define("dropbox",["modules/clean/undo","modules/core/controller_registry","modules/clean/browse_interface","modules/clean/multiaccount_login","modules/clean/datetime","modules/clean/base64","modules/clean/video_util","modules/clean/contacts/types","modules/core/uri","modules/clean/em_string","external/purify","modules/clean/db_bubble","modules/core/exception","libs","modules/clean/uirequest","jquery","modules/core/ordered_dictionary","modules/clean/components/bubble_picker","modules/clean/history","modules/clean/ajax","modules/clean/sso_login_checks","modules/core/notify","modules/clean/third_party/third_party_constants","modules/clean/components/ajax_form","modules/clean/sharing/shared_link_for_sf","modules/clean/react/modal","modules/clean/contacts/list","modules/clean/job_progress","modules/core/i18n","modules/clean/top_notif","modules/core/dom","modules/clean/web_timing_logger","modules/clean/account/email","modules/clean/dbmodal","modules/clean/teams/team_folder_modal","modules/clean/contacts/importer","modules/clean/payments/credit_card_util","modules/core/cookies","modules/clean/dbmodal_loading","modules/clean/display_format","modules/clean/payments/cash","modules/clean/event_load","modules/clean/contacts/facebook_modal","modules/clean/contacts/facebook_oauth","modules/clean/account/email_verify_reasons","modules/clean/image_size","modules/clean/payments/dfb_util","modules/clean/viewer","modules/clean/contacts/cache","modules/clean/analytics","modules/clean/photos/legacy_thumb_loader","modules/core/browser","modules/clean/sprite","modules/clean/filepath","modules/clean/clipboard","modules/core/html"],function(Q,bw,eu,bo,bE,ac,a7,P,C,bt,cv,ap,dx,bU,a9,bf,aK,bb,dX,cb,bG,Y,aH,bQ,dr,bZ,m,w,aY,b4,y,dE,cs,cA,di,U,ek,a8,ca,at,dd,ae,dz,dN,dO,Z,cx,cj,dL,aQ,a6,bB,b6,an,q,es){var A={};var bI=dx.alertd;var ci=dx.assert;var d4=dx.reportException;var d5=dx.stackTrace;var c9=bZ.SimpleModal;var cK=w.Job;var dV=w.ModalProgress;var aR=aY.ungettext;var dU=aY._;var c6=aY.N_;var B=aY.E_;var em=aY.render_sentences;var el=b4.TopNotificationBar;var d7=b4.EUCookieNotificationBar;var o=b4.ExpiredIOSNotificationBar;var dC=b4.PackratUnlimitedOptInNotificationBar;var bR=b4.DfBAdminEarlyAccessSharingControlsBar;var bN=b4.DfBAdminEarlyAccessFtsBar;var aB=b4.LocaleSwitchBar;var aj=cs.ChangeEmail;var dq=cs.EmailVerification;var du=cA.DBModal;var dm=cA.DBModalStack;var cL=cA.DBUserModal;var aW=dd.Cash;var eq=dd.CashUtil;var au=Z.image_best_fit_size;var er=cx.DfBTransitionInfoFetcher;var cg=dL.ContactsCache;var bA=dL.DefaultContactsCache;var dF,ei,cF;INLINE_JS.$=$;INLINE_JS.$u=$u;Function.prototype.defer=Function.prototype.defer.wrap(function(ev){var T;T=$A(arguments).slice(1);this.__tb__=d5();return ev.apply(this,T)});String.prototype.evalScripts=String.prototype.evalScripts.wrap(function(ev){var T,ew;T=$A(arguments).slice(1);try{return ev.apply(this,T)}catch(ex){ew=ex;return ci(0,ew.toString())}});dF=A.Jcached={cache:{},set:function(ev,ew,T){var ex;ex=dF.cache[ev];if(ex==null){ex=dF.cache[ev]={}}ex.value=ew;return ex.expires=T?new Date().getTime()+T:0},get:function(T){var ev;ev=dF.cache[T];if((ev==null)||new Date().getTime()>ev.expires){delete dF.cache[T];return false}return ev.value}};Function.prototype.cached=function(T){var ew,ev;ev=Math.random();ew=this;return function(){var ex;ex=dF.get(ev);if(ex!==false){return ex}ex=ew();dF.set(ev,ex,T);return ex}};Array.prototype.sort_by_key=function(ev,ew){var T;if(ew==null){ew=false}T=ew?-1:1;return this.sort(function(ex,ey){ex=ev(ex);ey=ev(ey);if(ex<ey){return T*-1}else{if(ex>ey){return T*1}else{return 0}}})};Array.prototype.contains=function(T){return this.indexOf(T)!==-1};Array.prototype.remove=function(ev,T){T=T||ev+1;return this.splice(ev,T-ev)};Array.prototype.removeItem=function(ev){var T;T=this.indexOf(ev);if(T>=0){return this.remove(T)}else{return false}};Array.prototype.dict_by=function(T){var ex,ey,ew,ez,ev;ew={};for(ex=ez=0,ev=this.length;ez<ev;ex=++ez){ey=this[ex];ew[this[ex][T]]=this[ex]}return ew};Array.prototype.unique=function(){var ey,ew,ex,ev,T;ey={};for(ex=0,ev=this.length;ex<ev;ex++){ew=this[ex];if(typeof ew!=="string"){return this}ey[ew]=0}T=[];for(ew in ey){T.push(ew)}return T};String.prototype.widthSplit=function(ex){var T,ew,ev,ey;if(ex==null){ex=15}T=[];ew=this;ey=0;ev=ew.substring(ey,ey+ex);while(ev!==""){T.push(ev);ey+=ex;ev=ew.substring(ey,ey+ex)}return T};Object.extend(Effect.Transitions,{EaseIn:function(T){return Math.pow(T,2)},EaseOut:function(T){return Math.pow(T,0.5)}});(function(ew){var ev,T;ev=function(eB){var ey,eF,eE,eC,eG,eA,ez,eD,ex;if(eB){if(Object.isArray(eB)){ey=[];for(eA=0,eD=eB.length;eA<eD;eA++){eF=eB[eA];ey.push(es.escape(eF).toHTML())}eB=new es(ey.join(""))}else{if(eB.top||eB.bottom||eB.before||eB.after){eC=["top","bottom","before","after"];for(ez=0,ex=eC.length;ez<ex;ez++){eE=eC[ez];eG=eB[eE];if(eG){eB[eE]=arguments.callee(eG)}}}else{if(ds.isElm(eB)||eB.toElement||eB.toHTML){}else{eB=es.escape(eB)}}}}return eB};return Element.addMethods({db_observe:function(ey,ex,ez){return ey.observe(ex,function(eA){return ez(eA,ey)})},smoothScrollIntoView:function(eA,ez){var eE,ey,ex,eD,eC,eB;if(ez==null){ez={}}eE={duration:0.3,offset:0,padding:0,transition:Effect.Transitions.EaseOut};ez=Object.extend(eE,ez);ex=eA.viewportOffset(eA);ey=eA.getDimensions();eB=document.viewport.getDimensions();eC=ez.padding||0;if(ex.top>eC&&(ex.top+ey.height)<(eB.height-eC)){return}eD=ex.top<eC?-1*Math.floor(eB.height/4):-1*Math.floor(3*eB.height/4);ez.offset=ez.offset||eD;return new Effect.ScrollTo(eA,ez)},__sert:function(ex,ey){return Element.insert(ex,ev(ey))},__date:function(ex,ey){return Element.update(ex,ev(ey))},replace:T=function(ex,ey){return ew(ex,ev(ey))}})})(Element.replace);ei=function(T){if(T!=null?T.target:void 0){try{return document.activeElement=T.target===document?null:T.target}catch(ev){}}};cF=function(T){try{return document.activeElement=null}catch(ev){}};if(document.addEventListener){document.addEventListener("focus",ei,true);document.addEventListener("blur",cF,true)}if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}String.prototype.lpad=function(ev,T){var ew;if(T==null){T="0"}ew=this;while(ew.length<ev){ew=T+ew}return ew.toString()};String.prototype.reverse=function(){var ew,ev,T;T=this.split("");ev=T.reverse();ew=ev.join("");return ew};String.prototype.count=function(T){return(this.length-this.gsub(T,"").length)/T.length};String.prototype.repeat=function(T){return(new Array(T+1)).join(this)};String.prototype.title=function(){return this.charAt(0).toUpperCase()+this.substr(1)};Ajax.DBRequest=Class.create(Ajax.Request,{initialize:function($super,eD,eB){var eH,eG,eL,eA,ew,T,eI,eE,eC,ex,ev,eJ,eK,eF,ez,ey;if(eB==null){eB={}}this.orig_req={url:eD,options:eB};this.start_time=bE.time();eB.method=eB.method||"post";eB.evalJS=false;eB.suppress_nonstandard_headers=true;eB.parameters=eB.parameters||{};eB.parameters.t=a8.read(Constants.JS_CSRF_COOKIE);eB.parameters.is_xhr=true;if(eB.method.toLowerCase()==="post"||Constants.CPROFILE_ENABLED){eB.parameters.parent_request_id=Constants.REQUEST_ID}if(Constants.CPROFILE_ENABLED){eB.parameters.cProfile=Constants.CPROFILE_PARAMETER}if(Constants.PUBLIC_MODE_OVERRIDE){eB.parameters.public_mode_override="1"}if(Constants.COUNTRY_OVERRIDE){eB.parameters.public_mode_override=Constants.COUNTRY_OVERRIDE}if(Constants.GANDALF_PANEL&&eD.indexOf("/")===0){eB.parameters.gandalf_panel=1}if(Ajax.DBRequest.restrict){eB.parameters.restrict=Ajax.DBRequest.restrict}eG=eB.cleanUp||(function(){});this.subject_user=eB.subject_user||eB.job_user;if(eB.job){this.job_id=ds.nonce();eB.parameters.job_id=this.job_id;dy.watch(this,eB.dont_hide_progress_on_complete)}if(!eB.no_watch){ai.watch(this,!!eB.job)}eI=eB.onFailure;eE=eB.onSuccess;T=eB.onComplete;ew=(function(eM){return function(eN){var eP,eO;if(eB.parameters.xhr_retry||!eB.allow_retries){return false}if((eO=eN.status)===0||eO===500||eO===502||eO===503){eM.orig_req.options.parameters.xhr_retry=true;eM.orig_req.options.onFailure=eI;eM.orig_req.options.onSuccess=eE;eP=new Ajax.DBRequest(eM.orig_req.url,eM.orig_req.options);return true}return false}})(this);eA=(function(eM){return function(eO){var eN;if(eB.noAutonotify||eB.no_watch){return}if(eO.status!==0&&eO.status<400){return}eN={url:eM.orig_req.url,response_code:eO.status,source_type:"web",request_id:eO.getHeader("X-Dropbox-Request-Id")};return new Ajax.DBRequest("/web_response_code_log",{noAutonotify:true,no_watch:true,parameters:eN})}})(this);eB.onFailure=function(eN){var eP,eM,eO;if(cK.handled(eN.request.job_id)){return}eA(eN);if(ew(eN)){return}if(!eB.noAutonotify){if(!Constants.IS_PROD&&eN.status===500&&eN.getHeader("X-Debug-Url")){eD=eN.getHeader("X-Debug-Url");eP=dU("There was a problem completing this request.")+(' <a href="'+eD+'" target="_blank">View debug</a>');Y.error(new es(eP))}else{Y.error()}}eG(false);if(eI){eI(eN)}if(eN.status===403){eM=ds.session_storage_get("reload-timestamp");if(!eM||bE.time()-eM>30*1000){ds.session_storage_set("reload-timestamp",bE.time());location.reload(true)}}return ci(eB.noAutonotify||((eO=eN.status)===403||eO===404||eO===502),"Ajax "+eN.status+" on "+eN.request.url)};eB.onComplete=(function(eM){return function(eN){if(eN.responseText.length&&T){if(eN.responseText.indexOf("async_task_started:")!==0){return T(eN)}}}})(this);eB.onSuccess=(function(eM){return function(eW){var eV,eN,e2,eZ,eX,eO,e1,eQ,eS,e0,eP,eT,eY,eU,eR;eP=bE.time()-eW.request.start_time;if(cK.handled(eW.request.job_id)){return}if(!eW.responseText.length){if(!eB.job){eA(eW);if(ew(eW)){return}if(!eB.noAutonotify){if(!eW||eW.status!==0){Y.error()}}if(eI){eI(eW)}}}else{if(eW.responseText.indexOf("err:")===0){if(!eB.noAutonotify){eO=eW.responseText.substr(4);if(eB.html_in_error_msg){eO=new es(eO)}Y.error(eO)}if(eI){eI(eW)}}else{if(eW.responseText.indexOf("async_task_started:")===0){eM.async_task_id=eW.responseText.split(":")[1];dy.watch(eM)}else{if(eE){if(eW.responseText.indexOf("ok:")===0){Y.success(eW.responseText.substr(3))}eE(eW)}}e0=eW.getHeader("X-Server-Response-Time")||"-1";if(eB.log_timing){dE.log_ajax_transition.defer(eP,void 0,void 0,void 0,e0,eD=aS.absolutize(eM.url))}eV=bf("#cprofile");if(!eB.no_watch&&eV.length){eS=""+Constants.REQUEST_ID+"-"+(eW.getHeader("X-Dropbox-Request-Id"));eD=eW.request.url.replace(/[^/]*\/\/[^/]+/,"").replace(/\?.*$/,"");eZ="Ajax: "+eD+" ("+e0+"ms)";e1="/profile/cprofile?request_id="+eS;eQ=eW.request.url;if(eQ.indexOf(Constants.BLOCK_CLUSTER)!==-1){e1+="&block=1"}else{eU=Constants.BATCH_THUMB_ENDPOINTS;for(eT=0,eY=eU.length;eT<eY;eT++){e2=eU[eT];if(eQ.indexOf(e2)!==-1){e1+="&block=1";break}}}eX=bf('<a class="ajax" target="_new" />').attr("href",e1).text(eZ);eN=eV.find(".ajax");if(eN.length>=10){eN.last().remove()}eV.prepend(eX)}if(bf("#gandalf_panel").length&&eW.request.url.substring(0,14)!=="/gandalf_panel"){if((eR=window.gandalf_panel)!=null){eR.add(eW.request.url,eW.getHeader("X-Dropbox-Request-Id"))}}}}return eG(true)}})(this);eB.onException=function(eN,eO){var eP,eM;if(window.console){throw eO}eP=("Error with AJAX callback for: "+eD+" :::: ")+eO.toString();eM=d5();eM.pop();return d4(eP,bB.get_href(),"",eM.join("\n"))};if(eB.job){eD+=(eD.indexOf("?")===-1?"?":"&")+"long_running=1"}if(eB.subject_user&&!((eF=eB.parameters)!=null?eF[Constants.UID_PARAM_NAME]:void 0)){eD=C.parse(eD).updateQuery(Constants.UID_PARAM_NAME,eB.subject_user).toString()}eH=$H({url:eD});if(eB.parameters){eH.update(eB.parameters);ez=eH.keys();for(ex=0,eJ=ez.length;ex<eJ;ex++){eL=ez[ex];ey=["passwd","password","oauth","ccn","host_id"];for(ev=0,eK=ey.length;ev<eK;ev++){eC=ey[ev];if(eL.indexOf(eC)!==-1){eH.unset(eL)}}}eH.unset("t")}eB.onSuccess.__tb_ajax_info__=eB.onFailure.__tb_ajax_info__=Object.toJSON(eH);return $super(eD,eB)}});if(typeof key!=="undefined"&&key!==null){Object.extend(key,{main_modifier:function(){if(ds.is_mac()){return decodeURIComponent("%E2%8C%98")}else{return"ctrl"}}})}Object.extend(Prototype.BrowserFeatures,{DB_CORS:window.XMLHttpRequest&&("withCredentials" in new XMLHttpRequest())});var cy=[].slice;if(!window.$j){window.$j=window.jQuery}INLINE_JS.$j=bf;if(!Function.prototype.bind){Function.prototype.bind=function(T){var ey,ex,ev,ew;if(typeof monkey_check==="function"){monkey_check()}if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}ey=Array.prototype.slice.call(arguments,1);ew=this;ev=function(){};ex=function(){return ew.apply((this instanceof ev&&T?this:T),ey.concat(Array.prototype.slice.call(arguments)))};ev.prototype=this.prototype;ex.prototype=new ev();return ex}}jQuery.fn.curry=function(){var T,ew,ev;ew=arguments[0],ev=arguments[1],T=3<=arguments.length?cy.call(arguments,2):[];if(ev==null){ev=window}if(typeof monkey_check==="function"){monkey_check()}return function(){var ex;ex=1<=arguments.length?cy.call(arguments,0):[];return ew.apply(ev,cy.call(T).concat(cy.call(ex)))}};jQuery.fn.stripTags=function(T){if(typeof monkey_check==="function"){monkey_check()}return T.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"")};jQuery.fn.controller=function(T){if(typeof monkey_check==="function"){monkey_check()}if(T!=null){return this.data("jscontroller",T)}else{return this.data("jscontroller")}};jQuery.fn.hasScrollBar=function(){if(typeof monkey_check==="function"){monkey_check()}return this.get(0).scrollHeight>this.height()};jQuery.fn.viewportOffset=function(){if(typeof monkey_check==="function"){monkey_check()}return y.viewport_offset(this)};jQuery.fn.visible=function(){if(typeof monkey_check==="function"){monkey_check()}return jQuery(this).is(":visible")};jQuery.fn.clonePosition=function(ev,T){if(typeof monkey_check==="function"){monkey_check()}y.clone_position(this,ev,T);return this};jQuery.format=function(ev,T){if(typeof monkey_check==="function"){monkey_check()}return ev.replace(/\{([^}]+)\}/g,function(ex,ew){if(ew in T){return T[ew]}else{return ex}})};jQuery.cachedScript=function(ev,T){if(typeof monkey_check==="function"){monkey_check()}T=bf.extend(T||{},{dataType:"script",cache:true,url:ev});return jQuery.ajax(T)};jQuery.browser=bB;jQuery.addSubjectParam=function(ew,T){var ev;if(typeof monkey_check==="function"){monkey_check()}if(ew.subject_user&&!((ev=ew.data)!=null?ev[Constants.UID_PARAM_NAME]:void 0)){return T[Constants.UID_PARAM_NAME]=String(ew.subject_user)}};jQuery.ajaxPrefilter(function(T,ex,ew){var ev;if(!ex.noDropboxDefaults){ev={t:a8.read(Constants.JS_CSRF_COOKIE),is_xhr:true};jQuery.addSubjectParam(ex,ev);if(jQuery.ajaxSettings.restrict!=null){ev.restrict=jQuery.ajaxSettings.restrict}T.data=bf.param(bf.extend(ex.data,ev),true);return false}});jQuery.ajax.retryOnce=function(ex,T,ev){var ew;if(typeof monkey_check==="function"){monkey_check()}if(T!=="abort"&&((ew=ex.status)===0||ew===500||ew===502||ew===503)&&!this.xhr_retry){this.xhr_retry=true;return jQuery.ajax(this)}};var d0,cJ,dh,aS,ds,cY,cU=function(T,ev){return function(){return T.apply(ev,arguments)}};ds=INLINE_JS.Util=A.Util={set_min_body_height_to_viewport_height:function(){var T;T=$(document.body);if(T!=null?T.style:void 0){return T.style.minHeight=y.viewport_dimensions().height+"px"}},scroll_to_thumb:function(T){var ey,ex,ew,ev;ex=T.cumulativeOffset().top;ey=T.getHeight();ev=y.scroll_offsets().top;ew=y.viewport_dimensions().height;if(ex<ev||ex+ey>ev+ew){return y.scroll_to(0,ex-ew/2)}},decode_sort_key:function(ew){var ey,ex,ev,T;T=[];for(ex=0,ev=ew.length;ex<ev;ex++){ey=ew[ex];if(typeof ey==="string"){T.push(ac.decode(ey))}else{T.push(ey)}}return T},sort_by_rank_or_key:function(T,ev){if((T.sort_rank!=null)&&(ev.sort_rank!=null)){return T.sort_rank-ev.sort_rank}ci((T.sort_key!=null)&&(ev.sort_key!=null),"expected sort keys on both elms");return this._sort_by_key(T,ev)},sort_by_key:function(T,ev){return this._sort_by_key(T,ev)},_sort_by_key:function(ev,eA){var ex,T,ew,ez,ey;T=ev.sort_key;ew=eA.sort_key;for(ex=ez=0,ey=T.length;0<=ey?ez<ey:ez>ey;ex=0<=ey?++ez:--ez){if(ew[ex]==null){return 1}if(typeof T[ex]!==typeof ew[ex]){if(typeof T[ex]==="string"){return 1}else{return -1}}else{if(T[ex]!==ew[ex]){if(T[ex]>ew[ex]){return 1}else{return -1}}}}if(ew.length>T.length){return -1}else{return 0}},add_sort_arrow_mouseover:function(T,ey,ew,ev){var eB,ez,eC,eA,ex;eA=$$(ew);ex=[];for(ez=0,eC=eA.length;ez<eC;ez++){eB=eA[ez];ex.push((function(eD){var eE;if(T!==eD){b6.src(eD.down("img"),"web","downtick-spacer");return eD.removeClassName("bolded")}else{eD.addClassName("bolded");if(eD.hasClassName("noarrow")){return}eE=ey?"arrow-up-gray":"arrow-down-gray";return b6.src(eD.down("img"),"web",eE)}})(eB))}return ex},add_sort_arrow_mouseover_j:function(T,ey,ew,ev){var eB,ez,eC,eA,ex;eA=bf(ew);ex=[];for(ez=0,eC=eA.length;ez<eC;ez++){eB=eA[ez];ex.push((function(eD){var eE;if(T.attr("data-sort")!==bf(eD).attr("data-sort")){b6.src(bf(eD).find("img")[0],"web","downtick-spacer");return bf(eD).removeClass("bolded")}else{bf(eD).addClass("bolded");if(bf(eD).hasClass("noarrow")){return}eE=ey?"arrow-up-gray":"arrow-down-gray";return b6.src(bf(eD).find("img")[0],"web",eE)}})(eB))}return ex},one_line_fit:function(T){var ew,ev;ew=$$(T);if(ew.length<2){return}ev=(function(ex){return function(){var eG,eD,eC,eA,eF,eB,ey,ez,eE;eC=ew[0];eF=ew[ew.length-1];eA=eC.cumulativeOffset().top;eB=eF.cumulativeOffset().top;if(eA!==eB){eG=parseInt(eC.getStyle("font-size"),10);ey=eG-1;if(ey<8){return}for(ez=0,eE=ew.length;ez<eE;ez++){eD=ew[ez];eD.style.fontSize=ey+"px"}return ev()}}})(this);return ev()},nice_list:function(ev){var ez,ey,ex,T,ew;if(!ev){return""}else{if(ev.length===1){return ev[0]}else{if(ev.length===2){return dU("%(x)s and %(y)s").format({x:ev[0],y:ev[1]})}}}ew=dU("%(x)s, %(y)s, and %(z)s").split(/%\(x\)s|%\(y\)s|%\(z\)s/);ci(ew.length===4,"bad item list format %(x)s, %(y)s, and %(z)s");ey=ew[0];ex=ew[1];T=ew[2];ez=ew[3];return[ey,ev.slice(0,-1).join(ex),T,ev[ev.length-1],ez].join("")},list_em_snippet:function(ev,T){var ez,ex,ew,ey,eB,eA;ew="";T-=new bt("...").length;for(ex=eB=0,eA=ev.length;0<=eA?eB<eA:eB>eA;ex=0<=eA?++eB:--eB){ey=ev[ex];if(ex!==0){ey=", "+ey}ez=new bt(ey).length;if(ez>T){break}T-=ez;ew+=ey}return{str:ew,snipped:ev.length-ex}},start_of_day:function(T){var ev;ev=new Date();ev.setTime(T.getTime());ev.setHours(0);ev.setMinutes(0);ev.setSeconds(0);ev.setMilliseconds(0);return ev},to_iso8601_date:function(ex,ev,ew){var T;if(ev==null){ev=false}if(ew==null){ew=false}if(ev){T=ex.getUTCFullYear().toString()+"-"+(ex.getUTCMonth()+1).toString().lpad(2)+"-"+ex.getUTCDate().toString().lpad(2);if(ew){T+=" "+ex.getUTCHours().toString().lpad(2)+":"+ex.getUTCMinutes().toString().lpad(2)+":"+ex.getUTCSeconds().toString().lpad(2)}}else{T=ex.getFullYear().toString()+"-"+(ex.getMonth()+1).toString().lpad(2)+"-"+ex.getDate().toString().lpad(2);if(ew){T+=" "+ex.getHours().toString().lpad(2)+":"+ex.getMinutes().toString().lpad(2)+":"+ex.getSeconds().toString().lpad(2)}}return T},to_mysql_date:function(ey,T,ew){var ev,ez,ex;ev=ey.getFullYear().toString()+"-"+(ey.getMonth()+1).toString().lpad(2)+"-"+ey.getDate().toString().lpad(2);ex=ey.getHours().toString().lpad(2)+":"+ey.getMinutes().toString().lpad(2)+":"+ey.getSeconds().toString().lpad(2);ez="."+ey.getMilliseconds().toString().lpad(3);if(!T){return ev}if(!ew){return ev+" "+ex}return ev+" "+ex+ez},from_mysql_date:function(ev){var ex,ez,ew,eB,T,eA,ey;eB=ev.split(" ");ex=eB[0];eA=eB.length>1?eB[1]:false;ez=ex.split("-");ci(ez.length===3,"weird date format on "+this+", expected yyyy-mm-dd");ew=new Date(ez[0],parseInt(ez[1],10)-1,ez[2]);if(eA){ey=eA.split(":");ci(ey.length===3,"weird time format on "+this+", expected hh:mm:ss.ms");ew.setHours(ey[0]);ew.setMinutes(ey[1]);T=ey[2].split(".");ew.setSeconds(T[0]);if(T.length>1){ew.setMilliseconds(T[1])}}return ew},make_table:function(T,eB){var ew,eA,eC,ev,ey,ex,ez;eC=new Element("table",eB);ev=new Element("tbody");eC.__sert(ev);for(eA in T){ez=T[eA];ex=new Element("tr");ey=new Element("td").insert(eA);ew=new Element("td").insert(ez);ex.__sert(ey);ex.__sert(ew);ev.__sert(ex)}return eC},validate_email:function(T){var ev;ev=new RegExp("^['&A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,15}$","i");return ev.test(T)},scrollTop:function(){return window.scrollY||document.documentElement.scrollTop||0},scrollLeft:function(){return window.scrollX||document.documentElement.scrollLeft||0},scried:{},scry:function(ew){var ev,T;T=this.scried;ev=T[ew];if(!ev){ev=$(ew);T[ew]=ev}return ev},urlquote:function(T){return T.split("/").map(encodeURIComponent).join("/")},ie8:Prototype.Browser.IE&&document.documentMode&&true,ie:Prototype.Browser.IE,log:function(){var ev,T;if(!Constants.IS_PROD){if(Prototype.Browser.IE){return(ev=$("ieconsole"))!=null?ev.innerHTML+=$A(arguments).join(" ")+"<br>":void 0}else{return typeof console!=="undefined"&&console!==null?(T=console.log)!=null?T.apply(console,$A(arguments)):void 0:void 0}}},childElement:function(ew,ev){var T;T=this.childElementWithIndex(ew,ev);return T[0]},childElementWithIndex:function(eB,ew){var ey,eA,ex,ev,ez,T;ey=0;ev=eB.childNodes;for(ex=ez=0,T=ev.length;ez<T;ex=++ez){eA=ev[ex];if(eA.nodeType===1&&ey++===ew){return[eA,ex]}}return[false,false]},disableSelection:function(T){T.onselectstart=function(){return false};T.unselectable="on";T.style.MozUserSelect="none";return T.style.cursor="default"},enableSelection:function(T){T.onselectstart=function(){return true};T.unselectable="off";T.style.MozUserSelect="";return T.style.cursor=""},disable_ie_image_dragging:function(){if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return document.ondragstart=function(){return false}}},bsearch:function(T,eB,ez,ey){var ew,ex,ev,eA;if(!ez){ez=function(eC,eD){return eC-eD}}ew=T.length;ex=0;while(ew>ex){ev=Math.floor(ew/2+ex/2);eA=ez(T[ev],eB);if(eA>0){ew=ev}else{if(eA<0){ex=ev+1}else{return ev}}}if(ey){return ex}else{return -1}},nonce:function(){var ew,T,ev;ew=new Date();ev=ew.getTime().toString();T=Math.floor(Math.random()*1000000).toString().lpad(6);return ev+T},focus:function(ev){if(ev){ev=$(ev);try{return ev.focus()}catch(T){}}},sumStyles:function(ex,ey){var T,ew,ez,ev;ew=0;if(ex){for(ez=0,ev=ey.length;ez<ev;ez++){T=ey[ez];ew+=parseInt(ex.getStyle(T),10)||0}}return ew},syncHeight:function(T){var ev;if(T==null){T=".sync-height"}$$(T).invoke("setStyle",{height:"auto"});ev=$$(T).invoke("getHeight").max();ev-=this.sumStyles($$(T)[0],["border-left-width","padding-left","padding-right","border-right-width"]);return $$(T).invoke("setStyle",{height:ev>0?""+ev+"px":"auto"})},async_load_script:function(ev){var T;T=function(){var ex,ew;ew=document.createElement("script");ew.src=ev;ew.type="text/javascript";ew.async=true;ex=document.getElementsByTagName("script")[0];return ex.parentNode.insertBefore(ew,ex)};if(document.readyState==="complete"){return T()}else{if(window.attachEvent!=null){return window.attachEvent("onload",T)}else{return window.addEventListener("load",T,false)}}},smart_window_load:function(T){if(document.readyState==="complete"){return T.defer()}else{return Event.observe(window,"load",T)}},isNumber:function(T){return !isNaN(Number(T,10))},shorten_url:function(T,ev){return new Ajax.DBRequest("/shorten_url",{parameters:{url:T},onSuccess:function(ew){return ev(ew.responseText)}})},falsy_to_empty:function(T){return T||""},preloaded_images:{},preload_image:function(ex,ew,ev){var T;if(this.preloaded_images[ex]){return}T=new Image();if(ew!=null){Element.extend(T).observe("error",ew)}if(ev!=null){Element.extend(T).observe("load",ev)}T.src=ex;return this.preloaded_images[ex]=T},get_preloaded_image:function(T){if(this.preloaded_images[T]){return this.preloaded_images[T].clone()}else{return new Element("img",{src:T})}},clear_selected:function(){var T;if(window.getSelection){T=window.getSelection();if(T.removeAllRanges){return T.removeAllRanges()}}else{if(document.selection){return document.selection.empty()}}},is_mac:function(){return navigator.appVersion.indexOf("Mac")!==-1},is_windows:function(){return navigator.appVersion.indexOf("Windows")!==-1},in_scrollbar:function(T){var ew,ev;ew=20;ev=y.viewport_dimensions();return T>ev.width-ew},freshbutton_overlay:function(ev,T){var ex,ew;ew=ev instanceof jQuery&&ev||bf(ev);ex=T instanceof jQuery&&T||bf(T);ew.on("mouseover",(function(ey){return function(){return ex.addClass("hovered")}})(this));ew.on("mouseout",(function(ey){return function(){ex.removeClass("hovered");return ex.removeClass("pressed")}})(this));ew.on("mousedown",(function(ey){return function(){ex.removeClass("hovered");return ex.addClass("pressed")}})(this));return ew.on("mouseup",(function(ey){return function(){return ex.removeClass("pressed")}})(this))},isElm:function(T){if(typeof HTMLElement==="object"){return T instanceof HTMLElement}else{return T&&typeof T==="object"&&T.nodeType===1&&typeof T.nodeName==="string"}},_track_twitter_chars_left:function(ev,ew){var T;clearInterval(this.chars_left_interval);T=(function(ex){return function(){var ey,ez;ey=$("twitter-chars");ez=ew-$F(ev).strip().length;if(ez<0){ey.addClassName("too-long")}else{ey.removeClassName("too-long")}return ey.__date(ez)}})(this);return this.chars_left_interval=setInterval(T,250)},session_storage_set:function(T,ev){if(!window.sessionStorage||!window.JSON){return}return window.sessionStorage.setItem(T,JSON.stringify(ev))},session_storage_get:function(T){if(window.sessionStorage&&window.JSON){return JSON.parse(window.sessionStorage.getItem(T))}},pdf_plugins:function(){var ew,ev,T;T=/Chrome PDF|Adobe Reader|Adobe PDF|Acrobat/gi;return ew=(function(){var eA,ey,ez,ex;ez=window.navigator.plugins;ex=[];for(eA=0,ey=ez.length;eA<ey;eA++){ev=ez[eA];if(T.test(ev.name)){ex.push(ev)}}return ex})()},get_window_location:function(){return window.location}};ds.scrollLeft=ds.scrollLeft.cached(50);ds.scrollTop=ds.scrollTop.cached(50);dh=A.UIButton=(function(){T.prototype.selector=function(){return".ui-button"};T.prototype.over=function(ev,ew){return ew.addClassName("over")};T.prototype.out=function(ev,ew){return ew.removeClassName("over")};T.prototype.down=function(ev,ew){return ew.addClassName("down")};T.prototype.up=function(ev){return $$(this.selector()+".down").invoke("removeClassName","down")};function T(){this.clear=cU(this.clear,this);this.up=cU(this.up,this);this.listen()}T.prototype.active=function(ew,ex){var ev;ev=bf(ex);if(ev.hasClass("ui-button-dropdown")){if(ev.hasClass("active")){bf(document).trigger("dropdownClosed",[1])}else{bf(document).trigger("dropdownOpened",[1])}}return ev.toggleClass("active")};T.prototype.clear=function(eB){var ew,ev,eA,eD,eC,ez,ex,eE,ey;eC=$(eB.target);ev=this.selector()+".active";ez=eC.match(ev)&&eC||eC.up(ev);eA=0;ey=$$(ev);for(ex=0,eE=ey.length;ex<eE;ex++){eD=ey[ex];ew=bf(eD);if(ez!==eD){if(ew.hasClass("active")&&ew.hasClass("ui-button-dropdown")){eA+=1}ew.removeClass("active")}}return bf(document).trigger("dropdownClosed",[eA])};T.prototype.listen=function(){$(document.body).on("mouseover",this.selector(),this.over);$(document.body).on("mouseout",this.selector(),this.out);$(document.body).on("mousedown",this.selector(),this.down);document.on("mouseup",this.up);$(document.body).on("click",this.selector(),this.active);return document.on("click",this.clear)};return T})();if(window.console==null){window.console={log:function(){},profile:function(){},profileEnd:function(){}}}document.observe("script:loaded",function(){var ew,ey,ev,ex,T;new dh();if(ds.ie8){ex=$$("#page-header a, #page-footer a");T=[];for(ey=0,ev=ex.length;ey<ev;ey++){ew=ex[ey];if(ew.target==="_blank"){T.push(ew.target="")}else{T.push(void 0)}}return T}});ae.window_load(function(){return ds.syncHeight()});cJ=__CONDITIONAL_JS__.Trace=A.Trace=(function(){var T;T=[];return{log:function(){var ev;ev=bE.time()+": "+$A(arguments).join(" ");return T.push(ev)},get:function(){return T.join("\n")}}})();d0=A.T=function(){return cJ.log.apply(this,$A(arguments))};document.observe("script:loaded",function(){var T;d0("dom:loaded");T=function(){var ev,ew;ev=$("page-content");if(ev){ew=y.viewport_dimensions();if(ew.width<ev.getWidth()){return $(document.body).addClassName("absolutize")}else{return $(document.body).removeClassName("absolutize")}}};Event.observe(window,"resize",T);return T()});Event.observe(window,"load",function(){return d0("window:load")});aS=A.URLUtil={absolutize:function(T){if(T.startsWith("https://")||T.startsWith("http://")){return T}else{if(T.charAt(0)==="/"){return""+window.location.protocol+"//"+window.location.host+T}else{return ci(0,"absolutize is confused by "+T)}}}};cY=A.Velocity={scroll_container:null,velocity:0,last_nonzero_velocity:0,old_y:0,max_delta_y:0,calculate_velocity:function(){this.velocity=this.max_delta_y;if(this.velocity!==0){this.last_nonzero_velocity=this.velocity}return this.max_delta_y=0},capture_new_y_pos:function(){var T,ev;if(this.old_y==null){this.old_y=this.scroll_container!=null?this.scroll_container.scrollTop:y.scroll_offsets().top;return}if(this.max_delta_y==null){this.max_delta_y=0;return}ev=this.scroll_container!=null?this.scroll_container.scrollTop:y.scroll_offsets().top;T=Math.abs(this.max_delta_y)<Math.abs(ev-this.old_y);if(T){this.max_delta_y=ev-this.old_y;return this.old_y=ev}},start_capture:function(T){this.scroll_container=T;this.velocity_calculator_interval=setInterval(this.calculate_velocity.bind(this,500));if(this.scroll_container!=null){return this.scroll_container.observe("scroll",this.capture_new_y_pos.bind(this))}else{return Event.observe(window,"scroll",this.capture_new_y_pos.bind(this))}},get:function(T){if(T==null){T=false}ci(this.velocity_calculator_interval!=null,"Haven't started capturing velocity");if(T){return this.last_nonzero_velocity}return this.velocity}};var cS;cS=A.DomUtil={fromElm:function(T){return $(T).innerHTML},updateFromElm:function(ev,T){ev=$(ev);T=$(T);return ev.update(this.fromElm(T))},fillVal:function(eB,ey){var ev,eA,ex,ez,T,ew;ez=$$("."+ey);ew=[];for(eA=0,ex=ez.length;eA<ex;eA++){ev=ez[eA];ev=$(ev);if(ev.tagName==="INPUT"){ev.value=eB;ew.push(ev.defaultValue=eB)}else{if(ev.innerHTML===""&&((T=ev.tagName)==="A"||T==="B"||T==="INPUT"||T==="I"||T==="LABEL"||T==="SELECT"||T==="SPAN"||T==="TEXTAREA")){ds.log("Filling an empty value; this may look broken in IE7",ev)}ew.push(ev.innerHTML=eB)}}return ew},copy_to_clipboard:function(eC,ez,eD){var ex,ew,T,ev,eA,ey;ex=$("hold_clipboard");ex.value=eC;if(ex.createTextRange){ey=ex.createTextRange();if(ey&&((typeof BodyLoaded==="undefined"||BodyLoaded===null)||BodyLoaded===1)){try{return ey.execCommand("Copy")}catch(eB){eA=eB;eD=eD||dU("Please copy the text below:");ez=ez||dU("Copy text");this.fillVal(eC,"text-to-copy");this.fillVal(eD,"copy-modal-body");ep.show(ez,this.fromElm("copy-modal"),{wit_group:"copy_to_clipboard"});return $("text-to-copy").select()}}}else{if(!$("flashcb")){T=document.createElement("div");T.id="flashcb";document.body.appendChild(T)}$("flashcb").innerHTML="";ew=encodeURIComponent(ex.value);ev='<embed src="/static/swf/_clipboard.swf" FlashVars="clipboard=#{clipboard}" width="0" height="0" type="application/x-shockwave-flash"></embed>';return $("flashcb").innerHTML=ev}}};var ai;ai=A.RequestWatcher={reqs:[],working_msg:dU("Still working...",{comment:"Comment about waiting for a process to complete"}),last_notification:null,TIMEOUT:10,watch:function(ev,ew){var T;T=this.reqs;if(!T.length){this.int_id=setInterval(this.check_up.bind(this),500)}if(ew){ev.skip_message=true}return T.push([ev,bE.time()])},check_up:function(){return this.scan(false)},remove:function(T){return this.scan(T)},scan:function(ez){var eD,ev,ex,T,eB,eA,ew,eC,ey;ev=bE.time();ex=[];ey=this.reqs;for(ew=0,eC=ey.length;ew<eC;ew++){T=ey[ew];eB=T[0];eA=T[1];eD=ev-eA;if(eB.transport.readyState===4){this.clearWorkingMessage();continue}if(eD>4000&&!eB.skip_message){eB.skip_message=true;if(Y.isShown()&&Y.current()===!Q.undo_notification){this.last_notification=Y.success(this.working_msg)}}if(eD>this.TIMEOUT*1000&&eB.job){eB.transport.abort()}if(eB!==ez){ex.push([eB,eA])}else{eB.transport.abort()}}this.reqs=ex;if(!ex.length){return clearInterval(this.int_id)}},clearWorkingMessage:function(){if(Y.isShown()&&Y.current()===this.last_notification){return Y.clear()}}};bf(function(){var ew,ev,ex,T;ex=Prototype.Browser;T=[];for(ew in ex){ev=ex[ew];if(ev===true){T.push(bf(document.body).addClass(ew.toLowerCase()))}}return T});var c8,aM,cy=[].slice;c8=A.HTML5_HISTORY=Modernizr.history;bf((function(T){return function(){return dX.init()}})(this));aM=A.HashRouter={watch_timer:null,callback_map:{},last_hash:"",last_prefix:"",_get_location:function(){return window.location.href},_set_location:function(T){return window.location.href=T},_replace_location:function(T){return window.location.replace(T)},init:function(){return this.watch_timer=setInterval(this.check_hash.bind(this),300)},watch:function(T,ev){this.callback_map[T]=ev;if(!this.watch_timer){return this.init()}},check_hash:function(){var ev,ew,ex,ez,ey,T;ez=this._get_location().split("#")[1];if(ez!=null){ez=ez.replace(/%27/g,"'")}if(this.last_hash===ez){return}this.last_hash=ez;if(this.last_prefix&&ez===""){ez=this.last_prefix+":"}else{if(!ez){return}}T=ez.split(":");ey=T.first();this.last_prefix=ey;ex=this.callback_map[ey];if(ex!=null){ew=(function(){var eD,eB,eC,eA;eC=T.slice(1);eA=[];for(eD=0,eB=eC.length;eD<eB;eD++){ev=eC[eD];eA.push(decodeURIComponent(ev))}return eA})();ex.apply(null,ew)}return $(document).fire("db:hash_change",{hash:ez})},_prepare_hash:function(ew){var ev,T;T=$A(ew).map(ds.falsy_to_empty);ev=T.map(encodeURIComponent);return ev.join(":")},set_hash:function(){var T,ev;T=1<=arguments.length?cy.call(arguments,0):[];ev=this._prepare_hash(T);return this._set_hash(ev)},replace_hash:function(){var T,ev;T=1<=arguments.length?cy.call(arguments,0):[];ev=this._prepare_hash(T);return this._set_hash(ev,true)},_set_hash:function(ev,T){if(ev===""){ev="/"}this.last_hash=ev;if(!T){return this._set_location("#"+ev)}else{return this._replace_location("#"+ev)}}};var c2;c2=A.SharingState=(function(){function T(){}T.set_role=function(ev){bf(".shared-folder-role-param").val(ev);return this.role=ev};T.set_is_merged=function(ev){return this.is_merged=ev};T.set_team_name=function(ev){return this.team_name=ev};T.set_team_permissions=function(ew,ev){if(ew==null){ew=false}if(ev==null){ev=false}this.team_only=ew;return this.show_groups=ev};T.set_not_logged_in_role_and_email=function(ew,ev){this.not_logged_in_role=ew;return this.not_logged_in_email=ev};T.set_show_inbox=function(ev){return this.show_inbox=ev};return T})();var aI;aI=A.SharingUtil=(function(){function T(){}T.success_string_for_recipients=function(ev){var ew;if(ev.length===1){if(ev[0].indexOf("@")===-1){ew=dU("Sent to %(recipient)s.",{comment:"Recipient is a user's name"}).format({recipient:ev[0]})}else{ew=dU("Sent to %(recipient)s.",{comment:"Recipient is an email address"}).format({recipient:ev[0]})}}else{if(ev.length===2){if(ev[0].indexOf("@")===-1){if(ev[1].indexOf("@")===-1){ew=dU("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"Recipients are users' names."}).format({recipient_first:ev[0],recipient_second:ev[1]})}else{ew=dU("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"First recipient is a user's name, second is an email address"}).format({recipient_first:ev[0],recipient_second:ev[1]})}}else{if(ev[1].indexOf("@")===-1){ew=dU("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"First recipient is an email address, second is a user's name"}).format({recipient_first:ev[0],recipient_second:ev[1]})}else{ew=dU("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"Recipients are email addresses"}).format({recipient_first:ev[0],recipient_second:ev[1]})}}}else{if(ev[0].indexOf("@")===-1){ew=dU("Sent to %(recipient)s and %(num_others)s others.",{comment:"num_others is 2 or more"}).format({recipient:ev[0],num_others:ev.length-1})}else{ew=dU("Sent to %(recipient)s and %(num_others)s others.",{comment:"num_others is 2 or more"}).format({recipient:ev[0],num_others:ev.length-1})}}}return ew};return T})();var aZ,b0;aZ=A.SharingApi=(function(){function T(ev){this.user=ev}T.prototype.invite_more_to_folder=function(ew,ev,ey,eA,ex,ez){var eB;eB={ns_id:ew,emails:ev.emails||[],fb_ids:ev.fb_ids||[],group_ids:ev.group_ids||[],new_style_group_ids:ev.new_style_group_ids||[],custom_message:ey||"",access_type:eA};return this._make_request("/share_ajax/invite_more",eB,ex,ez,true)};T.prototype.update_member_access_type=function(ev,eA,ey,ew,ex){var ez;ez={ns_id:ev,member_uid:eA,access_type:ey};return this._make_request("/share_ajax/update_member_access_type",ez,ew,ex)};T.prototype.update_group_access_type=function(ew,ez,ev,ex,ey){var eA;eA={ns_id:ew,group_gid:ez,can_edit:ev};return this._make_request("/share_ajax/update_group_access_type",eA,ex,ey)};T.prototype.update_invite_access_type=function(ez,ex,ev,ew){var ey;ey={invite_id:ez,access_type:ex};return this._make_request("/share_ajax/update_invite_access_type",ey,ev,ew)};T.prototype.share_folder=function(eE,ey,ex,eD,eC,ew,eF,ev,eA,eG,ez){var eB,eH;eB={emails:ex.emails||[],fb_ids:ex.fb_ids||[],group_ids:ex.group_ids||[],new_style_group_ids:ex.new_style_group_ids||[],custom_message:eD||"",audience:eC,inviter:ew,shared_link_policy:eF,access_type:ev,folder_settings:1};if(eE){eB.folder_name=ey;eH="/share_ajax/new"}else{eB.path=ey;eH=eA?"/share_ajax/existing_no_recipient":"/share_ajax/existing"}if(eC||ew){eB.custom_folder_settings=1}return this._make_request(eH,eB,eG,ez,true)};T.prototype.share_file=function(ez,eD,ex,eC,eB,ew,eE,ev,eF,ey){var eA,eG;eA={emails:ex.emails||[],fb_ids:ex.fb_ids||[],group_ids:ex.group_ids||[],new_style_group_ids:ex.new_style_group_ids||[],custom_message:eC||"",audience:eB,inviter:ew,shared_link_policy:eE,access_type:ev,folder_settings:1,path:ez,file_path:eD};eG="/share_ajax/share_file";if(eB||ew){eA.custom_folder_settings=1}return this._make_request(eG,eA,eF,ey,true)};T.prototype.unshare_folder=function(ew,ev,ex){var ey;ey={ns_id:ew,async:true};if(ev){ey.keep_files=true}return this._make_request("/share_ajax/unshare?long_running",ey,ex)};T.prototype.leave_folder=function(ew,ev,ex){var ey;ey={ns_id:ew};if(ev){ey.keep_files=true}return this._make_request("/share_ajax/leave?long_running",ey,ex)};T.prototype.transfer_ownership=function(ev,ex,ew){var ey;ey={ns_id:ev,user_id:ex};return this._make_request("/share_ajax/change_sf_owner",ey,ew)};T.prototype.cancel_invite=function(ev,ey,ew){var ex;ex={ns_id:ev,invite_id:ey};return this._make_request("/share_ajax/cancel_invite",ex,ew)};T.prototype.kick=function(ew,ey,ev,ex){var ez;ez={ns_id:ew,user_id:ey};if(ev){ez.keep_files=true}return this._make_request("/share_ajax/kick_user",ez,ex)};T.prototype.kick_group=function(ev,ex,ew){return Y.error("This feature has been removed.")};T.prototype.reinvite_user=function(ev,ey,ew){var ex;ex={ns_id:ev,invite_id:ey};return this._make_request("/share_ajax/reinvite_user",ex,ew)};T.prototype.update_sf_permissions=function(ev,ey,ew,ex){var ez;ez={ns_id:ev,new_permissions:ey};return this._make_request("/share_ajax/change_sf_perm",ez,ew,ex)};T.prototype.update_sf_team_permissions=function(ev,ey,ez,ex,eB,ew){var eA;eA={ns_id:ev,audience:ey,inviter:ez,shared_link_policy:ex};if(!(eB===void 0)){eA.activity_feed_enabled=eB}return this._make_request("/share_ajax/save_folder_settings",eA,ew)};T.prototype.validate_new_sf_path=function(ey,ev,ew){var ex;ex={share_type:"new",folder_name:ey};return this._make_request("/share_ajax/validate_folder",ex,ev,ew,true)};T.prototype.validate_existing_sf_path=function(ey,ev,ew){var ex;ex={share_type:"existing",path:ey};return this._make_request("/share_ajax/validate_folder",ex,ev,ew,true)};T.prototype._make_request=function(ew,eA,ev,ex,ez){var ey;if(ez==null){ez=false}eA[Constants.UID_PARAM_NAME]=this.user.id;if((ey=this.loading_elem)!=null){ey.addClass("ajax-loading")}return new Ajax.DBRequest(ew,{parameters:eA,onSuccess:ev,onFailure:ex,onComplete:(function(eB){return function(){var eC;return(eC=eB.loading_elem)!=null?eC.removeClass("ajax-loading"):void 0}})(this),noAutonotify:ez})};return T})();b0=A.UserlessSharingApi=(function(){function T(){}T.prototype.get_inbox_counts=function(ev){return new Ajax.DBRequest("/inbox_count",{onSuccess:(function(ew){return function(ey){var ex;ex=JSON.parse(ey.responseText);ci(typeof ex==="object","bad inbox_count");return ev(ex)}})(this)})};T.prototype.get_folder_info=function(ev,ew){return new Ajax.DBRequest("/share_ajax/list_folders",{onSuccess:ev,onFailure:ew})};return T})();var p;p=INLINE_JS.SharingModals=A.SharingModals=(function(){function T(){}T.show_shared_folder_options_modal=function(ew,ev){return dm.push(new cH(ev,ew))};T.show_shared_folder_wizard=function(ev){return new dM(ev,{element_id:"share-a-folder-wizard-modal"}).show()};T.get_select_role_modal=function(){return new ce({element_id:"select-role-modal"})};T.start_wizard_without_user=function(){if(cj.get_viewer().is_paired){if(this.select_role_modal==null){this.select_role_modal=T.get_select_role_modal()}return this.select_role_modal.show()}else{return this.start_wizard_for_user(cj.get_viewer().get_users()[0])}};T.start_wizard_for_user=function(ev){if(dq.get_for_user(ev).verified_or_show(dO.SHARE_FOLDER)){return T.show_shared_folder_wizard(ev)}};T.show_share_existing_modal=function(ex,ev){var ew;if(dq.get_for_user(ev).verified_or_show()){ew=new bY(ev,{folder_name:ex,element_id:"invite-to-new-sf-wizard-modal-"+ev.id});return ew.show()}};T.show_shmodel_or_invite_modal=function(ew,ey,ev,ex){if(dq.get_for_user(ev).verified_or_show()){return new dk(ev,{path:ew,existing_sf:ey,element_id:"create-link-or-invite-wizard-modal",target_item:ex}).show()}};T.show_unshare_team_sf_modal=function(ew,ev,ey){var ex;ex=new bD(ew,{element_id:"unshare-confirm-modal",team_shared_folder:true,ns_id:ev,folder_path:ey});return ex.show()};T.show_ignore_modal=function(ew,ez,ev){var ey,ex,eA;ci(ev,"Share ignore did not get an ns_id");eA=dU("Permanently remove '%(folder_name)s'").format({folder_name:bt.em_snippet(an.filename(ez),15)});ey={path:ez,ns_id:ev};ex=new cL(ew,{element_id:"ignore-confirm",title:eA});ex.on_confirm_button_click=function(eD){var eC,eB,eE;eD.preventDefault();eC=bf(eD.target);eB=eC.closest("form");eE=function(eF){Y.success(dU("Removed shared folder successfully."));document.fire(av.SF_IGNORE,{target_ns_id:ev,user_id:ew.id});return ex.hide()};return bs.ajax_submit(eB[0],false,eE,void 0,eC[0],ey)};return ex.show()};T.show_rejoin_modal=function(ew,ez,ev){var ey,ex,eA;ci(ev,"Rejoin didn't get an ns_id");eA=dU("Rejoin the shared folder '%(folder_name)s'?").format({folder_name:bt.em_snippet(an.filename(ez),13)});ey={path:ez,ns_id:ev};ex=new cL(ew,{element_id:"rejoin-confirm",title:eA});ex.on_confirm_button_click=function(eD){var eC,eB,eE;eD.preventDefault();eC=bf(eD.target);eB=eC.closest("form");eE=function(eH){var eF,eG;eG=eH.responseText;eF=an.filename(eG);Y.success(dU("Rejoined shared folder successfully."));document.fire(av.SF_REJOIN,{target_ns_id:ev,user_id:ew.id,filename:eF,mount_point:eG});return ex.hide()};return bs.ajax_submit(eB[0],false,eE,void 0,eC[0],ey)};return ex.show()};T.show_invites=function(){return dm.push(new ca({element_id:"invitation-page-modal",endpoint_url:"/share_ajax/get_invitation_page"}))};T.show_shared_subfolder_modal=function(ew,ey){var eB,ez,eA,ev,ex;eA=bt.em_snippet(an.filename(ew),14);ez=dU("Can't share folder");ev="'%(parent_shared_folder)s' ".format({parent_shared_folder:eA});cS.fillVal(ev.escapeHTML(),"parent_shared_folder_name");eB=dU("Share '%(parent_shared_folder)s' folder");ex=eB.format({parent_shared_folder:eA});($("share_parent_folder_button")).value=ex;ep.show(dU("Loading shared folder options..."),"<p style='margin: 3em 0; text-align: center;'> <img src='/static/images/icons/ajax-loading-small.gif' alt=''/></p>");bf("#share_parent_folder_button").on("click",(function(eC){return function(eD){ep.hide();return eC.show_shared_folder_options_modal(ew,ey)}})(this));return ep.show(ez,$("share_subfolder"))};return T})();var cG;cG=A.InviteFormController=(function(){function T(ex,ew,ev,eC,eB,eA){var ez,ey;this.user=ex;this.$form=ew;this.members=ev;this.invitees=eC;this.new_style_groups=eB;this.team_only=this.$form.data("team-only");ey={tokens:[",",";"],include_fb:true,members:this.members,invitees:this.invitees,new_style_groups:this.new_style_groups,contacts_only:true};if(this.user.role==="work"){ez=Autocompleter.TeamTokenizer;ey.team_only=this.team_only}else{ez=Autocompleter.ContactsTokenizer;ey.include_team=true}if(this.user.role==="work"&&(__CIRCULAR_DEPENDENCY__.GroupsApi!=null)){ey.include_new_style_groups=true}this.sharing_options_auto_completer=new ez(this.user,eA+"-new-collab-input",eA+"-new-whobulk",eA+"-hidden-input",ey);bS._create(this.$form.find(".custom-message-container")[0]);if(this.user.role==="work"){this.team_shared_folder_controller=new i(this.$form)}}T.prototype.listen=function(){return this.sharing_options_auto_completer.listen()};T.prototype.reset_autocompleter=function(){return this.sharing_options_auto_completer.clearTokens()};T.prototype.tokenize=function(){return this.sharing_options_auto_completer.tokenize_emails_input(true)};T.prototype.reset_options=function(){return bf(this.sharing_options_auto_completer.get_entry_container()).hide()};T.prototype.set_team_only=function(ev){this.team_only=ev;return this.sharing_options_auto_completer.setTeamOnly(ev)};T.prototype.extract_invitees=function(){var ey,ex,ew,eB,eA,ev,ez;eB={};ez=["emails","fb_ids","group_ids","new_style_group_ids"];for(eA=0,ev=ez.length;eA<ev;eA++){ex=ez[eA];ew=this.$form.find("input[name="+ex+"]");eB[ex]=[(function(){var eE,eD,eC;eC=[];for(eE=0,eD=ew.length;eE<eD;eE++){ey=ew[eE];eC.push(bf(ey).val())}return eC})()]}return eB};T.prototype.get_custom_message=function(){return this.$form.find("textarea[name='custom_message']").val()};T.prototype.get_access_type=function(){return this.$form.find(".can-edit-dropdown").data("selected-value")};return T})();var az,cH,L,dS,aF,d8,cT,b5,dc,bm,aw,bD,am={}.hasOwnProperty,cl=function(ex,ev){for(var T in ev){if(am.call(ev,T)){ex[T]=ev[T]}}function ew(){this.constructor=ex}ew.prototype=ev.prototype;ex.prototype=new ew();ex.__super__=ev.prototype;return ex},cU=function(T,ev){return function(){return T.apply(ev,arguments)}};dc=A.SharedFolderBaseModal=(function(ev){cl(T,ev);function T(ew,ex){this.user=ew;this.options=ex;T.__super__.constructor.call(this,this.options);this.team_shared_folder=this.options.team_shared_folder;this.path=this.options.folder_path;this.ns_id=this.options.ns_id;this.sharing_api=new aZ(this.user)}T.prototype.on_show=function(){return this.sharing_api.loading_elem=this.$modal_window};return T})(du);cH=A.ExistingSharedFolderOptionsModal=(function(ev){cl(T,ev);function T(ew,ex){var ez,ey;this.user=ew;this.__show_modal=cU(this.__show_modal,this);this.__x_click_handler=cU(this.__x_click_handler,this);ci(ex!=null,"Missing folder path");this.path=an.normalize(ex);ey=dU("Shared folder options for '%(folder)s'");ey=ey.format({folder:bt.em_snippet(an.filename(ex),13)});ez={};ez[Constants.UID_PARAM_NAME]=this.user.id;ez.max_results=20;T.__super__.constructor.call(this,{element_id:"folder-share-show-modal",title:ey,endpoint_url:C({path:"/share_options"+this.path}).toString(),parameters:ez})}T.prototype.__x_click_handler=function(ex){var ew;T.__super__.__x_click_handler.apply(this,arguments);ew={path:this.path};return aQ.SharedFolderActivityLogger.log("web","invite_modal_x_button",this.user,ew)};T.prototype.__show_modal=function(ex){var ew;T.__super__.__show_modal.apply(this,arguments);ew={path:this.path};return aQ.SharedFolderActivityLogger.log("web","invite_modal_displayed",this.user,ew)};return T})(ca);az=A.ExistingSharedFolderOptionsContent=(function(){function T(ey,ew,ex,ev){this.$root=ey;this.options=ev;this.show_email_verification=cU(this.show_email_verification,this);this.show_folder_settings=cU(this.show_folder_settings,this);this.toggle_from_invite_mode=cU(this.toggle_from_invite_mode,this);this.toggle_to_invite_mode=cU(this.toggle_to_invite_mode,this);this.show_leave_folder_modal=cU(this.show_leave_folder_modal,this);this.show_owner_leave_folder_warning=cU(this.show_owner_leave_folder_warning,this);this.show_access_request_link_modal=cU(this.show_access_request_link_modal,this);this.show_unshare_folder_modal=cU(this.show_unshare_folder_modal,this);this.show_uninvite_modal=cU(this.show_uninvite_modal,this);this.show_transfer_user_modal=cU(this.show_transfer_user_modal,this);this.show_kick_group_modal=cU(this.show_kick_group_modal,this);this.show_kick_user_modal=cU(this.show_kick_user_modal,this);this.update_tf_access=cU(this.update_tf_access,this);this.update_sf_perms=cU(this.update_sf_perms,this);this.reinvite_user=cU(this.reinvite_user,this);this.submit_invitations=cU(this.submit_invitations,this);this.maybe_load_more=cU(this.maybe_load_more,this);this.extract_user_data_and_call=cU(this.extract_user_data_and_call,this);this.extract_invitee_data_and_call=cU(this.extract_invitee_data_and_call,this);this.user=cj.get_viewer().get_user_by_id(ew);this.path=an.normalize(ex);if(this.options){this.members=this.options.folder_members;this.invitees=this.options.folder_invitees;this.new_style_groups=this.options.new_style_groups;this.num_total=this.options.num_total}this.$root.find(".bubble-dropdown").click(function(ez){y.controller(bf(ez.target).closest(".sf-action-dropdown")).closeDropdown();return true});this.start=20;this.max_results=100;this.maybe_load_more();this.sharing_api=new aZ(this.user);this.sharing_api.loading_elem=this.$root;aT.register_all();cz.register_all();this.ns_id=this.$root.data("ns-id");this.$invite_form=this.$root.find(".invite-more-form");this.sf_access_type=this.$invite_form.find(".sf-invite-can-edit");this.team_shared_folder=this.$root.data("team-shared-folder");this.$allow_members_table=this.$root.find(".allow-members-table");this.$folder_management_buttons=this.$root.find(".folder-management-buttons");this.log_extras={path:this.path,ns_id:this.ns_id};this.sf_access_type.hide();this.listen()}T.prototype.listen=function(){var ey,ex,ew,eA,ev,ez;this.$root.find(".confirm-button").click((function(eB){return function(eC){eC.preventDefault();return eB.submit_invitations()}})(this));this.$root.find(".cancel-button").click((function(eB){return function(eC){eC.preventDefault();return eB.toggle_from_invite_mode()}})(this));ey=this.$root.find("#sharing-options-new-collab-input");ez=["focus","keypress","contextmenu"];for(eA=0,ev=ez.length;eA<ev;eA++){ew=ez[eA];ey.off(ew);ey.on(ew,this.toggle_to_invite_mode)}ex=this.$root.find("#custom-message-wizard");ex.on("focus",this.toggle_to_invite_mode);this.$root.find(".change-settings-link").on("click",this.show_folder_settings);this.$root.find(".invite-verify-email").on("click",this.show_email_verification);if(this.$invite_form.length&&!this.team_shared_folder){this.invite_form_controller=new cG(this.user,this.$invite_form,this.members,this.invitees,this.new_style_groups,"sharing-options")}this.$root.on("click","a.leave-folder",(function(eB){return function(eC){eC.preventDefault();aQ.SharedFolderActivityLogger.log("web","invite_modal_leave_button",eB.user,eB.log_extras);return eB.show_leave_folder_modal()}})(this));this.$root.on("click","a.owner-leave-folder",(function(eB){return function(eC){eC.preventDefault();aQ.SharedFolderActivityLogger.log("web","invite_modal_owner_leave_button",eB.user,eB.log_extras);return eB.show_owner_leave_folder_warning()}})(this));this.$root.on("click","a.kick-user",(function(eB){return function(eC){return eB.extract_user_data_and_call(eC,eB.show_kick_user_modal)}})(this));this.$root.on("click","a.kick-group",(function(eB){return function(eE){var eC,eD,eF;eE.preventDefault();eC=bf(eE.currentTarget);eF=eC.data("group-name");eD=eC.data("group-gid");return eB.show_kick_group_modal(eF,eD)}})(this));this.$root.on("click","a.make-owner",(function(eB){return function(eC){return eB.extract_user_data_and_call(eC,eB.show_transfer_user_modal)}})(this));this.$root.on("click","a.send-email",(function(eB){return function(eD){var eC,eE;eD.preventDefault();eC=bf(eD.currentTarget);eE=eC.data("email");return window.location=C({scheme:"mailto",path:eE}).toString()}})(this));this.$root.on("click","a.reinvite-user",(function(eB){return function(eC){return eB.extract_invitee_data_and_call(eC,eB.reinvite_user)}})(this));this.$root.on("click","a.uninvite-user",(function(eB){return function(eC){return eB.extract_invitee_data_and_call(eC,eB.show_uninvite_modal)}})(this));this.$root.on("click","input.sf-action-leave",(function(eB){return function(eC){eC.preventDefault();aQ.SharedFolderActivityLogger.log("web","invite_modal_leave_button",eB.user,eB.log_extras);return eB.show_leave_folder_modal()}})(this));this.$root.on("click","input.sf-action-unshare",(function(eB){return function(eC){eC.preventDefault();aQ.SharedFolderActivityLogger.log("web","invite_modal_unshare_button",eB.user,eB.log_extras);return eB.show_unshare_folder_modal()}})(this));this.$root.on("click","input.sf-action-get-link",(function(eB){return function(eC){eC.preventDefault();return eB.show_access_request_link_modal()}})(this));this.$root.on("click","input.sf-action-done",(function(eB){return function(eC){eC.preventDefault();aQ.SharedFolderActivityLogger.log("web","invite_modal_done_button",eB.user,eB.log_extras);return dm.pop()}})(this));this.$root.on("click","input#change-sf-perm-checkbox",(function(eB){return function(eD){var eC;eC=bf(eD.currentTarget);return eB.update_sf_perms(eC.prop("checked"))}})(this));return this.$root.on("click","input#change-tf-access-checkbox",(function(eB){return function(eD){var eC;eC=bf(eD.currentTarget);return eB.update_tf_access(!eC.prop("checked"))}})(this))};T.prototype.extract_invitee_data_and_call=function(ey,ex){var ev,ez,ew;ey.preventDefault();ev=bf(ey.currentTarget);ew=ev.data("email-or-fbname");ez=ev.data("invite-id");return ex(ew,this.ns_id,ez)};T.prototype.extract_user_data_and_call=function(eA,ez){var ew,ey,ex,ev;eA.preventDefault();ew=bf(eA.currentTarget);ex=ew.data("display-name");ey=ew.data("email");ev=ew.data("user-id");return ez(ex,ey,ev)};T.prototype.maybe_load_more=function(){var ew,ev,ex;ev=this.$root.closest("body").length;if(!ev){return}if(this.start>=this.num_total){bf("#more-members-spinner").hide();return}bf("#more-members-spinner").show();ex={};ex[Constants.UID_PARAM_NAME]=this.user.id;ex.start=this.start;ex.max_results=this.max_results;ew=C({path:"/share_options"+this.path}).toString();this.$root.removeClass("ajax-loading");new a9(this.$root,ew,{data:ex,success:(function(ey){return function(eC,ez,eD){var eA,eB;if(((eB=eC.data)!=null?eB.options:void 0)!=null){eA=eC.data.options;if((ey.members!=null)&&(eA.folder_members!=null)){Array.prototype.push.apply(ey.members,eA.folder_members)}if((ey.invitees!=null)&&(eA.folder_invitees!=null)){Array.prototype.push.apply(ey.invitees,eA.folder_invitees)}if((ey.new_style_groups!=null)&&(eA.new_style_groups!=null)){Array.prototype.push.apply(ey.new_style_groups,eA.new_style_groups)}}return ey.maybe_load_more()}})(this),error:(function(ey){return function(eB,ez,eA){return Y.error("Unable to load all members of this folder.")}})(this)});return this.start=this.start+this.max_results};T.prototype.submit_invitations=function(){var ey,ex,eA,ew,ez,ev;this.invite_form_controller.tokenize();eA=this.invite_form_controller.extract_invitees();ez=this.invite_form_controller.get_custom_message();ey=this.invite_form_controller.get_access_type();ew=$u.clone(this.log_extras);ew.access_type=ey;aQ.SharedFolderActivityLogger.log("web","invite_modal_send_invites_button",this.user,ew);ev=(function(eB){return function(eD){var eC;eC=du.get_containing_modal(eB.$root);if(eC&&eC instanceof ca){eC.fetch()}else{dm.pop()}Y.success(eD.responseText);return document.fire(av.SF_INVITE,{target_ns_id:eB.ns_id,user_id:eB.user.id})}})(this);ex=(function(eB){return function(eC){return d2.show_validation_error(eC,eB.$root.find(".tokenized_autocompleter_container"))}})(this);return this.sharing_api.invite_more_to_folder(this.ns_id,eA,ez,ey,ev,ex)};T.prototype.reinvite_user=function(ex,ev,ew){return this.sharing_api.reinvite_user(ev,ew,(function(ey){return function(eF){var eC,eD,eE,eB,ez,eA;eB=JSON.parse(eF.responseText);ez=eB.status;if(ez==="OK"){eA=dU("%(email_or_fbname)s was reinvited successfully");eA=eA.format({email_or_fbname:ex});return Y.success(eA)}else{eE=eB.reason;if(eE==="ACCEPTED"){eC=dU("That invitation has already been accepted.")}else{if(eE==="DECLINED"){eC=dU("That invitation has already been declined.")}else{eC=dU("You no longer have permission to perform this action.")}}Y.error(eC);if(eB.reload){eD=du.get_containing_modal(ey.$root);if(eD&&eD instanceof ca){return eD.fetch()}}}}})(this))};T.prototype.update_sf_perms=function(ew){var ex,ey,ev;this.$root.find("#change-sf-perm-saving").show();ex=(ew?1:0);ev=(function(ez){return function(eA){if(ew){Y.success(dU("Editors can now manage membership of this folder."))}else{Y.success(dU("Editors can no longer manage membership of this folder."))}return ez.$root.find("#change-sf-perm-saving").hide()}})(this);ey=(function(ez){return function(eA){if(eA.responseText.indexOf("err:")===0){Y.error(eA.responseText.substr(4))}else{Y.error(dU("Error updating your preference! Please try again."))}return ez.$root.find("#change-sf-perm-saving").hide()}})(this);return this.sharing_api.update_sf_permissions(this.ns_id,ex,ev,ey)};T.prototype.update_tf_access=function(ew){var ex,ev;ev=(function(ey){return function(ez){if(ew){return Y.success(dU("Team members can now change folder contents."))}else{return Y.success(dU("Team members can no longer change folder contents."))}}})(this);ex=(function(ey){return function(ez){return Y.error(dU("Error updating your preference! Please try again."))}})(this);return this.sharing_api.update_group_access_type(this.ns_id,this.$root.data("group-gid"),ew,ev,ex)};T.prototype.show_kick_user_modal=function(ex,ew,ev){return dm.push(new d8(this.user,{element_id:"kick-confirm-modal",ns_id:this.ns_id,user_name:ex,folder_path:this.path,user_id:ev}))};T.prototype.show_kick_group_modal=function(ev,ew){return dm.push(new aF(this.user,{element_id:"kick-group-confirm-modal",ns_id:this.ns_id,group_name:ev,folder_path:this.path,group_id:ew}))};T.prototype.show_transfer_user_modal=function(ex,ew,ev){return dm.push(new bm(this.user,{element_id:"transfer-confirm-modal",user_id:ev,user_name:ex,ns_id:this.ns_id,folder_path:this.path}))};T.prototype.show_uninvite_modal=function(ex,ev,ew){return dm.push(new aw(this.user,{element_id:"uninvite-confirm-modal",email_or_fbname:ex,ns_id:ev,invite_id:ew,folder_path:this.path}))};T.prototype.show_unshare_folder_modal=function(){return dm.push(new bD(this.user,{element_id:"unshare-confirm-modal",team_shared_folder:this.team_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};T.prototype.show_access_request_link_modal=function(){return dm.push(new cI(this.user.id,this.path,void 0,true))};T.prototype.show_owner_leave_folder_warning=function(){return Y.error(dU("You can't leave this folder because you're the owner. You must transfer ownership to another member before you can leave."))};T.prototype.show_leave_folder_modal=function(){return dm.push(new cT(this.user,{element_id:"leave-confirm-modal",team_shared_folder:this.team_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};T.prototype.toggle_to_invite_mode=function(){var ev;this.$allow_members_table.show();this.$folder_management_buttons.hide();this.$invite_form.removeClass("collapsed");return(ev=this.sf_access_type)!=null?ev.show():void 0};T.prototype.toggle_from_invite_mode=function(){var ew,ev;this.$allow_members_table.hide();this.$folder_management_buttons.show();this.$invite_form.addClass("collapsed");if((ew=this.sf_access_type)!=null){ew.hide()}return(ev=this.invite_form_controller)!=null?ev.reset_autocompleter():void 0};T.prototype.show_folder_settings=function(ev){aQ.SharedFolderActivityLogger.log("web","invite_modal_change_settings",this.user,this.log_extras);ev.preventDefault();dm.register(dS.SAVED_PERMISSIONS,(function(ew){return function(ey,ex){if(ex!=null){return ew.set_team_only(ex)}}})(this));return dm.push(new dS(this.user,this.path,this.ns_id))};T.prototype.show_email_verification=function(ev){dm.pop();return dq.get_for_user(this.user).show()};T.prototype.set_team_only=function(ev){var ew;this.invite_form_controller.set_team_only(ev);ew=this.$invite_form.add(this.$root.find(".external-invite-message,.member-info .folder-settings"));if(ev){return ew.addClass("team-only")}else{return ew.removeClass("team-only")}};return T})();cT=A.LeaveFolderModal=(function(T){cl(ev,T);function ev(){this.before_show=cU(this.before_show,this);this.on_show=cU(this.on_show,this);this.on_confirm_button_click=cU(this.on_confirm_button_click,this);return ev.__super__.constructor.apply(this,arguments)}ev.prototype.on_confirm_button_click=function(ex){var ew;ex.preventDefault();ew=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.leave_folder(this.ns_id,ew,(function(ey){return function(){var ez;ez=dU("You removed yourself from '%(msg)s'.").format({msg:bt.em_snippet(an.filename(ey.path),25)});Y.success(ez);document.fire(av.SF_LEAVE,{target_ns_id:ey.ns_id,folder_deleted:!ew,user_id:ey.user.id});return dm.clear()}})(this))};ev.prototype.on_show=function(){ev.__super__.on_show.apply(this,arguments);if(this.team_shared_folder){this.$modal_window.find(".keep_files_option").hide();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",false)}else{this.$modal_window.find(".keep_files_option").show();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",true)}};ev.prototype.before_show=function(){var ew;ew=dU("Leave the shared folder '%(folder_name)s'");ew=ew.format({folder_name:bt.em_snippet(an.filename(this.path),14)});return this.format({".db-modal-title-text":ew})};return ev})(dc);bD=A.UnshareFolderModal=(function(ev){cl(T,ev);function T(){this.before_show=cU(this.before_show,this);this.on_show=cU(this.on_show,this);this.on_confirm_button_click=cU(this.on_confirm_button_click,this);return T.__super__.constructor.apply(this,arguments)}T.prototype.on_confirm_button_click=function(ex){var ew;ex.preventDefault();ew=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.unshare_folder(this.ns_id,ew,(function(ey){return function(){var ez;ez=dU("Unshared folder '%(folder_name)s'");ez=ez.format({folder_name:bt.em_snippet(an.filename(ey.path),25)});Y.success(ez);document.fire(av.SF_UNSHARE,{target_ns_id:ey.ns_id,user_id:ey.user.id});return dm.clear()}})(this))};T.prototype.on_show=function(){T.__super__.on_show.apply(this,arguments);if(this.team_shared_folder){this.$modal_window.find(".tsf_unshare_desc").show();return this.$modal_window.find(".regular_unshare_desc").hide()}else{this.$modal_window.find(".tsf_unshare_desc").hide();return this.$modal_window.find(".regular_unshare_desc").show()}};T.prototype.before_show=function(){var ew;ew=dU("Unshare '%(folder_name)s'");ew=ew.format({folder_name:bt.em_snippet(an.filename(this.path),21)});return this.format({".db-modal-title-text":ew})};return T})(dc);aw=A.UninviteModal=(function(ev){cl(T,ev);function T(ew,ex){this.before_show=cU(this.before_show,this);this.on_confirm_button_click=cU(this.on_confirm_button_click,this);this.email_or_fbname=ex.email_or_fbname;this.ns_id=ex.ns_id;this.invite_id=ex.invite_id;T.__super__.constructor.call(this,ew,ex)}T.prototype.on_confirm_button_click=function(ew){ew.preventDefault();return this.sharing_api.cancel_invite(this.ns_id,this.invite_id,(function(ex){return function(eD){var eB,eC,eA,ey,ez;eA=JSON.parse(eD.responseText);ey=eA.status;if(ey==="OK"){ez=dU("%(email_or_fbname)s has been uninvited.").format({email_or_fbname:ex.email_or_fbname});Y.success(ez)}else{eC=eA.reason;if(eC==="ACCEPTED"){eB=dU("That invitation has already been accepted.")}else{if(eC==="DECLINED"){eB=dU("That invitation has already been declined.")}}Y.error(eB)}return dm.pop()}})(this))};T.prototype.before_show=function(ew){var ex;ex=dU("Uninvite %(email_or_fbname)s?").format({email_or_fbname:bt.em_snippet(this.email_or_fbname,20)});return this.format({".uninvite-confirm-nickname":this.email_or_fbname,".uninvite-confirm-folder-name":an.filename(this.path),".db-modal-title-text":ex})};return T})(dc);d8=A.KickUserModal=(function(T){cl(ev,T);function ev(ew,ex){this.user=ew;this.options=ex;this.before_show=cU(this.before_show,this);this.on_confirm_button_click=cU(this.on_confirm_button_click,this);this.user_id=ex.user_id;this.user_name=ex.user_name;ev.__super__.constructor.call(this,ew,ex)}ev.prototype.on_confirm_button_click=function(ey){var ew,ex;ey.preventDefault();ew=this.$modal_window.find("#keep-files-check").prop("checked");this.sharing_api.kick(this.ns_id,this.user_id,ew,(function(ez){return function(){Y.success(dU("User removed successfully."));bz.reload_folder_info_if_two_account();return dm.pop()}})(this));ex={ns_id:this.ns_id,kick_user_id:this.user_id,keep_files:ew};return aQ.SharedFolderActivityLogger.log("web","invite_modal_kick_collaborator",this.user,ex)};ev.prototype.before_show=function(ew){var ex;ex=dU("Remove %(person_name)s from this folder?");ex=ex.format({person_name:this.user_name});return this.format({".kick-confirm-nickname":this.user_name,".db-modal-title-text":ex})};return ev})(dc);aF=A.KickGroupModal=(function(T){cl(ev,T);function ev(ew,ex){this.user=ew;this.options=ex;this.before_show=cU(this.before_show,this);this.on_confirm_button_click=cU(this.on_confirm_button_click,this);this.group_id=ex.group_id;this.group_name=ex.group_name;ev.__super__.constructor.call(this,ew,ex)}ev.prototype.on_confirm_button_click=function(ew){ew.preventDefault();return __CIRCULAR_DEPENDENCY__.GroupsApi.remove_namespace_from_group({group_id:this.group_id,ns_id:this.ns_id},(function(ex){return function(){Y.success(dU("Group removed successfully."));bz.reload_folder_info_if_two_account();return dm.pop()}})(this))};ev.prototype.before_show=function(){var ew;ew=dU("Remove %(group_name)s from this folder?");ew=ew.format({group_name:this.group_name});return this.format({".kick-confirm-nickname":this.group_name,".db-modal-title-text":ew})};return ev})(dc);b5=A.MakeOwnerModal=(function(ev){cl(T,ev);function T(ew,ex){this.user=ew;this.options=ex;this.before_show=cU(this.before_show,this);this.on_confirm_button_click=cU(this.on_confirm_button_click,this);this.member_uid=ex.member_uid;this.member_name=ex.member_name;this.ns_id=ex.ns_id;this.access_type=ex.access_type;T.__super__.constructor.call(this,ew,ex)}T.prototype.on_confirm_button_click=function(ew){ew.preventDefault();return this.sharing_api.update_member_access_type(this.ns_id,this.member_uid,this.access_type,(function(ex){return function(){Y.success(dU("%(name)s now is the owner.").format({name:ex.member_name}));return dm.pop()}})(this))};T.prototype.before_show=function(){var ew;ew=dU("Make %(name)s the owner of this folder?");ew=ew.format({name:bt.em_snippet(this.member_name,14)});return this.format({".make-owner-confirm-nickname":this.member_name,".db-modal-title-text":ew})};return T})(dc);bm=A.TransferOwnershipModal=(function(ev){cl(T,ev);function T(ew,ex){this.user=ew;this.options=ex;this.before_show=cU(this.before_show,this);this.on_confirm_button_click=cU(this.on_confirm_button_click,this);this.user_id=ex.user_id;this.user_name=ex.user_name;T.__super__.constructor.call(this,ew,ex)}T.prototype.on_confirm_button_click=function(ew){ew.preventDefault();return this.sharing_api.transfer_ownership(this.ns_id,this.user_id,(function(ex){return function(ey){Y.success(dU("Ownership changed successfully"));return dm.pop()}})(this))};T.prototype.before_show=function(){var ew;ew=dU("Make %(person_name)s the owner of this folder?");ew=ew.format({person_name:bt.em_snippet(this.user_name,14)});return this.format({".change_sf_owner-confirm-nickname":this.user_name,".db-modal-title-text":ew})};return T})(dc);dS=A.ExistingSharedFolderPermissionsModal=(function(ev){cl(T,ev);T.SAVED_PERMISSIONS="existing_sf_permissions:saved";function T(ex,ey,ew){var eA,ez;this.user=ex;this.path=ey;this.ns_id=ew;eA={ns_id:this.ns_id,folder_name:this.path};eA[Constants.UID_PARAM_NAME]=this.user.id;ez=dU("'%(folder_name)s' settings");ez=ez.format({folder_name:bt.em_snippet(an.filename(this.path),13)});T.__super__.constructor.call(this,{element_id:"folder-permissions-modal",title:ez,endpoint_url:"/share_ajax/folder_settings",parameters:eA})}return T})(ca);L=A.ExistingSharedFolderPermissionsContent=(function(){function T(ew,ex,ev){this.$form=ew;this.ns_id=ev;this._submit=cU(this._submit,this);this.user=cj.get_viewer().get_user_by_id(ex);this.sharing_api=new aZ(this.user);this.sharing_api.loading_elem=this.$form;this._listen()}T.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};T.prototype._cancel=function(){return dm.pop()};T.prototype._submit=function(eA){var eB,ev,ey,ex,ew,ez;eA.preventDefault();ev=this.$form.find("input[name=audience]:checked").val();ey=this.$form.find("input[name=inviter]:checked").val();ew=this.$form.find("input[name=shared_link_policy]:checked").val();eB=(ez=this.$form.find("input[name=activity_feed_enabled]:checked"))!=null?ez.val():void 0;this.sharing_api.update_sf_team_permissions(this.ns_id,ev,ey,ew,eB,(function(eC){return function(eE){var eD,eF;eD=JSON.parse(eE.responseText);eF=eD.team_only_invite;Y.success(eD.message);dm.trigger(dS.SAVED_PERMISSIONS,eF);return dm.pop()}})(this));false;ex={ns_id:this.ns_id,audience:ev,inviter:ey};return aQ.SharedFolderActivityLogger.log("web","settings_modal_save",this.user,ex)};return T})();var aL,dt,ec,dk,d2,bY,b8,dM,cC,bO,br,cu,ct,cr,cp,am={}.hasOwnProperty,cl=function(ex,ev){for(var T in ev){if(am.call(ev,T)){ex[T]=ev[T]}}function ew(){this.constructor=ex}ew.prototype=ev.prototype;ex.prototype=new ew();ex.__super__=ev.prototype;return ex},cU=function(T,ev){return function(){return T.apply(ev,arguments)}};aL=A.BaseShareAFolderWizardModal=(function(T){cl(ev,T);ev.prototype.base_title=null;ev.prototype.personal_title=null;ev.prototype.work_title=null;function ev(ew,ex){this.user=ew;this.options=ex;ev.__super__.constructor.call(this,this.options);this.sharing_api=new aZ(this.user)}ev.prototype.before_show=function(){var ew;this.sharing_api.loading_elem=this.$modal_window;ew=this.base_title;if(cj.get_viewer().is_paired){if(this.user.role==="personal"){ew=this.personal_title}else{ew=this.work_title.format({team_name:cj.get_viewer().team_name})}}return this.format({".db-modal-title-text":ew})};return ev})(du);dM=A.ShareAFolderWizardModal=(function(T){cl(ev,T);function ev(ew,ex){this.user=ew;this.options=ex;ev.__super__.constructor.call(this,this.user,this.options);this.base_title=dU("Share a folder");this.personal_title=dU("Share a folder from your personal Dropbox");this.work_title=dU("Share a folder from your %(team_name)s Dropbox")}ev.prototype.on_show=function(){this.$modal_window.find("input#create-new-sf").prop("checked",true);this.$modal_window.find("a.back").on("click",(function(ew){return function(ex){ex.preventDefault();p.start_wizard_without_user();return ew.hide()}})(this));return this.$modal_window.find("#new-or-existing-sf li").on("click",(function(ew){return function(ex){bf(ex.currentTarget).find('input[name="sf_type"]').prop("checked",true);if(ew.$modal_window.find("input#create-new-sf").is(":checked")){return aQ.SharedFolderActivityLogger.log("web","new_or_existing_modal_new_folder",ew.user)}else{return aQ.SharedFolderActivityLogger.log("web","new_or_existing_modal_existing_folder",ew.user)}}})(this))};ev.prototype.on_confirm_button_click=function(eC){var ez,eB,ew,ey,eA,ex;eC.preventDefault();eB=this.$modal_window.find("input#create-new-sf").is(":checked");if(eB){ey=null;if(this.user.role==="work"){eA="shared-folder-type-wizard-modal";ex=du.get_template(eA);if(ex.length){ey=new br(this.user,{element_id:eA})}}if(ey===null){ey=new bO(this.user,{element_id:"share-new-folder-wizard-modal"})}this.hide();ew={selection:"new_folder"};aQ.SharedFolderActivityLogger.log("web","new_or_existing_modal_next_button",this.user,ew);return ey.show()}ez=this.$modal_window.find(".ajax-loading-indicator").show();return bf.ajax({url:"/share_ajax/account_has_existing_folders",type:"post",subject_user:this.user,success:(function(eD){return function(eE){var eF;eE=JSON.parse(eE);if(eE===true){ey=new cC(eD.user,{element_id:"share-existing-folder-wizard-modal"});ew.has_existing_folder=true}else{eF=dU("You don't have any existing folders. Please create and share a new folder.");ey=new bO(eD.user,{element_id:"share-new-folder-wizard-modal",error_msg:eF});ew.has_existing_folder=false}eD.hide();return ey.show()}})(this),error:(function(eD){return function(){return Y.error()}})(this),complete:(function(eD){return function(){return ez.hide()}})(this)},ew={selection:"existing_folder"},aQ.SharedFolderActivityLogger.log("web","new_or_existing_modal_next_button",this.user,ew))};return ev})(aL);br=A.SharedFolderTypeWizardModal=(function(ev){cl(T,ev);function T(ew,ex){this.user=ew;this.options=ex;T.__super__.constructor.call(this,this.user,this.options);this.work_title=dU("Share a folder from your %(team_name)s Dropbox")}T.prototype.on_show=function(){this.$modal_window.find("input#team-folder-option").prop("checked",true);this.$modal_window.find("a.back").on("click",(function(ew){return function(ex){ex.preventDefault();p.start_wizard_for_user(ew.user);return ew.hide()}})(this));return this.$modal_window.find("#shared-folder-type li").on("click",(function(ew){return function(ex){bf(ex.currentTarget).find('input[name="shared_folder_type"]').prop("checked",true);if(ew.$modal_window.find("input#team-folder-option").is(":checked")){return aQ.SharedFolderActivityLogger.log("web","shared_folder_type_team_folder",ew.user)}else{return aQ.SharedFolderActivityLogger.log("web","shared_folder_type_shared_folder",ew.user)}}})(this))};T.prototype.on_confirm_button_click=function(eA){var ew,ey,ez,ex;eA.preventDefault();ew=(function(eB){return function(eE,eC){var eD;eE.preventDefault();eC.hide();eD=new eB.constructor(eB.user,eB.options);return eD.show()}})(this);ey=this.$modal_window.find("input#team-folder-option").is(":checked");if(ey){ez=new di({element_id:"new-team-folder-modal",open_created_folder:true,back_fn:ew});ex="team_folder"}else{ez=new bO(this.user,{element_id:"share-new-folder-wizard-modal",back_fn:ew});ex="shared_folder"}aQ.SharedFolderActivityLogger.log("web","shared_folder_type_next_button",this.user,{selection:ex});this.hide();return ez.show()};return T})(aL);d2=A.InlineModalValidationError=(function(){function T(){}T.show_validation_error=function(eC,ey){var ez,eA,ex,ew,eB,ev;if(eC.responseText.indexOf("err:{")===0){ev=eC.responseText.substr(4);eB=JSON.parse(ev);for(eA in eB){ez=eB[eA];if("message_text" in ez){ew=ey.find("span.error-message");if(ew.length===0){ew=bf("<span/>").addClass("error-message");ey.prepend(ew)}ew.text(ez.message_text);return}}ey.find("span.error-message").remove();return Y.error()}else{ey.find("span.error-message").remove();if(eC.responseText.indexOf("err:")===0){ex=eC.responseText.substr(4);return Y.error(ex)}else{return Y.error()}}};return T})();cu=A.TeamSharedFolderWizardModalPage1=(function(T){cl(ev,T);function ev(ew,ex){this.user=ew;this.options=ex;this.__fix_position=cU(this.__fix_position,this);ev.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page1 input[type=text]";this.base_title=dU("Now, let's set up your team");this.options.vertical_offset=5}ev.prototype.on_show=function(){var ex,ez,ew,ey;ey=this.$modal_window.find(".suggestion-input");for(ez=0,ew=ey.length;ez<ew;ez++){ex=ey[ez];cz.register($(ex))}this.$modal_window.find("#validate-team-name").submit((function(eA){return function(eB){eB.preventDefault();return eA.on_confirm_button_click(eB)}})(this));if(this.options.error_msg){Y.error(this.options.error_msg)}return aQ.SharedFolderActivityLogger.log("web","team_shared_group_name_land",this.user)};ev.prototype.on_confirm_button_click=function(ez){var ex,ew,ey;ez.preventDefault();ey=this.$modal_window.find("#new-team-shared-folder-name-input").val();ew=(function(eA){return function(){var eB;eB=new ct(eA.user,{team_name:ey,element_id:"team-shared-folder-wizard-modal-page2"});eA.hide();return eB.show()}})(this);ex=(function(eA){return function(eB){aQ.SharedFolderActivityLogger.log("web","team_shared_group_name_folder_exists",eA.user);return d2.show_validation_error(eB,eA.$modal_window.find("#validate-team-name"))}})(this);return this.sharing_api.validate_new_sf_path(ey,ew,ex)};ev.prototype.__fix_position=function(ex){var ew;ew=this.$modal_window.find(".db-modal");return ew.css({margin:"0",position:"fixed"})};return ev})(aL);ct=A.TeamSharedFolderWizardModalPage2=(function(T){cl(ev,T);function ev(ew,ex){this.user=ew;this.options=ex;this.__fix_position=cU(this.__fix_position,this);this.on_confirm_button_click=cU(this.on_confirm_button_click,this);ev.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-email1 input[type=text]";this.base_title=dU("Invite teammates");this.folder_name=this.options.team_name}ev.prototype.before_show=function(){var ew;ew=dU("Add people to %(folder_name)s").format({folder_name:this.folder_name});return this.format({"#figcaption_headline":ew})};ev.prototype.on_show=function(){aQ.SharedFolderActivityLogger.log("web","team_shared_group_emails_land",this.user);return this.$modal_window.find("#enter-email-invites").submit((function(ew){return function(ex){ex.preventDefault();return ew.on_confirm_button_click(ex)}})(this))};ev.prototype.on_confirm_button_click=function(eA){var ey,ex,eC,ew,eB,ez;eA.preventDefault();eC={emails:[]};aQ.SharedFolderActivityLogger.log("web","team_shared_group_emails_submit",this.user);for(ew=ez=1;ez<=10;ew=++ez){ey=this.$modal_window.find("#new-team-shared-folder-email"+ew).val();if(ey){eC.emails.push(ey)}}ex=dq.getForRole(b2.active_user.role);if(!ex.verified_or_show()){aQ.SharedFolderActivityLogger.log("web","team_shared_group_not_email_verified",this.user);return ex.send_email("share_folder",(function(eD){return function(){var eE;eE=new cr(eD.user,{element_id:"team-shared-folder-wizard-modal-page3",folder_name:eD.folder_name,invitees:eC,from_email_verification:true});eD.hide();return eE.show()}})(this))}else{aQ.SharedFolderActivityLogger.log("web","team_shared_group_email_verified",this.user);eB=new cr(this.user,{element_id:"team-shared-folder-wizard-modal-page3",folder_name:this.folder_name,invitees:eC,from_email_verification:true});this.hide();return eB.show()}};ev.prototype.__fix_position=function(ex){var ew;ew=this.$modal_window.find(".db-modal");ew.css;return{margin:"0",position:"fixed"}};return ev})(aL);cr=A.TeamSharedFolderWizardModalPage3=(function(ev){cl(T,ev);function T(ew,ex){this.user=ew;this.options=ex;this.__fix_position=cU(this.__fix_position,this);T.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page3 input[type=text]";this.base_title=dU("Creating %(folder_name)s team and sending invites!").format({folder_name:this.options.folder_name})}T.prototype.on_show=function(){var eB,ez,ey,ex,eD,eC,eA,ew;aQ.SharedFolderActivityLogger.log("web","team_shared_group_interstitial",this.user);this.$modal_window.find("#db-modal-close-x").click((function(eE){return function(eF){eF.preventDefault();return eE.on_close_button_click(eF)}})(this));eD="";eC=true;ez=false;ex="all";eA=false;eB=null;ew=(function(eE){return function(eH){var eF,eG;eF=JSON.parse(eH.responseText);Y.success(eF.success_msg);eG=new cp(eE.user,{element_id:"team-shared-folder-wizard-modal-page4",folder_name:eE.options.folder_name,invitees:eE.options.invitees,from_email_verification:true});eE.hide();return eG.show()}})(this);ey=(function(eE){return function(eF){return eE.hide()}})(this);return this.sharing_api.share_folder(eC,this.options.folder_name,this.options.invitees,eD,ez,ex,eA,eB,false,ew,ey)};T.prototype.on_confirm_button_click=function(ew){ew.preventDefault();return this.hide()};T.prototype.__fix_position=function(ex){var ew;ew=this.$modal_window.find(".db-modal");return ew.css({margin:"0",position:"fixed"})};return T})(aL);cp=A.TeamSharedFolderWizardModalPage4=(function(ev){cl(T,ev);function T(ew,ex){this.user=ew;this.options=ex;this.__fix_position=cU(this.__fix_position,this);T.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page4 input[type=text]";this.base_title=dU("%(folder_name)s created and invites sent!").format({folder_name:this.options.folder_name})}T.prototype.before_show=function(){var ew;ew=this.$modal_window.find("#back_to_home");ew.attr("href","/home/"+this.options.folder_name);return this.format({"#figcaption_headline":this.base_title})};T.prototype.on_show=function(){return aQ.SharedFolderActivityLogger.log("web","team_shared_group_final",this.user)};T.prototype.__fix_position=function(ex){var ew;ew=this.$modal_window.find(".db-modal");return ew.css({margin:"0",position:"fixed"})};return T})(aL);bO=A.ShareNewFolderWizardModal=(function(ev){cl(T,ev);function T(ew,ex){this.user=ew;this.options=ex;this.options.focus="#new-shared-folder-wizard input[type=text]";T.__super__.constructor.call(this,this.user,this.options);this.base_title=dU("Create a new shared folder");this.personal_title=dU("Create a shared folder in your personal Dropbox");this.work_title=dU("Create a shared folder in your %(team_name)s Dropbox")}T.prototype.on_show=function(){var ex,ez,ew,ey;ey=this.$modal_window.find(".suggestion-input");for(ez=0,ew=ey.length;ez<ew;ez++){ex=ey[ez];cz.register($(ex))}this.$modal_window.find("#validate-folder-name").submit((function(eA){return function(eB){eB.preventDefault();return eA.on_confirm_button_click(eB)}})(this));if(this.options.error_msg){Y.error(this.options.error_msg)}return this.$modal_window.find("a.back").on("click",(function(eA){return function(eB){if(eA.options.back_fn){return eA.options.back_fn(eB,eA)}else{eB.preventDefault();eA.hide();return p.start_wizard_for_user(eA.user)}}})(this))};T.prototype.on_confirm_button_click=function(ez){var ey,eA,ex,ew;ez.preventDefault();eA=this.$modal_window.find("#new-shared-folder-name-input").val();ex={folder_name:eA};aQ.SharedFolderActivityLogger.log("web","name_new_folder_modal_next_button",this.user,ex);bf(document).trigger("db:share_new_folder:next");ew=(function(eB){return function(){var eC;eC=new bY(eB.user,{folder_name:eA,element_id:"invite-to-new-sf-wizard-modal-"+eB.user.id});eB.hide();eC.new_folder=true;eC.show();return aQ.SharedFolderActivityLogger.log("web","name_new_folder_modal_success",eB.user,ex)}})(this);ey=(function(eB){return function(eC){var eD;eD=bQ.extract_errors(eC.responseText);aQ.SharedFolderActivityLogger.log("web","name_new_folder_modal_fail",eB.user,ex);if(eD===false){}else{if(typeof eD==="string"){return Y.error(eD)}else{bf("#new-shared-folder-name-input .error-message").remove();return bQ.fill_errors(bf("#validate-folder-name"),eD)}}}})(this);return this.sharing_api.validate_new_sf_path(eA,ew,ey)};return T})(aL);cC=A.ShareExistingFolderWizardModal=(function(ev){cl(T,ev);function T(ew,ex){this.user=ew;this.options=ex;this._hide=cU(this._hide,this);this.on_show=cU(this.on_show,this);T.__super__.constructor.call(this,this.user,this.options);this.base_title=dU("Choose folder to share");this.personal_title=dU("Choose a folder from your personal Dropbox");this.work_title=dU("Choose a folder from your %(team_name)s Dropbox")}T.prototype.on_show=function(){this.treeview_id="copy-move-treeview";this.treeview_parent_id=bf("#"+this.treeview_id).parent().attr("id");bC.schedule_reset();bC.move(this.treeview_id,"share-existing-treeview",{onSuccess:((function(ew){return function(){var ex;bf(document).on("db:treeview_selected",function(ez,ey){return ew.folder_name=ey});ex=bf(".first-treeview-link");if(!ds.ie){return ex.click()}}})(this)),user:this.user});return this.$modal_window.find("a.back").on("click",(function(ew){return function(ex){ex.preventDefault();ew.hide();return p.start_wizard_for_user(ew.user)}})(this))};T.prototype._hide=function(){bC.move(this.treeview_id,this.treeview_parent_id,{user:this.user});return T.__super__._hide.apply(this,arguments)};T.prototype.on_hide=function(){return bf(document).off("db:treeview_selected")};T.prototype.on_confirm_button_click=function(ez){var ey,ex,ew;ex={folder_name:this.folder_name};ez.preventDefault();if(this.folder_name&&this.$modal_window.find("#copy-move-treeview .highlight .s_web_folder_user").length){this.hide();aQ.SharedFolderActivityLogger.log("web","choose_folder_modal_shared_next",this.user,ex);return p.show_shared_folder_options_modal(this.folder_name,this.user)}else{ew=(function(eA){return function(){var eB;eB=new bY(eA.user,{folder_name:eA.folder_name,element_id:"invite-to-new-sf-wizard-modal-"+eA.user.id});eA.hide();aQ.SharedFolderActivityLogger.log("web","choose_folder_modal_not_shared_next",eA.user,ex);eB.new_folder=false;return eB.show()}})(this);ey=(function(eA){return function(eB){return d2.show_validation_error(eB,eA.$modal_window.find("#choose-existing-folder"))}})(this);return this.sharing_api.validate_existing_sf_path(this.folder_name,ew,ey)}};return T})(aL);dk=A.CreateLinkOrInviteToFolderWizardModal=(function(ev){cl(T,ev);function T(ew,ex){this.user=ew;this.options=ex;T.__super__.constructor.call(this,this.options);this.sharing_api=new aZ(this.user)}T.prototype.before_show=function(){var ew;this.sharing_api.loading_elem=this.$modal_window;ew=dU("Share '%(folder_name)s' with others");ew=ew.format({folder_name:bt.em_snippet(an.filename(this.options.path),16)});return this.format({".db-modal-title-text":ew})};T.prototype.on_show=function(){var ew,ey,ex;ew="edu_modal";ey=(ex=this.options.target_item)!=null?ex:null;aQ.ShmodelUILogger.log("view",ew,ey);this.$modal_window.find(".option-to-share-folder").on("click",(function(ez){return function(eB){var eA;if(ez.options.existing_sf){aQ.ShmodelUILogger.log("sf_options",ew,ey);eA=new cH(b2.active_user,ez.options.path)}else{aQ.ShmodelUILogger.log("sf_invite",ew,ey);eA=new bY(ez.user,{folder_name:ez.options.path,element_id:"invite-to-new-sf-wizard-modal-"+ez.user.id})}ez.hide();return eA.show()}})(this));this.$modal_window.find(".option-to-share-link").on("click",(function(ez){return function(eA){aQ.ShmodelUILogger.log("token_share",ew,ey);cV.shmodel(ez.options.path,"create_link_or_invite_to_folder_modal");return ez.hide()}})(this));return this.$modal_window.find(".learn-more").on("click",(function(ez){return function(eA){eA.preventDefault();aQ.ShmodelUILogger.log("clicked_learn_more",ew,ey);return window.open("/help/274","_blank")}})(this))};return T})(du);bY=A.InviteToNewSharedFolderWizardModal=(function(ev){cl(T,ev);function T(ew,ex){this.user=ew;this.options=ex;this.insert_folder_settings=cU(this.insert_folder_settings,this);this.share_folder=cU(this.share_folder,this);this.on_confirm_button_click=cU(this.on_confirm_button_click,this);this.show_settings_modal=cU(this.show_settings_modal,this);this.options.focus=".new-collab-input";T.__super__.constructor.call(this,this.options);this.sharing_api=new aZ(this.user);this.folder_name=this.options.folder_name;this.is_file=this.options.is_file;this.must_check_verified=(this.options.must_check_verified!=null)||false;this.progress_ever_blocked_by_verify=false}T.prototype.before_show=function(){var ew;this.sharing_api.loading_elem=this.$modal_window;ew=dU("Share '%(folder_name)s' with others");ew=ew.format({folder_name:bt.em_snippet(an.filename(this.folder_name),16)});return this.format({".db-modal-title-text":ew})};T.prototype.on_show=function(){var ex,ey,eB,eA,ew,ez;ez=this.$modal_window.find(".suggestion-input");for(eA=0,ew=ez.length;eA<ew;eA++){ey=ez[eA];cz.register($(ey))}ex=this.$modal_window.find(".invite-more-form");if(!this.invite_form_controller){eB="invite-wizard-"+this.user.id;this.invite_form_controller=new cG(this.user,ex,[],[],[],eB);if(this.invite_form_controller.team_only){this.insert_folder_settings("team")}}else{this.invite_form_controller.listen()}this.$modal_window.find(".new-collab-input").focus();this.$modal_window.find(".change-new-folder-settings").on("click",(function(eC){return function(eD){eD.preventDefault();return eC.show_settings_modal()}})(this));this.log_extras={path:this.folder_name};aQ.SharedFolderActivityLogger.log("web","share_folder_modal_displayed",this.user,this.log_extras);if(this.is_file){return aQ.SharedFolderActivityLogger.log("web","single_file_unshared_invite_modal_displayed",this.user,this.log_extras)}};T.prototype.show_settings_modal=function(){var ex,ew;ew=dU("'%(folder_name)s' settings");ew=ew.format({folder_name:bt.em_snippet(an.filename(this.folder_name),13)});ex={folder_name:this.folder_name};if(this.audience_restriction){ex.audience=this.audience_restriction}if(this.inviter_restriction){ex.inviter=this.inviter_restriction}if(this.shared_link_policy_restriction){ex.shared_link_policy=this.shared_link_policy_restriction}ex[Constants.UID_PARAM_NAME]=this.user.id;if(this.is_file){ex.is_file=this.is_file}dm.register(b8.SAVED_PERMISSIONS,(function(ey){return function(eA,ez){ey.insert_folder_settings(ez.audience,ez.inviter,ez.shared_link_policy);return ey.invite_form_controller.reset_options()}})(this));return dm.push(new ca({element_id:"folder-permissions-modal",title:ew,endpoint_url:"/share_ajax/default_folder_settings",parameters:ex}))};T.prototype.on_confirm_button_click=function(ez){var ey,ex,eB,ew,eA;ez.preventDefault();this.invite_form_controller.tokenize();eB=this.invite_form_controller.extract_invitees();eA=this.invite_form_controller.get_custom_message();ey=this.invite_form_controller.get_access_type();ew=this.$modal_window.find("input#allow_other_members_to_share");if(ew.length>0){this.inviter_restriction=ew.is(":checked")?"all":"me"}if(this.is_file){ex=new ec(this.user,{element_id:"confirm-share-new-file-wizard-modal",invitees:eB,msg:eA,access_type:ey,audience_restriction:this.audience_restriction,inviter_restriction:this.inviter_restriction,shared_link_policy_restriction:this.shared_link_policy_restriction,file_path:this.folder_name});this.hide();ex.show();return aQ.SharedFolderActivityLogger.log("web","single_file_unshared_invite_modal_continued",this.user,this.log_extras)}else{return this.share_folder(eB,eA,ey,true,false)}};T.prototype.share_folder=function(eB,ey,ew,eC,eA,ex){var eG,ez,eD,eF,eE;if(eC==null){eC=true}if(eA==null){eA=false}if(ex==null){ex=false}ez=(function(eH){return function(eI){return d2.show_validation_error(eI,eH.$modal_window.find(".tokenized_autocompleter_container"))}})(this);eF=(function(eH){return function(eK){var eJ,eI;eI=JSON.parse(eK.responseText);Y.success(eI.success_msg);if(eH.progress_ever_blocked_by_verify){aQ.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_share_succeess",eH.user,eD)}document.fire(av.SF_NEW,{sf_info:bz.decode_sort_key(eI.sf_info)});if(eC){eH.hide()}if(ex){eJ=new cH(eH.user,an.normalize(eH.folder_name));return eJ.show()}}})(this);if(this.must_check_verified&&!this.user.is_email_verified){this.progress_ever_blocked_by_verify=true;aQ.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_blocked_on_verify",this.user,eD);this.$modal_window.find(".confirm-button").prop("disabled",true);eE=dU("Verification email sent to %(email)s").format({email:this.user.email});eG=dq.get_for_user(this.user);eG.send_email("share_folder",function(){return Y.success(eE)});bf("#resend-email-verification-link").click(function(){return eG.send_email("share_folder",function(){return Y.success(eE)})});this.$modal_window.find(".email-verify-message").show();return eG.ensure_polling((function(eH){return function(){aQ.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_unblocked",eH.user,eD);Y.success(dU("Email verified. Try sharing your folder again."));eH.$modal_window.find(".confirm-button").prop("disabled",false);return eH.$modal_window.find(".email-verify-message").hide()}})(this))}else{this.sharing_api.share_folder(this.new_folder,this.folder_name,eB,ey,this.audience_restriction,this.inviter_restriction,this.shared_link_policy_restriction,ew,eA,eF,ez);eD={path:this.folder_name,access_type:ew};aQ.SharedFolderActivityLogger.log("web","invite_modal_share_folder_button",this.user,eD);return bf(document).trigger("db:invite_to_new_folder:share")}};T.prototype.insert_folder_settings=function(ex,ew,ez){var ey;this.audience_restriction=ex;this.inviter_restriction=ew;this.shared_link_policy_restriction=ez;ey=this.$modal_window.find(".invite-more-form, .external-invite-message,.folder-settings");if(this.audience_restriction==="team"){this.invite_form_controller.set_team_only(true);return ey.addClass("team-only")}else{this.invite_form_controller.set_team_only(false);return ey.removeClass("team-only")}};return T})(du);ec=A.ConfirmShareNewFileWizardModal=(function(T){cl(ev,T);function ev(ew,ex){this.user=ew;this.options=ex;ev.__super__.constructor.call(this,this.options);this.file_path=this.options.file_path;this.file_name=an.filename(this.file_path);this.folder_name=an.filename_without_extension(this.file_name);this.folder_path=an.parent_dir(this.file_path)+"/"+this.folder_name;this.invitees=this.options.invitees;this.msg=this.options.msg;this.audience_restriction=this.options.audience_restriction;this.inviter_restriction=this.options.inviter_restriction;this.shared_link_policy_restriction=this.options.shared_link_policy_restriction;this.access_type=this.options.access_type;this.sharing_api=new aZ(this.user);this.log_extras={path:this.file_path}}ev.prototype.before_show=function(){this.format({".confirm-share-file-invitees":this.format_invitees(),".confirm-share-file-name":this.file_name,".confirm-share-folder-name":this.folder_name});return aQ.SharedFolderActivityLogger.log("web","single_file_unshared_info_modal_displayed",this.user,this.log_extras)};ev.prototype.on_confirm_button_click=function(ey){var ex,ew;ex=(function(ez){return function(eC){var eA,eB,eD;aQ.SharedFolderActivityLogger.log("web","single_file_unshared_sharing_failed",ez.user,ez.log_extras);eD=bQ.extract_errors(eC.responseText);if(eD===false){return}else{if(typeof eD==="string"){Y.error(eD)}else{if(typeof eD==="object"){for(eB in eD){eA=eD[eB];if("message_text" in eA){Y.error(eA.message_text);break}}}}}return ez.hide()}})(this);ew=(function(ez){return function(){var eA;aQ.SharedFolderActivityLogger.log("web","single_file_unshared_sharing_succeeded",ez.user,ez.log_extras);eA=dU("%(folder_name)s was shared successfully.").format({folder_name:ez.folder_name});Y.success(eA);return ez.hide()}})(this);this.sharing_api.share_file(this.folder_path,this.file_path,this.invitees,this.msg,this.audience_restriction,this.inviter_restriction,this.shared_link_policy_restriction,this.access_type,ew,ex);return aQ.SharedFolderActivityLogger.log("web","single_file_unshared_info_modal_confirmed",this.user,this.log_extras)};ev.prototype.format_invitees=function(){var eB,eA,ey,ex,ew,ez;if(!this.invitees){return dU("others")}eB=this.invitees.emails[0];eA=this.invitees.fb_ids[0];ey=this.invitees.group_ids[0];ex=this.invitees.new_style_group_ids[0];if(!eB.length){return dU("others")}ew=eB[0];ez=eB.length+eA.length+ey.length+ex.length;if(ez>1){ew=ew+dU(" and others")}return ew};return ev})(du);dt=A.ConfirmShareExistingFileWizardModal=(function(ev){cl(T,ev);function T(ew,ex){this.user=ew;this.options=ex;T.__super__.constructor.call(this,this.options);this.folder_name=this.options.folder_name;this.folder_path=this.options.folder_path;this.log_extras={path:this.folder_name}}T.prototype.before_show=function(){this.format({".confirm-share-existing-folder-name":this.folder_name});return aQ.SharedFolderActivityLogger.log("web","single_file_shared_info_modal_displayed",this.user,this.log_extras)};T.prototype.on_confirm_button_click=function(ex){var ew;aQ.SharedFolderActivityLogger.log("web","single_file_shared_info_modal_confirmed",this.user,this.log_extras);ew=new cH(this.user,this.folder_path);this.hide();return ew.show()};return T})(du);b8=A.NewSharedFolderPermissionsContent=(function(){T.SAVED_PERMISSIONS="new_sf_permissions:saved";function T(ev){this.$form=ev;this._submit=cU(this._submit,this);this._listen()}T.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};T.prototype._cancel=function(){return dm.pop()};T.prototype._submit=function(ey){var ew,ex,ev;ey.preventDefault();ew=this.$form.find("input[name=audience]:checked").val();ex=this.$form.find("input[name=inviter]:checked").val();ev=this.$form.find("input[name=shared_link_policy]:checked").val();dm.trigger(T.SAVED_PERMISSIONS,{audience:ew,inviter:ex,shared_link_policy:ev});return dm.pop()};return T})();var cV;cV=A.SharingShmodel=(function(){function T(){}T.shmodel=function(ew,ev){return new cI(b2.active_user.id,ew,ev).show()};return T})();var bz;bz=INLINE_JS.Sharing=A.Sharing={init:function(ez,ey,ev,ex,ew,T){this.is_merged=ey;[ez.current,ez.past].each((function(eA){return function(eB){return eB.each(function(eC){return eA.decode_sort_key(eC)})}})(this));this._state={sf_info:ez,cmp:{"#sf-current":this._modified_cmp,"#sf-past":this._modified_cmp},is_ascending:{"#sf-current":false,"#sf-past":false},inbox_counts:{}};if(ey){this.role_picker=bf("#role-selector").controller();this.role_picker.on_state_change=this._render.bind(this);bo.set_during_login_callback((function(eA){return function(eC,eB){c2.set_not_logged_in_role_and_email(null,null);return eA._reload_folder_info(function(){return eB()},function(eD){eB(dU("Error displaying shared folders"));return window.location.reload()})}})(this))}c2.set_is_merged(ey);c2.set_not_logged_in_role_and_email(ev,ex);c2.set_team_name(ew);c2.set_show_inbox(T);this._listen();this._tmpl=es.tmpl("sf_list_item_tmpl");this._render();this.refresh_inbox_counts(true);return bf("#sf-view").show()},is_share_page:function(){return this._state!=null},decode_sort_key:function(T){ci((T.encoded_sort_key!=null)&&(T.sort_key==null),"expected encoded sort keys on each elm");T.sort_key=ds.decode_sort_key(T.encoded_sort_key);delete T.encoded_sort_key;return T},reload_folder_info_if_two_account:function(){if(this._showing_two_accounts()){return this._reload_folder_info()}},_reload_folder_info:function(ew,T){var ev;if(!this.is_share_page()){return}ev=(function(ex){return function(ey){var ez;ez=JSON.parse(ey.responseText);ex._state.sf_info=ez;ex._render();return typeof ew==="function"?ew():void 0}})(this);return new b0().get_folder_info(ev,T)},refresh_inbox_counts:function(T){return new b0().get_inbox_counts((function(ev){return function(ew){return ev._update_inbox_counts(ew,T)}})(this))},_update_inbox_counts:function(ev,ey){var eB,ew,T,eA,ez,ex;ex=0;for(eA in ev){eB=ev[eA];ex+=eB}bf("#inbox-count").text(ex);bf("#inbox-count").toggleClass("show",ex>0);if(!this.is_share_page()){return}ew=function(eD,eC){var eE;for(eA in eD){eE=eD[eA];if(eC[eA]!==eD[eA]){return false}}return true};if((!ey)&&this._state&&ew(this._state.inbox_counts,ev)){return}this._state.inbox_counts=ev;if(ex){T=new Element("a",{id:"new-invites-link",href:"#"});T.__sert(b6.make("web","email_32",{"class":"link-img"}));ez=aR("%(total_count)d new shared folder invitation","%(total_count)d new shared folder invitations",ex);ez+=" \n";ez=ez.format({total_count:ex});T.__sert(ez);T.observe("click",(function(eC){return function(eD){Event.stop(eD);return eC.show_invites()}})(this));$("invites-box").show();$("invites-box").__date(T)}else{$("invites-box").hide()}if(ex>0&&c2.show_inbox){c2.set_show_inbox(false);return this.show_invites()}},register_accept:function(T){bf(T).closest(".sf-invite-action").addClass("loading");new a9(bf(T),T.action,{data:bs.collect_form_vars(T),complete:(function(ev){return function(ex,ew){bf(T).closest(".sf-invite-action").removeClass("loading");ev.refresh_inbox_counts();return ev._reload_folder_info()}})(this),success:(function(ev){return function(eA,ew,eC){var ex,ez,eB,ey;eA=(ey=JSON.parse(eC.responseText))!=null?ey.data:void 0;ex=bf(T).closest(".sf-invite-action");ex.addClass("sf-accepted");if(eA!=null?eA.redirect:void 0){ez=ex.find(".view-folder-button");return ez.click(function(){return window.location.href=eA!=null?eA.redirect:void 0})}else{eB=bf(T).closest(".invitation-row").attr("data-invite-id");return ev._remove_invite_row(eB)}}})(this)});return false},register_decline:function(ev,ex){var T,ew;T=bf(ev).closest("form");if((ew=T.closest(".sf-invite-action"))!=null){ew.addClass("loading")}if(T.length){new a9(T,T[0].action,{data:bs.collect_form_vars(T[0]),complete:(function(ey){return function(eB,eA){var ez;if((ez=T.closest(".sf-invite-action"))!=null){ez.removeClass("loading")}ey._remove_invite_row(ex);ey.refresh_inbox_counts();return ey._reload_folder_info()}})(this)})}return false},_remove_invite_row:function(ey){var T,ex,ew,ev;T=bf("#invites-container");ex=T.find('[data-invite-id="'+ey+'"]');if(ex){ev=ex.parent("tbody");ex.remove();if(ev.children().length===0){T.find(".invitation-table-container").hide();T.find(".message-bottom").removeClass("message-bottom");T.find(".message-top").removeClass("message-top");if(T.find(".invites-message").length===0){ew=du.get_containing_modal(T);return ew!=null?ew.hide():void 0}}}},_listen:function(){var ew,ev,T;this.listen_modals();ew=(function(ex){return function(ez,eH,eC){var eD,ey,eG,eF,eE,eJ,eA,eI,eB;eB=ex._get_current_sf_list_info(eC),eF=eB[0],eG=eB[1];ci(eH,"SF _transfer w/o target_ns_id");for(eD=eA=0,eI=eF.length;eA<eI;eD=++eA){ey=eF[eD];if(ey.target_ns_id===eH&&ey.user_id===ez){eE=ey;eJ=eD;break}}ci(eJ!=null,"SF _transfer w/o js obj");return[eE,eJ]}})(this);T=(function(ex){return function(eD,eI,eF){var eG,eE,eJ,eH,eC,ez,eB,eA,ey;eB=ex._get_current_sf_list_info(eI),eG=eB[0],ez=eB[1];eA=ex._get_current_sf_list_info(eF),eH=eA[0],eC=eA[1];ey=ew(eD.memo.user_id,eD.memo.target_ns_id,eI),eE=ey[0],eJ=ey[1];eG.splice(eJ,1);ex._empty_check(eI);if(eD.memo.filename!=null){eE.filename=eD.memo.filename}if(eD.memo.mount_point!=null){eE.mount_point=eD.memo.mount_point}eH.push(eE);return ex._render()}})(this);ev=(function(ex){return function(eD,eA){var eF,eC,eE,ez,eB,ey;eB=ex._get_current_sf_list_info(eA),eF=eB[0],ez=eB[1];ey=ew(eD.memo.user_id,eD.memo.target_ns_id,eA),eC=ey[0],eE=ey[1];eF.splice(eE,1);return ex._render()}})(this);document.observe(av.SF_UNSHARE,(function(ex){return function(ey){return ev(ey,"#sf-current")}})(this));document.observe(av.SF_LEAVE,(function(ex){return function(ey){return T(ey,"#sf-current","#sf-past")}})(this));document.observe(av.SF_REJOIN,(function(ex){return function(ey){return T(ey,"#sf-past","#sf-current")}})(this));document.observe(av.SF_IGNORE,(function(ex){return function(ey){return ev(ey,"#sf-past")}})(this));document.observe(av.SF_NEW,(function(ex){return function(ez){var ey;ey=ez.memo.sf_info;ci(ey,"SF_NEW without info");ex._state.sf_info.current.push(ey);return ex._render()}})(this));$("create-share").observe("click",(function(ex){return function(ey){aQ.SharedFolderActivityLogger.log("web","sharing_view_share_new",null,{},true);if(!$("create-share").hasClassName("disabled")){Event.stop(ey);return p.start_wizard_without_user()}}})(this));bf("#learn-more-link").click((function(ex){return function(ey){return aQ.SharedFolderActivityLogger.log("web","sharing_view_learn_more",null,{},true)}})(this));if($("new-invites-link")){$("new-invites-link").observe("click",(function(ex){return function(ey){Event.stop(ey);return ex.show_invites()}})(this))}return bf("#sf-current, #sf-past").each((function(ex){return function(ey,ez){var eA;eA=["#sf-current","#sf-past"][ey];bf(".sf-list",ez).on("click","a.options-link",function(eI){var eG,eE,eF,eB,eC,eH,eD;eI.preventDefault();eG=bf(eI.target).closest("a.options-link");eB=eG.attr("data-type");eF=eG.attr("data-mount");eH=parseInt(eG.attr("data-nsid"),10);eD=cj.get_viewer().get_user_by_id(eG.attr("data-user_id"));eC=bf(eI.target).closest("li.sf-folder").data("role");if(eC!=null){c2.set_role(eC)}if(eB==="normal"){p.show_shared_folder_options_modal(eF,eD)}else{if(eB==="remove"){p.show_ignore_modal(eD,eF,eH)}else{if(eB==="rejoin"){p.show_rejoin_modal(eD,eF,eH)}}}eE={option_type:eB};if(eH){eE.ns_id=eH}if(eF){eE.path=eF}return aQ.SharedFolderActivityLogger.log("web","sharing_view_share_existing",eD.id,eE,true)});bf(".sf-sort",ez).on("click","a.sort-option",function(eD){var eC,eB,eE;eD.preventDefault();eC=bf(eD.target).closest("a.sort-option");eE={SF_BY_NAME:ex._name_cmp,SF_BY_MODIFIED:ex._modified_cmp};eB=eE[eC.attr("data-sort")];if(ex._state.cmp[eA]===eB){ex._state.is_ascending[eA]=!ex._state.is_ascending[eA]}else{ex._state.cmp[eA]=eB;ex._state.is_ascending[eA]=true}ds.add_sort_arrow_mouseover_j(eC,ex._state.is_ascending[eA],eA+" .sf-sort a.sort-option",true);return ex._render_list_id(eA)});return ds.add_sort_arrow_mouseover_j(bf(".modified-sorter",ez),ex._state.is_ascending[eA],eA+" .sf-sort a.sort-option",false)}})(this))},listen_modals:function(){return bf("#new-or-existing-sf li").click((function(T){return function(ew){var ev;bf("#new-or-existing-sf li").removeClass("active");ev=bf(ew.target).closest("li");ev.find("input").prop("checked",true);return ev.addClass("active")}})(this))},_showing_two_accounts:function(){var T;return this.is_merged&&((T=this.role_picker)!=null?T.get_state():void 0)===dn.ALL},_render:function(){this._render_list_id("#sf-current");this._render_list_id("#sf-past");if(bf("#sf-current").hasClass("empty-list")&&bf("#sf-past").hasClass("empty-list")){bf("#page-content").addClass("no-shares");return bf("#empty-content").show()}else{bf("#page-content").removeClass("no-shares");return bf("#empty-content").hide()}},_render_list_id:function(ew){var eD,eA,eB,ey,ez,ex,eC,T,eE,ev;ev=this._get_current_sf_list_info(ew),ey=ev[0],eB=ev[1];eC=this._showing_two_accounts();eD=(function(eF){return function(eG,eI){var eH;eH=eF._state.is_ascending[ew]?1:-1;return eH*eF._state.cmp[ew](eG,eI,eC)}})(this);ey.sort(eD);ez=bf(".sf-list",ew);ez.empty();for(T=0,eE=ey.length;T<eE;T++){ex=ey[T];if(this._should_render(ex)){eA=this._tmpl({options_str:dU("Options"),remove_str:dU("Remove"),rejoin_str:dU("Rejoin"),is_past:eB,sf:ex,Sprite:b6,Emstring:bt,Util:ds,_:dU});ez.append(eA.toHTML())}}return this._empty_check(ew)},_should_render:function(T){if(this.role_picker!=null){return this.role_picker.is_role_visible(T.role)}else{return true}},_empty_check:function(ex){var ew,T,ev;ev=this._get_current_sf_list_info(ex),ew=ev[0],T=ev[1];if(bf(".sf-list",ex).children().length){return bf(ex).removeClass("empty-list")}else{return bf(ex).addClass("empty-list")}},_get_current_sf_list_info:function(T){switch(T){case"#sf-current":return[this._state.sf_info.current,false];case"#sf-past":return[this._state.sf_info.past,true];default:return ci(false,"invalid sf list id")}},_name_cmp:function(ev,ew,T){if(T){return ds.sort_by_key(ev,ew)}else{return ds.sort_by_rank_or_key(ev,ew)}},_modified_cmp:function(ev,ew,T){return ev.modified_ts-ew.modified_ts},include_fb:false,use_fb_profile_pics:true,show_invites:function(){return p.show_invites()}};var a5;Autocompleter.Contacts=Class.create(Autocompleter.Base,{initialize:function(ey,ez,ex,eE){var eD,ew,eB,eC,T,ev,eA;this.user=ey;this.baseInitialize(ez,ex,eE);this.options.array=false;this.options.larray=false;this.options.frequency=0.1;ew=this.options.include_fb===true;if(this.options.include_team==null){this.options.include_team=true}eA=this.options.include_team===true;eB=this.options.include_groups===true;T=this.options.include_new_style_groups===true;eC=this.options.include_me===true;ev=this.options.include_rooms===true;this.contacts_importer=U.get_contacts_importer({user:this.user,on_update_services:this.update_import_contacts_link.bind(this),hide_containing_modal:this.hide_containing_modal.bind(this),show_containing_modal:this.show_containing_modal.bind(this)});this.update_import_contacts_link();this.contacts_importer.on_open_auth_popup=this.contact_importer_unshow.bind(this);this._autocompleter_contact_import_item_tmpl=es.tmpl("autocompleter_item_tmpl");this.listen();this.possible_email_pattern=/[.@_-]/;eD=(function(eF){return function(eG){eG=eG.includeForUser(eF.user.id);if(eF.options.contact_filter){eG=eF.options.contact_filter(eG)}else{if(!ew){eG=eG.excludeFacebook()}if(!eB){eG=eG.excludeGroups()}if(!T){eG=eG.excludeNewStyleGroups()}if(!eA){eG=eG.excludeTeamMembers()}if(!eC){eG=eG.excludeMe()}if(!ev){eG=eG.excludeRooms()}}return eF.setContacts(eG)}})(this);((function(eF){return function(){var eG;return bA.load_contacts(eG=false,ev=ev,(function(eH){eD(eH);return bA.register_for_updates("autocompleter_contacts",eD)}))}})(this)).defer();return this.options.onShow=function(eF,eG){if(!eG.style.position||eG.style.position==="absolute"){eG.style.position="absolute";bf(eG).clonePosition(bf(eF),{setHeight:false,setTop:false,setLeft:false})}return bf(eG).fadeTo(150,1)}},getToken:function(){var T;T=this.getTokenBounds();return this.element.value.substring(T[0],T[1])},listen:function(){var ev,T,ex,ew;this.install_contact_importer_listener();ev=bf(this.element).closest(".tokenized_autocompleter_container");T=ev.data("exp-rule");ex=ev.data("exp-variant");if(T==="import-contacts-text-experiment"&&(ex==="SELECT_PROVIDER_POP"||ex==="SELECT_PROVIDER_POP_LONG")){ew=(function(ey){return function(ez){if(ey.contacts_importer.has_connected_services()){return}if(bf(ey.element).val()){return}ey.activate();setTimeout(function(){var eA;return(eA=ey.get_entry_container())!=null?eA.show():void 0},300);return true}})(this);return bf(this.element).click(ew)}},install_contact_importer_listener:function(){var T;Event.stopObserving(this.element,"blur");T=(function(ev){return function(ew){var ex;if(!bf(ew.target).closest("li").hasClass("contacts-importer")){if(ev.contact_importer_currently_showing()){ev.contact_importer_unshow()}return(ex=ev.get_entry_container())!=null?ex.hide():void 0}}})(this);bf(this.element).closest(".db-modal-box").click(T);return bf(this.element).closest("#modal-box").click(T)},get_entry_container:function(){var T;return(T=this.element.up(".tokenized_autocompleter_container"))!=null?T.down(".autocomplete"):void 0},contact_importer_currently_showing:function(){var ev,T;ev=this.get_entry_container();if((ev!=null)&&ev.style.display!=="none"){if(((T=ev.firstChild.firstChild)!=null?T.value:void 0)===0){if(ev.firstChild.children.length>1){return true}}}return false},contact_importer_show:function(){var ew,ev,T,ex;ew=this.get_entry_container();if(((ev=ew.firstChild)!=null?(T=ev.firstChild)!=null?T.value:void 0:void 0)>0){this.old_display=ew.style.display}else{this.old_contents="<ul></ul>";this.old_display="none"}this.contact_importer_render_buttons();if((ex=$("flash_copy_container"))!=null){ex.hide()}return this.element.focus()},contact_importer_unshow:function(){var T;this.hasFocus=true;this.changed=false;this.updateChoices(this.old_contents);this.get_entry_container().style.display=this.old_display;return(T=$("flash_copy_container"))!=null?T.show():void 0},contact_importer_render_buttons:function(){var T;T=this.get_contact_importer_button_list();this.hasFocus=true;return this.updateChoices("<ul>"+(T.join(""))+"</ul>")},get_contact_importer_button_list:function(){var ey,ev,ex,T,ew;ev=[];ew=aH.contact_services();for(ex=0,T=ew.length;ex<T;ex++){ey=ew[ex];ci(this.contacts_importer.connected_services!=null,"connected_services has not been set");ev.push(this._autocompleter_contact_import_item_tmpl({email_provider_num:ey,email_provider_img:aH.to_img(ey),email_provider_name:aH.to_name(ey),bottom_text:this.contacts_importer.connected_services[ey]?dU("Connected"):"",is_suggestion:0}).toHTML())}return ev},update_import_contacts_link:function(){if(this.contacts_importer.has_unconnected_services()){return bf(this.element).closest("form").find(".import-contacts-link").show()}else{return bf(this.element).closest("form").find(".import-contacts-link").hide()}},hide_containing_modal:function(){this.$hidden_modals=bf(".db-modal-wrapper:visible").first();if(this.$hidden_modals.length){return this.$hidden_modals.css("display","none")}else{this.$hidden_modals=bf("#modal:visible, #modal-overlay:visible");return this.$hidden_modals.hide()}},show_containing_modal:function(){this.$hidden_modals.show();return this.$hidden_modals=null},setContacts:function(T){this.options.array=T.contacts;this.options.larray=T.lcontacts;if(this.active||this.getToken()){return this.getUpdatedChoices()}},getUpdatedChoices:function(){this.updateChoices(this.options.selector());bf(".autocomplete-item-cancel-button").off();return bf(".autocomplete-item-cancel-button").on("click",((function(T){return function(ev){ev.stopPropagation();T.contacts_importer.suggestions_enabled=false;T.getUpdatedChoices();return new Ajax.DBRequest("/contacts/turn_off_importer_suggestions",{subject_user:T.user})}})(this)))},selectEntry:function(){var ew,ev,T;ev=this.getCurrentEntry();ew=this.options.array[ev.value];if(ew.type===P.FB||ew.type===P.NEW_STYLE_GROUP){ev.innerHTML=ew.name}else{ev.innerHTML=ew.email}if(this.options.tokens.length>1){T=this.options.tokens[0]+" "}else{T=""}ev.innerHTML+=T;this.active=false;this.updateElement(ev);return bf(this.element).trigger("db:autocompleted")}},a5=function(T,ev){var ew;ew=bf("<div>");ew.addClass(T);if(typeof ev==="string"||ev instanceof String){ew.text(ev)}else{ew.append(ev)}return ew},{setOptions:function(ev){var T;if(ev==null){ev={}}T={choices:5,selector:(function(ew){return function(){var eB,eX,eW,eR,fm,eN,eQ,e7,eE,eF,fp,eI,e5,fo,ey,fk,e0,eT,eP,e6,e4,eM,fg,eC,e3,fn,e1,e9,e2,e8,fe,ex,fd,fl,eL,eU,ez,fb,eZ,fc,eA,eV,eY,eK,eD,fj,fi,fh,ff,eS,eJ,eH,eG,fa,eO;eZ=bf("<ul>");e5=ew.getToken().toLowerCase();fg=ew.options.array.length;fm=ew.options.choices;eQ=ew.options.array;e9=ew.options.larray;fb=[];if(e5.indexOf(" ")===-1){fb.push("\\s+")}if(e5.indexOf("+")===-1){fb.push("\\+")}if(e5.indexOf("@")===-1){fb.push("@")}if(e5.indexOf(".")===-1){fb.push("\\.")}if(e5.indexOf("&lt;")===-1){fb.push("&lt;")}ez=RegExp("("+fb.join("|")+")");e6=0;while(e6<fg&&eZ.children().length<fm){eN=eQ[e6];e1=e9[e6];fk=-1;eI=[];e8=[];eP="";switch(eN.type){case P.EMAIL:eI.push(eN.name,eN.email_snippet);e8.push(e1.name,e1.email);eP="/static/images/icons/mail28.png";break;case P.FB:eI.push(eN.name);e8.push(e1.name);if(bz.use_fb_profile_pics){eP="https://graph.facebook.com/"+e1.fb_id+"/picture"}else{eP="/static/images/icons/fb24.png"}break;case P.USER_GROUP:eI.push(eN.name,eN.members);e8.push(e1.name,"");eP="";e0=eN.group_avatar;break;case P.NEW_STYLE_GROUP:eI.push(eN.name,eN.members);e8.push(e1.name,"");eP="";if(__CIRCULAR_DEPENDENCY__.GroupsListController!=null){eX=__CIRCULAR_DEPENDENCY__.GroupsListController.string_to_hsl(eN.name);eW=__CIRCULAR_DEPENDENCY__.GroupsListController.get_initials(eN.name);e0=bf("<span class='group-icon'>").css("border-color",eX).css("color",eX).text(eW)}break;case P.CAROUSEL_ROOM:eI.push("",eN.name);eV=e1.name;fa=eN.members;for(fj=0,eS=fa.length;fj<eS;fj++){fe=fa[fj];eV+="."+fe.contact_vector_data.toLowerCase();eV+="."+fe.display_name.toLowerCase()}e8.push("",eV);eP=eN.avatar_url||"/static/images/carousel/icon-57px.png";break;default:ci(false,"should never get here due to type: "+(""+eN.type+", "+eN.name+", "+eN.email+", "+eN))}for(eM=fi=0,eJ=e8.length;fi<eJ;eM=++fi){e2=e8[eM];fl=fb.length?e2.split(ez):[e2];eE=0;for(fh=0,eH=fl.length;fh<eH;fh++){fd=fl[fh];if(!fd){continue}if(fd.indexOf(e5)===0){fk=eE;break}eE+=fd.length}if(fk!==-1){eC=document.createTextNode(eI[eM].substr(0,fk));ex=bf("<strong>").text(eI[eM].substr(fk,e5.length));fc=document.createTextNode(eI[eM].substr(fk+e5.length));eI[eM]=[eC,ex,fc];break}}if(eN.type===P.FB){eI.push(dU("Facebook message"))}if(fk!==-1){if(eP){eT=bf('<img width="28px" height="28px">').attr("src",eP)}else{if(e0){eT=e0}}eL=a5("autocomplete-line",eI[0]);eY=a5("autocomplete-line autocomplete-secondary",eI[1]);e3=a5("autocomplete-left",eT);eA=a5(null,[eL,eY]);fn=bf("<li>").attr("value",e6).append(e3,eA);eZ.append(fn)}e6++}if(!bf(ew.element).hasClass("no-contacts-importer")){if(ew.contacts_importer.has_unconnected_services()){e4=dU("Import contacts");eF=null;eK=false;e7=bf(ew.element).closest(".tokenized_autocompleter_container");fo=e7.data("exp-rule");ey=e7.data("exp-variant");eU=e7.attr("data-exp-data");if(fo==="import-contacts-text-experiment"&&(ey==="SELECT_PROVIDER"||ey==="SELECT_PROVIDER_POP"||ey==="SELECT_PROVIDER_POP_LONG")){if(ey==="SELECT_PROVIDER_POP_LONG"){e4=eU===aH.GOOGLE?dU("Select from your Gmail contacts"):eU===aH.YAHOO?dU("Select from your Yahoo contacts"):dU("Select from your contacts")}else{e4=eU===aH.GOOGLE?dU("Select from Gmail"):eU===aH.YAHOO?dU("Select from Yahoo contacts"):dU("Select from contacts")}if(ey==="SELECT_PROVIDER_POP"||ey==="SELECT_PROVIDER_POP_LONG"){if((eU===aH.GOOGLE||eU===aH.YAHOO)&&!ew.contacts_importer.connected_services[eU]){eF=e4;e4=null}else{eD=true}if(eD){if(ew.contacts_importer.has_connected_services()){eF=null;e4=dU("Import Contacts")}else{e4=eF=null;eK=true}}}}if(eF){fp=ew._autocompleter_contact_import_item_tmpl({email_provider_num:eU,email_provider_img:aH.to_img(eU),email_provider_name:eF,bottom_text:"",is_suggestion:0}).toHTML();eZ.append(fp)}if(e4){eT=b6.make("web","user_add");eL=a5("autocomplete-line autocomplete-line-center",e4);e3=a5("autocomplete-left",eT);eA=a5(null,[eL]);fn=bf("<li>").addClass("contacts-importer").append(e3,eA);eZ.append(fn)}if(eK){eO=ew.get_contact_importer_button_list();for(ff=0,eG=eO.length;ff<eG;ff++){eR=eO[ff];eZ.append(eR)}}}}eB=eZ.wrap("<span>").parent().html();ew.old_contents=eB;return eB}})(this)};return this.options=Object.extend(T,ev)}});var ck;ck=A.Token=Class.create({initialize:function(ev,T,ew,ex){this.element=$(ev);this.token_manager=ew;this.hidden_input=T;this.element.token=this;this.selected=false;this.info=ex;return bf(this.element).closest(".tokenized_autocompleter_container").click(this.onclick.bindAsEventListener(this))},select:function(){var T;this.token_manager.token=this;if((T=this.hidden_input)!=null){T.element.activate()}this.selected=true;return this.element.addClassName("token_selected")},deselect:function(){if(this.token_manager.token===this){this.token_manager.token=null}this.selected=false;return this.element.removeClassName("token_selected")},onclick:function(T){if(T&&T.preventDefault){T.preventDefault()}if(this.detect(T)&&!this.selected){return this.select()}else{return this.deselect()}},remove:function(T){return this.token_manager.remove(this)},detect:function(ex){var ev,ew,T;ew=ex.target?ex.target:ex.srcElement;T=ew.token;ev=ew;while((T==null)&&ev.parentNode){ev=ev.parentNode;T=ev.token}return(T!=null)&&T.element===this.element}});var K;K=A.TokenManager=Class.create({initialize:function(ev,ew,T){this.shift_boundary_right_func=ew;this.shift_boundary_left_func=T;this.element=ev;this.tokens=[];return this.token=null},add:function(T){this.tokens.push(T);return this.element.fire("token:add",T.info)},populate:function(){var eA,ew,ey,ex,ez,ev,T;ex=this.element.select(".token");T=[];for(ez=0,ev=ex.length;ez<ev;ez++){ey=ex[ez];eA=ey.hasClassName("token-warn");ew=new ck(ey,null,this,{external:eA});T.push(this.add(ew))}return T},remove:function(ev){var T;if(ev==null){ev=this.token}if(ev!=null){T=this.tokens.indexOf(ev);this.tokens.splice(T,1);ev.element.remove();if(this.token===ev&&T<this.tokens.length){this.tokens[T].select()}else{this.token=null;if(this.shift_boundary_right_func!=null){this.shift_boundary_right_func()}}return this.element.fire("token:remove",ev.info)}},removeAll:function(){var ev,ex,T,ew;ew=this.tokens;for(ex=0,T=ew.length;ex<T;ex++){ev=ew[ex];ev.element.remove();this.element.fire("token:remove",ev.info)}return this.tokens.clear()},shift_left:function(){var T;T=this.token?this.tokens.indexOf(this.token):this.tokens.length;if(T>0){if(this.token){this.token.deselect()}return this.tokens[T-1].select()}else{if(this.shift_boundary_left_func!=null){return this.shift_boundary_left_func()}}},shift_right:function(){var T;T=this.tokens.indexOf(this.token);if(this.token){this.token.deselect()}if(T+1<this.tokens.length){return this.tokens[T+1].select()}else{if(this.shift_boundary_right_func!=null){return this.shift_boundary_right_func()}}}});var dw;dw=A.HiddenInput=Class.create({initialize:function(T,ew,ev){this.element=$(T);this.auto_complete_element=ew;this.token_manager=ev;return Event.observe(this.element,"keydown",this.onKeyPress.bindAsEventListener(this))},onKeyPress:function(T){switch(T.keyCode){case Event.KEY_LEFT:T.preventDefault();this.token_manager.shift_left();break;case Event.KEY_TAB:T.preventDefault();this.token_manager.shift_right();break;case Event.KEY_RIGHT:T.preventDefault();this.token_manager.shift_right();break;case Event.KEY_BACKSPACE:case Event.KEY_DELETE:this.token_manager.remove()}return false}});var bk=[].indexOf||function(ew){for(var ev=0,T=this.length;ev<T;ev++){if(ev in this&&this[ev]===ew){return ev}}return -1};Autocompleter.ContactsTokenizer=Class.create(Autocompleter.Contacts,{initialize:function($super,T,ex,ez,ew,ev){var ey;this.user=T;$super(T,ex,ez,ev);this.token_manager=new K(this.element,this.generate_shift_boundary_right_func());this.hidden_input=new dw(ew,this.element,this.token_manager);this.textbox_height=0;if(!this.element.hacks){this.element.should_use_borderless_hack=Prototype.Browser.WebKit;this.element.should_use_shadow_hack=Prototype.Browser.IE||Prototype.Browser.Opera;this.element.hacks=true}if(this.element.should_use_borderless_hack||this.element.should_use_shadow_hack){bf(this.element).parent().addClass("tokenizer_input_borderless")}this.options.onShow=function(eA,eB){bf(eB).clonePosition(bf(eA.parentNode.parentNode),{setHeight:false,setTop:false,setLeft:false});return eB.show()};this.options.onHide=function(eA,eB){return eB.hide()};this.max_textbox_height=270;if(ev.max_textbox_height!=null){this.max_textbox_height=ev.max_textbox_height}this.members=[];if(ev.members!=null){this.members=ev.members}this.invitees=[];if(ev.invitees!=null){this.invitees=ev.invitees}this.new_style_groups=[];if(ev.new_style_groups!=null){this.new_style_groups=ev.new_style_groups}this.contacts_only=false;if(ev.contacts_only!=null){this.contacts_only=ev.contacts_only}if(dX.get_url().indexOf("/referrals")!==-1){ey=bf("#retrieve-contacts-button")}else{ey=bf(this.element).closest("form").find(".tokenizer-submit-button")[0]}bf(ey).on("mousedown",this.beforeSubmit.bindAsEventListener(this));bf(this.element).on("focus",this.onFocus.bindAsEventListener(this));this.import_links=[];if(!ev.hide_import_contacts){this.import_links=bf(".import-contacts-link")}this.calculate_input_size();this.dynamically_resize_input();this.check_populated();return setInterval(this.check_populated.bind(this),100)},onClick:function(ev){var T,ew;T=ev.findElement("li");this.index=T.autocompleteIndex;ew=this.selectEntry();if(!ew){return this.hide()}},onBlur:function($super,T){$(this.element.parentNode).removeClassName("focused");this.element.up(".tokenizer").removeClassName("focused");return $super(T)},onFocus:function(T){$(this.element.parentNode).addClassName("focused");return this.element.up(".tokenizer").addClassName("focused")},beforeSubmit:function(T){return this.tokenize_emails_input(true)},clearTokens:function(T){this.token_manager.removeAll();this.calculate_input_size();return this.dynamically_resize_input()},getTokenCount:function(){return this.token_manager.tokens.length},getEmails:function(){var ev,T;ev=bf(this.element).closest(".tokenized_autocompleter_container").find(".token-valid").find('[name="emails"]');return((function(){var ey,ex,ew;ew=[];for(ey=0,ex=ev.length;ey<ex;ey++){T=ev[ey];ew.push(bf(T).val())}return ew})()).join(", ")},check_populated:function(){var ev,T;ev=$(this.element.parentNode);T=(this.element.value==="")&&(this.token_manager.tokens.length===0);if(ev.hasClassName("populated")&&T){return ev.removeClassName("populated")}else{if(!ev.hasClassName("populated")&&!T){return ev.addClassName("populated")}}},clean_email_addr:function(ey,ew){var ev,ex,T;for(ex=0,T=ey.length;ex<T;ex++){ev=ey[ex];ew=ew.sub(ev,"")}return ew.strip()},get_regexp_from_delimiters:function(ey){var ev,ex,ew,T;ex="";for(ew=0,T=ey.length;ew<T;ew++){ev=ey[ew];ex+=ev+"|"}return new RegExp("["+ex+"\\r\\n|\\r|\\n|\\t]+")},createTokenInfo:function(ex,ew,T){var ey,ev;ev=true;ey=ew;if(T===P.FB){ey=ex}if(T===P.EMAIL&&!ds.validate_email(ew)){ev=false}else{if(bk.call(this.members,ew)>=0){ev=false;ey="Already member"}else{if(bk.call(this.invitees,ew)>=0){ev=false;ey="Already invited"}else{if(T===P.NEW_STYLE_GROUP){if(bk.call(this.new_style_groups,ew)>=0){ev=false;ey="Already member group"}else{ev=true;ey="Group"}}}}}if(ew===this.user.email||ew===this.user.id){ey="You";ev=!this.contacts_only}if(!ex&&ew){ex=ew.toString()}return{display:ex,value:ew,type:T,valid:ev,bubble_title:ey}},COMPOUND_EMAIL_REGEX:/([^<>]+)<([^@>]+@[^@>]+)>/,parse_compound_email:function(ev){var T,ew;T=ev.match(this.COMPOUND_EMAIL_REGEX);if(T){ew=this.createTokenInfo(T[0],T[2],P.EMAIL);return ew}return null},tokenize_emails_input:function(eD,ey){var eI,eC,ez,eH,ew,eJ,eG,eF,eA,eN,eB,ex,ev,T,eK,eM,eL,eE;eC=this.options.tokens;eF=this.get_regexp_from_delimiters(eC);if(this.options.single_token){eH=[this.element.value]}else{eH=this.element.value.split(eF)}eN="";if(!eD){eN=eH[eH.length-1];eG=this.clean_email_addr(eC,eN);eH=eH.slice(0,eH.length-1);if((eE=eN[eN.length-1])===" "||eE===">"){if(eG.match(this.COMPOUND_EMAIL_REGEX)||ds.validate_email(eG)){eH.push(eG);eN=""}}}eI=false;eB=[];if(eH.length>0){for(ex=0,eK=eH.length;ex<eK;ex++){ez=eH[ex];eA=this.parse_compound_email(ez);if(eA!=null?eA.valid:void 0){eI=true;this.set_input_size(1);this.addContact(eA)}else{eB.push(ez)}}}eH=eB;if(!this.options.single_token){eJ=[];for(ev=0,eM=eH.length;ev<eM;ev++){ez=eH[ev];eJ.push.apply(eJ,ez.split(" "))}eH=eJ}if(eH.length>0){for(T=0,eL=eH.length;T<eL;T++){ez=eH[T];ez=this.clean_email_addr(eC,ez);if(ez){eA=this.createTokenInfo(ez,ez,P.EMAIL);if(eA.valid){eI=true}else{if(ey){continue}}this.set_input_size(1);this.addContact(eA)}}}if(this.element.value!==eN){this.element.value=eN}ew=this.element.up("form");if(eI){bs.clear_errors(ew)}return this.dynamically_resize_input()},generate_shift_boundary_right_func:function(){var ev,T;ev=this.element;T=function(){return ev.focus()};return T},set_input_size:function(T){if((T==null)||T<0){T=20}return this.element.setStyle({width:""+T+"px"})},calculate_input_size:function(){if(this.import_links.length){this.import_links_width=this.import_links.width();return this.import_links_visible=this.import_links.is(":visible")}},dynamically_resize_input:function(){var eG,eK,eA,ey,eN,eB,eH,eJ,eF,ex,eD,ez,eE,eI,ew,T,eL,eM,eC,ev;eF=$(this.element.parentNode.parentNode);eD=parseInt(eF.getStyle("width"),10)-15;ex=parseInt(eF.getStyle("height"),10);if(ex!==this.textbox_height){this.textbox_height=ex;if(ex>=this.max_textbox_height){eF.setStyle({"overflow-y":"auto"})}else{eF.setStyle({"overflow-y":"hidden"})}}eN=eD;eG=bf(".tokenizer-link",eF.parentNode);if(eG.length>0){eN-=eG.width()}eE=this.token_manager.tokens;eB=false;eI=0;for(ew=0,eL=eE.length;ew<eL;ew++){ez=eE[ew];ey=ez.element;eA=parseInt(ey.getStyle("width"),10)+parseInt(ey.getStyle("margin-right"),10);eJ=eI+eA;if(eJ>eD){eI=eA;eB=true}else{if(eA>eD){eI=0;eB=true}else{eI=eJ}}}eH=eN-eI;eK=this.element.value.length*7;if(eK>eH){eH=eD}this.set_input_size(eH);if(this.import_links.length&&this.import_links_visible){if(eB||eD-eI-eK<1.25*this.import_links_width){this.import_links_visible=false;eC=this.import_links;ev=[];for(T=0,eM=eC.length;T<eM;T++){ey=eC[T];ev.push(bf(ey).fadeOut(100))}return ev}}},onKeyPress:function(ev){var ew,T;this.dynamically_resize_input();if(this.active){switch(ev.keyCode){case 44:case 188:case 59:case 186:if(this.has_selected_contact_importer_entry()||this.has_selected_contact_importer()){this.tokenize_emails_input(true)}this.reset_observer();return;case Event.KEY_TAB:case Event.KEY_RETURN:if(this.has_selected_contact_importer_entry()||this.has_selected_contact_importer()){this.tokenize_emails_input(true);this.hide();Event.stop(ev);return}this.selectEntry();this.hide();this.active=false;Event.stop(ev);return;case Event.KEY_ESC:this.hide();this.active=false;Event.stop(ev);return;case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:this.markPrevious();this.render();Event.stop(ev);return;case Event.KEY_DOWN:this.markNext();this.render();Event.stop(ev);return}}else{this.tokenize_emails_input(false);if(ev.keyCode===Event.KEY_TAB||ev.keyCode===Event.KEY_RETURN){if(this.element.value&&ev.preventDefault){ev.preventDefault()}this.tokenize_emails_input(true);return}else{if(this.element.value===""){if((ew=ev.keyCode)===Event.KEY_LEFT||ew===Event.KEY_BACKSPACE){this.token_manager.shift_left()}}else{if((T=ev.keyCode)===Event.KEY_LEFT||T===Event.KEY_RIGHT||T===Event.KEY_UP||T===Event.KEY_DOWN){return}}}}this.update_typeahead();return this.reset_observer()},update_typeahead:function(){this.changed=true;return this.hasFocus=true},reset_observer:function(){if(this.observer){clearTimeout(this.observer)}return this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1000)},onObserverEvent:function($super){var ev,ew,ez,ey,T,ex;if(this.active){ez=this.element.value;ex=this.options.tokens;for(ey=0,T=ex.length;ey<T;ey++){ev=ex[ey];ew=ez.indexOf(ev);if(ew!==-1){if(this.has_selected_contact_importer_entry()){this.tokenize_emails_input(true);this.hide();return}this.element.value=ez.substr(0,ew);this.selectEntry();this.hide();this.active=false;this.element.value=ez.substr(ew+1);break}}this.update_typeahead()}this.tokenize_emails_input(false);return $super()},has_selected_contact_importer:function(T){if(T==null){T=this.getCurrentEntry()}return bf(T).hasClass("contacts-importer")},has_selected_contact_importer_entry:function(T){var ev;if(T==null){T=this.getCurrentEntry()}return T.value===0&&((ev=T.id)!=null?ev.length:void 0)!==0},selectEntry:function(){var ew,ev,ez,T,ex,ey;ev=this.getCurrentEntry();if(this.has_selected_contact_importer(ev)){aQ.SharedFolderActivityLogger.log("web","import_contacts_button_clicked",this.user);this.contact_importer_show();return true}else{if(this.has_selected_contact_importer_entry(ev)){ez=ev.id.split("_")[0];ci((bk.call(aH.contact_services(),ez)>=0),"The 'id-value' of an autocompleter-entry is not a valid Third Party contact import service");ex=aH.to_name(ez);if(this.contacts_importer.connected_services[ez]){Y.success(dU("You're already connected to %(service_name)s").format({service_name:ex}));return}if(bk.call(aH.contact_services(),ez)>=0){if(bf(ev).attr("suggestion")==="1"){return this.contacts_importer.auth_import(ez,"suggestion")}else{return this.contacts_importer.auth_import(ez)}}else{return ci(false,"Should never get here. entry_value: "+ez)}}else{ew=this.options.array[ev.value];T=ew.type===P.FB?ew.fb_id:ew.type===P.USER_GROUP?ew.group_id:ew.type===P.NEW_STYLE_GROUP?ew.group_id:ew.type===P.CAROUSEL_ROOM?ew.members:ew.email;this.set_input_size(1);ey=this.createTokenInfo(ew.name.strip(),T,ew.type);this.addContact(ey);bs.clear_errors(this.element.up("form"));this.dynamically_resize_input();this.index=0;return this.element.focus()}}},addContact:function(eE){var eO,eJ,eP,eF,eR,eB,eM,ev,eG,eK,eQ,eU,ew,eC,eI,eL,eD,eN,ey,ex,T,eS,eV,eT,eH,eA,ez;if(eE.type===P.CAROUSEL_ROOM&&!eE.processed){eH=eE.value;for(ey=0,eS=eH.length;ey<eS;ey++){eO=eH[ey];ev=this.createTokenInfo(eP=eO.display_name,eN=JSON.stringify([eO.contact_vector_type,eO.contact_vector_data]),eD=P.CAROUSEL_ROOM);ev.processed=true;ev.bubble_title=eO.contact_vector_data;this.addContact(ev)}return}eL=this.token_manager.tokens;for(ex=0,eV=eL.length;ex<eV;ex++){eG=eL[ex];if(eE.value===eG.info.value){return}}this.element.value="";switch(eE.type){case P.FB:eM="fb_ids";eR=new Element("img",{src:"/static/images/icons/fb_16.png"});break;case P.EMAIL:eM="emails";eR=new Element("img",{src:"/static/images/icons/email_16.png"});break;case P.USER_GROUP:eM="group_ids";eR=new Element("img",{src:"/static/images/icons/icon_spacer.gif","class":"sprite sprite_groups s_groups_group"});break;case P.NEW_STYLE_GROUP:eM="new_style_group_ids";eR=new Element("img",{src:"/static/images/icons/icon_spacer.gif","class":"sprite sprite_groups s_groups_group"});break;case P.CAROUSEL_ROOM:eM="carousel_rooms";eR=new Element("img",{src:"/static/images/carousel/icon-57px.png"});break;case P.INVALID:eM="invalids";eR=new Element("span",{"class":"hidden"});break;default:ci(false,"should never get here due to type: "+eE.type)}eK=this.getTokenClass(eE);eI=bf("<span class='x'>").addClass(eK);eI.on("click",function(eW){this.parentNode.parentNode.parentNode.parentNode.parentNode.token.remove(eW);return false});eU=new Element("input",{type:"hidden",name:eM,value:eE.value.toString()});eG=new Element("a",{"class":"title_bubble token "+eK,href:"#",tabindex:"-1",title:eE.bubble_title});eB=new Element("span");if(this.options.wrap_name){ew=new Element("div",{"class":"token-display-text"});ew.__sert(eE.display);eQ=ew;eJ=1}else{eQ=eE.display;eJ=0}eA=[eU,eR,eQ];for(T=0,eT=eA.length;T<eT;T++){eF=eA[T];eB.__sert(eF)}bf(eB).append(eI);eG.__date(new Element("span").__date(new Element("span").__date(new Element("span").__date(eB))));if((ez=$(eG).down(5).next(eJ))!=null){ez.innerHTML="&nbsp;"}eC=new ck(eG,this.hidden_input,this.token_manager,eE);this.token_manager.add(eC);return this.element.up().__sert({before:eG})},getTokenClass:function(T){if(!T.valid){return"token-error"}return"token-valid"},isTeamOnly:function(){return false}});var bk=[].indexOf||function(ew){for(var ev=0,T=this.length;ev<T;ev++){if(ev in this&&this[ev]===ew){return ev}}return -1};Autocompleter.TeamTokenizer=Class.create(Autocompleter.ContactsTokenizer,{initialize:function($super,T,ex,ey,ew,ev){$super(T,ex,ey,ew,ev);this.warn_only=!ev.team_only;this.element.observe("token:remove",this.notifyExternal.bind(this));this.element.observe("token:add",this.notifyExternal.bind(this));return this.team_contacts={}},isTeamOnly:function(){return !this.warn_only},setTeamOnly:function(T){this.warn_only=!T;return this.reloadContacts()},reloadContacts:function(){var ev,T;return bA.load_contacts(ev=false,T=false,(function(ew){return function(ex){return ew.setContacts(ex)}})(this))},setContacts:function($super,ey){var T,ex,ev,ew;this.team_contacts={};this.team_contacts[cj.get_viewer().work_email]=1;ey=ey.sortByTeamFirst();ew=ey.contacts;for(ex=0,ev=ew.length;ex<ev;ex++){T=ew[ex];if(T.team){this.team_contacts[T.email]=1}}return $super(ey)},createTokenInfo:function(ey,ew,T){var eA,ez,ex,ev;ev=true;ez=false;eA=ew;if(T===P.FB){eA=ey}if(T===P.EMAIL&&!ds.validate_email(ew)){ev=false}else{if(bk.call(this.members,ew)>=0){ev=false;eA="Already member"}else{if(bk.call(this.invitees,ew)>=0){ev=false;eA="Already invited"}else{if(T===P.EMAIL&&!this.team_contacts[ew]){ev=this.warn_only;ez=true}else{if(T===P.FB){ev=this.warn_only;ez=true}else{if(T===P.NEW_STYLE_GROUP){if(bk.call(this.new_style_groups,ew)>=0){ev=false;eA="Already member group"}else{ev=true;eA="Group"}}}}}}}if(ew===this.user.email||ew===this.user.id){eA="You";ev=!this.contacts_only}if(!ey&&ew){ey=ew.toString()}return ex={display:ey,value:ew,type:T,valid:ev,external:ez,bubble_title:eA}},getTokenClass:function(T){if(!T.valid){return"token-error"}if(T.external){return"token-warn"}return"token-valid"},notifyExternal:function(ev){var T,ew,ex;ex=ev.memo;if(ex.external){ew=this.token_manager.tokens.filter(function(ey){return ey.info.external});T=ew?ew.length:0;return this.element.fire("sf:token:external",{count:T})}}});var i;i=A.TeamSharedFolderInviteController=(function(){function T(ev){var ew;this.element=$(ev[0]);ew=this.element.down(".new-collab-input");ew.observe("sf:token:external",this.handle_external.bind(this))}T.prototype.handle_external=function(ew){var ev,ex;ev=ew.memo.count;ex=this.element.down(".external-invite-message");if(ev>1){cS.fillVal(ev,"external-invite-num");if(ex!=null){ex.removeClassName("single")}return ex!=null?ex.show():void 0}else{if(ev===1){if(ex!=null){ex.addClassName("single")}return ex!=null?ex.show():void 0}else{return ex!=null?ex.hide():void 0}}};return T})();var ad;ad=INLINE_JS.SharingModel=A.SharingModel={ALBUM_THUMB_SIZE:260,ALBUM_PADDING:40,THUMBS_BATCH_SIZE:12,filename:null,c2d_vars:{},is_folder:false,is_album:false,gallery_enabled:false,gallery_showing:false,send_link_autocompleter:null,team_only_shmodel:false,owner_name:null,init:function(ev,T,ew){this.filename=ev;this.c2d_vars=T;this.c2d_url=ew!=null?ew:"/sm/c2d";this.init_logger();return on_script_loaded((function(ex){return function(){var ez,eF,eG,eE,eD,eC,eB,eA,ey;eF=$("login-create-an-account");if(eF){eF.writeAttribute("href","/register?signup_tag=shmodel")}scrollTo(1,0);scrollTo(0,0);if((eE=bf("#c2d-register-form"))!=null){eE.on("submit",ex.c2d_register.bind(ex))}if((eD=bf("#c2d-login-form"))!=null){eD.on("submit",ex.c2d_login.bind(ex))}if((eC=bf("#c2d-twofactor-login-form"))!=null){eC.on("submit",ex.c2d_twofactor_login.bind(ex))}if((eB=bf("#download_button_link[data-dl-link]"))!=null){eB.on("click",ex.download_zip)}ex.set_viewport_size();ez=function(eI,eH){return ex.do_c2d(eH.id)};bf("#c2d-modal .login-form").on((eA=__CONDITIONAL_JS__.LoginForm)!=null?eA.LOGIN_SUCCESS:void 0,ez);bf("#c2d-modal .register-form").on((ey=__CIRCULAR_DEPENDENCY__.RegisterForm)!=null?ey.REGISTER_SUCCESS:void 0,ez);eG=C.parse(window.location.href);if(eG.getQuery()["force_dl"]){eG.updateQuery({force_dl:0,dl:1});return window.location=eG.toString()}}})(this))},init_folder:function(T,ew,ev){this.gallery_enabled=T;this.gallery_showing=ew;this.is_folder=true;this.init_lightbox(ev);return on_script_loaded((function(ex){return function(){return ex.load_thumbs()}})(this))},init_album:function(){this.is_album=true;this._resize_album_view();return Event.observe(window,"resize",this._resize_album_view.bind(this))},init_file:function(){this.is_folder=false;if(!this.c2d_vars.subpath&&(this.c2d_vars.item_id==null)&&!this.c2d_vars.is_package){return this.c2d_vars.subpath="/"+this.filename}},get_thumbnail_for_file:function(ev){var ew,T;T=ev.icon.split("_");T.pop();ew=T.join("_");return"/static/images/icons128/"+ew+".png"},init_logger:function(){on_script_loaded((function(T){return function(){var ew,ev;ew=$("login-hover-link");if(ew){ew.observe("click",function(){return aA.log(aA.CLICK_SIGN_IN)});ew.observe("click",function(){return c7.log("click_sign_in")})}if($("download_button_link")){aA.attachLogListener(aA.CLICK_DOWNLOAD,$("download_button_link"))}ew=$("add_to_my_dropbox_link");if(ew){aA.attachLogListener(aA.CLICK_ADD_TO_MY_DROPBOX,ew);c7.attachLogListener("click_add_to_my_dropbox",ew)}if($$(".remove-link").length){aA.attachLogListener(aA.REMOVE_LINK,$$(".remove-link")[0])}if($$(".shmodel-filename").length){aA.attachLogListener(aA.CLICK_FILENAME,$$(".shmodel-filename")[0])}ew=$("default_content_download_button");if(ew){aA.attachLogListener(aA.CLICK_DOWNLOAD,ew)}ew=$("default_content_a2md");if(ew){aA.attachLogListener(aA.CLICK_ADD_TO_MY_DROPBOX,ew)}ew=bf("#login-create-an-account")[0];aA.attachLogListener(aA.CLICK_SIGNUP_THRU_DEFAULT_DROPDOWN,ew);ew=bf("#login-hover-cont .login-form")[0];aA.attachLogListener(aA.LOGIN_THRU_DEFAULT_DROPDOWN,ew);return(ev=bf("#share-button"))!=null?ev.click(function(ex){return aA.log(aA.CLICK_SHARE)}):void 0}})(this));return document.observe(ax.ACTIONS_ADDED,(function(T){return function(){var ey,ex,ev,ew;ew=$("view_original");if(ew){aA.attachLogListener("shmodel_lightbox_click_vieworiginal",ew)}ex=$("lightbox_share_link");if(ex){aA.attachLogListener("shmodel_lightbox_click_getlink",ex)}ev=bf("lightbox-share-link");if(ev[0]){aA.attachLogListener("shmodel_lightbox_click_getlink",ev[0])}ey=$("lightbox_download_link");if(ey){return aA.attachLogListener("shmodel_lightbox_click_download",ey)}}})(this))},set_team_only_shmodel:function(ev,T){this.team_only_shmodel=ev;return this.owner_name=T},_resize_album_view:function(){var T;T=Math.floor((y.viewport_dimensions().width-2*this.ALBUM_PADDING)/this.ALBUM_THUMB_SIZE)*this.ALBUM_THUMB_SIZE;return $("content-wrapper").setStyle({display:"block",width:""+T+"px"})},init_lightbox:function(T){return ax.init_from_preview_objs(T,"#gallery-view-media li")},load_thumbs:function(){var ev,T;T=this.gallery_showing?$$(".gallery-icon-view img"):$$(".browse-files .icon");ev=function(ew){if(!ew.src.endsWith(b6.SPACER)){return ew.addClassName("thumbnail")}};return a6.batch_load_thumbs(T,this.THUMBS_BATCH_SIZE,ev)},switch_mode:function(eA){var ew,eB,ez,T,ey,ev,ex;ex=$A(["gallery","list"]);for(ey=0,ev=ex.length;ey<ev;ey++){T=ex[ey];eB=$(T+"-view-container");ew=$(T+"-toggle");if(eA===T){eB.show();ew.addClassName("selected")}else{eB.hide();ew.removeClassName("selected")}}if(history.replaceState){ez=window.location.pathname;if(eA==="list"){ez+="?lst"}history.replaceState({},"",ez)}this.gallery_showing=!this.gallery_showing;return this.load_thumbs()},set_viewport_size:function(){var T;if($(document.body).hasClassName("mobile")){T=new Element("meta",{name:"viewport",content:"width = 480"});return document.head.appendChild(T)}},toggle_dropdown:function(ex,ey,ew){var T,ev;if(ex){Event.extend(ex).preventDefault()}if(!ey.visible()){if(this.is_album){return eb.show(ey,ew,null,true)}else{ev=$$(".nav-header").first().getHeight();T=$$(".nav-header .buttons").first().cumulativeOffset().top-4;if(T<0&&ds.ie8){T=4}return eb.show(ey,ew,ev-T,true)}}},prepare_confirm_remove_modal:function(ev,ex,T,ez,eE,eA,eD,eB){var ew,ey,eC;if(T){eC=ez?dU("Unshare?"):dU("Unshare album?");ew=bf("#album-disable-token-modal")[0];cS.fillVal(ev.escapeHTML(),"album_unshare_name")}else{if(eA){eC=dU("Remove link created by %(name)s").format({name:eD});if(ex){ey=dU('You are removing the link to "%(fname)s" created by <b>%(owner)s</b>.  Once the link is removed, no one else will be able to view this folder.<br/><br/>We\'ll notify <b>%(owner_email)s</b>.  Do you want to continue?')}else{ey=dU('You are removing the link to "%(fname)s" created by <b>%(owner)s</b>.  Once the link is removed, no one else will be able to view this file.<br/><br/>We\'ll notify <b>%(owner_email)s</b>.  Do you want to continue?')}ey=ey.format({fname:bt.em_snippet(ev,17),owner:eD,owner_email:eB})}else{eC=dU("Remove link to '%(name)s'").format({name:bt.em_snippet(ev,17)});if(ex){ey=dU("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this folder.")}else{ey=dU("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this file.")}}ew=bf("#disable-token-modal")[0];cS.fillVal(ey,"disable-token-desc")}return{title:eC,contents:ew}},confirm_remove:function(ev,ez,ew,T,ex,eD,eA,eC,eB){var ey;if(ew==null){ew=false}if(T==null){T=false}if(ex==null){ex=false}if(eD==null){eD=null}if(eA==null){eA=false}if(eC==null){eC=null}if(eB==null){eB=null}ci(ez,"confirm_remove missing tkey");ci(ev,"confirm_remove missing name");ci(eD,"confirm_remove missing user_id");ci(!eA||!T,"admin removal of collections not supported");ci(!eA||eC,"missing link owner name for admin removal");ci(!eA||eB,"missing link owner email for admin removal");if(!cj.get_viewer().is_uid_signed_in(eD)){bo.show_modal({user_id:eD,on_success:(function(eE){return function(){return eE.confirm_remove(ev,ez,ew,T,ex,eD,eA,eC,eB)}})(this)});return}ey=ad.prepare_confirm_remove_modal(ev,ew,T,ex,eD,eA,eC,eB);return ep.show(ey.title,ey.contents,{token:ez,name:ev,is_album:T,user_id:eD})},confirm_remove_from_event_gid:function(T,eC,ew,eB,ey,eA,ez,ev){var ex;if(ey==null){ey=false}if(eA==null){eA=null}if(ez==null){ez=null}if(ev==null){ev=null}ci(eC,"confirm_remove missing event gid");ci(T,"confirm_remove missing name");ci(eB,"confirm_remove missing user_id");ci(cj.get_viewer().is_uid_signed_in(eB),"user not logged in");ci(!ey||eA,"missing link owner name for admin removal");ci(!ey||ez,"missing link owner email for admin removal");ex=ad.prepare_confirm_remove_modal(T,ew,false,false,eB,ey,eA,ez);return ep.show(ex.title,ex.contents,{name:T,user_id:eB,activity_log_event_gid_dbase64:eC,redirect_to_member_id:ev})},do_remove:function(ex){var T,ew,ev;ci(ex.token||ex.activity_log_event_gid_dbase64,"missing token or event gid_dbase64");T=bf("#modal-content input").first();T.attr("disabled",true);bf("#modal-content").addClass("ajax-loading");ev=window.location.pathname;if((ev==="/links"||ev==="/links/your_links")||ev.match("^/home|^/work|^/personal")){return new Ajax.DBRequest("/sm/disable/"+ex.token,{subject_user:ex.user_id,onSuccess:(function(ey){return function(){var ez;ep.hide();if(ex.is_album){ez=dU("Unshared '%(name)s'")}else{ez=dU("Removed link for '%(name)s'")}ez=ez.format({name:ex.name});Y.success(ez);return document.fire(av.LINKS_REMOVE,{token:ex.token})}})(this),onComplete:(function(ey){return function(){T.attr("disabled",false);return bf("#modal-content").removeClass("ajax-loading")}})(this)})}else{if(ex.token){ew=C({path:"/sm/disable/"+ex.token})}else{ew=C({path:"/sm/disable_by_event_gid/"+ex.activity_log_event_gid_dbase64});ew.updateQuery("redirect_to_member_id",ex.redirect_to_member_id).toString()}return bs.postRequest(ew.updateQuery(Constants.UID_PARAM_NAME,ex.user_id).toString())}},show_shmodal_onload:function(ew,ex,ev,T){if(T==null){T=null}return bf((function(ey){return function(){dX.remove_query_param("m");if(!cj.get_viewer().is_uid_signed_in(T)){bo.show_modal({user_id:T,on_success:function(){return ey.show_shmodal_onload(ew,ex,ev,T)}});return}if((T!=null)&&dq.get_for_user(cj.get_viewer().get_user_by_id(T)).verified_or_show()){return ey.show_shmodal(ew,ex,ev,T)}else{if(T==null){ci(cj.get_viewer().is_paired,"Expected viewer to be paired.");return ey.show_share_shmodel_role_chooser(ew,ex,ev)}}}})(this))},show_shmodal:function(ev,eB,T,eH){var eG,eD,eF,eC,ez,eA,ex,ew,eE,ey;this.url=ev;this.short_url=eB;if(!cj.get_viewer().is_uid_signed_in(eH)){bo.show_modal({user_id:eH,on_success:(function(eI){return function(){return eI.show_shmodal(ev,eB,T,eH)}})(this)});return}ex=cj.get_viewer().get_user_by_id(eH);if(dq.get_for_user(ex).verified_or_show()){eA="shmodal-user-"+eH;ep.show(this._get_shmodal_title(ex.is_team),cS.fromElm($(eA)));ez={};ez[Constants.UID_PARAM_NAME]=eH;bs.add_vars("shmodal-send-form",ez);if(this._get_thumbnail_type()){ey=$$(".shmodal-image");for(ew=0,eE=ey.length;ew<eE;ew++){eC=ey[ew];eC.addClassName("thumbnail")}}if(T==="contacts"){eF=Autocompleter.ContactsTokenizer}else{eF=Autocompleter.TeamTokenizer}this.send_link_autocompleter=new eF(ex,eA+"-new-collab-input",eA+"-new-whobulk",eA+"-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true,team_only:T==="team_only",user_id:eH});this.configure_dropdown();if(!this.disabled){if(FlashDetect.installed){eG=q.clipboard_overlay(ev,bf("#"+eA+"-copy-link"),ad.copied_to_clipboard);eG.css({position:"fixed",zIndex:1001});eG.children().height(eG.height());clearInterval(this.follow_freshbutton);eD=(function(eI){return function(){return eG.clonePosition(bf("#"+eA+"-copy-link"),{offsetHeight:6,offsetWidth:6})}})(this);this.follow_freshbutton=setInterval(eD,500)}else{$(eA+"-copy-link").hide()}}bS._create($("modal").down(".custom-message-container"));bS._create($("modal").down(".fb-post-sickinput"));bS._create($("modal").down(".twitter-post-sickinput"));this._populate_twitter_info(eB,eH);$(eA+"-new-collab-input").focus();return aA.log("shmodal_show")}},configure_dropdown:function(){var ey,ev,ex,T,ew;ew=$$(".dropdown-menu-container");for(ex=0,T=ew.length;ex<T;ex++){ey=ew[ex];ev=ey.down(".dropdown-menu-trigger");if(ev!=null){ev.observe("click",(function(ez){return function(eB){var eA;eA=eB.target.up(".dropdown-menu-container");return eA.toggleClassName("dropdown-shown")}})(this))}}return document.on("click",(function(ez){return function(eF){var eD,eE,eC,eA,eB;if(eF.target.hasClassName("dropdown-menu-trigger")||eF.target.up(".dropdown-menu-trigger")){return}eA=$$(".dropdown-shown");eB=[];for(eE=0,eC=eA.length;eE<eC;eE++){eD=eA[eE];eB.push(eD.removeClassName("dropdown-shown"))}return eB}})(this))},copied_to_clipboard:function(){Y.success(dU("Link copied to clipboard"));ep.hide();aA.log("shmodal_copy_link");return aQ.ViralLogger.log(cj.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_copy_link",file_type:ad.is_album?"collection":ad.is_folder?"folder":ad.filename.indexOf(".")===-1?"file":co.EXTENSION_TO_CATEGORY[an.file_extension(ad.filename).toLowerCase()]||"file"})},get_shmodel_send_recipients:function(ew){var ex,eF,eC,eG,eH,eA,eD,T,ez,ey,eE,ev,eB;ci(ew,"Must pass the shmodal send form into get_shmodel_send_recipients");ex=ew.select('input[name="emails"]');eF=ew.select('input[name="fb_ids"]');eC=ew.select('input[name="group_ids"]');eA=ew.select('input[name="new_style_group_ids"]');T=[];eB=[ex,eF,eC,eA];for(ez=0,eE=eB.length;ez<eE;ez++){eH=eB[ez];for(ey=0,ev=eH.length;ey<ev;ey++){eG=eH[ey];eD=eG.up().innerHTML.stripTags().escapeHTML();T.push(eD.substring(0,eD.indexOf("&")))}}return T},send_shmodel_link:function(ex){var ew,ev,ey,T;ew=$("shmodal-send-form");ci(ew,"Couldn't find the shmodal send form.");T=this.get_shmodel_send_recipients(ew);ey=(function(ez){return function(eA){var eB;eB=aI.success_string_for_recipients(T);Y.success(eB);ep.hide();return aA.log("shmodal_send")}})(this);ev=(function(ez){return function(eA){return bs.remove_loading()}})(this);return bs.ajax_submit(ew,"/sm/share",ey,ev,ew.down(".tokenizer-submit-button"))},show_content:function(ev){var ey,ex,T,ew;$("shmodal-title-text").__date(cO.to_title_str(ev));ew=cO.list;for(ex=0,T=ew.length;ex<T;ex++){ey=ew[ex];if(ey!==ev){$(cO.to_toggle_str(ey)).removeClassName("toggled");$(cO.to_content_str(ey)).hide()}}$(cO.to_content_str(ev)).show();$(cO.to_toggle_str(ev)).addClassName("toggled");return bf("#modal .focusarea").focus()},show_send_content:function(){return this.show_content(cO.SEND)},show_fb_content:function(){return this.show_content(cO.FB)},show_twitter_content:function(){return this.show_content(cO.TWITTER)},start_fb_post:function(ey,ev){var ez,ew,T,ex;ew=(function(eA){return function(){return dN.do_auth(eA.do_fb_post.curry(ey,ev),ev)}})(this);ez=bf("#modal:visible, #modal-overlay:visible");T=function(){return ez.show()};if(dN.authed_user_id===ev){return this.do_fb_post(ey,ev)}else{if(cj.get_viewer().is_uid_associated(dN.authed_user_id)){ez.hide();ex=new dz(cj.get_viewer().get_user_by_id(ev),T,ew.bind(this));return ex.show()}else{return ew()}}},start_twitter_post:function(T){if(cc.is_authed(T)){return this.do_twitter_post(T)}else{return cc.do_auth(this.do_twitter_post,T)}},do_fb_post:function(ev,T){dN.custom_show_posting=function(){return bs.add_loading($("shmodal-fb-post-submit"))};dN.custom_show_complete=function(){ep.hide();Y.success(dU("Successfully posted to Facebook"));aA.log("shmodal_fb_post");return aQ.ViralLogger.log(cj.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_fb_post",file_type:ad.is_album?"collection":ad.is_folder?"folder":ad.filename.indexOf(".")===-1?"file":co.EXTENSION_TO_CATEGORY[an.file_extension(ad.filename).toLowerCase()]||"file"})};return dN.post($F("shmodal-fb-post-input"),ev,null,null,null,function(){return ep.hide()},T)},do_twitter_post:function(T){var ev;ev=$F("shmodal-twitter-post-input");if(!ev){Y.error(dU("Please enter a Twitter post"));return}else{if(ev.length>140){Y.error(dU("Your post must be 140 characters or less"));return}}cc.custom_show_posting=function(){$("twitter-chars").hide();return bs.add_loading($("shmodal-twitter-post-submit"))};return cc.custom_post(ev,(function(ew){return function(){ep.hide();Y.success(dU("Successfully posted to Twitter"));aA.log("shmodal_tweet");return aQ.ViralLogger.log(cj.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_twitter",file_type:ad.is_album?"collection":ad.is_folder?"folder":ad.filename.indexOf(".")===-1?"file":co.EXTENSION_TO_CATEGORY[an.file_extension(ad.filename).toLowerCase()]||"file"})}})(this),T)},_get_shmodal_title:function(T){if(T==null){T=false}return this.generate_title_content(this._get_shmodal_title_text(),((function(ev){return function(){return ev.show_send_content()}})(this)),((function(ev){return function(){return ev.show_fb_content()}})(this)),((function(ev){return function(){return ev.show_twitter_content()}})(this)),T)},generate_title_content:function(ev,eC,ez,eE,ex){var ey,eA,T,eD,ew,eB;if(ex==null){ex=false}eD=bf("<div/>",{id:"shmodal-title"});ew=bf("<div/>",{id:"shmodal-title-text",text:ev});eD.append(ew);if(!ex){T=bf("<a/>",{id:"shmodal-send-toggle","class":"freshtoggle ft-left toggled"});T.html(b6.make("web","email_20"));T.on("click",eC);eA=bf("<a/>",{id:"shmodal-fb-toggle","class":"freshtoggle ft-middle"});eA.html(b6.make("web","fb_20"));eA.on("click",ez);eB=bf("<a/>",{id:"shmodal-twitter-toggle","class":"freshtoggle ft-right"});eB.html(b6.make("web","twitter_20"));eB.on("click",eE);eD.append([T,eA,eB])}ey=bf("<div/>",{"class":"clear"});eD.append(ey);return eD[0]},_get_shmodal_title_text:function(){var ev,T;if(this.is_folder){ev=dU("Share link to \u2018%(folder_name)s\u2019");return ev=ev.format({folder_name:bt.em_snippet(this.filename,15)})}else{T=this._get_thumbnail_type();if(T===co.CATEGORY_TO_TRANSLATION.IMAGE){return dU("Share this image")}else{if(T===co.CATEGORY_TO_TRANSLATION.VIDEO){return dU("Share this video")}else{return dU("Share '%(filename)s'").format({filename:bt.em_snippet(this.filename,18)})}}}},_get_thumbnail_type:function(){var ev,T;if(this.filename.indexOf(".")===-1){return false}T=an.file_extension(this.filename).toLowerCase();ev=co.EXTENSION_TO_CATEGORY[T];if(ev&&(ev==="IMAGE"||ev==="VIDEO")){return co.CATEGORY_TO_TRANSLATION[ev]}return false},_populate_twitter_info:function(ew,T){var ex,ev;ex=this.is_folder?dU("Just shared some files using @Dropbox"):(ev=this._get_thumbnail_type(),ev&&ev===co.CATEGORY_TO_TRANSLATION.IMAGE?dU("Just shared an image using @Dropbox"):dU("Just shared a file using @Dropbox"));$("shmodal-twitter-post-input").setValue(ex+" "+ew);ds._track_twitter_chars_left("shmodal-twitter-post-input",140);if(cc.is_authed(T)){return cc.get_user_info(function(ey){$("shmodal-twitter-profile").down(".profile-pic").__date(new Element("img",{src:ey.profile_image_url_https}));$("shmodal-twitter-profile").down(".name").__date(ey.name);$("shmodal-twitter-profile").down(".username").__date("@"+ey.screen_name);$("modal").down(".twitter-post-sickinput").addClassName("shrank");return $("shmodal-twitter-profile").show()},T)}},download_zip:function(ex){var ev,ew,ey,T,ez;ev=bf("#download_button_link").attr("data-dl-link");ez=bf("#download_button_link").attr("data-test-link");T=bf("#download_button_link").attr("data-owner")==="true";ey=(function(eA){return function(eB){var eC;if(eB==="OK"){window.location=ev}else{if(eB.indexOf("err:")===0){if(T){eC=dU("The zip file is too large.")}else{eC=dU("The zip file is too large. Please add it to your Dropbox.")}Y.error(eC)}else{Y.error(dU("Failed to download zip file."))}}return false}})(this);ew=(function(eA){return function(eB){Y.error(dU("Failed to download zip file."));return false}})(this);if(ez&&bf.support.cors===true){bf.ajax({url:ez,type:"POST",success:ey,error:ew})}else{window.location=ev}return false},show_share_shmodel_role_chooser:function(ev,ew,T){if(this.shmodel_select_role_modal==null){this.shmodel_select_role_modal=new cX({element_id:"share-shmodel-select-role-modal",link_url:ev,short_url:ew,tokenizer_type:T})}return this.shmodel_select_role_modal.show().set_title(this._get_shmodal_title_text())},prompt_login_then_share:function(ev,ew,T,ey){var ex;ex=(function(ez){return function(){var eA;ep.hide();bf("#role-selector option").removeClass("disabled");eA=cj.get_viewer().get_uid_by_role(ey);cj.get_viewer().sign_in_user_by_id(eA);aQ.ShmodelUILogger.log("via-shmodel-viewer");return ad.show_shmodal(ev,ew,T,eA)}})(this);if(!cj.get_viewer().is_role_signed_in(ey)){c2.not_logged_in_role=ey;return bo.show_modal({role:ey,on_success:ex})}else{return ex()}},show_c2d_modal:function(eB,ev){var eA,T,ez,ex,ey,ew;if(eB==null){eB=""}if(ev==null){ev=false}if(eB){if(eB===Constants.ROLE_PERSONAL){ci(this.team_only_shmodel!=="forbid","Can't copy to personal Dropbox if restricted")}if(!cj.get_viewer().is_role_signed_in(eB)){bo.show_modal({role:eB,on_success:(function(eC){return function(){return eC.show_c2d_modal(eB)}})(this)});return}}else{if(cj.get_viewer().is_paired){new aD({element_id:"select-role-modal"}).show();return}}if(eB){ex="#c2d-modal-"+eB}else{ex="#c2d-modal"}ey=this._c2d_modal_msg(eB,cj.get_viewer().team_name);eA=this._c2d_modal_button_msg(eB,cj.get_viewer().team_name);T=this._c2d_modal_desc(eB,cj.get_viewer().team_name);if(ev){T=this._c2d_modal_team_only_desc(cj.get_viewer().team_name)+"<br/><br/>"+T}ez=this._c2d_modal_login_desc(eB,cj.get_viewer().team_name);cS.fillVal(T,"c2d-desc");cS.fillVal(ez,"c2d-login-desc");if((ew=bf(".c2d-submit-button"))!=null){ew.val(eA)}bf(".c2d-login-register-desc").hide();if(this.is_album){bf(".c2d-login-register-album-desc").show()}else{if(this.is_folder){bf(".c2d-login-register-folder-desc").show()}else{bf(".c2d-login-register-file-desc").show()}}return ep.show(ey,bf(ex)[0],false,false,false,false)},_c2d_modal_msg:function(ex,ev){var T,ew;if(ex==null){ex=""}if(ev==null){ev=""}if(this.c2d_vars.title){return ew=this.c2d_vars.title}else{if(ex===Constants.ROLE_PERSONAL){ew=dU("Save '%(filename)s' to my personal Dropbox");return ew.format({filename:bt.em_snippet(this.filename,10)})}else{if(ex===Constants.ROLE_WORK){ew=dU("Save '%(filename)s' to my %(team_name)s Dropbox");T=Math.max(10,15-new bt(ev).length);return ew.format({filename:bt.em_snippet(this.filename,T),team_name:ev})}else{ew=dU("Save '%(filename)s' to my Dropbox");return ew.format({filename:bt.em_snippet(this.filename,15)})}}}},_c2d_modal_button_msg:function(ew,T){var ev;if(ew==null){ew=""}if(T==null){T=""}if(ew===Constants.ROLE_PERSONAL){return ev=dU("Save to my personal Dropbox")}else{if(ew===Constants.ROLE_WORK){ev=dU("Save to my %(team_name)s Dropbox");return ev.format({team_name:T})}else{return dU("Save to my Dropbox")}}},_c2d_modal_team_only_desc:function(T){var ev;if(this.is_album){ev=dU("You can only add this album to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the album to members of <b>%(team_name)s</b>.")}else{if(this.is_folder){ev=dU("You can only add this folder to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the folder to members of <b>%(team_name)s</b>.")}else{ev=dU("You can only add this file to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the file to members of <b>%(team_name)s</b>.")}}return ev.format({owner_name:this.owner_name,team_name:T})},_c2d_modal_desc:function(ew,T){var ev;if(ew==null){ew=""}if(T==null){T=""}if(ew===Constants.ROLE_PERSONAL){if(this.is_album){if(this.team_only_shmodel==="warn"){ev=dU("The photos and videos in this album were sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy them to your personal Dropbox?");return ev.format({owner_name:this.owner_name,team_name:T})}else{return ev=dU("The photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.is_folder){if(this.team_only_shmodel==="warn"){ev=dU("This folder was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return ev.format({owner_name:this.owner_name,team_name:T})}else{return ev=dU("This folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.team_only_shmodel==="warn"){ev=dU("This file was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return ev.format({owner_name:this.owner_name,team_name:T})}else{return ev=dU("This file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}}else{if(ew===Constants.ROLE_WORK){if(this.is_album){ev=dU("The photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){ev=dU("This folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{ev=dU("This file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return ev.format({team_name:T})}else{if(this.is_album){return dU("The photos and videos in this album will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{if(this.is_folder){return dU("This folder will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{return dU("This file will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}}}}},_c2d_modal_login_desc:function(ew,T){var ev;if(ew==null){ew=""}if(T==null){T=""}if(ew===Constants.ROLE_PERSONAL){if(this.is_album){return ev=dU("Once you sign in to your personal Dropbox, the photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{if(this.is_folder){return ev=dU("Once you sign in to your personal Dropbox, this folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{return ev=dU("Once you sign in to your personal Dropbox, this file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}else{if(ew===Constants.ROLE_WORK){if(this.is_album){ev=dU("Once you sign in to your %(team_name)s Dropbox, the photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){ev=dU("Once you sign in to your %(team_name)s Dropbox, this folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{ev=dU("Once you sign in to your %(team_name)s Dropbox, this file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return ev.format({team_name:T})}}},c2d_register:function(ev){var T,ew;ev.preventDefault();T=$("c2d-register-form");ew=(function(ex){return function(ez){var ey;ey=JSON.parse(ez.responseText);return ex.do_c2d(ey.id)}})(this);return bs.ajax_submit(T,"/ajax_register",ew,false,$(T).down("input[type=submit]"))},c2d_login:function(ex,T){var ew,ev,ey;if(T==null){T="c2d-login-form"}ex.preventDefault();ew=$(T);ey=(function(ez){return function(eB){var eA;eA=JSON.parse(eB.responseText);switch(eA.status){case"OK":return ez.do_c2d(eA.id);case"TWOFACTOR":return ez.show_c2d_twofactor(eA.last_four_digits);case"SSO":return window.location=eA.sso_url}}})(this);ev=this.c2d_show_twofactor_error500.bind(this);return bs.ajax_submit(ew,"/ajax_login",ey,ev,$(ew).down("input[type=submit]"))},show_c2d_twofactor:function(T){$("c2d-login").hide();if(T){$("c2d-twofactor-login").addClassName("sms");cS.fillVal(T,"last-four-digits")}else{$("c2d-twofactor-login").removeClassName("sms")}$("c2d-resend-link").observe("click",this.c2d_resend_phone_code.bind(this));return $("c2d-twofactor-login").show()},hide_c2d_twofactor:function(){$("c2d-twofactor-login").hide();return $("c2d-login").show()},c2d_resend_phone_code:function(){if(this.c2d_is_resending()){return}this.c2d_show_resending();return new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(T){return function(ev){switch(ev.responseText.strip()){case"OK":return Y.success(dU("We sent you another code. It may take a few minutes to arrive."));case"UNREACHABLE":return T.c2d_show_twofactor_error_unreachable();case"BADCARRIER":return T.c2d_show_twofactor_error_bad_carrier();case"INVALIDNUMBER":return T.c2d_show_twofactor_error_invalid_number();case"NOTAMOBILE":return T.c2d_show_twofactor_error_not_a_mobile();case"EXPIRED":T.hide_c2d_twofactor();return Y.error(dU("Sorry, your phone code has expired. Please log in again."))}}})(this),onFailure:this.c2d_show_twofactor_error500.bind(this),cleanUp:this.c2d_hide_resending_with_delay.bind(this)})},c2d_twofactor_login:function(ew){var ev,T,ex;ew.preventDefault();if(!$("c2d-twofactor-code").getValue()){this.c2d_show_twofactor_error_invalid();return}ev=$("c2d-twofactor-login-form");ex=(function(ey){return function(eA){var ez;ez=JSON.parse(eA.responseText);switch(ez.status){case"OK":return ey.do_c2d(ez.id);case"INVALID":return ey.c2d_show_twofactor_error_invalid();case"EXPIRED":ey.hide_c2d_twofactor();return Y.error(dU("Sorry, your phone code has expired. Please log in again."))}}})(this);T=this.c2d_show_twofactor_error500.bind(this);return bs.ajax_submit(ev,"/ajax_verify_code",ex,T)},do_c2d:function(T){var ev;ci(T,"Must specify a user_id for saving to Dropbox.");ev=dU("Saving to your Dropbox...");if(cj.get_viewer().is_paired){if(cj.get_viewer().get_user_by_id(T).is_team){ev=dU("Saving to your %(team_name)s Dropbox...");ev=ev.format({team_name:cj.get_viewer().team_name})}else{ev=dU("Saving to your personal Dropbox...")}}Y.success(ev);ep.hide();return new Ajax.DBRequest(this.c2d_url,{parameters:this.c2d_vars,job:this.is_folder,progress_text:ev,subject_user:T,onSuccess:(function(ew){return function(ex){if(ex.responseText&&ex.responseText[0]==="/"){return window.location.href=ex.responseText}else{if(ex.responseText==="snapshot_ok"){return Y.success(dU("Successfully saved to your Dropbox."))}}}})(this)})},c2d_show_twofactor_error:function(ev){var T;T=$("c2d-twofactor-error");T.__date(ev);return T.show()},c2d_hide_twofactor_error:function(T){return $("c2d-twofactor-error").__date()},c2d_show_twofactor_error500:function(){return this.c2d_show_twofactor_error(dU("Sorry, an error occured. Please try again later."))},c2d_show_twofactor_error_bad_carrier:function(){return this.c2d_show_twofactor_error(dU("Unfortunately, your carrier is not supported at this time."))},c2d_show_twofactor_error_invalid_number:function(){return this.c2d_show_twofactor_error(dU("That is not a valid phone number."))},c2d_show_twofactor_error_not_a_mobile:function(){return this.c2d_show_twofactor_error(dU("That phone number does not appear to be a valid mobile number."))},c2d_show_twofactor_error_unreachable:function(){return this.c2d_show_twofactor_error(dU("We couldn't reach your phone number. Are you sure it's correct?"))},c2d_show_twofactor_error_invalid:function(){return this.c2d_show_twofactor_error(dU("Invalid code."))},c2d_is_resending:function(){return $("c2d-resend-link").hasClassName("resending")},c2d_show_resending:function(){return $("c2d-resend-link").addClassName("resending")},c2d_hide_resending:function(){return $("c2d-resend-link").removeClassName("resending")},c2d_hide_resending_with_delay:function(){return setTimeout(this.c2d_hide_resending.bind(this),3000)}};var cO;cO=A.ShmodalPanes={SEND:0,FB:1,TWITTER:2,list:[0,1,2],_content_str:["shmodal-send-content","shmodal-fb-content","shmodal-twitter-content"],_toggle_str:["shmodal-send-toggle","shmodal-fb-toggle","shmodal-twitter-toggle"],_title_str:["Share by Email",dU("Share on Facebook"),dU("Share on Twitter")],to_content_str:function(T){return this._content_str[T]},to_toggle_str:function(T){return this._toggle_str[T]},to_title_str:function(T){if(T===0){return ad._get_shmodal_title_text()}return this._title_str[T]},to_focus_str:function(T){return this._focus_str[T]}};var R,bx,cI,bl,cU=function(T,ev){return function(){return T.apply(ev,arguments)}},am={}.hasOwnProperty,cl=function(ex,ev){for(var T in ev){if(am.call(ev,T)){ex[T]=ev[T]}}function ew(){this.constructor=ex}ew.prototype=ev.prototype;ex.prototype=new ew();ex.__super__=ev.prototype;return ex};cI=INLINE_JS.ShareLinkModal=A.ShareLinkModal=(function(T){cl(ev,T);function ev(ew,ey,ex,ez){var eA;this.user_id=ew;if(ez==null){ez=false}this.before_show=cU(this.before_show,this);this.show=cU(this.show,this);this.prompt_login_then_show=cU(this.prompt_login_then_show,this);eA={origin:ex};eA[Constants.UID_PARAM_NAME]=this.user_id;ev.__super__.constructor.call(this,{element_id:"share-link-modal",endpoint_url:C({path:"/sm/share_link"+ey}).toString(),parameters:eA})}ev.prototype.prompt_login_then_show=function(){var ew;ew=(function(ex){return function(){ep.hide();bf("#role-selector option").removeClass("disabled");cj.get_viewer().sign_in_user_by_id(ex.user_id);aQ.ShmodelUILogger.log("via-shmodel-viewer");return ex.show()}})(this);if(!cj.get_viewer().is_uid_signed_in(this.user_id)){return bo.show_modal({user_id:this.user_id,on_success:ew})}else{return ew()}};ev.prototype.show=function(){var ew;ew=cj.get_viewer().get_user_by_id(this.user_id);if(dq.get_for_user(ew).verified_or_show(dO.SHMODAL)){return ev.__super__.show.call(this)}};ev.prototype.before_show=function(){var ez,ey,ew,ex;ex=this.$modal_window.find(".share-link-modal-content").length;if(ex){ez={"class":"ajax-loading-indicator",src:"/static/images/icons/ajax-loading-small.gif"};ew=bf("<img />",ez);ey=bf("<div />",{"class":"loading-spinner"}).append(ew);return this.$modal_window.find(".dynamic-content").html(ey)}};return ev})(ca);bl=A.ShareLinkModalContent=(function(){function T(ez,eA,eB,eC,ev,ew,eF,ey,eD,eG){var eE,ex;this.owner_id=ez;this.tkey=eA;this.fq_path=eB;this.link=eC;this.filename=ev;this.tokenizer_type=ew;this.tokenizer_ctx_str=eF;this.fq_path_of_restricting_sf=eD;this.read_receipts_variant=eG;this._send_link=cU(this._send_link,this);this._show_shared_link_settings_modal=cU(this._show_shared_link_settings_modal,this);this._show_shared_folder_settings_modal=cU(this._show_shared_folder_settings_modal,this);this._select_all_text=cU(this._select_all_text,this);this._toggle_send_link_button=cU(this._toggle_send_link_button,this);this._toggle_recipients_outside_team_warning=cU(this._toggle_recipients_outside_team_warning,this);this._toggle_close_button_text=cU(this._toggle_close_button_text,this);this._listen=cU(this._listen,this);this._init_autocompleter=cU(this._init_autocompleter,this);this.$content=bf(".share-link-modal-content");this.modal=du.get_containing_modal(this.$content);if(!this.modal){return}if(this.tokenizer_type==="shared_folder"){this.shared_folder_members=m.create_contacts_list(ey)}eE={filename:this.filename,fq_path:this.fq_path,tkey:this.tkey,user_id:this.owner_id};document.fire(av.LINKS_ADD,eE);this.modal.set_title(dU("Share link to \u2018%(filename)s\u2019").format({filename:bt.em_snippet(this.filename,15)}));this.collab_input_id=this.tokenizer_ctx_str+"-new-collab-input";this.$collab_input=this.$content.find("#"+this.collab_input_id);this.$send_link_button=this.$content.find(".confirm-button");this.$share_link_url_input=this.$content.find(".copy-link-input-container input[type='text']");this.$cancel_button=this.$content.find(".cancel-button");this._init_autocompleter();this._listen();if((ex=this.$share_link_url_input[0])!=null){ex.select()}}T.prototype._init_autocompleter=function(){var ev;ev={tokens:[",",";"],include_fb:true,include_team:true,team_only:this.tokenizer_type==="team_only",user_id:this.owner_id};if(this.tokenizer_type==="shared_folder"){this.autocompleter=new Autocompleter.SharedFolderTokenizer(cj.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",ev,this.shared_folder_members)}else{if(this.tokenizer_type==="contacts"){this.autocompleter=new Autocompleter.ContactsTokenizer(cj.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",ev)}else{this.autocompleter=new Autocompleter.TeamTokenizer(cj.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",ev)}}bS.init();return this.$collab_input.focus()};T.prototype._listen=function(){var ew,ev,ez,ey,ex;this.$send_link_button.on("click",this._send_link);this.$share_link_url_input.on("click",this._select_all_text);this.$cancel_button.on("click",(function(eA){return function(eB){return dm.pop()}})(this));this.$content.find("#shared-link-permissions-link").on("click",this._show_shared_link_settings_modal);this.$content.find("#shared-folder-options-link").on("click",this._show_shared_folder_settings_modal);if((ew=this.$collab_input)!=null){ew.keyup(this._toggle_send_link_button)}if((ev=this.$collab_input[0])!=null){ev.observe("token:remove",this._toggle_send_link_button)}if((ez=this.$collab_input[0])!=null){ez.observe("token:add",this._toggle_close_button_text)}if((ey=this.$collab_input[0])!=null){ey.observe("token:remove",this._toggle_close_button_text)}return(ex=this.$collab_input[0])!=null?ex.observe("sf:token:external",this._toggle_recipients_outside_team_warning):void 0};T.prototype._toggle_close_button_text=function(ex){var ev,ew;ev=((ew=this.autocompleter)!=null?ew.token_manager.tokens.length:void 0)===0;if(ev){return this.$cancel_button.text(dU("Close"))}else{return this.$cancel_button.text(dU("Cancel"))}};T.prototype._toggle_recipients_outside_team_warning=function(ex){var ev,ew;ev=bf(".external-recipient-warning-message");if(ev.length){ew=ex.memo.count;if(ex.memo.shared_folder_warning){if(ew>0){return ev.show()}else{return ev.hide()}}else{if(ew>1){ev.find(".external-recpient-num").text(ew);return ev.removeClass("single").show()}else{if(ew===1){return ev.addClass("single").show()}else{return ev.hide()}}}}};T.prototype._toggle_send_link_button=function(ex){var ev,ew;ev=((ew=this.autocompleter)!=null?ew.token_manager.tokens.length:void 0)===0;ev=ev&&bf.trim(this.$collab_input.val())==="";return this.$send_link_button.prop("disabled",ev)};T.prototype._select_all_text=function(ev){return bf(ev.currentTarget)[0].select()};T.prototype._show_shared_folder_settings_modal=function(ew){var ev;ew.preventDefault();ev=cj.get_viewer().get_user_by_id(this.owner_id);return p.show_shared_folder_options_modal(this.fq_path_of_restricting_sf,ev)};T.prototype._show_shared_link_settings_modal=function(ew){var ev;ew.preventDefault();ev=new dj(this.owner_id,this.tkey);return dm.push(ev)};T.prototype._send_link=function(ez){var ex,ew,ey,ev,eA;ey=this.$content.find(".share-link-modal-send-form")[0];ev=this.get_shmodel_send_recipients(ey);eA=(function(eB){return function(eC){var eD;eD=aI.success_string_for_recipients(ev);Y.success(eD);dm.pop();aA.log("shmodal_send");if(eB.read_receipts_variant==="READ_RECEIPTS_SHOW_INTERESTS"){eB.read_receipts_modal=new bx({element_id:"read_receipts_show_interests_modal",recipients:ev});return eB.read_receipts_modal.show()}}})(this);ew=(function(eB){return function(eC){return bs.remove_loading()}})(this);ex=this.$content.find(".tokenizer-submit-button")[0];return bs.ajax_submit(ey,"/sm/share",eA,ew,ex)};T.prototype.get_shmodel_send_recipients=function(ex){var ey,eG,eD,eH,eI,eB,eE,ev,eA,ez,eF,ew,eC;ci(ex,"Must pass the shmodal send form into get_shmodel_send_recipients");ey=ex.select('input[name="emails"]');eG=ex.select('input[name="fb_ids"]');eD=ex.select('input[name="group_ids"]');eB=ex.select('input[name="new_style_group_ids"]');ev=[];eC=[ey,eG,eD,eB];for(eA=0,eF=eC.length;eA<eF;eA++){eI=eC[eA];for(ez=0,ew=eI.length;ez<ew;ez++){eH=eI[ez];eE=eH.up().innerHTML.stripTags().escapeHTML();ev.push(eE.substring(0,eE.indexOf("&")))}}return ev};return T})();bx=A.ReadReceiptsShowInterestsModal=(function(ev){cl(T,ev);function T(){return T.__super__.constructor.apply(this,arguments)}T.prototype.before_show=function(){var ew;ew=this._show_interests_title_for_recipients(this.options.recipients);this.format({".db-modal-title-text":ew});this.$modal_window.find(".read-receipts-confirm-interests-button").click((function(ex){return function(){return ex._confirm_interests()}})(this));this.$modal_window.find(".read-receipts-skip").click((function(ex){return function(){return ex._skip_interests()}})(this));return aQ.ShmodelUILogger.log("read_receipts_view_interests")};T.prototype.on_hide=function(){return aQ.ShmodelUILogger.log("read_receipts_dismiss_interests")};T.prototype._confirm_interests=function(){aQ.ShmodelUILogger.log("read_receipts_confirm_interests");dm.pop();this.thanks_modal=new du({element_id:"read_receipts_thank_you_modal"});this.thanks_modal.before_show=(function(ew){return function(ex){return ex.find(".read-receipts-thank-you-done-button").on("click",function(ey){return dm.pop()})}})(this);return this.thanks_modal.show()};T.prototype._skip_interests=function(){aQ.ShmodelUILogger.log("read_receipts_skip_interests");return dm.pop()};T.prototype._show_interests_title_for_recipients=function(ew){var ez,eA,ey,eB,ex;for(eB=0,ex=ew.length;eB<ex;eB++){eA=ew[eB];if(eA.indexOf("@")===-1){ey=eA;break}}if(!ey){return dU("Want to know when others view the file you shared?")}ez=ey.split(" ")[0];if(ew.length===1){return dU("Want to know when %(name)s views the file you shared?").format({name:ez})}return dU("Want to know when %(name)s and others view the file you shared?").format({name:ez})};return T})(du);R=INLINE_JS.QuickSend=A.QuickSend={_files:{},_uploading_fileids:{},init:function(T,ev,ex){var ew;this.owner_id=T;this.tokenizer_ctx_str=ev;R.DEST_FOLDER=ex;this.$content=bf("#browse-root-quick-send");this.$content[0].writeAttribute("dropzone","copy move");this.$content[0].writeAttribute("quicksend","true");this.collab_input_id=this.tokenizer_ctx_str+"-new-collab-input";this.$collab_input=this.$content.find("#"+this.collab_input_id);if((ew=this.$collab_input)!=null){ew.keyup(this._toggle_send_button_state)}if(this.$collab_input[0]){this.$collab_input[0].on("token:remove",this._toggle_send_button_state);this.$collab_input[0].on("token:add",this._toggle_send_button_state)}this.$send_button=this.$content.find("#quick-send-submit");this.$send_button.on("click",this._send_link);this.$cancel_button=this.$content.find("#quick-send-cancel");this.$cancel_button.on("click",this._cancel_button_clicked);this.$import_services=this.$content.find(".autocomplete");bf("#browse-files").addClass("quicksend-collapsed");this.$content.show();this.has_autocompleter_inited=false;aQ.SharedFolderActivityLogger.log("web","quick_send_displayed",b2.active_user,{});this.$collab_input.on("blur",function(){return setTimeout(function(){var ey;return(ey=R.$import_services)!=null?ey.hide():void 0},100)});bf("#quick-send-top-choose-button-send").click(function(){return bf("#quick-send-file-box").click()});bf("#quick-send-choose-button").click(function(){return bf("#quick-send-file-box").click()});bf(".quick-send-choose-file-link").click(function(){return bf("#quick-send-file-box").click()});bf("#quick-send-file-box").on("change",function(){var ey;ey=bf("#quick-send-file-box")[0].files;return a3.upload(R.DEST_FOLDER+"/",ey)});document.on(b9.COMPLETE_EVT,R._file_upload_completed);return document.on(b9.ERROR_EVT,R._file_upload_errored)},_cancel_button_clicked:function(T){aQ.SharedFolderActivityLogger.log("web","quick_send_cancel_button_clicked",b2.active_user,{});return R._reset()},_init_autocompleter:function(){var T;if(R.has_autocompleter_inited){return}R.has_autocompleter_inited=true;T={tokens:[",",";"],include_fb:true,include_team:true,team_only:false,user_id:R.owner_id,max_textbox_height:30};return R.autocompleter=new Autocompleter.ContactsTokenizer(cj.get_viewer().get_user_by_id(R.owner_id),R.collab_input_id,R.tokenizer_ctx_str+"-new-whobulk",R.tokenizer_ctx_str+"-hidden-input",T)},_send_link:function(eB){var ey,ex,ez,ew,ev,eC,eD,T,eA;aQ.SharedFolderActivityLogger.log("web","quick_send_send_button_clicked",b2.active_user,{});R.autocompleter.tokenize_emails_input(true);T=R.autocompleter.getTokenCount();ew=bf(".quick-send-left-form")[0];ev=[];eD=0;for(ez in R._files){eD+=1;ex=R._files[ez];ev.push(ex.fq_path)}eC={num_recipients:T,num_files:eD};aQ.SharedFolderActivityLogger.log("web","quick_send_send_attempted",b2.active_user,eC);eA=(function(eE){return function(eF){R._reset();R._toggle_top_area_view();return aQ.SharedFolderActivityLogger.log("web","quick_send_send_succeeded",b2.active_user,{})}})(this);ey=(function(eE){return function(eF){return aQ.SharedFolderActivityLogger.log("web","quick_send_send_failed",b2.active_user,{})}})(this);return bs.ajax_submit(ew,"/sm/quick_send",eA,ey,null,{fq_paths:ev.join(",")})},_update_file_area_view:function(){if(Object.keys(R._files).length){bf("#quick-send-drop-area").hide();bf("#quick-send-files-area").show()}else{bf("#quick-send-drop-area").show();bf("#quick-send-files-area").hide()}return R._toggle_send_button_state()},_toggle_top_area_view:function(){bf("#quick-send-top-part-send").hide();bf("#quick-send-top-part-confirm").show();return setTimeout(function(){bf("#quick-send-top-part-send").show();return bf("#quick-send-top-part-confirm").hide()},3000)},_update_collapsed_view:function(ey){var ev,ex,T,ew;ex=R.$content;ew=ey?"collapsed":"expanded";if(ex.hasClass(ew)){return}T=ey?"expanded":"collapsed";ex.removeClass(T);ex.addClass(ew);ev=bf("#browse-files");ew=ey?"quicksend-collapsed":"quicksend-expanded";T=ey?"quicksend-expanded":"quicksend-collpased";ev.removeClass(T);ev.addClass(ew);if(!ey){return R._init_autocompleter()}},_update_collapsed_state:function(){var T;T=Object.keys(R._files).length;return R._update_collapsed_view(T===0)},_remove_file:function(ev,T){var ew;ew=false;if(ev in R._uploading_fileids){ew=true;document.fire(b9.CANCEL_EVT,{file:T});bf(document).trigger(b9.CANCEL_EVT,{file:T});delete R._uploading_fileids[ev]}if(ev in R._files){$(ev).remove();delete R._files[ev];R._update_upload_list_scroll();R._update_file_area_view();return R._update_collapsed_state()}},_reset:function(){var ev,ex,ew,T;R.autocompleter.clearTokens();ew=bf(".quick-send-left-form")[0];ew.reset();T=[];for(ex in R._files){ev=R._files[ex];T.push(R._remove_file(ex,ev.file_obj))}return T},_has_added_fq_path:function(ew){var T,ev;for(ev in R._files){T=R._files[ev];if(T.fq_path===ew){return true}}return false},_update_upload_list_scroll:function(){var ev,T;ev=Object.keys(R._files).length;T=bf("#quick-send-upload-files-list");if(ev<3){return T.removeClass("scroll")}else{T.addClass("scroll");return T.scrollTop=T.scrollHeight}},_add_file:function(ex,T){var eE,ew,eD,eB,eC,ey,ev,eF,eA,ez;eC={size:ex.bytes,source:T};aQ.SharedFolderActivityLogger.log("web","quick_send_file_added",b2.active_user,eC);eE=ex.dest||R.DEST_FOLDER;eF=at.format_bytes(ex.bytes||0);ez=es.tmpl("upload_list_item_tmpl");ew=ez({file:ex,icon:an.file_icon(ex.name),filename_snippet:bt.em_snippet(ex.name,dp.FILENAME_SNIPPET_LENGTH),size:eF,dest:eE,dest_snippet:bt.em_snippet(dU("Dropbox")+eE,dp.DEST_SNIPPET_LENGTH,0),Sprite:b6});ev=cv.sanitize(ew.toHTML());bf("#quick-send-upload-files-list").append(ev);eD=bf("#"+ex.id);R._update_upload_list_scroll();eD.find(".dest-col").hide();eD.find(".time-col").hide();eA=eD.find(".status-col").find("a.small-x-button");eB=ex.id;eA.on("click",function(eG){return R._remove_file(eB,ex)});ey=eD.find(".remove-link");ey.on("click",function(eG){return R._remove_file(eB,ex)});eD.on("mouseenter",(function(eG){return function(eH){eD.find(".status-col").hide();return ey.show()}})(this));eD.on("mouseleave",(function(eG){return function(eH){eD.find(".status-col").show();return ey.hide()}})(this));R._files[ex.id]={file_div:ew,fq_path:ex.fq_path,bytes:ex.size,file_obj:ex};R._update_file_area_view();return R._update_collapsed_state()},_toggle_send_button_state:function(){var ew,T,ev;T=((ev=R.autocompleter)!=null?ev.token_manager.tokens.length:void 0)===0;T=T&&R.$collab_input.val()==="";ew=Object.keys(R._files).length===0||Object.keys(R._uploading_fileids).length>0;return R.$send_button.prop("disabled",T||ew)},_file_upload_errored:function(ew){var ev,T;ev=ew.memo.file;if(ev.id in R._uploading_fileids){T={message:ew.memo.message};aQ.SharedFolderActivityLogger.log("web","quick_send_file_errored",b2.active_user,T);return delete R._uploading_fileids[ev.id]}},_file_upload_completed:function(ev){var T;T=ev.memo.file;if(T.id in R._uploading_fileids){aQ.SharedFolderActivityLogger.log("web","quick_send_file_uploaded",b2.active_user,{});delete R._uploading_fileids[T.id];return R._toggle_send_button_state()}},is_quicksend_dest:function(T){var ev;ev=an.normalize(T);return ev===R.DEST_FOLDER},add_external_file:function(T){var ew,ev;ev=T.dest+T.name;if(R._has_added_fq_path(ev)){Y.success(dU("You\u2019ve already added this file."));document.fire(b9.CANCEL_EVT,{file:T});bf(document).trigger(b9.CANCEL_EVT,{file:T});return}T.fq_path=ev;T.bytes=T.size;R._uploading_fileids[T.id]=true;R._add_file(T,"external");ew=bf("#"+T.id);return ew.find(".upload-progress-bar").css({width:"0"})},add_dropbox_file:function(T){var ev;if(T.dir){Y.error(dU("Please select files instead of folders."));return}if(R._has_added_fq_path(T.fq_path)){Y.success(dU("You\u2019ve already added this file."));return}T.name=T.filename;R._add_file(T,"dropbox");ev=bf("#"+T.id);ev.find(".upload-progress-bar").css({width:"100%"});ev.addClass("complete");return setTimeout(function(){var ew;ew=ev.find(".status-col");ew.empty();return ew.append(b6.make("web","s_check"))},0)}};var dj,b3,am={}.hasOwnProperty,cl=function(ex,ev){for(var T in ev){if(am.call(ev,T)){ex[T]=ev[T]}}function ew(){this.constructor=ex}ew.prototype=ev.prototype;ex.prototype=new ew();ex.__super__=ev.prototype;return ex},cU=function(T,ev){return function(){return T.apply(ev,arguments)}};dj=A.SharedLinkSettingsModal=(function(ev){cl(T,ev);function T(ew,ex){var ey;this.owner_id=ew;this.tkey=ex;ey={tkey:this.tkey};ey[Constants.UID_PARAM_NAME]=this.owner_id;T.__super__.constructor.call(this,{element_id:"shared-link-settings-modal",endpoint_url:"/sm/shared_link_settings",parameters:ey})}return T})(ca);b3=A.SharedLinkSettingsModalContent=(function(){function T(ew,ex,ev,ez){var eA,ey;this.owner_id=ew;this.tkey=ex;this.filename=ev;this.saved_password_placeholder_value=ez;this._save_settings=cU(this._save_settings,this);this._toggle_password_input=cU(this._toggle_password_input,this);this._enable_password_input_for_editing=cU(this._enable_password_input_for_editing,this);this._date_change_callback=cU(this._date_change_callback,this);this._show_calendar=cU(this._show_calendar,this);this._hide_calendar=cU(this._hide_calendar,this);this._future_date=cU(this._future_date,this);this._enable_save_button=cU(this._enable_save_button,this);this._custom_expiry_click_handler=cU(this._custom_expiry_click_handler,this);this._hide_custom_expiry_label=cU(this._hide_custom_expiry_label,this);this._show_custom_expiry_label=cU(this._show_custom_expiry_label,this);this._toggle_expiration=cU(this._toggle_expiration,this);this._expiry_picker_callback=cU(this._expiry_picker_callback,this);this._listen=cU(this._listen,this);this._detect_and_handle_blur_when_password_empty=cU(this._detect_and_handle_blur_when_password_empty,this);this._is_clicked=cU(this._is_clicked,this);this._change_password_click=cU(this._change_password_click,this);this._init_expiration_section=cU(this._init_expiration_section,this);this.MS_PER_DAY=1000*60*60*24;this.$content=bf(".sharing-settings-modal-content");this.modal=du.get_containing_modal(this.$content);if(!this.modal){return}ey=dU("'%(filename)s' settings").format({filename:bt.em_snippet(this.filename,18)});this.modal.set_title(ey);this.$form=this.$content.find(".shared-link-settings-modal-form");this.$save_button=this.$form.find(".confirm-button");this.$password_field_container=this.$form.find(".password-field-container");this.$password=this.$form.find(".link-password-container");this.$password_input=this.$password.find("input[name='password']");this.$password_label=this.$password.find("label");this.$change_password=this.$form.find(".change-link-password-container");this.$selected_expiry=this.$form.find(".selected-expiration");this.$unselected_expiry=this.$form.find(".unselected-expiration");this.$custom_expiry=this.$form.find(".custom-expiration");this.$selected_date_box=this.$form.find(".selected-date");this.$selected_date=this.$form.find(".selected-date-text");this.$calendar=this.$form.find("#expiration-calendar-container");this.$expiry_posix=this.$form.find("#expiration-posix");this.loaded_with_saved_password=this.$password_input.data("is-saved-password")==="yes";if(this.loaded_with_saved_password){this._show_password_input(eA=true)}this._init_expiration_section();this._listen()}T.prototype._init_expiration_section=function(){var ev;this.$form.find(".expiration-selection").show();if(this.$expiry_posix.val()){bf("#expiration-yes").prop("checked",true);ev=this._posix_time_to_date(parseInt(this.$expiry_posix.val()));this._set_selected_date_text(ev);return this._show_custom_expiry_label()}else{this.$selected_expiry.hide();this._hide_custom_expiry_label();return this.$unselected_expiry.show()}};T.prototype._change_password_click=function(ev){ev.preventDefault();return this._enable_password_input_for_editing()};T.prototype._is_clicked=function(ev,ew){return ev.is(ew.target)||ev.has(ew.target).length};T.prototype._detect_and_handle_blur_when_password_empty=function(ev){if(!this.$password.is(":visible")||this.$password_input.val()||this._is_clicked(this.$password_field_container,ev)){return}return this._show_password_input(true)};T.prototype._listen=function(){if(this.loaded_with_saved_password){bf(window).on("click",this._detect_and_handle_blur_when_password_empty);this.$change_password.find(".change-link-password").on("click",this._change_password_click)}this.$form.on("change",this._enable_save_button);this.$form.on("submit",this._save_settings);this.$save_button.on("click",this._save_settings);this.$content.find(".cancel-button").on("click",(function(ev){return function(ew){return dm.pop()}})(this));this.$content.find(".audience-selection input[type=radio]").on("change",this._toggle_password_input);this.$content.find(".expiration-selection input[type=radio]").on("change",this._toggle_expiration);return bf(window).on(bb.CHANGED,this._expiry_picker_callback)};T.prototype._expiry_picker_callback=function(ey,ex){var ev,ew;ev=ex.clicked_val;if(ev!=="custom"){ew=this._future_date(parseInt(ev));return this._set_expiration(ew)}else{this.$selected_expiry.hide();this._show_custom_expiry_label();this._set_selected_date_text(this._future_date(30));return this._show_calendar()}};T.prototype._toggle_expiration=function(ex){var ew,ev;if(bf(ex.currentTarget).attr("id")==="expiration-yes"){this.$selected_expiry.show();this._hide_custom_expiry_label();this.$unselected_expiry.hide();bf(".expiration-picker").controller().set_value(30);ev=30;ew=this._future_date(ev);this._set_expiration(ew);return this._set_selected_date_text(ew)}else{this.$expiry_posix.val("");this.$unselected_expiry.show();this.$selected_expiry.hide();this._hide_custom_expiry_label();return this._hide_calendar()}};T.prototype._show_custom_expiry_label=function(){this.$custom_expiry.show();this.$selected_expiry.hide();this.$unselected_expiry.hide();return bf(window).on("click",this._custom_expiry_click_handler)};T.prototype._hide_custom_expiry_label=function(){this.$custom_expiry.hide();return bf(window).off("click",this._custom_expiry_click_handler)};T.prototype._custom_expiry_click_handler=function(ev){if(this._is_clicked(this.$calendar,ev)){return}if(this.$selected_date_box.is(ev.target)||this.$selected_date_box.has(ev.target).length){if(this.$calendar.is(":visible")){return this.$calendar.hide()}else{return this._show_calendar()}}else{if(this.$calendar.is(":visible")){return this.$calendar.hide()}}};T.prototype._enable_save_button=function(ev){return this.$save_button.removeAttr("disabled")};T.prototype._future_date=function(ev){var ew;ew=ds.start_of_day(new Date());ew.setDate(ew.getDate()+ev);return ew};T.prototype._hide_calendar=function(){return this.$calendar.hide()};T.prototype._show_calendar=function(){var ex,ew,ev;bf(".selected-date").off("click");if(!this.calendar){if(this.$expiry_posix.val()){ev=this._posix_time_to_date(parseInt(this.$expiry_posix.val()))}else{ev=this._future_date(30)}ew={disable_past:true,first_day:this._future_date(1),last_day:this._future_date(365),selected_date:ev,onDateChange:bf.proxy(this._date_change_callback,this)};this.calendar=new D("expiration-calendar-container",ew)}else{this.$calendar.show()}ex=this.$selected_date_box.offset().left;return this.$calendar.show().offset({left:ex})};T.prototype._posix_time_to_date=function(ev){return new Date(ev*1000)};T.prototype._set_selected_date_text=function(ev){return this.$selected_date.text(I.localize(ev))};T.prototype._set_expiration=function(ew){var ev,ex;ci(ew.getMilliseconds()===0);ci(ew.getSeconds()===0);ci(ew.getMinutes()===0);ci(ew.getHours()===0);ex=(ew.getTime()+this.MS_PER_DAY)/1000;ev=ex-1;return this.$expiry_posix.val(ev)};T.prototype._date_change_callback=function(ev){this._set_selected_date_text(ev);this._set_expiration(ev);this._enable_save_button();return this._hide_calendar()};T.prototype._show_password_input=function(eA){var ez,ex,ew,ey,ev;if(eA==null){eA=false}ez=this.$content.find("label[for=audience-password]").position().left;ey=this.$content.find("#audience-password").position().left;ex=ez-ey+10;this.$password.show().css({left:ex});this.$password_input.val("");if(eA){this.$password_input.addClass("disabled").attr("readonly","true");this.$password_input.data("is-saved-password","yes");ev="\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf";this.$password_label.text(ev).show();ew=this.$password.position();return this.$change_password.css({left:ew.left,top:ew.top}).show()}else{return this._enable_password_input_for_editing()}};T.prototype._enable_password_input_for_editing=function(){this.$change_password.hide();this.$password_input.removeAttr("readonly").removeClass("disabled");this.$password_input.data("is-saved-password","no");this.$password_label.text(dU("Set password")).show();this.$password_input.focus();return this._enable_save_button()};T.prototype._toggle_password_input=function(ev){var ew;if(bf(ev.currentTarget).attr("id")==="audience-password"){return this._show_password_input(ew=this.loaded_with_saved_password)}else{this.$password.hide();this.$change_password.hide();return this.$password_input.data("is-saved-password","no")}};T.prototype._save_settings=function(ey){var ew,ev,ex,ez;if(this.$password_input.data("is-saved-password")==="yes"){ex={type:"hidden",name:"password",value:this.saved_password_placeholder_value};ew=bf("<input />",ex);this.$form.append(ew);this.$password_input.attr("name","inoperative_password")}ez=(function(eA){return function(eB){dm.pop();return Y.success(dU("Settings saved."))}})(this);ev=(function(eA){return function(eB){if(eA.$password.length&&eA.$password.is(":visible")){eA.$password_input.focus()}return bs.remove_loading()}})(this);return bs.ajax_submit(this.$form[0],"/sm/change_shared_link_settings",ez,ev,this.$save_button[0])};return T})();var dT,dQ;dQ=A.FoshmodalPanes=Object.clone(cO);dQ.to_title_str=function(){var T,ev,ez,ex,ey,ew;if(dT.sharing_collection){ex=bt.em_snippet(dT.collection_to_share.name,18,1);return dU("Share '%(snippeted_name)s'").format({snippeted_name:ex})}else{T=dT._selection;ew=cB.categorize_files(T),ev=ew[0],ez=ew[1];if(ev&&ez){ey=aR("Share %(file_count)s item","Share %(file_count)s items",T.length)}else{if(ev){ey=aR("Share %(file_count)s photo","Share %(file_count)s photos",T.length)}else{ey=aR("Share %(file_count)s video","Share %(file_count)s videos",T.length)}}ey=ey.format({file_count:T.length});return ey}};dT=INLINE_JS.Foshmodal=A.Foshmodal={current_shmodel_url:null,current_short_url:null,callback_for_when_we_have_shmodel_url:null,current_foshmodal_pane:dQ.SEND,send_link_autocompleter:null,sharing_collection:false,num_photos_to_share:null,working:false,collection_to_share:null,have_real_tkey:false,current_tkey:null,current_album_name:null,previous_album_name:null,_selection:null,lock:function(){if(this.working){return false}this.working=true;return this.working},unlock:function(){return this.working=false},clear_message_inputs:function(){$("shmodal-send-content").down(".custom-message-container").down(".textinput").setValue("");$("shmodal-fb-post-input").setValue("");return $("shmodal-twitter-post-input").setValue("")},refresh:function(){this.current_shmodel_url=null;this.current_short_url;this.callback_for_when_we_have_shmodel_url=null;this.current_foshmodal_pane=dQ.SEND;this.sharing_collection=false;this.have_real_tkey=false;this.current_tkey=null;this.current_album_name=null;this.previous_album_name=null;ed.clear();this.clear_message_inputs();this.send_link_autocompleter.clearTokens();this.unlock();bf(".link-image").attr("src","static/images/empty_album_big.png");bs.remove_loading(bf("#modal").find(".tokenizer-submit-button")[0]);bs.remove_loading(bf("#modal").find(".foshmodal-copy-link")[0]);bs.remove_loading(bf("#shmodal-twitter-post-submit")[0]);return bs.remove_loading(bf("#shmodal-fb-post-submit")[0])},create_album_from_selected_photos:function(T){var ev;ci(this._selection.length,"This should never be called with an empty selection");ci(this.current_tkey!=null,"Missing tkey");ci(this.current_shmodel_url!=null,"Missing shmodel url");ci(this.current_short_url!=null,"Missing short url");ci(T!=null,"Missing collection info");T.is_anonymous=this.creating_anonymous_collection();T.share_tkey=this.current_tkey;T.shmodel_url=this.current_shmodel_url;T.short_url=this.current_short_url;return ev=new W(T)},set_shmodel_url:function(ev,T){if(this.have_real_tkey){this.current_shmodel_url=this.collection_to_share.shmodel_url;this.current_short_url=this.collection_to_share.short_url;this.current_tkey=this.collection_to_share.share_tkey;return typeof ev==="function"?ev():void 0}else{return new Ajax.DBRequest("/collection_create_dummy_token",{onSuccess:(function(ew){return function(ey){var ex;ex=JSON.parse(ey.responseText);ew.current_shmodel_url=ex.token_link;ew.current_short_url=ex.short_link;ew.current_tkey=ex.tkey;if(typeof ev==="function"){ev()}return typeof ew.callback_for_when_we_have_shmodel_url==="function"?ew.callback_for_when_we_have_shmodel_url():void 0}})(this),onFailure:function(){return typeof T==="function"?T():void 0}})}},attach_collection_to_token:function(ev,T){ci(this.collection_to_share!=null,"Should get called only when there is an existing collection");ci(this.current_shmodel_url!=null,"Should have a shmodel url before you call attach_collection_to_token");if(this.have_real_tkey){if(typeof ev==="function"){ev(this.collection_to_share.gid)}return}ci(this.current_tkey!=null,"should have tkey");return this.collection_to_share.attach_to_token(this.current_tkey,this.current_shmodel_url,this.current_short_url,ev,T)},create_collection_and_attach_to_token:function(ez,T){var ew,ey,ex,ev;ci(this.sharing_collection===false,"Should not get called when we already have a collection");ci(this.current_shmodel_url!=null,"Should have a shmodel url before you call create_collection_and_attach_to_token");ey=(function(eA){return function(eB){var eC;eC=JSON.parse(eB.responseText);eA.create_album_from_selected_photos(eC);return typeof ez==="function"?ez(eC.gid):void 0}})(this);ew=function(eA){return typeof T==="function"?T(eA):void 0};ex={tkey:this.current_tkey,collection_name:this.creating_anonymous_collection()?"":this.current_album_name,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var eD,eB,eC,eA;eC=this._selection;eA=[];for(eD=0,eB=eC.length;eD<eB;eD++){ev=eC[eD];eA.push(ev.item_counter)}return eA}).call(this))};if(bp.in_single_collection_view()){ex.source_collection_gid=bp.get_current_collection().gid}return new Ajax.DBRequest("/collection_create_and_attach_to_dummy_token",{onSuccess:ey,onFailure:ew,parameters:ex})},alert_if_album_name_invalid:function(){if(this.creating_anonymous_collection()){return false}if(this.current_album_name.strip().length===0){Y.error(dU("Please enter a name for this album"));this.unlock();return true}if(cf.collection_name_in_use(this.current_album_name)){Y.error(dU("You already have an album named '%(current_album_name)s'").format({current_album_name:this.current_album_name}));this.unlock();return true}return false},send_button_onclick:function(ew){var ev,T;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}ev=$("shmodal-send-form");ci(ev,"Couldn't find the shmodal send form.");if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.send_button_onclick.bind(this);return}T=(function(ex){return function(ey){ex.unlock();if(!ey.responseText.startsWith("err:")){Y.error(dU("We couldn't send this album. Please try again."));ep.hide();return ex.refresh()}}})(this);if(this.sharing_collection){this.send_collection(ev,T)}else{this.send_selection(ev,T)}return h.log_interaction(dI.SEND,cD.FOSHMODAL,{num_photos:this.num_photos_to_share})},get_send_success_text:function(){var ex,ev,ew,T,ey;ex=this.get_current_display_name();T=ad.get_shmodel_send_recipients($("shmodal-send-form"));ev=T[0].split(" ")[0];if(T.length===1){ey=dU("Shared %(album_name)s with %(first_name_of_recipient)s").format({album_name:ex,first_name_of_recipient:ev})}else{if(T.length===2){ew=T[1].split(" ")[0];ey=dU("Shared %(album_name)s with %(first_name_of_recipient)s and %(first_name_of_second_recipient)s").format({album_name:ex,first_name_of_recipient:ev,first_name_of_second_recipient:ew})}else{ey=dU("Shared %(album_name)s with %(first_name_of_recipient)s and %(num_other_recipients)s others").format({album_name:ex,first_name_of_recipient:ev,num_other_recipients:T.length-1})}}return ey},send_selection:function(ew,ev){var ey,ex,T;ey=(function(ez){return function(eA){var eB;eB=JSON.parse(eA.responseText);ez.create_album_from_selected_photos(eB);Y.success(ez.get_send_success_text());ez.refresh();return ep.hide()}})(this);ex={shmodel_url:this.current_shmodel_url,tkey:this.current_tkey,num_items:this.num_photos_to_share,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var eC,eA,eB,ez;eB=this._selection;ez=[];for(eC=0,eA=eB.length;eC<eA;eC++){T=eB[eC];ez.push(T.item_counter)}return ez}).call(this))};if(bp.in_single_collection_view()){ex.source_collection_gid=bp.get_current_collection().gid}if(this.creating_anonymous_collection()){ex.collection_name=""}else{if(this.current_album_name.trim().length===0){ex.collection_name=cf.get_default_album_name()}}return bs.ajax_submit(ew,"/collection_create_and_send_link",ey,ev,ew.down(".tokenizer-submit-button"),ex)},send_collection:function(ev,T){var ew;ci(this.current_tkey!=null,"tkey should be set");ci(this.current_shmodel_url!=null,"shmodel url should be set");ew=(function(ex){return function(){Y.success(ex.get_send_success_text());ep.hide();return ex.refresh()}})(this);return this.collection_to_share.send_link(ev,this.current_tkey,this.current_shmodel_url,this.current_short_url,ew,T)},get_link_button_onclick:function(){var T,ew,ev;if(!this.lock()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.get_link_button_onclick.bind(this);return}ev=$("modal").down(".tokenizer-submit-button");ew=(function(ex){return function(ez){var ey;ey=ex.get_current_display_name();if(FlashDetect.installed){Y.success(dU("The link to %(album_name)s was copied to your clipboard",{comment:"name of a photo/video album"}).format({album_name:ey}))}ex.show_get_link_modal(ex.current_shmodel_url,ey,ez);aQ.ViralLogger.log(cj.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_copy_link",file_type:"collection"});if(ex.collection_to_share!=null){b7.log_share("share_link",ez,ex.num_photos_to_share,ex.creating_anonymous_collection(),!ex.sharing_collection)}return ex.refresh()}})(this);T=(function(ex){return function(ey){ex.unlock();bs.remove_loading(ev);if(!ey.responseText.startsWith("err")){Y.error(dU("We couldn't create a link to this album. Please try again."));ep.hide();return ex.refresh()}}})(this);if(this.sharing_collection){bs.add_loading(ev);this.attach_collection_to_token(ew,T)}else{if(this.alert_if_album_name_invalid()){return}bs.add_loading(ev);this.create_collection_and_attach_to_token(ew,T)}return h.log_interaction(dI.GET_LINK,cD.FOSHMODAL,{num_photos:this.num_photos_to_share})},initialize_get_link_button:function(){var T,ev;if(FlashDetect.installed){T=q.clipboard_overlay(this.current_shmodel_url,bf("#foshmodal-copy-link"),dT.get_link_button_onclick.bind(this));T.css({position:"fixed",zIndex:1001});clearInterval(this.follow_freshbutton);ev=(function(ew){return function(){return T.clonePosition(bf("#foshmodal-copy-link"),{offsetHeight:6,offsetWidth:6})}})(this);return this.follow_freshbutton=setInterval(ev,500)}else{$("foshmodal-copy-link").stopObserving();return $("foshmodal-copy-link").observe("click",this.get_link_button_onclick.bind(this))}},facebook_button_onclick:function(ez,ev){var ey,ew,T,ex;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.facebook_button_onclick.bind(this).curry(ez,ev);return}ey=bf("#modal:visible, #modal-overlay:visible");T=function(){return ey.show()};ew=(function(eA){return function(){eA.lock();setTimeout(eA.unlock.bind(eA),750);return dN.do_auth((function(){return eA.do_fb_post(ev)}),ev)}})(this);if(dN.authed_user_id===ev){this.do_fb_post(ev)}else{if(cj.get_viewer().is_uid_associated(dN.authed_user_id)){this.unlock();ey.hide();ex=new dz(cj.get_viewer().get_user_by_id(ev),T,ew.bind(this));ex.show()}else{ew()}}return h.log_interaction(dI.FB_SHARE,cD.FOSHMODAL,{num_photos:this.num_photos_to_share})},twitter_button_onclick:function(ev,T){if(!this.lock()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.twitter_button_onclick.bind(this).curry(ev,T);return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(cc.is_authed(T)){this.do_twitter_post(T)}else{setTimeout(this.unlock.bind(this),750);cc.do_auth(((function(ew){return function(){return ew.do_twitter_post(T)}})(this)),T)}return h.log_interaction(dI.TWITTER_SHARE,cD.FOSHMODAL,{num_photos:this.num_photos_to_share})},do_fb_post:function(T){var ev,ew;ev=(function(ex){return function(){Y.error(dU("We couldn't share this album on Facebook. Please try again."));ep.hide();return ex.refresh()}})(this);ew=(function(ex){return function(ez){var ey;dN.custom_show_posting=function(){return bs.add_loading($("shmodal-fb-post-submit"))};dN.progress_container=$("modal").down(".modal-buttons");ey=ex.get_current_display_name();dN.custom_show_complete=function(){ep.hide();Y.success(dU("Shared %(album_name)s on Facebook!",{comment:"name of a photo/video album"}).format({album_name:ey}));return ex.refresh()};dN.post($F("shmodal-fb-post-input"),ex.current_shmodel_url,null,null,null,ev,T);aQ.ViralLogger.log(cj.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_fb_post",file_type:"collection"});return b7.log_share("share_facebook",ez,ex.num_photos_to_share,ex.creating_anonymous_collection(),!ex.sharing_collection)}})(this);if(this.sharing_collection){return this.attach_collection_to_token(ew,ev)}else{return this.create_collection_and_attach_to_token(ew,ev)}},do_twitter_post:function(T){var ex,ev,ew;ex=$F("shmodal-twitter-post-input");if(!ex){Y.error(dU("Please enter a tweet"));this.unlock();return}if(ex.length>140){Y.error(dU("Your tweet must be 140 characters or less"));this.unlock();return}ew=(function(ey){return function(ez){cc.custom_show_posting=function(){$("twitter-chars").hide();return bs.add_loading($("shmodal-twitter-post-submit"))};cc.custom_post(ex,function(){ep.hide();Y.success(dU("Your tweet has been posted!"));return ey.refresh()},T);aQ.ViralLogger.log(cj.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_twitter",file_type:"collection"});return b7.log_share("share_twitter",ez,ey.num_photos_to_share,ey.creating_anonymous_collection(),!ey.sharing_collection)}})(this);ev=(function(ey){return function(){Y.error(dU("We couldn't share this album on Twitter. Please try again."));ep.hide();return ey.refresh()}})(this);if(this.sharing_collection){return this.attach_collection_to_token(ew,ev)}else{return this.create_collection_and_attach_to_token(ew,ev)}},show_get_link_modal:function(ev,T,ew){var ex;ep.show(dU("Link to %(album_name)s").format({album_name:T.escapeHTML()}),$("get-link-modal"));ex=$("get-link-modal").down(".link-input");ex.setValue(ev);ex.select();$("get-link-modal").down(".view-button").onclick=function(){window.open(ev,"_blank");return ep.hide()};return $("get-link-modal").down(".done-button").onclick=function(){if(ew!=null){cf.flash_sidebar_album(ew)}return ep.hide()}},update_current_album_name_text:function(T){this.current_album_name=$(dQ.to_content_str(this.current_foshmodal_pane)).down(".album-name-input").value;if(this.current_foshmodal_pane===dQ.FB){return this.set_fb_post_title(this.current_album_name)}},set_fb_post_title:function(ey){var ev,ex,ew,T;T=this.sharing_collection?bp.get_timeline().get_photos():this._selection;if(ey){if(this.num_photos_to_share===1){ev=ey}else{ev=dU("%(album_name_text)s (%(album_desc)s)",{comment:'e.g. album_desc is "5 photos and 1 video" and album_name_text is "my_album"'}).format({album_name_text:ey,album_desc:cB.file_desc(T)})}}else{if(T.length===1){ew=T[0];if(ew.preview_type==="photo"){ex=dU("Photo from %(date_taken)s")}else{ex=dU("Video from %(date_taken)s")}ev=ex.format({date_taken:bE.nice_date_with_month_name(new Date(ew.time_taken),true,true,true)})}else{ev=cB.file_desc(T)}}return $(dQ.to_content_str(dQ.FB)).down(".link-name").__date(ev)},set_current_album_name_text:function(ev,T){$(dQ.to_content_str(ev)).down(".album-name-input").value=T;if(ev===dQ.FB){return this.set_fb_post_title(T)}},show_content:function(ey){var ev,ex,T,ew;if(this.working){return}$("shmodal-title-text").__date(dQ.to_title_str());ew=dQ.list;for(ex=0,T=ew.length;ex<T;ex++){ev=ew[ex];if(ev!==ey){$(dQ.to_toggle_str(ev)).removeClassName("toggled");$(dQ.to_content_str(ev)).hide()}}$(dQ.to_content_str(ey)).show();$(dQ.to_toggle_str(ey)).addClassName("toggled");if(!this.sharing_collection){this.set_current_album_name_text(ey,this.current_album_name)}switch(ey){case dQ.FB:$("shmodal-fb-post-input").focus();break;case dQ.TWITTER:$("shmodal-twitter-post-input").focus();break;case dQ.SEND:$("foshmodal-new-collab-input").focus()}return this.current_foshmodal_pane=ey},_get_foshmodal_title:function(){return ad.generate_title_content(dQ.to_title_str(),((function(T){return function(){return T.show_content(dQ.SEND)}})(this)),((function(T){return function(){return T.show_content(dQ.FB)}})(this)),((function(T){return function(){return T.show_content(dQ.TWITTER)}})(this)))},creating_anonymous_collection:function(){return !$("shmodal").hasClassName("saving-as-album")},get_current_display_name:function(){if(this.sharing_collection){return"'"+this.collection_to_share.name+"'"}else{if(this.creating_anonymous_collection()){return cB.file_desc(this._selection,true)}else{return"'"+this.current_album_name+"'"}}},set_twitter_message:function(){var T,ew,ev,ey,ex;T=this.sharing_collection?bp.get_timeline().get_photos():this._selection;if(T.length===1){ex=cB.categorize_files(T),ev=ex[0],ey=ex[1];if(ev){ew=dU("Just shared a photo using @Dropbox")}else{if(ey){ew=dU("Just shared a video using @Dropbox")}else{ci(false,"We shouldn't have non-photo, non-video files in timeline")}}}else{ew=dU("Just shared an album using @Dropbox")}return $("shmodal-twitter-post-input").setValue(""+ew+" "+this.current_short_url)},update_shmodal_image_text:function(){var eB,eE,eD,ez,ey,eC,T,eA,ex,ew,ev;if(this.sharing_collection){eE=this.collection_to_share.num_items;eD=cB.album_desc(this.collection_to_share,false,true)}else{eE=this._selection.length;eD=cB.file_desc(this._selection,false,true)}if(eE>1){eA=$$(".shmodal-image");ew=[];for(ez=0,eC=eA.length;ez<eC;ez++){eB=eA[ez];eB.down("span").__date(eD);ew.push(eB.down(".share-file-count").show())}return ew}else{ex=$$(".shmodal-image");ev=[];for(ey=0,T=ex.length;ey<T;ey++){eB=ex[ey];ev.push(eB.down(".share-file-count").hide())}return ev}},show:function(eC,eJ){var eD,eG,eH,eE,eI,eA,ez,ex,eF,ev,T,eB,ey,ew;this.unlock();ep.onHide=(function(eK){return function(){var eM,eL;if((eM=$("flash_copy_container"))!=null){eM.remove()}if((eL=eK.send_link_autocompleter)!=null){eL.hide()}bf("#modal").find(".new-collab-input").val("");clearInterval(eK.follow_freshbutton);bp.disable_selection();delete ep.onHide;return ep.hide()}})(this);this.sharing_collection=eJ;eI=this.sharing_collection?eC.thumbnail_url_256:eC[0].thumbnail_url;eB=$$(".link_image");for(eA=0,eF=eB.length;eA<eF;eA++){eG=eB[eA];if(eI!=null){eG.src=eI}else{eG.src="static/images/empty_album_big.png"}}this.current_foshmodal_pane=dQ.SEND;this.have_real_tkey=this.sharing_collection&&(eC.share_tkey!=null);if(this.sharing_collection){this.collection_to_share=eC;this.num_photos_to_share=this.collection_to_share.num_items;$("shmodal").addClassName("sharing-collection");this.set_fb_post_title(this.collection_to_share.name)}else{this._selection=eC.sort(function(eL,eK){return eL.time_taken-eK.time_taken});this.num_photos_to_share=this._selection.length;this.current_album_name="";this.set_current_album_name_text(this.current_foshmodal_pane,this.current_album_name);$("shmodal").removeClassName("sharing-collection");$("shmodal").removeClassName("saving-as-album");ey=$$(".save-as-album-checkbox");for(ez=0,ev=ey.length;ez<ev;ez++){eD=ey[ez];eD.checked=false;eE=(function(eK){return function(eT){var eU,eQ,eO,eM,eL,eP,eN,eS,eR;if(eT.target.checked){$("shmodal").addClassName("saving-as-album");eK.current_album_name=eK.previous_album_name||cf.get_default_album_name();eK.set_current_album_name_text(eK.current_foshmodal_pane,eK.current_album_name);eU=$(dQ.to_content_str(eK.current_foshmodal_pane)).down(".album-name-input");eU.focus();eU.select();eP=$$(".save-as-album-checkbox");eS=[];for(eQ=0,eM=eP.length;eQ<eM;eQ++){eD=eP[eQ];eS.push(eD.checked=true)}return eS}else{$("shmodal").removeClassName("saving-as-album");eK.previous_album_name=eK.current_album_name;eK.current_album_name="";eK.set_current_album_name_text(eK.current_foshmodal_pane,eK.current_album_name);eN=$$(".save-as-album-checkbox");eR=[];for(eO=0,eL=eN.length;eO<eL;eO++){eD=eN[eO];eR.push(eD.checked=false)}return eR}}})(this);eD.observe("change",eE);if(bB.msie_version_at_most(8)){eD.observe("click",eE)}}ew=$$(".album-name-input");for(ex=0,T=ew.length;ex<T;ex++){eH=ew[ex];eH.observe("keyup",this.update_current_album_name_text.bind(this))}}bp.enable_selection();ep.show(this._get_foshmodal_title(),$("shmodal"));this.clear_message_inputs();this.show_content(this.current_foshmodal_pane);this.set_shmodel_url(((function(eK){return function(){eK.initialize_get_link_button();return eK.set_twitter_message()}})(this)),(function(){Y.error(dU("This request could not be completed.  Please try again."));return ep.hide()}));this.update_shmodal_image_text();if(!this.send_link_autocompleter){this.send_link_autocompleter=new Autocompleter.ContactsTokenizer(cj.get_viewer().get_user_by_role(Constants.ROLE_PHOTOS),"foshmodal-new-collab-input","foshmodal-new-whobulk","foshmodal-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true})}this.send_link_autocompleter.clearTokens();O.register(false,$("modal"));if(this.num_photos_to_share<=1){$("shmodal-send-content").down(".collection-thumb-stack").hide();$("shmodal-twitter-content").down(".collection-thumb-stack").hide()}else{$("shmodal-send-content").down(".collection-thumb-stack").show();$("shmodal-twitter-content").down(".collection-thumb-stack").show()}return ds._track_twitter_chars_left("shmodal-twitter-post-input",140)}};(function(ev,eA){var ex={};function ew(eF,eG){var eE,eC=[];for(var eD=0;eD<eF.length;++eD){eE=ex[eF[eD]]||ey(eF[eD]);if(!eE){throw"module definition dependecy not found: "+eF[eD]}eC.push(eE)}eG.apply(null,eC)}function eB(eE,eD,eC){if(typeof eE!=="string"){throw"invalid module definition, module id must be defined and be a string"}if(eD===eA){throw"invalid module definition, dependencies must be specified"}if(eC===eA){throw"invalid module definition, definition function must be specified"}ew(eD,function(){ex[eE]=eC.apply(null,arguments)})}function ez(eC){return !!ex[eC]}function ey(eF){var eD=ev;var eC=eF.split(/[.\/]/);for(var eE=0;eE<eC.length;++eE){if(!eD[eC[eE]]){return}eD=eD[eC[eE]]}return eD}function T(eE){for(var eD=0;eD<eE.length;eD++){var eF=ev;var eH=eE[eD];var eC=eH.split(/[.\/]/);for(var eG=0;eG<eC.length-1;++eG){if(eF[eC[eG]]===eA){eF[eC[eG]]={}}eF=eF[eC[eG]]}eF[eC[eC.length-1]]=ex[eH]}}eB("moxie/core/utils/Basic",[],function(){var eK=function(eP){var eO;if(eP===eO){return"undefined"}else{if(eP===null){return"null"}else{if(eP.nodeType){return"node"}}}return({}).toString.call(eP).match(/\s([a-z|A-Z]+)/)[1].toLowerCase()};var eG=function(eP){var eO;eI(arguments,function(eQ,eR){if(eR>0){eI(eQ,function(eT,eS){if(eT!==eO){if(eK(eP[eS])===eK(eT)&&!!~eM(eK(eT),["array","object"])){eG(eP[eS],eT)}else{eP[eS]=eT}}})}});return eP};var eI=function(eT,eU){var eS,eQ,eP,eR;if(eT){try{eS=eT.length}catch(eO){eS=eR}if(eS===eR){for(eQ in eT){if(eT.hasOwnProperty(eQ)){if(eU(eT[eQ],eQ)===false){return}}}}else{for(eP=0;eP<eS;eP++){if(eU(eT[eP],eP)===false){return}}}}};var eL=function(eO){var eP;if(!eO||eK(eO)!=="object"){return true}for(eP in eO){return false}return true};var eE=function(eP,eO){var eQ=0,eR=eP.length;if(eK(eO)!=="function"){eO=function(){}}if(!eP||!eP.length){eO()}function eS(eT){if(eK(eP[eT])==="function"){eP[eT](function(eU){++eT<eR&&!eU?eS(eT):eO(eU)})}}eS(eQ)};var eM=function(eQ,eR){if(eR){if(Array.prototype.indexOf){return Array.prototype.indexOf.call(eR,eQ)}for(var eO=0,eP=eR.length;eO<eP;eO++){if(eR[eO]===eQ){return eO}}}return -1};var eJ=function(eP,eR){var eQ=[];if(eK(eP)!=="array"){eP=[eP]}if(eK(eR)!=="array"){eR=[eR]}for(var eO in eP){if(eM(eP[eO],eR)===-1){eQ.push(eP[eO])}}return eQ.length?eQ:false};var eN=function(eQ,eP){var eO=[];eI(eQ,function(eR){if(eM(eR,eP)!==-1){eO.push(eR)}});return eO.length?eO:null};var eF=function(eQ){var eP,eO=[];for(eP=0;eP<eQ.length;eP++){eO[eP]=eQ[eP]}return eO};var eH=(function(){var eO=0;return function(eR){var eP=new Date().getTime().toString(32),eQ;for(eQ=0;eQ<5;eQ++){eP+=Math.floor(Math.random()*65535).toString(32)}return(eR||"o_")+eP+(eO++).toString(32)}}());var eC=function(eO){if(!eO){return eO}return String.prototype.trim?String.prototype.trim.call(eO):eO.toString().replace(/^\s*/,"").replace(/\s*$/,"")};var eD=function(eO){if(typeof(eO)!=="string"){return eO}var eQ={t:1099511627776,g:1073741824,m:1048576,k:1024},eP;eO=/^([0-9]+)([mgk]?)$/.exec(eO.toLowerCase().replace(/[^0-9mkg]/g,""));eP=eO[2];eO=+eO[1];if(eQ.hasOwnProperty(eP)){eO*=eQ[eP]}return eO};return{guid:eH,typeOf:eK,extend:eG,each:eI,isEmptyObj:eL,inSeries:eE,inArray:eM,arrayDiff:eJ,arrayIntersect:eN,toArray:eF,trim:eC,parseSizeStr:eD}});eB("moxie/core/I18n",["moxie/core/utils/Basic"],function(eD){var eC={};return{addI18n:function(eE){return eD.extend(eC,eE)},translate:function(eE){return eC[eE]||eE},_:function(eE){return this.translate(eE)},sprintf:function(eG){var eF=[].slice.call(arguments,1),eE="";eD.each(eG.split(/%[a-z]/),function(eH){eE+=eH;if(eF.length){eE+=eF.shift()}});return eE}}});eB("moxie/core/utils/Mime",["moxie/core/utils/Basic","moxie/core/I18n"],function(eF,eE){var eC="application/msword,doc dot,application/pdf,pdf,application/pgp-signature,pgp,application/postscript,ps ai eps,application/rtf,rtf,application/vnd.ms-excel,xls xlb,application/vnd.ms-powerpoint,ppt pps pot,application/zip,zip,application/x-shockwave-flash,swf swfl,application/vnd.openxmlformats-officedocument.wordprocessingml.document,docx,application/vnd.openxmlformats-officedocument.wordprocessingml.template,dotx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,xlsx,application/vnd.openxmlformats-officedocument.presentationml.presentation,pptx,application/vnd.openxmlformats-officedocument.presentationml.template,potx,application/vnd.openxmlformats-officedocument.presentationml.slideshow,ppsx,application/x-javascript,js,application/json,json,audio/mpeg,mp3 mpga mpega mp2,audio/x-wav,wav,audio/mp4,m4a,audio/ogg,oga ogg,audio/aiff,aiff aif,audio/flac,flac,audio/aac,aac,audio/ac3,ac3,audio/x-ms-wma,wma,image/bmp,bmp,image/gif,gif,image/jpeg,jpg jpeg jpe,image/photoshop,psd,image/png,png,image/svg+xml,svg svgz,image/tiff,tiff tif,text/plain,asc txt text diff log,text/html,htm html xhtml,text/css,css,text/csv,csv,text/rtf,rtf,video/mpeg,mpeg mpg mpe m2v,video/quicktime,qt mov,video/mp4,mp4,video/x-m4v,m4v,video/x-flv,flv,video/x-ms-wmv,wmv,video/avi,avi,video/webm,webm,video/3gpp,3gpp 3gp,video/3gpp2,3g2,video/vnd.rn-realvideo,rv,video/ogg,ogv,video/x-matroska,mkv,application/vnd.oasis.opendocument.formula-template,otf,application/octet-stream,exe";var eD={mimes:{},extensions:{},addMimeType:function(eG){var eH=eG.split(/,/),eI,eK,eJ;for(eI=0;eI<eH.length;eI+=2){eJ=eH[eI+1].split(/ /);for(eK=0;eK<eJ.length;eK++){this.mimes[eJ[eK]]=eH[eI]}this.extensions[eH[eI]]=eJ}},extList2mimes:function(eM,eN){var eH=this,eL,eI,eK,eJ,eG=[];for(eI=0;eI<eM.length;eI++){eL=eM[eI].extensions.split(/\s*,\s*/);for(eK=0;eK<eL.length;eK++){if(eL[eK]==="*"){return[]}eJ=eH.mimes[eL[eK]];if(!eJ){if(eN&&/^\w+$/.test(eL[eK])){eG.push("."+eL[eK])}else{return[]}}else{if(eF.inArray(eJ,eG)===-1){eG.push(eJ)}}}}return eG},mimes2exts:function(eG){var eH=this,eI=[];eF.each(eG,function(eK){if(eK==="*"){eI=[];return false}var eJ=eK.match(/^(\w+)\/(\*|\w+)$/);if(eJ){if(eJ[2]==="*"){eF.each(eH.extensions,function(eL,eM){if((new RegExp("^"+eJ[1]+"/")).test(eM)){[].push.apply(eI,eH.extensions[eM])}})}else{if(eH.extensions[eK]){[].push.apply(eI,eH.extensions[eK])}}}});return eI},mimes2extList:function(eG){var eI=[],eH=[];if(eF.typeOf(eG)==="string"){eG=eF.trim(eG).split(/\s*,\s*/)}eH=this.mimes2exts(eG);eI.push({title:eE.translate("Files"),extensions:eH.length?eH.join(","):"*"});eI.mimes=eG;return eI},getFileExtension:function(eH){var eG=eH&&eH.match(/\.([^.]+)$/);if(eG){return eG[1].toLowerCase()}return""},getFileMime:function(eG){return this.mimes[this.getFileExtension(eG)]||""}};eD.addMimeType(eC);return eD});eB("moxie/core/utils/Env",["moxie/core/utils/Basic"],function(eI){var eE=[{s1:navigator.userAgent,s2:"Android",id:"Android Browser",sv:"Version"},{s1:navigator.userAgent,s2:"Chrome",id:"Chrome"},{s1:navigator.vendor,s2:"Apple",id:"Safari",sv:"Version"},{prop:window.opera&&window.opera.buildNumber,id:"Opera",sv:"Version"},{s1:navigator.vendor,s2:"KDE",id:"Konqueror"},{s1:navigator.userAgent,s2:"Firefox",id:"Firefox"},{s1:navigator.vendor,s2:"Camino",id:"Camino"},{s1:navigator.userAgent,s2:"Netscape",id:"Netscape"},{s1:navigator.userAgent,s2:"MSIE",id:"IE",sv:"MSIE"},{s1:navigator.userAgent,s2:"Trident",id:"IE",sv:"rv"},{s1:navigator.userAgent,s2:"Gecko",id:"Mozilla",sv:"rv"}],eG=[{s1:navigator.platform,s2:"Win",id:"Windows"},{s1:navigator.platform,s2:"Mac",id:"Mac"},{s1:navigator.userAgent,s2:"iPhone",id:"iOS"},{s1:navigator.userAgent,s2:"iPad",id:"iOS"},{s1:navigator.userAgent,s2:"Android",id:"Android"},{s1:navigator.platform,s2:"Linux",id:"Linux"}],eD;function eH(eL){var eM,eN;for(var eK=0;eK<eL.length;eK++){eM=eL[eK].s1;eN=eL[eK].prop;eD=eL[eK].sv||eL[eK].id;if(eM){if(eM.indexOf(eL[eK].s2)!=-1){return eL[eK].id}}else{if(eN){return eL[eK].id}}}}function eJ(eL){var eK=eL.indexOf(eD);if(eK==-1){return}return parseFloat(eL.substring(eK+eD.length+1))}var eF=(function(){var eK={define_property:(function(){return false}()),create_canvas:(function(){var eL=document.createElement("canvas");return !!(eL.getContext&&eL.getContext("2d"))}()),return_response_type:function(eL){try{if(eI.inArray(eL,["","text","document"])!==-1){return true}else{if(window.XMLHttpRequest){var eN=new XMLHttpRequest();eN.open("get","/");if("responseType" in eN){eN.responseType=eL;if(eN.responseType!==eL){return false}return true}}}}catch(eM){}return false},use_data_uri:(function(){var eL=new Image();eL.onload=function(){eK.use_data_uri=(eL.width===1&&eL.height===1)};setTimeout(function(){eL.src="data:image/gif;base64,R0lGODlhAQABAIAAAP8AAAAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw=="},1);return false}()),use_data_uri_over32kb:function(){return eK.use_data_uri&&(eC.browser!=="IE"||eC.version>=9)},use_data_uri_of:function(eL){return(eK.use_data_uri&&eL<33000||eK.use_data_uri_over32kb())},use_fileinput:function(){var eL=document.createElement("input");eL.setAttribute("type","file");return !eL.disabled}};return function(eM){var eL=[].slice.call(arguments);eL.shift();return eI.typeOf(eK[eM])==="function"?eK[eM].apply(this,eL):!!eK[eM]}}());var eC={can:eF,browser:eH(eE),version:eJ(navigator.userAgent)||eJ(navigator.appVersion),OS:eH(eG),swf_url:"../flash/Moxie.swf",xap_url:"../silverlight/Moxie.xap",global_event_dispatcher:"moxie.core.EventTarget.instance.dispatchEvent"};return eC});eB("moxie/core/utils/Dom",["moxie/core/utils/Env"],function(eD){var eE=function(eK){if(typeof eK!=="string"){return eK}return document.getElementById(eK)};var eF=function(eM,eL){var eK;if(eM.className===""){return false}eK=new RegExp("(^|\\s+)"+eL+"(\\s+|$)");return eK.test(eM.className)};var eG=function(eL,eK){if(!eF(eL,eK)){eL.className=eL.className===""?eK:eL.className.replace(/\s+$/,"")+" "+eK}};var eJ=function(eM,eL){var eK=new RegExp("(^|\\s+)"+eL+"(\\s+|$)");eM.className=eM.className.replace(eK,function(eO,eN,eP){return eN===" "&&eP===" "?" ":""})};var eC=function(eL,eK){if(eL.currentStyle){return eL.currentStyle[eK]}else{if(window.getComputedStyle){return window.getComputedStyle(eL,null)[eK]}}};var eI=function(eL,eP){var eQ=0,eO=0,eS,eR=document,eM,eN;eL=eL;eP=eP||eR.body;function eK(eW){var eU,eV,eT=0,eX=0;if(eW){eV=eW.getBoundingClientRect();eU=eR.compatMode==="CSS1Compat"?eR.documentElement:eR.body;eT=eV.left+eU.scrollLeft;eX=eV.top+eU.scrollTop}return{x:eT,y:eX}}if(eL&&eL.getBoundingClientRect&&eD.browser==="IE"&&(!eR.documentMode||eR.documentMode<8)){eM=eK(eL);eN=eK(eP);return{x:eM.x-eN.x,y:eM.y-eN.y}}eS=eL;while(eS&&eS!=eP&&eS.nodeType){eQ+=eS.offsetLeft||0;eO+=eS.offsetTop||0;eS=eS.offsetParent}eS=eL.parentNode;while(eS&&eS!=eP&&eS.nodeType){eQ-=eS.scrollLeft||0;eO-=eS.scrollTop||0;eS=eS.parentNode}return{x:eQ,y:eO}};var eH=function(eK){return{w:eK.offsetWidth||eK.clientWidth,h:eK.offsetHeight||eK.clientHeight}};return{get:eE,hasClass:eF,addClass:eG,removeClass:eJ,getStyle:eC,getPos:eI,getSize:eH}});eB("moxie/core/Exceptions",["moxie/core/utils/Basic"],function(eD){function eC(eG,eF){var eE;for(eE in eG){if(eG[eE]===eF){return eE}}return null}return{RuntimeError:(function(){var eE={NOT_INIT_ERR:1,NOT_SUPPORTED_ERR:9,JS_ERR:4};function eF(eG){this.code=eG;this.name=eC(eE,eG);this.message=this.name+": RuntimeError "+this.code}eD.extend(eF,eE);eF.prototype=Error.prototype;return eF}()),OperationNotAllowedException:(function(){function eE(eF){this.code=eF;this.name="OperationNotAllowedException"}eD.extend(eE,{NOT_ALLOWED_ERR:1});eE.prototype=Error.prototype;return eE}()),ImageError:(function(){var eE={WRONG_FORMAT:1,MAX_RESOLUTION_ERR:2};function eF(eG){this.code=eG;this.name=eC(eE,eG);this.message=this.name+": ImageError "+this.code}eD.extend(eF,eE);eF.prototype=Error.prototype;return eF}()),FileException:(function(){var eE={NOT_FOUND_ERR:1,SECURITY_ERR:2,ABORT_ERR:3,NOT_READABLE_ERR:4,ENCODING_ERR:5,NO_MODIFICATION_ALLOWED_ERR:6,INVALID_STATE_ERR:7,SYNTAX_ERR:8};function eF(eG){this.code=eG;this.name=eC(eE,eG);this.message=this.name+": FileException "+this.code}eD.extend(eF,eE);eF.prototype=Error.prototype;return eF}()),DOMException:(function(){var eE={INDEX_SIZE_ERR:1,DOMSTRING_SIZE_ERR:2,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,INVALID_CHARACTER_ERR:5,NO_DATA_ALLOWED_ERR:6,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INUSE_ATTRIBUTE_ERR:10,INVALID_STATE_ERR:11,SYNTAX_ERR:12,INVALID_MODIFICATION_ERR:13,NAMESPACE_ERR:14,INVALID_ACCESS_ERR:15,VALIDATION_ERR:16,TYPE_MISMATCH_ERR:17,SECURITY_ERR:18,NETWORK_ERR:19,ABORT_ERR:20,URL_MISMATCH_ERR:21,QUOTA_EXCEEDED_ERR:22,TIMEOUT_ERR:23,INVALID_NODE_TYPE_ERR:24,DATA_CLONE_ERR:25};function eF(eG){this.code=eG;this.name=eC(eE,eG);this.message=this.name+": DOMException "+this.code}eD.extend(eF,eE);eF.prototype=Error.prototype;return eF}()),EventException:(function(){function eE(eF){this.code=eF;this.name="EventException"}eD.extend(eE,{UNSPECIFIED_EVENT_TYPE_ERR:0});eE.prototype=Error.prototype;return eE}())}});eB("moxie/core/EventTarget",["moxie/core/Exceptions","moxie/core/utils/Basic"],function(eC,eD){function eE(){var eF={};eD.extend(this,{uid:null,init:function(){if(!this.uid){this.uid=eD.guid("uid_")}},addEventListener:function(eK,eJ,eH,eI){var eG=this,eL;eK=eD.trim(eK);if(/\s/.test(eK)){eD.each(eK.split(/\s+/),function(eM){eG.addEventListener(eM,eJ,eH,eI)});return}eK=eK.toLowerCase();eH=parseInt(eH,10)||0;eL=eF[this.uid]&&eF[this.uid][eK]||[];eL.push({fn:eJ,priority:eH,scope:eI||this});if(!eF[this.uid]){eF[this.uid]={}}eF[this.uid][eK]=eL},hasEventListener:function(eG){return eG?!!(eF[this.uid]&&eF[this.uid][eG]):!!eF[this.uid]},removeEventListener:function(eI,eH){eI=eI.toLowerCase();var eJ=eF[this.uid]&&eF[this.uid][eI],eG;if(eJ){if(eH){for(eG=eJ.length-1;eG>=0;eG--){if(eJ[eG].fn===eH){eJ.splice(eG,1);break}}}else{eJ=[]}if(!eJ.length){delete eF[this.uid][eI];if(eD.isEmptyObj(eF[this.uid])){delete eF[this.uid]}}}},removeAllEventListeners:function(){if(eF[this.uid]){delete eF[this.uid]}},dispatchEvent:function(eM){var eL,eN,eK,eJ,eI={},eH=true;if(eD.typeOf(eM)!=="string"){eJ=eM;if(eD.typeOf(eJ.type)==="string"){eM=eJ.type;if(eJ.total&&eJ.loaded){eI.total=eJ.total;eI.loaded=eJ.loaded}eI.async=eJ.async||false}else{throw new eC.EventException(eC.EventException.UNSPECIFIED_EVENT_TYPE_ERR)}}if(eM.indexOf("::")!==-1){(function(eO){eL=eO[0];eM=eO[1]}(eM.split("::")))}else{eL=this.uid}eM=eM.toLowerCase();eN=eF[eL]&&eF[eL][eM];if(eN){eN.sort(function(eP,eO){return eO.priority-eP.priority});eK=[].slice.call(arguments);eK.shift();eI.type=eM;eK.unshift(eI);var eG=[];eD.each(eN,function(eO){eK[0].target=eO.scope;if(eI.async){eG.push(function(eP){setTimeout(function(){eP(eO.fn.apply(eO.scope,eK)===false)},1)})}else{eG.push(function(eP){eP(eO.fn.apply(eO.scope,eK)===false)})}});if(eG.length){eD.inSeries(eG,function(eO){eH=!eO})}}return eH},bind:function(){this.addEventListener.apply(this,arguments)},unbind:function(){this.removeEventListener.apply(this,arguments)},unbindAll:function(){this.removeAllEventListeners.apply(this,arguments)},trigger:function(){return this.dispatchEvent.apply(this,arguments)},convertEventPropsToHandlers:function(eG){var eI;if(eD.typeOf(eG)!=="array"){eG=[eG]}for(var eH=0;eH<eG.length;eH++){eI="on"+eG[eH];if(eD.typeOf(this[eI])==="function"){this.addEventListener(eG[eH],this[eI])}else{if(eD.typeOf(this[eI])==="undefined"){this[eI]=null}}}}})}eE.instance=new eE();return eE});eB("moxie/core/utils/Encode",[],function(){var eE=function(eG){return unescape(encodeURIComponent(eG))};var eF=function(eG){return decodeURIComponent(escape(eG))};var eD=function(eN,eS){if(typeof(window.atob)==="function"){return eS?eF(window.atob(eN)):window.atob(eN)}var eJ="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var eI,eH,eG,eR,eQ,eP,eO,eT,eM=0,eU=0,eK="",eL=[];if(!eN){return eN}eN+="";do{eR=eJ.indexOf(eN.charAt(eM++));eQ=eJ.indexOf(eN.charAt(eM++));eP=eJ.indexOf(eN.charAt(eM++));eO=eJ.indexOf(eN.charAt(eM++));eT=eR<<18|eQ<<12|eP<<6|eO;eI=eT>>16&255;eH=eT>>8&255;eG=eT&255;if(eP==64){eL[eU++]=String.fromCharCode(eI)}else{if(eO==64){eL[eU++]=String.fromCharCode(eI,eH)}else{eL[eU++]=String.fromCharCode(eI,eH,eG)}}}while(eM<eN.length);eK=eL.join("");return eS?eF(eK):eK};var eC=function(eO,eT){if(eT){eE(eO)}if(typeof(window.btoa)==="function"){return window.btoa(eO)}var eK="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var eJ,eI,eH,eS,eR,eQ,eP,eU,eN=0,eV=0,eM="",eL=[];if(!eO){return eO}do{eJ=eO.charCodeAt(eN++);eI=eO.charCodeAt(eN++);eH=eO.charCodeAt(eN++);eU=eJ<<16|eI<<8|eH;eS=eU>>18&63;eR=eU>>12&63;eQ=eU>>6&63;eP=eU&63;eL[eV++]=eK.charAt(eS)+eK.charAt(eR)+eK.charAt(eQ)+eK.charAt(eP)}while(eN<eO.length);eM=eL.join("");var eG=eO.length%3;return(eG?eM.slice(0,eG-3):eM)+"===".slice(eG||3)};return{utf8_encode:eE,utf8_decode:eF,atob:eD,btoa:eC}});eB("moxie/runtime/Runtime",["moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/EventTarget"],function(eG,eF,eH){var eC={},eD={};function eE(eQ,eN,eL,eJ,eM){var eP=this,eI,eO=eG.guid(eN+"_");function eK(eR,eS){var eU=null,eT=eQ&&eQ.required_caps;eS=eS||"browser";if(this.mode!==null){return this.mode}if(eT&&!eG.isEmptyObj(eR)){eG.each(eT,function(eX,eV){if(eR.hasOwnProperty(eV)){var eW=eR[eV](eX);if(typeof(eW)==="string"){eW=[eW]}if(!eU){eU=eW}else{if(!(eU=eG.arrayIntersect(eU,eW))){return(eU=false)}}}});if(eU){this.mode=eG.inArray(eS,eU)!==-1?eS:eU[0]}else{if(eU===false){this.mode=false}}}if(this.mode===null){this.mode=eS}if(this.mode&&eT&&!this.can(eT)){this.mode=false}}eD[eO]=this;eL=eG.extend({access_binary:false,access_image_binary:false,display_media:false,do_cors:false,drag_and_drop:false,filter_by_extension:true,resize_image:false,report_upload_progress:false,return_response_headers:false,return_response_type:false,return_status_code:true,send_custom_headers:false,select_file:false,select_folder:false,select_multiple:true,send_binary_string:false,send_browser_cookies:true,send_multipart:true,slice_blob:false,stream_upload:false,summon_file_dialog:false,upload_filesize:true,use_http_method:true},eL);eI=(function(){var eR={};return{exec:function(eU,eS,eV,eT){if(eI[eS]){if(!eR[eU]){eR[eU]={context:this,instance:new eI[eS]()}}if(eR[eU].instance[eV]){return eR[eU].instance[eV].apply(this,eT)}}},removeInstance:function(eS){delete eR[eS]},removeAllInstances:function(){var eS=this;eG.each(eR,function(eU,eT){if(eG.typeOf(eU.instance.destroy)==="function"){eU.instance.destroy.call(eU.context)}eS.removeInstance(eT)})}}}());eG.extend(this,{initialized:false,uid:eO,type:eN,mode:null,shimid:eO+"_container",clients:0,options:eQ,can:function(eT,eU){var eR=arguments[2]||eL;if(eG.typeOf(eT)==="string"&&eG.typeOf(eU)==="undefined"){eT=eE.parseCaps(eT)}if(eG.typeOf(eT)==="object"){for(var eS in eT){if(!this.can(eS,eT[eS],eR)){return false}}return true}if(eG.typeOf(eR[eT])==="function"){return eR[eT].call(this,eU)}else{return(eU===eR[eT])}},getShimContainer:function(){var eR,eS=eF.get(this.shimid);if(!eS){eR=this.options.container?eF.get(this.options.container):document.body;eS=document.createElement("div");eS.id=this.shimid;eS.className="moxie-shim moxie-shim-"+this.type;eG.extend(eS.style,{position:"absolute",top:"0px",left:"0px",width:"1px",height:"1px",overflow:"hidden"});eR.appendChild(eS);eR=null}return eS},getShim:function(){return eI},shimExec:function(eS,eT){var eR=[].slice.call(arguments,2);return eP.getShim().exec.call(this,this.uid,eS,eT,eR)},exec:function(eS,eT){var eR=[].slice.call(arguments,2);if(eP[eS]&&eP[eS][eT]){return eP[eS][eT].apply(this,eR)}return eP.shimExec.apply(this,arguments)},destroy:function(){if(!eP){return}var eR=eF.get(this.shimid);if(eR){eR.parentNode.removeChild(eR)}if(eI){eI.removeAllInstances()}this.unbindAll();delete eD[this.uid];this.uid=null;eO=eP=eI=eR=null}});eK.call(this,eJ,eM)}eE.order="html5,flash,silverlight,html4";eE.getRuntime=function(eI){return eD[eI]?eD[eI]:false};eE.addConstructor=function(eJ,eI){eI.prototype=eH.instance;eC[eJ]=eI};eE.getConstructor=function(eI){return eC[eI]||null};eE.getInfo=function(eI){var eJ=eE.getRuntime(eI);if(eJ){return{uid:eJ.uid,type:eJ.type,can:function(){return eJ.can.apply(eJ,arguments)}}}return null};eE.parseCaps=function(eI){var eJ={};if(eG.typeOf(eI)!=="string"){return eI||{}}eG.each(eI.split(","),function(eK){eJ[eK]=true});return eJ};eE.can=function(eJ,eL){var eK,eI=eE.getConstructor(eJ),eM;if(eI){eK=new eI({required_caps:eL});eM=eK.mode;eK.destroy();return !!eM}return false};eE.thatCan=function(eK,eL){var eJ=(eL||eE.order).split(/\s*,\s*/);for(var eI in eJ){if(eE.can(eJ[eI],eK)){return eJ[eI]}}return null};eE.capTrue=function(){return true};eE.capFalse=function(){return false};eE.capTest=function(eI){return function(){return !!eI}};return eE});eB("moxie/runtime/RuntimeClient",["moxie/core/Exceptions","moxie/core/utils/Basic","moxie/runtime/Runtime"],function(eC,eF,eE){return function eD(){var eG;eF.extend(this,{connectRuntime:function(eK){var eI=this,eJ;function eH(eL){var eN,eM;if(!eL.length){eI.trigger("RuntimeError",new eC.RuntimeError(eC.RuntimeError.NOT_INIT_ERR));eG=null;return}eN=eL.shift();eM=eE.getConstructor(eN);if(!eM){eH(eL);return}eG=new eM(eK);eG.bind("Init",function(){eG.initialized=true;setTimeout(function(){eG.clients++;eI.trigger("RuntimeInit",eG)},1)});eG.bind("Error",function(){eG.destroy();eH(eL)});if(!eG.mode){eG.trigger("Error");return}eG.init()}if(eF.typeOf(eK)==="string"){eJ=eK}else{if(eF.typeOf(eK.ruid)==="string"){eJ=eK.ruid}}if(eJ){eG=eE.getRuntime(eJ);if(eG){eG.clients++;return eG}else{throw new eC.RuntimeError(eC.RuntimeError.NOT_INIT_ERR)}}eH((eK.runtime_order||eE.order).split(/\s*,\s*/))},getRuntime:function(){if(eG&&eG.uid){return eG}eG=null;return null},disconnectRuntime:function(){if(eG&&--eG.clients<=0){eG.destroy();eG=null}}})}});eB("moxie/file/Blob",["moxie/core/utils/Basic","moxie/core/utils/Encode","moxie/runtime/RuntimeClient"],function(eF,eD,eE){var eC={};function eG(eJ,eI){function eH(eO,eK,eM){var eL,eN=eC[this.uid];if(eF.typeOf(eN)!=="string"||!eN.length){return null}eL=new eG(null,{type:eM,size:eK-eO});eL.detach(eN.substr(eO,eL.size));return eL}eE.call(this);if(eJ){this.connectRuntime(eJ)}if(!eI){eI={}}else{if(eF.typeOf(eI)==="string"){eI={data:eI}}}eF.extend(this,{uid:eI.uid||eF.guid("uid_"),ruid:eJ,size:eI.size||0,type:eI.type||"",slice:function(eM,eK,eL){if(this.isDetached()){return eH.apply(this,arguments)}return this.getRuntime().exec.call(this,"Blob","slice",this.getSource(),eM,eK,eL)},getSource:function(){if(!eC[this.uid]){return null}return eC[this.uid]},detach:function(eL){if(this.ruid){this.getRuntime().exec.call(this,"Blob","destroy",eC[this.uid]);this.disconnectRuntime();this.ruid=null}eL=eL||"";var eK=eL.match(/^data:([^;]*);base64,/);if(eK){this.type=eK[1];eL=eD.atob(eL.substring(eL.indexOf("base64,")+7))}this.size=eL.length;eC[this.uid]=eL},isDetached:function(){return !this.ruid&&eF.typeOf(eC[this.uid])==="string"},destroy:function(){this.detach();delete eC[this.uid]}});if(eI.data){this.detach(eI.data)}else{eC[this.uid]=eI}}return eG});eB("moxie/file/File",["moxie/core/utils/Basic","moxie/core/utils/Mime","moxie/file/Blob"],function(eE,eD,eF){function eC(eH,eI){var eG,eJ;if(!eI){eI={}}if(eI.type&&eI.type!==""){eJ=eI.type}else{eJ=eD.getFileMime(eI.name)}if(eI.name){eG=eI.name.replace(/\\/g,"/");eG=eG.substr(eG.lastIndexOf("/")+1)}else{var eK=eJ.split("/")[0];eG=eE.guid((eK!==""?eK:"file")+"_");if(eD.extensions[eJ]){eG+="."+eD.extensions[eJ][0]}}eF.apply(this,arguments);eE.extend(this,{type:eJ||"",name:eG||eE.guid("file_"),lastModifiedDate:eI.lastModifiedDate||(new Date()).toLocaleString()})}eC.prototype=eF.prototype;return eC});eB("moxie/file/FileInput",["moxie/core/utils/Basic","moxie/core/utils/Mime","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/core/EventTarget","moxie/core/I18n","moxie/file/File","moxie/runtime/Runtime","moxie/runtime/RuntimeClient"],function(eD,eG,eF,eK,eM,eE,eI,eC,eJ){var eL=["ready","change","cancel","mouseenter","mouseleave","mousedown","mouseup"];function eH(eQ){var eO=this,eN,eP,eR;if(eD.inArray(eD.typeOf(eQ),["string","node"])!==-1){eQ={browse_button:eQ}}eP=eF.get(eQ.browse_button);if(!eP){throw new eK.DOMException(eK.DOMException.NOT_FOUND_ERR)}eR={accept:[{title:eE.translate("All Files"),extensions:"*"}],name:"file",multiple:false,required_caps:false,container:eP.parentNode||document.body};eQ=eD.extend({},eR,eQ);if(typeof(eQ.required_caps)==="string"){eQ.required_caps=eC.parseCaps(eQ.required_caps)}if(typeof(eQ.accept)==="string"){eQ.accept=eG.mimes2extList(eQ.accept)}eN=eF.get(eQ.container);if(!eN){eN=document.body}if(eF.getStyle(eN,"position")==="static"){eN.style.position="relative"}eN=eP=null;eJ.call(eO);eD.extend(eO,{uid:eD.guid("uid_"),ruid:null,files:null,init:function(){eO.convertEventPropsToHandlers(eL);eO.bind("RuntimeInit",function(eT,eS){eO.ruid=eS.uid;eO.bind("Ready",function(){eO.trigger("Refresh")},999);eO.bind("Change",function(){var eU=eS.exec.call(eO,"FileInput","getFiles");eO.files=[];eD.each(eU,function(eV){if(eV.size===0){return true}eO.files.push(new eI(eO.ruid,eV))})},999);eO.bind("Refresh",function(){var eX,eW,eV,eU;eV=eF.get(eQ.browse_button);eU=eF.get(eS.shimid);if(eV){eX=eF.getPos(eV,eF.get(eQ.container));eW=eF.getSize(eV);if(eU){eD.extend(eU.style,{top:eX.y+"px",left:eX.x+"px",width:eW.w+"px",height:eW.h+"px"})}}eU=eV=null});eS.exec.call(eO,"FileInput","init",eQ)});eO.connectRuntime(eD.extend({},eQ,{required_caps:{select_file:true}}))},disable:function(eT){var eS=this.getRuntime();if(eS){eS.exec.call(this,"FileInput","disable",eD.typeOf(eT)==="undefined"?true:eT)}},refresh:function(){eO.trigger("Refresh")},destroy:function(){var eS=this.getRuntime();if(eS){eS.exec.call(this,"FileInput","destroy");this.disconnectRuntime()}if(eD.typeOf(this.files)==="array"){eD.each(this.files,function(eT){eT.destroy()})}this.files=null}})}eH.prototype=eM.instance;return eH});eB("moxie/file/FileDrop",["moxie/core/I18n","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/core/utils/Basic","moxie/file/File","moxie/runtime/RuntimeClient","moxie/core/EventTarget","moxie/core/utils/Mime"],function(eE,eF,eJ,eC,eH,eI,eL,eG){var eK=["ready","dragenter","dragleave","drop","error"];function eD(eN){var eM=this,eO;if(typeof(eN)==="string"){eN={drop_zone:eN}}eO={accept:[{title:eE.translate("All Files"),extensions:"*"}],required_caps:{drag_and_drop:true}};eN=typeof(eN)==="object"?eC.extend({},eO,eN):eO;eN.container=eF.get(eN.drop_zone)||document.body;if(eF.getStyle(eN.container,"position")==="static"){eN.container.style.position="relative"}if(typeof(eN.accept)==="string"){eN.accept=eG.mimes2extList(eN.accept)}eI.call(eM);eC.extend(eM,{uid:eC.guid("uid_"),ruid:null,files:null,init:function(){eM.convertEventPropsToHandlers(eK);eM.bind("RuntimeInit",function(eQ,eP){eM.ruid=eP.uid;eM.bind("Drop",function(){var eR=eP.exec.call(eM,"FileDrop","getFiles");eM.files=[];eC.each(eR,function(eS){eM.files.push(new eH(eM.ruid,eS))})},999);eP.exec.call(eM,"FileDrop","init",eN);eM.dispatchEvent("ready")});eM.connectRuntime(eN)},destroy:function(){var eP=this.getRuntime();if(eP){eP.exec.call(this,"FileDrop","destroy");this.disconnectRuntime()}this.files=null}})}eD.prototype=eL.instance;return eD});eB("moxie/runtime/RuntimeTarget",["moxie/core/utils/Basic","moxie/runtime/RuntimeClient","moxie/core/EventTarget"],function(eE,eD,eF){function eC(){this.uid=eE.guid("uid_");eD.call(this);this.destroy=function(){this.disconnectRuntime();this.unbindAll()}}eC.prototype=eF.instance;return eC});eB("moxie/file/FileReader",["moxie/core/utils/Basic","moxie/core/utils/Encode","moxie/core/Exceptions","moxie/core/EventTarget","moxie/file/Blob","moxie/file/File","moxie/runtime/RuntimeTarget"],function(eC,eG,eI,eK,eF,eH,eE){var eJ=["loadstart","progress","load","abort","error","loadend"];function eD(){var eL=this,eN;eC.extend(this,{uid:eC.guid("uid_"),readyState:eD.EMPTY,result:null,error:null,readAsBinaryString:function(eO){eM.call(this,"readAsBinaryString",eO)},readAsDataURL:function(eO){eM.call(this,"readAsDataURL",eO)},readAsText:function(eO){eM.call(this,"readAsText",eO)},abort:function(){this.result=null;if(eC.inArray(this.readyState,[eD.EMPTY,eD.DONE])!==-1){return}else{if(this.readyState===eD.LOADING){this.readyState=eD.DONE}}if(eN){eN.getRuntime().exec.call(this,"FileReader","abort")}this.trigger("abort");this.trigger("loadend")},destroy:function(){this.abort();if(eN){eN.getRuntime().exec.call(this,"FileReader","destroy");eN.disconnectRuntime()}eL=eN=null}});function eM(eT,eP){eN=new eE();function eR(eU){eL.readyState=eD.DONE;eL.error=eU;eL.trigger("error");eQ()}function eQ(){eN.destroy();eN=null;eL.trigger("loadend")}function eO(eU){eN.bind("Error",function(eW,eV){eR(eV)});eN.bind("Progress",function(eV){eL.result=eU.exec.call(eN,"FileReader","getResult");eL.trigger(eV)});eN.bind("Load",function(eV){eL.readyState=eD.DONE;eL.result=eU.exec.call(eN,"FileReader","getResult");eL.trigger(eV);eQ()});eU.exec.call(eN,"FileReader","read",eT,eP)}this.convertEventPropsToHandlers(eJ);if(this.readyState===eD.LOADING){return eR(new eI.DOMException(eI.DOMException.INVALID_STATE_ERR))}this.readyState=eD.LOADING;this.trigger("loadstart");if(eP instanceof eF){if(eP.isDetached()){var eS=eP.getSource();switch(eT){case"readAsText":case"readAsBinaryString":this.result=eS;break;case"readAsDataURL":this.result="data:"+eP.type+";base64,"+eG.btoa(eS);break}this.readyState=eD.DONE;this.trigger("load");eQ()}else{eO(eN.connectRuntime(eP.ruid))}}else{eR(new eI.DOMException(eI.DOMException.NOT_FOUND_ERR))}}}eD.EMPTY=0;eD.LOADING=1;eD.DONE=2;eD.prototype=eK.instance;return eD});eB("moxie/core/utils/Url",[],function(){var eC=function(eL){var eH=["source","scheme","authority","userInfo","user","pass","host","port","relative","path","directory","file","query","fragment"],eG=eH.length,eM={http:80,https:443},eJ={},eI=/^(?:([^:\/?#]+):)?(?:\/\/()(?:(?:()(?:([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?()(?:(()(?:(?:[^?#\/]*\/)*)()(?:[^?#]*))(?:\\?([^#]*))?(?:#(.*))?)/,eF=eI.exec(eL||"");while(eG--){if(eF[eG]){eJ[eH[eG]]=eF[eG]}}if(/^[^\/]/.test(eJ.path)&&!eJ.scheme){var eK=document.location.pathname;if(!/(\/|\/[^\.]+)$/.test(eK)){eK=eK.replace(/[^\/]+$/,"")}eJ.host=document.location.hostname;eJ.path=eK+(eJ.path||"")}if(!eJ.scheme){eJ.scheme=document.location.protocol.replace(/:$/,"")}if(!eJ.host){eJ.host=document.location.hostname}if(!eJ.port){eJ.port=document.location.port||eM[eJ.scheme]||80}eJ.port=parseInt(eJ.port,10);if(!eJ.path){eJ.path="/"}delete eJ.source;return eJ};var eE=function(eG){var eH={http:80,https:443},eF=eC(eG);return eF.scheme+"://"+eF.host+(eF.port!==eH[eF.scheme]?":"+eF.port:"")+eF.path+(eF.query?eF.query:"")};var eD=function(eG){function eF(eH){return[eH.scheme,eH.host,eH.port].join("/")}if(typeof eG==="string"){eG=eC(eG)}return eF(eC())===eF(eG)};return{parseUrl:eC,resolveUrl:eE,hasSameOrigin:eD}});eB("moxie/file/FileReaderSync",["moxie/core/utils/Basic","moxie/runtime/RuntimeClient","moxie/core/utils/Encode"],function(eE,eD,eC){return function(){eD.call(this);eE.extend(this,{uid:eE.guid("uid_"),readAsBinaryString:function(eG){return eF.call(this,"readAsBinaryString",eG)},readAsDataURL:function(eG){return eF.call(this,"readAsDataURL",eG)},readAsText:function(eG){return eF.call(this,"readAsText",eG)}});function eF(eM,eI){if(eI.isDetached()){var eL=eI.getSource();switch(eM){case"readAsBinaryString":return eL;case"readAsDataURL":return"data:"+eI.type+";base64,"+eC.btoa(eL);case"readAsText":var eH="";for(var eJ=0,eK=eL.length;eJ<eK;eJ++){eH+=String.fromCharCode(eL[eJ])}return eH}}else{var eG=this.connectRuntime(eI.ruid).exec.call(this,"FileReaderSync","read",eM,eI);this.disconnectRuntime();return eG}}}});eB("moxie/xhr/FormData",["moxie/core/Exceptions","moxie/core/utils/Basic","moxie/file/Blob"],function(eC,eD,eF){function eE(){var eH,eI={},eG="";eD.extend(this,{append:function(eK,eL){var eJ=this,eM=eD.typeOf(eL);if(eL instanceof eF){if(eH){delete eI[eH]}eH=eK;eI[eK]=[eL]}else{if("array"===eM){eK+="[]";eD.each(eL,function(eN){eJ.append.call(eJ,eK,eN)})}else{if("object"===eM){eD.each(eL,function(eO,eN){eJ.append.call(eJ,eK+"["+eN+"]",eO)})}else{eL=eL.toString();if(!eI[eK]){eI[eK]=[]}eI[eK].push(eL)}}}},hasBlob:function(){return !!eH},getBlob:function(){return eI[eH]&&eI[eH][0]||null},getBlobName:function(){return eH||null},each:function(eJ){eD.each(eI,function(eL,eK){eD.each(eL,function(eM){eJ(eM,eK)})})},destroy:function(){eH=null;eG="";eI={}}})}return eE});eB("moxie/xhr/XMLHttpRequest",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/core/EventTarget","moxie/core/utils/Encode","moxie/core/utils/Url","moxie/runtime/Runtime","moxie/runtime/RuntimeTarget","moxie/file/Blob","moxie/file/FileReaderSync","moxie/xhr/FormData","moxie/core/utils/Env","moxie/core/utils/Mime"],function(eK,eL,eJ,eR,eO,eI,eM,eH,eQ,eS,eC,eN){var eD={100:"Continue",101:"Switching Protocols",102:"Processing",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",226:"IM Used",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",306:"Reserved",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",426:"Upgrade Required",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",510:"Not Extended"};function eG(){this.uid=eK.guid("uid_")}eG.prototype=eJ.instance;var eF=["loadstart","progress","abort","error","load","timeout","loadend"];var eE=1,eT=2;function eP(){var fb=this,eY={timeout:0,readyState:eP.UNSENT,withCredentials:false,status:0,statusText:"",responseType:"",responseXML:null,responseText:null,response:null},fh=true,e3,e9,fa={},fc,e0,e2=null,e4=null,fk=false,eV=false,eU=false,e5=false,eX=false,e1=false,e7,fg,ff=null,fi=null,fd={},e8,fe="",eW;eK.extend(this,eY,{uid:eK.guid("uid_"),upload:new eG(),open:function(fq,fo,fp,fm,fn){var fl;if(!fq||!fo){throw new eL.DOMException(eL.DOMException.SYNTAX_ERR)}if(/[\u0100-\uffff]/.test(fq)||eR.utf8_encode(fq)!==fq){throw new eL.DOMException(eL.DOMException.SYNTAX_ERR)}if(!!~eK.inArray(fq.toUpperCase(),["CONNECT","DELETE","GET","HEAD","OPTIONS","POST","PUT","TRACE","TRACK"])){e9=fq.toUpperCase()}if(!!~eK.inArray(e9,["CONNECT","TRACE","TRACK"])){throw new eL.DOMException(eL.DOMException.SECURITY_ERR)}fo=eR.utf8_encode(fo);fl=eO.parseUrl(fo);e1=eO.hasSameOrigin(fl);e3=eO.resolveUrl(fo);if((fm||fn)&&!e1){throw new eL.DOMException(eL.DOMException.INVALID_ACCESS_ERR)}fc=fm||fl.user;e0=fn||fl.pass;fh=fp||true;if(fh===false&&(fj("timeout")||fj("withCredentials")||fj("responseType")!=="")){throw new eL.DOMException(eL.DOMException.INVALID_ACCESS_ERR)}fk=!fh;eV=false;fa={};e6.call(this);fj("readyState",eP.OPENED);this.convertEventPropsToHandlers(["readystatechange"]);this.dispatchEvent("readystatechange")},setRequestHeader:function(fn,fm){var fl=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","cookie","cookie2","content-transfer-encoding","date","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","user-agent","via"];if(fj("readyState")!==eP.OPENED||eV){throw new eL.DOMException(eL.DOMException.INVALID_STATE_ERR)}if(/[\u0100-\uffff]/.test(fn)||eR.utf8_encode(fn)!==fn){throw new eL.DOMException(eL.DOMException.SYNTAX_ERR)}fn=eK.trim(fn).toLowerCase();if(!!~eK.inArray(fn,fl)||/^(proxy\-|sec\-)/.test(fn)){return false}if(!fa[fn]){fa[fn]=fm}else{fa[fn]+=", "+fm}return true},getAllResponseHeaders:function(){return fe||""},getResponseHeader:function(fl){fl=fl.toLowerCase();if(eX||!!~eK.inArray(fl,["set-cookie","set-cookie2"])){return null}if(fe&&fe!==""){if(!eW){eW={};eK.each(fe.split(/\r\n/),function(fm){var fn=fm.split(/:\s+/);if(fn.length===2){fn[0]=eK.trim(fn[0]);eW[fn[0].toLowerCase()]={header:fn[0],value:eK.trim(fn[1])}}})}if(eW.hasOwnProperty(fl)){return eW[fl].header+": "+eW[fl].value}}return null},overrideMimeType:function(fm){var fl,fn;if(!!~eK.inArray(fj("readyState"),[eP.LOADING,eP.DONE])){throw new eL.DOMException(eL.DOMException.INVALID_STATE_ERR)}fm=eK.trim(fm.toLowerCase());if(/;/.test(fm)&&(fl=fm.match(/^([^;]+)(?:;\scharset\=)?(.*)$/))){fm=fl[1];if(fl[2]){fn=fl[2]}}if(!eN.mimes[fm]){throw new eL.DOMException(eL.DOMException.SYNTAX_ERR)}ff=fm;fi=fn},send:function(fn,fm){if(eK.typeOf(fm)==="string"){fd={ruid:fm}}else{if(!fm){fd={}}else{fd=fm}}this.convertEventPropsToHandlers(eF);this.upload.convertEventPropsToHandlers(eF);if(this.readyState!==eP.OPENED||eV){throw new eL.DOMException(eL.DOMException.INVALID_STATE_ERR)}if(fn instanceof eH){fd.ruid=fn.ruid;e4=fn.type||"application/octet-stream"}else{if(fn instanceof eS){if(fn.hasBlob()){var fl=fn.getBlob();fd.ruid=fl.ruid;e4=fl.type||"application/octet-stream"}}else{if(typeof fn==="string"){e2="UTF-8";e4="text/plain;charset=UTF-8";fn=eR.utf8_encode(fn)}}}if(!this.withCredentials){this.withCredentials=(fd.required_caps&&fd.required_caps.send_browser_cookies)&&!e1}eU=(!fk&&this.upload.hasEventListener());eX=false;e5=!fn;if(!fk){eV=true;if(!e5){}}eZ.call(this,fn)},abort:function(){eX=true;fk=false;if(!~eK.inArray(fj("readyState"),[eP.UNSENT,eP.OPENED,eP.DONE])){fj("readyState",eP.DONE);eV=false;if(e8){e8.getRuntime().exec.call(e8,"XMLHttpRequest","abort",e5)}else{throw new eL.DOMException(eL.DOMException.INVALID_STATE_ERR)}e5=true}else{fj("readyState",eP.UNSENT)}},destroy:function(){if(e8){if(eK.typeOf(e8.destroy)==="function"){e8.destroy()}e8=null}this.unbindAll();if(this.upload){this.upload.unbindAll();this.upload=null}}});function fj(fm,fl){if(!eY.hasOwnProperty(fm)){return}if(arguments.length===1){return eC.can("define_property")?eY[fm]:fb[fm]}else{if(eC.can("define_property")){eY[fm]=fl}else{fb[fm]=fl}}}function eZ(fo){var fm=this;e7=new Date().getTime();e8=new eM();function fn(){e8.destroy();e8=null;fm.dispatchEvent("loadend");fm=null}function fl(fp){e8.bind("LoadStart",function(fq){fj("readyState",eP.LOADING);fm.dispatchEvent("readystatechange");fm.dispatchEvent(fq);if(eU){fm.upload.dispatchEvent(fq)}});e8.bind("Progress",function(fq){if(fj("readyState")!==eP.LOADING){fj("readyState",eP.LOADING);fm.dispatchEvent("readystatechange")}fm.dispatchEvent(fq)});e8.bind("UploadProgress",function(fq){if(eU){fm.upload.dispatchEvent({type:"progress",lengthComputable:false,total:fq.total,loaded:fq.loaded})}});e8.bind("Load",function(fq){fj("readyState",eP.DONE);fj("status",Number(fp.exec.call(e8,"XMLHttpRequest","getStatus")||0));fj("statusText",eD[fj("status")]||"");fj("response",fp.exec.call(e8,"XMLHttpRequest","getResponse",fj("responseType")));if(!!~eK.inArray(fj("responseType"),["text",""])){fj("responseText",fj("response"))}else{if(fj("responseType")==="document"){fj("responseXML",fj("response"))}}fe=fp.exec.call(e8,"XMLHttpRequest","getAllResponseHeaders");fm.dispatchEvent("readystatechange");if(fj("status")>0){if(eU){fm.upload.dispatchEvent(fq)}fm.dispatchEvent(fq)}else{eX=true;fm.dispatchEvent("error")}fn()});e8.bind("Abort",function(fq){fm.dispatchEvent(fq);fn()});e8.bind("Error",function(fq){eX=true;fj("readyState",eP.DONE);fm.dispatchEvent("readystatechange");e5=true;fm.dispatchEvent(fq);fn()});fp.exec.call(e8,"XMLHttpRequest","send",{url:e3,method:e9,async:fh,user:fc,password:e0,headers:fa,mimeType:e4,encoding:e2,responseType:fm.responseType,withCredentials:fm.withCredentials,options:fd},fo)}if(typeof(fd.required_caps)==="string"){fd.required_caps=eI.parseCaps(fd.required_caps)}fd.required_caps=eK.extend({},fd.required_caps,{return_response_type:fm.responseType});if(fo instanceof eS){fd.required_caps.send_multipart=true}if(!e1){fd.required_caps.do_cors=true}if(fd.ruid){fl(e8.connectRuntime(fd))}else{e8.bind("RuntimeInit",function(fq,fp){fl(fp)});e8.bind("RuntimeError",function(fq,fp){fm.dispatchEvent("RuntimeError",fp)});e8.connectRuntime(fd)}}function e6(){fj("responseText","");fj("responseXML",null);fj("response",null);fj("status",0);fj("statusText","");e7=fg=null}}eP.UNSENT=0;eP.OPENED=1;eP.HEADERS_RECEIVED=2;eP.LOADING=3;eP.DONE=4;eP.prototype=eJ.instance;return eP});eB("moxie/runtime/Transporter",["moxie/core/utils/Basic","moxie/core/utils/Encode","moxie/runtime/RuntimeClient","moxie/core/EventTarget"],function(eF,eC,eD,eG){function eE(){var eL,eJ,eH,eM,eP,eO;eD.call(this);eF.extend(this,{uid:eF.guid("uid_"),state:eE.IDLE,result:null,transport:function(eU,eT,eS){var eR=this;eS=eF.extend({chunk_size:204798},eS);if((eL=eS.chunk_size%3)){eS.chunk_size+=3-eL}eO=eS.chunk_size;eN.call(this);eH=eU;eM=eU.length;if(eF.typeOf(eS)==="string"||eS.ruid){eK.call(eR,eT,this.connectRuntime(eS))}else{var eQ=function(eW,eV){eR.unbind("RuntimeInit",eQ);eK.call(eR,eT,eV)};this.bind("RuntimeInit",eQ);this.connectRuntime(eS)}},abort:function(){var eQ=this;eQ.state=eE.IDLE;if(eJ){eJ.exec.call(eQ,"Transporter","clear");eQ.trigger("TransportingAborted")}eN.call(eQ)},destroy:function(){this.unbindAll();eJ=null;this.disconnectRuntime();eN.call(this)}});function eN(){eM=eP=0;eH=this.result=null}function eK(eR,eS){var eQ=this;eJ=eS;eQ.bind("TransportingProgress",function(eT){eP=eT.loaded;if(eP<eM&&eF.inArray(eQ.state,[eE.IDLE,eE.DONE])===-1){eI.call(eQ)}},999);eQ.bind("TransportingComplete",function(){eP=eM;eQ.state=eE.DONE;eH=null;eQ.result=eJ.exec.call(eQ,"Transporter","getAsBlob",eR||"")},999);eQ.state=eE.BUSY;eQ.trigger("TransportingStarted");eI.call(eQ)}function eI(){var eQ=this,eR,eS=eM-eP;if(eO>eS){eO=eS}eR=eC.btoa(eH.substr(eP,eO));eJ.exec.call(eQ,"Transporter","receive",eR,eM)}}eE.IDLE=0;eE.BUSY=1;eE.DONE=2;eE.prototype=eG.instance;return eE});eB("moxie/core/JSON",[],function(){return !!window.JSON&&JSON.parse||(function(){var eF,eD,eC={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"},eO,eM=function(eP){throw {name:"SyntaxError",message:eP,at:eF,text:eO}},eI=function(eP){if(eP&&eP!==eD){eM("Expected '"+eP+"' instead of '"+eD+"'")}eD=eO.charAt(eF);eF+=1;return eD},eH=function(){var eQ,eP="";if(eD==="-"){eP="-";eI("-")}while(eD>="0"&&eD<="9"){eP+=eD;eI()}if(eD==="."){eP+=".";while(eI()&&eD>="0"&&eD<="9"){eP+=eD}}if(eD==="e"||eD==="E"){eP+=eD;eI();if(eD==="-"||eD==="+"){eP+=eD;eI()}while(eD>="0"&&eD<="9"){eP+=eD;eI()}}eQ=+eP;if(!isFinite(eQ)){eM("Bad number")}else{return eQ}},eJ=function(){var eS,eR,eQ="",eP;if(eD==='"'){while(eI()){if(eD==='"'){eI();return eQ}else{if(eD==="\\"){eI();if(eD==="u"){eP=0;for(eR=0;eR<4;eR+=1){eS=parseInt(eI(),16);if(!isFinite(eS)){break}eP=eP*16+eS}eQ+=String.fromCharCode(eP)}else{if(typeof eC[eD]==="string"){eQ+=eC[eD]}else{break}}}else{eQ+=eD}}}}eM("Bad string")},eL=function(){while(eD&&eD<=" "){eI()}},eE=function(){switch(eD){case"t":eI("t");eI("r");eI("u");eI("e");return true;case"f":eI("f");eI("a");eI("l");eI("s");eI("e");return false;case"n":eI("n");eI("u");eI("l");eI("l");return null}eM("Unexpected '"+eD+"'")},eN,eK=function(){var eP=[];if(eD==="["){eI("[");eL();if(eD==="]"){eI("]");return eP}while(eD){eP.push(eN());eL();if(eD==="]"){eI("]");return eP}eI(",");eL()}}eM("Bad array")},eG=function(){var eQ,eP={};if(eD==="{"){eI("{");eL();if(eD==="}"){eI("}");return eP}while(eD){eQ=eJ();eL();eI(":");if(Object.hasOwnProperty.call(eP,eQ)){eM('Duplicate key "'+eQ+'"')}eP[eQ]=eN();eL();if(eD==="}"){eI("}");return eP}eI(",");eL()}}eM("Bad object")};eN=function(){eL();switch(eD){case"{":return eG();case"[":return eK();case'"':return eJ();case"-":return eH();default:return eD>="0"&&eD<="9"?eH():eE()}};return function(eS,eQ){var eP;eO=eS;eF=0;eD=" ";eP=eN();eL();if(eD){eM("Syntax error")}return typeof eQ==="function"?(function eR(eW,eV){var eU,eT,eX=eW[eV];if(eX&&typeof eX==="object"){for(eU in eX){if(Object.prototype.hasOwnProperty.call(eX,eU)){eT=eR(eX,eU);if(eT!==eA){eX[eU]=eT}else{delete eX[eU]}}}}return eQ.call(eW,eV,eX)}({"":eP},"")):eP}}())});eB("moxie/image/Image",["moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/file/FileReaderSync","moxie/xhr/XMLHttpRequest","moxie/runtime/Runtime","moxie/runtime/RuntimeClient","moxie/runtime/Transporter","moxie/core/utils/Env","moxie/core/EventTarget","moxie/file/Blob","moxie/file/File","moxie/core/utils/Encode","moxie/core/JSON"],function(eE,eI,eO,eM,eP,eD,eN,eH,eL,eR,eG,eK,eJ,eF){var eQ=["progress","load","error","resize","embedded"];function eC(){eN.call(this);eE.extend(this,{uid:eE.guid("uid_"),ruid:null,name:"",size:0,width:0,height:0,type:"",meta:{},clone:function(){this.load.apply(this,arguments)},load:function(){this.bind("Load Resize",function(){eT.call(this)},999);this.convertEventPropsToHandlers(eQ);eU.apply(this,arguments)},downsize:function(e1,eX,e0,eY){try{if(!this.size){throw new eO.DOMException(eO.DOMException.INVALID_STATE_ERR)}if(this.width>eC.MAX_RESIZE_WIDTH||this.height>eC.MAX_RESIZE_HEIGHT){throw new eO.ImageError(eO.ImageError.MAX_RESOLUTION_ERR)}if(!e1&&!eX||eE.typeOf(e0)==="undefined"){e0=false}e1=e1||this.width;eX=eX||this.height;eY=(eE.typeOf(eY)==="undefined"?true:!!eY);this.getRuntime().exec.call(this,"Image","downsize",e1,eX,e0,eY)}catch(eZ){this.trigger("error",eZ)}},crop:function(eZ,eX,eY){this.downsize(eZ,eX,true,eY)},getAsCanvas:function(){if(!eL.can("create_canvas")){throw new eO.RuntimeError(eO.RuntimeError.NOT_SUPPORTED_ERR)}var eX=this.connectRuntime(this.ruid);return eX.exec.call(this,"Image","getAsCanvas")},getAsBlob:function(eX,eY){if(!this.size){throw new eO.DOMException(eO.DOMException.INVALID_STATE_ERR)}if(!eX){eX="image/jpeg"}if(eX==="image/jpeg"&&!eY){eY=90}return this.getRuntime().exec.call(this,"Image","getAsBlob",eX,eY)},getAsDataURL:function(eX,eY){if(!this.size){throw new eO.DOMException(eO.DOMException.INVALID_STATE_ERR)}return this.getRuntime().exec.call(this,"Image","getAsDataURL",eX,eY)},getAsBinaryString:function(eX,eZ){var eY=this.getAsDataURL(eX,eZ);return eJ.atob(eY.substring(eY.indexOf("base64,")+7))},embed:function(e0){var e8=this,e5,e4,e6,e2,e9=arguments[1]||{},eZ=this.width,e7=this.height,e1;function eY(){if(eL.can("create_canvas")){var fa=e5.getAsCanvas();if(fa){e0.appendChild(fa);fa=null;e5.destroy();e8.trigger("embedded");return}}var fc=e5.getAsDataURL(e4,e6);if(!fc){throw new eO.ImageError(eO.ImageError.WRONG_FORMAT)}if(eL.can("use_data_uri_of",fc.length)){e0.innerHTML='<img src="'+fc+'" width="'+e5.width+'" height="'+e5.height+'" />';e5.destroy();e8.trigger("embedded")}else{var fb=new eH();fb.bind("TransportingComplete",function(){e1=e8.connectRuntime(this.result.ruid);e8.bind("Embedded",function(){eE.extend(e1.getShimContainer().style,{top:"0px",left:"0px",width:e5.width+"px",height:e5.height+"px"});e1=null},999);e1.exec.call(e8,"ImageView","display",this.result.uid,eZ,e7);e5.destroy()});fb.transport(eJ.atob(fc.substring(fc.indexOf("base64,")+7)),e4,eE.extend({},e9,{required_caps:{display_media:true},runtime_order:"flash,silverlight",container:e0}))}}try{if(!(e0=eI.get(e0))){throw new eO.DOMException(eO.DOMException.INVALID_NODE_TYPE_ERR)}if(!this.size){throw new eO.DOMException(eO.DOMException.INVALID_STATE_ERR)}if(this.width>eC.MAX_RESIZE_WIDTH||this.height>eC.MAX_RESIZE_HEIGHT){throw new eO.ImageError(eO.ImageError.MAX_RESOLUTION_ERR)}e4=e9.type||this.type||"image/jpeg";e6=e9.quality||90;e2=eE.typeOf(e9.crop)!=="undefined"?e9.crop:false;if(e9.width){eZ=e9.width;e7=e9.height||eZ}else{var eX=eI.getSize(e0);if(eX.w&&eX.h){eZ=eX.w;e7=eX.h}}e5=new eC();e5.bind("Resize",function(){eY.call(e8)});e5.bind("Load",function(){e5.downsize(eZ,e7,e2,false)});e5.clone(this,false);return e5}catch(e3){this.trigger("error",e3)}},destroy:function(){if(this.ruid){this.getRuntime().exec.call(this,"Image","destroy");this.disconnectRuntime()}this.unbindAll()}});function eT(eY){if(!eY){eY=this.getRuntime().exec.call(this,"Image","getInfo")}if(eY){if(eE.typeOf(eY.meta)==="string"){try{this.meta=eF(eY.meta)}catch(eX){}}else{this.meta=eY.meta}}eE.extend(this,{size:parseInt(eY.size,10),width:parseInt(eY.width,10),height:parseInt(eY.height,10),type:eY.type});if(this.name===""){this.name=eY.name}}function eU(eZ){var eY=eE.typeOf(eZ);try{if(eZ instanceof eC){if(!eZ.size){throw new eO.DOMException(eO.DOMException.INVALID_STATE_ERR)}eS.apply(this,arguments)}else{if(eZ instanceof eG){if(!~eE.inArray(eZ.type,["image/jpeg","image/png"])){throw new eO.ImageError(eO.ImageError.WRONG_FORMAT)}eV.apply(this,arguments)}else{if(eE.inArray(eY,["blob","file"])!==-1){eU.call(this,new eK(null,eZ),arguments[1])}else{if(eY==="string"){if(/^data:[^;]*;base64,/.test(eZ)){eU.call(this,new eG(null,{data:eZ}),arguments[1])}else{eW.apply(this,arguments)}}else{if(eY==="node"&&eZ.nodeName.toLowerCase()==="img"){eU.call(this,eZ.src,arguments[1])}else{throw new eO.DOMException(eO.DOMException.TYPE_MISMATCH_ERR)}}}}}}catch(eX){this.trigger("error",eX)}}function eS(eX,eY){var eZ=this.connectRuntime(eX.ruid);this.ruid=eZ.uid;eZ.exec.call(this,"Image","loadFromImage",eX,(eE.typeOf(eY)==="undefined"?true:eY))}function eV(eZ,e0){var eY=this;eY.name=eZ.name||"";function eX(e1){eY.ruid=e1.uid;e1.exec.call(eY,"Image","loadFromBlob",eZ)}if(eZ.isDetached()){this.bind("RuntimeInit",function(e2,e1){eX(e1)});if(e0&&typeof(e0.required_caps)==="string"){e0.required_caps=eD.parseCaps(e0.required_caps)}this.connectRuntime(eE.extend({required_caps:{access_image_binary:true,resize_image:true}},e0))}else{eX(this.connectRuntime(eZ.ruid))}}function eW(eZ,eY){var eX=this,e0;e0=new eP();e0.open("get",eZ);e0.responseType="blob";e0.onprogress=function(e1){eX.trigger(e1)};e0.onload=function(){eV.call(eX,e0.response,true)};e0.onerror=function(e1){eX.trigger(e1)};e0.onloadend=function(){e0.destroy()};e0.bind("RuntimeError",function(e2,e1){eX.trigger("RuntimeError",e1)});e0.send(null,eY)}}eC.MAX_RESIZE_WIDTH=6500;eC.MAX_RESIZE_HEIGHT=6500;eC.prototype=eR.instance;return eC});eB("moxie/runtime/html5/Runtime",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/Runtime","moxie/core/utils/Env"],function(eH,eC,eE,eD){var eG="html5",eF={};function eI(eK){var eJ=this,eN=eE.capTest,eM=eE.capTrue;var eL=eH.extend({access_binary:eN(window.FileReader||window.File&&window.File.getAsDataURL),access_image_binary:function(){return eJ.can("access_binary")&&!!eF.Image},display_media:eN(eD.can("create_canvas")||eD.can("use_data_uri_over32kb")),do_cors:eN(window.XMLHttpRequest&&"withCredentials" in new XMLHttpRequest()),drag_and_drop:eN(function(){var eO=document.createElement("div");return(("draggable" in eO)||("ondragstart" in eO&&"ondrop" in eO))&&(eD.browser!=="IE"||eD.version>9)}()),filter_by_extension:eN(function(){return(eD.browser==="Chrome"&&eD.version>=28)||(eD.browser==="IE"&&eD.version>=10)}()),return_response_headers:eM,return_response_type:function(eO){if(eO==="json"){return true}else{return eD.can("return_response_type",eO)}},return_status_code:eM,report_upload_progress:eN(window.XMLHttpRequest&&new XMLHttpRequest().upload),resize_image:function(){return eJ.can("access_binary")&&eD.can("create_canvas")},select_file:function(){return eD.can("use_fileinput")&&window.File},select_folder:function(){return eJ.can("select_file")&&eD.browser==="Chrome"&&eD.version>=21},select_multiple:function(){return eJ.can("select_file")&&!(eD.browser==="Safari"&&eD.OS==="Windows")},send_binary_string:eN(window.XMLHttpRequest&&(new XMLHttpRequest().sendAsBinary||(window.Uint8Array&&window.ArrayBuffer))),send_custom_headers:eN(window.XMLHttpRequest),send_multipart:function(){return !!(window.XMLHttpRequest&&new XMLHttpRequest().upload&&window.FormData)||eJ.can("send_binary_string")},slice_blob:eN(window.File&&(File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice)),stream_upload:function(){return eJ.can("slice_blob")&&eJ.can("send_multipart")},summon_file_dialog:eN(function(){return(eD.browser==="Firefox"&&eD.version>=4)||(eD.browser==="Opera"&&eD.version>=12)||(eD.browser==="IE"&&eD.version>=10)||!!~eH.inArray(eD.browser,["Chrome","Safari"])}()),upload_filesize:eM},arguments[2]);eE.call(this,eK,(arguments[1]||eG),eL);eH.extend(this,{init:function(){this.trigger("Init")},destroy:(function(eO){return function(){eO.call(eJ);eO=eJ=null}}(this.destroy))});eH.extend(this.getShim(),eF)}eE.addConstructor(eG,eI);return eF});eB("moxie/runtime/html5/file/Blob",["moxie/runtime/html5/Runtime","moxie/file/Blob"],function(eD,eE){function eC(){function eF(eH,eK,eG){var eI;if(window.File.prototype.slice){try{eH.slice();return eH.slice(eK,eG)}catch(eJ){return eH.slice(eK,eG-eK)}}else{if((eI=window.File.prototype.webkitSlice||window.File.prototype.mozSlice)){return eI.call(eH,eK,eG)}else{return null}}}this.slice=function(){return new eE(this.getRuntime().uid,eF.apply(this,arguments))}}return(eD.Blob=eC)});eB("moxie/core/utils/Events",["moxie/core/utils/Basic"],function(eI){var eJ={},eF="moxie_"+eI.guid();function eE(){this.returnValue=false}function eD(){this.cancelBubble=true}var eG=function(eO,eK,eP,eM){var eN,eL;eK=eK.toLowerCase();if(eO.addEventListener){eN=eP;eO.addEventListener(eK,eN,false)}else{if(eO.attachEvent){eN=function(){var eQ=window.event;if(!eQ.target){eQ.target=eQ.srcElement}eQ.preventDefault=eE;eQ.stopPropagation=eD;eP(eQ)};eO.attachEvent("on"+eK,eN)}}if(!eO[eF]){eO[eF]=eI.guid()}if(!eJ.hasOwnProperty(eO[eF])){eJ[eO[eF]]={}}eL=eJ[eO[eF]];if(!eL.hasOwnProperty(eK)){eL[eK]=[]}eL[eK].push({func:eN,orig:eP,key:eM})};var eH=function(eP,eK,eQ){var eN,eM;eK=eK.toLowerCase();if(eP[eF]&&eJ[eP[eF]]&&eJ[eP[eF]][eK]){eN=eJ[eP[eF]][eK]}else{return}for(var eL=eN.length-1;eL>=0;eL--){if(eN[eL].orig===eQ||eN[eL].key===eQ){if(eP.removeEventListener){eP.removeEventListener(eK,eN[eL].func,false)}else{if(eP.detachEvent){eP.detachEvent("on"+eK,eN[eL].func)}}eN[eL].orig=null;eN[eL].func=null;eN.splice(eL,1);if(eQ!==eM){break}}}if(!eN.length){delete eJ[eP[eF]][eK]}if(eI.isEmptyObj(eJ[eP[eF]])){delete eJ[eP[eF]];try{delete eP[eF]}catch(eO){eP[eF]=eM}}};var eC=function(eL,eK){if(!eL||!eL[eF]){return}eI.each(eJ[eL[eF]],function(eN,eM){eH(eL,eM,eK)})};return{addEvent:eG,removeEvent:eH,removeAllEvents:eC}});eB("moxie/runtime/html5/file/FileInput",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Events","moxie/core/utils/Mime","moxie/core/utils/Env"],function(eG,eI,eF,eD,eE,eC){function eH(){var eK=[],eJ;eI.extend(this,{init:function(eU){var eL=this,eS=eL.getRuntime(),eR,eN,eO,eT,eQ,eP;eJ=eU;eK=[];eO=eJ.accept.mimes||eE.extList2mimes(eJ.accept,eS.can("filter_by_extension"));eN=eS.getShimContainer();eN.innerHTML='<input id="'+eS.uid+'" type="file" style="font-size:999px;opacity:0;"'+(eJ.multiple&&eS.can("select_multiple")?"multiple":"")+(eJ.directory&&eS.can("select_folder")?"webkitdirectory directory":"")+(eO?' accept="'+eO.join(",")+'"':"")+" />";eR=eF.get(eS.uid);eI.extend(eR.style,{position:"absolute",top:0,left:0,width:"100%",height:"100%"});eT=eF.get(eJ.browse_button);if(eS.can("summon_file_dialog")){if(eF.getStyle(eT,"position")==="static"){eT.style.position="relative"}eQ=parseInt(eF.getStyle(eT,"z-index"),10)||1;eT.style.zIndex=eQ;eN.style.zIndex=eQ-1;eD.addEvent(eT,"click",function(eW){var eV=eF.get(eS.uid);if(eV&&!eV.disabled){eV.click()}eW.preventDefault()},eL.uid)}eP=eS.can("summon_file_dialog")?eT:eN;eD.addEvent(eP,"mouseover",function(){eL.trigger("mouseenter")},eL.uid);eD.addEvent(eP,"mouseout",function(){eL.trigger("mouseleave")},eL.uid);eD.addEvent(eP,"mousedown",function(){eL.trigger("mousedown")},eL.uid);eD.addEvent(eF.get(eJ.container),"mouseup",function(){eL.trigger("mouseup")},eL.uid);eR.onchange=function eM(){eK=[];if(eJ.directory){eI.each(this.files,function(eW){if(eW.name!=="."){eK.push(eW)}})}else{eK=[].slice.call(this.files)}if(eC.browser!=="IE"){this.value=""}else{var eV=this.cloneNode(true);this.parentNode.replaceChild(eV,this);eV.onchange=eM}eL.trigger("change")};eL.trigger({type:"ready",async:true});eN=null},getFiles:function(){return eK},disable:function(eN){var eM=this.getRuntime(),eL;if((eL=eF.get(eM.uid))){eL.disabled=!!eN}},destroy:function(){var eM=this.getRuntime(),eL=eM.getShimContainer();eD.removeAllEvents(eL,this.uid);eD.removeAllEvents(eJ&&eF.get(eJ.container),this.uid);eD.removeAllEvents(eJ&&eF.get(eJ.browse_button),this.uid);if(eL){eL.innerHTML=""}eK=eJ=null}})}return(eG.FileInput=eH)});eB("moxie/runtime/html5/file/FileDrop",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Events","moxie/core/utils/Mime"],function(eF,eG,eE,eC,eD){function eH(){var eK=[],eN=[],eJ;eG.extend(this,{init:function(eR){var eQ=this,eS;eJ=eR;eN=eL(eJ.accept);eS=eJ.container;eC.addEvent(eS,"dragover",function(eT){eT.preventDefault();eT.stopPropagation();eT.dataTransfer.dropEffect="copy"},eQ.uid);eC.addEvent(eS,"drop",function(eU){eU.preventDefault();eU.stopPropagation();eK=[];if(eU.dataTransfer.items&&eU.dataTransfer.items[0].webkitGetAsEntry){var eT=[];eG.each(eU.dataTransfer.items,function(eV){eT.push(eV.webkitGetAsEntry())});eO(eT,function(){eQ.trigger("drop")})}else{eG.each(eU.dataTransfer.files,function(eV){if(eI(eV)){eK.push(eV)}});eQ.trigger("drop")}},eQ.uid);eC.addEvent(eS,"dragenter",function(eT){eT.preventDefault();eT.stopPropagation();eQ.trigger("dragenter")},eQ.uid);eC.addEvent(eS,"dragleave",function(eT){eT.preventDefault();eT.stopPropagation();eQ.trigger("dragleave")},eQ.uid)},getFiles:function(){return eK},destroy:function(){eC.removeAllEvents(eJ&&eE.get(eJ.container),this.uid);eK=eN=eJ=null}});function eL(eS){var eR=[];for(var eQ=0;eQ<eS.length;eQ++){[].push.apply(eR,eS[eQ].extensions.split(/\s*,\s*/))}return eG.inArray("*",eR)===-1?eR:[]}function eI(eQ){var eR=eD.getFileExtension(eQ.name);return !eR||!eN.length||eG.inArray(eR,eN)!==-1}function eO(eS,eR){var eQ=[];eG.each(eS,function(eT){eQ.push(function(eU){eM(eT,eU)})});eG.inSeries(eQ,function(){eR()})}function eM(eR,eQ){if(eR.isFile){eR.file(function(eS){if(eI(eS)){eK.push(eS)}eQ()},function(){eQ()})}else{if(eR.isDirectory){eP(eR,eQ)}else{eQ()}}}function eP(eU,eR){var eQ=[],eT=eU.createReader();function eS(eV){eT.readEntries(function(eW){if(eW.length){[].push.apply(eQ,eW);eS(eV)}else{eV()}},eV)}eS(function(){eO(eQ,eR)})}}return(eF.FileDrop=eH)});eB("moxie/runtime/html5/file/FileReader",["moxie/runtime/html5/Runtime","moxie/core/utils/Encode","moxie/core/utils/Basic"],function(eD,eC,eF){function eE(){var eH,eI=false;eF.extend(this,{read:function(eL,eJ){var eK=this;eH=new window.FileReader();eH.addEventListener("progress",function(eM){eK.trigger(eM)});eH.addEventListener("load",function(eM){eK.trigger(eM)});eH.addEventListener("error",function(eM){eK.trigger(eM,eH.error)});eH.addEventListener("loadend",function(){eH=null});if(eF.typeOf(eH[eL])==="function"){eI=false;eH[eL](eJ.getSource())}else{if(eL==="readAsBinaryString"){eI=true;eH.readAsDataURL(eJ.getSource())}}},getResult:function(){return eH&&eH.result?(eI?eG(eH.result):eH.result):null},abort:function(){if(eH){eH.abort()}},destroy:function(){eH=null}});function eG(eJ){return eC.atob(eJ.substring(eJ.indexOf("base64,")+7))}}return(eD.FileReader=eE)});eB("moxie/runtime/html5/xhr/XMLHttpRequest",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/utils/Mime","moxie/core/utils/Url","moxie/file/File","moxie/file/Blob","moxie/xhr/FormData","moxie/core/Exceptions","moxie/core/utils/Env","moxie/core/JSON"],function(eJ,eD,eG,eC,eI,eF,eM,eK,eH,eE){function eL(){var eS,eQ;eD.extend(this,{send:function(e0,eX){var eZ=this,eW=(eH.browser==="Mozilla"&&eH.version>=4&&eH.version<7),eT=eH.browser==="Android Browser",eY=false;eQ=e0.url.replace(/^.+?\/([\w\-\.]+)$/,"$1").toLowerCase();eS=eR();eS.open(e0.method,e0.url,e0.async,e0.user,e0.password);if(eX instanceof eF){if(eX.isDetached()){eY=true}eX=eX.getSource()}else{if(eX instanceof eM){if(eX.hasBlob()){if(eX.getBlob().isDetached()){eX=eP.call(eZ,eX);eY=true}else{if((eW||eT)&&eD.typeOf(eX.getBlob().getSource())==="blob"&&window.FileReader){eN.call(eZ,e0,eX);return}}}if(eX instanceof eM){var eV=new window.FormData();eX.each(function(e2,e1){if(e2 instanceof eF){eV.append(e1,e2.getSource())}else{eV.append(e1,e2)}});eX=eV}}}if(eS.upload){if(e0.withCredentials){eS.withCredentials=true}eS.addEventListener("load",function(e1){eZ.trigger(e1)});eS.addEventListener("error",function(e1){eZ.trigger(e1)});eS.addEventListener("progress",function(e1){eZ.trigger(e1)});eS.upload.addEventListener("progress",function(e1){eZ.trigger({type:"UploadProgress",loaded:e1.loaded,total:e1.total})})}else{eS.onreadystatechange=function eU(){switch(eS.readyState){case 1:break;case 2:break;case 3:var e3,e1;try{if(eC.hasSameOrigin(e0.url)){e3=eS.getResponseHeader("Content-Length")||0}if(eS.responseText){e1=eS.responseText.length}}catch(e2){e3=e1=0}eZ.trigger({type:"progress",lengthComputable:!!e3,total:parseInt(e3,10),loaded:e1});break;case 4:eS.onreadystatechange=function(){};if(eS.status===0){eZ.trigger("error")}else{eZ.trigger("load")}break}}}if(!eD.isEmptyObj(e0.headers)){eD.each(e0.headers,function(e1,e2){eS.setRequestHeader(e2,e1)})}if(""!==e0.responseType&&"responseType" in eS){if("json"===e0.responseType&&!eH.can("return_response_type","json")){eS.responseType="text"}else{eS.responseType=e0.responseType}}if(!eY){eS.send(eX)}else{if(eS.sendAsBinary){eS.sendAsBinary(eX)}else{(function(){var e1=new Uint8Array(eX.length);for(var e2=0;e2<eX.length;e2++){e1[e2]=(eX.charCodeAt(e2)&255)}eS.send(e1.buffer)}())}}eZ.trigger("loadstart")},getStatus:function(){try{if(eS){return eS.status}}catch(eT){}return 0},getResponse:function(eV){var eU=this.getRuntime();try{switch(eV){case"blob":var eX=new eI(eU.uid,eS.response);var eY=eS.getResponseHeader("Content-Disposition");if(eY){var eT=eY.match(/filename=([\'\"'])([^\1]+)\1/);if(eT){eQ=eT[2]}}eX.name=eQ;if(!eX.type){eX.type=eG.getFileMime(eQ)}return eX;case"json":if(!eH.can("return_response_type","json")){return eS.status===200?eE(eS.responseText):null}return eS.response;case"document":return eO(eS);default:return eS.responseText!==""?eS.responseText:null}}catch(eW){return null}},getAllResponseHeaders:function(){try{return eS.getAllResponseHeaders()}catch(eT){}return""},abort:function(){if(eS){eS.abort()}},destroy:function(){self=eQ=null}});function eN(eX,eV){var eW=this,eU,eT;eU=eV.getBlob().getSource();eT=new window.FileReader();eT.onload=function(){eV.append(eV.getBlobName(),new eF(null,{type:eU.type,data:eT.result}));self.send.call(eW,eX,eV)};eT.readAsBinaryString(eU)}function eR(){if(window.XMLHttpRequest&&!(eH.browser==="IE"&&eH.version<8)){return new window.XMLHttpRequest()}else{return(function(){var eT=["Msxml2.XMLHTTP.6.0","Microsoft.XMLHTTP"];for(var eV=0;eV<eT.length;eV++){try{return new ActiveXObject(eT[eV])}catch(eU){}}})()}}function eO(eU){var eV=eU.responseXML;var eT=eU.responseText;if(eH.browser==="IE"&&eT&&eV&&!eV.documentElement&&/[^\/]+\/[^\+]+\+xml/.test(eU.getResponseHeader("Content-Type"))){eV=new window.ActiveXObject("Microsoft.XMLDOM");eV.async=false;eV.validateOnParse=false;eV.loadXML(eT)}if(eV){if((eH.browser==="IE"&&eV.parseError!==0)||!eV.documentElement||eV.documentElement.tagName==="parsererror"){return null}}return eV}function eP(eV){var eY="----moxieboundary"+new Date().getTime(),eW="--",eX="\r\n",eT="",eU=this.getRuntime();if(!eU.can("send_binary_string")){throw new eK.RuntimeError(eK.RuntimeError.NOT_SUPPORTED_ERR)}eS.setRequestHeader("Content-Type","multipart/form-data; boundary="+eY);eV.each(function(e0,eZ){if(e0 instanceof eF){eT+=eW+eY+eX+'Content-Disposition: form-data; name="'+eZ+'"; filename="'+unescape(encodeURIComponent(e0.name||"blob"))+'"'+eX+"Content-Type: "+e0.type+eX+eX+e0.getSource()+eX}else{eT+=eW+eY+eX+'Content-Disposition: form-data; name="'+eZ+'"'+eX+eX+unescape(encodeURIComponent(e0))+eX}});eT+=eW+eY+eW+eX;return eT}}return(eJ.XMLHttpRequest=eL)});eB("moxie/runtime/html5/utils/BinaryReader",[],function(){return function(){var eF=false,eD;function eG(eI,eK){var eH=eF?0:-8*(eK-1),eL=0,eJ;for(eJ=0;eJ<eK;eJ++){eL|=(eD.charCodeAt(eI+eJ)<<Math.abs(eH+eJ*8))}return eL}function eC(eJ,eH,eI){eI=arguments.length===3?eI:eD.length-eH-1;eD=eD.substr(0,eH)+eJ+eD.substr(eI+eH)}function eE(eI,eJ,eL){var eM="",eH=eF?0:-8*(eL-1),eK;for(eK=0;eK<eL;eK++){eM+=String.fromCharCode((eJ>>Math.abs(eH+eK*8))&255)}eC(eM,eI,eL)}return{II:function(eH){if(eH===eA){return eF}else{eF=eH}},init:function(eH){eF=false;eD=eH},SEGMENT:function(eH,eJ,eI){switch(arguments.length){case 1:return eD.substr(eH,eD.length-eH-1);case 2:return eD.substr(eH,eJ);case 3:eC(eI,eH,eJ);break;default:return eD}},BYTE:function(eH){return eG(eH,1)},SHORT:function(eH){return eG(eH,2)},LONG:function(eH,eI){if(eI===eA){return eG(eH,4)}else{eE(eH,eI,4)}},SLONG:function(eH){var eI=eG(eH,4);return(eI>2147483647?eI-4294967296:eI)},STRING:function(eH,eI){var eJ="";for(eI+=eH;eH<eI;eH++){eJ+=String.fromCharCode(eG(eH,1))}return eJ}}}});eB("moxie/runtime/html5/image/JPEGHeaders",["moxie/runtime/html5/utils/BinaryReader"],function(eD){return function eC(eI){var eJ=[],eH,eE,eF,eG=0;eH=new eD();eH.init(eI);if(eH.SHORT(0)!==65496){return}eE=2;while(eE<=eI.length){eF=eH.SHORT(eE);if(eF>=65488&&eF<=65495){eE+=2;continue}if(eF===65498||eF===65497){break}eG=eH.SHORT(eE+2)+2;if(eF>=65505&&eF<=65519){eJ.push({hex:eF,name:"APP"+(eF&15),start:eE,length:eG,segment:eH.SEGMENT(eE,eG)})}eE+=eG}eH.init(null);return{headers:eJ,restore:function(eM){var eK,eL;eH.init(eM);eE=eH.SHORT(2)==65504?4+eH.SHORT(4):2;for(eL=0,eK=eJ.length;eL<eK;eL++){eH.SEGMENT(eE,0,eJ[eL].segment);eE+=eJ[eL].length}eM=eH.SEGMENT();eH.init(null);return eM},strip:function(eM){var eN,eK,eL;eK=new eC(eM);eN=eK.headers;eK.purge();eH.init(eM);eL=eN.length;while(eL--){eH.SEGMENT(eN[eL].start,eN[eL].length,"")}eM=eH.SEGMENT();eH.init(null);return eM},get:function(eL){var eN=[];for(var eM=0,eK=eJ.length;eM<eK;eM++){if(eJ[eM].name===eL.toUpperCase()){eN.push(eJ[eM].segment)}}return eN},set:function(eL,eO){var eP=[],eM,eN,eK;if(typeof(eO)==="string"){eP.push(eO)}else{eP=eO}for(eM=eN=0,eK=eJ.length;eM<eK;eM++){if(eJ[eM].name===eL.toUpperCase()){eJ[eM].segment=eP[eN];eJ[eM].length=eP[eN].length;eN++}if(eN>=eP.length){break}}},purge:function(){eJ=[];eH.init(null);eH=null}}}});eB("moxie/runtime/html5/image/ExifParser",["moxie/core/utils/Basic","moxie/runtime/html5/utils/BinaryReader"],function(eE,eD){return function eC(){var eJ,eG,eF,eH={},eM;eJ=new eD();eG={tiff:{274:"Orientation",270:"ImageDescription",271:"Make",272:"Model",305:"Software",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer"},exif:{36864:"ExifVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",36867:"DateTimeOriginal",33434:"ExposureTime",33437:"FNumber",34855:"ISOSpeedRatings",37377:"ShutterSpeedValue",37378:"ApertureValue",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",41986:"ExposureMode",41987:"WhiteBalance",41990:"SceneCaptureType",41988:"DigitalZoomRatio",41992:"Contrast",41993:"Saturation",41994:"Sharpness"},gps:{0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude"}};eM={ColorSpace:{1:"sRGB",0:"Uncalibrated"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{1:"Daylight",2:"Fliorescent",3:"Tungsten",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 -5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire.",1:"Flash fired.",5:"Strobe return light not detected.",7:"Strobe return light detected.",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},ExposureMode:{0:"Auto exposure",1:"Manual exposure",2:"Auto bracket"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},GPSLatitudeRef:{N:"North latitude",S:"South latitude"},GPSLongitudeRef:{E:"East longitude",W:"West longitude"}};function eI(eN,eV){var eP=eJ.SHORT(eN),eS,eY,eZ,eU,eT,eO,eQ,eW,eX=[],eR={};for(eS=0;eS<eP;eS++){eQ=eO=eN+12*eS+2;eZ=eV[eJ.SHORT(eQ)];if(eZ===eA){continue}eU=eJ.SHORT(eQ+=2);eT=eJ.LONG(eQ+=2);eQ+=4;eX=[];switch(eU){case 1:case 7:if(eT>4){eQ=eJ.LONG(eQ)+eH.tiffHeader}for(eY=0;eY<eT;eY++){eX[eY]=eJ.BYTE(eQ+eY)}break;case 2:if(eT>4){eQ=eJ.LONG(eQ)+eH.tiffHeader}eR[eZ]=eJ.STRING(eQ,eT-1);continue;case 3:if(eT>2){eQ=eJ.LONG(eQ)+eH.tiffHeader}for(eY=0;eY<eT;eY++){eX[eY]=eJ.SHORT(eQ+eY*2)}break;case 4:if(eT>1){eQ=eJ.LONG(eQ)+eH.tiffHeader}for(eY=0;eY<eT;eY++){eX[eY]=eJ.LONG(eQ+eY*4)}break;case 5:eQ=eJ.LONG(eQ)+eH.tiffHeader;for(eY=0;eY<eT;eY++){eX[eY]=eJ.LONG(eQ+eY*4)/eJ.LONG(eQ+eY*4+4)}break;case 9:eQ=eJ.LONG(eQ)+eH.tiffHeader;for(eY=0;eY<eT;eY++){eX[eY]=eJ.SLONG(eQ+eY*4)}break;case 10:eQ=eJ.LONG(eQ)+eH.tiffHeader;for(eY=0;eY<eT;eY++){eX[eY]=eJ.SLONG(eQ+eY*4)/eJ.SLONG(eQ+eY*4+4)}break;default:continue}eW=(eT==1?eX[0]:eX);if(eM.hasOwnProperty(eZ)&&typeof eW!="object"){eR[eZ]=eM[eZ][eW]}else{eR[eZ]=eW}}return eR}function eL(){var eN=eH.tiffHeader;eJ.II(eJ.SHORT(eN)==18761);if(eJ.SHORT(eN+=2)!==42){return false}eH.IFD0=eH.tiffHeader+eJ.LONG(eN+=2);eF=eI(eH.IFD0,eG.tiff);if("ExifIFDPointer" in eF){eH.exifIFD=eH.tiffHeader+eF.ExifIFDPointer;delete eF.ExifIFDPointer}if("GPSInfoIFDPointer" in eF){eH.gpsIFD=eH.tiffHeader+eF.GPSInfoIFDPointer;delete eF.GPSInfoIFDPointer}return true}function eK(eU,eW,eT){var eR,eP,eO,eN=0;if(typeof(eW)==="string"){var eV=eG[eU.toLowerCase()];for(var eQ in eV){if(eV[eQ]===eW){eW=eQ;break}}}eR=eH[eU.toLowerCase()+"IFD"];eP=eJ.SHORT(eR);for(var eS=0;eS<eP;eS++){eO=eR+12*eS+2;if(eJ.SHORT(eO)==eW){eN=eO+8;break}}if(!eN){return false}eJ.LONG(eN,eT);return true}return{init:function(eN){eH={tiffHeader:10};if(eN===eA||!eN.length){return false}eJ.init(eN);if(eJ.SHORT(0)===65505&&eJ.STRING(4,5).toUpperCase()==="EXIF\0"){return eL()}return false},TIFF:function(){return eF},EXIF:function(){var eO;eO=eI(eH.exifIFD,eG.exif);if(eO.ExifVersion&&eE.typeOf(eO.ExifVersion)==="array"){for(var eP=0,eN="";eP<eO.ExifVersion.length;eP++){eN+=String.fromCharCode(eO.ExifVersion[eP])}eO.ExifVersion=eN}return eO},GPS:function(){var eN;eN=eI(eH.gpsIFD,eG.gps);if(eN.GPSVersionID&&eE.typeOf(eN.GPSVersionID)==="array"){eN.GPSVersionID=eN.GPSVersionID.join(".")}return eN},setExif:function(eN,eO){if(eN!=="PixelXDimension"&&eN!=="PixelYDimension"){return false}return eK("exif",eN,eO)},getBinary:function(){return eJ.SEGMENT()},purge:function(){eJ.init(null);eJ=eF=null;eH={}}}}});eB("moxie/runtime/html5/image/JPEG",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/html5/image/JPEGHeaders","moxie/runtime/html5/utils/BinaryReader","moxie/runtime/html5/image/ExifParser"],function(eH,eC,eE,eG,eD){function eF(eQ){var eJ,eL,eN,eM,eP,eI;function eO(){var eR=0,eS,eT;while(eR<=eJ.length){eS=eL.SHORT(eR+=2);if(eS>=65472&&eS<=65475){eR+=5;return{height:eL.SHORT(eR),width:eL.SHORT(eR+=2)}}eT=eL.SHORT(eR+=2);eR+=eT-2}return null}eJ=eQ;eL=new eG();eL.init(eJ);if(eL.SHORT(0)!==65496){throw new eC.ImageError(eC.ImageError.WRONG_FORMAT)}eN=new eE(eQ);eM=new eD();eI=!!eM.init(eN.get("app1")[0]);eP=eO.call(this);eH.extend(this,{type:"image/jpeg",size:eJ.length,width:eP&&eP.width||0,height:eP&&eP.height||0,setExif:function(eR,eS){if(!eI){return false}if(eH.typeOf(eR)==="object"){eH.each(eR,function(eU,eT){eM.setExif(eT,eU)})}else{eM.setExif(eR,eS)}eN.set("app1",eM.getBinary())},writeHeaders:function(){if(!arguments.length){return(eJ=eN.restore(eJ))}return eN.restore(arguments[0])},stripHeaders:function(eR){return eN.strip(eR)},purge:function(){eK.call(this)}});if(eI){this.meta={tiff:eM.TIFF(),exif:eM.EXIF(),gps:eM.GPS()}}function eK(){if(!eM||!eN||!eL){return}eM.purge();eN.purge();eL.init(null);eJ=eP=eN=eM=eL=null}}return eF});eB("moxie/runtime/html5/image/PNG",["moxie/core/Exceptions","moxie/core/utils/Basic","moxie/runtime/html5/utils/BinaryReader"],function(eC,eF,eE){function eD(eO){var eH,eJ,eL,eK,eN;eH=eO;eJ=new eE();eJ.init(eH);(function(){var eP=0,eR=0,eQ=[35152,20039,3338,6666];for(eR=0;eR<eQ.length;eR++,eP+=2){if(eQ[eR]!=eJ.SHORT(eP)){throw new eC.ImageError(eC.ImageError.WRONG_FORMAT)}}}());function eM(){var eQ,eP;eQ=eG.call(this,8);if(eQ.type=="IHDR"){eP=eQ.start;return{width:eJ.LONG(eP),height:eJ.LONG(eP+=4)}}return null}function eI(){if(!eJ){return}eJ.init(null);eH=eN=eL=eK=eJ=null}eN=eM.call(this);eF.extend(this,{type:"image/png",size:eH.length,width:eN.width,height:eN.height,purge:function(){eI.call(this)}});eI.call(this);function eG(eP){var eS,eR,eT,eQ;eS=eJ.LONG(eP);eR=eJ.STRING(eP+=4,4);eT=eP+=4;eQ=eJ.LONG(eP+eS);return{length:eS,type:eR,start:eT,CRC:eQ}}}return eD});eB("moxie/runtime/html5/image/ImageInfo",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/html5/image/JPEG","moxie/runtime/html5/image/PNG"],function(eF,eC,eE,eD){return function(eH){var eI=[eE,eD],eG;eG=(function(){for(var eK=0;eK<eI.length;eK++){try{return new eI[eK](eH)}catch(eJ){}}throw new eC.ImageError(eC.ImageError.WRONG_FORMAT)}());eF.extend(this,{type:"",size:0,width:0,height:0,setExif:function(){},writeHeaders:function(eJ){return eJ},stripHeaders:function(eJ){return eJ},purge:function(){}});eF.extend(this,eG);this.purge=function(){eG.purge();eG=null}}});eB("moxie/runtime/html5/image/MegaPixel",[],function(){function eC(e0,eG,eH){var eJ=e0.naturalWidth,eP=e0.naturalHeight;var eU=eH.width,eR=eH.height;var eL=eH.x||0,eK=eH.y||0;var eV=eG.getContext("2d");if(eD(e0)){eJ/=2;eP/=2}var eY=1024;var eF=document.createElement("canvas");eF.width=eF.height=eY;var eI=eF.getContext("2d");var eW=eE(e0,eJ,eP);var eQ=0;while(eQ<eP){var eZ=eQ+eY>eP?eP-eQ:eY;var eS=0;while(eS<eJ){var eT=eS+eY>eJ?eJ-eS:eY;eI.clearRect(0,0,eY,eY);eI.drawImage(e0,-eS,-eQ);var eN=(eS*eU/eJ+eL)<<0;var eO=Math.ceil(eT*eU/eJ);var eM=(eQ*eR/eP/eW+eK)<<0;var eX=Math.ceil(eZ*eR/eP/eW);eV.drawImage(eF,0,0,eT,eZ,eN,eM,eO,eX);eS+=eY}eQ+=eY}eF=eI=null}function eD(eH){var eG=eH.naturalWidth,eJ=eH.naturalHeight;if(eG*eJ>1024*1024){var eI=document.createElement("canvas");eI.width=eI.height=1;var eF=eI.getContext("2d");eF.drawImage(eH,-eG+1,0);return eF.getImageData(0,0,1,1).data[3]===0}else{return false}}function eE(eJ,eG,eO){var eF=document.createElement("canvas");eF.width=1;eF.height=eO;var eP=eF.getContext("2d");eP.drawImage(eJ,0,0);var eI=eP.getImageData(0,0,1,eO).data;var eM=0;var eK=eO;var eN=eO;while(eN>eM){var eH=eI[(eN-1)*4+3];if(eH===0){eK=eN}else{eM=eN}eN=(eK+eM)>>1}eF=null;var eL=(eN/eO);return(eL===0)?1:eL}return{isSubsampled:eD,renderTo:eC}});eB("moxie/runtime/html5/image/Image",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/Exceptions","moxie/core/utils/Encode","moxie/file/Blob","moxie/runtime/html5/image/ImageInfo","moxie/runtime/html5/image/MegaPixel","moxie/core/utils/Mime","moxie/core/utils/Env"],function(eI,eC,eJ,eF,eD,eL,eK,eE,eG){function eH(){var eW=this,eV,e0,eU,eQ,eY,e2=false,eN=true;eC.extend(this,{loadFromBlob:function(e5){var e4=this,e6=e4.getRuntime(),e3=arguments.length>1?arguments[1]:true;if(!e6.can("access_binary")){throw new eJ.RuntimeError(eJ.RuntimeError.NOT_SUPPORTED_ERR)}eY=e5;if(e5.isDetached()){eQ=e5.getSource();eT.call(this,eQ);return}else{eZ.call(this,e5.getSource(),function(e7){if(e3){eQ=e1(e7)}eT.call(e4,e7)})}},loadFromImage:function(e3,e4){this.meta=e3.meta;eY=new eD(null,{name:e3.name,size:e3.size,type:e3.type});eT.call(this,e4?(eQ=e3.getAsBinaryString()):e3.getAsDataURL())},getInfo:function(){var e3=this.getRuntime(),e4;if(!e0&&eQ&&e3.can("access_image_binary")){e0=new eL(eQ)}e4={width:eR().width||0,height:eR().height||0,type:eY.type||eE.getFileMime(eY.name),size:eQ&&eQ.length||eY.size||0,name:eY.name||"",meta:e0&&e0.meta||this.meta||{}};return e4},downsize:function(){eM.apply(this,arguments)},getAsCanvas:function(){if(eU){eU.id=this.uid+"_canvas"}return eU},getAsBlob:function(e3,e4){if(e3!==this.type){eM.call(this,this.width,this.height,false)}return new eD(null,{type:e3,data:eW.getAsBinaryString.call(this,e3,e4)})},getAsDataURL:function(e4){var e5=arguments[1]||90;if(!e2){return eV.src}if("image/jpeg"!==e4){return eU.toDataURL("image/png")}else{try{return eU.toDataURL("image/jpeg",e5/100)}catch(e3){return eU.toDataURL("image/jpeg")}}},getAsBinaryString:function(e4,e6){if(!e2){if(!eQ){eQ=e1(eW.getAsDataURL(e4,e6))}return eQ}if("image/jpeg"!==e4){eQ=e1(eW.getAsDataURL(e4,e6))}else{var e5;if(!e6){e6=90}try{e5=eU.toDataURL("image/jpeg",e6/100)}catch(e3){e5=eU.toDataURL("image/jpeg")}eQ=e1(e5);if(e0){eQ=e0.stripHeaders(eQ);if(eN){if(e0.meta&&e0.meta.exif){e0.setExif({PixelXDimension:this.width,PixelYDimension:this.height})}eQ=e0.writeHeaders(eQ)}e0.purge();e0=null}}e2=false;return eQ},destroy:function(){eW=null;eO.call(this);this.getRuntime().getShim().removeInstance(this.uid)}});function eR(){if(!eU&&!eV){throw new eJ.ImageError(eJ.DOMException.INVALID_STATE_ERR)}return eU||eV}function e1(e3){return eF.atob(e3.substring(e3.indexOf("base64,")+7))}function eX(e4,e3){return"data:"+(e3||"")+";base64,"+eF.btoa(e4)}function eT(e4){var e3=this;eV=new Image();eV.onerror=function(){eO.call(this);e3.trigger("error",new eJ.ImageError(eJ.ImageError.WRONG_FORMAT))};eV.onload=function(){e3.trigger("load")};eV.src=/^data:[^;]*;base64,/.test(e4)?e4:eX(e4,eY.type)}function eZ(e5,e6){var e4=this,e3;if(window.FileReader){e3=new FileReader();e3.onload=function(){e6(this.result)};e3.onerror=function(){e4.trigger("error",new eJ.FileException(eJ.FileException.NOT_READABLE_ERR))};e3.readAsDataURL(e5)}else{return e6(e5.getAsDataURL())}}function eM(e4,ff,e8,fd){var fg=this,fh,e6,e5,fc,fb,e7,fa,e9,e3;eN=fd;e3=(this.meta&&this.meta.tiff&&this.meta.tiff.Orientation)||1;if(eC.inArray(e3,[5,6,7,8])!==-1){var fe=e4;e4=ff;ff=fe}e7=eR();e5=!e8?Math.min:Math.max;e6=e5(e4/e7.width,ff/e7.height);if(e6>1&&(!e8||fd)){this.trigger("Resize");return}fa=Math.round(e7.width*e6);e9=Math.round(e7.height*e6);if(!eU){eU=document.createElement("canvas")}fh=eU.getContext("2d");if(e8){eU.width=e4;eU.height=ff}else{eU.width=fa;eU.height=e9}fc=fa>eU.width?Math.round((fa-eU.width)/2):0;fb=e9>eU.height?Math.round((e9-eU.height)/2):0;if(!eN){eS(eU.width,eU.height,e3)}eP.call(this,e7,eU,-fc,-fb,fa,e9);this.width=eU.width;this.height=eU.height;e2=true;fg.trigger("Resize")}function eP(e6,e7,e3,e9,e5,e8){if(eG.OS==="iOS"){eK.renderTo(e6,e7,{width:e5,height:e8,x:e3,y:e9})}else{var e4=e7.getContext("2d");e4.drawImage(e6,e3,e9,e5,e8)}}function eS(e6,e3,e5){switch(e5){case 5:case 6:case 7:case 8:eU.width=e3;eU.height=e6;break;default:eU.width=e6;eU.height=e3}var e4=eU.getContext("2d");switch(e5){case 2:e4.translate(e6,0);e4.scale(-1,1);break;case 3:e4.translate(e6,e3);e4.rotate(Math.PI);break;case 4:e4.translate(0,e3);e4.scale(1,-1);break;case 5:e4.rotate(0.5*Math.PI);e4.scale(1,-1);break;case 6:e4.rotate(0.5*Math.PI);e4.translate(0,-e3);break;case 7:e4.rotate(0.5*Math.PI);e4.translate(e6,-e3);e4.scale(-1,1);break;case 8:e4.rotate(-0.5*Math.PI);e4.translate(-e6,0);break}}function eO(){if(e0){e0.purge();e0=null}eQ=eV=eU=eY=null;e2=false}}return(eI.Image=eH)});eB("moxie/runtime/flash/Runtime",["moxie/core/utils/Basic","moxie/core/utils/Env","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/runtime/Runtime"],function(eD,eG,eE,eJ,eC){var eH="flash",eI={};function eF(){var eL;try{eL=navigator.plugins["Shockwave Flash"];eL=eL.description}catch(eN){try{eL=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(eM){eL="0.0"}}eL=eL.match(/\d+/g);return parseFloat(eL[0]+"."+eL[1])}function eK(eM){var eL=this,eN;eM=eD.extend({swf_url:eG.swf_url},eM);eC.call(this,eM,eH,{access_binary:function(eO){return eO&&eL.mode==="browser"},access_image_binary:function(eO){return eO&&eL.mode==="browser"},display_media:eC.capTrue,do_cors:eC.capTrue,drag_and_drop:false,report_upload_progress:function(){return eL.mode==="client"},resize_image:eC.capTrue,return_response_headers:false,return_response_type:function(eO){return !eD.arrayDiff(eO,["","text","json","document"])||eL.mode==="browser"},return_status_code:function(eO){return eL.mode==="browser"||!eD.arrayDiff(eO,[200,404])},select_file:eC.capTrue,select_multiple:eC.capTrue,send_binary_string:function(eO){return eO&&eL.mode==="browser"},send_browser_cookies:function(eO){return eO&&eL.mode==="browser"},send_custom_headers:function(eO){return eO&&eL.mode==="browser"},send_multipart:eC.capTrue,slice_blob:eC.capTrue,stream_upload:function(eO){return eO&&eL.mode==="browser"},summon_file_dialog:false,upload_filesize:function(eO){return eD.parseSizeStr(eO)<=2097152||eL.mode==="client"},use_http_method:function(eO){return !eD.arrayDiff(eO,["GET","POST"])}},{access_binary:function(eO){return eO?"browser":"client"},access_image_binary:function(eO){return eO?"browser":"client"},report_upload_progress:function(eO){return eO?"browser":"client"},return_response_type:function(eO){return eD.arrayDiff(eO,["","text","json","document"])?"browser":["client","browser"]},return_status_code:function(eO){return eD.arrayDiff(eO,[200,404])?"browser":["client","browser"]},send_binary_string:function(eO){return eO?"browser":"client"},send_browser_cookies:function(eO){return eO?"browser":"client"},send_custom_headers:function(eO){return eO?"browser":"client"},stream_upload:function(eO){return eO?"client":"browser"},upload_filesize:function(eO){return eD.parseSizeStr(eO)>=2097152?"client":"browser"}},"client");if(eF()<10){this.mode=false}eD.extend(this,{getShim:function(){return eE.get(this.uid)},shimExec:function(eP,eQ){var eO=[].slice.call(arguments,2);return eL.getShim().exec(this.uid,eP,eQ,eO)},init:function(){var eP,eQ,eO;eO=this.getShimContainer();eD.extend(eO.style,{position:"absolute",top:"-8px",left:"-8px",width:"9px",height:"9px",overflow:"hidden"});eP='<object id="'+this.uid+'" type="application/x-shockwave-flash" data="'+eM.swf_url+'" ';if(eG.browser==="IE"){eP+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '}eP+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+eM.swf_url+'" /><param name="flashvars" value="uid='+escape(this.uid)+"&target="+eG.global_event_dispatcher+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>';if(eG.browser==="IE"){eQ=document.createElement("div");eO.appendChild(eQ);eQ.outerHTML=eP;eQ=eO=null}else{eO.innerHTML=eP}eN=setTimeout(function(){if(eL&&!eL.initialized){eL.trigger("Error",new eJ.RuntimeError(eJ.RuntimeError.NOT_INIT_ERR))}},5000)},destroy:(function(eO){return function(){eO.call(eL);clearTimeout(eN);eM=eN=eO=eL=null}}(this.destroy))},eI)}eC.addConstructor(eH,eK);return eI});eB("moxie/runtime/flash/file/Blob",["moxie/runtime/flash/Runtime","moxie/file/Blob"],function(eD,eE){var eC={slice:function(eH,eJ,eF,eI){var eG=this.getRuntime();if(eJ<0){eJ=Math.max(eH.size+eJ,0)}else{if(eJ>0){eJ=Math.min(eJ,eH.size)}}if(eF<0){eF=Math.max(eH.size+eF,0)}else{if(eF>0){eF=Math.min(eF,eH.size)}}eH=eG.shimExec.call(this,"Blob","slice",eJ,eF,eI||"");if(eH){eH=new eE(eG.uid,eH)}return eH}};return(eD.Blob=eC)});eB("moxie/runtime/flash/file/FileInput",["moxie/runtime/flash/Runtime"],function(eC){var eD={init:function(eE){this.getRuntime().shimExec.call(this,"FileInput","init",{name:eE.name,accept:eE.accept,multiple:eE.multiple});this.trigger("ready")}};return(eC.FileInput=eD)});eB("moxie/runtime/flash/file/FileReader",["moxie/runtime/flash/Runtime","moxie/core/utils/Encode"],function(eF,eC){var eD="";function eE(eH,eI){switch(eI){case"readAsText":return eC.atob(eH,"utf8");case"readAsBinaryString":return eC.atob(eH);case"readAsDataURL":return eH}return null}var eG={read:function(eK,eI){var eJ=this,eH=eJ.getRuntime();if(eK==="readAsDataURL"){eD="data:"+(eI.type||"")+";base64,"}eJ.bind("Progress",function(eM,eL){if(eL){eD+=eE(eL,eK)}});return eH.shimExec.call(this,"FileReader","readAsBase64",eI.uid)},getResult:function(){return eD},destroy:function(){eD=null}};return(eF.FileReader=eG)});eB("moxie/runtime/flash/file/FileReaderSync",["moxie/runtime/flash/Runtime","moxie/core/utils/Encode"],function(eE,eC){function eD(eG,eH){switch(eH){case"readAsText":return eC.atob(eG,"utf8");case"readAsBinaryString":return eC.atob(eG);case"readAsDataURL":return eG}return null}var eF={read:function(eJ,eI){var eG,eH=this.getRuntime();eG=eH.shimExec.call(this,"FileReaderSync","readAsBase64",eI.uid);if(!eG){return null}if(eJ==="readAsDataURL"){eG="data:"+(eI.type||"")+";base64,"+eG}return eD(eG,eJ,eI.type)}};return(eE.FileReaderSync=eF)});eB("moxie/runtime/flash/xhr/XMLHttpRequest",["moxie/runtime/flash/Runtime","moxie/core/utils/Basic","moxie/file/Blob","moxie/file/File","moxie/file/FileReaderSync","moxie/xhr/FormData","moxie/runtime/Transporter","moxie/core/JSON"],function(eI,eC,eE,eH,eG,eK,eF,eD){var eJ={send:function(eS,eN){var eP=this,eT=eP.getRuntime();function eM(){eS.transport=eT.mode;eT.shimExec.call(eP,"XMLHttpRequest","send",eS,eN)}function eO(eV,eU){eT.shimExec.call(eP,"XMLHttpRequest","appendBlob",eV,eU.uid);eN=null;eM()}function eQ(eV,eU){var eW=new eF();eW.bind("TransportingComplete",function(){eU(this.result)});eW.transport(eV.getSource(),eV.type,{ruid:eT.uid})}if(!eC.isEmptyObj(eS.headers)){eC.each(eS.headers,function(eU,eV){eT.shimExec.call(eP,"XMLHttpRequest","setRequestHeader",eV,eU.toString())})}if(eN instanceof eK){var eR;eN.each(function(eV,eU){if(eV instanceof eE){eR=eU}else{eT.shimExec.call(eP,"XMLHttpRequest","append",eU,eV)}});if(!eN.hasBlob()){eN=null;eM()}else{var eL=eN.getBlob();if(eL.isDetached()){eQ(eL,function(eU){eL.destroy();eO(eR,eU)})}else{eO(eR,eL)}}}else{if(eN instanceof eE){if(eN.isDetached()){eQ(eN,function(eU){eN.destroy();eN=eU.uid;eM()})}else{eN=eN.uid;eM()}}else{eM()}}},getResponse:function(eO){var eL,eN,eM=this.getRuntime();eN=eM.shimExec.call(this,"XMLHttpRequest","getResponseAsBlob");if(eN){eN=new eH(eM.uid,eN);if("blob"===eO){return eN}else{if(!!~eC.inArray(eO,["","text"])){eL=new eG();return eL.readAsText(eN)}else{if("arraybuffer"===eO){}else{if("json"===eO){eL=new eG();try{return eD(eL.readAsText(eN))}catch(eP){return null}}}}}}return null},abort:function(eM){var eL=this.getRuntime();eL.shimExec.call(this,"XMLHttpRequest","abort");this.dispatchEvent("readystatechange");this.dispatchEvent("abort");if(!eM){}}};return(eI.XMLHttpRequest=eJ)});eB("moxie/runtime/flash/runtime/Transporter",["moxie/runtime/flash/Runtime","moxie/file/Blob"],function(eC,eE){var eD={getAsBlob:function(eH){var eG=this.getRuntime(),eF=eG.shimExec.call(this,"Transporter","getAsBlob",eH);if(eF){return new eE(eG.uid,eF)}return null}};return(eC.Transporter=eD)});eB("moxie/runtime/flash/image/Image",["moxie/runtime/flash/Runtime","moxie/core/utils/Basic","moxie/runtime/Transporter","moxie/file/Blob","moxie/file/FileReaderSync"],function(eD,eF,eE,eH,eG){var eC={loadFromBlob:function(eL){var eK=this,eJ=eK.getRuntime();function eI(eN){eJ.shimExec.call(eK,"Image","loadFromBlob",eN.uid);eK=eJ=null}if(eL.isDetached()){var eM=new eE();eM.bind("TransportingComplete",function(){eI(eM.result.getSource())});eM.transport(eL.getSource(),eL.type,{ruid:eJ.uid})}else{eI(eL.getSource())}},loadFromImage:function(eJ){var eI=this.getRuntime();return eI.shimExec.call(this,"Image","loadFromImage",eJ.uid)},getAsBlob:function(eK,eL){var eJ=this.getRuntime(),eI=eJ.shimExec.call(this,"Image","getAsBlob",eK,eL);if(eI){return new eH(eJ.uid,eI)}return null},getAsDataURL:function(){var eK=this.getRuntime(),eJ=eK.Image.getAsBlob.apply(this,arguments),eI;if(!eJ){return null}eI=new eG();return eI.readAsDataURL(eJ)}};return(eD.Image=eC)});eB("moxie/runtime/silverlight/Runtime",["moxie/core/utils/Basic","moxie/core/utils/Env","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/runtime/Runtime"],function(eD,eG,eF,eJ,eC){var eH="silverlight",eI={};function eK(eT){var eW=false,eP=null,eL,eM,eN,eV,eO,eR=0;try{try{eP=new ActiveXObject("AgControl.AgControl");if(eP.IsVersionSupported(eT)){eW=true}eP=null}catch(eS){var eQ=navigator.plugins["Silverlight Plug-In"];if(eQ){eL=eQ.description;if(eL==="1.0.30226.2"){eL="2.0.30226.2"}eM=eL.split(".");while(eM.length>3){eM.pop()}while(eM.length<4){eM.push(0)}eN=eT.split(".");while(eN.length>4){eN.pop()}do{eV=parseInt(eN[eR],10);eO=parseInt(eM[eR],10);eR++}while(eR<eN.length&&eV===eO);if(eV<=eO&&!isNaN(eV)){eW=true}}}}catch(eU){eW=false}return eW}function eE(eM){var eL=this,eN;eM=eD.extend({xap_url:eG.xap_url},eM);eC.call(this,eM,eH,{access_binary:eC.capTrue,access_image_binary:eC.capTrue,display_media:eC.capTrue,do_cors:eC.capTrue,drag_and_drop:false,report_upload_progress:eC.capTrue,resize_image:eC.capTrue,return_response_headers:function(eO){return eO&&eL.mode==="client"},return_response_type:eC.capTrue,return_status_code:function(eO){return eL.mode==="client"||!eD.arrayDiff(eO,[200,404])},select_file:eC.capTrue,select_multiple:eC.capTrue,send_binary_string:eC.capTrue,send_browser_cookies:function(eO){return eO&&eL.mode==="browser"},send_custom_headers:function(eO){return eO&&eL.mode==="client"},send_multipart:eC.capTrue,slice_blob:eC.capTrue,stream_upload:true,summon_file_dialog:false,upload_filesize:eC.capTrue,use_http_method:function(eO){return eL.mode==="client"||!eD.arrayDiff(eO,["GET","POST"])}},{return_response_headers:function(eO){return eO?"client":"browser"},return_status_code:function(eO){return eD.arrayDiff(eO,[200,404])?"client":["client","browser"]},send_browser_cookies:function(eO){return eO?"browser":"client"},send_custom_headers:function(eO){return eO?"client":"browser"},use_http_method:function(eO){return eD.arrayDiff(eO,["GET","POST"])?"client":["client","browser"]}});if(!eK("2.0.31005.0")||eG.browser==="Opera"){this.mode=false}eD.extend(this,{getShim:function(){return eF.get(this.uid).content.Moxie},shimExec:function(eP,eQ){var eO=[].slice.call(arguments,2);return eL.getShim().exec(this.uid,eP,eQ,eO)},init:function(){var eO;eO=this.getShimContainer();eO.innerHTML='<object id="'+this.uid+'" data="data:application/x-silverlight," type="application/x-silverlight-2" width="100%" height="100%" style="outline:none;"><param name="source" value="'+eM.xap_url+'"/><param name="background" value="Transparent"/><param name="windowless" value="true"/><param name="enablehtmlaccess" value="true"/><param name="initParams" value="uid='+this.uid+",target="+eG.global_event_dispatcher+'"/></object>';eN=setTimeout(function(){if(eL&&!eL.initialized){eL.trigger("Error",new eJ.RuntimeError(eJ.RuntimeError.NOT_INIT_ERR))}},eG.OS!=="Windows"?10000:5000)},destroy:(function(eO){return function(){eO.call(eL);clearTimeout(eN);eM=eN=eO=eL=null}}(this.destroy))},eI)}eC.addConstructor(eH,eE);return eI});eB("moxie/runtime/silverlight/file/Blob",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/file/Blob"],function(eC,eD,eE){return(eC.Blob=eD.extend({},eE))});eB("moxie/runtime/silverlight/file/FileInput",["moxie/runtime/silverlight/Runtime"],function(eC){var eD={init:function(eF){function eE(eH){var eI="";for(var eG=0;eG<eH.length;eG++){eI+=(eI!==""?"|":"")+eH[eG].title+" | *."+eH[eG].extensions.replace(/,/g,";*.")}return eI}this.getRuntime().shimExec.call(this,"FileInput","init",eE(eF.accept),eF.name,eF.multiple);this.trigger("ready")}};return(eC.FileInput=eD)});eB("moxie/runtime/silverlight/file/FileDrop",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Dom","moxie/core/utils/Events"],function(eE,eD,eC){var eF={init:function(){var eH=this,eG=eH.getRuntime(),eI;eI=eG.getShimContainer();eC.addEvent(eI,"dragover",function(eJ){eJ.preventDefault();eJ.stopPropagation();eJ.dataTransfer.dropEffect="copy"},eH.uid);eC.addEvent(eI,"dragenter",function(eK){eK.preventDefault();var eJ=eD.get(eG.uid).dragEnter(eK);if(eJ){eK.stopPropagation()}},eH.uid);eC.addEvent(eI,"drop",function(eK){eK.preventDefault();var eJ=eD.get(eG.uid).dragDrop(eK);if(eJ){eK.stopPropagation()}},eH.uid);return eG.shimExec.call(this,"FileDrop","init")}};return(eE.FileDrop=eF)});eB("moxie/runtime/silverlight/file/FileReader",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/file/FileReader"],function(eC,eE,eD){return(eC.FileReader=eE.extend({},eD))});eB("moxie/runtime/silverlight/file/FileReaderSync",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/file/FileReaderSync"],function(eC,eD,eE){return(eC.FileReaderSync=eD.extend({},eE))});eB("moxie/runtime/silverlight/xhr/XMLHttpRequest",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/xhr/XMLHttpRequest"],function(eC,eE,eD){return(eC.XMLHttpRequest=eE.extend({},eD))});eB("moxie/runtime/silverlight/runtime/Transporter",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/runtime/Transporter"],function(eC,eE,eD){return(eC.Transporter=eE.extend({},eD))});eB("moxie/runtime/silverlight/image/Image",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/image/Image"],function(eD,eE,eC){return(eD.Image=eE.extend({},eC))});eB("moxie/runtime/html4/Runtime",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/Runtime","moxie/core/utils/Env"],function(eI,eC,eF,eE){var eH="html4",eG={};function eD(eK){var eJ=this,eM=eF.capTest,eL=eF.capTrue;eF.call(this,eK,eH,{access_binary:eM(window.FileReader||window.File&&File.getAsDataURL),access_image_binary:false,display_media:eM(eG.Image&&(eE.can("create_canvas")||eE.can("use_data_uri_over32kb"))),do_cors:false,drag_and_drop:false,filter_by_extension:eM(function(){return(eE.browser==="Chrome"&&eE.version>=28)||(eE.browser==="IE"&&eE.version>=10)}()),resize_image:function(){return eG.Image&&eJ.can("access_binary")&&eE.can("create_canvas")},report_upload_progress:false,return_response_headers:false,return_response_type:function(eN){return !!~eI.inArray(eN,["json","text","document",""])},return_status_code:function(eN){return !eI.arrayDiff(eN,[200,404])},select_file:function(){return eE.can("use_fileinput")},select_multiple:false,send_binary_string:false,send_custom_headers:false,send_multipart:true,slice_blob:false,stream_upload:function(){return eJ.can("select_file")},summon_file_dialog:eM(function(){return(eE.browser==="Firefox"&&eE.version>=4)||(eE.browser==="Opera"&&eE.version>=12)||(eE.browser==="IE"&&eE.version>=10)||!!~eI.inArray(eE.browser,["Chrome","Safari"])}()),upload_filesize:eL,use_http_method:function(eN){return !eI.arrayDiff(eN,["GET","POST"])}});eI.extend(this,{init:function(){this.trigger("Init")},destroy:(function(eN){return function(){eN.call(eJ);eN=eJ=null}}(this.destroy))});eI.extend(this.getShim(),eG)}eF.addConstructor(eH,eD);return eG});eB("moxie/runtime/html4/file/FileInput",["moxie/runtime/html4/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Events","moxie/core/utils/Mime","moxie/core/utils/Env"],function(eG,eI,eF,eD,eE,eC){function eH(){var eM,eK=[],eN=[],eJ;function eL(){var eQ=this,eT=eQ.getRuntime(),eS,eR,eO,eV,eP,eU;eU=eI.guid("uid_");eS=eT.getShimContainer();if(eM){eO=eF.get(eM+"_form");if(eO){eI.extend(eO.style,{top:"100%"})}}eV=document.createElement("form");eV.setAttribute("id",eU+"_form");eV.setAttribute("method","post");eV.setAttribute("enctype","multipart/form-data");eV.setAttribute("encoding","multipart/form-data");eI.extend(eV.style,{overflow:"hidden",position:"absolute",top:0,left:0,width:"100%",height:"100%"});eP=document.createElement("input");eP.setAttribute("id",eU);eP.setAttribute("type","file");eP.setAttribute("name","Filedata");eP.setAttribute("accept",eN.join(","));eI.extend(eP.style,{fontSize:"999px",opacity:0});eV.appendChild(eP);eS.appendChild(eV);eI.extend(eP.style,{position:"absolute",top:0,left:0,width:"100%",height:"100%"});if(eC.browser==="IE"&&eC.version<10){eI.extend(eP.style,{filter:"progid:DXImageTransform.Microsoft.Alpha(opacity=0)"})}eP.onchange=function(){var eW;if(!this.value){return}if(this.files){eW=this.files[0]}else{eW={name:this.value}}eK=[eW];this.onchange=function(){};eL.call(eQ);eQ.bind("change",function(){var eX=eF.get(eU),eZ=eF.get(eU+"_form"),eY;if(eQ.files.length&&eX&&eZ){eY=eQ.files[0];eX.setAttribute("id",eY.uid);eZ.setAttribute("id",eY.uid+"_form");eZ.setAttribute("target",eY.uid+"_iframe")}eX=eZ=null},998);eP=eV=null;eQ.trigger("change")};if(eT.can("summon_file_dialog")){eR=eF.get(eJ.browse_button);eD.removeEvent(eR,"click",eQ.uid);eD.addEvent(eR,"click",function(eW){if(eP&&!eP.disabled){eP.click()}eW.preventDefault()},eQ.uid)}eM=eU;eS=eO=eR=null;eQ.trigger({type:"ready",async:true})}eI.extend(this,{init:function(eR){var eO=this,eQ=eO.getRuntime(),eP;eJ=eR;eN=eR.accept.mimes||eE.extList2mimes(eR.accept,eQ.can("filter_by_extension"));eP=eQ.getShimContainer();(function(){var eS,eU,eT;eS=eF.get(eR.browse_button);if(eQ.can("summon_file_dialog")){if(eF.getStyle(eS,"position")==="static"){eS.style.position="relative"}eU=parseInt(eF.getStyle(eS,"z-index"),10)||1;eS.style.zIndex=eU;eP.style.zIndex=eU-1}eT=eQ.can("summon_file_dialog")?eS:eP;eD.addEvent(eT,"mouseover",function(){eO.trigger("mouseenter")},eO.uid);eD.addEvent(eT,"mouseout",function(){eO.trigger("mouseleave")},eO.uid);eD.addEvent(eT,"mousedown",function(){eO.trigger("mousedown")},eO.uid);eD.addEvent(eF.get(eR.container),"mouseup",function(){eO.trigger("mouseup")},eO.uid);eS=null}());eL.call(this);eP=null},getFiles:function(){return eK},disable:function(eP){var eO;if((eO=eF.get(eM))){eO.disabled=!!eP}},destroy:function(){var eP=this.getRuntime(),eO=eP.getShimContainer();eD.removeAllEvents(eO,this.uid);eD.removeAllEvents(eJ&&eF.get(eJ.container),this.uid);eD.removeAllEvents(eJ&&eF.get(eJ.browse_button),this.uid);if(eO){eO.innerHTML=""}eM=eK=eN=eJ=null}})}return(eG.FileInput=eH)});eB("moxie/runtime/html4/file/FileReader",["moxie/runtime/html4/Runtime","moxie/runtime/html5/file/FileReader"],function(eC,eD){return(eC.FileReader=eD)});eB("moxie/runtime/html4/xhr/XMLHttpRequest",["moxie/runtime/html4/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Url","moxie/core/Exceptions","moxie/core/utils/Events","moxie/file/Blob","moxie/xhr/FormData","moxie/core/JSON"],function(eH,eD,eG,eC,eI,eK,eF,eL,eE){function eJ(){var eO,eM,eP;function eN(eQ){var eV=this,eT,eU,eR,eS,eW=false;if(!eP){return}eT=eP.id.replace(/_iframe$/,"");eU=eG.get(eT+"_form");if(eU){eR=eU.getElementsByTagName("input");eS=eR.length;while(eS--){switch(eR[eS].getAttribute("type")){case"hidden":eR[eS].parentNode.removeChild(eR[eS]);break;case"file":eW=true;break}}eR=[];if(!eW){eU.parentNode.removeChild(eU)}eU=null}setTimeout(function(){eK.removeEvent(eP,"load",eV.uid);if(eP.parentNode){eP.parentNode.removeChild(eP)}var eX=eV.getRuntime().getShimContainer();if(!eX.children.length){eX.parentNode.removeChild(eX)}eX=eP=null;eQ()},1)}eD.extend(this,{send:function(eY,eS){var eU=this,eX=eU.getRuntime(),eT,eR,eW,eQ;eO=eM=null;function eV(){var eZ=eX.getShimContainer()||document.body,e0=document.createElement("div");e0.innerHTML='<iframe id="'+eT+'_iframe" name="'+eT+'_iframe" src="javascript:&quot;&quot;" style="display:none"></iframe>';eP=e0.firstChild;eZ.appendChild(eP);eK.addEvent(eP,"load",function(){var e2;try{e2=eP.contentWindow.document||eP.contentDocument||window.frames[eP.id].document;if(/^4\d{2}\s/.test(e2.title)&&e2.getElementsByTagName("address").length){eO=e2.title.replace(/^(\d+).*$/,"$1")}else{eO=200;eM=eD.trim(e2.body.innerHTML);eU.trigger({type:"progress",loaded:eM.length,total:eM.length});if(eQ){eU.trigger({type:"uploadprogress",loaded:eQ.size||1025,total:eQ.size||1025})}}}catch(e1){if(eC.hasSameOrigin(eY.url)){eO=404}else{eN.call(eU,function(){eU.trigger("error")});return}}eN.call(eU,function(){eU.trigger("load")})},eU.uid)}if(eS instanceof eL&&eS.hasBlob()){eQ=eS.getBlob();eT=eQ.uid;eW=eG.get(eT);eR=eG.get(eT+"_form");if(!eR){throw new eI.DOMException(eI.DOMException.NOT_FOUND_ERR)}}else{eT=eD.guid("uid_");eR=document.createElement("form");eR.setAttribute("id",eT+"_form");eR.setAttribute("method",eY.method);eR.setAttribute("enctype","multipart/form-data");eR.setAttribute("encoding","multipart/form-data");eR.setAttribute("target",eT+"_iframe");eX.getShimContainer().appendChild(eR)}if(eS instanceof eL){eS.each(function(e1,eZ){if(e1 instanceof eF){if(eW){eW.setAttribute("name",eZ)}}else{var e0=document.createElement("input");eD.extend(e0,{type:"hidden",name:eZ,value:e1});eR.appendChild(e0)}})}eR.setAttribute("action",eY.url);eV();eR.submit();eU.trigger("loadstart")},getStatus:function(){return eO},getResponse:function(eQ){if("json"===eQ){if(eD.typeOf(eM)==="string"){try{return eE(eM.replace(/^\s*<pre[^>]*>/,"").replace(/<\/pre>\s*$/,""))}catch(eR){return null}}}else{if("document"===eQ){}}return eM},abort:function(){var eQ=this;if(eP&&eP.contentWindow){if(eP.contentWindow.stop){eP.contentWindow.stop()}else{if(eP.contentWindow.document.execCommand){eP.contentWindow.document.execCommand("Stop")}else{eP.src="about:blank"}}}eN.call(this,function(){eQ.dispatchEvent("abort")})}})}return(eH.XMLHttpRequest=eJ)});eB("moxie/runtime/html4/image/Image",["moxie/runtime/html4/Runtime","moxie/runtime/html5/image/Image"],function(eD,eC){return(eD.Image=eC)});T(["moxie/core/utils/Basic","moxie/core/I18n","moxie/core/utils/Mime","moxie/core/utils/Env","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/core/EventTarget","moxie/core/utils/Encode","moxie/runtime/Runtime","moxie/runtime/RuntimeClient","moxie/file/Blob","moxie/file/File","moxie/file/FileInput","moxie/file/FileDrop","moxie/runtime/RuntimeTarget","moxie/file/FileReader","moxie/core/utils/Url","moxie/file/FileReaderSync","moxie/xhr/FormData","moxie/xhr/XMLHttpRequest","moxie/runtime/Transporter","moxie/core/JSON","moxie/image/Image","moxie/core/utils/Events"])})(this);(function(){var ew={},ev=moxie.core.utils.Basic.inArray;(function T(ey){var ex,ez;for(ex in ey){ez=typeof(ey[ex]);if(ez==="object"&&!~ev(ex,["Exceptions","Env","Mime"])){T(ey[ex])}else{if(ez==="function"){ew[ex]=ey[ex]}}}})(window.moxie);ew.Env=window.moxie.core.utils.Env;ew.Mime=window.moxie.core.utils.Mime;ew.Exceptions=window.moxie.core.Exceptions;window.mOxie=ew;if(!window.o){window.o=ew}return ew})();(function(ey,eA,ex){var ew=ey.setTimeout,ez={};function T(eC){var eB=eC.required_features,eD={};function eE(eG,eH,eF){var eI={chunks:"slice_blob",resize:"send_binary_string",jpgresize:"send_binary_string",pngresize:"send_binary_string",progress:"report_upload_progress",multi_selection:"select_multiple",max_file_size:"access_binary",dragdrop:"drag_and_drop",drop_element:"drag_and_drop",headers:"send_custom_headers",canSendBinary:"send_binary",triggerDialog:"summon_file_dialog"};if(eI[eG]){eD[eI[eG]]=eH}else{if(!eF){eD[eG]=eH}}}if(typeof(eB)==="string"){ev.each(eB.split(/\s*,\s*/),function(eF){eE(eF,true)})}else{if(typeof(eB)==="object"){ev.each(eB,function(eG,eF){eE(eF,eG)})}else{if(eB===true){if(!eC.multipart){eD.send_binary_string=true}if(eC.chunk_size>0){eD.slice_blob=true}ev.each(eC,function(eG,eF){eE(eF,!!eG,true)})}}}return eD}var ev={VERSION:"2.0.0beta",STOPPED:1,STARTED:2,QUEUED:1,UPLOADING:2,FAILED:4,DONE:5,GENERIC_ERROR:-100,HTTP_ERROR:-200,IO_ERROR:-300,SECURITY_ERROR:-400,INIT_ERROR:-500,FILE_SIZE_ERROR:-600,FILE_EXTENSION_ERROR:-601,FILE_DUPLICATE_ERROR:-602,IMAGE_FORMAT_ERROR:-700,IMAGE_MEMORY_ERROR:-701,IMAGE_DIMENSIONS_ERROR:-702,mimeTypes:eA.mimes,ua:eA.ua,typeOf:eA.typeOf,extend:eA.extend,guid:eA.guid,each:eA.each,getPos:eA.getPos,getSize:eA.getSize,xmlEncode:function(eC){var eD={"<":"lt",">":"gt","&":"amp",'"':"quot","'":"#39"},eB=/[<>&\"\']/g;return eC?(""+eC).replace(eB,function(eE){return eD[eE]?"&"+eD[eE]+";":eE}):eC},toArray:eA.toArray,inArray:eA.inArray,addI18n:eA.addI18n,translate:eA.translate,isEmptyObj:eA.isEmptyObj,hasClass:eA.hasClass,addClass:eA.addClass,removeClass:eA.removeClass,getStyle:eA.getStyle,addEvent:eA.addEvent,removeEvent:eA.removeEvent,removeAllEvents:eA.removeAllEvents,cleanName:function(eB){var eC,eD;eD=[/[\300-\306]/g,"A",/[\340-\346]/g,"a",/\307/g,"C",/\347/g,"c",/[\310-\313]/g,"E",/[\350-\353]/g,"e",/[\314-\317]/g,"I",/[\354-\357]/g,"i",/\321/g,"N",/\361/g,"n",/[\322-\330]/g,"O",/[\362-\370]/g,"o",/[\331-\334]/g,"U",/[\371-\374]/g,"u"];for(eC=0;eC<eD.length;eC+=2){eB=eB.replace(eD[eC],eD[eC+1])}eB=eB.replace(/\s+/g,"_");eB=eB.replace(/[^a-z0-9_\-\.]+/gi,"");return eB},buildUrl:function(eC,eB){var eD="";ev.each(eB,function(eF,eE){eD+=(eD?"&":"")+encodeURIComponent(eE)+"="+encodeURIComponent(eF)});if(eD){eC+=(eC.indexOf("?")>0?"&":"?")+eD}return eC},formatSize:function(eB){if(eB===ex||/\D/.test(eB)){return ev.translate("N/A")}if(eB>1099511627776){return Math.round(eB/1099511627776,1)+" "+ev.translate("tb")}if(eB>1073741824){return Math.round(eB/1073741824,1)+" "+ev.translate("gb")}if(eB>1048576){return Math.round(eB/1048576,1)+" "+ev.translate("mb")}if(eB>1024){return Math.round(eB/1024,1)+" "+ev.translate("kb")}return eB+" "+ev.translate("b")},parseSize:eA.parseSizeStr,predictRuntime:function(eD,eC){var eB,eE;if(eC){eD.runtimes=eC}eB=new ev.Uploader(eD);eE=eB.runtime;eB.destroy();return eE},addFileFilter:function(eC,eB){ez[eC]=eB}};ev.addFileFilter("mime_types",(function(){var eC,eD;function eB(eE){var eF=[];ev.each(eE,function(eG){ev.each(eG.extensions.split(/,/),function(eH){if(/^\s*\*\s*$/.test(eH)){eF.push("\\.*")}else{eF.push("\\."+eH.replace(new RegExp("["+("/^$.*+?|()[]{}\\".replace(/./g,"\\$&"))+"]","g"),"\\$&"))}})});return new RegExp("("+eF.join("|")+")$","i")}return function(eG,eF,eE){if(!eD||eG!=eC){eD=eB(eG);eC=[].slice.call(eG)}if(!eD.test(eF.name)){this.trigger("Error",{code:ev.FILE_EXTENSION_ERROR,message:ev.translate("File extension error."),file:eF});eE(false)}else{eE(true)}}}()));ev.addFileFilter("max_file_size",function(eE,eC,eB){var eD;if(eC.size!==eD&&eE&&eC.size>eE){this.trigger("Error",{code:ev.FILE_SIZE_ERROR,message:ev.translate("File size error."),file:eC});eB(false)}else{eB(true)}});ev.addFileFilter("prevent_duplicates",function(eE,eC,eB){if(eE){var eD=this.files.length;while(eD--){if(eC.name===this.files[eD].name&&eC.size===this.files[eD].size){this.trigger("Error",{code:ev.FILE_DUPLICATE_ERROR,message:ev.translate("Duplicate file error."),file:eC});eB(false);return}}}eB(true)});ev.Uploader=function(eF){var eC=[],eP={},eM={},eE,eK,eH=false,eI,eJ,eO;function eD(){var eS,eT=0,eR;if(this.state==ev.STARTED){for(eR=0;eR<eC.length;eR++){if(!eS&&eC[eR].status==ev.QUEUED){eS=eC[eR];if(this.trigger("BeforeUpload",eS)){eS.status=ev.UPLOADING;this.trigger("UploadFile",eS)}}else{eT++}}if(eT==eC.length){if(this.state!==ev.STOPPED){this.state=ev.STOPPED;this.trigger("StateChanged")}this.trigger("UploadComplete",eC)}}}function eN(eR){eR.percent=eR.size>0?Math.ceil(eR.loaded/eR.size*100):100;eG()}function eG(){var eS,eR;eK.reset();for(eS=0;eS<eC.length;eS++){eR=eC[eS];if(eR.size!==ex){eK.size+=eR.origSize;eK.loaded+=eR.loaded*eR.origSize/eR.size}else{eK.size=ex}if(eR.status==ev.DONE){eK.uploaded++}else{if(eR.status==ev.FAILED){eK.failed++}else{eK.queued++}}}if(eK.size===ex){eK.percent=eC.length>0?Math.ceil(eK.uploaded/eC.length*100):0}else{eK.bytesPerSec=Math.ceil(eK.loaded/((+new Date()-eE||1)/1000));eK.percent=eK.size>0?Math.ceil(eK.loaded/eK.size*100):0}}function eB(){var eR=this,eT=0;var eS={accept:eF.filters.mime_types,runtime_order:eF.runtimes,required_caps:eM,swf_url:eF.flash_swf_url,xap_url:eF.silverlight_xap_url};ev.each(eF.runtimes.split(/\s*,\s*/),function(eU){if(eF[eU]){eS[eU]=eF[eU]}});eA.inSeries([function(eU){if(eF.browse_button){eI=new eA.FileInput(ev.extend({},eS,{name:eF.file_data_name,multiple:eF.multi_selection,container:eF.container,browse_button:eF.browse_button}));eI.onready=function(){var eV=eA.Runtime.getInfo(this.ruid);eA.extend(eR.features,{chunks:eV.can("slice_blob"),multipart:eV.can("send_multipart"),multi_selection:eV.can("select_multiple")});eT++;eU()};eI.onchange=function(){eR.addFile(this.files)};eI.bind("mouseenter mouseleave mousedown mouseup",function(eW){if(!eH){var eV=eA.get(eF.browse_button);if(eV){if(eF.browse_button_hover){if("mouseenter"===eW.type){eA.addClass(eV,eF.browse_button_hover)}else{if("mouseleave"===eW.type){eA.removeClass(eV,eF.browse_button_hover)}}}if(eF.browse_button_active){if("mousedown"===eW.type){eA.addClass(eV,eF.browse_button_active)}else{if("mouseup"===eW.type){eA.removeClass(eV,eF.browse_button_active)}}}eV=null}}});eI.bind("error runtimeerror",function(){eI=null;eU()});eI.init()}else{eU()}},function(eU){if(eF.drop_element){eJ=new eA.FileDrop(ev.extend({},eS,{drop_zone:eF.drop_element}));eJ.onready=function(){var eV=eA.Runtime.getInfo(this.ruid);eR.features.dragdrop=eV.can("drag_and_drop");eT++;eU()};eJ.ondrop=function(){eR.addFile(this.files)};eJ.bind("error runtimeerror",function(){eJ=null;eU()});eJ.init()}else{eU()}}],function(){if(typeof(eF.init)=="function"){eF.init(eR)}else{ev.each(eF.init,function(eV,eU){eR.bind(eU,eV)})}if(eT){eR.trigger("PostInit")}else{eR.trigger("Error",{code:ev.INIT_ERROR,message:ev.translate("Init error.")})}})}function eQ(eS,eR){if(eS.ruid){var eT=eA.Runtime.getInfo(eS.ruid);if(eT){return eT.can(eR)}}return false}function eL(eT,eV,eR){var eS=new eA.Image();try{eS.onload=function(){eS.downsize(eV.width,eV.height,eV.crop,eV.preserve_headers)};eS.onresize=function(){eR(this.getAsBlob(eT.type,eV.quality));this.destroy()};eS.onerror=function(){eR(eT)};eS.load(eT)}catch(eU){eR(eT)}}eK=new ev.QueueProgress();eF=ev.extend({runtimes:eA.Runtime.order,max_retries:0,multipart:true,multi_selection:true,file_data_name:"file",flash_swf_url:"js/Moxie.swf",silverlight_xap_url:"js/Moxie.xap",send_chunk_number:true},eF);if(eF.resize){eF.resize=ev.extend({preserve_headers:true,crop:false},eF.resize)}if(ev.typeOf(eF.filters)==="array"){eF.filters={mime_types:eF.filters}}eF.filters=ev.extend({mime_types:[],prevent_duplicates:!!eF.prevent_duplicates,max_file_size:eF.max_file_size},eF.filters);eF.filters.max_file_size=ev.parseSize(eF.filters.max_file_size)||0;eF.chunk_size=ev.parseSize(eF.chunk_size)||0;eF.required_features=eM=T(ev.extend({},eF));ev.extend(this,{id:ev.guid(),state:ev.STOPPED,features:{},runtime:eA.Runtime.thatCan(eM,eF.runtimes),files:eC,settings:eF,total:eK,init:function(){var eR=this;eF.browse_button=eA.get(eF.browse_button);eF.drop_element=eA.get(eF.drop_element);if(typeof(eF.preinit)=="function"){eF.preinit(eR)}else{ev.each(eF.preinit,function(eT,eS){eR.bind(eS,eT)})}if(!eF.browse_button||!eF.url){this.trigger("Error",{code:ev.INIT_ERROR,message:ev.translate("Init error.")});return}eR.bind("FilesAdded",function(eT,eS){[].push.apply(eC,eS);ew(function(){eR.trigger("QueueChanged");eR.refresh()},1)});eR.bind("CancelUpload",function(){if(eO){eO.abort()}});if(eF.unique_names){eR.bind("BeforeUpload",function(eS,eT){var eV=eT.name.match(/\.([^.]+)$/),eU="part";if(eV){eU=eV[1]}eT.target_name=eT.id+"."+eU})}eR.bind("UploadFile",function(e0,eX){var eU=e0.settings.url,eV=e0.features,eY=eF.chunk_size,e1=eF.max_retries,eS,eZ=0;if(eX.loaded){eZ=eX.loaded=eY*Math.floor(eX.loaded/eY)}function eW(){if(e1-->0){ew(eT,1)}else{eX.loaded=eZ;e0.trigger("Error",{code:ev.HTTP_ERROR,message:ev.translate("HTTP Error."),file:eX,response:eO.responseText,status:eO.status,responseHeaders:eO.getAllResponseHeaders()})}}function eT(){var e4,e3,e2,e5;if(eX.status==ev.DONE||eX.status==ev.FAILED||e0.state==ev.STOPPED){return}e2={name:eX.target_name||eX.name};if(eY&&eV.chunks&&eS.size>eY){e5=Math.min(eY,eS.size-eZ);e4=eS.slice(eZ,eZ+e5)}else{e5=eS.size;e4=eS}if(eY&&eV.chunks){if(eF.send_chunk_number){e2.chunk=Math.ceil(eZ/eY);e2.chunks=Math.ceil(eS.size/eY)}else{e2.offset=eZ;e2.total=eS.size}}else{e2.chunk=0;e2.chunks=1}eO=new eA.XMLHttpRequest();eO.withCredentials=true;if(eO.upload){eO.upload.onprogress=function(e6){eX.loaded=Math.min(eX.size,eZ+e6.loaded);e0.trigger("UploadProgress",eX)}}eO.onload=function(){if(eO.status>=400){eW();return}if(e5<eS.size){e4.destroy();eZ+=e5;eX.loaded=Math.min(eZ,eS.size);e0.trigger("ChunkUploaded",eX,{offset:eX.loaded,total:eS.size,response:eO.responseText,status:eO.status,responseHeaders:eO.getAllResponseHeaders()});if(eA.Env.browser==="Android Browser"){e0.trigger("UploadProgress",eX)}}else{eX.loaded=eX.size}e4=e3=null;if(!eZ||eZ>=eS.size){if(eX.size!=eX.origSize){eS.destroy();eS=null}e0.trigger("UploadProgress",eX);eX.status=ev.DONE;e0.trigger("FileUploaded",eX,{response:eO.responseText,status:eO.status,responseHeaders:eO.getAllResponseHeaders()})}else{e1=eF.max_retries;ew(eT,1)}};eO.onerror=function(){eW()};eO.onloadend=function(){this.destroy();eO=null};if(e0.settings.multipart&&eV.multipart){e2.name=eX.target_name||eX.name;eO.open("post",eU,true);ev.each(e0.settings.headers,function(e7,e6){eO.setRequestHeader(e6,e7)});e3=new eA.FormData();ev.each(ev.extend(e2,e0.settings.multipart_params),function(e7,e6){e3.append(e6,e7)});e3.append(e0.settings.file_data_name,e4);eO.send(e3,{runtime_order:e0.settings.runtimes,required_caps:eM,swf_url:e0.settings.flash_swf_url,xap_url:e0.settings.silverlight_xap_url})}else{eU=ev.buildUrl(e0.settings.url,ev.extend(e2,e0.settings.multipart_params));eO.open("post",eU,true);eO.setRequestHeader("Content-Type","application/octet-stream");ev.each(e0.settings.headers,function(e7,e6){eO.setRequestHeader(e6,e7)});eO.send(e4,{runtime_order:e0.settings.runtimes,required_caps:eM,swf_url:e0.settings.flash_swf_url,xap_url:e0.settings.silverlight_xap_url})}}eS=eX.getSource();if(!eA.isEmptyObj(e0.settings.resize)&&eQ(eS,"send_binary_string")&&!!~eA.inArray(eS.type,["image/jpeg","image/png"])){eL.call(this,eS,e0.settings.resize,function(e2){eS=e2;eX.size=e2.size;eT()})}else{eT()}});eR.bind("UploadProgress",function(eS,eT){eN(eT)});eR.bind("StateChanged",function(eS){if(eS.state==ev.STARTED){eE=(+new Date())}else{if(eS.state==ev.STOPPED){for(var eT=eS.files.length-1;eT>=0;eT--){if(eS.files[eT].status==ev.UPLOADING){eS.files[eT].status=ev.QUEUED;eG()}}}}});eR.bind("QueueChanged",eG);eR.bind("Error",function(eS,eT){if(eT.file){eT.file.status=ev.FAILED;eN(eT.file);if(eS.state==ev.STARTED){ew(function(){eD.call(eR)},1)}}});eR.bind("FileUploaded",function(){eG();ew(function(){eD.call(eR)},1)});eR.trigger("Init",{runtime:this.runtime});eB.call(this)},refresh:function(){if(eI){eI.trigger("Refresh")}this.trigger("Refresh")},start:function(){if(this.state!=ev.STARTED){this.state=ev.STARTED;this.trigger("StateChanged");eD.call(this)}},stop:function(){if(this.state!=ev.STOPPED){this.state=ev.STOPPED;this.trigger("StateChanged");this.trigger("CancelUpload")}},disableBrowse:function(){eH=arguments[0]!==ex?arguments[0]:true;if(eI){eI.disable(eH)}this.trigger("DisableBrowse",eH)},getFile:function(eS){var eR;for(eR=eC.length-1;eR>=0;eR--){if(eC[eR].id===eS){return eC[eR]}}},addFile:function(eS,eT){var eY=this,eV=[],eR=[],eX;function eU(){var e0=eJ||eI;if(e0){return e0.getRuntime().uid}return false}function eW(e2,e1){var e0=[];eA.each(eY.settings.filters,function(e4,e3){if(ez[e3]){e0.push(function(e5){ez[e3].call(eY,e4,e2,function(e6){e5(!e6)})})}});eA.inSeries(e0,e1)}function eZ(e0){var e1=eA.typeOf(e0);if(e0 instanceof eA.File){if(!e0.ruid&&!e0.isDetached()){if(!eX){return false}e0.ruid=eX;e0.connectRuntime(eX)}eZ(new ev.File(e0))}else{if(e0 instanceof eA.Blob){eZ(e0.getSource());e0.destroy()}else{if(e0 instanceof ev.File){if(eT){e0.name=eT}eV.push(function(e2){eW(e0,function(e3){if(!e3){eR.push(e0)}e2()})})}else{if(eA.inArray(e1,["file","blob"])!==-1){eZ(new eA.File(null,e0))}else{if(e1==="node"&&eA.typeOf(e0.files)==="filelist"){eA.each(e0.files,eZ)}else{if(e1==="array"){eT=null;eA.each(e0,eZ)}}}}}}}eX=eU();eZ(eS);if(eV.length){eA.inSeries(eV,function(){if(eR.length){eY.trigger("FilesAdded",eR)}})}},removeFile:function(eS){var eT=typeof(eS)==="string"?eS:eS.id;for(var eR=eC.length-1;eR>=0;eR--){if(eC[eR].id===eT){return this.splice(eR,1)[0]}}},splice:function(eT,eR){var eS=eC.splice(eT===ex?0:eT,eR===ex?eC.length:eR);this.trigger("FilesRemoved",eS);this.trigger("QueueChanged");ev.each(eS,function(eU){eU.destroy()});return eS},trigger:function(eS){var eU=eP[eS.toLowerCase()],eT,eR;if(eU){eR=Array.prototype.slice.call(arguments);eR[0]=this;for(eT=0;eT<eU.length;eT++){if(eU[eT].func.apply(eU[eT].scope,eR)===false){return false}}}return true},hasEventListener:function(eR){return !!eP[eR.toLowerCase()]},bind:function(eR,eT,eS){var eU;eR=eR.toLowerCase();eU=eP[eR]||[];eU.push({func:eT,scope:eS||this});eP[eR]=eU},unbind:function(eR){eR=eR.toLowerCase();var eU=eP[eR],eS,eT=arguments[1];if(eU){if(eT!==ex){for(eS=eU.length-1;eS>=0;eS--){if(eU[eS].func===eT){eU.splice(eS,1);break}}}else{eU=[]}if(!eU.length){delete eP[eR]}}},unbindAll:function(){var eR=this;ev.each(eP,function(eT,eS){eR.unbind(eS)})},destroy:function(){this.stop();ev.each(eC,function(eR){eR.destroy()});eC=[];if(eI){eI.destroy();eI=null}if(eJ){eJ.destroy();eJ=null}eM={};eE=eK=eH=eO=null;this.trigger("Destroy");this.unbindAll();eP={}}})};ev.File=(function(){var eC={};function eB(eD){ev.extend(this,{id:ev.guid(),name:eD.name||eD.fileName,type:eD.type||"",size:eD.size||eD.fileSize,origSize:eD.size||eD.fileSize,loaded:0,percent:0,status:ev.QUEUED,lastModifiedDate:eD.lastModifiedDate||(new Date()).toLocaleString(),getNative:function(){var eE=this.getSource().getSource();return eA.inArray(eA.typeOf(eE),["blob","file"])!==-1?eE:null},getSource:function(){if(!eC[this.id]){return null}return eC[this.id]},destroy:function(){var eE=this.getSource();if(eE){eE.destroy();delete eC[this.id]}}});eC[this.id]=eD}return eB}());ev.QueueProgress=function(){var eB=this;eB.size=0;eB.loaded=0;eB.uploaded=0;eB.failed=0;eB.queued=0;eB.percent=0;eB.bytesPerSec=0;eB.reset=function(){eB.size=eB.loaded=eB.uploaded=eB.failed=eB.queued=eB.percent=eB.bytesPerSec=0}};ey.plupload=ev}(window,mOxie));var dY,ah,cw,de,b9,dp,a3,bk=[].indexOf||function(ew){for(var ev=0,T=this.length;ev<T;ev++){if(ev in this&&this[ev]===ew){return ev}}return -1};b9=INLINE_JS.Upload=A.Upload={QUEUE_EVT:"db:upload:queue",QUEUE_ERROR_EVT:"db:upload:queue_error",UPDATE_EVT:"db:upload:update",COMPLETE_EVT:"db:upload:complete",ERROR_EVT:"db:upload:error",CANCEL_EVT:"db:upload:cancel",CHOOSE_FILE_BASIC:"db:upload:choose_file_basic",APPLE_PACKAGE_EXTENSIONS:["pages","key","app","numbers","band","photolibrary","rcproject","rtfd","graffle","logic","logicx","lpdf","sketch","screenflow","scriv","dvdproj","mindnode","cmproj","xcodeproj","imovielibrary","mpkg","imovieproject","1password","agilekeychain","fcpbundle","abbu","mindnode","theater","gameproj","aplibrary","itlp","lrdata","ydevice","bundle","framework","plugin","kext","pkg"],APPLE_PACKAGE_ERROR:-54321,current_dest:"",runtimes:(function(){var ew,ev,ex,T;ex={"MSIE 8.0":"flash","MSIE 9.0":"flash"};ev="html5";for(ew in ex){T=ex[ew];if(navigator.userAgent.indexOf(ew)!==-1){ev=T}}return ev})(),choose_button_id:"choose-button",set_dest:function(T){cS.fillVal(T,"dest-folder");return this.current_dest=T},init:function(ew,ex,ey,ev){var T;this.set_dest(ew);T=this.initPLU(ey,ev);if(!ex){ae.window_load(T)}else{T()}bf("#flash-upload-container > .moxie-shim").each(function(ez){if(ez.observe){ds.freshbutton_overlay(ez,$("choose-button"));return ds.freshbutton_overlay(ez,$("add-button"))}});return ah.clear()},init_basic:function(){ds.freshbutton_overlay($("file-box"),$("basic-choose-button"));$("file-box").observe("click",function(T){return document.fire(b9.CHOOSE_FILE_BASIC)});$("basic-choose-button").observe("mousemove",function(ew){var ev,T,ex;ev=$("modal").cumulativeOffset();ex=ew.clientY-ev.top-3;T=ew.clientX-ev.left-$("file-box").getWidth()+3;return $("file-box").setStyle({top:ex+"px",left:T+"px"})});return $("file-box").observe("change",function(){var ey,ew,ez,ex,T,ev;ep.hide=function(){};$("modal-x").hide();$("basic-upload-desc").hide();$("basic-upload-buttons").hide();$("file-box").hide();ew=$("file-box").getValue().split("\\").pop();ex=b6.make("web",an.file_icon(ew));$("basic-upload-status").down(".icon").__date(ex);ey=dU("Uploading %(filename)s").format({filename:bt.em_snippet(ew,25)});$("basic-upload-status").down(".file-desc").__date(ey);$("basic-upload-status").show();$("basic-uploading-message").show();ez=$("file-box").files;ev=0;if(ez){T=ez[0].lastModifiedDate;if(T){ev=Math.round(Date.parse(T)/1000)||0}}if(!ev){ev=Math.round(Date.parse(new Date)/1000)}$("mtime-utc").value=ev;return $("basic-upload-form").submit()})},initPLU:function(ev,T){return(function(ew){return function(){var ey,ex;ey={url:"https://"+Constants.BLOCK_CLUSTER+"/chunked_upload",file_data_name:"file",runtimes:ew.runtimes,multipart_params:{},multipart:false,max_file_size:"10000mb",chunk_size:"8mb",max_retries:2,browse_button:ew.choose_button_id,container:"flash-upload-container",preinit:{PostInit:function(){if(ev){ev()}return ew.uploaderLoaded()},Error:ew.uploadError.bind(ew)},init:{FilesAdded:ew.fileQueued.bind(ew),UploadProgress:ew.uploadProgress.bind(ew),FileUploaded:ew.uploadSuccess.bind(ew),BeforeUpload:ew.prepareFileForUploading.bind(ew),ChunkUploaded:ew.chunkUploaded.bind(ew),UploadComplete:ah.finished.bind(ah),Refresh:function(){if(ew.PLU.runtime==="flash"&&$("upload-running-buttons").visible()){bf("#flash-upload-container").clonePosition(bf("#add-button"));bf("#flash-upload-container > .moxie-shim")[0].style.width="100%";return bf("#flash-upload-container > .moxie-shim")[0].style.height="100%"}}},flash_swf_url:Constants.static_url_moxie_swf};if(T!=null){bf.extend(ey,T)}ex=new plupload.Uploader(ey);ew.PLU=ex;return ew.PLU.init()}})(this)},reset:function(){if(ah.uploading&&ah.current_file){this.PLU.removeFile(ah.current_file)}return cw.hide()},show_upload:function(){$("upload-desc").hide();$("dnd-upload-desc").hide();$("upload-files-list").show();$("upload-start-buttons").hide();$("upload-running-buttons").show();$("hide-button").show();$("done-button").hide();if(!$("modal-overlay").visible()){return cw.show()}},updatePostParams:function(ew){var ev,T;T=this.PLU.settings.multipart_params;for(ev in ew){if(ew.hasOwnProperty(ev)){T[ev]=ew[ev]}}return this.PLU.settings.multipart_params=T},fileQueued:function(ev,ez){var ey,ex,T,ew;for(ex=0,T=ez.length;ex<T;ex++){ey=ez[ex];if((typeof ey.getNative==="function"?(ew=ey.getNative())!=null?ew.dest:void 0:void 0)===void 0){ey.dest=b9.current_dest}else{ey.dest=ey.getNative().dest}}document.fire(this.QUEUE_EVT,{files:ez});bf(document).trigger(this.QUEUE_EVT,{files:ez});if(R.is_quicksend_dest(ey.dest)){return}return this.show_upload()},uploadNext:function(){var ew,T,ev,ex;ev=ah.next();T=($u.contains(b9.APPLE_PACKAGE_EXTENSIONS,an.file_extension_for_logging(ev.name))&&ev.size%34===0)||(an.file_extension_for_logging(ev.name)===""&&ev.size%34===0&&ev.size<=3400);if(T){ev.status=plupload.FAILED;ew={file:ev,code:b9.APPLE_PACKAGE_ERROR,message:dU("Can\u2019t Upload"),tooltip_text:dU('To upload a package file via the web, try zipping it first, or <a href="https://www.dropbox.com/help/6691" target="_blank">learn more</a>.'),response:"",responseHeaders:"",status:400};this.uploadError(this.PLU,ew);return false}ex={dest:ah.next().dest,t:a8.read(Constants.JS_CSRF_COOKIE)};ex[Constants.UID_PARAM_NAME]=b2.active_user;b9.updatePostParams(ex);this.PLU.start();ah.last_update_time=0;ah.last_update_size=0;return true},pause:function(){return b9.PLU.stop()},uploadProgress:function(ev,T){if(!ah.cancelled_files[T.id]){document.fire(this.UPDATE_EVT,{file:T,percent_complete:T.loaded/T.size});return bf(document).trigger(this.UPDATE_EVT,{file:T,percent_complete:T.loaded/T.size})}},generateUploadId:function(){var T,ev,ex,ew;T="";for(ev=ew=0;ew<=15;ev=++ew){T+=String.fromCharCode(Math.floor(Math.random()*256))}ex=ac.encode(T);ex=ex.replace(/\+/g,"-");ex=ex.replace(/\//g,"_");ex=ex.replace(/\=*$/,"");return ex},chunkUploaded:function(ev,ew,ex){var T;T=JSON.parse(ex.response||"");return this.updatePostParams({offset:T.offset})},prepareFileForUploading:function(){var T;T=ah.next();return this.updatePostParams({reported_total_size:T.size,dest:T.dest,t:a8.read(Constants.JS_CSRF_COOKIE),upload_id:this.generateUploadId(),offset:0})},uploadSuccess:function(ey,ex,ew){var ev,T;try{T=JSON.parse(ew.response)}catch(ez){ev=ez;T=null}if(ew.response==="{'error': 'quota'}"){document.fire(this.ERROR_EVT,{file:ex,message:dU("Quota exceeded"),tooltip_text:dU("Your upload failed because you are over quota.")});return bf(document).trigger(this.ERROR_EVT,{file:ex,message:dU("Quota exceeded"),tooltip_text:dU("Your upload failed because you are over quota.")})}else{if(ew.response==="{'error': 'empty'}"){document.fire(this.CANCEL_EVT,{file:ex,message:dU("Empty File")});return bf(document).trigger(this.CANCEL_EVT,{file:ex,message:dU("Empty File")})}else{if(ew.response==="{'error': 'ignored'}"){document.fire(this.CANCEL_EVT,{file:ex,message:dU("File Ignored")});return bf(document).trigger(this.CANCEL_EVT,{file:ex,message:dU("File Ignored")})}else{if((T!=null?T.status:void 0)==="complete"){document.fire(this.COMPLETE_EVT,{file:ex});return bf(document).trigger(this.COMPLETE_EVT,{file:ex})}else{document.fire(this.ERROR_EVT,{file:ex});return bf(document).trigger(this.ERROR_EVT,{file:ex})}}}}},uploadComplete:function(ev,T){document.fire(this.COMPLETE_EVT,{file:T});return bf(document).trigger(this.COMPLETE_EVT,{file:T})},uploadError:function(ey,T){var ex,ev,ew;if((ew=T.file.id,bk.call(ah.file_ids(),ew)<0)&&T.code!==b9.APPLE_PACKAGE_ERROR){document.fire(this.QUEUE_EVT,{files:[T.file]});bf(document).trigger(this.QUEUE_EVT,{files:[T.file]})}ev=(function(){switch(T.code){case plupload.FILE_SIZE_ERROR:return dU("File too large");default:return dU("Upload Error")}})();this.show_upload();ex={file:T.file,error_code:T.code,message:ev};if(T!=null?T.tooltip_text:void 0){ex.tooltip_text=T.tooltip_text}document.fire(this.ERROR_EVT,ex);return bf(document).trigger(this.ERROR_EVT,ex)},grabURL:function(){var T;T=$F("file-box");if(/(^http|^https|^ftp):\/\//.match(T)){$("url").value=T}return true},treeview_handler:function(ev,T){var ew;cS.fillVal(ev,"dest-folder");ew=$("basic-uploader-url");if(ew){ew.href=ew.href.replace(/(\/upload)(.*)(\?basic=1)/,function(ez,ey,eA,ex){return ey+ds.urlquote(ev)+ex})}return ah.clear()},new_folder:function(){bC.hide();ep.show(dU("Create new folder..."),cS.fromElm("create-folder"),{action:this.do_new_folder.bind(this,b2.active_user),wit_group:"new-folder-confirm"});if(!ds.ie){return bf("#first-treeview-link").trigger("click")}},do_new_folder:function(T){var ew,ev;if(!ep.vars.selected_path){Y.error(dU("Please select a parent folder."));return}ev=$F("entered-name");ew=ep.vars.selected_path;return new Ajax.DBRequest("/cmd/new"+ds.urlquote(ew)+"?to_path="+ds.urlquote(ev),{subject_user:T,onSuccess:(function(ex){return function(ey){ex.treeview_handler(an.normalize(ew)+"/"+ev);return bC.schedule_reset()}})(this),cleanUp:function(){}})},uploaderLoaded:function(){$("upload-loading").hide();$("choose-button").show();if(b9.PLU.runtime==="flash"){bf("#flash-upload-container").clonePosition(bf("#choose-button"));bf("#flash-upload-container > .moxie-shim")[0].style.top="0px";bf("#flash-upload-container > .moxie-shim")[0].style.left="0px";bf("#flash-upload-container > .moxie-shim")[0].style.width="100%";return bf("#flash-upload-container > .moxie-shim")[0].style.height="100%"}else{bf("#"+this.choose_button_id).click((function(T){return function(ev){return bf("#"+T.PLU.id+"_html5").click()}})(this));return bf("#add-button").click((function(T){return function(ev){return bf("#choose-button").click()}})(this))}}};ah=A.FileQueue={init:function(){return ah._listen()},_listen:function(){document.observe(b9.QUEUE_EVT,ah._file_queued.bind(this));document.observe(b9.QUEUE_ERROR_EVT,ah._file_queue_errored.bind(this));document.observe(b9.UPDATE_EVT,ah._file_updated.bind(this));document.observe(b9.COMPLETE_EVT,ah._file_completed.bind(this));document.observe(b9.ERROR_EVT,ah._file_errored.bind(this));return document.observe(b9.CANCEL_EVT,ah._file_cancelled.bind(this))},_file_queued:function(ez){var ew,ey,ev,ex,T;ex=ez.memo.files;T=[];for(ey=0,ev=ex.length;ey<ev;ey++){ew=ex[ey];this.files[ew.id]=ew;if(!ah.uploading){this._start_uploading()}this.current_file=ew;T.push(d0("File queued:",ew.name))}return T},_file_queue_errored:function(T){this._file_queued(T);return setTimeout(((function(ev){return function(){return ev._file_errored(T)}})(this)),250)},_file_updated:function(eC){var ex,T,ev,ew,eA,ez,ey,eB,eD;ew=eC.memo.file;ez=eC.memo.percent_complete;eA=ez*ew.size;eD=eA+this.completed_size();ev=new Date().getTime();if(this.last_update_time){ey=(ev-this.last_update_time)/1000;if(b9.PLU.total.bytesPerSec){this.average_bps=b9.PLU.total.bytesPerSec}else{T=eA-this.last_update_size;ex=T/ey;this.average_bps=((eD-T)*this.average_bps+T*ex)/eD}eB=(this.queue_size()-eD)/this.average_bps;this.formatted_time=bE.format_time(eB+this.num_left())}this.current_file=ew;this.last_update_time=new Date().getTime();return this.last_update_size=eA},_file_completed:function(ev){var T;T=ev.memo.file;this.completed_files[T.id]=true;d0("File completed:",T.name);return this._check_if_finished(T)},_file_errored:function(ev){var T;T=ev.memo.file;this.errored_files[T.id]=true;dY.update_errors();cw.update_errors();d0("File errored:",T.name);return this._check_if_finished(T)},_file_cancelled:function(ev){var T;T=ev.memo.file;this.cancelled_files[T.id]=true;if(T.status===plupload.UPLOADING){b9.PLU.stop();b9.PLU.removeFile(T);b9.PLU.start()}else{b9.PLU.removeFile(T)}d0("File cancelled:",T.name);return this._check_if_finished(T)},_start_uploading:function(){var T;this.uploading=b9.uploadNext();if(this.uploading){this.all_cancelled=false;return window.onbeforeunload=T=(function(ev){return function(){return dU("Leaving this page will cancel your uploads.")}})(this)}},finished:function(){return this._finished_uploading()},_check_if_finished:function(T){if(this.empty()){if(this.uploading){return this._finished_uploading()}}else{return b9.uploadNext()}},_finished_uploading:function(){var ev,ew,ex,T;this.uploading=false;if(!this.num_files()){dY.cancelled()}else{if(this.errors()){dY.errored();cw.errored()}else{dY.completed();cw.completed()}}T=$("inline-upload-status").visible();b2.select_fq_paths=[];if(b2.inside_dir){for(ex in this.completed_files){ew=this.files[ex];ev=an.normalize(ew.dest);b2.select_fq_paths.push(""+ev+"/"+ew.name)}b2.force_reload()}else{if(b2.in_search_mode()){bJ.force_reload()}}if(T){cw.show()}ep.onHide=null;return window.onbeforeunload=null},empty:function(){return !this.num_left()},num_files:function(){return this.file_ids().length},num_non_cancelled_files:function(){return this.file_ids().length-this.cancels()},next:function(){return $u(this.files).filter((function(T){return function(ev){return !(T.cancelled_files[ev.id]||T.errored_files[ev.id]||T.completed_files[ev.id])}})(this))[0]},cancels:function(){return $u(this.cancelled_files).keys().length},errors:function(){return $u(this.errored_files).keys().length},queue_size:function(){var ev,ez,ew,ey,T,ex;ew=0;ex=this.file_ids();for(ey=0,T=ex.length;ey<T;ey++){ez=ex[ey];ev=this.files[ez];if(!this.errored_files[ez]&&!this.cancelled_files[ez]&&typeof ev.size!=="undefined"){ew+=ev.size}}return ew},completed_size:function(){var ey,ev,ex,T,ew;ev=0;ew=$u(this.completed_files).keys();for(ex=0,T=ew.length;ex<T;ex++){ey=ew[ex];if(typeof this.files[ey].size!=="undefined"){ev+=this.files[ey].size}}return ev},file_ids:function(){return $u(this.files).map((function(T){return function(ev,ew){return ew}})(this))},totalPercentage:function(){return this.completed_size()/this.queue_size()},num_left:function(){return $u(this.file_ids()).filter((function(T){return function(ev){return !(T.cancelled_files[ev]||T.errored_files[ev]||T.completed_files[ev])}})(this)).length},clear:function(){this.files={};this.cancelled_files={};this.all_cancelled=false;this.errored_files={};this.completed_files={};this.last_update_time=0;this.last_update_size=0;this.average_bps=0;this.formatted_time="";this.uploading=false;window.onbeforeunload=null;if(typeof ep!=="undefined"&&ep!==null){return ep.onHide=null}}};ah.clear();dp=A.UploadFile={FILENAME_SNIPPET_LENGTH:15,DEST_SNIPPET_LENGTH:13,_tmpl:null,init:function(){dp._tmpl=es.tmpl("upload_list_item_tmpl");return dp._listen()},_listen:function(){document.observe(b9.QUEUE_EVT,dp._file_queued);document.observe(b9.QUEUE_ERROR_EVT,dp._file_queue_errored);document.observe(b9.UPDATE_EVT,dp._file_updated);document.observe(b9.COMPLETE_EVT,dp._file_completed);document.observe(b9.ERROR_EVT,dp._file_errored);return document.observe(b9.CANCEL_EVT,dp._file_cancelled)},_file_queued:function(ez){var ew,ey,ev,ex,T;ex=ez.memo.files;T=[];for(ey=0,ev=ex.length;ey<ev;ey++){ew=ex[ey];T.push((function(eE){var eD,eH,eG,eC,eB,eA,eF;eD=eE.dest;if(R.is_quicksend_dest(eD)){R.add_external_file(eE);return}eB=at.format_bytes(eE.size||0);eH=dp._tmpl({file:eE,icon:an.file_icon(eE.name),filename_snippet:bt.em_snippet(eE.name,dp.FILENAME_SNIPPET_LENGTH),size:eB,dest:eD,dest_snippet:bt.em_snippet(dU("Dropbox")+eD,dp.DEST_SNIPPET_LENGTH,0),Sprite:b6});$("upload-files-list").__sert(eH);eG=$(eE.id);eC=ah.num_files();eA=$("upload-files-list");if(eC<=6){eA.removeClassName("scroll")}else{eA.addClassName("scroll")}eA.scrollTop=eA.scrollHeight;eG.down(".dest").observe("click",function(){b2.reload_fqpath(eG.readAttribute("data-dest"),true);return ep.hide()});eF=eG.down(".status-col").down("a.small-x-button");eF.stopObserving("click");eF.observe("click",function(eI){document.fire(b9.CANCEL_EVT,{file:eE});return bf(document).trigger(b9.CANCEL_EVT,{file:eE})});return eG.down(".upload-progress-bar").setStyle({width:"0"})})(ew))}return T},_file_queue_errored:function(T){dp._file_queued(T);return dp._file_errored(T)},_file_updated:function(ex){var ew,ey,ev,T;ew=ex.memo.file;ey=$(ew.id);if(ah.num_files()===1){T=dU("%(time_left)s left").format({time_left:ah.formatted_time});ey.down(".time-col").__date(T)}ev=parseInt(ew.percent,10)+"%";if(ev==="100%"){ey.down(".time-col").__date();ey.down(".status-col").__date(new Element("img",{src:"/static/images/icons/ajax-loading-small.gif"}))}return ey.down(".upload-progress-bar").setStyle({width:ev})},_file_completed:function(ev){var T,ew;T=ev.memo.file;T.completed=true;ew=$(T.id);ew.addClassName("complete");setTimeout(function(){return ew.down(".status-col").__date(b6.make("web","s_check"))},0);return ew.down(".upload-progress-bar").setStyle({width:"100%"})},_file_errored:function(ev){var T,ew;T=ev.memo.file;ew=$(T.id);if(ew){return dp._actual_file_errored(ev)}else{return setTimeout((function(ex){return function(){return dp._actual_file_errored(ev)}})(this),0)}},_actual_file_errored:function(ey){var T,ew,ev,ez,ex;ev=ey.memo.file;ez=$(ev.id);ez.addClassName("error");ez.down(".dest-col").hide();ez.down(".time-col").__date();ez.down(".status-col").__date(b6.make("web","nosync"));ez.down(".upload-progress-bar").setStyle({width:"100%"});if(R.is_quicksend_dest(ev.dest)){return}ew=ey.memo.message||dU("Upload Error");T=void 0;if(ey.memo.tooltip_text){T=ey.memo.tooltip_text}else{T=dU('Something went wrong with the advanced uploader. If the problem persists, please use the <a id="basic_link">basic uploader</a> to upload via the website.');bf(document).on("click","a#basic_link",function(){c0.show_basic_upload();return false})}ez.down(".error-msg").__date(ew);ex=ez.down(".error-details");ex.observe("mouseover",function(){return dG.show(ex,T)});return ez.down(".error-col").show()},_file_cancelled:function(ev){var T,ew;T=ev.memo.file;ew=$(T.id);ew.addClassName("cancelled");ew.down(".dest-col").__date(dU(ev.memo.message||"Canceled"));ew.down(".time-col").__date();ew.down(".status-col").__date(b6.make("web","cancelsync"));return ew.down(".upload-progress-bar").setStyle({width:"100%"})}};dY=A.BulkUpload={init:function(){this.elem=$("bulk-upload-status");return dY._listen()},_listen:function(){document.observe(b9.QUEUE_EVT,dY._file_queued.bind(this));return document.observe(b9.UPDATE_EVT,dY._file_updated.bind(this))},_file_queued:function(ev){var T;T=new Element("a",{"class":"small-x-button"});T.observe("click",function(){var ey,eA,ez,ex,ew;ah.all_cancelled=true;ey=ah.file_ids().slice(0);ew=[];for(ez=0,ex=ey.length;ez<ex;ez++){eA=ey[ez];if(!ah.completed_files[eA]&&!ah.errored_files[eA]){document.fire(b9.CANCEL_EVT,{file:ah.files[eA]});ew.push(bf(document).trigger(b9.CANCEL_EVT,{file:ah.files[eA]}))}else{ew.push(void 0)}}return ew});return this.elem.down(".status").__date(T)},_file_updated:function(ex){var ew,ev,T;if(ah.num_files()>1){this.elem.removeClassName("error");this.elem.removeClassName("complete");this.elem.removeClassName("cancelled");ew=aR("%d file","%d files",ah.num_non_cancelled_files()).format(ah.num_non_cancelled_files());this.elem.down(".num-files").__date(ew);ev=dU("- %(size)s").format({size:at.format_bytes(b9.PLU.total.size)});this.elem.down(".size").__date(ev);if(ah.formatted_time){T=dU("%(time_left)s left").format({time_left:ah.formatted_time});this.elem.down(".time-left").__date(T)}this.elem.down(".upload-progress-bar").style.width=Math.min(100,(ah.totalPercentage()*100||0).toFixed(2))+"%";this.elem.show();if(b9.PLU.runtime==="flash"){return bf("#flash-upload-container").clonePosition(bf("#add-button"))}}},update_errors:function(){var T;T=aR("- %d error","- %d errors",ah.errors()).format(ah.errors());return $("bulk-upload-status").down(".num-errors").__date(T)},completed:function(){var ev,T;$("hide-button").hide();$("done-button").show();if(ah.num_files()>1){this.elem.addClassName("complete");ev=aR("Uploaded %d file","Uploaded %d files",ah.num_non_cancelled_files()).format(ah.num_non_cancelled_files());this.elem.down(".num-files").__date(ev);T=dU("- %(size)s").format({size:at.format_bytes(ah.completed_size())});this.elem.down(".size").__date(T);this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(b6.make("web","s_check"));return this.elem.down(".upload-progress-bar").style.width="100%"}},errored:function(){var T;$("hide-button").hide();$("done-button").show();this.completed();T=aR("- %d error","- %d errors",ah.errors()).format(ah.errors());return this.elem.down(".num-errors").__date(T)},cancelled:function(){$("hide-button").hide();$("done-button").show();if(ah.num_files()>1){this.elem.addClassName("cancelled");this.elem.down(".num-files").__date(dU("All uploads canceled"));this.elem.down(".size").__date();this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(b6.make("web","cancelsync"));return this.elem.down(".upload-progress-bar").style.width="100%"}}};cw=A.InlineUploadStatus={FILENAME_SNIPPET_LENGTH:30,init:function(){return this._listen()},_listen:function(){document.observe(b9.QUEUE_EVT,cw._file_queued.bind(this));return document.observe(b9.UPDATE_EVT,cw._file_updated.bind(this))},_file_queued:function(ew){var ev,T;ev=$("inline-upload-status");ev.removeClassName("error");ev.removeClassName("complete");ev.down(".icon").__date(b6.make("web","s_sync"));ev.down(".file-desc").__date(dU("Starting upload..."));ev.down(".num-errors").__date();T=aR("%d file","%d files",ah.num_left()).format(ah.num_left());ev.down(".view-details").__date(T);ev.down(".status").__date();return ev.down(".inline-upload-progress").style.width="0%"},_file_updated:function(eA){var ez,ew,ex,ey,ev,T;ez=$("inline-upload-status");ew=eA.memo.file;ez.down(".icon").__date(b6.make("web","s_sync"));ex=dU("Uploading %(filename)s").format({filename:bt.em_snippet(ew.name,this.FILENAME_SNIPPET_LENGTH)});ez.down(".file-desc").__date(ex);if(ah.num_left()>1){T=aR("%d file left","%d files left",ah.num_left()-1).format(ah.num_left()-1);ez.down(".view-details").__date(T)}else{ez.down(".view-details").__date(dU("View details"))}if(ah.formatted_time){ev=dU("%(time_left)s left").format({time_left:ah.formatted_time});ez.down(".status").__date(ev)}ey=ew.percent+"%";return ez.down(".inline-upload-progress").style.width=ey},update_errors:function(){var T,ev;T=$("inline-upload-status");ev=aR("- %d error","- %d errors",ah.errors()).format(ah.errors());return T.down(".num-errors").__date(ev)},add_x_button:function(){var T,ev;ev=new Element("a",{"class":"small-x-button"});ev.observe("click",function(){cw.hide();return b9.reset()});T=$("inline-upload-status");return T.down(".status").__date(ev)},completed:function(){var ev,T;ev=$("inline-upload-status");ev.addClassName("complete");ev.removeClassName("error");ev.down(".icon").__date(b6.make("web","s_check"));if(ah.num_files()>1){T=dU("Uploaded %(num_files)d files").format({num_files:ah.num_non_cancelled_files()})}else{T=dU("Uploaded %(filename)s").format({filename:bt.em_snippet(ah.current_file.name,this.FILENAME_SNIPPET_LENGTH)})}ev.down(".file-desc").__date(T);ev.down(".num-errors").__date();ev.down(".view-details").__date(dU("View details"));this.add_x_button();return ev.down(".inline-upload-progress").style.width="100%"},errored:function(){var ew,ev,T,ex;ew=$("inline-upload-status");ew.addClassName("error");ew.removeClassName("complete");ew.down(".icon").__date(b6.make("web","nosync"));ev=void 0;if(ah.num_files()>1){ev=dU("Uploaded %(num_completed)d of %(num_files)d files").format({num_completed:ah.num_non_cancelled_files()-ah.errors(),num_files:ah.num_non_cancelled_files()});ew.down(".file-desc").__date(ev);ex=aR("- %d error","- %d errors",ah.errors()).format(ah.errors());ew.down(".num-errors").__date(ex)}else{if(ah.current_file!=null){T=bt.em_snippet(ah.current_file.name,this.FILENAME_SNIPPET_LENGTH)}ev=T?dU("Unable to upload %(filename)s").format({filename:T}):dU("Unable to upload file");ew.down(".file-desc").__date(ev);ew.down(".num-errors").__date()}ew.down(".view-details").__date(dU("View details"));this.add_x_button();return ew.down(".inline-upload-progress").style.width="100%"},show:function(T){return $("inline-upload-status").show()},hide:function(){return $("inline-upload-status").hide()}};a3=A.UploadPrep={_drop_indicators:false,_drop_dest_folder:null,file_counter:0,current_req:null,_notifications_cleared:false,supported:function(){return Prototype.BrowserFeatures.DB_CORS},enabled:function(){return a3.supported()&&b2.inside_dir&&!(b2.in_search_mode()&&bJ.fulltext_search_enabled)},browse_indicators_enabled:function(){var ex,ev,ew,T;if(!a3.enabled()){return false}ev=["file-preview-modal","modal-overlay"];if(b9.choose_button_id.startsWith("wizard-")){ev.push("wizard-overlay")}for(ew=0,T=ev.length;ew<T;ew++){ex=ev[ew];if($(ex).visible()){return false}}return true},modal_indicators_enabled:function(){var ev,T,ew;return a3.enabled()&&bf("#modal #upload-modal-dropzone").length&&((ev=bf("#modal"))!=null?ev.visible():void 0)&&((T=bf("#modal"))!=null?(ew=T.offset())!=null?ew.left:void 0:void 0)>0},_show_border_drop_indicators:function(){return $$(".external-drop-indicator").each(function(T){return bf(T).css("opacity",0).fadeTo(500,0.6)})},_hide_border_drop_indicators:function(){return $$(".external-drop-indicator").invoke("hide")},show_drop_indicators:function(ev){var T;if(!a3._drop_indicators){if(a3.modal_indicators_enabled()){T=$("upload-modal-dropzone");bf(T).clonePosition(bf("#modal"),{setLeft:false,setTop:false});bf(T).fadeIn(500);a3._show_border_drop_indicators()}else{if(a3.browse_indicators_enabled()){bq._add_drop_indicators(ev)}else{return}}$("drag-status").removeClassName("active");return a3._drop_indicators=true}},hide_drop_indicators:function(){if(a3._drop_indicators){a3._hide_border_drop_indicators();bq._remove_drop_indicators();if(!a3._notifications_cleared){Y.clear()}$("upload-modal-dropzone").hide();$("drag-status").addClassName("active");setTimeout((function(){a3._drop_indicators=false;a3._drop_dest_folder=null;return a3._notifications_cleared=false}),500)}return a3._notifications_cleared=true},folder_dragover:function(T){var ev;if(a3.browse_indicators_enabled()&&a3._drop_indicators){if(de.disabled){if(a3._drop_dest_folder==null){ev=dU("You can't upload files because you're out of space.");Y.error(ev,60);a3._notifications_cleared=false;a3._show_border_drop_indicators()}}else{if(T!==a3._drop_dest_folder){if(T===b2.containing_fq_path()){if(b2.inside_read_only_shared_folder){ev=dU("You don't have permission to add to this folder.");Y.error(ev,60)}else{ev=dU("Drop your file to %(upload_action)s",{comment:"upload_action is a phrase like 'upload to folder 'XYZ'"}).format({upload_action:c0.upload_plain_snippet()});Y.success(new es(ev),60);a3._show_border_drop_indicators()}a3._notifications_cleared=false}else{Y.clear();a3._hide_border_drop_indicators()}}}return a3._drop_dest_folder=T}},supports_recursive_upload:function(T){var ev;return window.File&&window.FileReader&&window.FileList&&window.Blob&&(T!=null?(ev=T[0])!=null?ev.webkitGetAsEntry:void 0:void 0)},upload:function(ew,ey,ev){var ex,eA,ez,T;if(ev==null){ev=null}if(b2.inside_read_only_shared_folder){return}if(de.disabled){eA=dU("You can't upload files because you're out of space.");return Y.error(eA)}else{if(a3.supports_recursive_upload(ev)){return a3._recursive_upload(ew,ev)}else{for(ez=0,T=ey.length;ez<T;ez++){ex=ey[ez];ex.dest=ew}return a3._upload(ey,ev)}}},_recursive_upload:function(eF,eC){var eH,ew,ex,eE,eA,eI,ev,eG,ez,eB,T,ey,eD;ev=[];ez=[];eB=function(eJ,eK){eJ.dest=eF+an.parent_dir(eK.fullPath);return ev.push(eJ)};for(ey=0,eD=eC.length;ey<eD;ey++){eG=eC[ey];eE=eG.webkitGetAsEntry();if(eE!==null){if(eE.isDirectory){if(R.is_quicksend_dest(eF)){Y.error(dU("Please select files instead of folders."))}else{ez.push(eE)}}else{eB(eG.getAsFile(),eE)}}}ex=0;eI=0;T=function(eJ,eL){var eK;eK=dU('The drag and drop uploader can\'t upload %(name)s because it contains Unicode characters. Use the <a id="use-advanced-uploader"> advanced uploader</a> instead.').format({name:eL.name});Y.error(new es(eK));return bf("#use-advanced-uploader").on("click",function(eM){eM.preventDefault();return c0.show_upload()})};eH=3000;eA=0;ew=function(){var eJ;while(ez.length){eE=ez.pop();if(eE!==null){if(eE.isDirectory){(function(eL){var eK;eK=eL.createReader();ex+=1;return eK.readEntries(function(eM){var eP,eO,eN;if(eM.length!==0){for(eO=0,eN=eM.length;eO<eN;eO++){eP=eM[eO];ez.push(eP)}return eK.readEntries(arguments.callee)}else{return ex-=1}},function(eM){ex-=1;return T(eM,eL)})})(eE)}else{eI+=1;eJ=function(eK){return function(eL){eB(eL,eK);return eI-=1}};eE.file(eJ(eE),function(eK){eI-=1;return T(eK,eE)})}}}if(ev.length>eH&&!eA){eA=1;Y.error(dU("The Dropbox website can't upload more than %(max_files)s files.").format({max_files:eH}));return}if(ex||eI){return ew.defer()}else{if(ev.length){return a3._upload(ev)}}};return ew()},_upload:function(ex,ev){var T,ew;if(ev==null){ev=null}if(ev){T=this._parse_upload_items(ev)}ew=function(){var eA,eB,ez,ey;ey=[];for(eB=0,ez=ex.length;eB<ez;eB++){eA=ex[eB];if(navigator.userAgent.toLowerCase().indexOf("chrome")>-1&&(T!=null?T[eA.name].isDirectory:void 0)){eA.is_directory=true}eA.id=plupload.guid();ey.push(b9.PLU.addFile(eA))}return ey};if($("modal").visible()){return ew()}else{c0.show_upload(ew);return ep.hide(null,true)}},_parse_upload_items:function(ev){var ew,ex,ey,T;ew={};for(ey=0,T=ev.length;ey<T;ey++){ex=ev[ey];if(ex.getAsEntry){ex=ex.getAsEntry()}else{if(ex.webkitGetAsEntry){ex=ex.webkitGetAsEntry()}}ew[ex.name]=ex}return ew}};de=A.OverQuotaUploads={disabled:false,init:function(T){this.disabled=T;if(this.disabled){return bf("body").addClass("uploads-disabled")}}};var c0;c0=INLINE_JS.FileOps=A.FileOps={NOTIFICATION_SNIPPET_LEN:40,SHOW_UPLOAD_EVT:"db:fileops:show_upload",_find_app_by_id:function(ev){var ey,ex,T,ew;ew=ep.vars.apps;for(ex=0,T=ew.length;ex<T;ex++){ey=ew[ex];if(ey.app_id!==ev){continue}return ey}return null},create_album_from_folder:function(ev,T){return new Ajax.DBRequest("/collection_from_folder",{parameters:{path:ev,album_name:T},job:true,job_user:cj.get_viewer().photos_user,dont_hide_progress_on_complete:true,progress_text:dU("Creating album..."),onSuccess:function(ew){var ex;ex=JSON.parse(ew.responseText);return window.location.href=ex.url}})},dir_handler:function(ex,ew){var ev,T;if(typeof ew==="string"){ew=$(ew)}ev=$$(".treeview .highlight")[0];if(ev){ev.removeClassName("highlight")}T=ew.up("div");T.addClassName("highlight");ep.selected_div=T;if(ep.shown()){ew.blur()}document.fire("db:dir_click",{path:ex});return ep.vars.selected_path=ex},show_folder_pick:function(ez,ex,ew,ey,T){var ev;cS.fillVal(an.filename(ex).escapeHTML(),"folder-pick-file");bC.move("copy-move-treeview","folder-pick-treeview",{user:b2.active_user});ev=(T?dU("Move"):dU("Copy"));cS.fillVal(ev,"folder-pick-action-text");ep.show(ez,$("folder-pick"),{fq_path:ex,action:ew,folder:ey});return bf("#first-treeview-link").trigger("click")},show_bulk_folder_pick:function(eA,ez,ex,ey){var ev,T,ew;ew=aO.profile_files(ex);T=aO.profile_summary(ew);cS.fillVal(T,"bulk-folder-pick-file");bC.move("copy-move-treeview","bulk-folder-pick-treeview",{user:b2.active_user});if(ez==="move"){ev=dU("Move")}else{if(ez==="copy"){ev=dU("Copy")}else{ev=dU("Restore")}}cS.fillVal(ev,"bulk-folder-pick-action-text");ep.show(eA,$("bulk-folder-pick"),{files:ex,action:ey});return bf("#first-treeview-link").trigger("click")},show_copy:function(T,ev){var ew;ew=(ev?dU("Copy folder to..."):dU("Copy file to..."));bC.set_params({disable_read_only:true});return c0.show_folder_pick(ew,T,c0.do_copy,ev,false)},show_copy_bulk:function(T){var ev;ev=aR("Copy %(item_count)s item to...","Copy %(item_count)s items to...",T.length).format({item_count:T.length});bC.set_params({disable_read_only:true});return c0.show_bulk_folder_pick(ev,"copy",T,c0.do_bulk_copy)},show_move_bulk:function(T){var ev;ev=aR("Move %(item_count)s item to...","Move %(item_count)s items to...",T.length).format({item_count:T.length});bC.set_params({disable_read_only:true});return c0.show_bulk_folder_pick(ev,"move",T,c0.do_bulk_move)},show_move:function(T,ev){var ew;ew=(ev?dU("Move folder to..."):dU("Move file to..."));bC.set_params({disable_read_only:true});return c0.show_folder_pick(ew,T,c0.do_move,ev,true)},show_delete:function(T,ew,ex,ev){return c9.show({title_text:ex?dU("Delete folder?"):dU("Delete file?"),body_html:dU("Are you sure you want to delete <strong>%(items)s</strong> from your Dropbox?").format({items:an.filename(ew).escapeHTML()}),confirm_text:dU("Delete"),cancel_text:dU("Cancel"),confirm_callback:(function(ey){return function(){if(ev){return c0.do_nonbrowse_delete(T,[ew])}else{return c0.do_delete(T,ew)}}})(this)})},show_bulk_delete:function(T,ev){return c9.show({title_text:aR("Delete %(item_count)s item?","Delete %(item_count)s items?",ev.length).format({item_count:ev.length}),body_html:aR("Are you sure you want to delete %(item_count)s item from your Dropbox?","Are you sure you want to delete %(item_count)s items from your Dropbox?",ev.length).format({item_count:ev.length}),confirm_text:dU("Delete"),cancel_text:dU("Cancel"),confirm_callback:(function(ew){return function(){return c0.do_bulk_delete(T,ev)}})(this)})},show_purge:function(T,ev){return c9.show({title_text:ev?dU("Permanently delete folder?"):dU("Permanently delete file?"),body_html:dU("Are you sure you want to permanently delete <strong>%(items)s</strong> from your Dropbox?").format({items:an.filename(T).escapeHTML()}),confirm_text:dU("Permanently delete"),cancel_text:dU("Cancel"),confirm_callback:(function(ew){return function(){return c0.do_purge(b2.find_file(T))}})(this)})},show_bulk_purge:function(T){return c9.show({title_text:aR("Permanently delete %d item?","Permanently delete %d items?",T.length).format(T.length),body_html:aR("Are you sure you want to permanently delete %(item_count)s item from your Dropbox?","Are you sure you want to permanently delete %(item_count)s items from your Dropbox?",T.length).format({item_count:T.length}),confirm_text:dU("Permanently delete"),cancel_text:dU("Cancel"),confirm_callback:(function(ev){return function(){return c0.do_bulk_purge(T)}})(this)})},show_bulk_restore:function(ev,T){return c9.show({title_text:aR("Restore %d item...","Restore %d items...",ev.length).format(ev.length),body_html:aR("Are you sure you want to restore %(item_count)s item?","Are you sure you want to restore %(item_count)s items?",ev.length).format({item_count:ev.length}),confirm_text:dU("Restore"),cancel_text:dU("Cancel"),confirm_callback:(function(ew){return function(){return c0.do_bulk_restore(ev)}})(this)})},wrap_strong:function(T){if(b2.containing_fq_path()===""){return T.escapeHTML()}else{return"<strong>"+T.escapeHTML()+"</strong>"}},upload_snippet:function(ew){var T,ev;if(ew==null){ew=1000}if(cj.get_viewer().is_paired&&b2.active_user.is_team){ev=bt.em_snippet(cj.get_viewer().team_name,ew).escapeHTML()}if(b2.containing_fq_path()===""){if(cj.get_viewer().is_paired){if(b2.active_user.is_team){return dU(" upload to your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({team_name:ev})}else{return dU(" upload to your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"})}}else{return dU(" upload to your Dropbox")}}else{T=bt.em_snippet(an.filename(b2.containing_fq_path()),ew).escapeHTML();if(cj.get_viewer().is_paired){if(b2.active_user.is_team){return dU(" upload to the folder <strong>%(folder)s</strong> in your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:T,team_name:ev})}else{return dU(" upload to the folder <strong>%(folder)s</strong> in your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:T})}}else{return dU(" upload to the folder <strong>%(folder)s</strong>",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:T})}}},upload_short_snippet:function(ew){var ev,T;if(ew==null){ew=1000}T=b2.containing_fq_path();if(!T){return dU("Upload to Dropbox",{comment:"Upload a file to the root Dropbox folder"})}ev=bt.em_snippet(an.filename(T),ew);return dU("Upload to '%(folder_name)s'",{comment:"Upload a file to some folder on the website"}).format({folder_name:ev})},upload_plain_snippet:function(T){if(T==null){T=1000}return this.upload_snippet(T).replace("<strong>","'").replace("</strong>","'")},show_upload:function(eC,T,ez){var ew,eA,ev,ex,eB,ey;ew=b2.containing_fq_path();if(de.disabled){cS.fillVal(this.wrap_strong(an.filename(ew)),"disabled-upload-foldername");ev=this.upload_short_snippet(20);ep.show(ev,$("disabled-upload-modal"),{},false);return}bf(document).trigger(this.SHOW_UPLOAD_EVT,{source:T,has_callback:eC!=null});if((!FlashDetect.versionAtLeast(9))&&b9.runtimes==="flash"){c0.show_basic_upload();$("enhanced-upload-toggle").hide();return}cS.fillVal(this.upload_snippet(20),"upload-foldername");cS.fillVal(this.upload_plain_snippet(10),"dnd-upload-foldername");if($("upload-desc").visible()&&a3.supported()){$("upload-desc").hide();$("dnd-upload-desc").show()}ev=this.upload_short_snippet(20);ep.show(ev,cS.fromElm("advanced-upload-modal"),{wit_group:"advanced-uploader"},false,false,ah.num_files());ey=[$("modal").down(".basic-link-start"),$("modal").down(".basic-link-running")];for(ex=0,eB=ey.length;ex<eB;ex++){eA=ey[ex];eA.observe("click",function(){c0.show_basic_upload();return false})}if(!ah.num_files()){b9.init(an.normalize(ew),true,eC,ez)}else{b9.set_dest(an.normalize(ew))}return cw.hide()},show_basic_upload:function(){cS.fillVal(this.upload_snippet(20),"basic-upload-foldername");ep.show(this.upload_short_snippet(20),$("basic-upload-modal"),{},false);$("modal").down(".enhanced-link").observe("click",function(){c0.show_upload();return false});b9.set_dest(an.normalize(b2.containing_fq_path()));return b9.init_basic()},show_undelete:function(T){var ev,ew,ex;cS.fillVal(T.filename.escapeHTML(),"undelete_filename");ev=b6.make("web",T.icon,{});ev.addClassName("link-img");ev.style.backgroundColor="transparent";ew=c0.build_revisions_uri(T.fq_path,b2.active_user,{undelete:1});$$(".undelete-icon").invoke("update",ev);$$(".undelete-other-versions")[0].href=ew;$$(".undelete-link")[0].href=ew;ex=dU("Restore file?");return ep.show(ex,$("undelete-modal"),{file:T})},do_undelete:function(ev){var T,ew;T=ep.vars.file;ew=dU("Restored '%(file_name)s'").format({file_name:T.filename});new Ajax.DBRequest("/cmd/restore",{parameters:{files:[T.fq_path]},subject_user:b2.active_user,job:true,html_in_error_msg:true,progress_text:dU("Restoring..."),onSuccess:function(ex){ep.hide();Y.success(ew);return document.fire(av.RESTORE,{files:[T]})}});return false},do_copy:function(ew,ev){var T;ew=ew||ep.vars.fq_path;ev=ev||ep.vars.selected_path;T=b2.find_file(ew);ci(T,"Trying to copy a file we couldn't find.");return c0.do_bulk_copy([T],ev)},do_bulk_copy:function(ez,ev){var ex,ey,ew,eA,T;b2.pre_action_selection=ee.get_selected_fq_paths();ez=ez||ep.vars.files;ci(ez.length>0,"Tried to copy 0 files");if(typeof ev==="undefined"){if(typeof ep.vars.selected_path==="undefined"){Y.error(dU("You need to select a destination for the file."));return}else{ev=ep.vars.selected_path}}ev=an.normalize(ev);ew=0;for(eA=0,T=ez.length;eA<T;eA++){ex=ez[eA];if(ex.dir){if((ev+"/").indexOf(ex.fq_path+"/")===0){Y.error(dU("You cannot copy a folder into itself."));return}}}ey=ez.pluck("fq_path");Y.clear();return new Ajax.DBRequest("/cmd/copy",{parameters:{files:ey,to_path:ev},subject_user:b2.active_user,job:true,html_in_error_msg:true,progress_text:dU("Copying..."),onSuccess:function(eI){var eE,eH,eB,eJ,eD,eF,eC,eG;eE=eI.responseText.evalJSON().changesets;eH=ey.length;eJ=bt.em_snippet(an.filename(ev),c0.NOTIFICATION_SNIPPET_LEN).escapeHTML();eD=aR("Copied %(count)d item to '<a id=\"reload-link\">%(location)s</a>'.","Copied %(count)d items to '<a id=\"reload-link\">%(location)s</a>'.",eH);eD=eD.format({count:eH,location:eJ});Q.notifyWithUndo(new es(eD),eE,c0.do_rollback);eB=[];eG=eI.responseText.evalJSON().new_browse_files;for(eF=0,eC=eG.length;eF<eC;eF++){ex=eG[eF];eB.push(ex.fq_path)}b2.select_fq_paths=eB;$("reload-link").observe("click",function(){return aN.set_path_url(null,ev)});bC.schedule_reset();return document.fire(av.COPY,{files:ez,to_fq_path:ev})}})},bulk_move_error:function(T,eC){var eA,ex,eD,ey,eE,ez,ev,ew,eB;eD=b2.find_file(eC);ey=aO.profile_files(T);ew=void 0;ez=void 0;eB=void 0;if(eD){ez=eD.dir;ew=eD.fq_path;eB=eD.target_ns||eD.ns_id}else{if(b2.inside_dir&&b2.can_get_details_from_fq_path(eC)){ex=b2.details_from_fq_path(eC);ez=true;ew=ex.fq_path;eB=ex.ns_id}else{ez=true;ew=eC;eB=void 0}}eE=T.pluck("fq_path").collect(an.normalize);if(-1!==eE.indexOf(an.normalize(ew))){return dU("You cannot copy a folder into itself.")}eA=ev=function(eF){var eG;eG=an.parent_dir(eF.fq_path);return eG===(ew||"/")};if(T.all(eA)){return aR("That file already exists in that folder.","Those files already exist in that folder.",T.length)}if(!ez){return dU("You cannot put files inside one another.")}if(ey.target_namespaces>0&&eB&&eB!==Constants.root_ns){if(ey.sandboxes>0){if(eD.is_sandbox()){return dU("You're not allowed to put an application folder inside another application folder.")}else{if(eD.is_shared_folder()){return dU("You're not allowed to put an application folder inside a shared folder.")}}}else{if(ey.shared_folders>0){if(eD.is_sandbox()){return dU("You're not allowed to put a shared folder inside an application folder.")}else{if(eD.is_shared_folder()){return dU("You're not allowed to put a shared folder inside another shared folder.")}}}}return dU("You're not allowed to nest special folders.")}if(b2.public_folder_enabled){if(ew==="/Public"&&ey.target_namespaces>0){return dU("You're not allowed to move shared folders to your Public folder.")}}if(ey.public_folder>0){return dU("You're not allowed to move your Public folder.")}if(ey.deleted>0){return dU("Moving deleted folders or files is not allowed.")}},do_move:function(ew,ev){var T;ew=ew||ep.vars.fq_path;ev=ev||ep.vars.selected_path;T=b2.find_file(ew);ci(T,"Trying to move a file we couldn't find.");return c0.do_bulk_move([T],ev)},do_bulk_move:function(ey,ez){var ew,ex,T,ev;b2.pre_action_selection=ee.get_selected_fq_paths();ey=ey||ep.vars.files;if(!ey){return}ci(ey.length>0,"Tried to move 0 files");T=ez||ep.vars.selected_path||"";T=an.normalize(T);ew=c0.bulk_move_error(ey,T);if(ew){Y.error(ew);return}ex=ey.pluck("fq_path");Y.clear();ev="/cmd/move";return new Ajax.DBRequest(ev,{parameters:{files:ex,to_path:T},subject_user:b2.active_user,job:true,html_in_error_msg:true,progress_text:dU("Moving..."),onSuccess:function(eD){var eC,eB,eA,eE;eC=eD.responseText.evalJSON().changesets;eB=ex.length;eA=bt.em_snippet(an.filename(T),c0.NOTIFICATION_SNIPPET_LEN).escapeHTML();eE=aR("Moved %(count)d item to '<a id=\"reload-link\">%(location)s</a>'.","Moved %(count)d items to '<a id=\"reload-link\">%(location)s</a>'.",eB);eE=eE.format({count:eB,location:eA});Q.notifyWithUndo(new es(eE),eC,c0.do_rollback);$("reload-link").observe("click",function(){return aN.set_path_url(null,T)});bC.schedule_reset();return document.fire(av.MOVE,{files:ey,to_fq_path:T})}})},do_rollback:function(T){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(T)},subject_user:b2.active_user,job:true,html_in_error_msg:true,progress_text:dU("Undoing..."),onSuccess:function(ev){var ew;ew=dU("Undo complete.");Y.success(ew);ci(b2.pre_action_selection instanceof Array,"Expected a selection from before the action to be undone");if(b2.in_search_mode()){bJ.select_fq_paths=b2.pre_action_selection;bJ.force_reload()}else{if(ax.shown){b2.select_fq_paths=b2.pre_action_selection}else{b2.select_fq_paths=b2.pre_action_selection;b2.force_reload()}}return b2.pre_action_selection=false}})},do_bulk_delete:function(T,ex){var ev,ew;b2.pre_action_selection=ee.get_selected_fq_paths();ex=ex||ep.vars.files;ci(ex.length>0,"Tried to delete 0 files");ew=(function(){var eA,ez,ey;ey=[];for(eA=0,ez=ex.length;eA<ez;eA++){ev=ex[eA];ey.push(ev.fq_path)}return ey})();Y.clear();return new Ajax.DBRequest("/cmd/delete",{parameters:{files:ew},subject_user:T,job:true,html_in_error_msg:true,progress_text:dU("Deleting..."),onSuccess:function(ey){var eA,ez;ez=ey.responseText.evalJSON();eA=aR("Deleted %d item.","Deleted %d items.",ew.length).format(ew.length);Q.notifyWithUndo(eA,ez.changesets,c0.do_rollback);bC.schedule_reset();return document.fire(av.DELETE,{files:ex})}})},do_delete:function(T,ew){var ev;ev=b2.find_file(ew||ep.vars.fq_path);ci(ev,"Trying to delete a file we couldn't find.");return c0.do_bulk_delete(T,[ev])},do_nonbrowse_delete:function(T,ev){return new Ajax.DBRequest("/cmd/delete",{parameters:{files:ev},subject_user:T,html_in_error_msg:true,onSuccess:function(ew){var ex;ex=aR("Deleted %(file_count)s item","Deleted %(file_count)s items",ev.length);ex=ex.format({file_count:ev.length});Y.success(ex);return document.fire(av.DELETE,{fq_paths:ev})}})},do_purge:function(T){ci(T,"Trying to purge a file we couldn't find.");return c0.do_bulk_purge([T])},do_bulk_purge:function(ev){var T,ew;ci(ev.length>0,"Tried to purge 0 files");T=ev.collect(function(ex){return ex.fq_path});ew=aR("Permanently deleted %d item","Permanently deleted %d items",T.length).format(T.length);return new Ajax.DBRequest("/cmd/purge",{parameters:{files:T},subject_user:b2.active_user,job:true,html_in_error_msg:true,progress_text:dU("Deleting..."),onSuccess:function(ex){Y.success(ew);bC.schedule_reset();return document.fire(av.PURGE,{files:ev})}})},do_bulk_restore:function(ew){var ev,ex,T;ew=ew||ep.vars.files;T=ep.vars.user;ci(ew.length>0,"Tried to restore 0 files");ev=ew.collect(function(ey){return ey.fq_path});ex=aR("Restored %d item","Restored %d items",ev.length,{comment:"meaning, successfully restored x files and folders"}).format(ev.length);return new Ajax.DBRequest("/cmd/restore",{parameters:{files:ev},subject_user:b2.active_user,job:true,html_in_error_msg:true,progress_text:dU("Restoring..."),onSuccess:function(ey){Y.success(ex);bC.schedule_reset();return document.fire(av.RESTORE,{files:ew})}})},do_folder_restore:function(ev,T){var ew;ew=function(ex){var ez,ey;ez=dU("Restoring '%(folder_name)s'").format({folder_name:an.filename(ev)});ey=ex.responseText;if(ey.startsWith("err:")){ey=ey.substring(4);bf("#async-result").html(ey);Y.error(new es(ey),60)}else{ez=dU("Restored '%(folder_name)s'").format({folder_name:an.filename(ev)});bf("#status-of-files").text(dU("Restored files"));Y.success(ez,60)}bf("#restore-done-heading").text(ez);bf(".pre-restore").hide();return bf(".post-restore").show()};return new Ajax.DBRequest("/cmd/restore",{parameters:{files:[ev]},job:true,html_in_error_msg:true,progress_text:dU("Restoring..."),onSuccess:ew,onFailure:ew,subject_user:T})},do_bulk_download:function(ew){var ey,ev,ex,T;ey=new Element("form",{action:C({scheme:"https",authority:Constants.BLOCK_CLUSTER,path:"/zip_batch"}).updateQuery(Constants.UID_PARAM_NAME,b2.active_user.id).toString(),method:"post"});for(ex=0,T=ew.length;ex<T;ex++){ev=ew[ex];bs.add_vars(ey,{files:ev.fq_path})}bs.add_vars(ey,{parent_path:b2.block_hash_param||"/",w:b2.block_hash});$(document.body).__sert(ey);return ey.submit()},do_bulk_photo_view:function(ev){var ew,T;ew=new Element("form",{action:"https://"+Constants.WEBSERVER+"/photos",method:"post"});bs.add_vars(ew,{t:a8.read(Constants.JS_CSRF_COOKIE),ns_ids:JSON.stringify((function(){var ez,ey,ex;ex=[];for(ez=0,ey=ev.length;ez<ey;ez++){T=ev[ez];ex.push(T.ns_id)}return ex})()),ns_paths:JSON.stringify((function(){var ez,ey,ex;ex=[];for(ez=0,ey=ev.length;ez<ey;ez++){T=ev[ez];ex.push(T.ns_path)}return ex})())});$(document.body).__sert(ew);return ew.submit()},build_revisions_uri:function(ew,T,ev){if(ev==null){ev={}}ev[Constants.UID_PARAM_NAME]=String(T);return C({path:"/revisions"+ew}).updateQuery(ev)}};var bs,am={}.hasOwnProperty;bs=__CONDITIONAL_JS__.Forms=INLINE_JS.Forms=A.Forms={submitOnlyOnce:function(){var T;T=bs.submitted!==true;bs.submitted=true;return T},disable:function(T){if(T){return setTimeout((function(){return T.disabled=true}),0)}},enable:function(T){if(T){return setTimeout((function(){return T.disabled=false}),0)}},show_button_on_change:function(T,ex){var ew,ey,ez,ev;ew=bf(T);ew.hide();if(ex==null){ex=ew.closest("form")}ey=ex[0];if(this.next_id==null){this.next_id=0}ez=this.next_id++;if(this.initial_vars==null){this.initial_vars={}}this.initial_vars[ez]=this.collect_form_vars(ey);ew.attr("data-id",ez);ex.data("button-id",ez);ev=(function(eA){return function(){var eD,eC,eB;ew.hide();eC=eA.collect_form_vars(ey);if(Object.keys(eC).length!==Object.keys(eA.initial_vars[ez]).length){ew.show()}eB=[];for(eD in eC){if(eC[eD]!==eA.initial_vars[ez][eD]){eB.push(ew.show())}else{eB.push(void 0)}}return eB}})(this);ex.change(ev);ex.find("input").filter(":text").on("input",ev);return ex.find("textarea").on("input",ev)},add_vars:function(ew,ex){var ey,ev,T;ew=$(ew);T=[];for(ev in ex){if(!am.call(ex,ev)){continue}ey=new Element("input",{type:"hidden",name:ev});ey.setValue(ex[ev]);T.push(ew.__sert(ey))}return T},collect_form_vars:function(ey,ex){var eB,ew,ev,eA,ez,T;if(ex==null){ex=false}ey=ey||$(document.body);ew=ey.select("input").concat(ey.select("textarea")).concat(ey.select("select"));ev={};for(ez=0,T=ew.length;ez<T;ez++){eB=ew[ez];if(eB.name&&eB.name!=="t"){eA=eB.getValue();if(eA||ex){if(typeof eA!=="string"){eA=eA.join(",")}if(ev[eB.name]!=null){if(typeof ev[eB.name]==="string"){ev[eB.name]=[ev[eB.name],eA]}else{ev[eB.name].push(eA)}}else{ev[eB.name]=eA}}}}return ev},add_loading:function(ew,T){var ev;if(ew){ew=$(ew);ev=new Element("img",{src:"/static/images/icons/ajax-loading-small.gif"});ev.addClassName("text-img ajax_submit_loading");if(T==="after"){return bf(ew).after(ev)}else{return bf(ew).before(ev)}}},remove_loading:function(T){return bf(".ajax_submit_loading").remove()},ui_form_submit:function(ev,T){T=T||ev.action;if(ev.ajax_submitted){return false}ev.ajax_submitted=true;return new a9(bf(ev),T,{data:bs.collect_form_vars(ev),success:(function(ew){return function(eA,ex,eB){var ez,ey;ey=bf(ev).data("button-id");if(ey!=null){ez=bf(ev).find("*[type='submit'][data-id='"+ey+"']");ew.initial_vars[ey]=ew.collect_form_vars(ev);return ez.hide()}}})(this),complete:(function(ew){return function(ey,ex){return ev.ajax_submitted=false}})(this)})},ajax_submit_obj:function(ez){var eD,eF,ew,ex,ev,ey,eB,eC,eA,eE,T;ex=ez.form,T=ez.url,eE=ez.success_callback,ew=ez.fail_callback,eD=ez.button,eB=ez.more_vars,eC=ez.position,ey=ez.job,ev=ez.html_response,eF=ez.complete_callback,eA=ez.progress_text;return bs.ajax_submit(ex,T,eE,ew,eD,eB,eC,ey,ev,eF,eA)},ajax_submit:function(ex,ev,eG,ew,eE,eB,eF,ey,T,eJ,ez){var eH,eA,eC,eI,eD;if(T==null){T=false}if(ex.ajax_submitted){return false}ex.ajax_submitted=true;eD=bf(ex).find(".suggestion-input");for(eC=0,eI=eD.length;eC<eI;eC++){eH=eD[eC];cz.blank(eH.identify())()}if(eE){bs.add_loading(eE,eF)}eA=bs.collect_form_vars(ex);if(eB){Object.extend(eA,eB)}new Ajax.DBRequest(ev||ex.action,{noAutonotify:true,parameters:eA,job:ey,progress_text:ez,evalJSON:false,onSuccess:function(eK){bs.remove_loading();if(eG&&typeof eG==="function"){return eG(eK)}},onFailure:function(eM){var eK,eL;if(eM){if(eM.responseText.indexOf("err:")===0){eK=eM.responseText.substr(4);if(eK.indexOf("{")===0){eL=eK.evalJSON(true);bs.fill_errors(ex,eL)}else{if(T){eK=new es(eK)}Y.error(eK)}}else{Y.error()}bs.remove_loading();if(ew&&typeof ew==="function"){return ew(eM)}}},onComplete:function(eN){var eM,eL,eK;eK=ex.select(".suggestion-input");for(eM=0,eL=eK.length;eM<eL;eM++){eH=eK[eM];cz.blur_elm(eH)}ex.ajax_submitted=false;if(eJ&&typeof eJ==="function"){return eJ(eN)}}});return false},clear_errors:function(T){T=T||$(document.body);this.hide_errors(T);return T.select(".error-removable").invoke("remove")},fill_errors:function(ez,ey){var ew,eB,ev,ex,eA,T;ey=ey||{};ez=ez||$(document.body);bs.clear_errors(ez);for(eA in ey){if(!am.call(ey,eA)){continue}eB=ez.down("[data-error-field-name='"+eA+"']")||ez.down("[name='"+eA+"']");if(eB){ew=new Element("br",{"class":"error-removable"});ev=new Element("span",{"class":"error-message error-removable"});ex=ey[eA];ci(ex.message_html||ex.message_text,"Error message must have a message_html or message_text property");if(ex.message_html){ev.update(ex.message_html)}else{ev.__date(ex.message_text)}bf(eB).before(ev);bf(eB).before(ew);T=bf(ez).find("input[name='"+eA+"'], textarea[name='"+eA+"']");if(T){T.addClass("input-error")}}}return this.show_errors(ez)},value:function(ex){var ew,ev,ez,ey,T;ev=$$('input[name="'+ex+'"]');ez=null;for(ey=0,T=ev.length;ey<T;ey++){ew=ev[ey];ez=$(ew).getValue()||ez}return ez},postRequest:function(ew,ex,T){var ev;if(ex==null){ex={}}if(T==null){T={}}ci(ew!=null,"postRequest missing action");ex.t=a8.read(Constants.JS_CSRF_COOKIE);ev=new Element("form",{action:ew,method:"POST"});if(T.target){ev.target=T.target}document.body.appendChild(ev);bs.add_vars(ev,ex);return ev.submit()},hide_errors:function(ew){var ez,ey,ex,ev,T;ez=this.get_errors(ew);T=[];for(ex=0,ev=ez.length;ex<ev;ex++){ey=ez[ex];if(ey.down("span.error-message")){T.push(ey.hide())}else{T.push(void 0)}}return T},show_errors:function(ev){var ey,ex,ew,T;ey=this.get_errors(ev);for(ew=0,T=ey.length;ew<T;ew++){ex=ey[ew];if(ex.down("span.error-message")){ex.show()}}return bf(".sick-input").find("label").css("top","")},get_errors:function(ev){var ew,T;T=".error-bubble, .error-plain-text";ew=ev?ev.select(T):$$(T);return ew}};bf(function(){return bs.show_errors()});var O;O=A.ActAsBlock={elm_list:["margin-left","margin-right","padding-left","padding-right","border-left-width","border-right-width"],parent_list:["padding-left","padding-right","border-left-width","border-right-width"],register:function(ey,ez){var ex,ev,ew,T;if(ez==null){ez=document.body}ew=$(ez).getElementsByClassName("act_as_block");T=[];for(ex=0,ev=ew.length;ex<ev;ex++){ey=ew[ex];T.push(this.resize(ey))}return T},resize:function(ey){var T,ew,ex,ev;ey=$(ey);ew=ey.up();T=ds.sumStyles(ey,this.elm_list);ex=ds.sumStyles(ew,this.parent_list);ey.style.width="1px";ev=ew.getWidth()-T-ex;if(ev>0){return ey.style.width=ev+"px"}}};var aT;aT=A.BrowseStyleRows={register_all:function(){var ex,ew,T,ev;ev=$$(".bs-row");for(ew=0,T=ev.length;ew<T;ew++){ex=ev[ew];this.register(ex)}Event.observe(document,"click",this.kill_current.bind(this));return bf(document).on("dropdown-opened",this.kill_current.bind(this))},register:function(ev){var T;ev=$(ev);ev.db_observe("mouseover",this.mouseover.bind(this));ev.db_observe("mouseout",this.mouseout.bind(this));T=ev.down(".action-button");if(T){return T.db_observe("click",this.click.bind(this))}},mouseover:function(ev,T){if(!T.hasClassName("no-hover")){return T.addClassName("hover")}},mouseout:function(ev,T){return T.removeClassName("hover")},click:function(ex,ev){var T,ey,ew;if(ex.target.tagName==="A"){return}ey=ev.up(".bs-row");Event.stop(ex);if(ey.hasClassName("selected")){this.kill_current(false);return}bf(document).trigger("dropdown-opened");this.kill_current(false);ew=$(ex.target);if(!ew.match(".bs-actions-list *")){ey.addClassName("selected")}T=(ew.hasClassName("bs-row")?ew:ew.up(".bs-row"));return T.style.zIndex=9},kill_current:function(ey){var ez,ex,ev,ew,T;ew=$$(".bs-row.selected");T=[];for(ex=0,ev=ew.length;ex<ev;ex++){ez=ew[ex];ez.removeClassName("selected");T.push(ez.style.zIndex="")}return T}};var dJ;dJ=A.Bubble={make:function(eH,eS,eK,eF,eB){var ey,eI,eP,ex,ew,eR,eM,eG,eE,ez,eD,eJ,eO,eC,T,eA,ev,eQ,eN,eL;if(eS==null){eS="left"}eB=eB!=null?eB:{};if(["left","right"].contains(eS)){eK=eK||"middle";ci(["top","middle","bottom"].contains(eK),"expected tail position ['top', 'middle', 'bottom'], got "+eK)}else{if(["bottom","top"].contains(eS)){eK=eK||"center";ci(["left","center","right"].contains(eK),"expected tail position ['left', 'center', 'right'], got "+eK)}else{if(!["none"].contains(eS)){ci(false,"unexpected tail side, got "+eS)}}}eJ=new Element("table");if(eB.style==="titled"){eJ.addClassName("bluebubble");eO="bluebubble"}else{eJ.addClassName("bubble");eO="bubble"}if(eF){eJ.style.width=eF+"px"}T=new Element("tbody");eQ=new Element("tr");eA=new Element("td");eA.addClassName("tl");eD=new Element("td");eD.addClassName("t");if(eB.style==="titled"){if(eF){eD.style.width=(eF-42)+"px"}}ev=new Element("td");ev.addClassName("tr");if(eS==="top"){eC=new Element("img",{src:"/static/images/"+eO+"_arrow_top.png"});eC.addClassName("tarrow");if(eB.style==="titled"){eC.addClassName("arrow-"+eK);eI=new Element("div");eI.addClassName("arrow-container");if(eF){eI.style.width=(eF-42)+"px"}eI.__sert(eC);eD.__sert(eI)}else{eD.style.textAlign=eK;eD.__sert(eC)}}eQ.__sert(eA);eQ.__sert(eD);eQ.__sert(ev);T.__sert(eQ);eN=new Element("tr");eG=new Element("td");eG.addClassName("l");if(eS==="left"){if(eB.style==="titled"){ey=new Element("img",{src:"/static/images/bluebubble_arrow_left.png"})}else{ey=new Element("img",{src:"/static/images/bubble_arrow.png"})}ey.addClassName("arrow");eG.__sert(ey);eG.vAlign=eK}eM=new Element("td");eM.addClassName("c");eM.update(eH);eE=new Element("td");eE.addClassName("r");if(eS==="right"){ez=new Element("img",{src:"/static/images/bubble_arrow_right.png"});ez.addClassName("rarrow");eE.__sert(ez);eE.vAlign=eK}eN.__sert(eG);eN.__sert(eM);eN.__sert(eE);T.__sert(eN);eL=new Element("tr");ew=new Element("td");ew.addClassName("bl");eP=new Element("td");eP.addClassName("b");if(eS==="bottom"){ex=new Element("img",{src:"/static/images/"+eO+"_arrow_bottom.png"});ex.addClassName("barrow");if(eB.style==="titled"){ex.addClassName("arrow-"+eK);eI=new Element("div");eI.addClassName("arrow-container");if(eF){eI.style.width=(eF-42)+"px"}eI.__sert(ex);eP.__sert(eI)}else{eP.style.textAlign=eK;eP.__sert(ex)}}eR=new Element("td");eR.addClassName("br");eL.__sert(ew);eL.__sert(eP);eL.__sert(eR);T.__sert(eL);eJ.__sert(T);return eJ}};var eb;eb=INLINE_JS.FreshDropdown=A.FreshDropdown={show:function(eA,ex,ew,ev){var ez,ey,eB,T;if(ev==null){ev=false}bf(document).trigger("dropdownOpened",[1]);ez=bf(ex);if(!ew){ew=ez[0].offsetHeight+10}this.hide_all();ey=bf(eA).show();T=ey[0].offsetWidth;eB=ez[0].offsetWidth;ey.clonePosition(ez,{setHeight:false,setWidth:false,offsetLeft:-1*(T-eB)+22,offsetTop:ew});if(ev){ey.width(T)}ez.addClass("pressed");return((function(eC){return function(){return document.observe("click",eb.hide_all)}})(this)).defer()},hide_all:function(ew){var ev,T;T=bf(".freshdropdown-menu");ev=0;T.each(function(){if(bf(this).is(":visible")){return ev+=1}});T.hide();bf(document).trigger("dropdownClosed",[ev]);$$(".freshdropdown-button").invoke("removeClassName","pressed");return document.stopObserving("click",eb.hide_all)}};var V;V=A.JumpWatcher={inverval:null,last_hash:null,last_page_offset:0,check:function(){if(window.location.href.endsWith("#")&&window.pageYOffset===0&&V.last_page_offset!==0){return this.report()}else{this.last_page_offset=window.pageYOffset;return this.last_hash=C.parse(window.location.href).fragment}},report:function(){clearInterval(V.interval);return ci(0.1+0.2===0.3,"Hash jump detected, last hash = "+this.last_hash+". You may have an onclick handler that isn't firing, or you are not preventing the default action (eg. by returning false in your handler)")}};var ej,a0,am={}.hasOwnProperty,cl=function(ex,ev){for(var T in ev){if(am.call(ev,T)){ex[T]=ev[T]}}function ew(){this.constructor=ex}ew.prototype=ev.prototype;ex.prototype=new ew();ex.__super__=ev.prototype;return ex};ej=A.LocaleSelectorModal=(function(ev){cl(T,ev);function T(){return T.__super__.constructor.apply(this,arguments)}T.prototype.action="https://"+Constants.WEBSERVER+"/set_locale";T.prototype.on_show=function(){return this.$modal_window.on("click",".locale-option",(function(ew){return function(ex){ex.preventDefault();ew.hide();return ew.set_locale(bf(ex.target).attr("data-locale"))}})(this))};T.prototype.on_hide=function(){return this.$modal_window.off("click")};T.prototype.set_locale=function(ew,ey){var ex;if(ey==null){ey=false}ex=bf("<form />",{action:this.action,method:"post"});bs.add_vars(ex[0],{locale:ew,locale_cont:ey||window.location.href,t:a8.read(Constants.JS_CSRF_COOKIE)});bf(document.body).append(ex);return ex.submit()};return T})(du);a0=A.TeamLocaleSelectorModal=(function(T){cl(ev,T);function ev(){return ev.__super__.constructor.apply(this,arguments)}ev.prototype.action="https://"+Constants.WEBSERVER+"/team/admin/set_locale";return ev})(ej);var da;da=A.LoginDropdown={init:function(){var T;T=bf("#login-hover-link");if(!(T.length>0)){return}this.login_link=T;return this.register()},register:function(T){this.login_link.on("click",this.click.bind(this));this.login_link.on("mousedown",this.mousedown.bind(this));this.login_link.on("focus",this.click.bind(this));return $(document.body).on("click",this.unclick.bind(this))},mousedown:function(T){return this.clicking=true},click:function(T){T.preventDefault();if(this.clicking&&T.type==="focus"){return}this.clicking=false;if(this.down){return this.unclick()}bf(document).trigger("dropdownOpened",[1]);this.down=true;this.login_link.parent().addClass("down");return bf("input[name='login_email']").focus()},unclick:function(ev){var T;if(ev){T=bf(ev.target);if(T[0].match("#top-login-wrapper, #top-login-wrapper *")){return}}if(this.down){bf(document).trigger("dropdownClosed",[1])}this.down=false;return this.login_link.parent().removeClass("down")}};var ep;ep=__CONDITIONAL_JS__.Modal=INLINE_JS.Modal=A.Modal={KEY_SCOPE:"modal",width:640,vertical_offset:90,show:function(eG,eC,eD,eI,ew,eE,eA,eB,eH){var ev,ey,eF,T,ex,ez;if(eD==null){eD=false}if(eI==null){eI=false}if(ew==null){ew=false}if(eE==null){eE=false}if(eA==null){eA=""}if(eB==null){eB=true}if(eH==null){eH=false}if(ep.shown()){ep._cleanup()}ew=ew||this.width;ey="#modal-content .error-message, #modal-content .error-removable, #modal-content .error-bubble";$$(ey).invoke("hide");if(ah.uploading&&!eE){bI(dU("You can't do this while uploading."));return false}ci(eC,"Missing modal content!");ex=this.vars._prev_scope;this.vars=eD||{};this.vars._prev_scope=ex;$("modal").setStyle({width:""+ew+"px",margin:"0 0 0 "+(Math.floor(-ew/2).toString())+"px"});this.vars.extra_class="";if(eA){$("modal").addClassName(eA);this.vars.extra_class=eA}if(!eE){if(ah.num_files()){b9.reset();ah.clear()}T=ds.childElement($("modal-content"),0);if(T&&T!==eC){$("grave-yard").__sert(T)}ev=new Element("div");ev.update(eC);$("modal-content").__sert(ev);if(eC.show){eC.show()}Element.show("modal")}bf("#modal-overlay").off("click");if(eB){bf("#modal-overlay").on("click",function(eJ){ep.hide(null,false,true);eJ.preventDefault();return eJ.stopPropagation()})}else{bf("#modal-overlay").on("click",function(eJ){eJ.preventDefault();return eJ.stopPropagation()})}this.fix_position();$("modal-overlay").show();$("modal-behind").setStyle({width:""+(ew+20)+"px",margin:"0 0 0 "+(Math.floor(-ew/2-10).toString())+"px"});bf("#modal-behind").css("opacity",0.2);$("modal-behind").show();if(eI){$("modal-content").select("#"+eI.id).first().focus()}else{if(!ds.ie){eF=$("modal").down("input[type=submit]")||$("modal").down("input[type=button]");if(eF){eF.focus()}}}if(!this.track_id){this.track_resizes()}if(eG){if(ds.isElm(eG)){bf("#modal-title").html(eG)}else{bf("#modal-title").text(eG)}bf("#modal-title").show();ez=bf("#modal-title").text();d0("Modal.show:",ez)}else{bf("#modal-title").hide();d0("Modal.show")}O.register(false,"modal");this.keydownHandler=this.keydown.bind(this);document.observe("keydown",this.keydownHandler);$("modal-content").style.height="auto";if(key.getScope()!==this.KEY_SCOPE){this.vars._prev_scope=key.getScope()}key.setScope(this.KEY_SCOPE);this.prevent_hide_if_loading=eH;bf("#modal").find("input").filter(":visible:first").focus();if(this.in_viewport()){this.scroll_locked=true;y.scroll_lock_document()}bf(document).trigger("modalOpened",[1]);return false},in_viewport:function(){var ew,T,ev,ey,ex;ew=bf("#modal");T=ew.height();ex=ew.width();ev=y.viewport_dimensions();ey=y.viewport_offset(ew);return ey.left>0&&ey.top>0&&ey.left+ex<ev.width&&ey.top+T<ev.height},fix_position:function(ew){var ev,T;T=document.viewport.getScrollOffsets().top+this.vertical_offset;ev=parseInt($("modal").getStyle("height"),10);if(ev+this.vertical_offset<document.viewport.getHeight()){$("modal").setStyle({position:"fixed",top:this.vertical_offset+"px"});return $("modal-behind").setStyle({position:"fixed",height:(ev+20)+"px",top:(this.vertical_offset-10)+"px"})}else{$("modal").setStyle({position:"absolute",top:T+"px"});return $("modal-behind").setStyle({position:"absolute",height:(ev+20)+"px",top:(T-10)+"px"})}},keydown:function(ex){var ey,T,ew,ev;ew=ex.keyCode||ex.which||ex.charCode;if(ew===27||(ew===8&&!y.focus_in_input())){ex.preventDefault();this.hide(null,false,true)}if(ew===9&&!y.focus_in_input()){T=$("modal").down("input[type=text], input[type=email]");ev=$("modal").down(".modal-tabs");ey=ev;while(ey&&ey.next()){ey=ey.next();if(ey.visible()){T=ey.down("input[type=text], input[type=email]");break}}if(T){ex.preventDefault();return T.focus()}}},shown:function(){return $("modal").visible()},hide:function(ew,T,ev){if(ew){Event.stop(ew)}if(this.should_prevent_hide()){return false}this.prevent_hide_if_loading=false;if(this.onHide){this.onHide(ev);return}this.onHide=null;Element.hide("modal-behind");Element.hide("modal-overlay");$("modal").removeClassName(this.vars.extra_class);if(!T&&!ah.num_files()){Element.hide("modal")}else{$("modal").style.marginLeft="-10000000px";if(ah.uploading){cw.show()}}ep._cleanup();if(this.track_id){clearInterval(this.track_id);this.track_id=false}document.stopObserving("keydown",this.keydownHandler);if(document.activeElement&&[document,window,document.body].indexOf(document.activeElement)===-1){$(document.activeElement).blur()}key.setScope(this.vars._prev_scope);return d0("Modal.hide")},_cleanup:function(){bf(document).trigger("modalClosed",[1]);if(this.scroll_locked){return y.scroll_unlock_document()}},should_prevent_hide:function(){return this.prevent_hide_if_loading&&$u.some(bf("#modal form"),function(T){return T.ajax_submitted})},track_resizes:function(){return this.track_id=setInterval(this.on_resize.bind(this),150)},on_resize:function(){var T;T=$("modal").getHeight();if(this.old_height!==T||$("modal-behind").getHeight()<T){this.old_height=T;return this.fix_position()}},vars:{}};var eg,dn,dD,cU=function(T,ev){return function(){return T.apply(ev,arguments)}},am={}.hasOwnProperty,cl=function(ex,ev){for(var T in ev){if(am.call(ev,T)){ex[T]=ev[T]}}function ew(){this.constructor=ex}ew.prototype=ev.prototype;ex.prototype=new ew();ex.__super__=ev.prototype;return ex};dn=A.RolePickerState={ALL:"all",PERSONAL:Constants.ROLE_PERSONAL,WORK:Constants.ROLE_WORK};eg=A.RolePicker=(function(){function T(ew){var ex,ev;if(ew==null){ew={}}this._actually_set_state=cU(this._actually_set_state,this);this._do_login=cU(this._do_login,this);this.is_user_visible=cU(this.is_user_visible,this);this.is_role_visible=cU(this.is_role_visible,this);this.ensure_role_is_visible=cU(this.ensure_role_is_visible,this);this.update_picker_ui=cU(this.update_picker_ui,this);this.set_state=cU(this.set_state,this);this.get_state=cU(this.get_state,this);this._allow_merged_state=ew.allow_merged_state!=null?ew.allow_merged_state:true;this._limit_to_role=ew.limit_to_role!=null?ew.limit_to_role:null;if(cj.get_viewer().is_role_signed_in(dn.PERSONAL)&&cj.get_viewer().is_role_signed_in(dn.WORK)){this.set_state(dn.ALL)}else{ex=cj.get_viewer().get_users();ci(ex.length,"tried to use RolePicker on a page with no users");ev=ex[0];this.set_state(ev.role)}return this}T.prototype.get_state=function(){return this._state};T.prototype.set_state=function(ew){var ez,ey,ev,ex;ci(this._allow_merged_state||(ew!==dn.ALL),"tried to set merged state in non-merged picker");if(this._limit_to_role!=null){ci((ew===dn.ALL)||(ew===this._limit_to_role))}if(ew===dn.ALL){ex=[Constants.ROLE_PERSONAL,Constants.ROLE_WORK,Constants.ROLE_PHOTOS];for(ey=0,ev=ex.length;ey<ev;ey++){ez=ex[ey];if(!cj.get_viewer().is_role_signed_in(ez)){this._do_login(ez,ew);return}}}else{ez=ew;if(!cj.get_viewer().is_role_signed_in(ez)){this._do_login(ez,ew);return}}return this._actually_set_state(ew)};T.prototype.update_picker_ui=function(){};T.prototype.ensure_role_is_visible=function(ev){if(!this.is_role_visible(ev)){if(this._allow_merged_state){return this.set_state(dn.ALL)}else{return this.set_state(ev)}}};T.prototype.is_role_visible=function(ev){return this._state===dn.ALL||this._state===ev};T.prototype.is_user_visible=function(ev){return this.is_role_visible(ev.role)};T.prototype._do_login=function(ev,ew){return bo.show_modal({role:ev,on_success:(function(ex){return function(){return ex._actually_set_state(ew)}})(this)})};T.prototype._actually_set_state=function(ev){this._state=ev;this.update_picker_ui();return typeof this.on_state_change==="function"?this.on_state_change(ev):void 0};return T})();dD=A.RoleSelect=(function(ev){cl(T,ev);function T(ex,ew){if(ew==null){ew={}}this.limit_to_role=cU(this.limit_to_role,this);this.update_picker_ui=cU(this.update_picker_ui,this);this.on_ui_change=cU(this.on_ui_change,this);this.$container=ex;this.$bubble_picker=this.$container.find(".bubble-picker");this.$bubble_picker.on(bb.CHANGED,this.on_ui_change);T.__super__.constructor.call(this,ew);return this}T.prototype.on_ui_change=function(ew,ey){var ex;ex=ey.clicked_val;if(ex!==this._state){this.$bubble_picker.controller().set_value(this._state);return this.set_state(ex)}};T.prototype.update_picker_ui=function(){this.$bubble_picker.controller().set_value(this._state);return this.$bubble_picker.find(".bubble-picker-label .role-option").addClass("title_bubble")};T.prototype.limit_to_role=function(ez,ex){var ew,ey;if(ez!=null){this.ensure_role_is_visible(ez);for(ew in dn){ey=dn[ew];if(ey===ez||ey===dn.ALL){continue}this.$bubble_picker.controller().disable_option(ey,ex)}}else{for(ew in dn){ey=dn[ew];this.$bubble_picker.controller().enable_option(ey)}}return this._limit_to_role=ez};return T})(eg);var bS;bS=A.SickInput={init:function(){var ey,ex,ev,ew,T;ew=$$(".sick-input");T=[];for(ex=0,ev=ew.length;ex<ev;ex++){ey=ew[ex];if(!ey.hasClassName("sickified")){T.push(this._create(ey))}}return T},_create:function(ex){var ew,T,ev;if(ex==null){return}ew=ex.identify();T=ex.down("input")||ex.down("textarea")||ex.down("select");T.observe("focus",function(){return ex.addClassName("focused")});T.observe("blur",function(){return ex.removeClassName("focused")});ev=function(){if(ex.hasClassName("populated")&&T.getValue()===""){ex.removeClassName("populated")}else{if(!ex.hasClassName("populated")&&T.getValue()!==""){ex.addClassName("populated")}}if(ew in bS._handler_map){return bS._handler_map[ew]()}};bs.show_errors();ev();return setInterval(ev,100)},_handler_map:{},add_interval_handler:function(ev,T){var ew;ew=ev.identify();return this._handler_map[ew]=T},remove_interval_handler:function(ev,T){var ew;ew=ev.identify();if(this._handler_map[ew]===T){return delete this._handler_map[ew]}}};var cz;cz=A.SuggestionInput={register:function(ev){var T;ev=$(ev);T=ev.up("form");if(cz.defaulted(ev)||ev.getValue()===""){ev.setValue(ev.title)}else{ev.addClassName("suggestion-input-unfaded")}ev.observe("blur",this.blur.bind(this));ev.observe("focus",this.focus.bind(this));ev.observe("db:value_change",this.focus.bind(this));if(T){if(!ev.id){ev.id="r_elm_id_"+(Math.random().toString())}return T.observe("submit",cz.blank(ev.id).bind(this))}},register_all:function(){var ew,ey,ev,ex,T;ex=$$(".suggestion-input");T=[];for(ey=0,ev=ex.length;ey<ev;ey++){ew=ex[ey];T.push(this.register(ew))}return T},blank:function(T){return(function(ev){return function(){var ew;ew=$(T);if(!ew){return}if(ev.defaulted(ew)){return ew.setValue("")}}})(this)},defaulted:function(T){T=$(T);return T.getValue()===T.title},do_blank:function(T){return this.blank(T)()},clear:function(T){var ev;ev={target:T};return this.focus(ev)},focus:function(T){var ev;ev=$(T.target);if(!ev){return}if(this.defaulted(ev)){ev.addClassName("suggestion-input-unfaded");return ev.setValue("")}},blur_elm:function(T){if(T.getValue()===""){T.removeClassName("suggestion-input-unfaded");T.setValue(T.title)}return T.blur()},blur:function(T){var ev;ev=$(T.target);if(!ev){return}return this.blur_elm(ev)},reset:function(ev){var T;T=$(ev);if(!T){return}T.removeClassName("suggestion-input-unfaded");T.setValue(T.title);T.defaulted=true;return T.blur()},setValue:function(T,ev){var ew;ew=$(T);if(!ew){return}ew.addClassName("suggestion-input-unfaded");ew.setValue(ev);return ew.defaulted=false}};var a2;a2=A.TitleBubble=(function(){var ew,ev,eA,ex,ey,T,ez;ez=0;ew=0;T=function(eB){return ez=eB};ey=function(eG){var eL,eJ,eE,eI,eD,eB,eH,eC,eF,eK;eI=bf(eG.currentTarget);eK=eI.attr("title");if(eK!=null?eK.length:void 0){eI.attr("data-title",eK);eI.removeAttr("title")}eE=parseInt(eI.data("title-delay"));eJ="title-bubble-"+(ew++);eI.data("bubble-id",eJ);eL=bf("<div/>",{id:eJ,"class":"title_bubble_container"});if(!eE){eL.css({opacity:0});eL.addClass("has-transition")}if(eI.hasClass("white")){eL.addClass("white")}if(eI.hasClass("black")){eL.addClass("black")}eL.text(eI.attr("data-title"));eC=eI.attr("data-title-hide-tail")!=="yes";if(eC){eF=bf("<div/>",{"class":"tail"});eL.append(eF)}bf(document.body).append(eL);eB=eA(eI[0],eL[0]);eD=ev(eB,eL[0],eI[0]);eL.clonePosition(eI,{setWidth:false,setHeight:false,offsetTop:eD.top-ez,offsetLeft:eD.left});eL.addClass("position-"+eB);if(eC){eF.clonePosition(eI,{setWidth:false,setHeight:false,offsetTop:eD.top-ez+eD.tail_offset_top+bf(eL).outerHeight(),offsetLeft:eD.left+eD.tail_offset_left+(bf(eL).outerWidth()/2)})}eH=function(){var eM;if(!((eL.data("pending-delay"))&&(eI.data("bubble-id")===eJ))){return}eM=(parseInt(eI.data("title-fade-time")))||400;return eL.fadeIn(eM)};if(eE){eL.hide();eL.data("pending-delay",true);return setTimeout(eH,eE)}else{return eL.css({opacity:""})}};eA=function(eF,eB){var eE,eD,eC;eF=$(eF);eC=eF.getAttribute("data-title-position");eE=document.viewport.getDimensions();eD=eF.viewportOffset();if(!(eC==="above"||eC==="below"||eC==="right"||eC==="left")){eC="above"}if(eC==="left"){if(eD.left<eB.width){return"right"}}else{if(eC==="right"){if(eE.width-(eD.left+eF.getWidth())<eB.width){return"left"}}else{if(eC==="below"){if(eE.height-(eD.top+eF.getHeight())<eB.height){return"above"}}else{if(eC==="above"){if(eD.top<eB.height){return"below"}}}}}return eC};ev=function(eD,eK,eG){var eI,eE,eL,eH,eJ,eF,eB,eN,eM,eC;eK=$(eK);eG=$(eG);eL=document.viewport.getDimensions();eI=eK.getDimensions();eH=eG.viewportOffset();eE=6;eJ=0;eF=0;eM=0;eC=0;if(eD==="below"||eD==="above"){if(eD==="below"){eF=eG.getHeight()+eE}else{eF=(-1*eI.height)-eE}eB=eG.getWidth()/2-eI.width/2;if(eH.left+eB+eI.width>eL.width){eJ=eL.width-eH.left-eI.width;eM=eB-eJ-5}else{eJ=eB;eM=-5}}if(eD==="left"||eD==="right"){if(eD==="right"){eJ=eG.getWidth()+eE}else{eJ=(-1*eI.width)-eE}eN=eG.getHeight()/2-eI.height/2;if(eH.top+eN+eI.height>eL.height){eF=eL.height-eH.top-eI.height;eC=eN-eF-5}else{eF=eN;eC=-5}}return{left:eJ,top:eF,tail_offset_left:eM,tail_offset_top:eC}};ex=function(eC){var eB,eD,eE;eE=bf(eC!=null?eC.currentTarget:void 0);eB=bf("#"+eE.data("bubble-id"));if(eB.data("pending-delay")){eB.removeData("pending-delay");eD=(parseInt(eE.data("title-fade-time")))||400;return eB.fadeOut(eD,function(){return eB.remove()})}else{return eB.remove()}};return{init:function(){bf(document).on("mouseenter",".title_bubble",ey);bf(document).on("mouseleave",".title_bubble",ex).on("mouseup",".title_bubble",ex);bf(document).on("mouseenter",".title_bubble_sticky",ey);return bf(document).on("mouseleave",".title_bubble_sticky",ex)},set_vertical_space:T,hide_all:function(){return bf(".title_bubble_container").remove()}}})();var dG;dG=INLINE_JS.Tooltip=A.Tooltip={attach:function(ez,ew,T,ev){var ey,ex;if(ev==null){ev={}}ez=$(ez);T=(T?$(T):null);ey=dJ.make(ew,ez.tail_position,ev.tail_position,ev.width,ev);ey.setStyle({display:"none",position:"absolute"});$("floaters").__sert(ey);if(ez.match("#modal-content *")||ez.match(".db-modal-content *")){ey.style.zIndex="13001"}else{ey.style.zIndex=""}if(ez.tail_position==="right"){ex=(ds.ie?32:12);ey.style.marginLeft=-(ey.getWidth()+ez.getWidth()+ex)+"px"}ez.tooltip=ey;ez.out_target=(T?true:false);ez.observe("mouseout",this.mouseout("target",ez));ez.observe("mouseover",this.mouseover("target",ez));ez.out_trigger=(T?false:true);if(T){T.observe("mouseout",this.mouseout("trigger",ez));T.observe("mouseover",this.mouseover("trigger",ez))}ez.out_tooltip=true;ey.observe("mouseout",this.mouseout("tooltip",ez));return ey.observe("mouseover",this.mouseover("tooltip",ez))},update:function(ev,T){if(ev.tooltip){return $(ev.tooltip).update(T)}},mouseover:function(T,ev){return function(){return ev["out_"+T]=false}},mouseout:function(T,ev){return function(){ev["out_"+T]=true;return dG.hide_if_out.defer(ev)}},show_by:function(ev){var ew,T;ew=bf(ev.tooltip);ev=bf(ev);ew.show();T=Math.floor(ew[0].offsetHeight/2);return ew.clonePosition(ev,{setWidth:false,setHeight:false,offsetTop:Math.floor(ev[0].offsetHeight/2)-T,offsetLeft:ev[0].offsetWidth+1})},hide_if_out:function(T){var ev;if(!T.out_target||!T.out_trigger||!T.out_tooltip){return}ev=$(T.tooltip);return ev.hide()},show:function(ey,ex,ev,T,ew){if(T==null){T="left"}ey=$(ey);if(!ey.tail_position){ey.tail_position=T}ev=(ev?$(ev):null);if(!ey.tooltip){this.attach(ey,ex,ev,ew)}return this.show_by(ey)}};var bC;bC=INLINE_JS.TreeView=A.TreeView={tv:{},loaded:false,set_params:function(T){return this.ajax_params=T},init:function(ew,T,ex){var ev;if(ex==null){ex="treeview"}this.tv[ex]={};ev=this.tv[ex];ev.autohide=(T===null?true:T);ev.handler=ew;ev.viewdiv=$(ex);ev.hidefunc=this.hide.bindAsEventListener(this);this.ajax_params={};document.observe(be.ADD,(function(ey){return function(ez){return ey.schedule_reset()}})(this));document.observe(be.REMOVE,(function(ey){return function(ez){return ey.schedule_reset()}})(this));return document.observe(be.MOVE,(function(ey){return function(ez){return ey.schedule_reset()}})(this))},schedule_reset:function(){return this.loaded=false},reset:function(ex){var ev,ew,T;ev={url:"/ajax_subtreeview",type:"post",data:bf.extend({},this.ajax_params),success:(function(ey){return function(eA){var eB,ez;ez=[];for(eB in ey.tv){if(ey.tv.hasOwnProperty(eB)){ey.tv[eB].viewdiv.down(".treeview-folders").update(eA);if(ex&&ex.onSuccess){ez.push(ex.onSuccess(eA))}else{ez.push(void 0)}}else{ez.push(void 0)}}return ez}})(this)};if(ex!=null?ex.user:void 0){ev.subject_user=ex.user;T=cj.get_role_title(ex.user);if(cj.get_viewer().is_paired){if(ex.user.is_team){ew="s_briefcase"}else{ew="s_house"}}else{ew="dropbox"}if(!T){T=dU("Dropbox")}bf("#first-treeview-link span").text(T);b6.replace(bf("#root-img")[0],"web","dropbox",ew)}else{bf("#first-treeview-link span").text(dU("Dropbox"))}return bf.ajax(ev)},toggle:function(ew,ev){var T;Event.stop(ew);T=this.tv[ev||"treeview"];if(T.shown){T.shown=false;this.hide(ew,ev)}else{T.shown=true;this.show(ew.target,ev)}return false},hide:function(ew,ev){var T;T=this.tv[ev||"treeview"];if(!ew||!$(ew.target).descendantOf(T.viewdiv)){T.viewdiv.hide();Event.stopObserving(window,"click",T.hidefunc);return T.shown=false}},show:function(ew,ev){var ex,T;T=this.tv[ev||"treeview"];ew=$(ew);ew.blur();ex=ew.cumulativeOffset();T.viewdiv.setStyle({top:(ex.top+ew.getHeight())+"px",left:(ex.left-4)+"px"});T.viewdiv.show();return Event.observe(window,"click",T.hidefunc)},toggleNode:function(ev){var T;ev=$(ev);T=ev.down("img");if(T.className.match("bullet_plus")){b6.replace(T,"web","bullet_plus","bullet_minus")}else{b6.replace(T,"web","bullet_minus","bullet_plus")}ev.up().next("div").toggle();ev.blur();return false},toggleNodeAjax:function(ex,T,ev){var ew,ey;if(ex.fetched_children){return this.toggleNode(ex)}ex=$(ex);ew=ex.down("img");ey=b6._get(ew);ew.src="/static/images/icons/ajax-loading-small.gif";bf.ajax({url:"/ajax_subtreeview"+T,type:"post",data:bf.extend({},this.ajax_params),subject_user:ev,success:(function(ez){return function(eA){var eB;eB=new Element("div",{style:"display: none;"}).update(eA);ex.up().__sert({after:eB});ex.fetched_children=true;b6._set(ew,ey);return ez.toggleNode(ex)}})(this),complete:function(){if(/loading/.match(ew.src)){return b6._set(ew,ey)}}});return false},handle:function(ew,ev){var ex,T;ex=$H(this.tv).keys();T=$(ev).ancestors().find(function(ey){return ex.include(ey.id)});if(!T){return}T=this.tv[T.id];bf(document).trigger("db:treeview_selected",[ew]);if(T.handler){T.handler(ew,ev)}if(T.autohide){this.hide(T.id)}return false},move:function(ew,ex,ev){var T;T=$(ew);if(!this.loaded){this.reset({onSuccess:(function(ey){return function(){ey.loaded=1;return ey.move(ew,ex,ev)}})(this),user:ev!=null?ev.user:void 0})}else{if(ev&&ev.onSuccess){ev.onSuccess()}}ci(T,"Couldn't find tree_id");ci($(ex),"Couldn't find location_id");$(ex).appendChild(T);return T.show()}};var aC;aC=A.ULSelectMenu=(function(){var ex,eB,ew,eC,eD,ey,eA,T,ez,ev,eE;ex=function(eF){return eF.removeClassName("shown")};eE=function(eF){return eF.toggleClassName("shown")};eA=function(){return this.removeClassName("hover")};ey=function(){return this.addClassName("hover")};T=function(eJ,eI){var eF,eK,eH,eG;eG=[];for(eK=0,eH=eI.length;eK<eH;eK++){eF=eI[eK];eG.push(eJ.insert(eF))}return eG};eC=function(eH,eF,eG){T(eH,eG);if(eH.firstChild!==eF){return eH.__sert({top:eF})}};ez=function(eG,eH){var eF;eF="selected";bf(eG).find("."+eF).removeClass(eF);return bf(eH).addClass(eF)};ev=function(eH,eK){var eL,eJ,eG,eI,eF;eI=eH.select("li");eF=[];for(eJ=0,eG=eI.length;eJ<eG;eJ++){eL=eI[eJ];if(eL.getAttribute("data-value")===eK){eF.push(ez(eH,eL))}else{eF.push(void 0)}}return eF};eD=function(eF,eH,eG){return function(eI){if(!eF.hasClassName("selected")){ez(eH,eF);eH.fire("db:change",eF.getAttribute("data-value"));return ex(eH)}else{eC(eH,eF,eG);return eE(eH)}}};eB=function(eH){var eK,eN,eJ,eG,eM,eF,eI,eL;eN=eH.select("li");ci(eN.length,"Empty list of options "+eH.identify());eJ=void 0;if(eN.length===1){eH.addClassName("one")}else{for(eI=0,eL=eN.length;eI<eL;eI++){eK=eN[eI];eM=eK.getAttribute("data-value");ci(eM,eK.identify()+" missing data value");eK.observe("click",eD(eK,eH,eN));eK.observe("mouseenter",ey);eK.observe("mouseleave",eA);if(eK.hasClassName("selected")){eJ=eK}}$(document.body).observe("click",function(eO){if($(eO.target).up(".ul_select_menu")===eH){return}return ex(eH)})}if(!eJ){eJ=eN[0]}eJ.addClassName("selected");eF=new Element("span");eG=eJ.getDimensions();eF.setStyle({width:eG.width+"px",height:eG.height+"px",position:"relative",display:"inline-block"});return eH.wrap(eF)};ew=function(){var eJ,eI,eG,eH,eF;eH=$$(".ul_select_menu");eF=[];for(eI=0,eG=eH.length;eI<eG;eI++){eJ=eH[eI];eF.push(eB(eJ))}return eF};bf(ew);return{init:function(eF){return eB(eF)},set_selected_by_value:ev}})();var D;D=A.DBCalendar=Class.create({initialize:function(ev,T){this.options=T||{};this.container=$(ev);ci(this.container,"Couldn't find the element");this.today=new Date();if(this.options.disable_future){this.options.last_day=ds.start_of_day(this.options.last_day||this.today)}if(this.options.disable_past){this.options.first_day=ds.start_of_day(this.options.first_day||this.today)}this.view_date=ds.start_of_day(this.options.selected_date||this.today);this.selected_date=ds.start_of_day(this.options.selected_date||this.today);return this.render()},_change_month:function(ev,T){Event.stop(ev);this.view_date.setMonth(T);return this.render()},is_valid_date:function(ex,ez,ey,ew,T){var ev;ex=parseInt(ex,10);ez=parseInt(ez,10);ey=parseInt(ey,10);ew=parseInt(ew,10);T=parseInt(T,10);ew=ew||1970;T=T||(new Date()).getFullYear()+1;ez+=1;if(ey<ew){return false}if(ey>T){return false}if(ez<1||ez>12){return false}if(ex<=0){return false}if(ez===2){ev=((ey%4)===0)&&(((ey%100)!==0)||((ey%400)===0));if(ev){return ex<=29}else{return ex<=28}}else{if(ez===4||ez===6||ez===9||ez===11){return ex<=30}else{return ex<=31}}},change_date:function(T,ex,ev){var ew;if(!this.is_valid_date(T,ex,ev)){return}ew=ev!==this.view_date.getFullYear()||ex!==this.view_date.getMonth();this.selected_date.setDate(T);this.selected_date.setMonth(ex);this.selected_date.setFullYear(ev);if(ew){this.view_date.setMonth(ex);this.view_date.setFullYear(ev);this.render()}else{bf(this.container).find(".selected").removeClass("selected");bf(this.container).find("a#day"+T+"-"+ex).addClass("selected")}if(this.options.onDateChange){return this.options.onDateChange(this.selected_date)}},render:function(){var ex,eD,eB,ez,ey,ev,eA,ew,eC,T;eD=this.render_days();ez=bf(".current-month",eD);eA=ez.first().data("date");ev=ez.last().data("date");T=eA<=this.options.first_day;eC=ev>=this.options.last_day;ex=new Element("div");ex.addClassName("calendar clearfix");if(!eC){this._next_month=(function(eE){return this._change_month(eE,this.view_date.getMonth()+1)}).bind(this);ey=new Element("a");ey.addClassName("changemonth next");ey.update(b6.make("web","arrowright",{}));Event.observe(ey,"click",this._next_month);ex.__sert(ey)}if(!T){this._prev_month=(function(eE){return this._change_month(eE,this.view_date.getMonth()-1)}).bind(this);ew=new Element("a");ew.addClassName("changemonth prev");ew.update(b6.make("web","arrowleft",{}));Event.observe(ew,"click",this._prev_month);ex.__sert(ew)}eB=new Element("h5");eB.update(dU("%(month)s %(year)s",{comment:"For example 'January 2010'. This is used as part of a calendar."}).format({month:bE.month_name(this.view_date.getMonth()),year:this.view_date.getFullYear()}));ex.__sert(eB);ex.__sert(eD);return this.container.__date(ex)},render_days:function(){var eB,eA,T,ez,ev,ey,ex,ew;eA=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);ex=eA.getDay();eB=new Element("div");eB.addClassName("days");for(T=ew=ex;ex<=0?ew<0:ew>0;T=ex<=0?++ew:--ew){ey=new Date(eA.getFullYear(),eA.getMonth(),eA.getDate());ey.setDate(ey.getDate()-T);eB.__sert(this.render_day(ey,true))}ez=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);while(ez.getMonth()===this.view_date.getMonth()){eB.__sert(this.render_day(ez));ez=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),ez.getDate()+1)}ev=new Date(this.view_date.getFullYear(),this.view_date.getMonth()+1,0);while(ev.getDay()!==6){ev=new Date(ev.getFullYear(),ev.getMonth(),ev.getDate()+1);eB.__sert(this.render_day(ev,true))}return eB},render_day:function(ev,ex){var T,ew;ew=!ex;if(this.options.last_day){ex=ex||ev>this.options.last_day}if(this.options.first_day){ex=ex||ev<this.options.first_day}T=new Element(ex?"span":"a");bf(T).data("date",ev);if(ew){T.addClassName("current-month")}T.update(ev.getDate());T.addClassName("date");T.writeAttribute("id","day"+ev.getDate()+"-"+ev.getMonth());if(this.selected_date.getDate()===ev.getDate()&&this.selected_date.getMonth()===ev.getMonth()&&this.selected_date.getFullYear()===ev.getFullYear()){T.addClassName("selected")}if(ex){T.addClassName("inactive")}else{this._handler=(function(ez){var ey;ey=ez.target.identify().substr(3).split("-");return this.change_date(ey[0],this.view_date.getMonth(),this.view_date.getFullYear())}).bind(this);Event.observe(T,"click",this._handler)}return T}});var aE;aE=A.DatePickerInput=Class.create({initialize:function(T,ew){var ez,ex,ey,ev;this.container=T;this.options={};Object.extend(this.options,ew||{});this.input=this.container.down(".input-date");this.display=this.container.down(".visible-date");ev=(this.input.value?ds.from_mysql_date(this.input.value):new Date());if(this.container.hasAttribute("data-first")){ey=ds.from_mysql_date(this.container.getAttribute("data-first"))}ez=this.options.disable_future!=null?this.options.disable_future:true;ex=this.options.disable_past!=null?this.options.disable_past:true;this.cal_container=this.container.down(".cal-container");this.calendar=new D(this.cal_container,{onDateChange:this.onDateChange.bind(this),first_day:ey,disable_future:ez,disable_past:ex,selected_date:ev});this.container.observe("click",this.show_cal.bindAsEventListener(this));$(document.body).observe("click",this.hide_cal.bind(this));return this.onDateChange(ev)},show_cal:function(ev){var T;if(ev){Event.stop(ev)}T=$(ev.target);if(T.match(".cal-container")||T.up(".cal-container")){return}bf(".cal-container").hide();return this.cal_container.show()},hide_cal:function(){return this.cal_container.hide()},onDateChange:function(T){this.input.value=ds.to_mysql_date(T,false);this.display.update(I.localize(T));return this.hide_cal()}});var et;et=A.TextInputDatePicker=Class.create({initialize:function(ex,ew){var ez,ey,ev,T;this.options={include_seconds:true,include_microseconds:true,choose_eod:false};Object.extend(this.options,ew||{});this.input=$(ex);ci(this.input,"Couldn't find the element "+ex.toString());ev=new Date();T=(this.input.value?ds.from_mysql_date(this.input.value):false);ey=new Date(ev.getUTCFullYear(),ev.getUTCMonth(),ev.getUTCDate());this.cal_icon=b6.make("web","calendar_view_month",{align:"absmiddle"});this.cal_container=new Element("div",{id:"cal_container_"+ex,style:"display: none; position: absolute; z-index: 1"});this.calendar=new D(this.cal_container,{onDateChange:this.onDateChange.bind(this),last_day:ey,selected_date:T});this.input.__sert({after:this.cal_icon});this.cal_icon.observe("click",this.toggle_cal.bindAsEventListener(this));ez=bf(this.input);bf(this.cal_container).clonePosition(ez,{setWidth:false,setHeight:false,offsetTop:ez[0].offsetHeight});return this.cal_icon.__sert({after:this.cal_container})},toggle_cal:function(T){if(T){Event.stop(T)}return this.cal_container.toggle()},hide_cal:function(T){if(T){Event.stop(T)}return this.cal_container.hide()},onDateChange:function(T){if(this.options.choose_eod){T.setTime(ds.start_of_day(T).getTime()+86399999)}this.input.value=ds.to_mysql_date(T,this.options.include_seconds,this.options.include_microseconds);return this.hide_cal()}});ae.window_load(O.register.bind(O));bf(bS.init.bind(bS));bf(cz.register_all.bind(cz));Event.observe(window,"scroll",function(){return a2.hide_all()});bf(function(){V.interval=setInterval(V.check.bind(V),500);da.init();return a2.init()});var aG;aG=A.LocaleSelector={init:function(){bf(document).on("click",".modal-locale-link",(function(T){return function(ev){ev.preventDefault();return T.show()}})(this));bf(document).on("click",".modal-locale-link-index-page",(function(T){return function(ev){ev.preventDefault();T.logShow();return T.show()}})(this));return bf(document).on("click",".modal-team-locale-link",(function(T){return function(ev){ev.preventDefault();return T.show_team_modal()}})(this))},show:function(){if(!this.modal){this.modal=new ej({element_id:"locale-selector-modal"})}return this.modal.show()},logShow:function(){return bf.ajax({url:"https://"+Constants.WEBSERVER+"/log_user_opened_locale_selector",type:"POST"})},show_team_modal:function(){if(!this.team_modal){this.team_modal=new a0({element_id:"locale-selector-modal"})}return this.team_modal.show()}};bf(function(){return aG.init()});var aU,am={}.hasOwnProperty,cl=function(ex,ev){for(var T in ev){if(am.call(ev,T)){ex[T]=ev[T]}}function ew(){this.constructor=ex}ew.prototype=ev.prototype;ex.prototype=new ew();ex.__super__=ev.prototype;return ex};aU=INLINE_JS.ChangeNameModal=A.ChangeNameModal=(function(T){cl(ev,T);function ev(){ev.__super__.constructor.call(this,{element_id:"change-name-modal"});this.on_confirm_button_click=(function(ew){return function(eA){var ez,ex,ey;eA.preventDefault();ez=bf(eA.target);ex=ez.closest("form");ey=function(){ew.hide();return location.reload()};return bs.ajax_submit(ex[0],false,ey,null,ez[0])}})(this)}return ev})(du);var bv,dP,cU=function(T,ev){return function(){return T.apply(ev,arguments)}},am={}.hasOwnProperty,cl=function(ex,ev){for(var T in ev){if(am.call(ev,T)){ex[T]=ev[T]}}function ew(){this.constructor=ex}ew.prototype=ev.prototype;ex.prototype=new ew();ex.__super__=ev.prototype;return ex};dP=A.ManageAliasModal=(function(ev){cl(T,ev);function T(ew){this.options=ew;this._poll_until_verified=cU(this._poll_until_verified,this);this._get_params_from_target=cU(this._get_params_from_target,this);this._on_load=cU(this._on_load,this);this._show_action_panel=cU(this._show_action_panel,this);this._input_enter_handler=cU(this._input_enter_handler,this);this.resend_verify=cU(this.resend_verify,this);this.remove_alias=cU(this.remove_alias,this);this.add_alias=cU(this.add_alias,this);this.refresh_alias=cU(this.refresh_alias,this);this.on_show=cU(this.on_show,this);T.__super__.constructor.call(this,this.options)}T.prototype.before_show=function(ew){T.__super__.before_show.call(this,ew);this.polling=0;ew.find(".alias-action").on("click",this._show_action_panel);ew.find(".alias-action-submit").on("click",this.add_alias);ew.find("form").submit(function(){return false});return ew.find(".alias-action-inputs input").on("keyup",this._input_enter_handler)};T.prototype.on_show=function(){return this.refresh_alias(true,this._poll_until_verified)};T.prototype.refresh_alias=function(ex,ew){if(ex==null){ex=true}if(ex){bs.clear_errors()}return new Ajax.DBRequest("/account/alias/get",{subject_user:this.options.subject_user,onSuccess:(function(ey){return function(ez){ey.$modal_window.find(".dynamic-content").html(ez.responseText);ey._on_load(ez);if(typeof ew==="function"){return ew()}}})(this),onFailure:(function(ey){return function(ez){return ey.hide()}})(this)})};T.prototype.add_alias=function(ez){var ey,ew,ex,eA;ez.preventDefault();ew=bf(ez.currentTarget).closest("form");ey=ew.find(".alias-action-submit");eA={};eA[Constants.UID_PARAM_NAME]=this.options.subject_user.id;ex=(function(eB){return function(){var eC;eB.$modal_window.find(".alias-action-inputs input").val("");eB.polling=0;eC=eB.polling?null:eB._poll_until_verified;return eB.refresh_alias(true,eC)}})(this);return bs.ajax_submit(ew[0],false,ex,false,ey[0],eA,"before")};T.prototype.remove_alias=function(ew){var ex;ew.preventDefault();ex=this._get_params_from_target(ew.currentTarget);return new Ajax.DBRequest("/account/alias/remove",{subject_user:this.options.subject_user,parameters:ex,onSuccess:(function(ey){return function(ez){return ey.refresh_alias()}})(this)})};T.prototype.resend_verify=function(ew){var ex;ew.preventDefault();ex=this._get_params_from_target(ew.currentTarget);return new Ajax.DBRequest("/account/alias/send_verify",{subject_user:this.options.subject_user,parameters:ex,onSuccess:(function(ey){return function(ez){return ey.refresh_alias()}})(this)})};T.prototype._input_enter_handler=function(ew){ew.preventDefault();ew.stopPropagation();if(ew.which===13){return this.add_alias(ew)}};T.prototype._show_action_panel=function(ey){var ex,ew;ey.preventDefault();ew=bf(ey.currentTarget).data("target");this.$modal_window.find(".alias-action-panel").hide();ex=this.$modal_window.find("#"+ew).show();return ex.find("input:visible:enabled:first").focus()};T.prototype._on_load=function(ew){aT.register_all();this.$dynamic=this.$modal_window.find("#alias-list-container");this.$dynamic.on("click",".alias-remove",(function(ex){return function(ey){return ex.remove_alias(ey)}})(this));return this.$dynamic.on("click",".alias-verify",(function(ex){return function(ey){return ex.resend_verify(ey)}})(this))};T.prototype._get_params_from_target=function(ey){var ew,ex,ez;ew=bf(ey);ez=ew.data("alias-type");ex=ew.closest(".alias-row").find(".alias-text").text();return{alias:ex,alias_type:ez}};T.prototype._poll_until_verified=function(){var ey,ez,ex,ew;ez=5;ey=60;ex=(function(eA){return function(){return eA.refresh_alias(false,eA._poll_until_verified)}})(this);ew=this.$dynamic.find(".alias-verify").length;if(ew&&this.polling<ey){this.polling++;return setTimeout(ex,ez*1000)}else{return this.polling=0}};return T})(du);bv=INLINE_JS.AliasManager=A.AliasManager={show:function(ey){var ew,ex,ev,T;T=cj.get_viewer().get_user_by_role(ey);if(T==null){return}if(!T.is_email_verified){if(ey===Constants.ROLE_PERSONAL){personal_email_verification.verified_or_show()}else{work_email_verification.verified_or_show()}return}ev=cj.get_viewer().is_paired?ey:"";ex=dU("Manage your %(role_show)s contact methods").format({role_show:ev});ew=new dP({element_id:"manage-alias",title:ex,subject_user:T,role:T.role});ew.show()}};var cW;cW=INLINE_JS.BonusTable=A.BonusTable={_tmpl:null,_inited:null,_next_page:0,_fetching_page:false,init:function(T){this.user_id=T;if(cW._inited){return}cW._inited=true;$("bonus-loading").show();cW._tmpl=es.tmpl("bonus_row_tmpl");cW.listen();return cW.get_next_page()},_render:function(ex){var ev,ey,ew,T;ev=[];for(ew=0,T=ex.length;ew<T;ew++){ey=ex[ew];ev.push(cW._tmpl({row:ey,Sprite:b6}))}return $("bonus-table").__sert(ev)},get_next_page:function(){if(cW._fetching_page){return}cW._fetching_page=true;return new Ajax.DBRequest("/account/bonus_page/"+cW._next_page,{onSuccess:function(ev){var ex,T,ew;ex=ev.responseText.evalJSON();ew=ex.rows;T=ex.has_more;cW._render(ew);$("bonus-loading").hide();if(T){cW._next_page+=1;$("load-more-bonus").show()}else{$("load-more-bonus").hide()}return cW._fetching_page=false},subject_user:this.user_id})},_max_referral_over:function(ev){var T,ex,ew;ex=bf(ev.currentTarget);ew=dU("You've earned the maximum amount of referral space. Thanks for inviting people to Dropbox!");T=bf(dJ.make(ew,"right","middle"));Element.absolutize(T[0]);ex.append(T);T.clonePosition(ex,{setWidth:false,setHeight:false});return T.css({width:"200px",left:(parseInt(T.css("left"),10)-210)+"px",top:(parseInt(T.css("top"),10)-55)+"px"})},_max_referral_out:function(ez){var T,ey,ew,ex,ev;ex=bf(".reached-max-referral-bonus .bubble");ev=[];for(ey=0,ew=ex.length;ey<ew;ey++){T=ex[ey];ev.push(T.remove())}return ev},listen:function(){bf("#load-more-bonus").on("click",cW.get_next_page.bind(cW));bf(document).on("mouseenter",".reached-max-referral-bonus",cW._max_referral_over);return bf(document).on("mouseleave",".reached-max-referral-bonus",cW._max_referral_out)},toggle:function(){if(bf("#bonus-list").is(":visible")){this.hide();return bf("#space-earned-link").text(dU("View all space earned"))}else{this.show();return bf("#space-earned-link").text(dU("Hide space earned"))}},show:function(){return bf("#bonus-list").slideDown(150)},hide:function(){return bf("#bonus-list").slideUp(150)}};var z,s,c;z=INLINE_JS.DowngradeReasons=A.DowngradeReasons={reasons:{},addReason:function(T){return this.reasons[T]=true},addReasons:function(T){var ex,ey,ew,ev;ev=[];for(ey=0,ew=T.length;ey<ew;ey++){ex=T[ey];ev.push(this.addReason(ex))}return ev},change:function(ez,ew,T){var eA,eC,eB,ex,ev,ey;ez=parseInt(ez,10);eC=$(ew);ci(eC,"Couldn't find container for DowngradeReason");eA=false;ey=this.reasons;for(ex in ey){eB=ey[ex];ev=$(T+ex);ci(ev,"Couldn't find container for ",T+ex);if(eB&&parseInt(ex,10)===ez){ev.show();eA=true}else{ev.hide()}}if(eA){return eC.show()}else{return eC.hide()}}};s=A.DowngradeReasons2={init:function(){var ev,ex,T,ew;ew=["input[name=downgrade_reason_id]","input[name=other_reason_id]"];for(ex=0,T=ew.length;ex<T;ex++){ev=ew[ex];bf(ev).change(function(ez){var ey;ey=ez.target.id.indexOf("other")>=0;return s.change(ey,ez.target.getValue())})}return bf(".shared-additional-info").attr("name","shared_additional_info")},change:function(ew,T){var ev;bf(".downgrade-other-reason .error-message").hide();if(ew){return}ev="#downgrade-info-"+T;bf(".downgrade-info").hide();bf(ev).show();bf(".downgrade-info textarea").removeAttr("name");bf(ev+" textarea").attr("name","additional_info");return bf("input[name=other_reason_id]").removeAttr("checked")}};c=A.DowngradeSurvey={init:function(){var T;T="#downgrade-survey-form";return bf(""+T).on("submit",(function(ev){return function(ey){var ex,ew;ew=bf(""+T+" input[name=other_reason_id]:checked").length;ex=bf(""+T+" input[id=downgrade-radio-8]");if(ex.is(":checked")&&ew===0){bf(".downgrade-other-reason .error-message").show();return ey.preventDefault()}}})(this))}};var bL;bL=INLINE_JS.GetSpace=A.GetSpace={_current_space:null,_why_msg:null,_twitter_url:null,offer_highlight_color:"#ffa",init:function(ew,ev,ex){var T;bL._current_space=ew;bL._why_msg=ev;bL._twitter_url=ex;$("space-actions").on("click",".space-action",bL.perform_action);T=C.parse(window.location.href).fragment;if(T){return bL.highlight_offer(T)}},highlight_offer:function(ev){var T,ew;T=bf("#"+ev);ew=T.css("background-color");return T.css("background-color",bL.offer_highlight_color).delay(2000).animate({"background-color":ew}).queue(function(){return T.css("background-color","")})},perform_action:function(ev){var ew,T;T={contact_sales:bL._contact_sales,contact_support:bL._contact_support,teams:bL._teams,upgrade:bL._upgrade,plans:bL._plans,refer:bL._refer,get_started:bL._get_started,fb_link:bL._fb_link,twitter_link:bL._twitter_link,twitter_follow:bL._twitter_follow,why_like:bL._why_like,mailbox_link:bL._mailbox_link};ew=$(ev.target);if(!ew.hasClassName("space-action")){ew=ew.up(".space-action")}return T[ew.id]()},_teams:function(){return window.location.href="/business?tk=dropbox&ag=getspace&ad=v1"},_contact_sales:function(){return window.location.href="mailto:sales@dropbox.com"},_contact_support:function(){return window.location.href="/support"},_plans:function(){return window.location.href="/plans"},_upgrade:function(){return window.location.href="/upgrade"},_refer:function(){return window.location.href="/referrals"},_get_started:function(){return window.location.href="/gs"},_fb_link:function(){return dN.do_auth(function(){bL._refresh_link_bonuses();return bL._completed($("fb_link"))},cj.get_viewer().personal_user.id)},_twitter_link:function(){return cc.do_auth(function(){bL._refresh_link_bonuses();cc.set_is_authed(cj.get_viewer().personal_user.id,true);return bL._completed($("twitter_link"))},cj.get_viewer().personal_user.id)},_twitter_follow:function(){if(cc.is_authed(cj.get_viewer().personal_user.id)){return bL.follow_dropbox()}else{return cc.do_auth(bL.follow_dropbox,cj.get_viewer().personal_user.id)}},_why_like:function(){ep.show(dU("Tell us why you love Dropbox"),$("why-i-like-modal"));$("why-i-like-input").focus();return ds._track_twitter_chars_left("why-i-like-input",90)},_mailbox_link:function(){return window.location.href="http://www.mailboxapp.com/"},follow_dropbox:function(){if(!cc.is_authed(cj.get_viewer().personal_user.id)){bL._refresh_link_bonuses();cc.set_is_authed(cj.get_viewer().personal_user.id,true)}return cc.follow_dropbox({showWorking:function(){return $("twitter_follow").down(".title").__date(dU("Following Dropbox on Twitter..."))},onFailure:function(){return $("twitter_follow").down(".title").__date(dU("Follow Dropbox on Twitter"))},onSuccess:function(){if($("twitter_link")&&$("twitter_link").visible()){bL._completed($("twitter_link"))}return bL._completed($("twitter_follow"))}},cj.get_viewer().personal_user.id)},submit_why:function(){bL._why_msg=$F("why-i-like-input");return bs.ajax_submit($("why-i-like-form"),false,(function(){ep.hide();return bL._completed($("why_like"))}),false,$("why-i-like-submit"))},_completed:function(ev){var T;ev.addClassName("completed");ev.down(".icon-col").__date(b6.make("web","check_36"));bf(ev).css("opacity",0.5).fadeTo(500,1);setTimeout((function(){return bf(ev).css("opacity",1).slideUp().animate({opacity:0},{queue:false,duration:"normal"})}),1500);T=parseInt(ev.down(".space").readAttribute("data-space"),10);bL._current_space+=T;$("current-space").__date(at.format_bytes(bL._current_space));$("current-space").addClassName("updated");return setTimeout((function(){return $("current-space").removeClassName("updated")}),5000)},_refresh_link_bonuses:function(){return new Ajax.DBRequest("/social_recheck")}};var ba;ba=A.Help={toggle_more_help:false,show_os:function(ev,ew,T){ew=$(ew);$$(".os-filter").invoke("removeClassName","selected");ew.addClassName("selected");$$(".help-os-section").invoke("hide");$$(".help-os-"+T).invoke("show");return Event.stop(ev)},vote:function(T,ev){new Ajax.DBRequest("/help/"+T+"/vote/"+ev);bf("#help-vote-cont").fadeOut();return Y.success(dU("Thanks for your feedback!"))}};var dR,dg,X,r,cU=function(T,ev){return function(){return T.apply(ev,arguments)}},am={}.hasOwnProperty,cl=function(ex,ev){for(var T in ev){if(am.call(ev,T)){ex[T]=ev[T]}}function ew(){this.constructor=ex}ew.prototype=ev.prototype;ex.prototype=new ew();ex.__super__=ev.prototype;return ex};dg=INLINE_JS.Hosts=A.Hosts={attach_host_listener:function(ey,ew){var ev,ex,ez,T;ev=bf("#"+ey);ez=ev.data("host-ids");ex=ev.data("display-name");T=function(){return new X(ez,ex,ew,null,null).show()};return bf(".unlink-host-link",ev).on("click",T)},edit:function(ez,ew){var ev,eA,eB,ey,ex,T;eB=bf("#host-device-row-"+ew+" .host-item .sprite-text");if(eB.data("editing")==="true"){return false}eB.data("editing","true");eA=eB.text();eB.data("previous",eA);ez=$u.values(ez);ey=bf('<input type="text" class="name-input skinny-input" size="20" maxlength="256" style="word-wrap: break-word;" />').val(eA);T=bf('<input type="button" class="button">').val(dU("Save"));T.on("click",function(){return dg.doneEditing(ez,ew)});ev=bf('<input type="button" class="button grayed">').val(dU("Cancel"));ev.on("click",function(){return dg.cancelEditing(ew)});eB.empty();eB.append(ey,"&nbsp;",T,"&nbsp;",ev);ex=bf("input",eB);ex.on("keydown",function(){return dg.checkKey(ez,ew)});return ex.focus()},doneEditing:function(ew,ev){var ex,T;ex=bf("#host-device-row-"+ev+" .host-item .sprite-text");T=bf("input",ex).val();return bf.ajax({url:"/account/change_host_name",data:{host_ids:JSON.stringify(ew),name:T},type:"POST"}).success(function(ey){return dg.unedit(ex,JSON.parse(ey).display_name)})},cancelEditing:function(T){var ev;ev=bf("#host-device-row-"+T+" .host-item .sprite-text");return dg.unedit(ev,ev.data("previous"))},unedit:function(ev,T){ev.data("editing","false");return ev.text(T)},dismiss:function(ew,ev,ex,T,ey){new bf.ajax("/account/dismiss_unlink",{type:"POST",data:{host_id:ew,user_id:ev,team_id:ex},subject_user:ey,success:function(ez){return T.remove()}});return false},checkKey:function(ev,T){return function(ew){ew=ew||window.event;if(ew.keyCode===Event.KEY_RETURN){dg.doneEditing(ev,T)}if(ew.keyCode===Event.KEY_ESC){return dg.cancelEditing(T)}}},show_device_unlink_modal:function(ex,ey,eA,ew,ev,eC,T){var eB,ez;eB=bf("#unlink-device-modal-"+eC);ez={both:$u.values(ev),personal:[ev[Constants.ROLE_PERSONAL]],work:[ev[Constants.ROLE_WORK]]};ep.show(ew,eB[0]);if($u.values(ev).length>1){eB.addClass("show-selector")}return bf("form input[type=submit]",eB).on("click",function(eD){eD.preventDefault();ev=ez[bf(".unlink-select select",eB).val()];bs.add_vars(bf("form",eB)[0],{user_ids:JSON.stringify(ev),app_id:ey,device_id:JSON.stringify(ex),device_name:T});return bf("form",eB).submit()})}};dR=A.DeleteFailuresModal=(function(T){cl(ev,T);function ev(){this.on_show=cU(this.on_show,this);this.on_confirm_button_click=cU(this.on_confirm_button_click,this);return ev.__super__.constructor.apply(this,arguments)}ev.prototype.on_confirm_button_click=function(ew){ew.preventDefault();window.location.href="/delete_failures?host_id="+this.host_id;return this.hide()};ev.prototype.on_show=function(ex){var ew;ew=aR("Dropbox couldn't delete %(num_failures)d file from the computer <strong>%(host_name)s</strong>. You can download the name of this file and the reason why it couldn't be deleted.","Dropbox couldn't delete %(num_failures)d files from the computer <strong>%(host_name)s</strong>. You can download the names of these files and the reasons why they couldn't be deleted.",this.num_failures).format({host_name:this.name.escapeHTML(),num_failures:this.num_failures});return this.$modal_window.find(".failures_message").html(ew)};return ev})(du);r=INLINE_JS.show_delete_failures_modal=A.show_delete_failures_modal=function(ew,ev,T){var ex;ex=new dR({element_id:"delete-failures-modal"});ex.host_id=ew;ex.name=ev;ex.num_failures=T;ex.show();return false};X=INLINE_JS.UnlinkHostModal=A.UnlinkHostModal=(function(ev){cl(T,ev);function T(eA,ey,ew,ex,ez){this.host_ids=eA;this.name=ey;this.delete_support_type=ew;this.owner_id=ex;this.team_id=ez;this.on_show=cU(this.on_show,this);this._set_delete_text=cU(this._set_delete_text,this);this.fail_callback=cU(this.fail_callback,this);this.success_callback=cU(this.success_callback,this);this.on_confirm_button_click=cU(this.on_confirm_button_click,this);T.__super__.constructor.call(this,{element_id:"unlink-host-modal"});this.show_host_selector=$u(this.host_ids).values().length>1}T.prototype.on_confirm_button_click=function(ez){var ex,ey,ew;ez.preventDefault();ey=this.$modal_window.find(".unlink_host_form")[0];ex=$(this.$modal_window.find(".confirm-button")[0]);this.$modal_window.find("[type=button]").attr("disabled","");ew={host_ids:JSON.stringify(this.get_selected_hosts())};return bs.ajax_submit(ey,false,this.success_callback,this.fail_callback,ex,ew)};T.prototype.success_callback=function(){return window.location.reload()};T.prototype.fail_callback=function(){return this.$modal_window.find("[type=button]").removeAttr("disabled")};T.prototype._set_delete_text=function(ew){return this.$modal_window.find(".delete_data_label").text(ew)};T.prototype._get_unlink_select=function(){return this.$modal_window.find(".unlink-select select").val()};T.prototype._set_delete_checkbox=function(){return this.$modal_window.find(".delete_data").prop("checked",true)};T.prototype._clear_delete_checkbox=function(){return this.$modal_window.find(".delete_data").prop("checked",false)};T.prototype.on_show=function(ex){var ew;this._clear_delete_checkbox();if(this.delete_support_type===Constants.DELETE_ON_UNLINK_OLD_CLIENT){this.$modal_window.find(".unlink_host_modal_content").addClass("show_old_client_modal")}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_UNSUPPORTED){this.$modal_window.find(".unlink_host_modal_content .unlink_host_form").addClass("hidden")}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED_TEAM_ONLY){this._set_delete_checkbox();this.$modal_window.find(".unlink-choice").change((function(ey){return function(ez){if(ey._get_unlink_select()===Constants.ROLE_PERSONAL){ey._clear_delete_checkbox();return ey.$modal_window.find(".new_client").hide()}else{ey._set_delete_checkbox();return ey.$modal_window.find(".new_client").show()}}})(this));this._set_delete_text(dU("Delete files from %(team_name)s Dropbox the next time this computer comes online.").format({team_name:cj.get_viewer().team_name}))}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED_PERSONAL_ONLY){this._set_delete_checkbox();this.$modal_window.find(".unlink-choice").change((function(ey){return function(ez){if(ey._get_unlink_select()===Constants.ROLE_WORK){ey._clear_delete_checkbox();return ey.$modal_window.find(".new_client").hide()}else{ey._set_delete_checkbox();return ey.$modal_window.find(".new_client").show()}}})(this));this._set_delete_text(dU("Delete files from my personal Dropbox the next time this computer comes online."))}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED){this._set_delete_checkbox();this._set_delete_text(dU("Delete files from these Dropboxes the next time this computer comes online."));this.$modal_window.find(".unlink-choice").change((function(ey){return function(ez){if(ey._get_unlink_select()===Constants.ROLE_PERSONAL){return ey._set_delete_text(dU("Delete files from my personal Dropbox the next time this computer comes online."))}else{if(ey._get_unlink_select()===Constants.ROLE_WORK){return ey._set_delete_text(dU("Delete files from %(team_name)s Dropbox the next time this computer comes online.").format({team_name:cj.get_viewer().team_name}))}else{return ey._set_delete_text(dU("Delete files from these Dropboxes the next time this computer comes online."))}}}})(this))}}}}}if(this.show_host_selector){ew="<span class='host_name'></span>";this.$modal_window.find(".unlink-select").removeClass("hidden");this.$modal_window.find(".unlink-modal-text").html(dU("Which Dropboxes do you want to unlink from %(host_name)s? Any Dropbox you unlink will immediately stop syncing.").format({host_name:ew}))}this.$modal_window.find("[name=host_id]").attr("value",this.host_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);this.$modal_window.find("[name=user_id]").attr("value",this.owner_id);return this.$modal_window.find(".host_name").text(this.name)};T.prototype.get_selected_hosts=function(){var ew;if($u.values(this.host_ids).length===1){return $u.values(this.host_ids)}ew=bf(".unlink-choice").val();if(ew==="both"){return $u.values(this.host_ids)}else{return[this.host_ids[ew]]}};return T})(du);var d3;d3=A.News={DEFAULT_TAB:"recent-news",init:function(){$("news-home").on("click","#nav a",function(ev,ew){var T;if(ew.hasAttribute("data-div")){ev.preventDefault();T=ew.readAttribute("data-div");return dX.push_state("/news/"+T)}});return dX.add_callback("/news",d3.history_change)},change_tab:function(T){var ev;ev=$$("#nav a[data-div="+T+"]").first();if($(ev)){$$(".section").invoke("removeClassName","selected");$$("#nav a").invoke("removeClassName","selected");$(ev).addClassName("selected");return $(T).addClassName("selected")}},history_change:function(T){T=T||d3.DEFAULT_TAB;return d3.change_tab(T)}};var c5;c5=A.Recover={init:function(){var T;T=$("recover-form");return T.observe("submit",this.form_submit.bind(this))},form_submit:function(T){this.clear_error();T.preventDefault();return bs.ajax_submit($("recover-form"),null,this.submit_response.bind(this))},submit_response:function(ev){var T;T=JSON.parse(ev.responseText);if(T.status==="error"){this.show_error(T.msg)}if(T.status==="ok"){this.show_hosts(T)}if(T.status==="redirect"){return window.location.href=T.url}},show_hosts:function(eB){var ey,ew,ex,T,eA,ev,ez;bs.add_vars($("recover-form"),{check_file:"true"});$("filename-to-create").update(eB.filename);ew=$("trusted-hosts");ew.update();ez=eB.hosts;for(eA=0,ev=ez.length;eA<ev;eA++){ey=ez[eA];T=new Element("li");ex="lnx";if(ey.platform==="mac"){ex="osx"}if(ey.platform==="win"){ex="win"}T.__sert(b6.make("web",ex));T.__sert(new es(ey.display_name.escapeHTML()));ew.appendChild(T)}$("login-step").hide();return $("hosts-step").show()},show_error:function(T){$("error-messages").update(T);return $("error-messages").show()},clear_error:function(){return $("error-messages").update()}};var cM;cM=A.Restore={next:function(T,ex){var ew,ev;ev=bf("ul.selected");ew=ev.next("ul");ew.addClass("selected");ev.removeClass("selected");if(ew.next("ul").length){bf("#next-page").show()}else{bf("#next-page").hide()}bf("#prev-page").show();return cM.inc_page(1)},prev:function(T,ex){var ew,ev;ev=bf("ul.selected");ew=ev.prev("ul");ew.addClass("selected");ev.removeClass("selected");if(ew.prev("ul").length){bf("#prev-page").show()}else{bf("#prev-page").hide()}bf("#next-page").show();return cM.inc_page(-1)},inc_page:function(ew){var ev,T;ev=parseInt(bf("#page_num").text(),10);T=ev+ew;return bf("#page_num").text(T)},init:function(ex,T,ev){var ew;ew=cj.get_viewer().get_user_by_id(ev);bf("#next-page").on("click",function(ey){cM.next(ey);return false});bf("#prev-page").on("click",function(ey){cM.prev(ey);return false});bf("#restore-submit-button").on("click",function(ey){c0.do_folder_restore(ex,ew);return false});bf("#restore-cancel-button").on("click",function(ey){return location.href=T});return bf("#restore-back-button").on("click",function(ey){return location.href=T})}};var bP,cX,ce,aD,cU=function(T,ev){return function(){return T.apply(ev,arguments)}},am={}.hasOwnProperty,cl=function(ex,ev){for(var T in ev){if(am.call(ev,T)){ex[T]=ev[T]}}function ew(){this.constructor=ex}ew.prototype=ev.prototype;ex.prototype=new ew();ex.__super__=ev.prototype;return ex};bP=A.SelectRoleModal=(function(T){cl(ev,T);function ev(){this.on_show=cU(this.on_show,this);return ev.__super__.constructor.apply(this,arguments)}ev.prototype.on_select_role=null;ev.prototype.on_show=function(){return bf(".role-options li").click((function(ew){return function(ey){var ex,ez;ex=bf(ey.target).closest("li");ez=ex.data("role");ci(ew.on_select_role,"missing on_select_role implementation");ew.on_select_role(ez);return ew.hide()}})(this))};return ev})(du);ce=A.SharedFolderSelectRoleModal=(function(T){cl(ev,T);function ev(){return ev.__super__.constructor.apply(this,arguments)}ev.prototype.on_select_role=function(ex){var ew;ew=function(){bz.role_picker.ensure_role_is_visible(ex);c2.set_role(ex);return p.start_wizard_for_user(cj.get_viewer().get_user_by_role(ex))};if(ex===bo.logged_out_role){return bo.show_modal({role:ex,on_success:ew})}else{return ew()}};return ev})(bP);aD=A.ShmodelC2DSelectRoleModal=(function(T){cl(ev,T);function ev(){return ev.__super__.constructor.apply(this,arguments)}ev.prototype.on_select_role=function(ex){var ew;ew=function(){return ad.show_c2d_modal(ex)};if(!cj.get_viewer().is_role_signed_in(ex)){return bo.show_modal({role:ex,on_success:ew})}else{return ew()}};return ev})(bP);cX=A.ShareShmodelSelectRoleModal=(function(T){cl(ev,T);function ev(){this.on_select_role=cU(this.on_select_role,this);return ev.__super__.constructor.apply(this,arguments)}ev.prototype.on_select_role=function(ew){return ad.prompt_login_then_share(this.options.link_url,this.options.short_url,this.options.tokenizer_type,ew)};return ev})(bP);var cn;cn=A.TabController=Class.create({initialize:function(ew,ev){var T;T=$(ew);ci(T,ew+" is missing.");this.container=T;this.options={killEvent:true};Object.extend(this.options,ev);return this.listen()},listen:function(){var ez,ew,ey,ev,ex,T;ew=this;ex=this.container.select("a");T=[];for(ey=0,ev=ex.length;ey<ev;ey++){ez=ex[ey];ci(ez.id&&ez.id.length>0,"Element is missing an id");T.push(ez.observe("click",(function(eA){return this.click(eA)}).bindAsEventListener(ew)))}return T},click:function(T){if(this.options.killEvent){Event.stop(T)}return this.toggle($(T.target))},toggle:function(ev){var ey,T,ex,ez,ew;ew=this.container.down("a.selected");if(ew){ez=$(ew.id+"-content");if(ez){ez.hide()}}this.container.select(".selected").invoke("removeClassName","selected");T=false;if(!ev){ev=this.container.down("a");T=true}ev.addClassName("selected");ey=$(ev.id+"-content");if(ey){ey.show()}if(this.options.onTabChange){this.options.onTabChange(ev,ew)}if(this.options.url_prefix){ex=this.options.url_prefix;if(!T){ex+="/"+ev.id}return dX.push_state(ex)}}});var db;db=A.InviteForm={initialized:false,init:function(){if(this.initialized){return}return bf((function(T){return function(){T.add_auto_completer=new Autocompleter.ContactsTokenizer(cj.get_viewer().get_user_by_role(Constants.ROLE_WORK),"team-invite-new-collab-input","team-invite-new-whobulk","team-invite-hidden-input",{tokens:[",",";"],hide_import_contacts:true,suggestions_disabled:true,contact_filter:function(ev){return ev.excludeTeamMembers().excludeFacebook().excludeGroups().excludeNewStyleGroups().excludeRooms().excludeMe()}});T.add_auto_completer.clearTokens();T.tokenAdd=bf.proxy(T._tokenAdd,T);T.tokenRemove=bf.proxy(T._tokenRemove,T);bf("#team-invite-new-collab-input")[0].on("token:add",T.tokenAdd);bf("#team-invite-new-collab-input")[0].on("token:remove",T.tokenRemove);T.reset_licenses();T.initialized=true;T.setup_tab_support(bf);return bS.init()}})(this))},set_emails:function(T){if(T==null){return}return bf((function(ev){return function(){var ey,eA,ez,ex,ew;ev.init();ew=[];for(ez=0,ex=T.length;ez<ex;ez++){ey=T[ez];eA=ev.add_auto_completer.createTokenInfo(null,ey,P.EMAIL);ew.push(ev.add_auto_completer.addContact(eA))}return ew}})(this))},rebind_modal_submit_autocompleter:function(){var T,ev;T=this.invite_modal.$modal_window;ev=T.find(".tokenizer-submit-button");ev.on("mousedown",(function(ew){return function(){return ew.add_auto_completer.beforeSubmit()}})(this));return this.setup_tab_support(T)},setup_tab_support:function(T){return T.find("#team-invite-new-collab-input").first().on("keyup change",function(){var ev;ev=T.find(".new-collab-input").first();if(ev.val()!==""){return ev.attr("tabindex",-1)}else{return ev.removeAttr("tabindex")}})},reset_modal_licenses:function(){var T;T=__CIRCULAR_DEPENDENCY__.Dashboard!=null?__CIRCULAR_DEPENDENCY__.Dashboard.get_total_members():__CIRCULAR_DEPENDENCY__.MembersReact!=null?__CIRCULAR_DEPENDENCY__.MembersReact.get_total_members():window.active_team_member_table.get_user_count();this.update_used_licenses(T);this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},reset_licenses:function(){this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},get_new_users:function(){return this.new_users},_tokenAdd:function(T){this.available_licenses--;bf(window).trigger("token:changed",{remaining_licenses:this.available_licenses});return this.new_users++},_tokenRemove:function(T){this.available_licenses++;bf(window).trigger("token:changed",{remaining_licenses:this.available_licenses});return this.new_users--},already_invited_user:function(ev){var ew,T,ex;if(window.active_team_member_table){ex=window.active_team_member_table.data.users;for(T in ex){ew=ex[T];if(ew.email===ev){return true}}}},update_license_count:function(){var T,ev;T=bf("#license-count-message");if(this.available_licenses<0){ev=dU("You need more licenses for this invitation.");T.addClass("over")}else{if(this.available_licenses===0){ev=dU("You have no remaining licenses.");T.removeClass("over")}else{ev=aR("You have %(invites)d remaining license.","You have %(invites)d remaining licenses.",this.available_licenses).format({invites:this.available_licenses});T.removeClass("over")}}return T.text(ev)},init_modal_licenses:function(ew,ev,T){if(!this.invite_modal){this.invite_modal=new t(T)}this.total_licenses=ew;this.is_trial=ev;return bf("body").trigger("invite-modal-initialized")},update_used_licenses:function(T){this.used_licenses=T;return this.reset_licenses()},init_form_licenses:function(ew,T,ev){this.total_licenses=ew;this.used_licenses=T;this.is_trial=ev;return db.reset_licenses()},add_total_licenses:function(T){T=T||0;if(T>0){this.total_licenses+=T;this.available_licenses+=T;this.update_license_count();if(__CIRCULAR_DEPENDENCY__.Dashboard!=null){return __CIRCULAR_DEPENDENCY__.Dashboard.add_licenses(T)}}},on_add_licenses_exit:function(ev,T){var ew;if((ew=this.invite_modal)!=null?ew.$modal_window:void 0){this.rebind_modal_submit_autocompleter()}return this.add_total_licenses(T)},reset_modal:function(){var T;T=this.invite_modal.$modal_window;cz.reset(T.find("#team-invite-message")[0]);if(this.add_auto_completer){this.add_auto_completer.clearTokens()}this.reset_modal_licenses();return T.find(".new-collab-input").val("")},on_add_licenses_click:function(ev){var T;ev.preventDefault();if(this.is_trial){if((T=this.invite_modal)!=null){T.hide()}return __CIRCULAR_DEPENDENCY__.add_more_licenses_to_trial()}else{if(this.add_licenses_cb!=null){dm.unregister(__CIRCULAR_DEPENDENCY__.AddLicensesModal.LICENSES_ADDED,this.add_licenses_cb)}this.add_licenses_cb=bf.proxy(this.on_add_licenses_exit,this);dm.register(__CIRCULAR_DEPENDENCY__.AddLicensesModal.LICENSES_ADDED,this.add_licenses_cb);return dm.push(new __CIRCULAR_DEPENDENCY__.AddLicensesModal())}}};var t,cU=function(T,ev){return function(){return T.apply(ev,arguments)}},am={}.hasOwnProperty,cl=function(ex,ev){for(var T in ev){if(am.call(ev,T)){ex[T]=ev[T]}}function ew(){this.constructor=ex}ew.prototype=ev.prototype;ex.prototype=new ew();ex.__super__=ev.prototype;return ex};t=A.InviteModal=(function(ev){cl(T,ev);function T(ew){this.transition_view_model=ew;this._reset=cU(this._reset,this);this._update_form_pricing_information=cU(this._update_form_pricing_information,this);this._update_remaining_licenses_message=cU(this._update_remaining_licenses_message,this);this._make_transition_info_request=cU(this._make_transition_info_request,this);this._handle_token_change=cU(this._handle_token_change,this);this._licenses_total=cU(this._licenses_total,this);this._licenses_to_add=cU(this._licenses_to_add,this);this.on_hide=cU(this.on_hide,this);this.on_show=cU(this.on_show,this);T.__super__.constructor.call(this,{element_id:"team-invite-wizard",focus:".new-collab-input"});this.inline_add_license=this.transition_view_model!=null;if(this.inline_add_license){this.transition_info_fetcher=new er([ew]);this.probability=Math.random()}this.skip_reset=false}T.prototype.on_confirm_button_click=function(ew){return df.add_users(ew,this.add_qty)};T.prototype.on_show=function(){var ew;this._reset();ew=bf("#team-invite-wizard .team-invite-add-licenses");ew.on("click",bf.proxy(db.on_add_licenses_click,db));bf(window).on("token:changed",this._handle_token_change);if(db.initialized){db.update_license_count()}return dm.register(dm.CLEAR,function(){return db.reset_modal()})};T.prototype.on_hide=function(){return bf(window).off("token:changed",this._handle_token_change)};T.prototype._licenses_to_add=function(){return -1*db.available_licenses};T.prototype._licenses_total=function(){return db.total_licenses+this._licenses_to_add()};T.prototype._handle_token_change=function(ex,ew){this._update_remaining_licenses_message(ew.remaining_licenses);if(this.inline_add_license){clearTimeout(this.fetch_transition_timeout_id);return this.fetch_transition_timeout_id=setTimeout((function(ey){return function(){ey._make_transition_info_request();return ey.fetch_transition_timeout_id=null}})(this),100)}};T.prototype._make_transition_info_request=function(){var ey,ex,ew,ez;ex=Math.floor(Math.random()*1000000);this.current_callback_token=ex;ey=this._licenses_to_add();ew=this._licenses_total();ez=(function(eA){return function(eB){return eA._update_form_pricing_information(ex,ey,ew,eB[0])}})(this);if(ey>0){return this.transition_info_fetcher.get(ez,{total_users:this._licenses_total()})}else{return ez(null)}};T.prototype._update_remaining_licenses_message=function(ew){var ex;this.remaining_licenses=ew;ex=this._get_remaining_licenses_message(ew);return this.$modal_window.find("#license-count-message").text(ex)};T.prototype._get_remaining_licenses_message=function(ew){var ex;if(ew<0){ex=dU("You need more licenses for this invitation.")}else{if(ew===0){ex=dU("After this invitation, you'll have no remaining licenses.")}else{ex=aR("After this invitation, you'll have %(count)d remaining license.","After this invitation, you'll have %(count)d remaining licenses.",ew).format({count:ew})}}return ex};T.prototype._update_form_pricing_information=function(ez,eA,ew,eD){var ex,eC,eB,ey;if(ez!==this.current_callback_token){return}if(eD&&eA>0){this.add_qty=eA;ex=this.transition_view_model.state.currency;eB=eD.current_total.amount;eC=eq.formatCurrency(eB,ex);ey=eq.formatCurrency(eD.recurring_total.amount,ex);bf(".new-amount").text(eC);bf(".add-qty").text(eA);bf(".recurring-amount").text(ey);bf(".total-qty").text(ew);bf(".charges-section").show();bf(".team-invite-buttons .confirm-button").val(dU("Invite and buy"));return bf("#expected_price").val(eB)}else{return this._reset()}};T.prototype._reset=function(){this.add_qty=0;bf(".charges-section").hide();bf("#expected_price").val(0);return bf(".team-invite-buttons .confirm-button").val(dU("Invite to team"))};return T})(du);var bi,al,ao,N,dA,ef,d1,df,eo,b1,n,cU=function(T,ev){return function(){return T.apply(ev,arguments)}},am={}.hasOwnProperty,cl=function(ex,ev){for(var T in ev){if(am.call(ev,T)){ex[T]=ev[T]}}function ew(){this.constructor=ex}ew.prototype=ev.prototype;ex.prototype=new ew();ex.__super__=ev.prototype;return ex};df=INLINE_JS.Team=A.Team={_use_async_reset:false,team_id:cj.get_viewer().team_id,set_team_id:function(T){this.team_id=T},setup_beta_modal_listeners:function(){var ez,eC,eA,T,ey,ex,eB,ev,ew;eC=bf(".feature-list .enroll-button");T=bf(".feature-list .feedback-button");for(ey=0,eB=eC.length;ey<eB;ey++){ez=eC[ey];eA=bf(ez).data("feature");bf(ez).click((function(eD){return function(){return new al(eD).show()}})(eA));ez.disabled=false}ew=[];for(ex=0,ev=T.length;ex<ev;ex++){ez=T[ex];eA=bf(ez).data("feature");ew.push(bf(ez).click((function(eD){return function(){return new ao(eD).show()}})(eA)))}return ew},invite_modal_show:function(T){if(!db.invite_modal){return bf("body").one("invite-modal-initialized",(function(ev){return function(){return ev.invite_modal_show(T)}})(this))}if(!this.invite_modal_already_initialized){db.invite_modal.show();db.init();this.invite_modal_already_initialized=true}else{db.invite_modal.show();db.rebind_modal_submit_autocompleter()}if(window.active_team_member_table!=null){db.update_used_licenses(window.active_team_member_table.get_user_count())}return db.set_emails(T)},init_admin:function(){a2.set_vertical_space(2);return bf("form.activity-report-generator").submit(this.submit_report_form.bind(this))},init_team_name_change_notice:function(){return bf(".team_name_change_notice .hide_link").click((function(T){return function(ev){return T.hide_team_name_change_banner()}})(this))},add_users:function(ew,T){var ey,ev,ex;Event.stop(ew);ev=$("team-invite-form");ci(ev,"Couldn't find the team invite form.");ey=bf(ev).find("input[name='emails']");if(ey.length===0){Y.error(dU("You haven't included anyone to invite! Please invite at least one person."));return}ex=bs.collect_form_vars(ev);bf.extend(ex,{team_id:this.team_id});bs.add_loading(ew.target);return new Ajax.DBRequest("/account/team/add_users",{parameters:ex,subject_user:cj.get_viewer().work_user,progress_text:dU("Inviting members..."),noAutonotify:true,onSuccess:function(eE){var eC,eB,eA,eD,ez;bs.remove_loading();db.reset_modal();db.add_total_licenses(T);db.invite_modal.hide();eD=bf(".team_admin_members_table");eA=JSON.parse(eE.responseText);if(eA){if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.add_users(eA!=null?eA.users:void 0)}else{if(__CIRCULAR_DEPENDENCY__.Dashboard!=null){__CIRCULAR_DEPENDENCY__.Dashboard.set_num_invited(eA!=null?eA.num_invited:void 0)}}}eC=(function(){var eG,eF;eG=eA!=null?eA.users:void 0;eF=[];for(eB in eG){ez=eG[eB];eF.push(ez)}return eF})();if(eC.length===1){return Y.success(dU("Invited %(user_email)s.").format({user_email:eC[0].email}))}else{if(eC.length>1){return Y.success(dU("Invited %(user_count)d people.").format({user_count:eC.length}))}else{return Y.error(aR("Skipped %(num_skipped)d person who is already a member of the team.","Skipped %(num_skipped)d people who are already members of the team.",ey.length).format({num_skipped:ey.length}))}}}else{return Y.error()}},onFailure:function(eB){var ez,eA;if(eB){if(eB.responseText.indexOf("err:")===0){ez=eB.responseText.substr(4);if(ez.indexOf("{")===0){eA=ez.evalJSON(true);bs.fill_errors(ev,eA)}else{ez=new es(ez);Y.error(ez)}}else{Y.error()}}bs.remove_loading();return bf("input[type='submit']").prop("disabled",false)},cleanUp:function(){bs.remove_loading();db.reset_modal();return db.invite_modal.hide()}})},show_demo_signup_modal:function(ew,ex,ey,ev,ez){var T,eC,eB,eA;this.webinar_key=ew;this.webinar_iso_datetime=ex;this.webinar_date=ey;this.webinar_title=ev;this.tab_url=ez;eA=dU("Register for a webinar on %(start_time)s").format({start_time:this.webinar_date});eC=new N({element_id:"demo-signup-modal",title:eA});eC.show();eC.$modal_window.find("input[name=webinar_key]").attr("value",this.webinar_key);eC.$modal_window.find("input[name=webinar_title]").attr("value",this.webinar_title);eC.$modal_window.find("input[name=Sales_Webinar_Topic__c]").attr("value",this.webinar_title);eC.$modal_window.find("input[name=Sales_webinar_date__c]").attr("value",this.webinar_iso_datetime);eB=eC.$modal_window.find("input[name=retURL]");eB.attr("value",eB.val()+"#"+this.tab_url);T=eC.$modal_window.find("#demo-signup-form")[0];return T.on("submit",eC.on_confirm_button_click)},show_remove_or_deactivate_modal:function(ew,ey,T,ev,ez){var ex;ex=new dA({element_id:"dfe-remove-or-deactivate-user-modal",focus:".new-collab-input"});ex.user_name=ey||ev;ex.email=ev;ex.user_id=T;ex.team_id=this.team_id;ex.invited=ez;ex.show();return false},show_remove_modal:function(ew,ey,T,ev,ez){var ex;ex=new ef({element_id:"dfe-remove-user-modal",focus:".new-collab-input"});ex.user_name=ey||ev;ex.email=ev;ex.user_id=T;ex.team_id=this.team_id;ex.invited=ez;ex.show();return false},remove_user:function(ex,ey){var ew,ev,T;alert("in remove_user");Event.stop(ex);ev=bf("input[type=submit]","#remove-user-modal");ev.attr("disabled",1);T=ep.vars.user_id;if(ey){ew=true}else{ew=bf("input[name=disable_if_joined]:checked","#remove-user-modal").val()}return new Ajax.DBRequest("/account/team/remove_user",{parameters:{team_id:this.team_id,user_id:T,disable_if_joined:ew},onSuccess:(function(ez){return function(eC){var eB,eD,eA;eB=JSON.parse(eC.responseText);if((eD=window.active_team_member_table)!=null){eD.remove_user(ep.vars.user_id)}if((eA=window.removed_team_member_table)!=null){eA.add_users(eB)}ez.decrement_used_licenses();return Y.success(dU("User removed."))}})(this),cleanUp:function(){ep.hide();return ev.removeAttr("disabled")}})},show_reinvite_modal:function(ew,ex,T,ev){var ey;cS.fillVal(ev,"reinvite-user-email");cS.fillVal(ex,"reinvite-user-team");ey=dU("Resend invite to '%(email_address)s'").format({email_address:bt.em_snippet(ev,18)});return ep.show(ey,$("reinvite-user-modal"),{user_id:T,button:ew})},reinvite_user:function(ev){var T;Event.stop(ev);T=ep.vars.user_id;return new Ajax.DBRequest("/account/team/reinvite_user",{parameters:{team_id:this.team_id,user_id:T},onSuccess:function(ez){var ex,ey,ew,eA;Y.success(dU("Invite sent."));if((eA=$("team-member-info"))!=null){eA.update(ez.responseText)}ex=window.active_team_member_table;if(ex){ew=ex.data.users[T];ew.invite_expired=false;ey={};ey[T]=ew;return ex.update_user_data(ey)}},cleanUp:function(){return ep.hide()}})},show_user_activity_log_modal:function(T,ew,ex){var ev;ev=bf("#activity-log-modal");ev.find(".activity-log-email").text(ew);ev.find(".activity-log-name").text(ex);ev.find("#activity-log-user-message").show();return ep.show(dU("Create activity report"),ev[0],{user_id:T})},show_team_activity_log_modal:function(ev,ew){var T;T=bf("#activity-log-modal");T.find(".activity-log-email").text(ev);T.find(".activity-log-name").text(ew);T.find("#activity-log-team-message").show();return ep.show(dU("Create full activity report"),T[0])},generate_activity_log:function(eB){var ez,ex,eA,ey,T,ew,ev;Event.stop(eB);ex=bf("#activity-log-modal");eA=ex.find("input[name='from_date']").val();T=ex.find("input[name='to_date']").val();if(eA>T){Y.error(dU("Your start date is after your end date."));return}ey=this.team_id;ev=ep.vars.user_id;ew=new Date().getTimezoneOffset().toString();ez=bf(".activity-report-generator .freshbutton-blue");ez.prop("disabled",true);return new Ajax.DBRequest("/team/events_report/csv",{parameters:{from_date:eA,to_date:T,team_id:ey,user_id:ev,tzoffset:ew},onSuccess:function(eC){return Y.success(dU("Report started. We'll email you when it's ready."))},cleanUp:function(){ep.hide();return ez.prop("disabled",false)}})},show_reset_password_modal:function(ev,ew,T){var ex;bf("#reset-password-modal .member-name").text(ew);ex=dU("Reset password for '%(user_name)s'").format({user_name:ew});return ep.show(ex,$("reset-password-modal"),{user_id:T,button:ev})},reset_password:function(ev){var T;Event.stop(ev);T=ep.vars.user_id;return new Ajax.DBRequest("/account/team/reset_password",{parameters:{team_id:this.team_id,user_id:T},onSuccess:function(ew){return Y.success(dU("User's password reset."))},cleanUp:function(){return ep.hide()}})},show_reset_all_passwords_modal:function(){return ep.show(dU("Reset all passwords"),$("reset-all-passwords-modal"))},set_async_password_reset:function(T){return this._use_async_reset=T},reset_all_passwords:function(){return new Ajax.DBRequest("/account/team/reset_all_passwords",{parameters:{team_id:this.team_id},job:this._use_async_reset,subject_user:cj.get_viewer().work_user,progress_text:dU("Resetting all passwords..."),onSuccess:function(T){return Y.success(dU("All passwords reset."))},cleanUp:function(){return ep.hide()}})},show_admin_status_modal:function(ew,eC,eE,ey,eD,ez){var ev,eA,T,ex,eB;T=eD.strip()||ey;ex=void 0;ev=void 0;eB=void 0;eA=void 0;if(ez){eB=dU("Add admin permissions for '%(person_name)s'").format({person_name:T.escapeHTML()});ex=dU("Are you sure you want to add admin permissions for <strong>%(person_name)s</strong>?").format({person_name:T.escapeHTML()});ev=dU("Add admin permissions",{comment:"make this user an admin; give them the permissions an admin has"});eA="alert_32"}else{eB=dU("Remove admin privileges from '%(person_name)s'").format({person_name:T.escapeHTML()});ex=dU("Are you sure you want to remove admin permissions from <strong>%(person_name)s</strong>?").format({person_name:T.escapeHTML()});ev=dU("Remove admin permissions",{comment:"clicking this button completes the action: it removes a person's admin status"});eA="alert_32"}cS.fillVal(ey,"admin-status-email");cS.fillVal(ex,"admin-status-action");cS.fillVal(ev,"admin-status-button-action");return ep.show(eB,$("admin-status-modal"),{user_id:eE,button:ew,admin_on:ez})},set_admin_status:function(ev){var T;Event.stop(ev);T=ep.vars.user_id;return new Ajax.DBRequest("/account/team/set_admin_status",{parameters:{team_id:this.team_id,user_id:T,on:(ep.vars.admin_on?"yes":"no")},onSuccess:function(ex){var ey,ew;ey=(ep.vars.admin_on?dU("User's admin status granted."):dU("User's admin status removed."));if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){return __CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){ew=JSON.parse(ex.responseText);window.active_team_member_table.update_user_data(ew);return Y.success(ey)}else{if(ep.vars.admin_on){return window.location="/team/admin/member?id=%d&msg=granted".format(ep.vars.user_id)}else{return window.location="/team/admin/member?id=%d&msg=removed".format(ep.vars.user_id)}}}},cleanUp:function(){return ep.hide()}})},show_disable_2fa_modal:function(ew,T,ev){bf("#disable-2fa-modal .member-name").text(ev);return ep.show(dU("Disable two-step verification"),$("disable-2fa-modal"),{user_id:T,elm:ew})},disable_2fa:function(){return new Ajax.DBRequest("/account/team/disable_2fa",{parameters:{team_id:this.team_id,user_id:ep.vars.user_id},onSuccess:function(ev){var T;bf(".tfa_enabled").replaceWith(dU("Disabled"));T=JSON.parse(ev.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.update_user_data(T)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",T)}}}Y.success(dU("Two-step verification disabled."));return ep.hide()}})},show_sso_preview_email:function(T){return ep.show(dU("Email preview"),$(T))},show_sso_sample_email:function(T){return ep.show(dU("Sample email"),$(T))},show_user_message_modal:function(ew,ev,T){var ex;cS.fillVal(T,"user-message-email");ex=dU("Send email to '%(user_name)s'").format({user_name:ew});$("user-message").value="";ep.show(ex,$("user-message-modal"),{user_name:ew,user_id:ev});return ds.focus.defer("user-message")},send_user_message:function(){var ev,T;T=ep.vars.user_id;ev=$F("user-message").strip();return new Ajax.DBRequest("/account/team/send_user_message",{parameters:{user_id:T,team_id:this.team_id,message:ev},onSuccess:function(){var ew;ew=ep.vars.user_name;Y.success(dU("Message successfully sent to %(user_name)s.").format({user_name:ew}));return ep.hide()}})},hide_team_name_change_banner:function(){new Ajax.DBRequest("/account/team/name_change_notice_received",{parameters:{team_id:this.team_id}});bf(".team_name_change_notice").hide();return false},hide_pin_banner:function(){new Ajax.DBRequest("/team/invalidate_pin");return bf(".pin_notice").hide()},hide_pin_banner_with_user_id:function(T,ev){var ew;ew=function(ex){return bf(ev).closest("span").removeClass("on").addClass("off")};if(T===null){return new Ajax.DBRequest("/team/invalidate_pin",{onSuccess:ew})}else{return new Ajax.DBRequest("/team/invalidate_pin",{parameters:{user_id:T},onSuccess:ew})}},get_pin_with_user_id:function(T,ew,ev){var ex;if(ev==null){ev=null}if(ev===null){ev=function(ez,ey){bf(ey).closest("span").find(".pin-value").text(ez.pin+" -");return bf(ey).closest("span").removeClass("off").addClass("on")}}ex=function(ez){var ey;ey=JSON.parse(ez.responseText);return ev(ey,ew)};if(T===null){return new Ajax.DBRequest("/team/generate_pin",{onSuccess:ex})}else{return new Ajax.DBRequest("/team/generate_pin",{parameters:{user_id:T},onSuccess:ex})}},send_team_message:function(ev){var T;Event.stop(ev);T=$F("team-message").strip();if(T){return new Ajax.DBRequest("/account/team/send_team_message",{parameters:{team_id:this.team_id,message:T},onSuccess:function(ew){Y.success(dU("Message successfully sent to team."));return ep.hide()}})}},show_security_message_modal:function(){return new eo().show()},send_team_security_message:function(ew){var ev,T;Event.stop(ew);T=$F("team-security-message").strip();ev=$("team-security-message-form");return new Ajax.DBRequest("/account/team/send_team_message",{parameters:ev.serialize(true),onSuccess:function(ex){Y.success(dU("Message successfully sent."));return ep.hide()}})},used_licenses:0,total_licenses:0,set_used_licenses:function(T,ev){this.used_licenses=T;return this.total_licenses=ev},decrement_used_licenses:function(){return this.set_used_licenses(this.used_licenses-1,this.total_licenses)},show_migration_link:function(T,ev){$("migration-url").value=ev;ep.show(dU("Migration link for '%(email)s'").format({email:bt.em_snippet(T,18)}),$("migrate-url-modal"));return $("migration-url").select()},show_end_session_modal:function(ev,T,ew){a2.hide_all();bf("#end-session-modal .member-name").text(bf("#member-name").text());return ep.show(dU("Close web session",{comment:"Log out of your current Dropbox web session"}),$("end-session-modal"),{login_id:ev,user_id:T,elm:ew})},end_session:function(){return new Ajax.DBRequest("/logout_remote_session",{parameters:{remote_login_id:ep.vars.login_id,team_id:this.team_id,user_id:ep.vars.user_id},onSuccess:function(){ep.hide();df.remove_closest_row(ep.vars.elm);return Y.success(dU("Web session closed."))}})},unlink_device:function(T,ex,eB,ev,eC,ew,ey){var eA,ez;a2.hide_all();eA=$("unlink-device-modal-"+ew);ez=dU("Unlink %(device_name)s").format({device_name:eB});return ep.show(ez,eA,{app_id:ex,user_id:eC,elm:ey,device_id:T,display_name:eB})},unlink_device_submit:function(){return new Ajax.DBRequest("/account/unlink_team_device",{parameters:{app_id:ep.vars.app_id,team_id:this.team_id,user_id:ep.vars.user_id,device_id:JSON.stringify(ep.vars.device_id)},subject_user:cj.get_viewer().work_user,onSuccess:function(){ep.hide();df.remove_closest_row(ep.vars.elm);return Y.success(dU("%(device_name)s unlinked.").format({device_name:ep.vars.display_name}))}})},disable_app:function(ev,ew,T,ex){a2.hide_all();bf("#disable-app-modal .app-name").text(ew);bf("#disable-app-modal .member-name").text(bf("#member-name").text());return ep.show(dU("Disable '%(app_name)s'?").format({app_name:ew}),$("disable-app-modal"),{app_id:ev,user_id:T,elm:ex})},disable_app_submit:function(){return new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:ep.vars.app_id,keep_sandbox_files:true,team_id:this.team_id,user_id:ep.vars.user_id},subject_user:cj.get_viewer().work_user,onSuccess:function(T){ep.hide();df.remove_closest_row(ep.vars.elm);return Y.success(T.responseText)}})},remove_closest_row:function(ex){var ew,ev,T;ew=bf(ex).closest(".team_admin_table_row");ev=bf(ew).closest(".team_admin_table");if(ev.find(".team_admin_table_row").length===1){T=ev.prev(".team_admin_table_title");if(!T.length){T=bf(".team_apps_table_panel")}T.remove();return ev.remove()}else{return ew.remove()}},submit_report_form:function(T){bf(T.target.elements.tzoffset).val(""+new Date().getTimezoneOffset());return true}};al=A.BetaEnrollConfirmationModal=(function(ev){cl(T,ev);function T(ew){this.feature_name=ew;this.on_confirm_button_click=cU(this.on_confirm_button_click,this);T.__super__.constructor.call(this,{element_id:"beta-enroll-confirmation-modal"})}T.prototype.on_confirm_button_click=function(ew){bf("<input>").attr({type:"hidden",name:"feature_name",value:this.feature_name}).appendTo("#beta-enroll-confirmation-modal form");return this.$modal_window.addClass("ajax-loading")};return T})(du);ao=A.BetaFeedbackModal=(function(ev){cl(T,ev);function T(ew){this.feature_name=ew;this.error=cU(this.error,this);this.success=cU(this.success,this);T.__super__.constructor.call(this,{element_id:"beta-feedback-modal"});this.on_confirm_button_click=(function(ex){return function(eB){var eA,ez,ey;eB.preventDefault();eA=bf(eB.target);ez=eA.closest("form");ey={feature_name:ex.feature_name};return bs.ajax_submit(ez[0],false,ex.success,ex.error,eA[0],ey)}})(this)}T.prototype.success=function(ew){Y.success(dU("Thank you for your feedback."));return this.$modal_window.hide()};T.prototype.error=function(ew){if(ew.status!==200){return Y.error(dU("Failed to submit feedback. Please try again."))}};return T})(du);N=A.DemoSignupModal=(function(T){cl(ev,T);function ev(){this.on_show=cU(this.on_show,this);this.on_confirm_button_click=cU(this.on_confirm_button_click,this);return ev.__super__.constructor.apply(this,arguments)}ev.prototype.on_confirm_button_click=function(eA){var eI,eF,eB,ew,eD,ey,eH,eG,ex,eE,eC,ez;eA.preventDefault();eC=$("demo-signup-form");eG=$("1210");ey=bf(eC).find("input[name='first_name']").val();bf(eG).find("input[name='FirstName']").attr("value",ey);eH=bf(eC).find("input[name='last_name']").val();bf(eG).find("input[name='LastName']").attr("value",eH);eD=bf(eC).find("input[name='email']").val();bf(eG).find("input[name='Email']").attr("value",eD);eE=bf(eC).find("input[name='phone_number']").val();bf(eG).find("input[name='Phone']").attr("value",eE);eI=bf(eC).find("input[name='company_name']").val();bf(eG).find("input[name='Company']").attr("value",eI);eB=bf(eC).find("select[name='company_size']");eF=eB.find("option:selected").val();bf(eG).find("input[name='Company_size__c']").attr("value",eF);ew=$(this.$modal_window.find(".confirm-button")[0]);ez=(function(eJ){return function(eK){eJ.$modal_window.hide();return eG.submit()}})(this);ex=bs.collect_form_vars(eC,true);return bs.ajax_submit(eC,false,ez,false,ew,ex,true)};ev.prototype.on_show=function(ew){this.$modal_window.find(".db-modal-content").css({"overflow-y":""});return bS.init()};return ev})(du);bi=A.AccountTransferBaseModal=(function(ev){cl(T,ev);function T(ew,ey,ex){this.file_action_selector=ey;this.transfer_choice_selector=ex;this._clearInput=cU(this._clearInput,this);this._markInputInvalid=cU(this._markInputInvalid,this);this._markInputValid=cU(this._markInputValid,this);this._tokenRemove=cU(this._tokenRemove,this);this._tokenAdd=cU(this._tokenAdd,this);this._selectChange=cU(this._selectChange,this);this._isTransferSelected=cU(this._isTransferSelected,this);this.handleAjaxFailure=cU(this.handleAjaxFailure,this);T.__super__.constructor.call(this,ew,this.file_action_selector,this.transfer_choice_selector)}T.prototype.on_show=function(){if(this.$modal_window.find("#manage-files-new-collab-input").length===0){return}this.auto_completer=new Autocompleter.TeamTokenizer(cj.get_viewer().get_user_by_role(Constants.ROLE_WORK),"manage-files-new-collab-input","manage-files-new-whobulk","manage-files-hidden-input",{hide_import_contacts:true,suggestions_disabled:true,wrap_name:true,single_token:true,contact_filter:(function(ew){return function(ex){return ex.excludeNonTeam().excludeGroups().excludeNewStyleGroups().excludeRooms().excludeByEmail(ew.email?[ew.email.toLowerCase()]:[])}})(this)});this.tokenAdd=bf.proxy(this._tokenAdd,this);this.tokenRemove=bf.proxy(this._tokenRemove,this);this.$collab_input=this.$modal_window.find("#manage-files-new-collab-input")[0];this.$collab_input.on("token:add",this.tokenAdd);this.$collab_input.on("token:remove",this.tokenRemove);this.$textinput=this.$modal_window.find(".tokenized_autocompleter_container .textinput");this.selectChange=bf.proxy(this._selectChange,this);return this.$modal_window.find(this.file_action_selector).on("change",this.selectChange)};T.prototype.handleAjaxFailure=function(ew){if(ew.status===200&&this._isTransferSelected()){return this._markInputInvalid()}};T.prototype._isTransferSelected=function(){return bf(this.transfer_choice_selector).prop("checked")};T.prototype._selectChange=function(ew){if(this._isTransferSelected()){return this.$textinput.removeClass("unselected")}else{return this.$textinput.addClass("unselected")}};T.prototype._tokenAdd=function(ew){this.$collab_input.hide();if(ew.memo.valid){return this._markInputValid()}else{return this._markInputInvalid()}};T.prototype._tokenRemove=function(ew){this.$collab_input.show();return this._clearInput()};T.prototype._markInputValid=function(){this._clearInput();return this.$textinput.addClass("valid")};T.prototype._markInputInvalid=function(){this._clearInput();return this.$textinput.addClass("invalid")};T.prototype._clearInput=function(){this.$textinput.removeClass("valid");return this.$textinput.removeClass("invalid")};return T})(du);eo=A.TwoFactorMessageModal=(function(ev){cl(T,ev);function T(){T.__super__.constructor.call(this,{element_id:"team-security-message-modal",focus:"#team-security-message"})}T.prototype.on_confirm_button_click=function(ew){df.send_team_security_message(ew);return this.hide()};return T})(du);dA=A.DfeRemoveOrDeactivateUserModal=(function(ev){cl(T,ev);function T(ew){this.on_confirm_button_click=cU(this.on_confirm_button_click,this);this.success_callback=cU(this.success_callback,this);this.on_show=cU(this.on_show,this);this.handle_change_action=cU(this.handle_change_action,this);this.switch_to_uninvite_mode=cU(this.switch_to_uninvite_mode,this);this.switch_to_removal_mode=cU(this.switch_to_removal_mode,this);this.switch_to_deactivation_mode=cU(this.switch_to_deactivation_mode,this);this.show_removal_content=cU(this.show_removal_content,this);this.show_deactivation_content=cU(this.show_deactivation_content,this);this.set_modal_class=cU(this.set_modal_class,this);this.set_form_action_to_remove=cU(this.set_form_action_to_remove,this);this.set_form_action_to_deactivate=cU(this.set_form_action_to_deactivate,this);T.__super__.constructor.call(this,ew,"input[name=transfer_files]","#transfer_files_on")}T.prototype.set_form_action_to_deactivate=function(){return bf(".dfe-remove-or-deactivate-user-modal").attr("action","/account/team/deactivate_user")};T.prototype.set_form_action_to_remove=function(){return bf(".dfe-remove-or-deactivate-user-modal").attr("action","/account/team/remove_user")};T.prototype.set_modal_class=function(ey){var ex,ew;ex="invited suspending deleting";ew=this.$modal_window.find(".dfe-remove-or-deactivate-user-modal");ew.removeClass(ex);return ew.addClass(ey)};T.prototype.show_deactivation_content=function(){return this.set_modal_class("suspending")};T.prototype.show_removal_content=function(){return this.set_modal_class("deleting")};T.prototype.switch_to_deactivation_mode=function(){this.show_deactivation_content();return this.set_form_action_to_deactivate()};T.prototype.switch_to_removal_mode=function(){this.show_removal_content();return this.set_form_action_to_remove()};T.prototype.switch_to_uninvite_mode=function(){this.set_form_action_to_remove();this.set_modal_class("invited");this.$modal_window.find(".transfer_data_on_remove_setting").remove();return this.$modal_window.find(".remote_wipe_setting").remove()};T.prototype.handle_change_action=function(ew){ew.preventDefault();if(bf("#deactivate_option").is(":checked")){return this.switch_to_deactivation_mode()}else{return this.switch_to_removal_mode()}};T.prototype.on_show=function(ew){var ex;T.__super__.on_show.call(this);bf("input[name=deactivate_or_remove").on("change",this.handle_change_action);this.$modal_window.find(".deleted_user_name").text(this.user_name);if(this.invited){ex=dU("Uninvite %(user_name)s").format({user_name:this.user_name});this.switch_to_uninvite_mode()}else{ex=dU("Delete %(user_name)s").format({user_name:this.user_name});bf("#deactivate_option").attr("checked","checked");this.show_deactivation_content()}this.$modal_window.find(".db-modal-title-text").text(ex);this.$modal_window.find("[name=user_id]").attr("value",this.user_id);return this.$modal_window.find("[name=team_id]").attr("value",this.team_id)};T.prototype.success_callback=function(ew){if(this.invited){Y.success(dU("User uninvited"))}else{if(bf("#deactivate_option").is(":checked")){Y.success(dU("User suspended"))}else{Y.success(dU("User deleted"))}}return this.hide()};T.prototype.on_confirm_button_click=function(ey){var ew,ex;ey.preventDefault();ex=this.$modal_window.find(".dfe-remove-or-deactivate-user-modal")[0];ew=$(this.$modal_window.find(".confirm-button")[0]);return bs.ajax_submit(ex,false,this.success_callback,this.handleAjaxFailure,ew)};return T})(bi);ef=A.DfeRemoveUserModal=(function(T){cl(ev,T);function ev(ew){this.on_confirm_button_click=cU(this.on_confirm_button_click,this);this.success_callback=cU(this.success_callback,this);this.on_show=cU(this.on_show,this);ev.__super__.constructor.call(this,ew,"input[name=transfer_files]","#transfer_files_on")}ev.prototype.on_show=function(ew){var ex;ev.__super__.on_show.call(this);this.$modal_window.find(".remove_user_name").text(this.user_name);if(this.invited){ex=dU("Uninvite %(user_name)s").format({user_name:this.user_name})}else{ex=dU("Delete %(user_name)s").format({user_name:this.user_name})}this.$modal_window.find(".db-modal-title-text").text(ex);this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);if(this.invited){this.$modal_window.find(".active_user_remove_setting").remove();return this.$modal_window.find(".dfe-remove-user-modal").addClass("invited")}};ev.prototype.success_callback=function(ey){var ex,ez,ew;ex=JSON.parse(ey.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if((ez=window.active_team_member_table)!=null){ez.remove_user(this.user_id)}if((ew=window.removed_team_member_table)!=null){ew.add_users(ex)}}if(this.invited){Y.success(dU("User uninvited."))}else{Y.success(dU("User removed."))}df.decrement_used_licenses();return this.hide()};ev.prototype.on_confirm_button_click=function(ey){var ew,ex;ey.preventDefault();ex=this.$modal_window.find(".dfe-remove-user-modal")[0];ew=$(this.$modal_window.find(".confirm-button")[0]);return bs.ajax_submit(ex,false,this.success_callback,this.handleAjaxFailure,ew)};return ev})(bi);d1=A.ManageFilesModal=(function(ev){cl(T,ev);function T(ex,ey,ew){this.source_user_id=ex;this.source_user_name=ey;this.options=ew;this.on_confirm_button_click=cU(this.on_confirm_button_click,this);T.__super__.constructor.call(this,this.options,"input[name=file_action]","#move-files")}T.prototype.get_form=function(){return this.$modal_window.find("form")[0]};T.prototype.on_show=function(){var ew;T.__super__.on_show.call(this);this.$modal_window.find("[name='source_user_id']").attr("value",this.source_user_id);this.$modal_window.find(".source-user-name").text(this.source_user_name);ew=dU("Manage %(team_member)s's files").format({team_member:this.source_user_name});this.$modal_window.find(".db-modal-title-text").text(ew);return this.get_form().on("submit",this.on_confirm_button_click)};T.prototype.on_confirm_button_click=function(ey){var ew,ex,ez;ey.preventDefault();ex=this.get_form();ew=$(this.$modal_window.find(".confirm-button")[0]);ez=(function(eA){return function(eC){var eB;eB=JSON.parse(eC.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.removed_team_member_table){window.removed_team_member_table.update_user_data(eB)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu!=null){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",eB)}}}if(bf("#move-files").prop("checked")){Y.success(dU("Transfer started",{comment:"This refers to the start of a file transfer from one Dropbox to another"}))}else{Y.success(dU("Permanently deleted files"))}return eA.$modal_window.hide()}})(this);return bs.ajax_submit(ex,false,ez,this.handleAjaxFailure,ew)};return T})(bi);b1=A.show_manage_files_modal=function(T,ev){var ew;ew=new d1(T,ev,{element_id:"manage-files-modal",focus:".new-collab-input"});return ew.show()};n=function(){var T;T=function(ex,ew){var ev,ey;bf(ew).css("display","none");ev=bf(ew).closest("#user_generate_liveops_pin");ey=ev.find(".user_generate_liveops_pin_value");ey.text(ex.pin);bf(ew).addClass("liveops_pin_elem_invisible");return ev.find(".user_generate_liveops_pin_text").removeClass("liveops_pin_elem_invisible")};df.get_pin_with_user_id(null,this,T);return false};bf("#user_generate_liveops_pin_button").click(n);var M,b,dv,aX,af,bk=[].indexOf||function(ew){for(var ev=0,T=this.length;ev<T;ev++){if(ev in this&&this[ev]===ew){return ev}}return -1},cy=[].slice;M=A.NOTCLIENTS={};b=A.NOTCLIENT_DEBUG=false;dv="/subscribe";aX=A.add_notclient=function(T,ew,ev){af(T);return setTimeout((function(){return M[T].init(ew,ev)}),2000)};af=A.new_notclient=function(eM){var e0,e2,eD,eF,eC,eN,eK,eV,ew,eH,T,ey,eG,e5,ex,e6,eA,eR,eL,ez,eT,eE,eJ,e1,eQ,e7,eZ,eI,eY,ev,eS,eX,eB,eO,e4,eW,eP,e3,eU;ci(bk.call(M,eM)<0,"cannot create more than one notclient per user");eL=function(e8){return $u.isNumber(e8)&&e8%1===0&&e8>0};eR=function(e8){return $u.isNumber(e8)&&e8%1===0&&e8>=0};ci(eL(eM),"user_id must be a positive integer");ez=function(){var e8;e8=1<=arguments.length?cy.call(arguments,0):[];if(b){return console.log.apply(console,e8)}};e0=90000;eF=8096;eN="user";eC="list";ex=false;e2=1000;eD=5*60*1000;e7=0;eO=function(){var e8;if(ey===0){e8=0}else{e8=Math.min(e2*Math.pow(2,ey-1),eD)}return Math.max(e8,e7)};e1=null;eZ={};e5={};eJ=1;e6=false;eA=false;e3=null;eV=false;eW=[];eB=null;T=null;eT=null;eE={};eI=false;ey=0;e4=0;eP=function(fc,fa){var e9,e8,fb;fb=[];for(e9 in fa){e8=fa[e9];e9=parseInt(e9,10);ci(eL(e9),"ns_ids must be positive integers: "+e9);ci(eR(e8),"sjids must be nonnegative integers: "+e8);if(fc[e9]!=null){fb.push(fc[e9]=Math.min(fc[e9],e8))}else{fb.push(fc[e9]=e8)}}return fb};ew=function(){var fa,e9,fb,e8;ci((e1!=null)&&!$u.isEmpty(eZ),"expected nid and ns_map");fb={host_int:0,trace:window.location.pathname,rev:Constants.SVN_REV};fa=$u.pluck($u.values(e5),"type");if(bk.call(fa,eN)>=0){fb.user_id=eM;fb.nid=e1!=null?e1.replace(/^0+(.)/,"$1"):void 0}if(bk.call(fa,eC)>=0){fb.ns_map=((function(){var fc;fc=[];for(e9 in eZ){e8=eZ[e9];fc.push(""+e9+"_"+e8)}return fc})()).join(",")}if(C.parse(dv).updateQuery(fb).toString().length>eF){delete fb.ns_map}return fb};eH=function(){var e8;if(!ex){return}e8=eO();if(e8>0){return T=window.setTimeout(eU,e8)}else{return eU()}};eU=function(){var e8;ci(!e6&&!eA,"connect: invalid state");ci(e1>=0||!$u.isEmpty(eZ),"notclient: called connect with nothing to subscribe to");ez("###########################");e8=ew();if((e8.nid==null)&&!e8.ns_map){ez("nothing to subscribe to. skipping notserver connection.");return}ez("connecting to notserver...");e6=true;e4+=1;return e3=bf.ajax(dv,{data:e8,dataType:"json",noDropboxDefaults:true,error:function(){if(eV){eV=false;return}ey+=1;ez("error connecting to notserver. bad rounds="+ey+".");e6=false;return eH()},success:function(e9){ez("notserver connection closed. response:",e9);e6=false;if(e9.chillout!=null){e7=parseInt(e9.chillout,10)*1000;ez("notserver told us to chill for "+e7+"ms")}else{if(e7>0){ez("setting notserver chillout back to 0ms");e7=0}}if(e9.ret==="punt"){return eH()}else{ci(e9.ret==="new","unknown notserver ret: "+e9.ret);ci("refresh" in e9,"expected notserver ret:new to have refresh keyword");return eX(e9.refresh)}}})};eK=function(){if(e3!=null){eV=true;e3.abort();return e3=null}};eY=function(){e7=0;e6=false;eA=false;eK();eW=[];window.clearTimeout(eB);window.clearTimeout(T);eB=null;T=null;eT=null;eE={};eI=false;ey=0;return eH()};eS=function(){var e8;ex=false;e7=0;e1=null;eZ={};e5={};e8=0;eJ=1;e6=false;eA=false;e3=null;eV=false;eW=[];window.clearTimeout(eB);window.clearTimeout(T);eB=null;T=null;eT=null;eE={};eI=false;ey=0;return e4=0};eX=function(fd){var fg,fc,e8,e9,fe,fa,ff,fb;ci(!eA&&!e6,"run_handlers: invalid state");ci(eT===null,"run_handlers: new_nid must start at null");ci($u.isEqual(eE,{}),"run_handlers: new_ns_map must start at {}");ci(!eI,"expected one_or_more_handler_failures=false");eA=true;ez("running handlers...");e9=$u.filter($u.values(e5),function(fi){var fh;return fh=fi.type,bk.call(fd,fh)>=0});ci(!$u.isEmpty(e9),"notserver sent a ping for unsubscribed activity");eW=$u.pluck(e9,"handler_id");for(fa=0,ff=e9.length;fa<ff;fa++){fb=e9[fa],fg=fb.handler,fc=fb.handler_id,e8=fb.name,fe=fb.type;ez("running id="+fc+", name="+e8+", type="+fe);fg()}if($u.isEmpty(eW)){return ez("all handlers already finished running. no need for a slacker timeout.")}else{ez("all handlers running. slacker timeout set.");return eB=window.setTimeout(ev,e0)}};ev=function(){var fa,fb,e9,e8;ci(eA&&!e6,"called report_slackers in an invalid state.");ci(!$u.isEmpty(eW,"report_slackers called w/ nothing slackin'"));ez("found some slackers");eI=true;e8=[];for(fb=0,e9=eW.length;fb<e9;fb++){fa=eW[fb];e8.push(eG(fa))}return e8};eG=function(e8){if(bk.call(eW,e8)<0){return}ez("done handling: "+e8);eW=$u.without(eW,e8);if($u.isEmpty(eW)){ez("all handlers are done running.");eA=false;window.clearTimeout(eB);if(eT!=null){ez("new nid: "+eT);e1=eT}if(!$u.isEmpty(eE)){ez("new ns_map:",eE);eZ=eE}if(eI){ey+=1;ez("one or more handler errors. bad_rounds="+ey)}else{ey=0}eT=null;eE={};eI=false;return eH()}};eQ={get_user_id:function(){return eM},get_nid:function(){return e1},get_ns_map:function(){return $u.clone(eZ)},get_consecutive_bad_rounds:function(){return ey},get_total_rounds:function(){return e4},get_notserver_chillout_ms:function(){return e7},get_sleep_ms:eO,subscribe_user:function(ff){var e9,fa,fe,fd,fc,e8,fb;ci(!eA,"adding new handlers from inside handlers is not currently supported");fb=["name","handler"];for(fc=0,e8=fb.length;fc<e8;fc++){fd=fb[fc];ci(ff[fd],"subscribe_user requires this param be non-falsey: "+fd)}ci($u.isFunction(ff.handler),"handler must be a function");ez("adding user handler "+ff.name);fa=$u.pluck($u.values(e5),"type");fe=bk.call(fa,eN)<0;e9=eJ++;e5[e9]={handler_id:e9,handler:ff.handler,name:ff.name,type:eN};if(fe){ez("first user handler added, reconnecting");eY()}return e9},subscribe_sfj:function(ff){var e9,fa,fe,fd,fc,e8,fb;ci(!eA,"adding new handlers from inside handlers is not currently supported");fb=["name","handler"];for(fc=0,e8=fb.length;fc<e8;fc++){fd=fb[fc];ci(ff[fd],"subscribe_sfj requires this param be non-falsey: "+fd)}ci($u.isFunction(ff.handler),"handler must be a function");ez("adding sfj handler "+ff.name);fa=$u.pluck($u.values(e5),"type");fe=bk.call(fa,eC)<0;e9=eJ++;e5[e9]={handler_id:e9,handler:ff.handler,name:ff.name,type:eC};if(fe){ez("first sfj handler added, reconnecting");eY()}return e9},handler_success:function(e8,fa){var e9;if(bk.call(eW,e8)<0){return}e9=e5[e8].type;if(e9===eC){ci("ns_map" in fa,"ns_map required param is missing");ci(!("nid" in fa),"nid is disallowed from SFJ handlers");eP(eE,fa.ns_map)}else{ci(e9===eN,"unknown handler type: "+e9);ci("nid" in fa,"nid required param is missing");ci(!("ns_map" in fa),"ns_map is disallowed from user handlers");if((eT==null)||fa.nid<eT){eT=fa.nid}}return eG(e8)},handler_failure:function(e8){ez("handler failed. handler_id="+e8);if(bk.call(eW,e8)<0){return}eI=true;return eG(e8)},handle_visibility_change:function(){if(window.document.hidden){return eK()}else{return eY()}},init:function(e9,e8){ci(!ex,"error: init() has been called twice.");e1=e9;eP(eZ,e8);ex=true;if(window.document.visibilityState!=null){window.document.on("visibilitychange",this.handle_visibility_change);if(!window.document.hidden){return eH()}}else{return eH()}},reset:eS,abort:eK,reconnect:eY};M[eM]=eQ;return eQ};var be;be=A.UpdateEvents={ADD:"db:add_file_objects",REMOVE:"db:remove_file_objects",MOVE:"db:move_file_objects"};var bH;bH=A.FileTypes={FILE:1,FOLDER:2,PACKAGE:3,SHARED_FOLDER:4,SANDBOX:5};var aO;aO=A.BrowseUtil={THUMBS_BATCH_SIZE:16,make_browsefile:function(ev,ew){var T;if(ew==null){ew=null}T=Object.clone(ev);if(T.is_dir){T.ago="";T.ts=0}else{T.target_ns=false}T.sort_key=ds.decode_sort_key(T.sort_key);T.request_id=ew!=null?ew:null;return new co(T)},filepreview_from_selected:function(eH,eM,eN,ey,ez){var eK,eE,eA,eI,ew,eG,ev,eB,eJ,eF,eD,ex,T,eL,eC;if(ey==null){ey=false}if(ez==null){ez=false}if(eM&&(eM.bytes<0||eM.preview_type==="download")){window.open(eM.href,"_blank");return}ex=dX.get_url();eG=dX.deconstruct_url(ex);ew=ex.indexOf("/lightbox")===0;eA=ex.indexOf("/sh/")===0;eE=ex.indexOf("/s/")===0;ev=eG.qargs.preview!=null;if((eH==="callback")&&ew&&ax.shown){return}else{if(eH==="fileclick"&&eM&&((eC=eM.preview_type)!=="photo"&&eC!=="video")){l.show(eM,b2.active_user,true);if(!(ez||eE||eG.qargs.preview===eM.filename)){l.set_preview_url(eM,b2.active_user,true)}return}}if(!eM){eF=ee.get_selected_files();eM=eF&&eF.first()}eJ=ey?[eM]:b2.files;eB=this.browsefile_to_filepreview(eJ);if(eB.length){eD=0;if(eM){for(eI=T=0,eL=eB.length;T<eL;eI=++T){eK=eB[eI];if(eK.fq_path===eM.fq_path){eD=eI;break}}}if(eA){aa.close_shared_link_view()}return ax.init(eB,{start_index:eD,include_delete:true,keep_url:eE||ez,is_loading:eN,share_button_experiment_variant:b2.lightbox_share_button_experiment_variant})}},browsefile_to_filepreview:function(ez){var eB,ev,ex,T,ey,eA,ew;T=[];for(eA=0,ew=ez.length;eA<ew;eA++){eB=ez[eA];if(eB.bytes<0||eB.dir){continue}if(eB.preview_type==="photo"&&eB.large_thumbnail_url_tmpl){ev="null-"+eB.filename;ex=new S({filename:eB.filename,fq_path:eB.fq_path,thumbnail_url_tmpl:eB.large_thumbnail_url_tmpl,dl_url:C.parse(eB.href).updateQuery({dl:1}).toString(),original_url:eB.href,link_hash:ev,ns_id:eB.ns_id,ns_path:eB.ns_path,owner_id:eB.user_id});T.push(ex)}else{if(eB.preview_type==="video"&&eB.large_thumbnail_url_tmpl&&!Constants.DISABLE_VIDEOS_IN_LIGHTBOX){ey=new bh({filename:eB.filename,fq_path:eB.fq_path,thumbnail_url_tmpl:eB.large_thumbnail_url_tmpl,preview_url:eB.video_transcode_url(),dl_url:C.parse(eB.href).updateQuery({dl:1}).toString(),ns_id:eB.ns_id,ns_path:eB.ns_path,owner_id:eB.user_id});T.push(ey)}}}return T},profile_files:function(ev){var ew,ex,ey,T;ex={files:0,folders:0,shared_folders:0,deleted:0,public_folder:0,rejoinables:0,sandboxes:0,target_namespaces:0,in_root_coll:0};for(ey=0,T=ev.length;ey<T;ey++){ew=ev[ey];if(ew.dir){ex.folders+=1}else{ex.files+=1}if(ew.is_sandbox()){ex.sandboxes+=1}if(ew.is_shared_folder()){ex.shared_folders+=1}if(ew.bytes===-1){ex.deleted+=1}if(ew.target_ns){ex.target_namespaces+=1}if(ew.fq_path.toLowerCase()==="/public"&&b2.public_folder_enabled){ex.public_folder=1}if(ew.in_root_coll){ex.in_root_coll+=1}}return ex},profile_summary:function(ev){var ew,T;ew=aR("%d file","%d files",ev.files,{comment:"used in a phrase such as 'x files and y folders'"}).format(ev.files);T=aR("%d folder","%d folders",ev.folders,{comment:"used in a phrase such as 'x files and y folders'"}).format(ev.folders);if(ev.files&&ev.folders){return dU("%(x_files)s and %(y_folders)s",{comment:"x_files will either be '1 file' or 'd files', similar for x_folders"}).format({x_files:ew,y_folders:T})}else{if(ev.files){return ew}else{if(ev.folders){return T}else{return""}}}},BROWSE_MODE:"browse",SEARCH_MODE:"search",SPECIAL_MODES:["search"],set_browse_mode:function(){var eB,ez,ew,ev,eA,ey,T,ex;eB=bf("#browse");ew=eB.find("#browse-root-actions");ev=eB.find("#browse-sort");ez=eB.find("#browse-header-status");ex=this.SPECIAL_MODES;for(ey=0,T=ex.length;ey<T;ey++){eA=ex[ey];eB.removeClass(eA);ew.removeClass(eA);ev.removeClass(eA);ez.removeClass(eA)}if(bJ.fulltext_search_enabled){bJ.reset_fulltext_search(true);eB.removeClass("fulltext_search");ew.removeClass("fulltext_search");ev.removeClass("fulltext_search");ez.removeClass("fulltext_search");bf("#fulltext-search-loading").hide();return bf("#fulltext-search-all-link").hide()}},set_special_mode:function(eA){var ev,ew,eC,T,ez,ex,eB,ey;ev=bf("#browse");eC=ev.find("#browse-root-actions");T=ev.find("#browse-sort");ew=ev.find("#browse-header-status");ci(this.SPECIAL_MODES.indexOf(eA)!==-1,"unknown mode");if(ev.hasClass(eA)){ci(eC.hasClass(eA),"inconsistent modes");ci(T.hasClass(eA),"inconsistent modes");return}ey=this.SPECIAL_MODES;for(ex=0,eB=ey.length;ex<eB;ex++){ez=ey[ex];if(ez!==eA){ev.removeClass(ez);eC.removeClass(ez);T.removeClass(ez);ew.removeClass(ez)}}ev.addClass(eA);eC.addClass(eA);T.addClass(eA);ew.addClass(eA);if(eA===this.SEARCH_MODE){if(bJ.fulltext_search_enabled){ev.addClass("fulltext_search");eC.addClass("fulltext_search");T.addClass("fulltext_search");return ew.addClass("fulltext_search")}}},get_mode:function(){var ey,T,ex,ev,ew;T=this.BROWSE_MODE;ew=this.SPECIAL_MODES;for(ex=0,ev=ew.length;ex<ev;ex++){ey=ew[ex];if(bf("#browse").hasClass(ey)){T=ey}}return T},load_visible_thumbs:function(){var eE,eH,ex,eD,eI,eJ,eF,ew,eB,ev,eA,ez,eG,T,eC,ey;ew=this.get_files_in_view();eH=ew[1]-ew[0];eF=[Math.max(ew[0]-eH,0),ew[0]];eJ=[Math.min(ew[1],b2.files.length),Math.min(ew[1]+eH,b2.files.length)];eE=[];eC=[ew,eJ,eF];for(eA=0,eG=eC.length;eA<eG;eA++){eI=eC[eA];eD=eI[0],eB=eI[1];ey=b2.files.slice(eD,+eB+1||9000000000);for(ez=0,T=ey.length;ez<T;ez++){ex=ey[ez];if(ex.get_div()){eE.push(ex.get_div().down("img"))}}}ev=function(eK){if(!eK.src.endsWith(b6.SPACER)){eK.addClassName("thumbnail");return eK.__sert({before:new Element("div",{"class":"thumbnail-border"})})}};return a6.batch_load_thumbs(eE,this.THUMBS_BATCH_SIZE,ev)},get_files_in_view:function(){var ez,ew,eB,ex,ey,ev,eC,eA,T,eD;T=y.viewport_dimensions().height;eD=y.scroll_offsets().top;ev=this._get_elm_height();if(!ev){return[0,b2.files.length-1]}if(bf("body").hasClass("whole-page-scrollable")){ew=bf("#browse-files").offset().top;eB=ew-eD;if(eB>0){eC=0;ey=T-eB;eA=ey/ev}else{eC=Math.abs(eB/ev);eA=Math.abs(T-eB)/ev}}else{ez=bf("#browse-files");if(!ez.length){return[0,b2.files.length-1]}ex=parseInt(ez.css("padding-top"));eC=eD/ev;ey=T-ex;eA=(ey+eD)/ev}eC=Math.max(Math.floor(eC),0);eA=Math.min(Math.floor(eA),b2.files.length-1);return[eC,eA]},_get_elm_height:function(){var ev,T;if(b2.files.length>=3&&b2.files[1].get_div()){ev=bf(b2.files[1].get_div());T=ev.outerHeight()+parseInt(ev.css("margin-bottom"))+parseInt(ev.css("margin-top"));return T}else{return null}},append_ellipsis:function(T){return dU("%(action_text)s\u2026","web","action which requires further user interaction").format({action_text:T})},_show_blue_sharing_icons:function(){return b2.sharing_icons_experiment_variant&&b2.sharing_icons_experiment_variant==="BLUE_ICONS"},get_shared_folder_icon:function(){if(this._show_blue_sharing_icons()){return"s-folder-blue"}else{return"rainbow_16"}},get_shared_link_icon:function(){if(this._show_blue_sharing_icons()){return"s-link-blue"}else{return"s_link"}}};var a4;a4=A.Sort=(function(){var eA,T,ex,ez,ey,ew,ev;ex=function(eC){var eB;eB=eC?1:-1;return function(eD,eE){return eB*ds.sort_by_rank_or_key(eD,eE)}};ez=function(eC){var eB;eB=eC?1:-1;return function(eD,eE){if(eD.bytes>eE.bytes){return eB}else{if(eD.bytes<eE.bytes){return -eB}else{return eB*a4.FILES_BY_NAME(eD,eE)}}}};eA=function(eC){var eB;eB=eC?1:-1;return function(eD,eE){return eB*(eD.fq_path.toLowerCase()>eE.fq_path.toLowerCase()?1:-1)}};T=function(eC){var eB;eB=eC?1:-1;return function(eE,eF){var eD;eD=eE.ts===eF.ts?0:eE.ts>eF.ts?1:-1;return eB*eD}};ew=function(eB){return function(eE){var eD,eC;eC=eB(eE);eD=ex(true);return function(eF,eG){if(eF.dir^eG.dir){return(eF.dir?1:0)-(eG.dir?1:0)}else{return eC(eF,eG)||eD(eF,eG)}}}};ey=function(eB){return function(eE){var eC,eD;if(!a4.FOLDERS_FIRST){return eB(eE)}eD=eB(eE);eC=eE?1:-1;return function(eG,eH){var eF;if(eG.dir^eH.dir){eF=(eG.dir?0:1)-(eH.dir?0:1);return eC*eF}else{return eD(eG,eH)}}}};ev=function(eB){return function(eE){var eC,eD;eD=a4.FILES_BY_NAME(eE);eC=eE?1:-1;return function(eG,eH){var eF;if(eG.is_deleted^eH.is_deleted){return(eG.is_deleted?1:0)-(eH.is_deleted?1:0)}eF=0;if(eB){if(eG.get_category()!==eH.get_category()){eF=eG.get_category()<eH.get_category()?-1:1}else{if(eG.get_extension()!==eH.get_extension()){eF=eG.get_extension()<eH.get_extension()?-1:1}}}else{if(eG.get_extension()!==eH.get_extension()){eF=eG.get_extension()<eH.get_extension()?-1:1}else{if(eG.get_category()!==eH.get_category()){eF=eG.get_category()<eH.get_category()?-1:1}}}return(eC*eF)||eD(eG,eH)}}};return{FILES_BY_NAME:ey(ex),FILES_BY_SIZE:ew(ez),FILES_BY_LOCATION:ew(eA),FILES_BY_KIND:ew(ev(true)),FILES_BY_EXTENSION:ew(ev(false)),FILES_BY_MODIFIED:ew(T),FOLDERS_FIRST:!ds.is_mac(),ALL_BY_MODIFIED:T}})();var cP;cP=A.FlexColumn=(function(){var eC,ew,eF,eA,ex,eB,ev,T,eE,ey,eD,ez;eC=[["FILES_BY_KIND",a4.FILES_BY_KIND,dU("Kind"),true],["FILES_BY_EXTENSION",a4.FILES_BY_EXTENSION,dU("Extension"),true],["FILES_BY_SIZE",a4.FILES_BY_SIZE,dU("Size"),false]];ew={};eF={};ex=[];eA=[];for(ey=0,eD=eC.length;ey<eD;ey++){ez=eC[ey],eE=ez[0],ev=ez[1],eB=ez[2],T=ez[3];ex.push(ev);ew[eE]=eB;eF[eE]=T;eA.push(eE)}return{SORT_FUNCTIONS:ex,DISPLAY:ew,IS_ASC:eF,LABELS:eA}})();var bJ,dW;dW=A.SearchType={COMPLETION:"completion",DELETED:"deleted",FULLTEXT:"full-text"};bJ=A.FileSearch={MAX_RESULTS:100,SHORT_PREFIX_LEN:2,SHORT_PREFIX_DELAY_TIME:250,_cache:{},_cache_ts:{},CACHE_TIME:60000,last_state:false,last_fq_path:null,scoped_search:true,last_new_search_ts:{},init:function(eG,eD){var ev,eF,eC,ew,eA,ez,eE,T,eB,ey,ex;this.sparky_search_ui_enabled=eG;this.fulltext_search_enabled=eD;if(this.sparky_search_ui_enabled){return}eC=$("browse-search");eF=$("browse-search-input");bS.add_interval_handler(eC,this.search_with_delay.bind(this));$("advanced-search-box").observe("submit",(function(eH){return function(eI){eH.search();return Event.stop(eI)}})(this));$("exit-search-xclose").observe("click",(function(eH){return function(){return eH.exit_search()}})(this));key("/",b2.KEY_SCOPE,(function(eH){return function(){if(J.is_active()){return}if(!eC.hasClassName("focused")){eF.focus();return false}}})(this));key("escape",b2.KEY_SCOPE,(function(eH){return function(){if(b2.in_search_mode()){eH.exit_search();return false}if(eF.getValue().strip()===""){eF.blur();return false}}})(this));key("tab",b2.KEY_SCOPE,(function(eH){return function(eI){if(document.activeElement===eF){eI.preventDefault();eF.blur();if(b2.files.length){ee.set_selected_files(b2.files[0])}else{if(b2.in_search_mode()){eH.toggle_advanced()}}return false}}})(this));ew="#advanced-search-link, #advanced-search-exit, #advanced-search-cancel";$(document.body).on("click",ew,this.toggle_advanced.bind(this));document.observe(av.RENAME,(function(eH){return function(){return eH.clear_cache()}})(this));eB=[av.DELETE,av.COPY,av.MOVE,av.PURGE,av.RESTORE,av.UPLOAD,av.SF_NEW,av.SF_LEAVE,av.SF_UNSHARE,av.SF_REJOIN,av.SF_IGNORE,av.LINKS_REMOVE];for(eA=0,eE=eB.length;eA<eE;eA++){ev=eB[eA];document.observe(ev,(function(eH){return function(eI){if(!b2.inside_dir){return eH.force_reload()}}})(this))}ey=[be.ADD,be.MOVE,be.REMOVE];ex=[];for(ez=0,T=ey.length;ez<T;ez++){ev=ey[ez];ex.push(document.observe(ev,(function(eH){return function(eI){return eH._update_number_results(b2.files.length)}})(this)))}return ex},get_state:function(){var eA,ew,ez,ev,ey,T,ex;eA=bf("#browse-search");if(this.fulltext_search_enabled){ez={is_advanced:false}}else{ez={is_advanced:eA.length&&!eA.visible()}}if(ez.is_advanced){ex=["all_terms","any_terms","excluded_terms","exact"];for(ey=0,T=ex.length;ey<T;ey++){ew=ex[ey];ev=bf("#"+ew).val();if(ev){ez[ew]=ev}}ez.include_files=bf("#include_files").prop("checked");ez.include_folders=bf("#include_folders").prop("checked");ez.include_deleted=!Constants.can_see_trash&&bf("#include_deleted").prop("checked")}else{ez.query_unnormalized=this.get_basic_query();ez.query=ez.query_unnormalized.toLowerCase().strip().split(RegExp(" +")).join(" ");if(this.fulltext_search_enabled){ez.last_fq_path=this.last_fq_path!=null?this.last_fq_path:""}}return ez},set_state:function(ey){var ev,ex,T,ew;if(ey.is_advanced){ew=["all_terms","any_terms","excluded_terms","exact"];for(ex=0,T=ew.length;ex<T;ex++){ev=ew[ex];if(ey[ev]){$(ev).setValue(ey[ev])}}bf("#include_files").prop("checked",ey.include_files);bf("#include_folders").prop("checked",ey.include_folders);if(!Constants.can_see_trash){bf("#include_deleted").prop("checked",ey.include_deleted)}this.show_advanced();return this.search()}else{if(this.fulltext_search_enabled){this.last_fq_path=ey.last_fq_path!=null?ey.last_fq_path:"";this.scoped_search=this.last_fq_path!=="";b2.inside_dir=this.scoped_search}this.set_basic_query(ey.query_unnormalized);this.show_basic();if(this.fulltext_search_enabled){return this.do_search(this.scoped_search,true)}else{return this.search()}}},state_changed:function(){var ev,T;ev=this.get_state();T=this.last_state;if(this.fulltext_search_enabled){if(T===false){return !!ev.query}return(ev.is_advanced!==T.is_advanced)||(ev.query!==T.query)||(ev.last_fq_path!==T.last_fq_path)}else{if(T===false){return !!ev.query}return(ev.is_advanced!==T.is_advanced)||(ev.query!==T.query)}},get_basic_query:function(){return this._get_browse_search_input().val()},set_basic_query:function(T){if(T===this.get_basic_query()){return}this._get_browse_search_input().val(T);if(!this.fulltext_search_enabled){$("browse-search").show()}return $("advanced-search-link").__date(dU("Advanced search"))},set_title:function(){var T,ev;T=this.get_state();ev=dU("Search - Dropbox");if(T.query_unnormalized){ev=""+T.query_unnormalized+" - "+ev}return document.title=ev},_pending_search_q:"",search_with_delay:function(){var ev,ew,T;ew=this.search.bind(this);T=this.get_state();if(T.is_advanced){return}ev=T.query;if(ev.length===0&&b2.in_search_mode()){ew();return}if(ev.length<=this.SHORT_PREFIX_LEN){if(ev!==this._pending_search_q){this._pending_search_q=ev;clearTimeout(this._pending_search_timer);return this._pending_search_timer=setTimeout(ew,this.SHORT_PREFIX_DELAY_TIME)}}else{this._pending_search_q="";if(this.state_changed()){return ew()}}},_set_scope_path_to_browse_location:function(){if(b2.inside_dir){return this.last_fq_path=b2.containing_fq_path()}else{return this.last_fq_path=""}},do_search:function(ew,ev){var ey,ex,T;if(ev==null){ev=false}T=!ev&&!b2.in_search_mode();if(this.fulltext_search_enabled&&T){this._set_scope_path_to_browse_location()}ex=this.get_state();ey=""===this.get_basic_query();if(!ex.is_advanced&&ey){if(b2.in_search_mode()){this._clear_on_reload=false;this.exit_search()}return}this.last_state=ex;this._clear_on_reload=true;if(!(b2.in_search_mode()&&!this.fulltext_search_enabled)){ee.deselect_all();b2.clear();aO.set_special_mode("search");if(!this.fulltext_search_enabled){this._set_scope_path_to_browse_location()}this.scoped_search=this.last_fq_path!=="";if(!ev){if(this.fulltext_search_enabled){dX.push_state("/search",this.last_state)}else{dX.push_state("/search")}}}this._prune_cache();this.set_title();if(ex.is_advanced){this.ask_server_advanced()}else{if(this.fulltext_search_enabled){this.reset_fulltext_search(this.scoped_search);this.last_new_search_ts=new Date();bf("#fulltext-search-loading").show();this.ask_server("/ajax_fulltext_search",ew,0,this.MAX_RESULTS,false)}else{if(ex.query in this._cache){this.update_results()}else{if(!this.attempt_cache_filter()){this.ask_server("/ajax_search",false)}}}}return d0("search")},search:function(T){if(T==null){T=false}if(T!==this.scoped_search){this.last_state=false}this.scoped_search=this.scoped_search&&T;if(this.fulltext_search_enabled&&!this.scoped_search){this.last_fq_path=""}return this.do_search(false)},load_more_results:function(){var T;if(this.fulltext_search_enabled&&!this.end_of_results){T=this.search_pos;if(this.end_of_active_results){T=this.deleted_search_pos}return this.ask_server("/ajax_fulltext_search",false,T,this.MAX_RESULTS,this.end_of_active_results)}},firefly_filename_search:function(){return this.do_search(true)},_prune_cache:function(){var ew,ex,ez,ey,ev,T;ew=new Date();ex=[];for(ez in this._cache_ts){if(ew-this._cache_ts[ez]>this.CACHE_TIME){ex.push(ez)}}T=[];for(ey=0,ev=ex.length;ey<ev;ey++){ez=ex[ey];delete this._cache[ez];T.push(delete this._cache_ts[ez])}return T},update_empty:function(){var T;T=dU("No results found");if(this.scoped_search&&this.fulltext_search_enabled){T=dU("No results found in '%(path)s'").format({path:an.filename(this.last_fq_path)})}bf("#noresults-header").text(T);bf("#fulltext-search-all-link").hide();bf("#noresults-directions").toggle(!(this.scoped_search&&this.fulltext_search_enabled));return bf("#noresults-search-all-link").toggle(this.scoped_search&&this.fulltext_search_enabled)},show_empty:function(){this.update_empty();return $("search-empty").show()},hide_empty:function(){return $("search-empty").hide()},reset_fulltext_search:function(T){ee.deselect_all();b2.clear();b2.reset_state();b2.update_header_status("");this.search_pos=0;this.deleted_search_pos=0;this.end_of_active_results=false;this.end_of_results=false;this.scoped_search=T;return bf("#fulltext-search-all-link").hide()},exit_search:function(){var ev,ex,T,ew;if(b2.in_search_mode()&&this.fulltext_search_enabled){b2.deleted_shown=false}ew=$$("#advanced-search-box .sick-input input");for(ex=0,T=ew.length;ex<T;ex++){ev=ew[ex];ev.setValue("");ev.blur()}this.show_basic();$("browse").removeClassName("pending-search");this.hide_empty();b2.first_load=true;return b2.reload_fqpath(this.last_fq_path,true)},clear_cache:function(){this._cache={};return this._cache_ts={}},force_reload:function(){this.clear_cache();return this.search()},create_completion_log_dict:function(ev,eA,ex,ey,ez,T,ew){if(ev==null){ev=null}if(eA==null){eA=null}if(ex==null){ex=null}if(ey==null){ey=null}if(ez==null){ez=null}if(T==null){T=null}if(ew==null){ew=null}if(ev==null){return}if(eA!=null){ev.request_id=eA}if(ex!=null){ev.latency=(new Date().getTime())-ex}if(ey!=null){ev.query_string=ey.query;if((T==null)||T===200){ev.displayed=this.last_state.query===ey.query?true:false}}if(ez!=null){ev.result_count=ez}if((T!=null)&&T!==200){ev.failure_type=T}if(ew!=null){ev.file_nsid=ew.ns_id;ev.file_sjid=ew.sjid}return ev},ask_server:function(ev,eA,ew,eB,ey){var ez,eE,eC,ex,eD,T;T=this.get_state();eD=null;if(this.fulltext_search_enabled){ex=new Date();if(ey){eD=dW.DELETED}else{if(eA){eD=dW.COMPLETION}else{eD=dW.FULLTEXT}}}ez={firefly:this.fulltext_search_enabled,infinite_scroll:ew>0?true:false,path_scoped:false,search_type:eD,query_string:T.query};aQ.SearchClientActivityLogger.log("query_started",b2.active_user.id,ez);ci(!T.is_advanced,"expected to be in basic search mode");if(!ew){bf("#web-search-results").html(dU("Searching..."))}bf("#browse").addClass("pending-search");eE={query:T.query};if(this.fulltext_search_enabled){if(ew){eE.start=ew}if(eB){eE.max_results=eB}if(ey){eE.deleted=ey}if(this.scoped_search){eE.fq_path=this.last_fq_path}if(!eA){this.last_fulltext_query=T.query}}if(eA){eE.filename_only=true}eC=false;return new Ajax.DBRequest(ev,{no_watch:true,evalJSON:false,parameters:eE,log_timing:true,onSuccess:(function(eF){return function(eH){var eI,eG,eK,eJ;if(!b2.in_search_mode()){return}eK=eH.request.parameters.parent_request_id;eI=JSON.parse(eH.responseText);eJ=eI.file_info.length;if(eF.fulltext_search_enabled){if(T.query===eF.last_fulltext_query&&ex>=eF.last_new_search_ts){eF.search_pos=eF.search_pos+eJ;if(eF.end_of_active_results){eF.deleted_search_pos=eF.deleted_search_pos+eJ}if(eJ<eF.MAX_RESULTS){eF.end_of_results=true&&eF.end_of_active_results;eF.end_of_active_results=true;if(!eF.end_of_results){eC=true}else{bf("#fulltext-search-loading").hide()}}eF.update_results(eI,eC,eK)}}else{eF._cache[T.query]=eI;eF._cache_ts[T.query]=new Date();if(!eF.last_state.is_advanced&&(eF.last_state.query===T.query)){eF.update_results(null,false,eK)}}if(eI.file_info.length>0){eG=eI.file_info[0]}else{eG=null}ez=eF.create_completion_log_dict(ez,eK,eH.request.start_time,T,eJ,null,eG);return aQ.SearchClientActivityLogger.log("query_completed",b2.active_user.id,ez)}})(this),onFailure:(function(eF){return function(eG){ez=eF.create_completion_log_dict(ez,eG.request.parameters.parent_request_id,eG.request.start_time,T,null,eG.status);return aQ.SearchClientActivityLogger.log("query_failed",b2.active_user.id,ez)}})(this),cleanUp:(function(eF){return function(){if(eC){return eF.load_more_results()}else{return bf("#browse").removeClass("pending-search")}}})(this),subject_user:b2.active_user})},ask_server_advanced:function(){var T,ev;ev=this.get_state();T={firefly:this.fulltext_search_enabled,query_string:ev.query};aQ.SearchClientActivityLogger.log("query_started",b2.active_user.id,T);ci(ev.is_advanced,"expected to be in advanced search mode");ci(!ev.query,"expected advanced search params only");delete ev.is_advanced;$("web-search-results").__date(dU("Searching..."));$("browse").addClassName("pending-search");return new Ajax.DBRequest("/ajax_advanced_search",{no_watch:true,evalJSON:false,parameters:ev,log_timing:true,onSuccess:(function(ew){return function(ey){var ex,ez;if(!b2.in_search_mode()){return}ez=ey.request.parameters.parent_request_id;ew.advanced_results=JSON.parse(ey.responseText);ew.update_results(null,false,ez);if(ew.advanced_results.file_info.length>0){ex=ew.advanced_results.file_info[0]}else{ex=null}T=ew.create_completion_log_dict(T,ey.request.parameters.parent_request_id,ey.request.start_time,ev,ew.advanced_results.file_info.length,null,ex);return aQ.SearchClientActivityLogger.log("query_completed",b2.active_user.id,T)}})(this),onFailure:(function(ew){return function(ex){T=ew.create_completion_log_dict(T,ex.request.parameters.parent_request_id,ex.request.start_time,ev,null,ex.status);return aQ.SearchClientActivityLogger.log("query_failed",b2.active_user.id,T)}})(this),cleanUp:(function(ew){return function(ex){return $("browse").removeClassName("pending-search")}})(this),subject_user:b2.active_user})},attempt_cache_filter:function(){var T,ex,ev,eB,ew,eA,ez,ey;eA=this.get_state().query;eB=this._query_to_regex(eA);ev=function(eC){return eB.match(an.filename(eC.ns_path).toLowerCase())};if(eA.length<=1){return false}for(ew=ez=ey=eA.length-1;ey<=1?ez<=1:ez>=1;ew=ey<=1?++ez:--ez){ex=eA.substr(0,ew).strip();if(ex in this._cache){if(this._cache[ex].file_info.length<this.MAX_RESULTS){T=Object.clone(this._cache[ex]);T.file_info=T.file_info.findAll(ev);this.update_results(T);return true}else{return false}}}return false},_query_to_regex:function(T){return new RegExp(RegExp.escape(T).split(new RegExp(" +")).join(".*"))},update_results:function(ev,T,ez){var ey,ex,ew;if(T==null){T=false}if(ez==null){ez=null}if(!this.fulltext_search_enabled){b2.reset_state();b2.reset_sort()}ew=this.get_state();if(!ev&&ew.is_advanced){ev=this.advanced_results}if(!ev){ex="the only way to get to advanced is through basic -- expected last_state to exist and not be advanced!";ci(this.last_state&&!this.last_state.is_advanced,ex);ci(this.last_state.query in this._cache,("update() called w/o a cache entry: q="+this.last_state.query)+(ev=this._cache[this.last_state.query]))}b2.update(ev,ez);b2.set_selection_from_fq_paths_or_index(bJ);ey=ew.is_advanced?dU("Basic search"):dU("Advanced search");$("advanced-search-link").__date(ey);if(!T){if(this.fulltext_search_enabled){this._update_number_results(this.search_pos)}else{this._update_number_results(b2.files.length)}if(b2.files.length){return this.hide_empty()}else{return this.show_empty()}}},_update_number_results:function(ev){var T,ew;if(this.sparky_search_ui_enabled){if(ev===0){T=""}else{if(this.end_of_results){T=this.fulltext_search_enabled?aR("%(num_results)s result in files, folders, and content.","%(num_results)s results in files, folders, and content.",ev).format({num_results:ev}):aR("%(num_results)s result in files and folders.","%(num_results)s results in files and folders.",ev).format({num_results:ev})}else{T=this.fulltext_search_enabled?aR("Over %(num_results)s result in files, folders, and content.","Over %(num_results)s results in files, folders, and content.",ev).format({num_results:ev}):aR("Over %(num_results)s result in files and folders.","Over %(num_results)s results in files and folders.",ev).format({num_results:ev})}}}else{if(ev===0){T=dU("No Results")}else{if(ev>=this.MAX_RESULTS){ev=ev+"+"}T=aR("%(num_results)s result","%(num_results)s results",ev).format({num_results:ev})}}ew=dU("Search")+" - "+T;if(this.sparky_search_ui_enabled){b2.update_header_status(T);ew=dU("Results for '%(query)s'").format({query:this.get_state().query});if(this.scoped_search){ew=dU("Results for '%(query)s' in '%(path)s'").format({query:this.get_state().query,path:an.filename(this.last_fq_path+"'")})}}bf("#web-search-results").text(ew);if(this.sparky_search_ui_enabled&&this.scoped_search){return bf("#fulltext-search-all-link").show()}},show_advanced:function(){$("browse").addClassName("advanced-search");$("browse-search").hide();$("advanced-search-link").__date(dU("Basic search"));$("advanced-search-box").show();return $("all_terms").focus()},show_basic:function(T){$("browse").removeClassName("advanced-search");$("advanced-search-box").hide();$("advanced-search-link").__date(dU("Advanced search"));if($("browse-search")){$("browse-search").show();if(!T){return $("browse-search-input").focus()}}},toggle_advanced:function(){var T,ev;ev=$("advanced-search-link");ev.toggleClassName("selected");if(ev.hasClassName("selected")){bf("#all_terms").val(this.get_basic_query());return this.show_advanced()}else{T=bf("#all_terms").val();if(T){this.set_basic_query(T);return this.show_basic()}else{return this.exit_search()}}},history_change_handler:function(T,ev){var ew;if(this.fulltext_search_enabled&&(ev!=null)){this.last_state=ev;this.last_state.is_advanced=false}if(!this.last_state){aN.set_path_url(Constants.root_ns,"");return}if(this.state_changed()){this.set_state(this.last_state)}key.setScope(b2.KEY_SCOPE);if(ee.get_selected_files().length){ew=ee.get_selected_files()[0].get_div();return b2.scrollToWithPadding(ew,ew.getHeight()*2)}},clear_searchbox:function(){return this._get_browse_search_input().val("")},_get_browse_search_input:function(){if(this.fulltext_search_enabled){return bf("#browse-search-input input")}else{return bf("#browse-search-input")}}};var dK;dK=A.BrowseKeys={_handlers:{},init:function(){},init_advanced:function(){var ew,T,ev;ev=this.advanced_dict;for(T in ev){ew=ev[T];key(ew.key,b2.KEY_SCOPE,ew.onPress)}this.customize_chart();if(ds.is_mac()&&Prototype.Browser.Gecko){return document.observe("keypress",(function(ex){return function(ey){if(ey.charCode===63&&!y.focus_in_input()){return ex.advanced_dict.help.onPress()}}})(this))}},customize_chart:function(){var ex,ev,ew,T;ex=(ds.is_mac()?".key-windows":".key-macos");ew=0;ev=void 0;T=[];while(true){ev=$("keys-chart").down(ex,ew++);if(!ev){break}T.push(ev.hide())}return T},toggle_chart:function(){if($("keys-chart").style.display==="none"){return this.show_chart()}else{return this.hide_chart()}},show_chart:function(){var T,ev;T=$("keys-chart");T.style.position="fixed";ev=$("browse-sort");if(bJ.fulltext_search_enabled&&b2.in_search_mode()){ev=$("browse-header-wrapper")}else{if(ev.getStyle("display")==="none"){ev=$("browse-root-actions")}}bf(T).clonePosition(bf(ev),{setHeight:false});T.style.top=ev.cumulativeOffset()[1]+ev.getHeight()+"px";T.setOpacity(0.9);return T.show()},hide_chart:function(){return $("keys-chart").hide()},advanced_dict:{rename:{title:dU("Rename selected files",{comment:"'selected' means files that have been highlighted by the user to be acted upon"}),key:"f2",onPress:function(ev,ew){var T;T=ee.get_selected_files();if(T.length){return T.first().edit()}}},"delete":{title:dU("Delete selected files",{comment:"'selected' means files that have been highlighted by the user to be acted upon"}),key:"delete, command+backspace, backspace",onPress:function(ex,ey){var T,ew,ev;Event.stop(ex);if(b2.inside_read_only_shared_folder){Y.warning(dU("You don't have permission to delete files in this folder."))}ev=ee.get_selected_files();if(ev.length===1){T=ev.first();if(T.is_deleted){return c0.show_purge(T.fq_path,T.dir)}else{return c0.show_delete(b2.active_user,T.fq_path,T.dir)}}else{if(ev.length>1){ew=aO.profile_files(ev);if(ew.deleted===ev.length){return c0.show_bulk_purge(ev)}else{if(ew.deleted===0){return c0.show_bulk_delete(b2.active_user,ev)}}}}}},help:{title:dU("Show/hide keyboard shorcuts"),key:"shift+/, "+(key.main_modifier())+"+/",onPress:function(){return dK.toggle_chart()}},close_help:{title:dU("Hide keyboard shorcuts"),key:"escape",onPress:function(){return dK.hide_chart()}},up_dir:{title:dU("Up a folder",{comment:"meaning, go from the current folder to its containing (parent) folder. this is one step up only -- the parent, not the root."}),key:"left",onPress:function(){var T,ev;b2.keyboard_nav=true;if(!b2.reloading){if(b2.inside_dir){if(!b2.containing_ns_path()&&b2.containing_ns_id()!==Constants.root_ns){ev=Constants.root_ns;T=an.normalize(an.parent_dir(b2.containing_fq_path()))}else{ev=b2.containing_ns_id();T=an.normalize(an.parent_dir(b2.containing_ns_path()))}if(b2.containing_ns_path()!==T||b2.containing_ns_id()!==ev){b2.select_fq_paths=[b2.containing_fq_path()];return aN.set_path_url(ev,T)}else{return ee.flicker_selected()}}else{return ee.flicker_selected()}}}},open_file:{title:dU("Open highlighted file"),key:"enter",onPress:function(){var T,ev;ev=ee.get_selected_files();if(ev.length===1){T=ev[0];b2.open_file(T,false)}return false}},open_dir:{title:dU("Open highlighted folder"),key:"right",onPress:function(){var T,ev;b2.keyboard_nav=true;ev=ee.get_selected_files();if(ev.length===1){T=ev[0];if(T.dir){b2.select_index=0;b2.open_folder(T)}else{ee.flicker_selected()}}return false}},undo:{title:dU("Undo recent move/copy/rename/delete"),key:""+(key.main_modifier())+"+z",onPress:function(){Q.perform_undo();return false}},search:{title:dU("Search"),key:"/",onPress:function(){var ev,T;if((ev=__CIRCULAR_DEPENDENCY__.SearchBar)!=null){if((T=ev.getInstancesWithHolderClass("top-search-bar")[0])!=null){T.focus()}}return false}}}};var aa;aa=A.BrowseSharedLink={store_shared_link_info:function(ew,T,ev){if(ew.charAt(0)==="/"){ew=ew.substring(1)}this._shared_link_fq_dir=ew;this._shared_link_file=ev;return this._shared_link_url=T},shared_link_handler:function(T,ev){if(aa._shared_link_url==="/s/"+T){aN.load_browse_view(void 0,encodeURIComponent(aa._shared_link_fq_dir));b2.open_preview(aa._shared_link_file)}else{if(aa._shared_link_url==="/sh/"+T){aN.load_browse_view(void 0,encodeURIComponent(aa._shared_link_fq_dir));if(aa._shared_link_file){b2.open_preview(aa._shared_link_file)}else{ax.init([],{include_delete:true,keep_url:true,filename_in_url:true,enable_sublinks:true,share_button_experiment_variant:b2.lightbox_share_button_experiment_variant})}}else{location.reload()}}return aa.highlight_user()},close_shared_link_view:function(){if(window.location.pathname===this._shared_link_url){return aN.set_path_url(null,"/"+this._shared_link_fq_dir)}},highlight_user:function(){if(b2.active_user.role===Constants.ROLE_WORK){bf("#work-nav-item").addClass("selected");return bf("#personal-nav-item").removeClass("selected")}else{bf("#personal-nav-item").addClass("selected");return bf("#work-nav-item").removeClass("selected")}}};var aN;aN=A.BrowseURL={_DEFAULTS:{d:false,select:false,open_preview:false},_get_helper:function(T){var ev;ev=dX.deconstruct_url().qargs;if(T in ev){return !!ev[T]}else{ci(T in this._DEFAULTS,"bad query param in BrowseURL");return this._DEFAULTS[T]}},get_del:function(){return this._get_helper("d")},ns_to_fq_path:function(T,ew){var ev;if(T!==b2.active_user.root_ns&&(!(T in b2.ns_id_to_mount_point))){T=b2.active_user.root_ns}if(T===b2.active_user.root_ns){return ew}else{ev=b2.ns_id_to_mount_point[T];return ev+ew}},_make_url:function(T,ez,eA){var eB,ey,ev,ex,ew;if(eA==null){eA={}}if(!T){T=b2.active_user.root_ns}ci(typeof T==="number","expected ns_id as a number");ci(typeof ez==="string","expected explicit ns_path string");eB=this.ns_to_fq_path(T,ez);ex=C({path:eu.get_browse_root(b2.active_user)+eB});ev=dX.deconstruct_url().qargs;for(ey in eA){ew=eA[ey];if(ey in this._DEFAULTS&&!!ew!==this._DEFAULTS[ey]){ev[ey]=ew}}for(ey in ev){if(!(ey in this._DEFAULTS)){delete ev[ey]}}return dX.construct_url(String(ex),ev)},set_path_url:function(T,ez,ex){var ey,ew,ev;if(!T){T=b2.active_user.root_ns}else{ew=parseInt(T,10);T=!isNaN(ew)?ew:Constants.root_ns}ez=an.normalize(ez);ev=ex!=null?this._make_url(T,ez,{d:ex?1:0}):this._make_url(T,ez);ey=dX.deconstruct_url(ev);return dX.push_state(ey.path,ey.qargs)},set_del_url:function(T){var ew,ex,ev;ev=dX.deconstruct_url();ew=ev.path;ex=ev.qargs;if(T){ex.d="1"}else{delete ex.d}return dX.push_state(ew,ex)},_first_load:true,_last_ns_dir:null,_last_ns_id:null,load_browse_view:function(T,ex,ev){var ey,ez,ew;if(ev==null){ev=false}key.setScope(b2.KEY_SCOPE);ex=an.normalize(ex);ew=false;if(!this._first_load){ew=(!b2.inside_dir)||(ex!==this._last_ns_dir)||(T!==this._last_ns_id)||(b2.in_search_mode()&&bJ.fulltext_search_enabled)}ey=ev!==b2.deleted_shown;b2.deleted_shown=ev;if(this._first_load||ew||ey){b2.reload(T,ex,true)}bJ.show_basic(true);this._first_load=false;this._last_ns_dir=ex;this._last_ns_id=T;if(ee.get_selected_files().length){ez=ee.get_selected_files()[0].get_div();if(ez){return b2.scrollToWithPadding(ez,ez.getHeight()*2)}}},history_change_handler:function(ez,eA){var ew,ey,T,ev,ex;if(b2.growth_browse_experiment_rule==="sharing-on-browse-experiment"&&((ex=b2.growth_browse_experiment_variant)==="INLINE_SHARE"||ex==="BOTH")){b2.reset_browse_exp()}T=eA.ns;ev=eA.d==="1";this.load_browse_view(T,ez,ev);if(eA.preview!=null){ey="/"+C.encode(eA.preview);if(!!ez){ey="/"+ez+ey}ew=b2.find_file(C.decode(ey));if(ew!=null){return b2.open_preview(ew)}else{return dX.replace_state(eu.get_browse_root(b2.active_user))}}else{if(l.shown()){return l.hide()}}},parse_b2_hash:function(ey){var ew,ev,ex,T,ez;T=ey.split(":");if(T.length!==4){return false}ex=T[0];ew=T[2]==="1";ev=T[3];ez=!ev||ds.isNumber(ev);if(!ez){return false}ev=parseInt(ev,10)||Constants.root_ns;return{ns_id:ev,ns_path:ex,deleted:ew}}};var co;co=A.BrowseFile=Class.create({initialize:function(ew){var ey,ev,ex,T,ez;ey=b2.inside_dir?cN:bV;ev=an.filename(ew.fq_path);this.icon=ew.icon;this.filename=ev;this.filename_highlights=(ex=ew.filename_highlights)!=null?ex:[];this.caption=bt.em_snippet(ev,ey);this.ns_id=ew.ns_id;this.ns_path=ew.ns_path;this.fq_path=ew.fq_path;this.mount_point=ew.mount_point;this.hash=ew.hash;this.href=ew.href;this.size=ew.size!=="None"?ew.size:"";this.bytes=ew.bytes;this.is_deleted=this.bytes===-1;this.ago=ew.ago;this.ts=ew.ts;this.dir=ew.is_dir?1:0;this.target_ns=ew.target_ns;this.sort_rank=ew.sort_rank||0;this.sort_key=ew.sort_key||[""];this.sjid=ew.sjid;this.tkey=void 0;this.thumbnail_url_tmpl=ew.thumbnail_url_tmpl;this.large_thumbnail_url_tmpl=ew.large_thumbnail_url_tmpl;this.type=ew.type;this.preview_type=ew.preview_type;if(ew.last_modified_fname){this.last_modified_fname=bt.em_snippet(ew.last_modified_fname,cq)}this.htmlified_link=ew.htmlified_link;this.doc_preview_status=ew.doc_preview_status;this.in_root_coll=ew.in_root_coll;this.user_id=ew.user_id;this.fulltext_search=ew.fulltext_search;this.read_only=ew.read_only?true:false;this.is_read_only_mount=ew.is_read_only_mount?true:false;this.request_id=(T=ew.request_id)!=null?T:null;return this.match_type=(ez=ew.match_type)!=null?ez:"UNKNOWN_MATCH"},track_in_browse:function(){if(!(this.to_key() in co._file_index)){b2.add_file(this);return co._file_index[this.to_key()]=this}},is_shared_folder:function(){return this.type===bH.SHARED_FOLDER},could_be_shared_folder:function(){var ew,ex,T,ev;ex=b2.public_folder_enabled&&this.fq_path.toLowerCase().startsWith("/public/");ev=b2.public_folder_enabled&&this.fq_path.toLowerCase()==="/public";T=this.target_ns;ew=this.ns_id!==Constants.root_ns;return this.type===bH.FOLDER&&!(ew||T||ex||ev)},is_shared_single_file:function(){var T;T=this.ns_id!==Constants.root_ns;return this.type===bH.FILE&&T},could_be_shared_single_file:function(){var ev,ew,T;ew=b2.public_folder_enabled&&this.fq_path.toLowerCase().startsWith("/public/");T=b2.public_folder_enabled&&this.fq_path.toLowerCase()==="/public";ev=this.ns_id!==Constants.root_ns;return this.type===bH.FILE&&!(ev||ew||T)},is_sandbox:function(){return this.type===bH.SANDBOX},video_transcode_url:function(){var T;ci(this.fq_path,"video_transcode_url: expected a non-root fq_path");if(Constants.transcoder_hls4web){T=C({path:"/playlist"+this.fq_path})}else{T=C({scheme:"https",authority:Constants.LIVE_TRANSCODE_SERVER,path:"/transcode_video/w/"+(this.hash+this.fq_path)})}return T.updateQuery(Constants.UID_PARAM_NAME,b2.active_user.id).toString()},get_div:function(){return $("f_"+(this.to_key()))},rename:function(ez,eB,ex,ey,eA,eC){var ev,eD,T,ew;ev=b2.inside_dir?cN:bV;T=this.fq_path;b2.pre_action_selection=[T];eD=b2.find_file(ez);if(eD){b2.remove_file(eD)}this.filename=an.filename(ez);this.caption=bt.em_snippet(this.filename,ev);this.fq_path=ez;this.ns_path=eB;this.htmlified_link=eC;this.hash=ex;this.sort_key=ey;this.sort_rank=null;this.last_modified_fname=null;if(!this.dir){ew=this.href.split("/");ew[ew.length-1]=ds.urlquote(this.filename)+("?w="+ex);this.href=ew.join("/");this.icon=eA}else{this.href="/home"+ds.urlquote(ez);if(this.target_ns){b2.ns_id_to_mount_point[this.target_ns]=ez}}if(b2.in_search_mode()&&bJ.fulltext_search_enabled){this.filename_highlights=[]}co._file_index[this.to_key()]=this;b2.update_file_pos(this);return document.fire(av.RENAME,{old_fq_path:T,file:this})},edit:function(){var ew,T,ex,ev,ey;this.editing=true;b2.selectable();ey=(function(ez){return function(eH){var eB,eA,eE,eJ,eG,eD,eK,eI,eF,eC;eC=eH.responseText.evalJSON(true);ci(eC.new_browse_files.length===1,"No new file data returned.");eE=eC.new_browse_files.first();eJ=eE.fq_path;eG=eE.hash;eF=ds.decode_sort_key(eE.sort_key);eK=eE.icon;eI=eE.ns_path;eD=eE.htmlified_link;eB=eC.changesets;eA=dU("Rename complete.");Q.notifyWithUndo(eA,eB,c0.do_rollback);ez.rename(eJ,eI,eG,eF,eK,eD);ee.set_selected_files([ez]);ez.get_div().smoothScrollIntoView();aO.load_visible_thumbs();return b2.fire_visible_change_callbacks()}})(this);T=C({path:"/cmd/rename"+this.fq_path}).updateQuery(Constants.UID_PARAM_NAME,b2.active_user).toString();ex=bJ.fulltext_search_enabled&&b2.in_search_mode()?".filename-col":".filename-col a";ew=new Ajax.InPlaceEditor(this.get_div().down(ex),T,{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.filename,cancelIfSame:true,clickToEdit:false,onComplete:(function(ez){return function(){return ez.editing=false}})(this),onFailure:function(){},savingText:dU("Saving..."),ajaxOptions:{job:true,subject_user:b2.active_user,html_in_error_msg:true,progress_text:dU("Renaming..."),method:"POST",onCreate:Y.clear,onSuccess:ey,onUninitialized:b2.unselectable},callback:(function(ez){return function(eA,eB){return{to_path:eB||"",folder:(ez.dir?"yes":"")}}})(this)});ew.enterEditMode();ev=this.get_div().down(".editor_field");if("selectionEnd" in ev&&this.filename.lastIndexOf(".")>-1){return ev.selectionEnd=this.filename.lastIndexOf(".")}},to_key:function(){return""+this.ns_id+"_"+this.sjid},get_category:function(){var ev,T;if(this.dir){if(b2.inside_dir&&b2.containing_fq_path()===""){if(this.filename.toLowerCase()==="public"&&b2.public_folder_enabled){ev="PUBLIC_FOLDER"}}if(ev==null){if(this.type===bH.FOLDER){ev="FOLDER"}else{if(this.type===bH.PACKAGE){ev="FOLDER"}else{if(this.type===bH.SHARED_FOLDER){ev="SHARED_FOLDER"}else{if(this.type===bH.SANDBOX){ev="SANDBOX"}else{if(this.target_ns){ev="SHARED_FOLDER"}else{ev="FOLDER"}}}}}}}if(ev==null){ev=co.EXTENSION_TO_CATEGORY[this.get_extension()]||"FILE"}T=this.is_deleted?co.CATEGORY_TO_DELETED_TRANSLATION[ev]:co.CATEGORY_TO_TRANSLATION[ev];ci(T,"CATEGORY MISSING FOR "+ev);return T},get_extension:function(){if(this.dir||this.filename.indexOf(".")===-1){return}return an.file_extension(this.filename).toLowerCase()},is_shmodelable:function(){return !this.is_deleted&&b2.is_shmodelable_path(this.fq_path)}});co._CATEGORIES={IMAGE:"ai bmp cr2 eps gif ico jpeg jpg nef png psd tif tiff svg svgz",VIDEO:"3gp 3gpp 3gpp2 avi dv flv m2t m4v mkv mov mp4 mpeg mpg mts ts vob wmv",AUDIO:"aif flac m4a m4p mp3 ogg wav wma",DOCUMENT:"cdr csv doc docx docm fla indd keynote numbers otf pages pdf ppt pptx pptm pps ppsx ppsm ps rtf swf txt wpd xls xlsx xlsm",COMPRESSED_FILE:"7z bz2 gz gzip rar tar zip",CODE:"as as3 c coffee cpp cs css cxx h html html java js less php py rb sass scss sh sql vb xhtml xml",DISK_IMAGE:"dmg iso",EXECUTABLE:"exe",SHORTCUT:"lnk",LINK:"url webloc",FONT:"ttf"};co.EXTENSION_TO_CATEGORY={};co.CATEGORY_TO_TRANSLATION={FILE:dU("file"),FOLDER:dU("folder"),SHARED_FOLDER:dU("shared folder"),PUBLIC_FOLDER:dU("folder"),IMAGE:dU("image"),VIDEO:dU("video"),AUDIO:dU("audio"),DOCUMENT:dU("document"),COMPRESSED_FILE:dU("archive"),CODE:dU("code"),DISK_IMAGE:dU("disk image"),EXECUTABLE:dU("executable"),SHORTCUT:dU("shortcut"),LINK:dU("link"),FONT:dU("font"),SANDBOX:dU("app folder")};co.CATEGORY_TO_DELETED_TRANSLATION={FILE:dU("deleted file"),FOLDER:dU("deleted folder"),SHARED_FOLDER:dU("deleted shared folder"),PUBLIC_FOLDER:dU("deleted folder"),IMAGE:dU("deleted image"),VIDEO:dU("deleted video"),AUDIO:dU("deleted audio"),DOCUMENT:dU("deleted document"),COMPRESSED_FILE:dU("deleted archive"),CODE:dU("deleted code"),DISK_IMAGE:dU("deleted disk image"),EXECUTABLE:dU("deleted executable"),SHORTCUT:dU("deleted shortcut"),LINK:dU("deleted link"),FONT:dU("deleted font"),SANDBOX:dU("deleted app folder")};(function(){var ew,ey,ev,ex,T;ex=co._CATEGORIES;T=[];for(ew in ex){ev=ex[ew];T.push((function(){var eC,eA,ez,eB;ez=ev.trim().split(" ");eB=[];for(eC=0,eA=ez.length;eC<eA;eC++){ey=ez[eC];eB.push(co.EXTENSION_TO_CATEGORY[ey]=ew)}return eB})())}return T})();co._file_index={};co.from_key=function(T){return co._file_index[T]};co.from_elem=function(ev){var T;if(!ev){return}T=ev.readAttribute("data-identity");if(T){return co.from_key(T)}else{return co.from_elem(ev.up("[data-identity]"))}};var a,dZ,ab,en,bn,c4;a=INLINE_JS.BrowseActions=A.BrowseActions=Class.create({initialize:function(T){return this._set_files(T)},firefly_logging_helper:function(T){if(b2.in_search_mode()&&T){this._firefly_log_values.action_type=T;return aQ.SearchClientActivityLogger.log("result_action",b2.active_user.id,this._firefly_log_values)}},unlisten:function(){},get_action_names:function(){var T;T=this.get_files();if(T.length<2){return this._get_actions_single(T.first())}else{return this._get_actions_multi(T)}},get_files:function(){return this._files},get_action_by_name:function(T){return this.evaluate_action(a.option_dict[T],T)},evaluate_action:function(ew,ev){var ex,ey,T;ex=(function(ez){return function(eB,eA){if((eA!=null)&&(eB==null)){return eA}if(bf.isFunction(eB)){return eB.call(ez)}else{if(eB!=null){return eB}else{return eA}}}})(this);T={icon_href:ew.icon_href,target:ew.target,click_handler:ew.click_handler,type:ew.type,name:ev||ew.name,is_dropdown:!!ew.is_dropdown,icon:ex(ew.icon),text:ex(ew.text),detail_text:ex(ew.detail_text),href:ex(ew.href,""),kind:ex(ew.kind,"icon"),button_label:ex(ew.button_label,ew.text)};if(bf.isFunction(ew.subactions)){T.subactions=ew.subactions.call(this)}else{if(bf.isArray(ew.subactions)){T.subactions=(function(){var eC,eA,eB,ez;eB=ew.subactions;ez=[];for(eC=0,eA=eB.length;eC<eA;eC++){ey=eB[eC];ez.push(this.get_action_by_name(ey))}return ez}).call(this)}else{if(ew.subactions){ci(0,"subactions must be a function or an array of actions")}}}return T},_set_files:function(ev){var T;this._files=$A(ev);this._log_extras={};if(this.get_files().length>0){T=ev.first();this._log_extras={path:T.fq_path,ns_id:T.ns_id};return this._firefly_log_values={file_nsid:T.ns_id,file_sjid:T.sjid,firefly:bJ.fulltext_search_enabled,match_type:T.match_type,position:T.sort_rank,request_id:T.request_id,viewport:"full-view"}}},_get_actions_single:function(eK){var eA,eD,eE,eH,ew,ex,eM,eB,eG,ey,ez,eI,eJ,eF,T,eL,eC,ev;eD=[];if(!eK){return[]}eH=b2.public_folder_enabled&&eK.fq_path.toLowerCase().startsWith("/public/");eG=b2.public_folder_enabled&&eK.fq_path.toLowerCase()==="/public";eM=eK.target_ns;eE=eK.ns_id!==Constants.root_ns;ez=eK.type===bH.SHARED_FOLDER;ey=eK.type===bH.SANDBOX;eB=eK.type===bH.PACKAGE;ex=eK.in_root_coll;if(eK.is_deleted){eD=eD.concat(["restore"]);eD.push("purge");if(!eK.dir){eD.push("revisions")}}else{eF=(__CONDITIONAL_JS__.UnityFeatures!=null)&&((eC=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?eC.get(eK.ns_id,eK.ns_path):void 0);eI=eF?"open":"download";if(eK.dir){if(ey){eD.push("app_info")}else{if(b2.simple_sharing_enabled){eD.push("share_folder_and_token")}else{if(ez){eD.push("sharing_options")}else{if(!(eE||eM||eH||eG)){eD.push("share")}}}}if(eK.is_shmodelable()&&!b2.simple_sharing_enabled){eD.push("token_share")}eD.push(eI);if(!eG){eD=eD.concat(["delete","rename","move"]);if(!(eB||eM)){eD.push("copy")}}if(b2.can_use_photos_features){if(b2.can_use_photos_features){eD.push("album_from_folder")}}}else{if(eK.is_shmodelable()){eD.push("token_share")}if(eH||b2.public_app_token){eD.push("copy_url")}eD.push(eI);eD=eD.concat(["delete","rename","move","copy","revisions"]);if(ex&&b2.can_use_photos_features){eD.push("view_in_photos")}}if(b2.sharing_growth_experiments_variant&&b2.sharing_growth_experiments_variant==="DROPDOWN"&&!b2.simple_sharing_enabled){eJ=false;ev=["sharing_options","share","token_share"];for(T=0,eL=ev.length;T<eL;T++){eA=ev[T];ew=eD.indexOf(eA);if(ew>-1){eD.splice(ew,1);eJ=true}}if(eK.is_shared_folder()||eK.could_be_shared_folder()){eD.unshift("single_entry_share_dropdown_variant_menu")}else{eD.unshift("single_entry_share_dropdown_variant_token_share_only")}}}return eD},_get_actions_multi:function(ew){var T,ev,ex;if(Constants.send_a_copy_enabled){T=["send_copy","download"]}else{T=["download"]}T=T.concat(["delete","move","copy","restore","purge","view_in_photos"]);ev=aO.profile_files(ew);if(ev.deleted>0||ev.public_folder>0){T.removeItem("move");T.removeItem("copy");T.removeItem("delete")}if(ev.shared_folders>0){T.removeItem("copy")}if(ev.deleted>0){T.removeItem("send_copy");T.removeItem("delete");T.removeItem("download")}if(!b2.inside_dir){T.removeItem("download")}if(!(ev.deleted===ew.length&&(ev.shared_folders===0||((ev.shared_folders===(ex=ew.length)&&ex===1))))){T.removeItem("restore");if(ev.deleted!==ew.length){T.removeItem("purge")}}if(ev.in_root_coll!==ew.length||!b2.can_use_photos_features){T.removeItem("view_in_photos")}return T},_show_appropriate_sharing_modals:function(ev,T){var ew;if(ev.is_shared_folder()){aQ.ShmodelUILogger.log_with_target_file("sf_options",T,ev);return p.show_shared_folder_options_modal(ev.fq_path,b2.active_user)}else{if(ev.could_be_shared_folder()){aQ.ShmodelUILogger.log_with_target_file("sf_invite",T,ev);return p.show_share_existing_modal(ev.fq_path,b2.active_user)}else{aQ.ShmodelUILogger.log_with_target_file("token_share",T,ev);ew=ev.fq_path;ci(ew,"token_share: expected non-root fq_path");return cV.shmodel(ew,T+"_token_share")}}},get_disabled_action_names:function(){var T,ew,ey,ev,ex;T=false;ex=this.get_files();for(ey=0,ev=ex.length;ey<ev;ey++){ew=ex[ey];T=true;if(!ew.read_only){T=false;break}}if(b2.inside_read_only_shared_folder||T){return["move","rename","delete","restore","purge","upload","new_folder"]}else{return[]}},show_disabled_action_warning:function(T){if(b2.inside_read_only_shared_folder){if(T==="move"){return Y.warning(dU("You don't have permission to move files in this folder."))}else{if(T==="rename"){return Y.warning(dU("You don't have permission to rename files in this folder."))}else{if(T==="delete"){return Y.warning(dU("You don't have permission to delete files in this folder."))}else{if(T==="restore"){return Y.warning(dU("You don't have permission to restore files in this folder."))}else{if(T==="purge"){return Y.warning(dU("You don't have permission to permanently delete files in this folder."))}else{if(T==="upload"){return Y.warning(dU("You don't have permission to upload files into this folder."))}else{if(T==="new_folder"){return Y.warning(dU("You don't have permission to create a new folder in this folder."))}else{return Y.warning(dU("You only have permission to view this folder."))}}}}}}}}else{return Y.warning(dU("You do not have permission to perform the requested action."))}}});Object.extend(a,{PUBLIC_FOLDER_PATH_LENGTH:7,showCopyPublicUrlModal:function(ev){var T,ew;ep.show(aO.append_ellipsis(dU("Copy public link")),cS.fromElm("copy-public-url"),{wit_group:"copy_public_link"});ep.onHide=function(){$("flash_copy_container").remove();delete ep.onHide;return ep.hide()};T=q.clipboard_overlay(ev,bf("#real_copy"),function(){Y.success(dU("Link copied to clipboard!"));return ep.hide()});T.css({zIndex:1001});ew=$("modal-content").down("#public_url");ci(ew,"Text element not found for copy pulic link");ew.setValue(ev);return ew.select()},shortenPublicLink:function(){var T;ds.shorten_url($F("public_url"),a.updatePublicLink);T=new Element("img",{id:"publink_loading",src:"/static/images/icons/ajax-loading-small.gif",className:"right"});return $("modal-content").down("a").__date(T)},updatePublicLink:function(ev){var T;$("public_url").setValue(ev);$("public_url").select();$("publink_loading").remove();$("flash_copy_container").remove();T=q.clipboard_overlay(ev,bf("#real_copy"),function(){Y.success(dU("Link copied to clipboard!"));return ep.hide()});return T.css({zIndex:1001})},option_dict:{new_folder:{icon:"folder_add",text:dU("New folder"),click_handler:function(T){return b2.new_folder()}},global_restore:{icon:"restore",text:function(){ci(b2.inside_deleted_dir,"Global restore from not a deleted dir");if(b2.inside_deleted_shared_folder){return aO.append_ellipsis(dU("Rejoin shared folder"))}else{if(b2.inside_deleted_sandbox){return dU("Restore app folder")}else{return dU("Restore folder")}}},click_handler:function(){var ex,ey,ev,T,ew;ex=b2.containing_fq_path();ev=ex.toLowerCase();if(b2.inside_deleted_sandbox){ci(b2.old_path_to_ns_id[ev],"Deleted sandbox missing nsid");return aV.restore_sandbox(b2.active_user,ex,b2.old_path_to_ns_id[ev])}else{if(b2.inside_deleted_shared_folder){ci(b2.old_path_to_ns_id[ev],"Deleted shared folder missing nsid");return p.show_rejoin_modal(b2.active_user,ex,b2.old_path_to_ns_id[ev])}else{ey=C.parse(location.href).setFragment("").toString();T={prev:ey};T[Constants.UID_PARAM_NAME]=b2.active_user;ew=C({path:"/restore"+ex}).updateQuery(T);return window.location.href=String(ew)}}}},restore:{icon:"restore",text:function(){var ev,T;ev=this.get_files();T=aO.profile_files(ev);if(T.shared_folders===ev.length){return aO.append_ellipsis(aR("Rejoin shared folder","Rejoin shared folders",ev.length,{comment:"BUTTON"}))}else{return aO.append_ellipsis(dU("Restore",{comment:"Restore a previously-deleted file"}))}},click_handler:function(){var ew,ez,ev,eA,ey,T,ex;ez=this.get_files();if(ez.length===0){}else{if(ez.length===1){ew=ez.first();if(!ew.is_deleted){return}eA=ew.fq_path;ev=eA.toLowerCase();if(ew.type===bH.SANDBOX){ci(b2.old_path_to_ns_id[ev],"Restore missing ns");aV.restore_sandbox(b2.active_user,eA,b2.old_path_to_ns_id[ev])}else{if(ew.type===bH.SHARED_FOLDER){ci(b2.old_path_to_ns_id[ev],"Rejoin missing ns");p.show_rejoin_modal(b2.active_user,eA,b2.old_path_to_ns_id[ev])}else{if(ew.dir){ey=C.parse(location.href).updateQuery({select:ew.filename});T={prev:String(ey)};T[Constants.UID_PARAM_NAME]=b2.active_user;ex=C({path:"/restore"+ew.fq_path}).updateQuery(T);window.location=String(ex)}else{c0.show_undelete(ew)}}}}else{return c0.show_bulk_restore(ez,b2.active_user)}}}},global_share:{icon:function(){return aO.get_shared_folder_icon()},text:function(){if(b2.inside_shared_folder){return aO.append_ellipsis(dU("Shared folder options",{comment:"BUTTON. please keep this as short as possible."}))}else{if(b2.containing_fq_path()===""){return aO.append_ellipsis(dU("Share a folder",{comment:"BUTTON. this initiates a wizard that lets the user select a folder to share."}))}else{return aO.append_ellipsis(dU("Share this folder",{comment:"BUTTON. this button lets the user share the current folder that they're viewing."}))}}},click_handler:function(T){T.preventDefault();if(b2.containing_fq_path()===""){return p.start_wizard_for_user(b2.active_user)}else{if(b2.inside_shared_folder){return p.show_shared_folder_options_modal(b2.containing_mount_point(),b2.active_user)}else{return p.show_share_existing_modal(b2.containing_fq_path(),b2.active_user)}}}},global_share_button:{icon:"rainbow_16",kind:"button",button_label:dU("Share"),text:function(){return aO.append_ellipsis(dU("Share a folder"))},click_handler:function(ev,T){ev.preventDefault();if(b2.containing_fq_path()===""){return p.start_wizard_for_user(b2.active_user)}else{if(b2.is_in_subfolder_of_shared_folder()){aQ.ShmodelUILogger.log("via-single-entry-sharing-button");return cV.shmodel(b2.containing_fq_path(),T+"_global_share_button")}else{return p.show_shmodel_or_invite_modal(b2.containing_fq_path(),b2.inside_shared_folder,b2.active_user)}}}},sharing_options:{icon:function(){return aO.get_shared_folder_icon()},text:aO.append_ellipsis(dU("Shared folder options",{comment:"BUTTON"})),click_handler:function(ew,T){var ev;ev=this.get_files().first();aQ.ShmodelUILogger.log_with_target_file("sf_options",T,ev);return p.show_shared_folder_options_modal(ev.fq_path,b2.active_user)}},share:{icon:function(){return aO.get_shared_folder_icon()},text:aO.append_ellipsis(dU("Invite to folder",{comment:"BUTTON"})),click_handler:function(ew,T){var ev;ev=this.get_files().first();aQ.ShmodelUILogger.log_with_target_file("sf_invite",T,ev);return p.show_share_existing_modal(ev.fq_path,b2.active_user)}},share_folder_and_token:{icon:function(){return aO.get_shared_folder_icon()},text:dU("Share",{comment:"BUTTON"}),click_handler:function(ew,T){var ev;ev=this.get_files().first();return this._show_appropriate_sharing_modals(ev,T)}},revisions:{icon:"s_clock",click_handler:function(){return window.location.href=c0.build_revisions_uri(this.get_files().first().fq_path,b2.active_user)},text:dU("Previous versions",{comment:"BUTTON"})},token_share:{icon:function(){return aO.get_shared_link_icon()},text:aO.append_ellipsis(dU("Share link",{comment:"BUTTON"})),click_handler:function(ex,T){var ev,ew;ev=this.get_files().first();aQ.ShmodelUILogger.log_with_target_file("token_share",T,ev);ew=ev.fq_path;ci(ew,"token_share: expected non-root fq_path");return cV.shmodel(ew,T+"_token_share")}},global_token_share:{icon:function(){return aO.get_shared_link_icon()},text:aO.append_ellipsis(dU("Share link",{comment:"BUTTON"})),click_handler:function(ev,T){aQ.ShmodelUILogger.log("via-global-toolbar");return cV.shmodel(b2.containing_fq_path(),T+"_global_token_share")}},copy_url:{icon:"world_link",text:aO.append_ellipsis(dU("Copy public link",{comment:"BUTTON"})),click_handler:function(ew){var ev,T;ev=this.get_files().first();if(b2.public_app_token){T="/spa/"+b2.public_app_token+ev.ns_path}else{T="/u/"+b2.active_user.id+ev.fq_path.substring(a.PUBLIC_FOLDER_PATH_LENGTH)}return a.showCopyPublicUrlModal(String(new C({scheme:"https",authority:Constants.PUBSERVER,path:T})))}},download:{icon:"download",text:function(){return dU("Download",{comment:"BUTTON"})},click_handler:function(){var ex,ew,T,eA,eC,eB,ey,ev,ez;T=this.get_files();if(T.length===1&&!T[0].dir){ew=T.first();ez=[Constants.protocol,Constants.BLOCK_CLUSTER,ew.fq_path,ew.hash],eB=ez[0],ex=ez[1],eC=ez[2],eA=ez[3];ey={w:eA,dl:1};ev=C({scheme:eB,authority:ex,path:"/get"+eC,query:ey});return window.location=String(ev.updateQuery(Constants.UID_PARAM_NAME,b2.active_user))}else{return c0.do_bulk_download(T)}}},view:{href:function(){var ez,T,ex,ew,ey,ev;T=this.get_files().first();ev=[Constants.protocol,Constants.BLOCK_CLUSTER,ds.urlquote(T.fq_path),T.hash],ey=ev[0],ez=ev[1],ew=ev[2],ex=ev[3];return""+ey+"://"+ez+"/get"+ew+"?w="+ex},icon:"page_white_magnify",text:dU("View file",{comment:"BUTTON"})},ignore:{click_handler:function(){return p.show_ignore_modal(this.get_files().first().fq_path)},icon:"folder_user_delete",text:dU("Permanently remove",{comment:"BUTTON"})},show_del:{click_handler:function(T){return b2.toggle_deleted()},icon:"trash-can",text:dU("Show deleted files",{comment:"BUTTON"})},hide_del:{click_handler:function(T){return b2.toggle_deleted()},icon:"trash-can-open",text:dU("Hide deleted files",{comment:"BUTTON"})},copy:{icon:"copy",text:aO.append_ellipsis(dU("Copy",{comment:"BUTTON"})),click_handler:function(ew){var T,ev;ev=this.get_files();if(ev.length===1){T=ev.first();return c0.show_copy(T.fq_path,T.dir)}else{if(ev.length>1){return c0.show_copy_bulk(ev)}}}},move:{icon:"move_16",text:aO.append_ellipsis(dU("Move",{comment:"BUTTON"})),click_handler:function(ew){var T,ev;ev=this.get_files();if(ev.length===1){T=ev.first();return c0.show_move(T.fq_path,T.dir)}else{if(ev.length>1){return c0.show_move_bulk(ev)}}}},rename:{icon:"rename",text:dU("Rename",{comment:"BUTTON"}),click_handler:function(){return this.get_files().first().edit()}},"delete":{icon:"delete_16",text:aO.append_ellipsis(dU("Delete",{comment:"BUTTON"})),click_handler:function(ew){var T,ev;ev=this.get_files();if(ev.length>1){return c0.show_bulk_delete(b2.active_user,ev)}else{if(ev.length===1){T=ev.first();return c0.show_delete(b2.active_user,T.fq_path,T.dir)}}}},global_purge:{icon:"cancel",text:aO.append_ellipsis(dU("Permanently delete folder")),click_handler:function(){return c0.show_purge(b2.containing_fq_path(),true)}},purge:{icon:"cancel",text:aO.append_ellipsis(dU("Permanently delete",{comment:"BUTTON"})),click_handler:function(ew){var T,ev;ev=this.get_files();if(ev.length===1){T=ev.first();return c0.show_purge(T.fq_path,T.dir)}else{return c0.show_bulk_purge(ev)}}},upload:{icon:"upload_16",text:aO.append_ellipsis(dU("Upload")),click_handler:function(T){return c0.show_upload()}},app_info:{icon:"application_double",text:aO.append_ellipsis(dU("Application info")),click_handler:function(T){return window.location.href="/account/security"}},more_actions:{is_dropdown:true,text:dU("More",{comment:"Show more options"}),click_handler:Prototype.emptyFunction},more_global_actions:{text:dU("More actions"),click_handler:function(){bn.show_secondary();return document.body.observe("click",bn.hide_secondary)}},view_in_photos:{icon:"s_photo",text:function(){return dU("View in Photos")},click_handler:function(){var T;T=this.get_files();return c0.do_bulk_photo_view(T)}},album_from_folder:{icon:"create-album",text:function(){return dU("Create album")},click_handler:function(){var ev,T;ev=this.get_files();T=ev.first();return c0.create_album_from_folder(T.fq_path,T.filename)}},open:{icon:"open",text:function(){return dU("Open")},click_handler:function(){var T;T=this.get_files().first();return __CONDITIONAL_JS__.UnityFeatures.open_file(T.ns_id,T.ns_path,T.user_id,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler)}},single_entry_share_dropdown_variant_token_share_only:{icon:"s_rainbow",text:aO.append_ellipsis(dU("Share")),click_handler:function(ew,T){var ev;ev=this.get_files().first();aQ.ShmodelUILogger.log_with_target_file("single_entry_share_click",T,ev);return cV.shmodel(ev.fq_path,T)}},single_entry_share_dropdown_variant_menu:{icon:"s_rainbow",text:aO.append_ellipsis(dU("Share")),is_dropdown:true,subactions:["single_entry_share_dropdown_variant_menu_invite_option","single_entry_share_dropdown_variant_menu_token_share_option"],click_handler:function(){},hover_handler:function(ew,T){var ev;ev=this.get_files().first();return aQ.ShmodelUILogger.log_with_target_file("single_entry_share_hover",T,ev)}},single_entry_share_dropdown_variant_menu_invite_option:{icon:"user_add",text:aO.append_ellipsis(dU("Invite people to collaborate")),click_handler:function(ez,T){var ew,ex,ey,ev;ew=this.get_files().first();if(ew.is_shared_folder()){if(dq.get_for_user(b2.active_user).verified_or_show()){aQ.ShmodelUILogger.log_with_target_file("sf_options",T,ew);ex=new cH(b2.active_user,ew.fq_path);return ex.show()}}else{ev=b2.verify_email_after_share_experiment_variant;ey=ev&&ev==="VERIFY_LAST";if(ey){aQ.UserActivityLogger.log("web","email_verify_last_experiment_shown")}else{if(ev){aQ.UserActivityLogger.log("web","email_verify_last_experiment_not_shown")}}if(ey||dq.get_for_user(b2.active_user).verified_or_show()){aQ.ShmodelUILogger.log_with_target_file("sf_invite",T,ew);ex=new bY(b2.active_user,{folder_name:ew.fq_path,element_id:"invite-to-new-sf-wizard-modal-"+b2.active_user.id,must_check_verified:ey});return ex.show()}}}},single_entry_share_dropdown_variant_menu_token_share_option:{icon:"s_link",text:aO.append_ellipsis(dU("Send link")),click_handler:function(ew,T){var ev;ev=this.get_files().first();aQ.ShmodelUILogger.log_with_target_file("token_share",T,ev);return cV.shmodel(ev.fq_path,T)}}}});ab=A.BrowseActionsContext=Class.create(a,{initialize:function($super,T){$super(T);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");bf("#context-menu-container").off("mouseenter");$("context-menu-container").on("click",".action button",this._click.bind(this));$("context-menu-container").on("contextmenu",".action button",this._click.bind(this));bf("#context-menu-container").on("mouseover","li.primary",this._over.bind(this));bf("#context-menu-container").on("mouseout","li.primary",this._out.bind(this));return bf("#context-menu-container").on("mouseenter",".action button",this._enter.bind(this))},_click:function(ex,ev){var ew,T;ew=ev.readAttribute("data-value");this.firefly_logging_helper(ew);T=a.option_dict[ew];aQ.BrowseActionsContextMenuLogger.log(this.get_files(),ew);if(!T.is_dropdown||ev.hasAttribute("submenu-index")){a1.hide()}ex.preventDefault();T.click_handler.call(this,ex,"browse_actions_context");if(ew==="sharing_options"){aQ.SharedFolderActivityLogger.log("web","browse_view_options",b2.active_user,this._log_extra,true)}if(ew==="share"){return aQ.SharedFolderActivityLogger.log("web","browse_view_share_existing",b2.active_user,this._log_extras,true)}},_reset_all_submenus:function(){return bf("#context-menu-container .hover").removeClass("hover")},_reset_submenu:function(T){return bf(T).removeClass("hover")},_enter:function(ex){var ew,T,ev;ew=bf(ex.currentTarget).data("value");ci(ew);T=a.option_dict[ew];ci(T,"Action info is missing for "+ew);return(ev=T.hover_handler)!=null?ev.call(this,ex,"browse_actions_context"):void 0},_over:function(T){if(bf(T.currentTarget).children(".secondary").length){clearTimeout(this.timeoutID);this._reset_all_submenus();return bf(T.currentTarget).addClass("hover")}},_out:function(T){if(bf(T.currentTarget).children(".secondary").length){return this.timeoutID=setTimeout((function(ev){return function(){return ev._reset_submenu(T.currentTarget)}})(this),300)}}});dZ=A.BrowseActionsBasic=Class.create(a,{initialize:function($super){var T;T=ee.get_selected_files();$super(T);this._render();return this._listen()},_listen:function(){var T;this.bound_update=this._update.bind(this);this.bound_disable=this._disable.bind(this);this.bound_enable=this._enable.bind(this);this.bound_click=this._click.bind(this);document.observe(ee.UPDATED_EVT,this.bound_update);document.observe(a1.SHOW_EVT,this.bound_disable);document.observe(a1.HIDE_EVT,this.bound_enable);T=$("browse-root-actions");T.stopObserving("click");return T.on("click",".action button",this.bound_click)},unlisten:function(){document.stopObserving(ee.UPDATED_EVT,this.bound_update);document.stopObserving(a1.SHOW_EVT,this.bound_disable);document.stopObserving(a1.HIDE_EVT,this.bound_enable);return $("browse-root-actions").stopObserving("click",this.bound_click)},_update:function(){this._set_files(ee.get_selected_files());return this._render()},_disable:function(){$("browse-root-actions").stopObserving("click");if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").addClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"default"})},_disable_action:function(ew){var ev,T;T="#browse-root-actions #"+ew+"_action_button";ev=bf(T);ev.addClass("disabled");return ev.click((function(ex){return function(ey){ex.show_disabled_action_warning(ew);return false}})(this))},_enable:function(){$("browse-root-actions").stopObserving("click");$("browse-root-actions").on("click",".action button",this._click.bind(this));if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").removeClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"pointer"})},_render:function(){var eV,eO,eQ,eG,eS,eW,eY,eN,eP,eJ,T,eC,eD,eF,eE,eR,eB,eZ,eL,ez,eI,eH,eK,eM,eA,ey,ew,ev,eT,eX,eU,ex;eC=this.get_files();eQ=this.get_action_names();if(b2.sharing_growth_experiments_variant&&b2.sharing_growth_experiments_variant==="DROPDOWN"&&!b2.simple_sharing_enabled){eH=["single_entry_share_dropdown_variant_token_share_only","single_entry_share_dropdown_variant_menu"];for(ey=0,eT=eH.length;ey<eT;ey++){eO=eH[ey];eE=eQ.indexOf(eO);if(eE>-1){eQ.splice(eE,1);break}}}eV=13.5;eP="";eD="";if(eC.length===1){eP=bt.em_snippet(eC[0].filename,eV);if(!eC[0].dir&&eC[0].bytes>=0){eD=eC[0].size}}else{if(1<eC.length){ez=aO.profile_files(eC);eR=[];if(ez.files){eB=aR("%d file","%d files",ez.files).format(ez.files);eR.push(eB)}if(ez.folders){eB=aR("%d folder","%d folders",ez.folders).format(ez.folders);eR.push(eB)}eP=ds.nice_list(eR)}}eW=$("browse-root-actions");eS=eW.getLayout().get("width");eF=eW.getStyle("font-size");ci(eF.endsWith("px"),"Invalid font size "+eF);eF=parseInt(eF,10);eJ=new bt(eP).length*eF;eK=new bt(eD).length*eF;eS-=eJ+eK;eM=[];eI=[];eS-=30;for(ew=0,eX=eQ.length;ew<eX;ew++){eZ=eQ[ew];eO=this.get_action_by_name(eZ);eA=new bt(eO.text).length*eF;eY=eA+16+8+10+9;if(eS>eY){eM.push(eZ)}else{if(eI.length===0){eL=eM.pop();eI.push(eL)}eI.push(eZ)}eS-=eY}if(eI.length){eM.push("more_actions")}eG=(function(){var e2,e0,e1;e1=[];for(e2=0,e0=eM.length;e2<e0;e2++){eZ=eM[e2];e1.push(this.get_action_by_name(eZ))}return e1}).call(this);if(eI.length){eG[eG.length-1].subactions=(function(){var e2,e0,e1;e1=[];for(e2=0,e0=eI.length;e2<e0;e2++){eZ=eI[e2];e1.push(this.get_action_by_name(eZ))}return e1}).call(this)}eN=es.tmpl("actions_bar_tmpl",{context:this,description:eP,filesize:eD,has_actions:!!eQ.length,actions:eG,_:dU,Sprite:b6});$("browse-root-actions").__date(eN);T=this.get_disabled_action_names();ex=[];for(ev=0,eU=T.length;ev<eU;ev++){eO=T[ev];ex.push(this._disable_action(eO))}return ex},_click:function(ex,ev){var ew,T;ew=ev.readAttribute("data-value");ci(ew);this.firefly_logging_helper(ew);T=a.option_dict[ew];ci(T,"Action info is missing for "+ew);ex.preventDefault();T.click_handler.call(this,ex,"browse_actions_basic");if(ew==="sharing_options"){aQ.SharedFolderActivityLogger.log("web","browse_view_select_folder_options",b2.active_user,this._log_extras,true)}if(ew==="share"){return aQ.SharedFolderActivityLogger.log("web","browse_view_select_share_existing",b2.active_user,this._log_extras,true)}}});Object.extend(dZ,{STANDARD_ACTIONS:["share","sharing_options","app_info","token_share","copy_url","download","delete","rename","restore","purge","view_in_photos"]});en=A.GlobalActions=Class.create(a,{initialize:function($super){return $super()},get_action_names:function(){var T;if(!b2.inside_dir){return[]}T=[];if(!b2.inside_deleted_dir){T=T.concat(["upload","new_folder"]);if(this._should_show_shared_folder_options()){T.push("global_share")}if(this._should_show_share_link()){T.push("global_token_share")}if(this._should_show_single_entry_share()){T.push("global_share_button")}if(!Constants.can_see_trash){T.push((b2.deleted_shown?"hide_del":"show_del"))}}else{T=T.concat(["global_restore"])}return T},_should_show_shared_folder_options:function(){return !b2.is_in_subfolder_of_shared_folder()&&!b2.inside_sandbox&&!this._should_show_single_entry_share()},_should_show_share_link:function(){return b2.is_shmodelable_path(b2.containing_fq_path())&&!this._should_show_single_entry_share()},_should_show_single_entry_share:function(){return b2.single_share_entry_point&&b2.containing_fq_path()!==""}});bn=A.GlobalActionsBasic=Class.create(en,{initialize:function($super){$super();this._listen();return this._render()},_listen:function(){$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));document.observe(a1.SHOW_EVT,this._disable.bind(this));return document.observe(a1.HIDE_EVT,this._enable.bind(this))},_render:function(){var ex,ez,eB,eE,eG,T,ev,eA,eD,eC,ey,eF,ew;ez=this.get_action_names();eC=ez.intersect(bn.STANDARD_ACTIONS);eA=ez.without.apply(ez,bn.STANDARD_ACTIONS);if(eA.length===1){eC=ez;eA=[]}if(eA.length){eC.push("more_global_actions")}eD=(function(){var eJ,eI,eH;eH=[];for(eJ=0,eI=eC.length;eJ<eI;eJ++){T=eC[eJ];eH.push(this.get_action_by_name(T))}return eH}).call(this);eB=(function(){var eJ,eI,eH;eH=[];for(eJ=0,eI=eD.length;eJ<eI;eJ++){ex=eD[eJ];if(ex.kind==="button"){eH.push(ex)}}return eH})();ev=(function(){var eJ,eI,eH;eH=[];for(eJ=0,eI=eD.length;eJ<eI;eJ++){ex=eD[eJ];if(ex.kind!=="button"){eH.push(ex)}}return eH})();eE=es.tmpl("global_actions_tmpl",{context:this,standard_actions:eB.concat(ev),secondary_actions:(function(){var eJ,eI,eH;eH=[];for(eJ=0,eI=eA.length;eJ<eI;eJ++){T=eA[eJ];eH.push(this.get_action_by_name(T))}return eH}).call(this),Sprite:b6});$("global-actions").__date(eE);bf(document).trigger("db:browse:ga_rendered");eG=this.get_disabled_action_names();ew=[];for(ey=0,eF=eG.length;ey<eF;ey++){ex=eG[ey];ew.push(this._disable_action(ex))}return ew},_disable:function(){$("global-actions").stopObserving("click");$$("#global-actions .action a").invoke("removeClassName","title_bubble");return $$("#global-actions .action a").invoke("addClassName","disabled")},_disable_action:function(ew){var ev,T;T="#global-actions #"+ew+"_button";ev=bf(T);ev.addClass("disabled");return ev.click((function(ex){return function(ey){ex.show_disabled_action_warning(ew);return false}})(this))},_enable:function(){var ex,ey,ew,ev,T;$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));$$("#global-actions .action a").invoke("removeClassName","disabled");$$("#global-actions .action a").invoke("addClassName","title_bubble");ey=this.get_disabled_action_names();T=[];for(ew=0,ev=ey.length;ew<ev;ew++){ex=ey[ew];T.push(this._disable_action(ex))}return T},_click:function(ex,ev){var ew,T;ew=ev.readAttribute("data-value");ci(ew);T=a.option_dict[ew];ci(T,"Action info is missing for "+ew);bn.hide_secondary();ee.deselect_all();ex.preventDefault();T.click_handler.call(this,ex,"global_actions_basic");if(ew==="global_share"){if(this._log_extras.path===""){return aQ.SharedFolderActivityLogger.log("web","browse_view_share_button",b2.active_user,this._log_extras,true)}else{return aQ.SharedFolderActivityLogger.log("web","folder_view_share_button",b2.active_user,this._log_extras,true)}}}});Object.extend(bn,{STANDARD_ACTIONS:["upload","new_folder","global_share","global_token_share","global_restore","global_purge","global_share_button"],show_secondary:function(){var T,ev;ev=$("secondary-actions");T=$("more_global_actions_button");ev.show();return T.addClassName("down")},hide_secondary:function(){var T,ev;ev=$("secondary-actions");if(!ev){return}T=$("more_global_actions_button");ev.hide();return T.removeClassName("down")}});c4=A.GlobalActionsContext=Class.create(en,{initialize:function($super,T){$super(T);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(ex,ev){var ew,T;ew=ev.readAttribute("data-value");this.firefly_logging_helper(ew);T=a.option_dict[ew];ee.deselect_all();if(!T.is_dropdown){a1.hide()}ex.preventDefault();T.click_handler.call(this,ex,"global_actions_context");if(ew==="global_share"){if(this._log_extras.path===""){return aQ.SharedFolderActivityLogger.log("web","browse_view_right_click_share",b2.active_user,this._log_extras,true)}else{if(b2.inside_shared_folder){return aQ.SharedFolderActivityLogger.log("web","folder_view_right_click_options",b2.active_user,this._log_extras,true)}else{return aQ.SharedFolderActivityLogger.log("web","folder_view_right_click_share",b2.active_user,this._log_extras,true)}}}}});var v;v=A.BrowseClipboard=(function(){var eC,ez,ew,eA,ey,eE,eG,eB,ev,T,eD,ex,eF;eC=0;ez=1;ey=[];ew=null;eF=function(){var eJ,eL,eI,eM,eK,eH;if(y.focus_in_input()){return}eI=ee.get_selected_files();if(eI&&eI.length){for(eK=0,eH=eI.length;eK<eH;eK++){eL=eI[eK];if(eL.bytes<0){Y.error(dU("Deleted files cannot be added to the clipboard"));return false}else{if(eL.target_ns){eM=dU("'%(filename)s' cannot be added to the clipboard");eM=eM.format({filename:eL.filename});Y.error(eM);return false}}}ey=eI;eJ=eI.length;eM=aR("Added %d item to clipboard","Added %d items to clipboard",eJ).format(eJ);Y.success(eM);return true}};eE=function(){if(eF()){ew=eC;return false}};eG=function(){if(eF()){ew=ez;return false}};eB=function(eH){var eI;ci(typeof eH!=="undefined","BrowseClipboard _paste got an undefined path");if(ey.length){eI=ew===eC?c0.do_bulk_copy:c0.do_bulk_move;eI(ey,eH);return true}};ex=function(eH){var eI;if(y.focus_in_input()||b2.in_search_mode()||b2.inside_deleted_dir){return}eI=eB(b2.containing_fq_path());if(eI){return false}};eA=function(){return ey=[]};T=function(eO){var eN,eJ,eL,eM,eK,eI,eH;eL=eO.memo.files;for(eM=0,eI=eL.length;eM<eI;eM++){eJ=eL[eM];for(eK=0,eH=ey.length;eK<eH;eK++){eN=ey[eK];if(eN.fq_path===eJ.fq_path||eN.fq_path.startsWith(eJ.fq_path+"/")){eA();return}}}};ev=function(eH){ci((eH.memo.file!=null)&&(eH.memo.files==null));eH.memo.files=[eH.memo.file];return T(eH)};eD=function(){var eL,eH,eK,eI,eJ;document.observe(av.RENAME,ev);eJ=[av.DELETE,av.MOVE];for(eK=0,eI=eJ.length;eK<eI;eK++){eL=eJ[eK];document.observe(eL,T)}eH=key.main_modifier();key(""+eH+"+c",b2.KEY_SCOPE,eE);key(""+eH+"+x",b2.KEY_SCOPE,eG);return key(""+eH+"+v",b2.KEY_SCOPE,ex)};return{init:function(){return eD()}}})();var ee,aJ,ar;ee=A.BrowseSelection=(function(){var ey,eA,eR,eG,eU,T,eN,eF,e2,eK,eO,eB,eH,eP,eZ,eY,eC,eI,ex,eQ,eL,eS,e0,ez,eV,eT,e1,eE,eX,eW,eM,e4,ew,eJ,eD,ev,e3;eW=[];eG=null;eK=null;eF=null;T=[];eD=function(){$$("#browse-files li.browse-file.file-select").invoke("removeClassName","file-select");return ee.get_selected_files().invoke("get_div").findAll(function(e5){return e5}).invoke("addClassName","file-select")};ev=function(){if(eF){return}$$("#browse-files li.browse-file[draggable]").invoke("writeAttribute","draggable",false);if(b2.in_search_mode()&&bJ.fulltext_search_enabled){return}return ee.get_selected_files().filter(function(e5){return !e5.editing}).invoke("get_div").findAll(function(e5){return e5}).invoke("writeAttribute","draggable","true")};e3=function(e5){e5.apply(null,$A(arguments).slice(1));return document.fire(ee.UPDATED_EVT)};eM=function(e7,e6){var e8,e5;e5=eW.length;eW=(e7 instanceof co?[e7]:$A(e7));if(eW.length!==e5){d0("Selected",eW.length,"files")}e8=e6||eW.last();ci(!e8||e8 instanceof co,"Invalid anchor type"+e8);return eG=e8};eM=eM.wrap(e3);ey=function(e6,e5){if(e6){eW.push(e6)}return eG=e5||e6};ey=ey.wrap(e3);eV=function(e5){var e6;e6=eW.indexOf(e5);if(e6===-1){return}return eW.splice(e6,1)};eV=eV.wrap(e3);eT=function(){return eW=[]};eT=eT.wrap(e3);e4=function(e5){T=e5;$$("#browse-files li.browse-file.context-select").invoke("removeClassName","context-select");return e5.invoke("get_div").findAll(function(e6){return e6}).invoke("addClassName","context-select")};eI=function(fe){var fb,e9,e8,fa,fh,e7,fg,fi,e5,fd,ff,fc,e6;fc=$(fe.target);fi=fc.match("li.browse-file")?fc:fc.up("li.browse-file");fb=fc.match("a")?fc:fc.up("a");e8=co.from_elem(fi);if(fe.isRightClick()||!fi||fb||fi.hasClassName("unselectable")){return}b2.keyboard_nav=false;if(T.length){return}e7=ds.is_mac();if((e7&&fe.metaKey)||(!e7&&fe.ctrlKey)){if(eW.indexOf(e8)===-1){return ey(e8)}else{return eV(e8)}}else{if(fe.shiftKey){e9=b2.files.indexOf(eG);e6=b2.files.indexOf(e8);fg=b2.files.indexOf(eW.last());fd=eW.slice(0);fh=fg<e9?-1:1;fa=e9;while(fa!==fg){fa+=fh;ff=fd.indexOf(b2.files[fa]);if(ff!==-1){fd.splice(ff,1)}}fh=e6<e9?-1:1;fa=e9;while(fa!==e6){fa+=fh;e5=fd.indexOf(b2.files[fa]);if(e5!==-1){fd.splice(e5,1)}fd.push(b2.files[fa])}return eM(fd,eG)}else{return eM(e8)}}};ex=function(fa){var fe,e7,fd,fb,e6,e5,e9,e8,fc;if(fa.isRightClick()||T.length||ds.in_scrollbar(fa.pointerX())){return}fb=$(fa.target);if(Element.match(fb,"object")){fb=fb.parentNode}e9=["browse-box","context-menu-container","modal","modal-overlay"];e6=false;for(e8=0,fc=e9.length;e8<fc;e8++){e5=e9[e8];if(fb.descendantOf(e5)||fb.match("#"+e5)){e6=true;break}}if(!e6){eM();return}fd=fb.match("li.browse-file")?fb:fb.up("li.browse-file");e7=co.from_elem(fd);fe=fb.match("[draggable]")||fb.up("[draggable]");if(e7&&!fe){eK=eG;if(!fa.shiftKey){if(e7){eK=e7}else{if(fb.match("#browse-files")){eK=b2.files.last()}}}eF=[];if(fa.metaKey||fa.ctrlKey){return eF=ee.get_selected_files()}}};ew=function(e7){var e6,e5;e6=co.from_elem(eY(e7));e7.preventDefault();if(!e6){return}e5="browse_file_row";aQ.ShmodelUILogger.log_with_target_file("token_share",e5,e6);return cV.shmodel(e6.fq_path,e5)};eY=function(e6){var e5;e5=$(e6.target);if(e5.match("li.browse-file")){return e5}else{return e5.up("li.browse-file")}};eZ=(function(e5){return function(fd){var e7,e6,e8,fg,ff,fb,fe,fc,fa,e9;fe=b2.sharing_growth_experiments_variant&&b2.sharing_growth_experiments_variant==="DROPDOWN";fc=b2.sharing_single_file_collaboration&&b2.sharing_single_file_collaboration==="SINGLE_FILE_SHARING";fg=eY(fd);e7=co.from_elem(fg);fd.preventDefault();if(!(e7&&fe)){return}ff="browse_file_row";fa=aQ.ShmodelUILogger.get_target_item(e7);aQ.ShmodelUILogger.log("single_entry_share",ff,fa);e8=b2.simple_sharing_enabled;fb=bf(fg).find(".inline-share-button")[0];if(b2.growth_browse_experiment_rule==="sharing-on-browse-experiment"&&((e9=b2.growth_browse_experiment_variant)==="SHARERS")){fb=bf(fg).find(".sharing .inline-share-button")[0]}if(e7.is_shared_folder()||e7.could_be_shared_folder()){if(e8){return eJ(b2.active_user,e7.is_shared_folder(),fa,e7.fq_path)}else{return ar.open(e7.fq_path,e7.is_shared_folder(),fb,b2.active_user,fa)}}else{if(fc&&(e7.is_shared_single_file()||e7.could_be_shared_single_file())&&!e8){return ar.open(e7.fq_path,e7.is_shared_single_file(),fb,b2.active_user,fa,e6=true,e7.mount_point)}else{ee.firefly_logging_helper(e7,"single_entry_share_button_file_link");return cV.shmodel(e7.fq_path,ff)}}}})(this);ez=(function(e5){return function(e8){var e7,e6;e6=eY(e8);e7=co.from_elem(e6);return aJ.recipients_click(e7,b2.active_user)}})(this);eC=(function(e5){return function(e8){var e7,e6;e6=eY(e8);e7=co.from_elem(e6);return aJ.link_click(e7,b2.active_user)}})(this);eU=function(e8){var e6,e5,e7;e7=$(e8.target);e5=e7.match("li.browse-file")?e7:e7.up("li.browse-file");e6=co.from_elem(e5);if(e6){return eI(e8)}};eP=null;eO=function(){var e5;clearInterval(eP);e5=function(){b2.keyboard_nav=false;return $("browse-files").addClassName("mouse-active")};return eP=setTimeout(e5,100)};eN=function(){if(!b2.keyboard_nav){b2.keyboard_nav=true;return $("browse-files").removeClassName("mouse-active")}};eQ=function(fb){var e8,e7,e6,fa,fd,e5,e9,fc;eO();if(!ee.is_selecting()){return}e8=b2.files.indexOf(eK);e5=b2.files.indexOf(co.from_elem(fb.target));ci(e8<b2.files.length&&e8>=0,"anchor_index: "+e8+" "+eK);ci(e5<b2.files.length&&e5>=0,"target_index: "+e5);e7=b2.files.slice(Math.min(e8,e5),Math.max(e8,e5)+1);e6=eF.slice(0);for(e9=0,fc=e7.length;e9<fc;e9++){fd=e7[e9];fa=e6.indexOf(fd);if(fa===-1){e6.push(fd)}else{e6.splice(fa,1)}}return eM(e6)};e2=function(e5){eK=null;return eF=null};e0=function(e7){var e5,e6;if(typeof J!=="undefined"&&J!==null){J.reset()}eN();if(e7){Event.extend(e7).preventDefault()}e6=eW.length?eW.last()===b2.files.first()?b2.files.first():(e5=b2.files.indexOf(eW.last())-1,b2.files[e5]):b2.files.last();eM(e6);if(e6){return b2.scrollTo(e6.get_div())}};eL=function(e7){var e5,e6;if(typeof J!=="undefined"&&J!==null){J.reset()}eN();if(e7){Event.extend(e7).preventDefault()}e6=eW.length?eW.last()===b2.files.last()?b2.files.last():(e5=b2.files.indexOf(eW.last())+1,b2.files[e5]):b2.files.first();eM(e6);if(e6){return b2.scrollTo(e6.get_div())}};eR=function(fd){var e5,e6,fb,fc,e8,e9,fa,e7;if(typeof J!=="undefined"&&J!==null){J.reset()}eN();if(fd){Event.extend(fd).preventDefault()}if(eW.length>0){fc=b2.files.indexOf(eW.last());e5=b2.files.indexOf(eG);if(eG===eW.last()||e5>fc){if(fc>0){e7=[];for(fb=e9=fa=fc-1;fa<=0?e9<=0:e9>=0;fb=fa<=0?++e9:--e9){e6=b2.files[fb];e8=eW.indexOf(e6);ey(e6,eG);if(e8!==-1){e7.push(eW.splice(e8,1))}else{b2.scrollTo(e6.get_div());break}}return e7}}else{eV(eW.last());return b2.scrollTo(eW.last().get_div())}}else{return e0()}};eA=function(fe){var e5,e6,fc,fd,e9,fa,fb,e8,e7;if(typeof J!=="undefined"&&J!==null){J.reset()}eN();if(fe){Event.extend(fe).preventDefault()}if(eW.length>0){fd=b2.files.indexOf(eW.last());e5=b2.files.indexOf(eG);if(eG===eW.last()||e5<fd){e7=[];for(fc=fa=fb=fd+1,e8=b2.files.length;fb<=e8?fa<e8:fa>e8;fc=fb<=e8?++fa:--fa){e6=b2.files[fc];e9=eW.indexOf(e6);ey(e6,eG);if(e9!==-1){e7.push(eW.splice(e9,1))}else{b2.scrollTo(e6.get_div());break}}return e7}else{eV(eW.last());return b2.scrollTo(eW.last().get_div())}}else{return eL()}};e1=function(){if(typeof J!=="undefined"&&J!==null){J.reset()}eM(b2.files);return false};eX=function(){if(typeof J!=="undefined"&&J!==null){J.reset()}return eM(null,null,null)};eE=function(e5){return eM(b2.find_file(e5.memo.fq_path))};eH=function(){$$(".file-select").invoke("removeClassName","file-select");return setTimeout(eD,100)};eS=function(e5){return e5.memo.files.each(function(e6){var e7;e7=eW.indexOf(e6[0]);if(e7!==-1){eW.splice(e7,1);return ey(e6[1])}})};eB=function(e5,e6){var e7;if(b2.in_search_mode()&&e5&&e6){e7={file_nsid:e5.ns_id,file_sjid:e5.file_sjid,firefly:bJ.fulltext_search_enabled,match_type:e5.match_type,position:e5.sort_rank,request_id:e5.request_id,viewport:"full-view",action_type:e6};return aQ.SearchClientActivityLogger.log("result_action",b2.active_user.id,e7)}};eJ=function(e6,e5,e7,e9,fd){var fc,fb,fa,e8;fb="file_row_sharing_menu";if(e5){if(dq.get_for_user(e6).verified_or_show()){aQ.ShmodelUILogger.log("sf_options",fb,e7);eB("single_entry_share_button_folder_options");fc=new cH(e6,e9);if(typeof fd==="function"){fd()}return fc.show()}}else{e8=b2.verify_email_after_share_experiment_variant;fa=e8&&e8==="VERIFY_LAST";if(fa){aQ.UserActivityLogger.log("web","email_verify_last_experiment_shown")}else{if(e8){aQ.UserActivityLogger.log("web","email_verify_last_experiment_not_shown")}}if(fa||dq.get_for_user(e6).verified_or_show()){aQ.ShmodelUILogger.log("sf_invite",fb,e7);eB("single_entry_share_button_folder_invite");fc=new bY(e6,{folder_name:e9,element_id:"invite-to-new-sf-wizard-modal-"+e6.id,must_check_verified:fa});if(typeof fd==="function"){fd()}return fc.show()}}};document.observe(be.REMOVE,function(e5){return e5.memo.files.each(eV)});document.observe(be.MOVE,eS);return{UPDATED_EVT:"db:select:updated",LIGHTBOX_EXIT_SELECT_EVT:"db:filepreview:exitselect",init:function(){var e5;document.observe("click",eU);document.observe("mousedown",ex);document.observe("mouseup",e2);document.observe("dragend",e2);document.observe("mouseup",ev);$("browse-files").on("mouseover","li.browse-file",eQ);$("browse-files").on("click",".shmodel-file",ew);$("browse-files").on("click",".inline-share-button",eZ);$("browse-files").on("click",".more-link",eZ);document.observe(ee.UPDATED_EVT,eD);document.observe(ee.UPDATED_EVT,ev);document.observe(b2.RENDER_EVT,eD);document.observe(b2.RENDER_EVT,ev);document.observe(b2.UPDATE_EVT,eM.bind(null,null,null));document.observe(ee.LIGHTBOX_EXIT_SELECT_EVT,eE);e5=key.main_modifier();key("up",b2.KEY_SCOPE,e0);key("down",b2.KEY_SCOPE,eL);key(e5+"+a",b2.KEY_SCOPE,e1);key("escape",b2.KEY_SCOPE,eX);key("shift+up",b2.KEY_SCOPE,eR);return key("shift+down",b2.KEY_SCOPE,eA)},set_selected_files:function(e5){return eM(e5)},get_selected_files:function(){return eW.slice(0)},get_selected_fq_paths:function(){return eW.map(function(e5){return e5.fq_path})},is_selected:function(e5){return eW.indexOf(e5)!==-1},is_selecting:function(){return !!eK},deselect_all:eT,set_context_selected:function(e5){return e4(e5)},flicker_selected:eH,firefly_logging_helper:function(e5,e6){return eB(e5,e6)},show_share_modal_if_email_verified:eJ,recipients_click:function(e5){return ez(e5)},link_click:function(e5){return eC(e5)}}})();ar=A.SharingGrowthExperimentsDropdown={open:function(ez,ew,ex,ev,eA,eB,ey){var T;this.fq_path=ez;this.existing_sf=ew;this.button=ex;this.user=ev;this.target_item=eA;this.is_file=eB;this.mount_point=ey;this.$menu=bf("#sharing-growth-experiments-dropdown-menu");T=this.$button&&this.$button.length;if(T){if(this.$button[0]===this.button){this._hide();return}else{this._hide()}}return this._show()},_show:function(){var T,ev;this.$menu.show();this.$button=bf(this.button);this.$button.addClass("pressed");if(b2.growth_browse_experiment_rule==="sharing-on-browse-experiment"&&((ev=b2.growth_browse_experiment_variant)==="INLINE_SHARE"||ev==="BOTH")){this.$button.parent(".sharing-actions").addClass("pressed")}T={offsetLeft:-1*Math.abs(this.$button.outerWidth()-this.$menu.outerWidth())+6,offsetTop:46,setWidth:false,setHeight:false};y.clone_position(this.$menu,this.$button,T);bf("#browse-box").addClass("dropdown-menu-open");if(this.is_file){this._add_share_file_logging("single_file_shared_entry_button_displayed","single_file_unshared_entry_button_displayed")}return this._listen()},_listen:function(){this.$menu.on("click dblclick",function(T){return T.stopPropagation()});bf(document).on("mousedown",bf.proxy(this._click_outside_menu_callback,this));this.$menu.find(".option-to-share-folder").on("click",bf.proxy(this._sf_click,this));return this.$menu.find(".option-to-share-link").on("click",bf.proxy(this._share_link_click,this))},_unlisten:function(){this.$menu.hide().off("click dblclick");bf(document).off("mousedown",this._click_outside_menu_callback);this.$menu.find(".option-to-share-folder").off("click",bf.proxy(this._sf_click,this));return this.$menu.find(".option-to-share-link").off("click",bf.proxy(this._share_link_click,this))},_add_share_file_logging:function(ew,ex){var ev,T;T={path:this.fq_path};ev=this.existing_sf?ew:ex;return aQ.SharedFolderActivityLogger.log("web",ev,this.user,T)},_sf_click:function(ev){var T;if(this.is_file){if(dq.get_for_user(this.user).verified_or_show()){this._add_share_file_logging("single_file_shared_collaboration_clicked","single_file_unshared_collaboration_clicked");if(this.existing_sf){T=new dt(this.user,{folder_name:an.filename(this.mount_point),folder_path:this.mount_point,element_id:"confirm-share-existing-file-wizard-modal"})}else{T=new bY(this.user,{folder_name:this.fq_path,is_file:true,element_id:"invite-to-new-share-file-wizard-modal-"+this.user.id})}this._hide();return T.show()}}else{return ee.show_share_modal_if_email_verified(this.user,this.existing_sf,this.target_item,this.fq_path,this._hide.bind(this))}},_share_link_click:function(ev){var T;T="file_row_sharing_menu";aQ.ShmodelUILogger.log("token_share",T,this.target_item);this._firefly_logging_helper("single_entry_share_button_folder_link");cV.shmodel(this.fq_path,T);if(this.is_file){this._add_share_file_logging("single_file_shared_link_clicked","single_file_unshared_link_clicked")}return this._hide()},_firefly_logging_helper:function(T){return ee.firefly_logging_helper(b2.find_file(this.fq_path),T)},_clicked:function(T,ev){return T.is(ev.target)||T.has(ev.target).length},_click_outside_menu_callback:function(T){if(!(this._clicked(this.$menu,T)||this._clicked(this.$button,T))){return this._hide()}},_hide:function(T){this._unlisten();bf("#browse-box").removeClass("dropdown-menu-open");this.$button.removeClass("pressed");if(b2.growth_browse_experiment_rule==="sharing-on-browse-experiment"&&b2.growth_browse_experiment_variant===["INLINE_SHARE","BOTH"]){this.$button.parent(".sharing-actions").removeClass("pressed")}return this.$button=null}};aJ=A.SharingGrowthExperimentsAutocomplete={init:function(){return this.autocomplete=new Autocompleter.ContactsTokenizer(b2.active_user,"growth-browse-inline-new-collab-input","growth-browse-inline-new-whobulk","growth-browse-inline-hidden-input",{tokens:[",",";"],include_fb:false,include_team:false,hide_import_contacts:false,suggestions_disabled:true})},recipients_click:function(ev,T){var ew;this.file=ev;this.user=T;this.mode="recipients";this._activate();this.$sharing_actions.find(".get-link").hide();this.$sharing_actions.find(".send-button").show();ew=this._autocomplete_div();this.$sharing_actions.prepend(ew);ew.show();this.autocomplete.dynamically_resize_input();bf(this.autocomplete.element).val("");this.autocomplete.clearTokens();bf(this.autocomplete.get_entry_container()).hide();bf(this.autocomplete.element).focus();return false},link_click:function(ew,ev){var T;this.file=ew;this.user=ev;if(!dq.get_for_user(this.user).verified_or_show(dO.SHMODAL)){return}T="file_row_sharing_menu";aQ.ShmodelUILogger.log("token_share",T,this.target_item);return cV.shmodel(this.file.fq_path,T)},_activate:function(){this.$sharing_div=bf(this.file.get_div()).find(".sharing");this.$sharing_actions=this.$sharing_div.find(".sharing-actions");this.$sharing_actions.find(".recipients").hide();this.$sharing_div.addClass("pressed");bf("#browse-box").addClass("dropdown-menu-open");return this._listen()},_send:function(){var ev,eA,eB,eD,eG,ex,ew,ey,eC,eF,ez,T,eE;this.sharing_api=new aZ(this.user);this.autocomplete.tokenize_emails_input(true);eD=this.emails=this.autocomplete.getEmails().split(", ");eG=this.file.fq_path;T={emails:eD};eB="";eA="";ev="";ey=this.file.target_ns;ew="";eE="";ev="";ex=false;this._hide();eF=(function(eH){return function(){return eH._complete(dU("Sent!"),"success")}})(this);eC=(function(eH){return function(eM){var eL,eK,eJ,eI;eI=eM.responseText.substr(4);if(eI[0]==="{"){eL=JSON.parse(eI);if(eL.emails){eK=eL.emails["message_text"]}if(eL.path){eK=eL.path["message_text"]}}else{eK=eI}if(!eK){eK="Unknown"}eJ=dU("Error: %(msg)s").format({msg:eK});return eH._complete(eJ,"error")}})(this);if(!dq.get_for_user(this.user).verified_or_show(dO.SHMODAL)){return}ez=this.file.read_only||this.file.is_read_only_mount;if(this.file.is_shared_folder()&&!ez){return this.sharing_api.invite_more_to_folder(ey,T,eB,ev,eF,eC)}else{if(this.file.could_be_shared_folder()&&!ez){return this.sharing_api.share_folder(false,eG,T,eB,eA,ew,eE,ev,ex,eF,eC)}else{return this._get_shmodel_link(function(eI){var eH;eH=C.parse(eI);return cb.WebRequest({url:"/sm/share",data:{emails:eD,shmodel_path:eH.path},subject_user:b2.active_user.id,success:eF,error:eC})})}}},_get_shmodel_link:function(T){return cb.WebRequest({url:"/growth/find_or_create_shmodel_link",data:{path:this.file.fq_path},subject_user:b2.active_user.id,dataType:"json",success:(function(ev){return function(ew){if(ew.error!=null){return ev._complete(dU("Error"),"error")}else{return T(ew.shmodel_link)}}})(this),error:(function(ev){return function(){return ev._complete(dU("Error"),"error")}})(this)})},_complete:function(ev,eA){var T,ez,eB,eC,ex,ey,ew;this.$sharing_div.addClass("complete");T=this.$sharing_div.find(".sharers");if(eA==="success"&&this.emails){ey=aR("Sent to %(number)d person","Sent to %(number)d people",this.emails.length).format({number:this.emails.length});Y.success(ey);ez=T.text();if(ez==="--"){ez=""}if(ez.length===""||ez.length+this.emails.join(", ").length<28){eB=[];ew=0;ex=0;while(ex<this.emails.length&&ew+this.emails[ex].length<(30-ez.length)){eB.push(this.emails[ex]);ew+=this.emails[ex].length;ex++}if(this.emails.length>eB.length){eB.push("+"+(this.emails.length-eB.length))}if(ez!==""){eB.push(ez)}eC=eB.join(", ");T.text(eC);b2.update_file_to_sharers(this.file,eC)}}else{if(eA==="error"){Y.error(ev)}}return setTimeout(this._removeComplete,2000)},_removeComplete:function(){return bf("div.sharing.complete").removeClass("complete")},_autocomplete_div:function(){return bf("#browse-inline-autocomplete")},_listen:function(){if(this.mode==="recipients"){this._autocomplete_div().on("click dblclick",function(T){return T.stopPropagation()});this.$sharing_actions.find(".send-button").on("click",bf.proxy(this._send,this))}return bf(document).on("mousedown",bf.proxy(this._click_outside_autocompleter_callback,this))},_unlisten:function(){if(this.mode==="recipients"){this._autocomplete_div().off("click dblclick");this.$sharing_actions.find(".send-button").off("click",bf.proxy(this._send,this))}return bf(document).off("mousedown",this._click_outside_autocompleter_callback)},_click_outside_autocompleter_callback:function(T){if(!(this.$sharing_actions.is(T.target)||bf(T.target).parents(".sharing-actions").length)){return this._hide()}},_hide:function(T){var ev;this._unlisten();bf("#browse-box").removeClass("dropdown-menu-open");this.$sharing_actions.find(".recipients, .get-link").show();this.$sharing_actions.find(".send-button, .link-field").hide();this.$sharing_div.removeClass("pressed");ev=this._autocomplete_div().hide();return bf("#browse-sort").append(ev)}};var x;x=A.DragScroll={_timer:null,_mouse_y:0,_initial_mouse_y:null,_scroll_amount:40,_scroll_window:50,_min_drag_distance:20,_exclude_move_event:null,init:function(T,ev){this._exclude_move_event=T;if(ev!=null){return this._scroll_window=ev}},start:function(){this._initial_mouse_y=null;this._listen();return this._timer=setInterval(this._check_for_scroll.bind(this),100)},end:function(){this._unlisten();return clearInterval(this._timer)},_mousemove:function(ev){var T;if(typeof this._exclude_move_event==="function"?this._exclude_move_event(ev):void 0){return this._mouse_y=0}else{T=ev.pointerY();return this._mouse_y=T-y.scroll_offsets().top}},_listen:function(){document.observe("mousemove",this._mousemove.bind(this));return document.observe("dragover",this._mousemove.bind(this))},_unlisten:function(){document.stopObserving("mousemove",this._mousemove.bind(this));return document.stopObserving("dragover",this._mousemove.bind(this))},_check_for_scroll:function(){var T;if(this._initial_mouse_y===null){this._initial_mouse_y=this._mouse_y}if(Math.abs(this._mouse_y-this._initial_mouse_y)<this._min_drag_distance){return}T=0;if(this._mouse_y<this._scroll_window){T=-1*this._scroll_amount}else{if(this._mouse_y>y.viewport_dimensions().height-this._scroll_window){T=this._scroll_amount}}if(T){return y.scroll_to(y.scroll_offsets().left,y.scroll_offsets().top+T)}}};var bq;bq=A.BrowseDrag={_BODY_DRAG_CLASS:"external_drag",_STATUS_CLASS:"dragging",_STATUS_OFFSET:10,_SELECTION_CONST:"SELECTION",_current_item_key:null,_drag_from_window:false,init:function(){var T;if(!Modernizr.draganddrop){return}this.listen();T=function(ew){var ev;ev=bf(ew.target);return ev.closest("#browse-location").length||ev.attr("id")==="browse-location"};return x.init(T,bf("#browse-header").height())},listen:function(){var T;T=$(document.body);document.observe(b2.UPDATE_EVT,this._update_body_data.bind(this));T.on("dragleave","[dropzone]",this._dropzone_dragleave.bind(this));T.on("dragend",this._body_dragend.bind(this));T.on("dragover","[dropzone]",this._dropzone_dragover.bind(this));if(Prototype.Browser.IE){T.on("dragenter","[dropzone]",this._dropzone_dragover.bind(this));T.on("mousedown",this._ie_start_drags.bind(this));T.on("mouseover","a.filename-link",this._ie_mouseover.bind(this))}T.observe("dragover",this._body_dragover.bind(this));T.observe("dragleave",this._body_dragleave.bind(this));T.observe("dragstart",this._body_dragstart.bind(this));T.observe("mousemove",this._body_mousemove.bind(this));T.on("dragstart","li.browse-file",this._file_dragstart.bind(this));document.observe(ee.UPDATED_EVT,this._build_selected_drag_icon.bind(this));document.observe(b2.RENDER_EVT,this._build_selected_drag_icon.bind(this));T.on("mousedown","li.browse-file",this._build_file_drag_icon.bind(this));return T.on("drop","[dropzone]",this._drop.bind(this))},_file_mousemove:function(ev){var T;if(!window.event||window.event.button!==1){return}T=ev.findElement("[draggable]");if(T&&T!==document&&T.dragDrop){T.dragDrop();return bq._ie_end_drags()}},_ie_start_drags:function(T,ev){if(ev.tagName!=="OBJECT"&&$(ev).match("[draggable]")){return $("browse-files").observe("mousemove",this._file_mousemove)}},_ie_end_drags:function(){return $("browse-files").stopObserving("mousemove")},_update_body_data:function(){var ev,T;ev=b2.inside_dir?"copy move":false;T=b2.inside_dir?b2.containing_fq_path():false;$(document.documentElement).writeAttribute("dropzone",ev);return $(document.documentElement).writeAttribute("data-fq_path",T)},_body_dragover:function(ex){var ev,ew,T;ev=this._get_event_browse_files();if(ev.length){return this._update_status_position(ex,ev)}else{if(!this._drag_from_window&&((ew=ex.dataTransfer)!=null?(T=ew.types)!=null?T.contains("Files"):void 0:void 0)){return a3.show_drop_indicators(ex)}}},_body_dragleave:function(ew){var ev,T,ex;T=ew.x||ew.clientX;ex=ew.y||ew.clientY;ev=y.viewport_dimensions();if(!((0<T&&T<ev.width)&&(0<ex&&ex<ev.height))){return a3.hide_drop_indicators()}},_body_dragstart:function(){return this._drag_from_window=true},_body_dragend:function(){if($("breadcrumb-dropdown")){$("breadcrumbs-box").removeClassName("down");$("breadcrumb-dropdown").hide()}this._clear_event_browse_files();this._remove_drop_indicators();a3.hide_drop_indicators();x.end();return this._drag_from_window=false},_body_mousemove:function(){return a3.hide_drop_indicators()},_ie_mouseover:function(ev,T){if(!y.focus_in_input()){return T.focus()}},_dropzone_dragover:function(ez,T){var ev,ew,ex,ey;ez.preventDefault();ex=this._get_event_browse_files();ey=this._target_fq_path(T);if(!ex.pluck("fq_path").indexOf(ey===-1)){return}if(!this._can_drop(ez,T)){T.addClassName("drag_nodrop");return}try{ew=ez.dataTransfer.effectAllowed}catch(eA){}if(ew==="move"||ew==="copyMove"||ew==="linkMove"||ew==="all"){ez.dataTransfer.dropEffect="move"}else{ez.dataTransfer.dropEffect="copy"}ez.preventDefault();ev=$$(".dragover");ev.removeItem(T);ev.invoke("removeClassName","dragover");if(!de.disabled){T.addClassName("dragover")}return a3.folder_dragover(ey)},_dropzone_dragleave:function(ev,T){return this._clear_hover_state(T)},_file_dragstart:function(eA,eD){var eE,T,eF,ev,ez,ey,ex,eB,ew;ds.clear_selected();if(ee.is_selecting()){return eA.preventDefault()}eA.dataTransfer.effectAllowed="copyMove";eA.dataTransfer.setData("URL","about:blank");ez=co.from_elem(eD);this._set_event_browse_files(ez);ey=this._get_event_browse_files();if(ey.length<=1&&!ez.dir){ew=ez.href;ex=(ez.filename||dU("file")).replace(/:/g,"-");eB="application/octet-stream";try{eA.dataTransfer.setData("DownloadURL",[eB,ex,ew].join(":"))}catch(eC){}}eF=new Element("img",{src:"/static/images/icons/icon_spacer.gif",width:1,height:1});eE=true;try{eA.dataTransfer.setDragImage(eF,150,150)}catch(eC){ev=eC;eE=ds.ie8}this._add_drop_indicators(eA);x.start();if(eE){this._update_status_position(eA,ey);T=$("drag-status");T.removeClassName("rotatein").removeClassName("fadein").removeClassName("selection");if(ey.length>1){T.addClassName("rotatein")}if(this._is_dragging_selection()){T.addClassName("selection")}return T.addClassName("fadein")}},_add_drop_indicators:function(ey){var ez,ex,ev,ew,T;$(document.body).addClassName(this._STATUS_CLASS);if(!de.disabled){ew=$$('[dropzone="copy move"]');T=[];for(ex=0,ev=ew.length;ex<ev;ex++){ez=ew[ex];if(this._can_drop(ey,ez)){T.push(ez.addClassName("can_drop"))}else{T.push(void 0)}}return T}},_remove_drop_indicators:function(){this._clear_hover_state();$(document.body).removeClassName(this._STATUS_CLASS);return $$(".can_drop").invoke("removeClassName","can_drop")},_build_selected_drag_icon:function(){var T,ex,eC,ew,eA,eD,eB,ev,ey,eE,ez;ev=ee.get_selected_files();eC=new Element("div",{id:"drag-selection-status"});ez=ev.slice(0,4);for(eA=ey=0,eE=ez.length;ey<eE;eA=++ey){ex=ez[eA];T=ex.get_div();if(!T){continue}eB=T.down(".icon");eB.stopObserving("load");eB.observe.bind(eB).defer("load",bq._build_selected_drag_icon);eD=eB.cloneNode(false);Element.addClassName(eD,"icon icon"+eA);eC.__sert(eD)}ew=new Element("span",{className:"badge"});ew.__date(ev.length);eC.appendChild(ew);return $("drag-selection-status").replace(eC)},_build_file_drag_icon:function(ey,T){var ev,ez,ex,ew;ev=co.from_elem(T);ew=ev.get_div().down(".icon").cloneNode(false);Element.addClassName(ew,"icon icon0");ex=new Element("span",{className:"badge"});ex.__date("1");ez=new Element("div",{id:"drag-file-status"});ez.__date(ew).__sert(ex);return $("drag-file-status").replace(ez)},_drop:function(ez,eC){var eA,ew,eD,eF,eE,ey,ev,T,ex,eB;ew=this._get_event_browse_files();eE=ez.dataTransfer.files;ey=ez.dataTransfer.items;ez.preventDefault();if(eC.readAttribute("quicksend")){if(eE&&eE.length){a3.upload(R.DEST_FOLDER,eE,ey)}else{if(ew.length){for(ex=0,eB=ew.length;ex<eB;ex++){ev=ew[ex];ev.id=plupload.guid();R.add_dropbox_file(ev)}}}return}if(this._is_read_only(eC)){T=dU("You don't have permission to add to this folder.");Y.error(T);return}eD=null;eF=co.from_elem(eC);eA=eC.readAttribute("data-fq_path");if(eF){eD=eF.fq_path}else{if(eA||eA===""){eD=eA}}if(eE&&eE.length){if(!a3.supported()){Y.error(dU("Drag and drop not supported. Please try the simple uploader."))}else{if(!a3.browse_indicators_enabled()&&!a3.modal_indicators_enabled()){if(b9.choose_button_id.startsWith("wizard-")){Y.error(dU("You'll be able to drag and drop files once you finish this tutorial. For now, choose a file to upload."))}else{Y.error(dU("You can't drag and drop upload right now."))}}else{a3.upload(eD,eE,ey)}}}else{if(ew.length){if((ez.dataTransfer.dropEffect==="copy")||(ez.dataTransfer.effectAllowed==="copy")){c0.do_bulk_copy(ew,eD)}else{if(!b2.inside_dir||b2.containing_fq_path()!==eD){c0.do_bulk_move(ew,eD)}}}}this._remove_drop_indicators();return a3.hide_drop_indicators()},_set_event_browse_files:function(T){var ev;ev=ee.is_selected(T);return this._current_item_key=ev?this._SELECTION_CONST:T.to_key()},_clear_event_browse_files:function(){return this._current_item_key=null},_get_event_browse_files:function(){var ew,ev,T;try{T=this._current_item_key;if(this._is_dragging_selection()){return ee.get_selected_files()}else{if(T){ev=co.from_key(T);return(ev?[ev]:[])}}}catch(ey){ew=ey;console.log(ew)}return[]},_is_dragging_selection:function(){return this._current_item_key&&this._current_item_key===this._SELECTION_CONST},_is_read_only:function(T){if(T.readAttribute("read_only")){return true}if(T.readAttribute("is_read_only_mount")){return true}return false},_can_drop:function(ex,ev){var T,ew;if(ev.readAttribute("quicksend")){return true}if(this._is_read_only(ev)){return false}T=this._target_fq_path(ev);ew=this._get_event_browse_files();if(ew.length){return !c0.bulk_move_error(ew,T)}else{if($A(ex.dataTransfer.types).indexOf("Files")!==-1){return a3.supported()}else{return false}}},_target_fq_path:function(T){var ev;ev=co.from_elem(T);if(ev){return ev.fq_path}else{return T.readAttribute("data-fq_path")}},_clear_hover_state:function(ev){var ey,ex,T,ew;ew=$$("#browse .dragover");for(ex=0,T=ew.length;ex<T;ex++){ey=ew[ex];if(ey!==ev){ey.removeClassName("dragover")}}return $$("#browse .drag_nodrop").invoke("removeClassName","drag_nodrop")},_update_status_position:function(T){T=Event.extend(T);return ds.scry("drag-status").setStyle({left:(T.pointerX()-y.scroll_offsets().left+this._STATUS_OFFSET)+"px",top:(T.pointerY()-y.scroll_offsets().top+this._STATUS_OFFSET)+"px"})}};var J;J=A.BrowseJump={_active:"",_listening:false,_RESET_WAIT:1000,_RESET_TIMER_ID:null,_CODEPOINTS:null,_BLACKLIST:["/","\\",":","?","*","<",">","|"].map(function(T){return T.charCodeAt(0)}),update:function(){var ew,ez,ev,ey,T,ex;if(!J._listening){J.listen();J._listening=true}ew=[];ex=b2.files;for(ey=0,T=ex.length;ey<T;ey++){ev=ex[ey];ez=J.to_codepoint_list(ev.filename);ew.push([ez,ev])}ew.sort(function(eB,eA){return J.cmp_codepoints(eB[0],eA[0])});return J._CODEPOINTS=ew},reset:function(){return J._active=""},is_active:function(){return J._active},jump:function(T){if(T){ee.set_selected_files([T]);return b2.scrollTo(T.get_div())}},listen:function(){var ey,ex,ev,ew,T;document.observe("keypress",function(eA){var ez;if(key.getScope()!==b2.KEY_SCOPE){return}if(y.focus_in_input()||eA.metaKey||eA.altKey||eA.altGraphKey||eA.ctrlKey){return}ez=eA.charCode||eA.keyCode;if(ez<32){return}if((33<=ez&&ez<=40)){return}if(ez===32){if(J._active){eA.preventDefault()}else{return}}if(J._BLACKLIST.indexOf(ez)!==-1){return}clearTimeout(J._RESET_TIMER_ID);J._active+=String.fromCharCode(ez).toLowerCase();J.jump(J.nearest_file(J._active));return J._RESET_TIMER_ID=setTimeout(J.reset,J._RESET_WAIT)});ew=[av.DELETE,av.COPY,av.MOVE,av.RENAME,av.PURGE,av.RESTORE,av.UPLOAD,av.SF_NEW,av.SF_LEAVE,av.SF_UNSHARE,av.SF_REJOIN,av.SF_IGNORE,av.LINKS_REMOVE,be.ADD,be.REMOVE,be.MOVE];T=[];for(ex=0,ev=ew.length;ex<ev;ex++){ey=ew[ex];T.push(document.observe(ey,function(ez){return J.update()}))}return T},nearest_file:function(eC){var ez,ev,T,ey,eB,eA,ex,ew;if((eA=J._CODEPOINTS)!=null?eA.length:void 0){ez=J.to_codepoint_list(eC);ex=J._CODEPOINTS;for(ey=0,eB=ex.length;ey<eB;ey++){ew=ex[ey],T=ew[0],ev=ew[1];if(J.cmp_codepoints(ez,T)<1){return ev}}J._CODEPOINTS.last()[1]}return null},cmp_codepoints:function(ey,ex){var T,ew,ev;ci(ey.length>0&&ex.length>0,"bad input to cmp_codepoints");for(T=ew=0,ev=ey.length;0<=ev?ew<ev:ew>ev;T=0<=ev?++ew:--ew){if(ex[T]==null){return 1}if(ey[T]!==ex[T]){return(ey[T]<ex[T]?-1:1)}}if(ex.length>ey.length){return -1}else{return 0}},to_codepoint_list:function(ev){var ew,T,ey,ex;ev=ev.toLowerCase();T=[];for(ew=ey=0,ex=ev.length;0<=ex?ey<ex:ey>ex;ew=0<=ex?++ey:--ey){T.push(ev.charCodeAt(ew))}return T}};var a1;a1=A.ContextMenu={KEY_SCOPE:"context",SHOW_EVT:"db:contextmenu:show",HIDE_EVT:"db:contextmenu:hide",_prev_key_scope:null,listen:function(){bf(document).click(this.hide_on_click);bf(document).on(b2.UPDATE_EVT,this.hide_on_click);return key("esc",this.KEY_SCOPE,(function(T){return function(ev){return a1.hide()}})(this))},unlisten:function(){bf(document).off("click",this.hide_on_click);return bf(document).off(b2.UPDATE_EVT,this.hide_on_click)},hide_on_click:function(T){if(!(T.which===3||bf(T.target).parents("#context-menu").length)){return a1.hide()}},show_for_file:function(T,ex,ew){var ey,ev;b2.keyboard_nav=false;this.hide();ey=co.from_elem(ew);ev=ee.is_selected(ey)?ee.get_selected_files():(ee.deselect_all(),[ey]);ee.set_context_selected(ev);return this._show(ex,new T(ev))},show_global:function(T,ev){this.hide();return this._show(ev,new T())},show_shmodel:function(ey){var ex,T,ev,ew;ex=["get_original"];this.hide();ev=ey.findElement("img");ew={get_original:{icon:"download",text:dU("Download original"),href:ev.readAttribute("data-original-href")}};T=Class.create({get_action_names:function(){return ex},get_disabled_action_names:function(){return[]},get_action_by_name:function(ez){var eA;eA=ew[ez];eA.name=ez;return eA}});return this._show(ey,new T())},show_for_lightbox:function(ey){var ex,T,ev,ew;ex=["download","view_original"];this.hide();ev=ey.findElement("img");ew={download:{icon:"download",text:dU("Download"),href:C.parse(ev.readAttribute("data-original-href")).updateQuery({dl:1}).toString()},view_original:{icon:"view_original",text:aO.append_ellipsis(dU("View original")),href:ev.readAttribute("data-original-href"),target:"_blank"}};T=Class.create({initialize:function(){return this._listen()},_listen:function(){var ez;ez=$("context-menu-container");ez.stopObserving("click");ez.stopObserving("contextmenu");ez.on("click",".action button",this._click.bind(this));return ez.on("contextmenu",".action button",this._click.bind(this))},_click:function(eD,eA){var eC,ez,eB;eC=eA.readAttribute("data-value");ez=ew[eC];a1.hide();eD.preventDefault();return(eB=ez.click_handler)!=null?eB.call(this,eD):void 0},get_action_names:function(){return ex},get_disabled_action_names:function(){return[]},get_action_by_name:function(ez){var eA;eA=ew[ez];eA.name=ez;return eA}});return this._show(ey,new T())},show_photos:function(eC,eG){var eF,ev,ez,ex,eE,eD,T,ew,eA,eB,ey;this.hide();ex={divider:{type:"divider"},choose_album:{icon:"album_16",text:aO.append_ellipsis(dU("Add %(num_photos)s to album").format({num_photos:eG.length})),click_handler:function(eH){cf.show_add_to_album_modal(eH,eG);return h.log_interaction(dI.ADD_TO_OTHER_ALBUM,cD.PCM,{num_photos:eG.length})}},remove:{icon:"album_delete_16",text:dU("Remove %(num_photos)s from album").format({num_photos:eG.length}),click_handler:function(){cf.show_remove_photos_modal(bp.get_current_collection(),eG);return h.log_interaction(dI.REMOVE,cD.PCM,{num_photos:eG.length})}},set_cover:{icon:"album_16",text:dU("Set as cover"),click_handler:function(){bp.get_current_collection().set_cover(eG[0]);return h.log_interaction(dI.SET_AS_COVER,cD.PCM,{num_photos:1})}},edit_timestamp:{text:"Edit timestamp",click_handler:function(){return bp.show_timestamps_modal(eG)}}};if(bp.in_single_collection_view()){eF=["share","choose_album","remove"];if(eG.length===1){eF.unshift("divider");eF.unshift("set_cover")}}else{eF=["share","choose_album"];eF.push("divider");eF.push("delete");if(bp.timestamp_edit_enabled){eE=(function(){var eJ,eI,eH;eH=[];for(eJ=0,eI=eG.length;eJ<eI;eJ++){ew=eG[eJ];if(ew.time_taken==null){eH.push(ew)}}return eH})();if(eE.length===0){eF.push("edit_timestamp")}else{if(eE.length===eG.length){ex.edit_timestamp.text="Set timestamp";eF.push("edit_timestamp")}}}}if(eG.length===1){eB=cB.categorize_files(eG),eD=eB[0],T=eB[1];if(eD){eA=aO.append_ellipsis(dU("Share photo"))}else{eA=aO.append_ellipsis(dU("Share video"))}Object.extend(ex,{share:{icon:"s_link",text:eA,click_handler:function(eH){dT.show(eG,false);return h.log_interaction(dI.SHARE,cD.PCM,{num_photos:1})}},"delete":{text:aO.append_ellipsis(dU("Delete")),click_handler:function(){bp.show_delete_photos_modal(eG);return h.log_interaction(dI.DELETE,cD.PCM,{num_photos:1})}},show_in_folder:{text:aO.append_ellipsis(dU("Show in folder")),click_handler:function(){bp.show_in_folder(eG[0]);return h.log_interaction(dI.SHOW_IN_FOLDER,cD.PCM,{num_photos:1})}}});if(bp.in_single_collection_view()){eF.push("divider")}eF.push("show_in_folder")}else{ey=cB.categorize_files(eG),eD=ey[0],T=ey[1];if(eD&&T){eA=aR("Share %(file_count)s item","Share %(file_count)s items",eG.length);ez=aR("Delete %(file_count)s item","Delete %(file_count)s items",eG.length)}else{if(eD){eA=aR("Share %(file_count)s photo","Share %(file_count)s photos",eG.length);ez=aR("Delete %(file_count)s photo","Delete %(file_count)s photos",eG.length)}else{eA=aR("Share %(file_count)s video","Share %(file_count)s videos",eG.length);ez=aR("Delete %(file_count)s video","Delete %(file_count)s videos",eG.length)}}eA=eA.format({file_count:eG.length});ez=ez.format({file_count:eG.length});Object.extend(ex,{share:{icon:"s_link",text:eA,click_handler:function(eH){bp._share_selected();return h.log_interaction(dI.SHARE,cD.PCM,{num_photos:eG.length})}},"delete":{text:ez,click_handler:function(eH){bp.show_delete_photos_modal(eG);return h.log_interaction(dI.DELETE,cD.PCM,{num_photos:eG.length})}}})}ev=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(eK,eI){var eJ,eH,eL;eJ=eI.readAttribute("data-value");eH=ex[eJ];if(eK.clientX===0&&eK.clientY===0){return}a1.hide();return(eL=eH.click_handler)!=null?eL.call(this,eK):void 0},get_action_names:function(){return eF},get_disabled_action_names:function(){return[]},get_action_by_name:function(eH){var eI;eI=ex[eH];eI.name=eH;return eI}});return this._show(eC,new ev())},show_photo_collection:function(ex,ey,ez){var ew,T,ev;this.hide();if(ey.is_anonymous){ew=["go_to_link","unshare"]}else{if(ey.is_creator){ew=["share","rename"];if(ey.share_tkey!=null){ew.push("unshare")}ew.push("delete")}else{ew=["share"]}}ev={share:{icon:"s_link",text:aO.append_ellipsis(dU("Share album")),click_handler:function(eA){if(ey.num_items===0){Y.error(dU("This album is empty. Add some photos before you share it!"));return}dT.show(ey,true);return h.log_interaction(dI.SHARE_ALBUM,cD.CCM,{num_photos:ey.num_photos})}},unshare:{icon:"lock",text:aO.append_ellipsis(ey.is_anonymous?dU("Unshare"):dU("Unshare album")),click_handler:function(eA){cf.show_unshare_modal(ey);return h.log_interaction(dI.UNSHARE_ALBUM,cD.CCM,{num_photos:ey.num_photos})}},rename:{icon:"pencil",text:dU("Rename album"),click_handler:function(eA){ey.rename(ez.down(".collection-name"));return h.log_interaction(dI.RENAME_ALBUM,cD.CCM,{num_photos:ey.num_photos})}},"delete":{icon:"album_delete_16",text:aO.append_ellipsis(dU("Delete album")),click_handler:function(eA){cf.show_delete_modal(ey);return h.log_interaction(dI.DELETE_ALBUM,cD.CCM,{num_photos:ey.num_photos})}},go_to_link:{icon:"s_link",text:dU("Go to link"),click_handler:function(eA){cf.go_to_link(ey);return h.log_interaction(dI.GO_TO_ALBUM_LINK,cD.CCM,{num_photos:ey.num_photos})}}};T=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(eE,eB){var eD,eA,eC;eD=eB.readAttribute("data-value");eA=ev[eD];a1.hide();return(eC=eA.click_handler)!=null?eC.call(this):void 0},get_action_names:function(){return ew},get_disabled_action_names:function(){return[]},get_action_by_name:function(eA){var eB;eB=ev[eA];eB.name=eA;return eB}});return this._show(ex,new T())},_show:function(eL,eE,eK){var eJ,eI,eA,T,eC,eM,ev,eH,eG,eQ,eF,ey,ex,ew,eN,eP,eO,eD,eB,ez;if(eK==null){eK=false}eF=((eL!=null?(eD=eL.target)!=null?eD.tagName.toUpperCase():void 0:void 0)==="INPUT")&&((eL!=null?(eB=eL.target)!=null?eB.type.toUpperCase():void 0:void 0)==="TEXT")||((eL!=null?(ez=eL.target)!=null?ez.tagName.toUpperCase():void 0:void 0)==="TEXTAREA");eH=["#page-footer","#account-header","#browse-global-actions-bar","#modal","#modal-overlay","#file-preview-modal","#file-viewer","#notify-wrapper",".db-modal-wrapper","#sharing-growth-experiments-dropdown-menu",".inline-share-button","#wizard-overlay","#react-bubble-dropdown-root"];eQ=$(eL.target);if(bf(eQ).parents("#context-menu").length){return}eJ=bf("#file-preview-modal");if(!(eJ.find(eQ).length&&bf(eQ).is("img"))){for(ey=0,eN=eH.length;ey<eN;ey++){ev=eH[ey];eM=$$(ev);if(eM){for(ex=0,eP=eM.length;ex<eP;ex++){eC=eM[ex];if(eQ.descendantOf(eC)||eQ.match(ev)){return}}}}}if((eL!=null?eL.shiftKey:void 0)||eF){return}else{Event.stop(eL)}if(this._context_menu_tmpl==null){this._context_menu_tmpl=es.tmpl("context_menu_tmpl")}if(!eE.get_action_names().length){return}eb.hide_all();$("context-menu-container").__date(this._context_menu_tmpl({context:eE,actions:(function(){var eT,eR,eU,eS;eU=eE.get_action_names();eS=[];for(eT=0,eR=eU.length;eT<eR;eT++){eG=eU[eT];eS.push(eE.get_action_by_name(eG))}return eS})(),big:eK,Sprite:b6}));T=eE.get_disabled_action_names();for(ew=0,eO=T.length;ew<eO;ew++){eI=T[ew];this.disable_action(eI=eI,eA=eE)}this.position_at(eL.clientX,eL.clientY);$("context-menu-container").show();this.listen();this._prev_key_scope=key.getScope();key.setScope(this.KEY_SCOPE);return document.fire(this.SHOW_EVT)},position_at:function(ew,ez){var ev,T,ex,ey;ey=y.viewport_dimensions();T=parseInt($("context-menu").getStyle("width"),10);ev=parseInt($("context-menu").getStyle("height"),10);ex=15;if(ew+T>ey.width-ex){$("context-menu").setStyle({left:(ey.width-T-ex)+"px"})}else{$("context-menu").setStyle({left:ew+"px"})}if(ez+ev>ey.height-ex){return $("context-menu").setStyle({top:(ey.height-ev-ex)+"px"})}else{return $("context-menu").setStyle({top:ez+"px"})}},hide:function(){if(!$("context-menu-container").empty()){this.unlisten();ee.set_context_selected([]);$("context-menu-container").__date();if(key.getScope()===this.KEY_SCOPE){key.setScope(this._prev_key_scope)}return document.fire(this.HIDE_EVT)}},disable_action:function(ex,ev){var ew,T;T="#context-menu-container #"+ex+"_button";ew=bf(T);ew.addClass("disabled");return ew.click(function(ey){ev.show_disabled_action_warning(ex);return false})}};var cN,b2,j,cq,bV;cN=A.BROWSE_SNIPPET_LEN=25;bV=A.SEARCH_SNIPPET_LEN=20;cq=A.LAST_MODIFIED_FNAME_SNIPPET=4;b2=INLINE_JS.Browse=A.Browse={KEY_SCOPE:"browse",RENDER_EVT:"db:browse:render",UPDATE_EVT:"db:browse:update",SCROLL_DURATION:0.5,msg:false,files:[],reloading:false,creating_folder:false,first_load:true,last_sort:[a4.FILES_BY_NAME,true],folder_loading_notification:null,folder_loading_timeout:null,keyboard_nav:false,init:function(ev,eA,ex,ez,T,ey,ew){this.browse_actions_ctor=eA;this.global_actions_ctor=ex;this.browse_actions_context_ctor=ez;this.global_actions_context_ctor=T;this.ns_id_to_mount_point=ey;ci(typeof ew==="number","a user_id was not passed into Browse.init",true,[],false);this.active_user=cj.get_viewer().get_user_by_id(ew);__CIRCULAR_DEPENDENCY__.active_user_loaded=true;ci(this.active_user,"No active_user was found in Browse.init",true,[],false);this.unselectable();this.listen();y.viewport_dimensions();if(bB.chrome){this.browser_supports_previews=ev&&ds.pdf_plugins().length}else{this.browser_supports_previews=ev}if(cj.get_viewer().is_paired){c2.set_role(this.active_user.role)}this.subscribe_sfj_callbacks={};this.compiled_search_tmpl=es.tmpl("search_list_item_tmpl");return this.add_visible_change_callback((function(eB){return function(){return eB.show_sharing_on_browse_exp()}})(this))},setup:function(ev,eA){var ez,ey,ex,T,ew;if(eA==null){eA=null}this.ns_id_to_mount_point=ev.ns_id_to_mount_point;this.old_path_to_ns_id=ev.old_path_to_ns_id;this.compiled_tmpl=es.tmpl("list_item_tmpl");this.render_timeout=null;this.inside_dir=ev.inside_dir;this.inside_deleted_dir=ev.inside_deleted_dir;this.inside_shared_folder=ev.inside_shared_folder;this.inside_read_only_shared_folder=ev.inside_read_only_shared_folder;this.inside_sandbox=ev.inside_sandbox;this.public_app_token=ev.public_app_token;this.public_folder_enabled=ev.public_folder_enabled;this.inside_deleted_sandbox=ev.inside_deleted_sandbox;this.inside_deleted_shared_folder=ev.inside_deleted_shared_folder;this.inside_team_folder=ev.inside_team_folder;this.is_read_only=ev.is_read_only;this.ns_map=ev.ns_map;this.contents_cache_key=ev.contents_cache_key;ey="inside_deleted_dir";if(this.inside_deleted_dir){$("browse").addClassName(ey)}else{$("browse").removeClassName(ey)}this.block_hash=ev.block_hash;this.block_hash_param=ev.block_hash_param;if(this.inside_dir){$("advanced-search-box").hide();$("advanced-search-link").removeClassName("selected");this._containing_ns_id=ev.containing_ns_id;this._containing_ns_path=ev.containing_ns_path;this._containing_fq_path=ev.containing_fq_path;this._containing_mount_point=ev.containing_mount_point;this.breadcrumb();ew=[this.browse_actions,this.global_actions];for(ex=0,T=ew.length;ex<T;ex++){ez=ew[ex];if(ez!=null){ez.unlisten()}}this.browse_actions=new this.browse_actions_ctor();this.global_actions=new this.global_actions_ctor();if(!ev.file_info){this.show_message(dU('<h3>This folder is empty</h3> Add files using the <a href="/install">desktop application</a> or the upload button above.'))}}return this._push_files(ev.file_info,eA)},_push_files:function(ew,ez){var ev,ex,ey,T;if(ez==null){ez=null}for(ey=0,T=ew.length;ey<T;ey++){ex=ew[ey];ev=aO.make_browsefile(ex,ez);ev.track_in_browse()}return J.update()},_get_helper:function(T){ci(this.inside_dir,"accessed "+T+", but not inside a directory");return b2[T]},containing_ns_id:function(){return this._get_helper("_containing_ns_id")},containing_ns_path:function(){return this._get_helper("_containing_ns_path")},containing_fq_path:function(){return this._get_helper("_containing_fq_path")},containing_mount_point:function(){return this._get_helper("_containing_mount_point")},listen:function(){var eF,ex,eA,eI,ev,eD,eC,ez,eG,ew,T,eH,eE,eB,ey;bf("#fulltext-search-all-link").click(this.unscoped_search);bf("#noresults-search-all-link").click(this.unscoped_search);$("browse-files").on("click","li.browse-file",this.click.bind(this));$("browse-files").on("dblclick","li.browse-file",this.dblclick.bind(this));$("browse-files").on("contextmenu","li.browse-file",a1.show_for_file.bind(a1,this.browse_actions_context_ctor));this.enable_sorting();eA="#browse-sort a.sortable-column-header";ds.add_sort_arrow_mouseover($("name-sorter"),true,eA,false);Event.observe(window,"scroll",this.window_scroll.bind(this));Event.observe(window,"resize",this.updateOffset.bind(this));$(document.body).on("click","a.crumb",this.crumb_click.bind(this));$("browse-files").on("click","a.parent-dir",this.parent_click.bind(this));document.observe("contextmenu",a1.show_global.bind(a1,this.global_actions_context_ctor));document.observe(ee.UPDATED_EVT,this.selection_handler.bind(this));document.observe(av.COPY,(function(eJ){return function(eK){if(eJ.inside_dir&&eK.memo.to_fq_path===eJ.containing_fq_path()){return eJ.force_reload()}}})(this));eE=[av.MOVE,av.RESTORE,av.UPLOAD,av.SF_NEW,av.SF_REJOIN,av.SF_IGNORE,av.LINKS_REMOVE,av.LINKS_ADD];for(eD=0,eG=eE.length;eD<eG;eD++){ex=eE[eD];document.observe(ex,(function(eJ){return function(eK){if(eJ.inside_dir&&!(bJ.fulltext_search_enabled&&b2.in_search_mode())){return eJ.force_reload()}}})(this))}eB=[av.SF_LEAVE,av.SF_UNSHARE];for(eC=0,ew=eB.length;eC<ew;eC++){ex=eB[eC];document.observe(ex,(function(eJ){return function(eK){if(eJ.inside_dir){if(eK.memo.target_ns_id===eJ.containing_ns_id()){if(eK.memo.folder_deleted){return eJ.reload_fqpath("")}else{return eJ.reload_fqpath(eJ.containing_fq_path())}}else{return eJ.force_reload()}}}})(this))}ey=[av.DELETE,av.PURGE];for(ez=0,T=ey.length;ez<T;ez++){ex=ey[ez];document.observe(ex,(function(eJ){return function(eS){var eP,eR,eL,eQ,eK,eN,eO,eM;if(eJ.inside_dir){if(eS.eventName===av.PURGE||(eS.eventName===av.DELETE&&!aN.get_del())){for(eR=eQ=eO=eJ.files.length-1;eO<=0?eQ<=0:eQ>=0;eR=eO<=0?++eQ:--eQ){if(eS.memo.files.indexOf(eJ.files[eR])===-1){eL=eJ.files[eR]}else{break}}ee.deselect_all();eM=eS.memo.files;for(eN=0,eK=eM.length;eN<eK;eN++){eP=eM[eN];eP.get_div().remove();eJ.files.removeItem(eP)}if(eJ.files.length){if(eL!=null){return ee.set_selected_files(eL)}else{return ee.set_selected_files(eJ.files.last())}}else{return eJ.show_empty()}}else{if(eJ.keyboard_nav){eJ.select_fq_paths=[eJ.containing_fq_path()+"/"+eS.memo.files.last().filename]}if(ax.shown){return ax.reload=true}else{return eJ.force_reload()}}}}})(this))}document.observe(a1.SHOW_EVT,this.disable_sorting.bind(this));document.observe(a1.HIDE_EVT,this.enable_sorting.bind(this));eH=function(){var eK,eJ;eK=$("browse-header");eJ=eK.cumulativeOffset().top+eK.getHeight();return y.viewport_dimensions().height-eJ};key("pagedown",this.KEY_SCOPE,(function(eJ){return function(eK){Event.extend(eK).preventDefault();return window.scrollBy(0,eH())}})(this));key("pageup",this.KEY_SCOPE,(function(eJ){return function(eK){Event.extend(eK).preventDefault();return window.scrollBy(0,-1*eH())}})(this));eI=function(){var eJ;eJ=b2.in_search_mode()?bJ:b2;if(b2.files.length===0){return eJ.show_empty()}else{return eJ.hide_empty()}};document.observe(be.ADD,(function(eJ){return function(eM){var eL,eK,eO,eN;eN=eM.memo.files;for(eK=0,eO=eN.length;eK<eO;eK++){eL=eN[eK];eJ.insert_file(eL,true)}return eI()}})(this));document.observe(be.REMOVE,(function(eJ){return function(eM){var eL,eK,eO,eN;eN=eM.memo.files;for(eK=0,eO=eN.length;eK<eO;eK++){eL=eN[eK];eJ.remove_file(eL)}return eI()}})(this));document.observe(be.MOVE,(function(eJ){return function(eQ){var eS,eP,eR,eT,eN,eK,eM,eL,eO;eP=eJ.in_search_mode()&&bJ.fulltext_search_enabled;eM=eQ.memo.files;eO=[];for(eN=0,eK=eM.length;eN<eK;eN++){eL=eM[eN],eS=eL[0],eT=eL[1];if(eP){if(eS!=null){eR=eJ.get_file_pos(eS)}else{continue}}eJ.remove_file(eS);eJ.insert_file(eT);if(eP&&eR>=0){eO.push(eJ.update_file_pos(eT,eR))}else{eO.push(void 0)}}return eO}})(this));eF=this.fire_visible_change_callbacks.bind(this);bf(window).on("resize",eF);this._last_visible_change_timeout_id=null;ev=(function(eJ){return function(eK){clearTimeout(eJ._last_visible_change_timeout_id);return eJ._last_visible_change_timeout_id=setTimeout(eF,250)}})(this);return bf(window).on("scroll",ev)},add_subscribe_sfj_callback:function(T){return this.subscribe_sfj_callbacks[this.subsribe_sfj_count]=T},remove_sfj_callback:function(T){return delete this.subscribe_sfj_callbacks[T]},disable_sorting:function(){$("browse-sort").stopObserving("click");return $$("#browse-sort *").invoke("setStyle",{cursor:"default"})},enable_sorting:function(){$("browse-sort").stopObserving("click");$("browse-sort").on("click","#browse-sort a.sortable-column-header",this.sort_handler.bind(this));return $$("#browse-sort *").invoke("setStyle",{cursor:"pointer"})},click:function(ew,ey){var T,ex,ev;ev=$(ew.target);if(ev.match("a.filename-link")||ev.match("img.icon")||ev.up("a.filename-link")){this._click(ew,ey)}if(ev.match("a.parent-dir")){T=co.from_elem(ey);if(T){ex={file_nsid:T.ns_id,file_sjid:T.sjid,firefly:bJ.fulltext_search_enabled,match_type:T.match_type,position:T.sort_rank,request_id:T.request_id,viewport:"full-view",action_type:"click_path_link"};return aQ.SearchClientActivityLogger.log("result_action",b2.active_user.id,ex)}}},dblclick:function(T,ev){if($(T.target).match("a")){return}return this._click(T,ev)},open_file:function(ex,T,ev){var ey,eA,ew,ez;if(ev==null){ev=false}ew={mode:"get",file_ext:an.file_extension_for_logging(ex.filename),file_bytes:ex.bytes};eA={file_nsid:ex.ns_id,file_sjid:ex.sjid,firefly:bJ.fulltext_search_enabled,match_type:ex.match_type,position:ex.sort_rank,request_id:ex.request_id,viewport:ev?"dropdown-view":"full-view"};if(ex.dir){if(this.in_search_mode()||ev){eA.action_type="folder_open";aQ.SearchClientActivityLogger.log("result_action",b2.active_user.id,eA)}if(T){return this.open_folder_in_new_window(ex)}else{return this.open_folder(ex)}}else{if(!T&&!((ex.preview_type==="video")&&Constants.DISABLE_VIDEOS_IN_LIGHTBOX)){if(this.browser_supports_previews||((ez=ex.preview_type)==="photo"||ez==="video")){if(this.in_search_mode()||ev){eA.action_type="file_view";aQ.SearchClientActivityLogger.log("result_action",b2.active_user.id,eA)}return this.open_preview(ex,ey=true,ev)}else{if(this.in_search_mode()||ev){eA.action_type="file_view";aQ.SearchClientActivityLogger.log("result_action",b2.active_user.id,eA)}aQ.UserActivityLogger.log("web","file_view",ew);return window.open(ex.href,"_blank")}}else{if(this.in_search_mode()||ev){eA.action_type="file_view";aQ.SearchClientActivityLogger.log("result_action",b2.active_user.id,eA)}aQ.UserActivityLogger.log("web","file_view",ew);return window.open(ex.href,"_blank")}}},close_preview_callback:function(){bf(document).off("db:filepreview:close",this.close_preview_callback);document.stopObserving(ax.EXIT_SELECT_EVT,this.close_preview_callback);aa.close_shared_link_view();return b2.set_title()},open_preview:function(ew,ex,ev){var T,ez,ey;if(ex==null){ex=false}if(ev==null){ev=false}ez=ew.preview_type==="video"&&Constants.DISABLE_VIDEOS_IN_LIGHTBOX;T=this.browser_supports_previews||((ey=ew.preview_type)==="photo"||ey==="video");if(!ez&&T){aO.filepreview_from_selected("fileclick",ew,!ex,ev,ev);bf(document).on("db:filepreview:close",this.close_preview_callback);return document.observe(ax.EXIT_SELECT_EVT,this.close_preview_callback)}},_click:function(ew,ex){var ev,T;this.keyboard_nav=false;ev=co.from_elem(ex);if(ev.editing){return}T=(ew.which===2)||(ds.is_mac()&&ew.metaKey);b2.open_file(ev,T);ew.preventDefault()},crumb_click:function(ex,T){var ew,ev;this.keyboard_nav=false;ex.preventDefault();ev=T.readAttribute("data-fq_path");ew=this.details_from_fq_path(ev);return aN.set_path_url(ew.ns_id,ew.ns_path)},parent_click:function(ey,ex){var ew,ez,T,ev;this.keyboard_nav=false;ey.preventDefault();ev=ex.readAttribute("data-parent_ns_path");T=parseInt(ex.readAttribute("data-parent_ns_id"),10);aN.set_path_url(T,ev);ew=co.from_elem(ex);if(ew){ez={file_nsid:ew.ns_id,file_sjid:ew.sjid,firefly:bJ.fulltext_search_enabled,match_type:ew.match_type,position:ew.sort_rank,request_id:ew.request_id,viewport:"full-view",action_type:"click_path_link"};return aQ.SearchClientActivityLogger.log("result_action",b2.active_user.id,ez)}},selection_handler:function(){if(ee.get_selected_files().length){return $("browse-box").addClassName("selected")}else{return $("browse-box").removeClassName("selected")}},POST_SCROLL_WAIT:100,_last_scroll_timeout:null,window_scroll:function(){var T,ev,ex,ew;if(bJ.fulltext_search_enabled&&this.in_search_mode()&&!bJ.end_of_results){ew=aO.get_files_in_view(),ex=ew[0],ev=ew[1];T=this.files.length-(ex+ev);if(T<=50&&!$("browse").hasClassName("pending-search")){bJ.load_more_results()}}clearTimeout(this._last_scroll_timeout);return this._last_scroll_timeout=setTimeout(aO.load_visible_thumbs.bind(aO),this.POST_SCROLL_WAIT)},unscoped_search:function(){return bJ.search(false)},updateOffset:function(){if(!this.div_parent){return}this._cumulativeOffset=this.div_parent.cumulativeOffset();return this.viewportOffset()},reset_sort:function(){var ev,T;this.last_sort=[a4.FILES_BY_NAME,true];T="#browse-sort a.sortable-column-header";ev=$$(T)[0];ds.add_sort_arrow_mouseover(ev,true,T,false);$("kind-sorter-label").__date(cP.DISPLAY.FILES_BY_KIND);return b6.src(ev.down("img"),"web","arrow-up-gray")},sort_handler:function(eA,eB,ex){var ey,T,ez,ev,eC,ew;eB=$(eB);eB.blur();ey=eB.readAttribute("data-sort");if(ex==null){ex=this.last_sort[0]===a4[ey]?eB.readAttribute("data-ascending")==="false":true}if(cP.LABELS.indexOf(ey)!==-1){eC=cP.SORT_FUNCTIONS.indexOf(this.last_sort[0])!==-1;if(eC){ez=(cP.LABELS.indexOf(ey)+1)%cP.LABELS.length;ey=cP.LABELS[ez];T=cP.DISPLAY[ey];$("kind-sorter-label").__date(T)}eB.writeAttribute("data-sort",ey);ex=cP.IS_ASC[ey]}else{eB.writeAttribute("data-ascending",(ex?"true":"false"))}ew="#browse-sort a.sortable-column-header";ds.add_sort_arrow_mouseover(eB,ex,ew,true);ev=a4[ey];this.sort(ev,ex);if(eA){return eA.stop()}},toggle_deleted:function(){var T;T=!aN.get_del();return aN.set_del_url(T)},new_folder:function(){var ew,ex,eK,eC,ev,ez,eD,eJ,T,ey,eF,eI,eE,eH,eA,eG,eB;if(this.reloading||this.creating_folder){return}this.hide_empty();this.selectable();ex=dU("New folder");ev=[];eB=this.files;for(eA=0,eG=eB.length;eA<eG;eA++){ez=eB[eA];if(ez.dir&&ez.filename.indexOf(ex)!==-1){ev.push(ez.filename)}}eJ=ex;ew=1;while(true){if(ev.indexOf(eJ)===-1){break}eJ=ex+" ("+ew+")";ew++}eH=es.tmpl("new_folder_tmpl",{name:eJ,Sprite:b6,_:dU});eD=-1;if(this.files.length){eE=y.scroll_offsets();if(eE.top>0){eI=this.files[0].get_div().getLayout().get("margin-box-height");eD=Math.floor(eE.top/eI)}}if(eD>0){this.files[eD].get_div().__sert({after:eH})}else{$("browse-files").__sert({top:eH})}T=$$("#browse-files .browse-new-folder .name").first();ci(T!=null,"expected new_folder_name to be defined");eK=this.containing_fq_path();eF=(function(eL){return function(eO){var eN,eM,eP;eP=eO.responseText.evalJSON(true);ci(eP.new_browse_files.length===1,"No new file data returned.");eN=an.filename(eP.new_browse_files.first().fq_path);eM=dU("Created folder '%(folder_name)s'");eM=eM.format({folder_name:bt.em_snippet(eN,25)});Y.success(eM);eL.select_fq_paths=[eP.new_browse_files.first().fq_path];return eL.force_reload()}})(this);ey=(function(eL){return function(eN){var eM;eM=$$("#browse-files li.browse-new-folder").first();if(eM){eM.remove()}return eL.creating_folder=false}})(this);eC=new Ajax.InPlaceEditor(T,"/cmd/new"+(ds.urlquote(eK)),{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,onFailure:function(){},onComplete:ey,savingText:dU("Creating folder..."),onLeaveEditMode:this.unselectable,ajaxOptions:{method:"POST",onSuccess:eF,subject_user:b2.active_user},callback:(function(eL){return function(eM,eN){eL.creating_folder=true;return{to_path:eN||"",folder:"yes"}}})(this)});return eC.enterEditMode()},open_folder:function(ev){var ex,T,ew;ci(ev.dir,"Only open directories, not files");if(b2.inside_dir&&b2.containing_ns_path()===ev.ns_path&&!(this.in_search_mode()&&bJ.fulltext_search_enabled)){return}if(!(ee.get_selected_files().length===1&&ee.get_selected_files().indexOf(ev)===0)){ee.deselect_all();ex=ev.get_div();if(ex){ex.addClassName("file-select")}}clearTimeout(this.folder_loading_timeout);this.folder_loading_timeout=setTimeout((function(ey){return function(){var ez;ez=dU("Loading %(filename)s...");ez=ez.format({filename:bt.em_snippet(ev.filename,50)});return ey.folder_loading_notification=Y.success(ez,60,true)}})(this),1000);if(ev.target_ns){T=ev.target_ns;ew=""}else{T=ev.ns_id;ew=ev.ns_path}if(ev.is_deleted){return aN.set_path_url(T,ew,true)}else{return aN.set_path_url(T,ew)}},open_folder_in_new_window:function(T){return window.open(aN._make_url(T.ns_id,T.ns_path),"_blank")},show_message:function(ew){var ev,T;if((typeof ew)!==(typeof"string")){T=$("browse-files").down(".browse-message");if(T){T.show()}return}this.msg=ew;ev=new Element("div",{"class":"browse-message"});ev.__date(ew);return $("browse-files").__sert(ev)},sort:function(T,ex,ew){var ev;if(!ew&&T===this.last_sort[0]&&ex===this.last_sort[1]){return}this.last_sort=[T,ex];ev=T(ex);this.files.sort(ev);this.smartfill();aO.load_visible_thumbs();return this.fire_visible_change_callbacks()},resort:function(){var ew,T,ev;T=this.last_sort;ev=T[0];ew=T[1];return this.sort(ev,ew,true)},in_search_mode:function(){return $("browse").hasClassName("search")},flex_column:function(){return $("kind-sorter").readAttribute("data-sort")},smartfill:function(){var ev,ey,ew,ez,ex,eB,T,eA;ev=$("browse-files");ex=[];ez=this.in_search_mode();eA=this.files;for(eB=0,T=eA.length;eB<T;eB++){ey=eA[eB];ew=this.flex_column();ex.push(this.compiled_tmpl({file:ey,in_search_mode:ez,flex_column:ew,sharing_growth_experiments_variant:b2.sharing_growth_experiments_variant,share_link_icon_src:aO.get_shared_link_icon(),Browse:b2,Sprite:b6,Constants:Constants,FilePath:an,Emstring:bt,_:dU}))}ev.__date(ex);document.fire(this.RENDER_EVT);return bf(document).trigger(this.RENDER_EVT)},search_smartfill:function(eC,ew){var T,eB,ez,ev,ey,ex,eA;if(ew==null){ew=null}ey=[];for(ex=0,eA=eC.length;ex<eA;ex++){eB=eC[ex];ev=aO.make_browsefile(eB,ew);ev.track_in_browse();ez=this.compiled_search_tmpl({file:ev,sharing_growth_experiments_variant:b2.sharing_growth_experiments_variant,share_link_icon_src:aO.get_shared_link_icon(),BrowseInterface:eu,Browse:b2,Sprite:b6,Constants:Constants,_:dU,Search:__CIRCULAR_DEPENDENCY__.Search,HTML:es,FilePath:an,Emstring:bt,Util:ds});T=bf(ez.toHTML());ey.push(T)}bf("#browse-files").append(ey);document.fire(this.RENDER_EVT);bf(document).trigger(this.RENDER_EVT);aO.load_visible_thumbs();return this.fire_visible_change_callbacks()},add_file:function(T){this.files.push(T);if(T.target_ns){b2.ns_id_to_mount_point[T.target_ns]=T.fq_path}if(T.bytes<0){return this.deleted_shown=true}},insert_file:function(ew,ev){var T;if(!ew){return}ev=ev||0;T=this.find_file(ew.fq_path);if(T&&T!==ew){this.remove_file(T)}co._file_index[ew.to_key()]=ew;this.update_file_pos(ew);if(ev){ew.get_div().setStyle({display:"none"})}return document.fire(this.RENDER_EVT)},add_files:function(T){return b2._push_files(T.file_info)},get_file_pos:function(T){var ev;ev=this.files.indexOf(T);ci(ev!==-1,"file not present in @files");ci(T.to_key() in co._file_index,"file not present in BrowseFile._file_index");return ev},remove_file:function(T){var ew,ev;if(!T){return}ew=this.files.indexOf(T);if(ew!==-1){this.files.splice(ew,1);delete co._file_index[T.to_key()];return(ev=T.get_div())!=null?ev.remove():void 0}},update_file_pos:function(ez,eB){var T,eD,ex,ey,eA,ew,ev,eC;if(eB==null){eB=-1}eC=this.files.indexOf(ez);if(eC!==-1){this.files.splice(eC,1)}delete ez.sort_rank;ew=this.last_sort[0];eA=this.last_sort[1];if(eB>=0){eC=eB}ey=this.in_search_mode()&&bJ.fulltext_search_enabled?eC:ds.bsearch(this.files,ez,ew(eA),true);this.files.splice(ey,0,ez);ex=ez.get_div();T=$("browse-files");if(ex){ex.remove()}if(this.in_search_mode()&&bJ.fulltext_search_enabled){ev=this.compiled_search_tmpl({file:ez,Browse:b2,BrowseInterface:eu,Constants:Constants,Emstring:bt,FilePath:an,HTML:es,Search:__CIRCULAR_DEPENDENCY__.Search,Sprite:b6,Util:ds,_:dU})}else{ev=this.compiled_tmpl({file:ez,in_search_mode:this.in_search_mode(),flex_column:this.flex_column(),sharing_growth_experiments_variant:b2.sharing_growth_experiments_variant,share_link_icon_src:aO.get_shared_link_icon(),Browse:b2,Constants:Constants,Emstring:bt,FilePath:an,Sprite:b6,_:dU})}eD=T.childElements();if(ey<eD.length){return T.childElements()[ey].__sert({before:ev})}else{return T.__sert(ev)}},find_file:function(T){return this.files.find(function(ev){return ev.fq_path.toLowerCase()===T.toLowerCase()})},reset_state:function(){this.msg=false;this.dragging=false;this.files=[];this.selected_files=[];this.selection=[];co._file_index={};return bq._body_dragend()},clear:function(){$("browse-files").__date();this.hide_empty();return bJ.hide_empty()},show_empty:function(){var T;this.hide_empty();if(bf("#browse-empty-team-folder").length&&this.inside_team_folder&&!this.is_in_subfolder_of_team_folder()){T="#browse-empty-team-folder"}else{T="#browse-empty"}bf(""+T+" .drag-prompt").toggle(!this.is_read_only);if(!(b2.in_search_mode()&&bJ.fulltext_search_enabled)){return bf(T).show()}},hide_empty:function(){return bf("#browse-empty, #browse-empty-team-folder").hide()},update:function(T,ev){if(ev==null){ev=null}$("browse-box").show();if(bJ.fulltext_search_enabled&&this.in_search_mode()){return this.search_smartfill(T.file_info,ev)}else{this.clear();if(typeof T==="string"){T=JSON.parse(T)}this.setup(T,ev);this.resort();document.fire(this.UPDATE_EVT);return bf(document).trigger(this.UPDATE_EVT)}},show_sharing_on_browse_exp:function(){var ex,ev,T,eC,ez,ew,eB,eE,eD,eA,ey;if(b2.growth_browse_experiment_rule!=="sharing-on-browse-experiment"){return}ez=(eD=b2.growth_browse_experiment_variant)==="SHARERS"||eD==="BOTH";ev=(eA=b2.growth_browse_experiment_variant)==="INLINE_SHARE"||eA==="BOTH";if(!(ez||ev)){return}if(this.in_search_mode()){bf("#browse-box").removeClass("show-sharers").removeClass("show-inline-share");return}if(ez){bf("#browse-box").addClass("show-sharers")}if(ev){bf("#browse-box").addClass("show-inline-share")}if(ev){ey=b2.files;for(eB=0,eE=ey.length;eB<eE;eB++){ex=ey[eB];ew=bf(ex.get_div()).find(".sharing");ew.find(".recipients").off().on("click",ee.recipients_click);if((ex.is_shared_folder()||ex.could_be_shared_folder())&&!(ex.read_only||ex.is_read_only_mount)){T=dU("Who do you want to collaborate on this folder with?")}else{if(ex.type===bH.FOLDER){T=dU("Who do you want to send this folder to?")}else{T=dU("Who do you want to send this file to?")}}ew.find(".recipients").attr("placeholder",T);ew.find(".get-link").off().on("click",ee.link_click)}if(!this.show_sharing_init_done){this.show_sharing_init_done=true;aJ.init()}}if(!ez){return}eC=(function(eF){return function(){var eI,eJ,eH,eK,eG;eK=b2.files;eG=[];for(eJ=0,eH=eK.length;eJ<eH;eJ++){ex=eK[eJ];eI=bf(ex.get_div()).find(".sharing .sharers");if(ex.is_shared_folder()&&ex.href in eF.file_to_sharers){ez=eF.file_to_sharers[ex.href];eG.push(eI.removeClass("no-sharers").text(ez))}else{eG.push(eI.text("--"))}}return eG}})(this);if(this.file_to_sharers!=null){return eC()}else{return cb.WebRequest({url:"/share_ajax/list_folders",dataType:"json",success:(function(eF){return function(eK){var eM,eO,eH,eL,eN,eI,eJ,eG;eM=eK.current;eF.file_to_sharers={};for(eJ=0,eG=eM.length;eJ<eG;eJ++){eH=eM[eJ];eN=eH.other_names;eO=[];eI=0;eL=0;while(eL<eN.length&&eI+eN[eL].length<30){eO.push(eN[eL]);eI+=eN[eL].length;eL++}if(eN.length>eO.length){eO.push("+"+(eN.length-eO.length))}if(eO.length>0){eF.file_to_sharers[eH.href]=eO.join(", ")}}return eC()}})(this)})}},update_file_to_sharers:function(ev,T){if(this.file_to_sharers!=null){return this.file_to_sharers[ev.href]=T}},reset_browse_exp:function(){var T;T=bf("#browse-inline-autocomplete");T.hide().off();bf("#browse-sort").append(T);return bf("#browse-box").removeClass("dropdown-menu-open")},reload_fqpath:function(ev,T){return this.reload(null,ds.urlquote(ev),T)},force_reload:function(){return this.reload(this.containing_ns_id(),ds.urlquote(this.containing_ns_path()),true)},set_title:function(){var T;if(b2.in_search_mode()){bJ.set_title();return}if(!b2.inside_dir){return}T=this.containing_fq_path();return document.title=T?an.filename(T)+" - Dropbox":cj.get_viewer().is_paired&&b2.active_user.role===Constants.ROLE_WORK?cj.get_viewer().team_name+" - Dropbox":cj.get_viewer().is_paired&&b2.active_user.role===Constants.ROLE_PERSONAL?dU("Personal")+" - Dropbox":dU("Home")+" - Dropbox"},set_selection_from_fq_paths_or_index:function(eC){var ew,ev,eA,ez,T,ex,ey,eB;T=eC.select_fq_paths;ex=eC.select_index;if(T||ex>-1){ev=[];if(T){for(ey=0,eB=T.length;ey<eB;ey++){eA=T[ey];ez=this.find_file(eA);if(ez){ev.push(ez)}}}if(!ev.length&&ex>-1){ew=this.files[ex];if(ew){ev.push(ew)}}if(ev.length){ee.set_selected_files(ev);this.scrollToWithPadding(ev.first().get_div(),100)}eC.select_fq_paths=false;return eC.select_index=-1}else{if(!bJ.fulltext_search_enabled){return window.scrollTo(0,0)}}},set_selection_from_item_counters:function(){var ev,eB,ey,eD,ez,ex,eC,T,eA,ew;if(this.select_item_counters!=null){ey={};eA=this.select_item_counters;for(ez=0,eC=eA.length;ez<eC;ez++){eB=eA[ez];ey[eB]=true}eD=[];ew=this.files;for(ex=0,T=ew.length;ex<T;ex++){ev=ew[ex];if(ev.root_coll_item_counter in ey){eD.push(ev)}}ee.set_selected_files(eD);return this.select_item_counters=null}},reload:function(ex,eC,ev){var eE,ey,eD,ew,eA,ez,eB,T;ew="Browse.reload ns_path contains an invalid character: # ; ? : @ & = + $ (ns_path = "+eC+")";ci(eC.search(dX.URL_ESCAPE_REGEX)===-1,ew);if(ex==null){ex=b2.active_user.root_ns}eC=an.normalize(eC);if(aO.get_mode()!==aO.BROWSE_MODE){this.clear();aO.set_browse_mode()}if(bJ._clear_on_reload){bJ.clear_searchbox()}if(!ah.uploading){cw.hide()}if(this.reloading){return}if(this.inside_dir&&eC===this.containing_ns_path()&&ex===this.containing_ns_id()&&!ev){return}eB=this.first_load?Constants.referrer:"";eD=this.deleted_shown?"?show_deleted=yes":"";ez={ns_id:ex,referrer:eB,delays_parent_request_rendering:this.first_load};ez=Object.extend(ez,this.extra_reload_args);d0("Browse.reload:",eC);this.reloading=true;T="/browse"+eC+eD;eE=2;ey=["browse",ex,eC,eD,b2.active_user.id,eE];eA=(function(eF){return function(eG){eF.reset_state();eF.update(eG);(eF.files.length?eF.hide_empty.bind(eF):eF.show_empty.bind(eF))();clearTimeout(eF.folder_loading_timeout);if(Y.isShown()&&Y.current()===eF.folder_loading_notification){Y.clear()}y.scroll_clear_cache();eF.set_selection_from_fq_paths_or_index(b2);if(!l.shown()){return eF.set_title()}}})(this);new Ajax.DBRequest(T,{allow_retries:true,subject_user:b2.active_user,parameters:ez,log_timing:true,on304:(function(eF){return function(eG){}})(this),onSuccess:(function(eF){return function(eK){var eN,eJ,eH,eM,eI,eL,eG;if(eF.in_search_mode()){return}eJ=JSON.parse(eK.responseText);eI=null;eM=null;eA(eJ);if(eI){eH=[];for(eL=0,eG=eI.length;eL<eG;eL++){eN=eI[eL];eH.push(b2.find_file(eN.fq_path))}ee.set_selected_files(eH);return window.scrollTo(eM[0],eM[1])}else{return b2.set_selection_from_item_counters()}}})(this),onFailure:(function(eF){return function(){ax.update_with_error();if(eF.first_load){eF.reload.bind(eF).defer(Constants.root_ns,"")}return clearTimeout(eF.folder_loading_timeout)}})(this),cleanUp:(function(eF){return function(){eF.first_load=false;return eF.reloading=false}})(this),no_feed_reload:true,evalJSON:false});return true},is_in_subfolder_of_shared_folder:function(){return b2.inside_shared_folder&&b2.containing_ns_path()},is_in_subfolder_of_team_folder:function(){return b2.inside_team_folder&&b2.containing_ns_path()},is_shmodelable_path:function(T){var ev;if(b2.public_app_token){return false}if(T===""){return false}if(b2.public_folder_enabled){ev=T.toLowerCase();if(ev.startsWith("/public/")){return false}}return true},can_get_details_from_fq_path:function(ew){var ev,T;ev=this.containing_fq_path();T=this.containing_mount_point();return(T&&ew.startsWith(T))||ev.startsWith(ew)},details_from_fq_path:function(ex){var ey,ev,T,ew;ci(this.can_get_details_from_fq_path(ex));ev=this.containing_mount_point();if(ev&&ex.startsWith(ev)){T=this.containing_ns_id();ew=ex.slice(ev.length);ey=an.filename(ex,this._get_root_name())}else{T=Constants.root_ns;ew=ex;ey=an.filename(ex,this._get_root_name())}return{ns_id:T,ns_path:ew,fq_path:ex,folder_name:ey||this._get_root_name(),url:String(eu.browse_uri_for_fq_path(b2.active_user,ex)),icon:(ex.length?"folder_32":this._get_root_icon())}},update_header_status:function(T){return bf("#browse-header-status").text(T)},_make_breadcrumbs_data:function(){var ez,eA,ev,ey,T,ex,ew;eA=this.containing_fq_path();ez=[];T=eA.split("/");for(ev=ex=0,ew=T.length;0<=ew?ex<ew:ex>ew;ev=0<=ew?++ex:--ex){ey=an.normalize(T.slice(0,ev+1).join("/"));ez.push(this.details_from_fq_path(ey))}return ez},_get_root_icon:function(){if(!cj.get_viewer().is_paired){return"glyph"}if(b2.active_user.role===Constants.ROLE_WORK){return"work_icon"}else{if(b2.active_user.role===Constants.ROLE_PERSONAL){return"personal_icon"}}},_get_root_name:function(){return cj.get_root_name(b2.active_user)},_get_max_breadcrumb_width:function(ex){var ev,ew,T;ew=ex?this._DROPDOWN_WIDTH:new bt(this._get_root_name()).length;if(this.use_shorter_breadcrumbs){ev=bf("#browse-rightmenu").width();T=bf("#browse-global-actions-bar").width();return((T-ev)*this._FUDGE_FACTOR/this._PX_TO_EM)-ew}else{return this._MAX_BREADCRUMB_WIDTH-ew}},_PX_TO_EM:16,_FUDGE_FACTOR:0.75,_DROPDOWN_WIDTH:2.625,_MAX_BREADCRUMB_WIDTH:20,_CONNECT_WIDTH:1.64,breadcrumb:function(){var eD,ev,ex,eE,eA,eC,T,eF,eB,ew,ey,ez;ev=this._make_breadcrumbs_data();ew=ev.collect(function(eG){return new bt(eG.fq_path?eG.folder_name:"").length});eB=0;ex=0;ci(ev.length>0,"expected at least one breadcrumb");eF=this._get_max_breadcrumb_width();for(eA=ey=ez=ev.length-1;ez<=0?ey<=0:ey>=0;eA=ez<=0?++ey:--ey){eB+=ew[eA];if(eB>eF){break}ex+=1;eB+=this._CONNECT_WIDTH}eE=ev.slice(0,ev.length-Math.max(1,ex));ev=ev.slice(eE.length,ev.length);if(!eE.length&&ev.length>1){ev.shift()}eC=ev.pop();eD=es.tmpl("breadcrumb_tmpl",{breadcrumbs:ev,dropdown:eE,containing_fq_path:this.containing_fq_path(),url_root:eu.get_browse_root(b2.active_user),root_name:this._get_root_name(),Sprite:b6});T=eC.folder_name;if(eC.fq_path!==""){T=bt.em_snippet(T,this._get_max_breadcrumb_width(eE.length>1))}$("browse-location").__date(eD);$("browse-location").__sert(" "+T);if(eE.length>1){return this._render_breadcrumbs_dropdown(eE)}},_render_breadcrumbs_dropdown:function(ey){var T,ew,ev,ex;T=$("breadcrumbs-box");ey.reverse();ev=es.tmpl("breadcrumb_li_tmpl",{breadcrumbs:ey,Sprite:b6,Emstring:bt});$("browse-location").__sert(ev);ew=$("breadcrumb-dropdown");ex=(function(ez){return function(eB){var eA;eB.stopPropagation();ew.show();eA=bf(T);return bf(ew).clonePosition(eA,{setWidth:0,setHeight:0,offsetTop:eA[0].offsetHeight,offsetLeft:parseInt(eA.css("padding-left"),10)})}})(this);T.observe("click",ex);T.observe("dragover",ex);return document.observe("click",(function(ez){return function(){T.removeClassName("down");return ew.hide()}})(this))},viewportOffset:function(){var T,ew,ev;if(!this.files.length){return}if(!this.div_parent){ew=this.files[0].get_div().offsetParent;if(!ew){return}this._viewportOffset={};this.div_parent=$(ew);this._cumulativeOffset=this.div_parent.cumulativeOffset()}T=ds.scrollLeft(this.div_parent);ev=ds.scrollTop(this.div_parent);if(!this.scrollTop||!this.scrollLeft||this.scrollTop!==ev||this.scrollLeft!==T){this._viewportOffset.top=this._cumulativeOffset.top-ev;this._viewportOffset.left=this._cumulativeOffset.left-T;this.scrollLeft=T;this.scrollTop=ev}return this._viewportOffset},selectable:function(){return ds.enableSelection($("browse-files"))},unselectable:function(){return ds.disableSelection($("browse-files"))},_header_offset:(function(){var T;T=$("browse-header");return T.getHeight()+T.cumulativeOffset().top}).cached(1000),scrollTo:function(T){return this.scrollToWithPadding(T,3)},scrollToWithPadding:function(ex,ez){var ew,eA,ev,ey,T;if(!ex){return}ey=y.viewport_dimensions();T=y.scroll_offsets();eA=ex.cumulativeOffset().top-T.top;ew=ex.getHeight();ev=this._header_offset();if(eA<ev){y.scroll_to(0,T.top+eA-ev-ez)}else{if(eA+ew>ey.height){y.scroll_to(0,T.top+eA+ew-ey.height+ez)}}if($("modal-overlay").visible()&&$("modal").getStyle("position")==="absolute"){return ep.fix_position()}},_visible_change_callbacks:{},_next_visible_change_callback_id:0,add_visible_change_callback:function(T){this._visible_change_callbacks[this._next_visible_change_callback_id]=T;return this._next_visible_change_callback_id++},remove_visible_change_callback:function(T){return delete this._visible_change_callbacks[T]},fire_visible_change_callbacks:function(){var ew,eA,ex,ez,ey,T,ev;if(!bf.isEmptyObject(this._visible_change_callbacks)){ey=aO.get_files_in_view(),ez=ey[0],ew=ey[1];T=this._visible_change_callbacks;ev=[];for(ex in T){eA=T[ex];ev.push(eA(this.files,this.active_user.id,ez,ew))}return ev}}};j=A.BrowseUpdate=(function(){var T,eB,eA,ex,ez,ey,ew,ev;ew=function(eD){var eE,eF,eC;if(!b2.inside_dir){return}eF=eD.parent_changes;if(eF.change_to_fq_path!=null){if(eF.change_type==="moved"){if(eF.is_changing_view){eE=dU("The folder '%s' has been moved. <a href=\"/home%s\">View</a>");eE=eE.format(eF.old_fq_path.escapeHTML(),ds.urlquote(eF.new_fq_path))}else{eE=dU("This folder has been moved")}}else{if(eF.change_type==="renamed"){if(eF.is_changing_view){eE=dU("The folder '%s' has been renamed. <a href=\"/home%s\">View</a>");eE=eE.format(eF.old_fq_path.escapeHTML(),ds.urlquote(eF.new_fq_path))}else{eE=dU("This folder has been renamed to '%s'.");eC=eF.change_to_fq_path.split("/");eE=eE.format(eC[eC.length-1].escapeHTML())}}else{eE=dU("The folder '%s' has been deleted.");eE=eE.format(eF.old_fq_path.escapeHTML())}}if(eF.is_changing_view){Y.error(new es(eE))}else{if(eF.old_fq_path===b2.containing_fq_path()){Y.success(new es(eE))}}b2.reload_fqpath(eF.change_to_fq_path);return}return ey(eD)};ev=function(eH){var eD,eK,eJ,eC,eM,eI,eF,eL,eG,eE;eK=[];eI=[];if(!b2.in_search_mode()){return}bJ.clear_cache();for(eC in b2.ns_id_to_mount_point){if(!(eC in eH.mount_points)){eH.mount_points[eC]=null}}eG=eH.mount_points;for(eC in eG){eJ=eG[eC];eC=parseInt(eC,10);eM=b2.ns_id_to_mount_point[eC];if(eJ===eM){continue}if(eJ){b2.ns_id_to_mount_point[eC]=eJ}else{delete b2.ns_id_to_mount_point[eC]}eE=b2.files;for(eF=0,eL=eE.length;eF<eL;eF++){eD=eE[eF];if(eD.fq_path.indexOf(eM)===0&&eD.target_ns!==eC){if(eJ){eD.fq_path=eJ+eD.fq_path.slice(eM.length);eD.href=eu.get_browse_root(b2.active_user)+eJ+eD.href.slice(5+eM.length);eK.push([eD,eD])}else{eI.push(eD)}}}}return ey(eH,[],eI,eK)};ey=function(eZ,eK,eT,eJ){var eN,eI,eU,eO,eS,eP,eR,eQ,eW,eL,eF,eD,eC,eV,eY,eX,eM,eH,eG,eE;if(eK==null){eK=[]}if(eT==null){eT=[]}if(eJ==null){eJ=[]}eM=eZ.added;for(eF=0,eV=eM.length;eF<eV;eF++){eU=eM[eF];eI=an.normalize(an.parent_dir(eU.ns_path));if(b2.in_search_mode()||(eU.ns_id===b2.containing_ns_id()&&eI===b2.containing_ns_path())){eN=aO.make_browsefile(eU);eN.track_in_browse();eK.push(eN)}}eH=eZ.removed;for(eD=0,eY=eH.length;eD<eY;eD++){eO=eH[eD];eT.push(b2.find_file(eO))}eG=eZ.moved;for(eC=0,eX=eG.length;eC<eX;eC++){eE=eG[eC],eS=eE[0],eL=eE[1];eW=an.normalize(an.parent_dir(eL.ns_path));eQ=null;eR=b2.in_search_mode()||(eL.ns_id===b2.containing_ns_id()&&eW===b2.containing_ns_path());eP=b2.in_search_mode()&&bJ.fulltext_search_enabled;if(eR&&!(eP&&b2.find_file(eL.ns_path))){eQ=aO.make_browsefile(eL);eQ.track_in_browse()}eJ.push([b2.find_file(eS),eQ])}document.fire(be.ADD,{files:eK});bf(document).trigger(be.ADD,{files:eK});document.fire(be.MOVE,{files:eJ});aO.load_visible_thumbs();b2.fire_visible_change_callbacks();return ez(eK,eT,eJ)};T=function(eF,eD,eE,eC){eF.css("background","");bf(document).trigger("db:browse:update_rendered");return document.fire(be.REMOVE,{files:eE})};ez=function(eM,eL,eN){var eE,eP,eJ,eQ,eI,eH,eF,eO,eD,eC,eK,eG;eJ=(eM.length+eL.length)<=10;for(eI=0,eO=eM.length;eI<eO;eI++){eE=eM[eI];if(!(eE&&eE.get_div())){continue}eB(eE,eJ,eM,eL,eN)}for(eH=0,eD=eL.length;eH<eD;eH++){eE=eL[eH];if(!(eE&&eE.get_div())){continue}ex(eE,eJ,eM,eL,eN)}eG=[];for(eF=0,eC=eN.length;eF<eC;eF++){eK=eN[eF],eP=eK[0],eQ=eK[1];if(eP){ex(eP,eJ,eM,eL,eN)}if(eQ){eG.push(eB(eQ,eJ,eM,eL,eN))}else{eG.push(void 0)}}return eG};eA=function(eC){var eD;eD=ee.is_selected(eC)?"#83B8DC":"#CCEAFF";return bf(eC.get_div()).css("background-color",eD)};ex=function(eC,eF,eE,eG,eD){var eH;eA(eC);eH=bf(eC.get_div());if(eF){return eH.show().slideUp("normal",function(){return T(eH,eE,eG,eD)})}else{eH.hide();return T(eH,eE,eG,eD)}};eB=function(eC,eF,eE,eG,eD){var eH;eA(eC);eH=bf(eC.get_div());if(eF){return eH.hide().slideDown("normal",function(){return T(eH,eE,eG,eD)})}else{eH.show();return T(eH,eE,eG,eD)}};return{init:function(){var eE,eD,eC;eC=M[b2.active_user.id];eE=(function(eF){return function(){return ax.refresh_file_list(b2.files)}})(this);document.observe(b2.UPDATE_EVT,eE);return eD=eC.subscribe_sfj({name:"BrowseUpdater",handler:function(){var eN,eI,eK,eM,eJ,eO,eH,eG,eF,eL;eO=b2.in_search_mode();eN=eO?ev:ew;eF=eO?"/update/list_search":"/update/list_dir";if(!(b2.inside_dir||eO)){eC.handler_failure(eD);return}if(eO){eG=bJ.get_state();if(eG.is_advanced){eJ=eG}else{eJ={all_terms:eG.query}}}else{eJ={fq_dir:b2.containing_fq_path(),show_deleted:b2.deleted_shown}}eJ.ns_map=((function(){var eQ,eP;eQ=eC.get_ns_map();eP=[];for(eM in eQ){eH=eQ[eM];eP.push(""+eM+"_"+eH)}return eP})()).join(",");ci(b2.active_user,"No active_user was set before calling "+eF+". Active user loaded? "+(__CIRCULAR_DEPENDENCY__.active_user_loaded||false)+". Error before loading? "+(__CIRCULAR_DEPENDENCY__.an_error_happened_before_loading||false)+". Error after loading? "+(__CIRCULAR_DEPENDENCY__.an_error_happened_after_loading||false)+".",true,[],false);eL=b2.subscribe_sfj_callbacks;for(eK in eL){eI=eL[eK];eI()}return new bf.ajax(eF,{data:eJ,dataType:"json",type:"POST",subject_user:b2.active_user,success:(function(eP){return function(eQ){eN(eQ);return eC.handler_success(eD,{ns_map:eQ.ns_map})}})(this),error:function(){return eC.handler_failure(eD)}})}})}}})();var av;av=A.FileEvents={DELETE:"db:bulk_delete",COPY:"db:bulk_copy",MOVE:"db:bulk_move",RENAME:"db:bulk_rename",PURGE:"db:bulk_purge",RESTORE:"db:bulk_restore",UPLOAD:"db:upload",SF_NEW:"db:sf_new",SF_LEAVE:"db:sf_leave",SF_UNSHARE:"db:sf_unshare",SF_REJOIN:"db:sf_rejoin",SF_INVITE:"db:sf_invite",SF_IGNORE:"db:sf_ignore",LINKS_REMOVE:"db:link_remove",LINKS_ADD:"db:link_add"};var dy;dy=A.ProgressWatcher={job_info:{},INIT_POLL_INT:1000,FAILS_MEAN_FAIL:3,MODAL_WAIT_MS:1000,watch:function(T,ey){var ex,ew,ev;if(T.async_task_id){if(!T.async_task_id.match(/^[A-Za-z0-9_\-=]*$/)){return}ew=T.async_task_id}else{ew=T.job_id}dy.job_info[ew]={};ex=dy.job_info[ew];ex.subject_user=T.subject_user||((ev=T.parameters)!=null?ev[Constants.UID_PARAM_NAME]:void 0);ex.req=T;ex.is_async_task=!!T.async_task_id;ex.poll_int=dy.INIT_POLL_INT;ex.poll_count=0;ex.int_id=setInterval(dy.update_for(ew),ex.poll_int);ex.failures=0;ex.start_time=bE.time();return ex.dont_hide=ey},update_for:function(T){return function(){return dy.update(T)}},backoff:function(ev){var T;T=dy.job_info[ev];clearInterval(T.int_id);T.poll_int=Math.min(Math.floor(T.poll_int*1.5),30000);return T.int_id=setInterval(dy.update_for(ev),T.poll_int)},update:function(ew){var T,ev;ev=dy.job_info[ew];if(cK.peek(ew)){return dy.done(ew)}ev.poll_count++;if(ev.poll_count%10===0){dy.backoff(ew)}if(!ev.modaled&&bE.time()-ev.start_time>dy.MODAL_WAIT_MS){T=ev.req.options;dV.show(T.progress_text);T.onProgress=dV.update;if(T.on_modal_shown!=null){T.on_modal_shown()}ev.modaled=true}if(ev.is_async_task){return dy.get_async_task_status(ew)}else{return dy.get_job_status(ew)}},get_job_status:function(T){return new Ajax.DBRequest("/job_status/"+T,{method:"post",subject_user:dy.job_info[T].subject_user,onSuccess:function(ew){var ex,ev;ex=dy.job_info[T];ev=ew.responseText;if(ev.indexOf("err")===0){dy.done(T);if(ex.req.options.onFailure&&!cK.handled(T)){ex.req.options.onFailure(ew)}return}if(ev.indexOf("done")===0){ex.req.options.job=false;if(!cK.peek(T)){new Ajax.Request("/job_results/"+T,{method:"post",parameters:{t:a8.read(Constants.JS_CSRF_COOKIE)},onSuccess:function(ez){if(cK.handled(T)){return}ai.clearWorkingMessage();if(ex.req.options.onSuccess){return ex.req.options.onSuccess(ez)}},onFailure:function(ez){if(cK.handled(T)){return}ai.clearWorkingMessage();if(ex.req.options.onFailure){return ex.req.options.onFailure(ez)}}})}return dy.done(T)}else{try{if(ex.req.options.onProgress){return ex.req.options.onProgress(ew.responseText)}}catch(ey){}}},onFailure:function(ev){var ew;ew=dy.job_info[T];ew.failures++;if(ew.failures>=dy.FAILS_MEAN_FAIL){if(ew.req.options.onFailure){ew.req.options.onFailure(ev,true)}ai.remove(ew.req);return dy.done(T)}}})},get_async_task_status:function(T){return new Ajax.DBRequest("/async_task_status/"+T,{method:"post",subject_user:dy.job_info[T].subject_user,onSuccess:function(ew){var ex,ev;ex=dy.job_info[T];ev=ew.responseText;if(ev.indexOf("done:")===0||ev.indexOf("err:")===0){cK.handled(T);ai.clearWorkingMessage();if(ev.indexOf("done:")===0){ew.responseText=ev.substr(5)}if(ex.req.options.onSuccess){ex.req.options.onSuccess(ew)}if(ex.req.options.onComplete){ex.req.options.onComplete(ew)}return dy.done(T)}else{if(ev.indexOf("async_task_err:")===0){Y.error(new es(ev.substr(15)));cK.handled(T);ai.clearWorkingMessage();dy.done(T);return b2.force_reload()}else{try{if(ex.req.options.onProgress){return ex.req.options.onProgress(ew.responseText)}}catch(ey){}}}},onFailure:function(ev){var ew;ew=dy.job_info[T];ew.failures++;if(ew.failures>=dy.FAILS_MEAN_FAIL){try{if(ew.req.options.onFailure){ew.req.options.onFailure(ev,true)}}catch(ex){}ai.remove(ew.req);return dy.done(T)}}})},done:function(ev){var T;T=dy.job_info[ev];clearInterval(T.int_id);if(!T.dont_hide){delete dy.job_info[ev];if(!(T.req.async_task_id&&T.req.async_task_id!==ev)){return dV.hide(ev)}}else{return dV.update("1/1")}}};var cQ,by,bd,bk=[].indexOf||function(ew){for(var ev=0,T=this.length;ev<T;ev++){if(ev in this&&this[ev]===ew){return ev}}return -1};bd=A.NamespaceEvents=(function(){function T(ev){this.ns_id=ev;this.earliest=Number.MAX_VALUE;this.events=[];this.seen={};this.done=false}return T})();cQ=A.EventDatePicker=(function(){function T(ew){var ev,ex,ey;this.on_change=ew;bf(document.body).on("click",(function(ez){return function(eA){return ez.hide_calendar(eA)}})(this));ey=new Element("div",{id:"cal_container"});bf(ey).bind("click",function(ez){return ez.preventDefault()});bf(document.body).append(ey);this.calendar=new D("cal_container",{onDateChange:(function(ez){return function(eA){return ez.on_change(eA)}})(this),disable_future:true});bf(ey).css("position","fixed");ex=bf("#cal_date");ev=bf("#cal_container");ev.clonePosition(ex,{setWidth:false,setHeight:false,offsetTop:ex.height(),offsetLeft:ex.width()-ev.children().first()[0].offsetWidth});this.hide_calendar()}T.prototype.show_calendar=function(ev){if(this.shown){bf("#cal_container").hide();this.shown=false;return}bf("#cal_container").show();return this.shown=true};T.prototype.hide_calendar=function(ev){if(ev&&bf(ev.target).closest("#cal_date").length>0){return}bf("#cal_container").hide();this.shown=false;return true};return T})();by=INLINE_JS.Events=A.Events={ns:null,role:"all",now:Number(new Date()),timestamp:ds.start_of_day(new Date(Number(new Date())+60*60*24*1000)),request_in_flight:false,one_day:60*60*24*1000,user_navigated_away:false,init:function(T,ez,eA,ew){var ex,ey,ev;ev=dX.deconstruct_url();this.first_event_map=T;this.roles=ez;this.rss_data=eA;this.role_has_events=ew;this.role_picker=bf("#role-selector").controller();if(this.roles.length===1){this.role=this.roles[0].role}else{if(ev.qargs.role){this.role=ev.qargs.role;this.role_picker.set_state(this.role)}}this.date_picker=new cQ((function(eB){return function(eC){eB.change_date(eC);eB.set_url();return aQ.WebMiscActivityLogger.log("filter_events_date")}})(this));this._init_state();this.role_picker.on_state_change=(function(eB){return function(){eB.role=eB.role_picker.get_state();if(eB.ns&&!$u(eB.valid_roles()).any(function(eC){return eC.ns_ids.contains(eB.ns.ns_id)})){eB.ns=null;aC.set_selected_by_value(bf("#namespace-list")[0],"false")}eB.set_url();return eB.get_more(true)}})(this);bo.set_during_login_callback((function(eB){return function(eD,eC){return window.location.reload()}})(this));bf(window).bind("beforeunload",(function(eB){return function(){eB.user_navigated_away=true;return void 0}})(this));if(bf("#namespace-list-container")[0]){bf("#namespace-list-container")[0].observe("db:change",(function(eB){return function(eC){eB.ns=eB.namespaces[JSON.parse(eC.memo)];eB.set_url();eB.get_more(true);return aQ.WebMiscActivityLogger.log("filter_events_shared_folder")}})(this))}bf(window).on("scroll",(function(eB){return function(){document.body.scrollTop=Math.min(document.body.scrollTop,document.body.scrollHeight-y.viewport_dimensions().height-10);return eB.get_more()}})(this));if(ev.qargs.ns){aC.set_selected_by_value(bf("#namespace-list")[0],ev.qargs.ns);this.ns=this.namespaces[ev.qargs.ns]}if(ev.qargs.date){ey=ev.qargs.date.split("-").map(Number);ex=new Date(ey[2],ey[1]-1,ey[0]);this.date_picker.calendar.selected_date=ex;this.change_date(ex)}this.update_calendar_first_day();return this.get_more()},_init_state:function(){var ev,ey,eB,ez,ex,ew,eA,T;this.namespaces={};eA=$u(this.roles).values();for(eB=0,ex=eA.length;eB<ex;eB++){ey=eA[eB];T=ey.ns_ids;for(ez=0,ew=T.length;ez<ew;ez++){ev=T[ez];this.namespaces[ev]=new bd(ev)}}if(this.ns){return this.ns=this.namespaces[this.ns.ns_id]}},change_date:function(T){this.timestamp=Number(T)+this.one_day;if(this.timestamp<this.earliest()||this.timestamp>this.latest){this.latest=this.timestamp;this._init_state()}bf("#cur_date_text").text(I.localize(T));return this.get_more(true)},is_scrolled_down:function(){var T,ew,ev;ev=y.scroll_offsets().top;ew=y.viewport_dimensions().height;T=bf("#events").height();return ev+ew+50>=T},get_more:function(ew){var T,ev;if(this.request_in_flight){return}if($u(this.valid_nss()).all(function(ex){return ex.done})){this.render();return}if(!(ew||this.is_scrolled_down())){this.render();return}this.request_in_flight=true;this.render();ev=(function(ex){return function(){return $u(ex.valid_nss()).map(function(ey){return ey.ns_id}).join(",")}})(this);T=Math.min(this.earliest(),this.timestamp/1000,Math.floor(this.now/1000));return new Ajax.DBRequest("/events/ajax",{method:"POST",parameters:{page_size:25,ns_ids:ev(),timestamp:T},onSuccess:(function(ex){return function(eL){var eJ,ez,eM,eB,eK,eH,eG,eD,eN,eA,ey,eI,eF,eC,eE;eJ=JSON.parse(eL.responseText);ex.request_in_flight=false;eI=eJ.events;for(eH=0,eN=eI.length;eH<eN;eH++){ez=eI[eH];ez.html=bf(ez.html)[0];eK=ez.pkey+" "+(ez.html.textContent||ez.html.innerText);eM=ex.namespaces[ez.ns_id];if(!eM.seen[eK]){eM.events.push(ez);eM.seen[eK]=true;eM.earliest=ez.timestamp}}if(eJ.events.length>0){eF=eJ.ns_ids;for(eG=0,eA=eF.length;eG<eA;eG++){eB=eF[eG];ex.namespaces[eB].earliest=$u(eJ.events).map(function(eO){return eO.timestamp}).min()}}ex.render();if(eJ.events.last()){return ex.get_more()}else{if($u(eJ.ns_ids).join(",")!==ev()){return ex.get_more()}else{eC=eJ.ns_ids;eE=[];for(eD=0,ey=eC.length;eD<ey;eD++){eB=eC[eD];eE.push(ex.namespaces[eB].done=true)}return eE}}}})(this),onError:(function(ex){return function(){ex.request_in_flight=false;if(!ex.user_navigated_away){return Y.error(dU("We had problems loading your events feed; please try again later."))}}})(this)})},valid_roles:function(){if(this.role!=="all"){return $u(this.roles).filter((function(T){return function(ev){return ev.role===T.role}})(this))}else{return this.roles}},valid_nss:function(){if(this.ns){return[this.ns]}else{return $u(this.valid_roles()).map((function(T){return function(ev){return ev.ns_ids}})(this)).flatten().map((function(T){return function(ev){return T.namespaces[ev]}})(this)).uniq()}},earliest:function(){return $u(this.valid_nss()).map((function(T){return function(ev){return ev.earliest}})(this)).max()},latest:Number.MAX_VALUE,update_calendar_first_day:function(){this.date_picker.calendar.options.first_day=ds.start_of_day(new Date($u(this.valid_nss()).map((function(T){return function(ev){return T.first_event_map[ev.ns_id]}})(this)).min()));if(this.date_picker.calendar.selected_date<this.date_picker.calendar.options.first_day){this.date_picker.calendar.selected_date=ds.start_of_day(new Date(Number(this.date_picker.calendar.options.first_day)+this.one_day));this.change_date(this.date_picker.calendar.selected_date)}return this.date_picker.calendar.render()},set_url:function(){var ev,ew,T;T=new Date(this.timestamp-this.one_day);ew=this.now-this.timestamp>0;ev={};if(this.ns){ev.ns=this.ns.ns_id}if(this.role!=="all"){ev.role=this.role}if(ew){ev.date=""+(T.getDate())+"-"+(T.getMonth()+1)+"-"+(T.getFullYear())}return dX.push_state("/events",ev)},render:function(){var T,eI,eJ,eD,eK,eN,eH,ew,eC,eF,eB,eG,ev,eA,ey,ex,eL,eM,eE,ez;if(this.role_has_events[this.role]){this.update_calendar_first_day()}T=$u(this.valid_nss()).map((function(eO){return function(eP){return eP.events}})(this)).flatten();eI=this.earliest();ev=$u(T).sortBy(function(eO){return -eO.timestamp});eD=$u(ev).filter((function(eO){return function(eP){return eP.timestamp>=eI&&eP.timestamp<eO.timestamp/1000&&(eO.ns!==null||!eP.is_dup)}})(this));if(this.role_has_events[this.role]){bf("#event-table").empty();for(ey=0,eL=eD.length;ey<eL;ey++){eC=eD[ey];eJ=bf(eC.html);eF=$u(this.valid_roles()).filter((function(eO){return function(eP){return eP.ns_ids.contains(eC.ns_id)}})(this)).map((function(eO){return function(eP){return eP.name}})(this)).join(" & ");eJ.find("span.role-label > span").text(eF);bf("#event-table").append(eJ)}bf("#events-container").show();bf("#events-sub-header").show();bf("#events-sub-header").css("visibility","visible");bf("#events-empty-state").hide();bf(".empty-explanation").hide()}else{if(!this.request_in_flight){bf("#events-container").hide();bf("#events-sub-header").hide();bf("#events-empty-state").show();bf(".empty-explanation").show()}}if(!this.request_in_flight){bf("#more-loading").hide()}else{bf("#more-loading").show()}bf("#more-loading").css("marginTop",this.earliest()===Number.MAX_VALUE?"140px":"20px");eE=bf("#namespace-list > li");for(ex=0,eM=eE.length;ex<eM;ex++){eK=eE[ex];ew=$u(this.valid_roles()).map((function(eO){return function(eP){return eP.ns_ids}})(this)).flatten().any((function(eO){return function(eP){return eP===bf(eK).data("value")}})(this));eH=bf(eK).data("value")===false;eA=eH||ew;bf(eK).css("display",eA?"":"none")}eG=bk.call((function(){var eR,eP,eO,eQ;eO=this.valid_roles();eQ=[];for(eR=0,eP=eO.length;eR<eP;eR++){eN=eO[eR];eQ.push(eN.ns_ids.length>1)}return eQ}).call(this),true)>=0;if(!this.request_in_flight){if(eG){bf("#namespace-list-container").css("visibility","visible");bf("#namespace-list-container").show()}else{bf("#namespace-list-container").hide()}eB=this.rss_data[(ez=this.ns)!=null?ez.ns_id:void 0]||this.rss_data[this.role];if(eB&&this.role_has_events[this.role]){bf("#rss-feed a").attr("data-title",eB.title);bf("#rss_url").val(eB.url);bf("#reset-rss-link").on("click",(function(eO){return function(eP){new Ajax.DBRequest("/reset_rss",{parameters:{ns_id:eB.ns_id},onSuccess:function(){Y.success(dU("RSS feed url successfully reset."));return bB.redirect("/events")}});return false}})(this));bf("#rss_url").focus();bf("#rss-feed").show();return bf("#rss-feed").css("visibility","visible")}else{return bf("#rss-feed").hide()}}},show_rss_modal:function(){var T,ev;ep.show(dU("Subscribe to this RSS feed"),bf("#rss-modal")[0]);ev=bf("#rss_url").val();T=q.clipboard_overlay(ev,bf("#real_copy"),function(){Y.success(dU("Link copied to clipboard!"));return ep.hide()},bf(".modal-buttons"));return T.css({zIndex:1001})}};var I;I=A.DateUtil={fromSecondsSinceEpochUTC:function(T){var ev;ev=new Date(1970,0,1);ev.setSeconds(T);return ev},applyTimezoneOffset:function(ev,ex){var T,ew;T=parseInt(ex,10);ew=60*(ex-T);ev.setHours(ev.getHours()+T);return ev.setMinutes(ev.getMinutes()+ew)},contextualFormat:function(ev){var ex,ez,T,ew,ey;T=new Date(Date.now());ew=(T.getTime()-ev.getTime())/1000;ex=0;if(ew<8*3600){return bE.ago(ev)}this.applyTimezoneOffset(T,Constants.TIMEZONE_OFFSET);this.applyTimezoneOffset(ev,Constants.TIMEZONE_OFFSET);ey=new Date(Date.now());this.applyTimezoneOffset(ey,Constants.TIMEZONE_OFFSET);ey.setDate(ey.getDate()-1);if(ev.getYear()===T.getYear()&&ev.getMonth()===T.getMonth()&&ev.getDate()===T.getDate()){ez=dU("Today %(time)s");return ez.format({time:I.format(ev,Constants.time_format)})}else{if(ev.getYear()===ey.getYear()&&ev.getMonth()===ey.getMonth()&&ev.getDate()===ey.getDate()){ez=dU("Yesterday %(time)s");return ez.format({time:I.format(ev,Constants.time_format)})}else{return I.format(ev,Constants.datetime_format)}}},toUTCDate:function(T){return new Date(T.getUTCFullYear(),T.getUTCMonth(),T.getUTCDate(),T.getUTCHours(),T.getUTCMinutes(),T.getUTCSeconds(),T.getUTCMilliseconds())},differenceStr:function(ex,eA){var eC,eB,ev,ew,ey,T,ez;ey=(ex.getTime()-eA.getTime())/1000;if(ey<60){return aR("%d sec","%d secs",ey).format(ey)}else{if(ey<3600){ev=parseInt(ey/60,10);return aR("%d min","%d mins",ev).format(ev)}else{if(ey<86400){eB=parseInt(ey/3600,10);return aR("%d hour","%d hours",eB).format(eB)}else{if(ey<2592000){eC=parseInt(ey/(60*60*24),10);return aR("%d day","%d days",eC).format(eC)}else{if(ey<4838400){T=parseInt(ey/(60*60*24*7),10);return aR("%d week","%d weeks",T).format(T)}else{if(ey<31536000){ew=parseInt(ey/(60*60*24*30),10);return aR("%d month","%d months",ew).format(ew)}else{ez=parseInt(ey/(60*60*24*365),10);return aR("%d year","%d years",ez).format(ez)}}}}}}},localize:function(T){ci(Constants.date_format!=null,"Date format missing.");return I.format(T,Constants.date_format)},format:function(T,ev){var ew;ci(typeof ev==="string","Date format requires a format string");ew={yy:(function(ex){return function(){return T.getFullYear().toString().substring(2)}})(this),yyyy:(function(ex){return function(){return T.getFullYear().toString()}})(this),M:(function(ex){return function(){return(T.getMonth()+1).toString()}})(this),MM:(function(ex){return function(){return(T.getMonth()+1).toString().lpad(2)}})(this),d:(function(ex){return function(){return T.getDate().toString()}})(this),dd:(function(ex){return function(){return T.getDate().toString().lpad(2)}})(this),h:(function(ex){return function(){return(T.getHours()%12||12).toString()}})(this),H:(function(ex){return function(){return T.getHours().toString()}})(this),HH:(function(ex){return function(){return T.getHours().toString().lpad(2)}})(this),m:(function(ex){return function(){return T.getMinutes().toString()}})(this),mm:(function(ex){return function(){return T.getMinutes().toString().lpad(2)}})(this),a:(function(ex){return function(){if(T.getHours()>11){return dU("PM",{comment:"PM as in evening"})}else{return dU("AM",{comment:"AM as in morning"})}}})(this)};return ev.replace(/([a-zA-Z]+)/g,function(ex){if(ew[ex]!=null){return ew[ex]()}else{return ex}})}};var d9;d9=INLINE_JS.Timezone=A.Timezone={check_timezone:function(){var T;if(!cj.get_viewer().is_signed_in){return}T=d9.get_current_timezone();if((Constants.auto_timezone_offset==null)||Constants.auto_timezone_offset!==T){return d9.update(T)}},get_current_timezone:function(){var ex,ew,T,ev;ew=new Date();ew.setSeconds(0);ew.setMilliseconds(0);ev=ew.toGMTString();ex=new Date(ev.substring(0,ev.lastIndexOf(" ")));T=(ew-ex)/(1000*60*60);return T},update:function(T){ci(typeof T==="number","Timezone offset was not a number: "+T);return new Ajax.DBRequest("/set_timezone",{parameters:{offset:T},noAutonotify:true})},update_timezones_dropdown:function(ev,ex){var ew,T;if(ex==null){ex=null}T=d9.timezones_by_country[ev];bf("#timezone_id").empty();bf("#timezone_id").append((function(){var eA,ez,ey;ey=[];for(eA=0,ez=T.length;eA<ez;eA++){ew=T[eA];ey.push(bf('<option value="'+ew.id+'">'+ew.name+"</option>").prop("selected",ew.id===ex))}return ey})());return ds.syncHeight()},auto:function(){var T;T=$F("timezone_auto");if(T){bf("#tz").hide()}else{if(d9.default_country){bf("#timezone_country").val(d9.default_country);d9.update_timezones_dropdown(d9.default_country)}bf("#tz").show()}return ds.syncHeight()},load_data:function(ev,T){d9.timezones_by_country=ev;return d9.default_country=T}};var aV,bj;bj=A.CreateApp={init:function(ex,ev){var ew,ey,T;this.accepted_tos_by_uid=ex;this.form=ew=bf("#create-app-form");this.email_verification=null;if(!cj.get_viewer().is_paired){T=cj.get_viewer().get_users()[0];this.select_user(T.id)}ey=(function(ez){return function(eA){var eB;eB=eA.target.name;return ew.find("input[name="+eB+"]").each(function(){bf(this).parents("label").removeClass("active");return ew.removeClass(bf(this).data("next"))})}})(this);ew.find("input[type=radio]").change(function(ez){ey(ez);bf(ez.target).parents("label").addClass("active");return ew.addClass(bf(this).data("next"))});ew.find("input[type=checkbox]").change(function(ez){var eA;if(bf(this).filter("#accept-tos").length){return}bf(ez.target).parents("label").toggleClass("active");eA=ew.find("input[name="+(bf(this).attr("name"))+"]:checked");ew.toggleClass(bf(this).data("next"),eA.length!==0)});ew.find(".role-choice input").change((function(ez){return function(eB){var eA,eC;eA=ew.find(".role-choice input:checked");eC=eA.val();if(!cj.get_viewer().is_uid_signed_in(eC)){eA.prop("checked",false);ey(eB);bo.show_modal({user_id:eC,on_success:function(){return eA.prop("checked",true).trigger("change")}});return false}else{return ez.select_user(eC)}}})(this));ew.find("input:checked").trigger("change");ew.find("input[name=tos_accept]").change((function(ez){return function(eA){return ez.update_submit_enabled()}})(this));ew.find("#send-verify-email, #resend-verify-email").click((function(ez){return function(eA){ez.email_verification.send_email(ev,function(){ew.addClass("verify-email-sent");ez.email_verification.flash_email_sent_notification();return ez.email_verification.ensure_polling(function(){if(!ez.email_verification.user.is_email_verified){return}ew.addClass("email-verified");ew.removeClass("verifiy-email-sent");return ez.update_submit_enabled()})});return false}})(this));return ew.submit(function(ez){ew=bf(ez.target);bs.ajax_submit(ew[0],false,(function(eA){return window.location.href=eA.responseText}));return false})},select_user:function(T){this.email_verification=dq.get_for_user(cj.get_viewer().get_user_by_id(T));this.form.find("#accept-tos-wrapper").toggle(!this.accepted_tos_by_uid[T]);this.form.find("input[name=tos_accept]").prop("checked",false);this.form.removeClass("verify-email-sent");this.form.find("#verify-email-wrapper").toggle(!this.email_verification.user.is_email_verified);this.form.toggleClass("email-verified",this.email_verification.user.is_email_verified);return this.update_submit_enabled()},update_submit_enabled:function(){var ev,T;T=this.email_verification.user;ev=this.accepted_tos_by_uid[T.id]||this.form.find("input[name=tos_accept]").prop("checked");return this.form.find("#create-button").prop("disabled",!ev)}};aV=INLINE_JS.Apps=A.Apps={init_apps:function(){return bf("#show-disabled-apps").click(function(){bf(this).parent().hide();bf("#disabled-apps").show();return false})},init_app_info:function(ev,ew,T){this.user_email=T;bf("#app-info .icon-container").each(function(ey,ez){var ex;ex=bf(ez);return ex.append(Dropbox.createChooseButton({success:function(eA){ex.find(".icon").attr("src",eA[0].thumbnailLink);return ex.find("input[type=hidden]").val(eA[0].link)},linkType:"direct",extensions:["images"]}))});this._hoverable_tmpl=es.tmpl("hoverable_tmpl");this._webhook_info_row_tmpl=es.tmpl("webhook_info_row_tmpl");bf("#domain-list").on("click",".img-container",function(ex){aV.remove_domain(ex.currentTarget.parentNode,ev)});bf("#oauth-uri-list").on("click",".img-container",function(ex){aV.remove_oauth_uri(ex.currentTarget.parentNode,ev)});bf("#webhook-list").on("click",".img-container",function(ex){aV.remove_webhook(ex.currentTarget.parentNode,ev)});bf("#webhook-list").on("click",".webhook-actions.enabled .webhook_disable",function(ex){aV.update_webhook_url(ex.currentTarget,ev,false)});bf("#webhook-list").on("click",".webhook-actions.disabled .webhook_enable",function(ex){aV.update_webhook_url(ex.currentTarget,ev,true)});bf("#generate-token-button").on("click",function(ex){aV.generate_access_token(ev)});bf("#delete-app-button").on("click",function(ex){aV.confirm_disable(ew,ev,0)});bf("#webhook_url").on("click change paste focus",function(ex){bf("#webhook-form").removeClass("error")});this.init_app_info_add_redirect_uri();return bf("#oauth2-allow-implicit-grant").on("change",function(ex){return aV.set_oauth2_allow_implicit_grant(ex.currentTarget,ev)})},init_app_info_add_redirect_uri:function(){var T,ev,ew,ex;ev=/^\#?add_redirect_uri=(.*)$/.exec(window.location.hash||"");if(!ev){return}ex=window.decodeURIComponent(ev[1]);T=bf("#oauth-add-uri-form");bf("input[name=oauth_uri]",T).val(ex);ew=bf("#add-redirect-uri-modal")[0];bf("#add-redirect-uri-modal-uri").text(ex);ep.show(dU("Add OAuth redirect URI"),ew,{doit:function(){var ey;if(window.history&&window.history.replaceState){ey=window.location.href;ey=ey.substring(0,ey.indexOf("#"));window.history.replaceState({},document.title,ey)}else{window.location.hash=""}ep.hide();return aV.submit_new_oauth_uri(bf("#oauth-add-uri-form")[0])}})},init_app_datastores_browse:function(T){this.ds_info=T;if(cj.get_viewer().is_paired){this.role_picker=bf("#role-selector").controller();this.role_picker.on_state_change=this.app_datastores_browse_render.bind(this);return bo.set_during_login_callback((function(ev){return function(ex,ew){return ev.app_datastores_browse_reload_info(function(){return ew()},function(){ew("Error displaying datastores");return window.location.reload()})}})(this))}},app_datastores_browse_reload_info:function(ev,T){bf.ajax({url:"/developers/apps/datastores/info",success:(function(ew){return function(ex){ew.ds_info=ex;ew.app_datastores_browse_render();return typeof ev==="function"?ev():void 0}})(this),error:(function(ew){return function(ex){return typeof T==="function"?T(ex):void 0}})(this)});return false},app_datastores_browse_render:function(){this.app_datastores_browse_render_id("#apps_developed_container");this.app_datastores_browse_render_id("#apps_used_container");return this.app_datastores_browse_render_empty()},app_datastores_browse_render_empty:function(){var ew,ev,T,ex;ev=bf("#no_apps_container").empty();if(bf("#apps_developed_container").children().length!==0||bf("#apps_used_container").children().length!==0){return}ew=bf("<div class='empty-state'></div>").appendTo(ev);switch((ex=this.role_picker)!=null?ex.get_state():void 0){case dn.PERSONAL:case dn.WORK:T=cj.get_viewer().get_user_by_role(this.role_picker.get_state());return ew.append("You don't have any datastores in your "+cj.get_role_title(T)+" Dropbox.");default:return ew.append("You don't have any datastores in your Dropbox.")}},app_datastores_browse_render_id:function(eB){var ev,eA,ex,ez,ey,ew,T;ez=this.app_datastores_browse_get_id_info(eB);eA=bf(eB);eA.empty();ev="";for(ew=0,T=ez.length;ew<T;ew++){ex=ez[ew];if(this.app_datastores_should_render(ex.uid)){ev+=ex.html}}if(ev){eA.append(this.app_datastores_browse_get_id_header(eB));ey=bf("<div class='app-list clearfix'/>").appendTo(eA);return ey.html(ev)}},app_datastores_should_render:function(ev){var T;if(this.role_picker!=null){T=cj.get_viewer().get_user_by_id(ev);return this.role_picker.is_role_visible(T.role)}else{return true}},app_datastores_browse_get_id_info:function(T){switch(T){case"#apps_developed_container":return this.ds_info.apps_developed;case"#apps_used_container":return this.ds_info.apps_used;default:return ci(false,"invalid ds group id")}},app_datastores_browse_get_id_header:function(T){switch(T){case"#apps_developed_container":return bf("<h2>Apps you develop</h2>");case"#apps_used_container":return bf("<h2>Apps you use</h2>");default:return ci(false,"invalid ds group id")}},generate_access_token:function(ev){var ex,ew,T;T=this;ex=bf("#generate-token-button");ew=bf("<img>").attr("src","/static/images/icons/ajax-loading-small.gif").css("vertical-align","middle");ex.replaceWith(ew);return bf.ajax({url:"/developers/apps/generate_access_token",type:"POST",data:{app_id:ev},dataType:"json",success:function(ez){var ey;if(ez.status==="ok"){ey=bf("<div>").append(bf("<div>").attr("id","generated-token").addClass("text").css("padding-top",0).text(ez.token));ey.append(bf("<div>").addClass("detail-text").text(ez.warning))}else{if(ez.status==="error"){ey=bf("<div>").addClass("detail-text").addClass("error").text(ez.msg)}}return ew.replaceWith(ey)},error:function(){return Y.error("Unable to complete your request.")}})},confirm_disable:function(ex,ew,ev){var ey,T;ey=(ev?dU("Are you sure you want to disable '%(app_name)s'?"):dU("Are you sure you want to delete '%(app_name)s'?"));cS.fillVal(ey.format({app_name:ex.escapeHTML()}),"app-disable-text");ep.show((ev?dU("Confirm disable"):dU("Confirm delete")),$("app-disable-modal"));T="/developers/disable_app/"+ew;$("app-disable-modal").down("form").action=T;return $("disable-app-button").setValue((ev?dU("Disable"):dU("Delete")))},enable_app:function(ev){var T;T="/developers/enable_app/"+ev;return window.location.href=T},show_uninstall:function(ez,ey,ew,ev,ex,T){var eA;if(ez){Event.stop(ez)}ep.vars={app_id:ew,user_id:T};eA=bf("#delete-"+ev+"-app-confirm");if(ev==="sandbox"){if(!ex){aV.do_uninstall();return}bf(".app_folder",eA).text(ex)}bf(".app_name",eA).text(ey);ep.show(dU("Remove %(app_name)s?").format({app_name:bt.em_snippet(ey,22)}),eA[0],ep.vars);return null},do_uninstall:function(){var T;T=ep.vars.user_id;new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:ep.vars.app_id,keep_sandbox_files:$F("keep_sandbox_files")},onSuccess:function(ev){var ew;Y.success(ev.responseText);ew=bf(".apps-"+T);bf("#inst-app-"+ep.vars.app_id+"-row",ew).hide().removeClass("active_app");if(bf(".active_app",ew).length===0){ew.hide()}if(bf(".active_app").length===0){bf("#empty-explanation").text(dU("You have no apps linked to your Dropbox."));return bf("#applications-explanation",ew).remove()}},subject_user:T});return ep.hide()},enable_users_in_dev:function(T,ev){new Ajax.DBRequest("/developers/enable_users_in_dev/"+T,{onSuccess:function(ew){ep.show(dU("Limit raised to %d users").format(ev),$("increased-dev-user-limit-modal"));bf("#users-in-dev-none, #users-in-dev-some").hide();return bf("#users-in-dev-max").show()}});return false},unlink_all_users_in_dev:function(T){ep.show(dU("Unlink all users"),$("confirm-unlink-all-users"),{doit:function(){return new Ajax.DBRequest("/developers/unlink_all_users/"+T,{onSuccess:function(ev){bf("#current-app-users-1, #current-app-users-2").text("0");return ep.hide()}})}});return false},unlink_all_teams_in_dev:function(T){ep.show(dU("Unlink all teams"),$("confirm-unlink-all-teams"),{doit:function(){return bf.ajax({url:"/developers/unlink_all_teams/"+T,type:"POST",success:function(ev){bf("#current-app-teams").text("0");return ep.hide()}})}});return false},restore_sandbox:function(ev,ex,T){var ez,ew,ey;ez=bf("#restore-sandbox")[0];ep.show(dU("Restore app folder '%(filename)s'").format({filename:bt.em_snippet(an.filename(ex),17)}),ez);ey=bf("#restore-sandbox-form")[0];ew={ns_id:T};ew[Constants.UID_PARAM_NAME]=ev.id;return bs.add_vars(ey,ew)},submit_restore_sandbox:function(ev){var T;T=$("restore-sandbox-form");bs.ajax_submit(T,false,(function(ew){ep.hide();Y.success(dU("Restored app folder"));if(ew.responseText.length){return b2.reload_fqpath(ew.responseText)}else{return b2.reload("","",true)}}),false,ev.target);return false},submit_app_info:function(T){var ev;ev=bf(T).find("input[name=name]").val();bs.clear_errors(T);return bs.ajax_submit(T,false,(function(){Y.success("App info updated.");if(ev){return bf("#app-info h1").text(ev)}}))},submit_folder_name:function(T){var ev;ev=bf(T).find("input[name=folder]").val();bs.clear_errors(T);return bs.ajax_submit(T,false,(function(){Y.success("App folder name updated.");bf("#folder-name .text").text(ev);return aV.hide_folder_input()}))},submit_new_webhook:function(ev){var ew,eG,eE,ez,eC,eB,eF,eD,ex,T,eA,ey;eG=bf(ev);eC=bf("#webhook-list");ez=bf("<img>").attr("src","/static/images/icons/ajax-loading-small.gif").css("vertical-align","middle");eE=eG.find("input[name=webhook_url]");ex=function(eI,eH){if(eH){eH.remove()}if(eC.find(".hoverable-url").length===0){eC.addClass("hide-status")}bf("#webhook-form-error").text(eI);return bf("#webhook-form").addClass("error")};eF=eE.val();if(eF===""){ex("Empty URI");return}eD=C.parse(eF);if((eA=eD.scheme)!=="http"&&eA!=="https"){ex("URI scheme must be http or https");return}if(!eD.authority){ex("Improperly formatted URI (typo maybe?)");return}if((ey=eD.authority)==="localhost"||ey==="127.0.0.1"){ex("Webhooks doesn't support localhost as Dropbox can't contact your local server. Please use an internet accessible URI.");return}if(eC.find("tbody").length>=Constants.MAX_WEBHOOKS_PER_APP){ex("You can register a maximum of %d webhook URIs per app.".format(Constants.MAX_WEBHOOKS_PER_APP));return}ew=bf(this._webhook_info_row_tmpl({url:eF,status:"Verifying"}).toHTML());ew.find(".status").append(ez);eC.append(ew);eC.removeClass("hide-status");bf("#webhook-form").removeClass("error");eB=bs.collect_form_vars(ev);eE.val("");T=new Date().getTime();return bf.ajax({url:"/developers/apps/update/add_webhook",type:"POST",dataType:"json",data:eB,success:function(eJ){var eH,eI;if(eJ.status==="invalid"){ex(eJ.failure_text,ew);return eE.val(eF)}else{eI=new Date().getTime()-T;eH=Math.max(0,1000-eI);return setTimeout((function(){if(eJ.status==="ok"){return ew.find(".status").text("Enabled")}else{if(eJ.status==="error"){ew.find("textarea").text(eJ.failure_text);ew.find(".status").text(eJ.status_text).addClass("error");ew.find(".timestamp").text("Just now");return ew.find(".webhook-failure-info").css("display","")}}}),eH)}},error:function(){Y.error("Unable to complete your request.");ew.remove();return eE.val(eF)}})},remove_webhook:function(ew,ev){var ex,T;bf("#webhook-form").removeClass("error");T=bf(ew).find(".value").text();ex=bf("<img>").attr("src","/static/images/icons/ajax-loading-small.gif").css("vertical-align","middle");bf(ew).find(".status").text("Removing").removeClass("error").append(ex);return bf.ajax({url:"/developers/apps/update/remove_webhook",type:"POST",data:{app_id:ev,webhook_url:T},dataType:"json",success:function(eA){var ey,ez;ey=ew.parentNode;ez=ey.parentNode;ez.removeChild(ey);if(ez.getElementsByClassName("hoverable-url").length===0){bf(ez).addClass("hide-status")}if(!bf("#webhook_url").val()){return bf("#webhook_url").val(T)}},error:function(){return Y.error("Unable to complete your request.")}})},update_webhook_url:function(ez,ex,ew){var eA,T,ey,eB,ev;ev=bf(ez.parentNode.parentNode).find(".value").text();bf("#webhook-form").removeClass("error");ey=ez.parentNode.parentNode.parentNode;eA=bf("<img>").attr("src","/static/images/icons/ajax-loading-small.gif").css("vertical-align","middle");T=bf(ey).find(".status").text();ew=T==="Disabled";eB=ew?"Enabling":"Disabling";bf(ey).find(".status").text(eB).removeClass("error").append(eA);return bf.ajax({url:"/developers/apps/update/update_webhook_url",type:"POST",data:{app_id:ex,webhook_url:ev,enable:ew},dataType:"json",success:function(eD){var eC;T=bf(ey).find(".status").text();eC=T==="Disabling"?"Disabled":"Enabled";bf(ey).find(".status").text(eC).removeClass("error").removeClass("img");if(T==="Disabling"){return bf(ey).find(".webhook-actions").removeClass("enabled").addClass("disabled")}else{return bf(ey).find(".webhook-actions").removeClass("disabled").addClass("enabled")}},error:function(eC){return Y.error("Unable to complete your request.")}})},set_oauth2_allow_implicit_grant:function(ev,T){return bf.ajax({url:"/developers/apps/update/oauth2_allow_implicit_grant",type:"POST",data:{app_id:T,allow:bf(ev).val()},dataType:"json",success:function(ew){return Y.success("OAuth 2 allow implicit grant updated.")},error:function(){return Y.error("Error updating OAuth 2 allow implicit grant.")}})},submit_new_oauth_uri:function(ev){var T;T=bf(ev).find("input[name=oauth_uri]").val();bs.clear_errors(ev);return bs.ajax_submit(ev,false,(function(){Y.success("OAuth URI added.");aV.add_oauth_uri(T);return bf(ev).find("input[name=oauth_uri]").val("")}))},add_oauth_uri:function(ev){var T;T=bf("#oauth-uri-list");T.append(this._hoverable_tmpl({value:ev}).toHTML());return T.show()},remove_oauth_uri:function(ev,T){var ex,ew;ex=bf(ev).find(".value").text();ew=function(ez){var ey;Y.success("OAuth URI removed.");ey=ev.parentNode;ey.removeChild(ev);if(ey.getElementsByTagName("div").length===0){return ey.hide()}};return bf.ajax({url:"/developers/apps/update/remove_oauth_uri",type:"POST",data:{app_id:T,oauth_uri:ex},dataType:"json",success:ew,error:function(){return Y.error("Unable to complete your request.")}})},submit_new_domain:function(T){var ev;ev=bf(T).find("input[name=domain_name]").val();bs.clear_errors(T);return bs.ajax_submit(T,false,(function(){Y.success("Domain added.");aV.add_domain(ev);return bf(T).find("input[name=domain_name]").val("")}))},add_domain:function(ev){var T;T=bf("#domain-list");T.append(this._hoverable_tmpl({value:ev}).toHTML());return T.show()},remove_domain:function(ev,T){var ex,ew;ex=bf(ev).find(".value").text();ew=function(ez){var ey;Y.success("Domain removed.");ey=ev.parentNode;ey.removeChild(ev);if(ey.getElementsByTagName("div").length===0){return ey.hide()}};return bf.ajax({url:"/developers/apps/update/remove_domain",type:"POST",data:{app_id:T,domain_name:ex},dataType:"json",success:ew,error:function(){return Y.error("Unable to complete your request.")}})},show_need_users_modal:function(T){ep.show(dU("Please test this app",{comment:"Error message"}),$("app-need-users-modal"));return false},show_need_teams_modal:function(T){return ep.show(dU("Please test this app",{comment:"Error message"}),$("app-need-teams-modal"))},show_name_branding_modal:function(T){ep.show(dU("Please rename this app",{comment:"Error message"}),$("app-name-branding-modal"));return false},hide_folder_input:function(){bf("#folder-name").show();return bf("#folder-input").hide()},show_folder_input:function(){bf("#folder-name").hide();bf("#folder-input").show();return bf("#folder-input input[name=folder]").focus()}};var cc,c3;c3=INLINE_JS.twitter_auth_complete=function(T){ci(T!=null,"user_id must be provided");if(cc.onLoginSuccessCallback){cc.onLoginSuccessCallback(T)}else{window.location.reload()}return false};cc=A.Twitter={is_authed:function(T){T=parseInt(T);if(cc._authed_users==null){cc._authed_users={}}return cc._authed_users[T]},set_is_authed:function(T,ev){T=parseInt(T);if(cc._authed_users==null){cc._authed_users={}}return cc._authed_users[T]=ev},get_progress_container:function(){var T;ci(cc.progress_container,"Twitter is missing progress_container");T=$(cc.progress_container);ci(T,"Missing progress_container elm");return T},follow_dropbox:function(ev,T){var ew;ci(T!=null,"user_id must be provided");if(ev.showWorking){ev.showWorking()}ew=function(){if(ev.onFailure){return ev.onFailure()}else{return window.location.reload()}};return new Ajax.DBRequest("/twitter/follow_us",{onSuccess:function(ex){if(!ex.responseText.startsWith("ok")){return ew()}else{if(ev.onSuccess){return ev.onSuccess()}}},onFailure:function(){return ew()},subject_user:T})},do_auth:function(ex,T){var ew,ev;ci(T!=null,"user_id must be provided");ev=C({path:"/twitter/request_token"}).updateQuery(Constants.UID_PARAM_NAME,T).toString();window.open(ev,"twitter_auth","width=800,height=400");ew=function(ey){cc.set_is_authed(ey,true);return typeof ex==="function"?ex(ey):void 0};return cc.onLoginSuccessCallback=ew},show_auth:function(T){if(T){cc.onLoginSuccessCallback=T}return cS.updateFromElm(cc.get_progress_container(),"inline-twitter-auth")},show_posting:function(){if(cc.should_hide_modal()){ep.hide()}return cc.get_progress_container().update(cS.fromElm("sharing-progress"))},show_complete:function(ev){var T;T=cc.get_progress_container();T.update(cS.fromElm("sharing-posted"));return cc.show_complete_into(ev,T)},show_complete_into:function(eA,T){var ex,ey,ew,ez,ev;ex="twitter";ez=dU("View tweet");ev=void 0;if(eA.startsWith("ok")){ev="http://www.twitter.com/"}else{ev=eA}ey=T.down("#view-post");ey.href=ev;ey.update(ez);ew=b6.make("web",ex);return ey.__sert({top:ew})},post:function(ex,ez,ew,T){var ey,ev;ci(T!=null,"user_id must be provided");ci(ex,"Twitter message is empty");ey={message:ex,from_referrals:cc.from_referrals,from_getspace:cc.from_getspace};new Ajax.DBRequest("/twitter_post",{parameters:ey,onSuccess:function(eA){var eB,eC;if(eA.responseText==="login"){cc.onLoginSuccessCallback=function(){return cc.post(ex,null,null,T)};eB=cc.custom_show_auth||cc.show_auth;return eB()}else{if(cc.should_hide_modal()){ep.hide()}eC=cc.onPostSuccessCallback||cc.show_complete;return eC(eA.responseText)}},subject_user:T});ev=cc.custom_show_posting||cc.show_posting;return ev()},custom_post:function(ev,ew,T){ci(T!=null,"user_id must be provided");if(ew){cc.onPostSuccessCallback=ew}if(!ev){return}ci(ev,"Twitter message doesn't exist");if(!cj.get_viewer().is_signed_in){return window.open("http://www.twitter.com/home?status="+encodeURI(ev))}else{return cc.post(ev,null,null,T)}},get_user_info:function(ev,T){ci(T!=null,"user_id must be provided");return new Ajax.DBRequest("/twitter/user_info",{noAutonotify:1,parameters:{},onSuccess:function(ew){return ev(JSON.parse(ew.responseText))},subject_user:T})},should_hide_modal:function(){if(typeof cc.hide_modal==="undefined"){return true}else{return cc.hide_modal}}};var cR,eh,c1,S,ea,ak,bh,ag,u,dH,am={}.hasOwnProperty,cl=function(ex,ev){for(var T in ev){if(am.call(ev,T)){ex[T]=ev[T]}}function ew(){this.constructor=ex}ew.prototype=ev.prototype;ex.prototype=new ew();ex.__super__=ev.prototype;return ex},cU=function(T,ev){return function(){return T.apply(ev,arguments)}};c1=A.LightboxPreviewBase=(function(){function T(ev){this.link_hash=ev.link_hash;this.filename=ev.filename;this.fq_path=ev.fq_path;this.thumbnail_url_tmpl=ev.thumbnail_url_tmpl;this.dl_url=ev.dl_url;this.ns_id=ev.ns_id;this.ns_path=ev.ns_path;this.display_time=ev.display_time||null;this.more_actions_item_tmpl=es.tmpl("lightbox_more_actions_item_tmpl")}T.prototype.shutdown=function(){};T.prototype.preload=function(){};T.prototype.render=function(){};T.prototype.image_size=function(){var ev;ev=document.viewport.getDimensions();return au(ev.width,ev.height)};T.prototype.get_more_actions_above_divider=function(ew){var ex,ev;ev=[];ex=this.more_actions_item_tmpl({_id:"lightbox_download_link",_href:this.dl_url,_ns_id:this.ns_id,_ns_path:this.ns_path,sprite_name:"lightbox_download",item_text:dU("Download"),more_classes:"more-actions-item",Sprite:b6});ev.push(ex);return ev};T.prototype.get_more_actions_below_divider=function(ev){return[]};T.prototype.is_a_timeline_preview=function(){return this instanceof ea||this instanceof cR||this instanceof ak||this instanceof eh};T.prototype.is_an_album_preview=function(){return this instanceof ea||this instanceof ak};T.prototype.is_a_photo_preview=function(){return this instanceof S};T.prototype.is_a_video_preview=function(){return this instanceof bh};T.prototype.get_actions=function(ex){var ez,eB,eC,ew,eA,ev,ey;ew=[];if(!this.is_a_timeline_preview()&&ex.enable_sublinks){if(ex.share_button_experiment_variant==="WHITE_BUTTON"){eC=bf("#lightbox-share-action-base").clone().attr("id","lightbox-share-button");if(this.shmodel_link){ey=(function(eD){return function(eE){aQ.ShmodelUILogger.log("via-shmodel-lightbox");return window.open(C.parse(eD.shmodel_link).updateQuery("m","1"))}})(this)}else{ey=(function(eD){return function(eE){eE.preventDefault();aQ.ShmodelUILogger.log("via-browse-lightbox");return cV.shmodel(eD.fq_path,"browse_lightbox")}})(this)}}else{eC=bf("<a />",{id:"lightbox_share_link","class":"title_bubble black"});eC.html(b6.make("web","link_white"));if(this.is_a_photo_preview()){eC.attr("title",dU("Share link to photo"))}else{if(this.is_a_video_preview()){eC.attr("title",dU("Share link to video"))}else{ci(false,"preview needs to be a photo or video")}}if(this.shmodel_link){eC.attr("href",C.parse(this.shmodel_link).updateQuery("m","1"));eC.attr("target","_blank");ey=(function(eD){return function(eE){return aQ.ShmodelUILogger.log("via-shmodel-lightbox")}})(this)}else{eC.attr("href","#");ey=(function(eD){return function(eE){eE.preventDefault();aQ.ShmodelUILogger.log("via-browse-lightbox");return cV.shmodel(eD.fq_path,"browse_lightbox")}})(this)}}eC.on("click",ey);ew.push(eC[0])}if(ex.include_delete){eA=bp.in_single_collection_view()?dU("Remove"):dU("Delete");if(ex.share_button_experiment_variant==="WHITE_BUTTON"){ez=bf("#lightbox-delete-action-base").clone().attr("id","lightbox-delete-link");ez.find(".sprite-text-inner").text(eA);ez.on("click",(function(eD){eD.preventDefault();return ax.delete_current()}))}else{ez=bf("<a />",{id:"lightbox-delete-button",href:"#","class":"title_bubble black",title:eA});ez.html(b6.make("web","lightbox_delete_16"));ez.on("click",(function(eD){eD.preventDefault();return ax.toggle_delete()}))}ew.push(ez[0])}if(ex.share_button_experiment_variant==="WHITE_BUTTON"){ev=(function(eD){return function(eE){eE.preventDefault();return ax.toggle_more_actions_menu()}})(this);eB=bf("#lightbox-more-actions-base").clone().attr("id","lightbox-more-actions-button").on("click",ev);ew.push(eB[0])}else{ci(ax.more_actions_button!=null,"Lightbox should have a more_actions_button added on init");ew.push(ax.more_actions_button)}return ew};T.prototype.delete_pressed=function(){var ev;ev=dU("Deleting...");if(this.is_a_timeline_preview()){if(bp.in_single_collection_view()){ev=dU("Removing...");bp.get_current_collection().remove_photos([this.photo])}else{bp._delete_photos([this.photo])}}else{document.fire(ax.PHOTO_DELETE_EVT,this)}return Y.success(ev)};T.prototype.set_more_actions_event_handlers=function(ev){};T.prototype.replace_dl_action_with_open_action_if_file_available=function(){var ew,ex,ev,ey;if(__CONDITIONAL_JS__.UnityFeatures==null){return}ev=b2.active_user.id;ex=(function(ez){return function(eA,eD,eB){var eE,eC;eE=bf("#lightbox_download_link");if(!(eE.data("ns-id")===eA&&eE.data("ns-path")===eD)){return}eC=bf(ez.more_actions_item_tmpl({_id:"unity_open_action",_href:"#",_ns_id:eA,_ns_path:eD,sprite_name:"lightbox_open",item_text:dU("Open"),more_classes:"more-actions-item",Sprite:b6}).toHTML());eE.replaceWith(eC);return eC.on("click",function(eF){return __CONDITIONAL_JS__.UnityFeatures.open_file(eA,eD,eB,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler)})}})(this);if((ey=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?ey.get(this.ns_id,this.ns_path):void 0){return ex(this.ns_id,this.ns_path,ev)}else{ew=(function(ez){return function(eA){if(eA){return ex(ez.ns_id,ez.ns_path,ev)}}})(this);return __CONDITIONAL_JS__.UnityFeatures.check_file(this.ns_id,this.ns_path,ev,ew)}};return T})();S=INLINE_JS.PhotoPreview=A.PhotoPreview=(function(ev){cl(T,ev);function T(ew){T.__super__.constructor.call(this,ew);this.original_url=String(C.parse(ew.original_url).updateQuery(Constants.UID_PARAM_NAME,b2.active_user));this.shmodel_link=ew.shmodel_link;this.fail_image_src="/static/images/preview_fail.png";if(this.is_gif()){this.thumbnail_url_tmpl=this.original_url}this.loaded=false}T.prototype.show_fail=function(ex){var ew;return ew=bf(ex).find(".lightbox_fail_text").text(dU("Unable to preview this item."))};T.prototype.fallback=function(ex){var ew,ey;ew=$(ex.target);ew.writeAttribute({src:this.fail_image_src,width:128,height:128});ey=ew.up("div.content-item");if(ey){return this.show_fail(ey)}};T.prototype.is_gif=function(){return"gif"===an.file_extension(this.filename).toLowerCase()};T.prototype.preload=function(ey){var ex,ez,ew;ew=C.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();if(this.is_gif()){ew=this.thumbnail_url_tmpl}ez=(function(eA){return function(){if(typeof ey==="function"){ey()}return eA.loaded=true}})(this);ds.preload_image(ew,this.fallback.bind(this),ez);ex=$(ds.preloaded_images[ew]);ex.writeAttribute("data-original-href",this.original_url);ex.writeAttribute("class","thumbnail");return ex};T.prototype.render=function(eB,ey){var ez,ex,eA,ew,eC;if(this.loaded){ey()}ex=this.preload(ey);eC=bf("<div />",{"class":"content-item"}).append(ex);ez=bf("<div />",{"class":"lightbox_fail_text"});eC.append(ez);eA=ex.getAttribute("src").length;ew=ex.getAttribute("src").substring(eA-this.fail_image_src.length,eA);if(ew===this.fail_image_src){this.show_fail(eC)}eB.appendChild(eC[0]);return eC[0]};T.prototype.advance_on_click=true;T.prototype.get_more_actions_above_divider=function(ey){var ex,ew;ew=T.__super__.get_more_actions_above_divider.call(this,ey);ex=this.more_actions_item_tmpl({_id:"view_original",_href:this.original_url,_target:"_blank",sprite_name:"lightbox_view_original",item_text:dU("View original"),more_classes:"more-actions-item",Sprite:b6});ew.push(ex);return ew};return T})(c1);bh=A.VideoPreview=(function(T){cl(ev,T);function ev(ew){this._player_error=cU(this._player_error,this);this._player_ready=cU(this._player_ready,this);ev.__super__.constructor.call(this,ew);this.preview_url=ew.preview_url;this.shmodel_link=ew.shmodel_link;this.thumbnail_div=null;this.metadata_link=ew.metadata_link!=null?ew.metadata_link:void 0;this.metadata=null;this.player=null}ev.prototype.render_error=function(ez){var eB,ex,ew,ey,eA;ex=bf("<div/>");ew=bf("<img/>",{src:"/static/images/preview_fail.png","class":"video-preview-fail"});ey=bf("<div/>",{"class":"video-preview-fail"});if(ez==="needflash"){ey.html(dU('Install <a href="http://get.adobe.com/flashplayer/">Adobe Flash Player</a> to view this video.'))}else{ey.text(dU("Unable to preview this item.",eA="web",eB="preview means showing the item in the same browser window without downloading a copy."))}ex.append(ew,ey);return ex[0]};ev.prototype._player_ready=function(){var ew;ew=function(){bf(".vjs-poster").show();bf(".vjs-big-play-button").show();return bf(".vjs-big-play-button").focus()};return ew.defer()};ev.prototype._onPlay=function(){bf(".vjs-poster").hide();return bf(".vjs-big-play-button").hide()};ev.prototype._onEnded=function(){bf(".vjs-poster").show();bf(".vjs-big-play-button").show();return bf(".vjs-loading-spinner").hide()};ev.prototype._player_error=function(ew){this.shutdown();this.div=this.render_error(ew);return bf("#file-preview-modal .content-item").html(this.div)};ev.prototype.preload=function(){};ev.prototype.render=function(ex,ew){this.div=this.render_video(ex);return this.div};ev.prototype.render_video=function(eC){var ew,eA,ey,ex,eB,ez;ez=new Element("div",{"class":"video-player content-item"});eB=this.image_size().split("x")[0]*0.8;ex=parseInt(eB*0.55,10);eA=false;ey=C.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();ew=(function(eD){return function(eE){return eD.metadata=eE}})(this);this.player=a7.embed(ez,{src:this.preview_url,type:Constants.transcoder_hls4web?"application/vnd.apple.mpegurl":"video/flv",width:eB,height:ex,controls:true,preload:"auto",poster:ey,onError:this._player_error,onReady:this._player_ready,metadata:this.metadata,metadata_link:this.metadata_link,metadata_cb:ew});eC.appendChild(ez);bf(".vjs-poster").hide();bf(".vjs-big-play-button").hide();this.player.on("play",this._onPlay);this.player.on("ended",this._onEnded);return ez};ev.prototype.shutdown=function(){var ex,ew;bf(".vjs-big-play-button").blur();if(this.player){try{this.player.trigger("shutdown");if(this.player.techName==="Hls"){if((ew=this.player.tech.sourceBuffer)!=null){ew.abort()}}this.player.dispose()}catch(ey){ex=ey}return this.player=null}};return ev})(c1);ag=function(ew){var T,ev;T=(function(ey){cl(ex,ey);function ex(ez){ez.ns_id=ez.photo.ns_id;ez.ns_path=ez.photo.ns_path;ex.__super__.constructor.call(this,ez);this.photo=ez.photo;a2.set_vertical_space(3);if(bp.in_single_collection_view()){bf("#lightbox-delete-photo").val(dU("Remove"))}else{bf("#lightbox-delete-photo").val(dU("Delete"))}}ex.prototype.get_more_actions_above_divider=function(eB){var eA,ez;ez=ex.__super__.get_more_actions_above_divider.call(this,eB);eA=this.more_actions_item_tmpl({_id:"lightbox_add_to_album",sprite_name:"lightbox_add_to_album",item_text:dU("Add to album"),more_classes:"more-actions-item",Sprite:b6});ez.push(eA);return ez};ex.prototype.toggle_select_button_off=function(ez){if(this.is_a_photo_preview()){ez.attr("title",dU("Select photo"))}else{if(this.is_a_video_preview()){ez.attr("title",dU("Select video"))}}ez.html(b6.make("web","lightbox_unselected"));ez.removeClass("selected");ez.addClass("elbboggiw");return setTimeout((function(){return ez.removeClass("elbboggiw")}),540)};ex.prototype.toggle_select_button_on=function(ez){if(this.is_a_photo_preview()){ez.attr("title",dU("Un-select photo"))}else{if(this.is_a_video_preview()){ez.attr("title",dU("Un-select video"))}}ez.html(b6.make("web","lightbox_selected"));ez.addClass("selected");ez.addClass("wiggobble");return setTimeout((function(){return ez.removeClass("wiggobble")}),540)};ex.prototype.toggle_select=function(eA){var ez;eA.preventDefault();ez=bf("#lightbox-select-button");a2.hide_all();if(ed.contains(this.photo)){ed._remove(this.photo);return this.toggle_select_button_off(ez)}else{ed._add(this.photo);return this.toggle_select_button_on(ez)}};ex.prototype.get_actions=function(eB){var eA,ez,eC;eA=[];eC=bf("<a />",{id:"lightbox_share",href:"#","class":"lightbox-button lightbox-not-important"});ax.update_share_button_text(null,bf(eC));eC.on("click",((function(eD){return function(eF){var eE;eF.preventDefault();eE=ed.get();if(eE.length===0){return dT.show([eD.photo],false)}else{return dT.show(ed.get(),false)}}})(this)));ez=bf("<a />",{id:"lightbox-select-button",href:"#","class":"title_bubble black",title:dU("Select this photo")});if(ed.contains(this.photo)){ez.html(b6.make("web","lightbox_selected"))}else{ez.html(b6.make("web","lightbox_unselected"))}ez.on("click",this.toggle_select.bind(this));eA.push(eC[0]);eA.push(ez[0]);return eA.concat(ex.__super__.get_actions.call(this,eB))};ex.prototype.set_more_actions_event_handlers=function(ez){$("lightbox_add_to_album").observe("click",((function(eA){return function(eB){eB.preventDefault();return cf.show_add_to_album_modal(eB,[eA.photo])}})(this)));$("lightbox_show_in_folder").observe("click",((function(eA){return function(eB){eB.preventDefault();return bp.show_in_folder(eA.photo)}})(this)));return ex.__super__.set_more_actions_event_handlers.call(this,ez)};ex.prototype.get_more_actions_below_divider=function(eB){var eA,ez;eA=[];ez=this.more_actions_item_tmpl({_id:"lightbox_show_in_folder",sprite_name:"lightbox_show_in_folder",item_text:dU("Show in folder"),more_classes:"more-actions-item",Sprite:b6});eA.push(ez);eA=eA.concat(ex.__super__.get_more_actions_below_divider.call(this,eB));return eA};return ex})(ew);ev=(function(ey){cl(ex,ey);function ex(){return ex.__super__.constructor.apply(this,arguments)}ex.prototype.get_more_actions_below_divider=function(eB){var ez,eA;eA=[];ez=this.more_actions_item_tmpl({_id:"lightbox_remove_from_album",sprite_name:"lightbox_remove_from_album",item_text:dU("Remove from album"),more_classes:"more-actions-item",Sprite:b6});eA.push(ez);eA=eA.concat(ex.__super__.get_more_actions_below_divider.call(this,eB));return eA};ex.prototype.set_more_actions_event_handlers=function(ez){$("lightbox_remove_from_album").observe("click",((function(eA){return function(eB){eB.preventDefault();return cf.show_remove_photos_modal(bp.get_current_collection(),[eA.photo])}})(this)));return ex.__super__.set_more_actions_event_handlers.call(this,ez)};return ex})(T);return[T,ev]};u=ag(S),cR=u[0],ea=u[1];dH=ag(bh),eh=dH[0],ak=dH[1];var ax;ax=INLINE_JS.Lightbox=A.Lightbox=(function(){var eO,eM,fk,fj,e6,eC,ev,eT,e2,fo,fi,eB,e1,fd,eJ,fc,eY,e7,fn,eI,eZ,eG,fb,ff,eA,fe,ez,eR,fh,eL,e0,eD,eU,e8,eV,e4,ex,eN,T,e3,fg,fm,fa,eK,eQ,ey,eP,e5,ew,eE,e9,eW,eX,eH,eS,eF,fl;fj=[];eO=0;e6=false;fk=true;eW=void 0;ev=/^\d+\-\d+\-\d+\s+\d+\.\d+\.\d+/;eC=false;fh=void 0;fd=void 0;e5=-1;ew=null;e7=null;eZ=false;T=false;eA=false;eG=null;eI=function(fp){return fp.complete!==false};ey=function(){var fp;if($$("#file-preview-modal .loading-image").length){return}fp=new Element("img",{"class":"loading-image",src:"/static/images/icons/ajax-loader-black.gif"});return $$("#file-preview-modal .preview-content").first().__sert(fp)};eY=function(){return $$("#file-preview-modal .loading-image").invoke("remove")};eV=function(){var fv,fu,fr,fp,ft,fs,fq;fu=$$("#file-preview-modal .content-item").first().down("img.thumbnail");if(!fu||!eI(fu)){return}fp=$$("#file-preview-modal .preview").first().getDimensions();fv=void 0;if(!fu.naturalHeight){fv=fu.getDimensions();fu.naturalHeight=fv.height;fu.naturalWidth=fv.width}else{fv={width:fu.naturalWidth,height:fu.naturalHeight}}fr=fv.width/fp.width;fq=fv.height/fp.height;fs=Math.max(fr,fq);fu.style.visibility="";if(fs<1){fu.style.width="";fu.style.height=""}else{fu.style.width=Math.floor(fv.width/fs)+"px";fu.style.height=Math.floor(fv.height/fs)+"px"}ft=bf("#file-preview-modal .paging-block").position().left-16;return bf("#file-preview-modal .filename").css("max-width",ft)};e1=void 0;fe=function(){var fw,fr,fv,fu,ft,fq,fs,fp;fr=$("file-preview-modal");fu=fr.down(".menu");fv=fr.down(".header");fs=$$(".lightbox-not-important");fp=[];for(ft=0,fq=fs.length;ft<fq;ft++){fw=fs[ft];fp.push(fw.addClassName("opacity-zero"))}return fp};eP=function(){var ft,fs,fq,fr,fp;if(e1){clearTimeout(e1)}fr=$$(".lightbox-not-important");fp=[];for(fs=0,fq=fr.length;fs<fq;fs++){ft=fr[fs];fp.push(ft.removeClassName("opacity-zero"))}return fp};e4=function(fq){var fp;eP();fp=fq&&$(fq.target).descendantOf("file-preview-menu");if(e1!=null){clearTimeout(e1)}if(fk){if(!eC&&!fp){return e1=setTimeout(fe,3112)}}};e9=function(){if(e1!=null){clearTimeout(e1)}return fk=false};eE=function(){fk=true;return e4()};fn=function(fq){var fp;fp=fj.length;return(fp+(eO+fq)%fp)%fp};e0=function(fq){var fp,fr;if(fh.no_preload){return}fp=eK.bind(null,fq);return typeof(fr=fj[fq]).preload==="function"?fr.preload(fp):void 0};eD=function(){var fr,ft,fq,fs,fp;fs=[1,2,3,4,5,6,-1,-2];fp=[];for(ft=0,fq=fs.length;ft<fq;ft++){fr=fs[ft];if(Math.abs(fr)<fj.length){fp.push(e0(fn(fr)))}else{fp.push(void 0)}}return fp};eN=function(fp){if(!fh.filename_in_url){return}if(fp!=null){aM.replace_hash("lh",fp)}else{aM.replace_hash("")}return eG=fp};e8=function(){var fp,fq;fp=bf("#file-preview-modal");fq=fh.num_previews||fj.length;if(eZ&&T&&eA){fp.find(".lightbox-index-text-container").text(dU("Could not load folder",{comment:"Error shown when a folder fails to load"}))}else{if(eZ){if(T){fp.find(".lightbox-index-text-container").text(dU("Loading...",{comment:"Shown while waiting for photos/videos to load"}))}else{fp.find(".lightbox-index-text-container").text("")}}else{fp.find(".lightbox-index-text-container").text(dU("%(cur_file_num)s of %(num_total_files)s",{comment:"Indicating which we're viewing, like '3 of 10'"}).format({cur_file_num:eO+1,num_total_files:fq}))}}if(fj.length===1){fp.find(".prev").addClass("opacity-zero");return fp.find(".next").addClass("opacity-zero")}else{if(eO===0&&fh.no_wrap){fp.find(".prev").addClass("opacity-zero");return fp.find(".next").removeClass("opacity-zero")}else{if(eO===fj.length-1&&fh.no_wrap){fp.find(".prev").removeClass("opacity-zero");return fp.find(".next").addClass("opacity-zero")}else{fp.find(".prev").removeClass("opacity-zero");return fp.find(".next").removeClass("opacity-zero")}}}};e3=function(fr,fI){var fx,fy,fz,fE,ft,fp,fD,fH,fG,fC,fv,fB,fu,fA,fF,fq,fJ,fw,fs;e5=bE.time();ci(eO<fj.length,"Invalid index "+eO);fA=fj[eO];if(typeof fA!=="object"){if(ew){clearTimeout(ew)}ew=setTimeout((function(){if((ax.shown!=null)&&ax.shown){return e3(fr,fI)}}),100);return}bf("#file-preview-modal").trigger(ax.LIGHTBOX_SHOW_EVT,{preview:fA});fD={mode:"lightbox"};aQ.UserActivityLogger.log("web","file_view",fD);fG=bf("#file-preview-modal");fF=fG.find(".preview-content");fu=fr?fa:eK;fF.empty();ft=fA.render(fF[0],fu);fG=fG[0];if(!e7){e7=fG.on("contextmenu","img.thumbnail",a1.show_for_lightbox.bind(a1))}eN(fA.link_hash);e8();if(fA.display_time){if(fA.filename.match(ev)){fG.down(".filename").__date(fA.display_time)}else{fG.down(".filename").__date(fA.display_time+" - "+fA.filename)}}else{fG.down(".filename").__date(fA.filename)}fG.down(".filename").writeAttribute("title",fA.filename);if(bp.in_single_collection_view()&&((fw=bp.get_current_collection().member_fnames)!=null?fw.length:void 0)>1&&(((fs=fA.photo)!=null?fs.item_owner_fname:void 0)!=null)){fE="&nbsp;&nbsp;&middot;&nbsp;&nbsp;";fE+=dU("Added by %(fname)s").format({fname:bt.em_snippet(fA.photo.item_owner_fname,7)});fG.down(".added-by").__date(new es(fE));fG.down(".added-by").show()}else{fG.down(".added-by").hide()}fv=es.tmpl("lightbox_more_actions_item_tmpl");fC=fA.get_more_actions_above_divider(fh);fz=fA.get_more_actions_below_divider(fh);if(fz.length){fC.push(fv({divider:true,Sprite:b6}));fC=fC.concat(fz)}$("lightbox-more-actions-list").__date(fC);fA.set_more_actions_event_handlers(fh);if(bf(fG).data("is-unity-allowed")==="True"&&(__CONDITIONAL_JS__.UnityFeatures!=null)){fA.replace_dl_action_with_open_action_if_file_available()}fy=fA.get_actions(fh);fp=document.createDocumentFragment();for(fq=0,fJ=fy.length;fq<fJ;fq++){fx=fy[fq];fp.appendChild(fx)}fG.down(".actions").__date();fG.down(".actions").appendChild(fp);if(fh.share_button_experiment_variant==="WHITE_BUTTON"){fB=bf("#lightbox-more-actions-button .sprite-div").width();bf("#lightbox-more-actions-menu").css("right",fB/2)}document.fire(ax.ACTIONS_ADDED);if(bp.in_single_collection_view()){fG.down(".album-name").show().__date(bt.em_snippet(bp.get_current_collection().name,15,1));fG.down(".filename").addClassName("faded")}else{fG.down(".album-name").hide();fG.down(".filename").removeClassName("faded")}ft=ft.down("img.thumbnail");if(ft){if(!eI(ft)){ft.hide();ey();ft.observe("load",function(){eY();ft.style.visibility="hidden";ft.show();return eV()})}else{ft.show();eV()}}fH={preview_obj:fA,index:eO,direction:fI};return document.fire(ax.PHOTO_CHANGE_EVT,fH)};fm=function(fu){var fq,fr,fp,fs,ft;if(e5===-1){return}ft=bE.time()-e5;if(typeof h!=="undefined"&&h!==null){fq=h.get_current_view()}else{if(typeof ad!=="undefined"&&ad!==null?ad.is_album:void 0){fq="album_shmodel"}else{fq="not_photos"}}fr={current_view:fq};fp=bf("#file-preview-modal .content-item img.thumbnail")[0];if((fp!=null)&&(fp.src!=null)){fs=C.parse(fp.src).getQuery();if("size" in fs){fr.size=fs.size}}dE.log_ajax_transition(ft,fu,fr);e5=-1;return eD()};fa=function(){return fm("file-preview-lightbox-load-initial")};eK=function(fp){var fq;if(typeof fp==="number"){if((fq=fj[fp])!=null){fq.loaded=true}if(fp===eO){return fm("file-preview-lightbox-load")}}else{return fm("file-preview-lightbox-load")}};fg=function(fp){var fq;fq=bf("#lightbox-click-catcher");if(!fq.length){fq=bf("<div />",{id:"lightbox-click-catcher",style:"position: absolute; width: 100%; height: 100%; top: 0px; left: 0px; z-index: 2;"});fq.appendTo("#file-preview-modal .modal-preview-content");if(bB.msie_version_at_most(10)){fq.css("background","black");fq.fadeTo(0,0)}}fq.off("click");fq.on("click",(function(fr){fr.preventDefault();return fp()}));return fq.show()};eJ=function(){return bf("#lightbox-click-catcher").hide()};fo=function(){var fp;fp=bf("#lightbox-more-actions-button");if(fp.hasClass("toggled")){eJ();fp.removeClass("toggled");$("lightbox-more-actions-menu").hide();bf(document).trigger("dropdownClosed",[1]);eE();return true}return false};eR=function(){var fp;fp=bf("#lightbox-more-actions-button");if(!fp.hasClass("toggled")){fc();fp.addClass("toggled");a2.hide_all();bf("#lightbox-more-actions-menu").show();bf(document).trigger("dropdownOpened",[1]);e9();return fg(ax.close_more_actions_menu)}};eH=function(){if(bf("#lightbox-more-actions-button").hasClass("toggled")){return fo()}else{return eR()}};ez=function(fq){var fp;if(eZ){T=true;e8()}fo();if(fq){fq.preventDefault()}if(eO===fj.length-1&&fh.no_wrap){return}if((fp=fj[eO])!=null){fp.shutdown()}eO=fn(1);if(eO===0){e4()}return e3(null,ax.NEXT)};eU=function(fq){var fp;if(eZ){T=true;e8()}fo();if(fq){fq.preventDefault()}if(eO===0&&fh.no_wrap){return}if((fp=fj[eO])!=null){fp.shutdown()}eO=fn(-1);return e3(null,ax.PREV)};e2=function(fp){if(fp){fp.preventDefault()}if(fj[eO].advance_on_click){if(fp.clientX<bf(window).width()/10){return eU()}else{return ez()}}};fi=function(fv){var fs,fr,fu,fw,ft,fq,fp;fs=fj.dict_by("fq_path");fw=void 0;if(fv.memo.files){fw=fv.memo.files.collect(function(fx){return fx.fq_path})}else{fw=fv.memo.fq_paths}fp=[];for(ft=0,fq=fw.length;ft<fq;ft++){fu=fw[ft];if(fs[fu]){fr=fj.indexOf(fs[fu]);fj.splice(fr,1);if(fh.num_previews){fh.num_previews--}if(!fh.num_previews&&!fj.length){fp.push(fd())}else{if(fr===fj.length){fp.push(eU())}else{fp.push(e3())}}}else{fp.push(void 0)}}return fp};ex=function(fp){if(fj[eO].is_a_timeline_preview()){return fj[eO].toggle_select(fp)}};eS=function(){Event.stopObserving(document,"mousemove",e4);Event.stopObserving(document,"click",e4);document.stopObserving(ax.PHOTO_DELETE_EVT,eL);document.stopObserving(av.DELETE,fi);document.stopObserving(ed.CHANGE_EVT,eF);return clearInterval(eW)};fd=function(fs){var fq,fr,fp,ft;if(fs){fs.preventDefault()}if(!ax.shown){return}if((fr=fj[eO])!=null){fr.shutdown()}fq=$("file-preview-modal");fq.hide();fq.down(".preview-content").__date();y.scroll_unlock_document();eS();eN();ax.shown=0;fq.stopObserving("click",ax.back);if((fp=$$(".preview-content"))!=null){if((ft=fp.first())!=null){ft.stopObserving("click")}}bf("#file-preview-modal").trigger(ax.LIGHTBOX_HIDE_EVT);if(ax.reload){return b2.force_reload()}};eM="db:filepreview:exitselect";eT=function(fq){var fp;if(fh.keep_url){fd()}else{if((fp=fj[eO])!=null){fp.shutdown()}window.history.go(-1)}if(fq!=null){if(fq.originalEvent){fq=fq.originalEvent}Event.extend(fq).stop()}return document.fire(eM,fj[eO])};eL=(function(fp){return function(fq){return c0.do_delete(b2.active_user,fq.memo.fq_path)}})(this);ff=function(){var fp;if(!e6){fp=bf("#file-preview-modal");fp.on("click",".close",eT);key("esc",ax.KEY_SCOPE,(function(fq){if(bf("#lightbox-more-actions-button").hasClass("toggled")){return fo()}else{if(eC){return fc()}else{return eT(fq)}}}));fp.on("click",".next",ez);fp.on("click",".prev",eU);fp.on("click",".preview-container",e2);key("left, k",ax.KEY_SCOPE,function(fq){return eU()});key("right, j",ax.KEY_SCOPE,function(fq){ez();return false});key("up, down",ax.KEY_SCOPE,function(fq){return false});key("x, s, space",ax.KEY_SCOPE,function(fq){ex(fq);return false});if(fh.include_delete&&fh.share_button_experiment_variant!=="WHITE_BUTTON"){key("delete, command+backspace, backspace",ax.KEY_SCOPE,function(fq){Event.extend(fq).preventDefault();return ax.toggle_delete()});bf("#lightbox-delete-photo").on("click",(function(fq){eX();return fj[eO].delete_pressed()}));bf("#lightbox-delete-cancel").on("click",fc)}dX.add_exit_callback("/lightbox",function(){return fd()});ds.disableSelection(fp.find(".preview-container")[0]);ds.disableSelection(fp.find(".header")[0]);e6=true}Event.observe(document,"mousemove",e4);Event.observe(document,"click",e4);document.observe(av.DELETE,fi);document.observe(ax.PHOTO_DELETE_EVT,eL);document.observe(ed.CHANGE_EVT,eF);key.setScope(ax.KEY_SCOPE);return eW=setInterval(eV,500)};fb=function(){var fr,ft,fs,fq,fp;if(!eG){return}fp=[];for(fr=fs=0,fq=fj.length;fs<fq;fr=++fs){ft=fj[fr];if(ft.link_hash&&ft.link_hash.toLowerCase()===eG.toLowerCase()){eO=fr;if(!ax.shown){fp.push(ax.show())}else{fp.push(e3())}}else{fp.push(void 0)}}return fp};fl=function(){return on_script_loaded(function(){aM.watch("lh",function(fp){eG=fp;return fb()});return aM.watch("f",function(fr){var fs,fu,ft,fq,fp;fp=[];for(fs=ft=0,fq=fj.length;ft<fq;fs=++ft){fu=fj[fs];if(fu.filename.toLowerCase()===fr.toLowerCase()){eO=fs;if(!ax.shown){fp.push(ax.show())}else{fp.push(e3())}}else{fp.push(void 0)}}return fp})})};eF=function(ft,fv){var fr,fu,fq,fs,fp;if(fv==null){fv=bf("#lightbox_share")}fq=ed.get();fs=cB.categorize_files(fq),fr=fs[0],fu=fs[1];if(fq.length===0){fv.text(dU("Share"));return(fp=fj[eO])!=null?fp.toggle_select_button_off(bf("#lightbox-select-button")):void 0}else{if(fq.length===1){if(fr){return fv.text(dU("Share 1 photo"))}else{return fv.text(dU("Share 1 video"))}}else{if(fr&&fu){return fv.text(dU("Share %(num_files)s items",{comment:"num_files is a number greater than 1"}).format({num_files:fq.length}))}else{if(fr){return fv.text(dU("Share %(num_photos)s photos",{comment:"num_photos is a number greater than 1"}).format({num_photos:fq.length}))}else{return fv.text(dU("Share %(num_videos)s videos",{comment:"num_videos is a number greater than 1"}).format({num_videos:fq.length}))}}}}};eQ=function(){a2.hide_all();bf("#file-preview-modal .delete-file-prompt").show();bf(document).trigger("dropdownOpened",[1]);eP();eC=true;fg(ax.toggle_delete);return bf("#lightbox-delete-photo").focus()};fc=function(){var fq,fp;if(eC){fq=bf("#file-preview-modal .delete-file-prompt");fq.hide();bf(document).trigger("dropdownClosed",[1]);if((fp=fq.find(":focus")[0])!=null){fp.blur()}e4();eC=false;return eJ()}};eX=function(){fo();if(eC){return fc()}else{return eQ()}};eB=function(){return fj[eO].delete_pressed()};return{init_from_preview_objs:function(fs,fw,fr){var fv,fu,fp,ft,fq;if(fr==null){fr=true}fp=[];for(ft=0,fq=fs.length;ft<fq;ft++){fv=fs[ft];if(fv.is_video){fu=new bh({filename:fv.filename,fq_path:fv.path,thumbnail_url_tmpl:fv.thumbnail_url,preview_url:fv.preview_url,dl_url:fv.dl_url,shmodel_link:fv.shmodel_link,ns_id:fv.ns_id,ns_path:fv.path,link_hash:fv.item_id+"-"+fv.filename,metadata_link:fv.metadata_link})}else{fu=new S({filename:fv.filename,fq_path:fv.path,thumbnail_url_tmpl:fv.thumbnail_url,dl_url:fv.dl_url,original_url:fv.orig_url,shmodel_link:fv.shmodel_link,ns_id:fv.ns_id,ns_path:fv.ns_path,link_hash:fv.item_id+"-"+fv.filename})}fp.push(fu)}ax.init(fp,{include_delete:false,keep_url:true,filename_in_url:true,enable_sublinks:fr});return document.on(ax.EXIT_SELECT_EVT,(function(fx){return function(fz){var fy;key.setScope("all");fy=bf(fw)[fp.indexOf(fz.memo)];ds.scroll_to_thumb(fy);bf(fy).addClass("wiggobble");return setTimeout((function(){return bf(fy).removeClass("wiggobble")}),1000)}})(this))},init:function(fp,fq){if(ax.shown){return}ax.more_actions_button=new Element("a",{id:"lightbox-more-actions-button",href:"#","class":"lightbox-more-actions-button title_bubble black extra-margin",title:dU("More actions")});ax.more_actions_button.observe("click",((function(fr){return function(fs){fs.preventDefault();return ax.toggle_more_actions_menu()}})(this)));ax.more_actions_button.__date(b6.make("web","lightbox_more"));fq=fq||{};fh={include_delete:fq.include_delete||false,keep_url:fq.keep_url||false,num_previews:fq.num_previews||null,filename_in_url:fq.filename_in_url||false,no_wrap:(fq.no_wrap||false)||true,no_preload:fq.no_preload||false,enable_sublinks:fq.enable_sublinks!=null?fq.enable_sublinks:true,share_button_experiment_variant:fq.share_button_experiment_variant||false};eZ=fq.is_loading||false;ci(!fh.filename_in_url||fh.keep_url,"filename_in_url cannot be used with keep_url off");fj=fp;if(fq.start_index!=null){ax.show(fq.start_index)}if(fh.filename_in_url){fl()}return $(document.body).on("click",".more-actions-item",function(fr,fs){if(fs.down("a").getAttribute("href").length<2){fr.preventDefault()}return ax.close_more_actions_menu()})},update_previews:function(fp){return fj=fp},show:function(fp){var fq;if(ax.shown){return}ci(fj&&fj.length,"Lightbox.show() requires file preview objects to show");ff();if(fp!=null){eO=fp}bf("#file-preview-modal").trigger("lightbox-init-show",{preview:fj[eO]});ci(!ax.shown,"Trying to reshow file preview modal");$("file-preview-modal").show();y.scroll_lock_document();e3(true);ax.shown=1;if(!fh.keep_url){fq=dX.deconstruct_url(dX.get_url());if(fq.path.indexOf("/lightbox/")!==0){dX.push_state("/lightbox"+fq.path,fq.qargs)}}return e4()},jump_to:function(fp){ci(ax.shown,"Lightbox should be showing");eO=fp;e3();return e4()},set_no_wrap:function(fp){return fh.no_wrap=fp},refresh_file_list:function(fs){var fr,fu,fq,ft,fp;if(ax.shown){fu=fj[eO].fq_path}fj=aO.browsefile_to_filepreview(fs);fb();if(!ax.shown){return}for(fq=ft=0,fp=fj.length;ft<fp;fq=++ft){fr=fj[fq];if(fr.fq_path===fu){eO=fq;break}}eZ=false;T=false;return e8()},update_with_error:function(){eA=true;return e8()},num_previews:function(){return fh.num_previews||fj.length},get_previews:function(){return fj},current_index:function(){return eO},close_more_actions_menu:fo,toggle_more_actions_menu:eH,update_share_button_text:eF,toggle_delete:eX,delete_current:eB,back:eT,PHOTO_CHANGE_EVT:"db:lightbox:photo_change",PHOTO_DELETE_EVT:"db:lightbox:photo_delete",PHOTO_REMOVE_FROM_ALBUM_EVT:"db:lightbox:photo_remove_from_album",ACTIONS_ADDED:"db:lightbox:actions_added",EXIT_SELECT_EVT:eM,reload:false,NEXT:1,PREV:-1,vid_thumbnail_hidden:null,KEY_SCOPE:"lightbox",LIGHTBOX_HIDE_EVT:"lightbox-hide",LIGHTBOX_SHOW_EVT:"lightbox-preview"}})();var bg;bg=A.Tour=(function(){var ex,ew,ez,eA,eE,eC,eD,eB,ey,eF,ev,T;ew=6;ex=0;ev=function(eG){var eP,eO,eN,eI,eH,eJ,eL,eM,eK;$$(".page-end").each(Element.remove);eH=eG;eL=ew-eG-1;eP=document.createDocumentFragment();for(eO=eM=0;0<=eH?eM<eH:eM>eH;eO=0<=eH?++eM:--eM){eI=new Element("img",{src:"/static/images/page-left.png","class":"page-end-left page-end"});eI.style.left=(28-eO*5)+"px";eI.style.zIndex=ew-eO;eP.appendChild(eI)}for(eN=eK=0;0<=eL?eK<eL:eK>eL;eN=0<=eL?++eK:--eK){eJ=new Element("img",{src:"/static/images/page-right.png","class":"page-end-right page-end"});eJ.style.right=(31-eN*5)+"px";eJ.style.zIndex=ew-eN;eP.appendChild(eJ)}return $("book").appendChild(eP)};T=function(eG){(eG>0?Element.show:Element.hide)("tour-page-back");return(eG+1<ew?Element.show:Element.hide)("tour-page-forward")};ey=function(eG){$$(".pages").invoke("hide");return $("page-"+eG).show()};ez=function(eG){T(eG);ev(eG);ey(eG);return ex=eG};eB=function(eH){var eG;Event.extend(eH).preventDefault();eG=ex-1;if(eG<0){return}ez(eG);return dX.push_state("/tour/"+eG)};eC=function(eH){var eG;Event.extend(eH).preventDefault();eG=ex+1;if(eG>=ew){return}ez(eG);return dX.push_state("/tour/"+eG)};eF=function(eH,eI){var eG;eH.preventDefault();eG=parseInt(eI.href.split("/").last(),10);ez(eG);return dX.push_state("/tour/"+eG)};eE=function(){$("tour-page-back").observe("click",eB);$("tour-page-forward").observe("click",eC);key("right",eC);key("left",eB);return $("toc").on("click","a",eF)};eA=function(eH,eI){var eG;eG=parseInt(eH,10)||0;return ez(eG)};eD=function(){var eK,eJ,eH,eI,eG;eI=$$(".page-right img");eG=[];for(eJ=0,eH=eI.length;eJ<eH;eJ++){eK=eI[eJ];eG.push(ds.preload_image(eK.src))}return eG};return{setup:function(){return bf(function(){dX.add_callback("/tour",eA);eE();return eD()})}}})();var bp,bk=[].indexOf||function(ew){for(var ev=0,T=this.length;ev<T;ev++){if(ev in this&&this[ev]===ew){return ev}}return -1};bp=INLINE_JS.Photos=A.Photos={THUMB_SIZE:198,MONTH_HEADER_HEIGHT:46,COLLECTION_HEADER_HEIGHT:4,LIGHTBOX_OFFSET:25,DUPLICATES_SNIPPET_LENGTH:30,KEY_SCOPE:"photos",NUM_PHOTOS_LONG_RUNNING_DELETES:100,NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP:200,_all_photos_timeline:null,_single_collection_timeline:null,_last_lightbox_photo:null,_current_collection_gid:null,_in_all_collections_view:false,_tmpl:null,_cu_duplicate_tmpl:null,_creating_filetags:false,_creating_filetags_cb:null,event_metadata_cache:{},scroll_count:0,initialized:false,_init_finished:false,init:function(eA,ev,ex,eE,eB,ew,T,eC,eG){var ez,eD,eF,ey;this.event_metadata_cache=T;this.initialized=true;this.disable_selection();ds.disable_ie_image_dragging();this._tmpl=es.tmpl("cu_list_item_tmpl");this._cu_duplicate_tmpl=es.tmpl("cu_duplicate_list_item_tmpl");this._current_collection_gid=eB!=null?eB.gid:void 0;key.setScope(this.KEY_SCOPE);this.include_shared_folders=eC.include_shared_folders;this.show_hidden=eC.show_hidden;this.timestamp_edit_enabled=eG.timestamp_edit_enabled;this.undo_enabled=eG.undo_enabled;this.local_storage_enabled=eG.local_storage_enabled;eD=dX.deconstruct_url();ey="share" in eD.qargs;for(eF in eE){if(eE.hasOwnProperty(eF)){ed.inc_num_loading_events_before_select(ey)}}this._init_timeline(eA,ev,ex,eE);this._init_lightbox();ez=[];if(eB!=null){ez.push(new W(eB,false))}cf.init(ez,ew);ed.drag_select_enabled=eG.drag_select_enabled;if(eC.show_photos_tour){ay.next()}delete eD.qargs.selr;delete eD.qargs.user_email;delete eD.qargs.uid;delete eD.qargs.share;delete eD.qargs.m;if("uuid" in eD.qargs){delete eD.qargs.uuid;delete eD.qargs.id}if(c8){dX.replace_state(eD.path,eD.qargs)}else{if(!C.parse(window.location.href).fragment){dX.push_state("/photos",eD.qargs)}}this._listen();return this._init_finished=true},_listen:function(){$(document.body).on("click",".cu-thumb",this._thumb_click.bind(this));$(document.body).on("dblclick",".cu-thumb",this._thumb_double_click.bind(this));$(document.body).on("contextmenu",".cu-thumb",this._thumb_context_menu.bind(this));document.observe(ax.PHOTO_CHANGE_EVT,this._lightbox_photo_change.bind(this));document.observe(ax.PHOTO_DELETE_EVT,this._lightbox_delete.bind(this));document.observe(ax.PHOTO_REMOVE_FROM_ALBUM_EVT,this._lightbox_remove.bind(this));document.observe(ax.EXIT_SELECT_EVT,this._lightbox_exit.bind(this));document.observe(a1.HIDE_EVT,this._context_menu_hide.bind(this));Event.observe(window,"resize",this._window_resize.bind(this));dX.add_callback("/photos",this._history_change_handler.bind(this));document.observe(cE.EVENT_MISCOUNT_EVT,this._photos_changed.bind(this));document.observe(cE.PHOTOS_LOADED_EVT,this._photos_loaded.bind(this));document.observe(bT.PHOTOS_ADDED_EVT,this._photos_changed.bind(this));document.observe(bT.PHOTOS_REMOVED_EVT,this._photos_changed.bind(this));bf("#photos-nav-item").on("click",this.show_all_photos.bind(this));bf("#back-to-photos").on("click",this._back_to_photos.bind(this));bf("#back-to-albums").on("click",this._back_to_albums.bind(this));bf("#share-selected").on("click",this._share_selected.bind(this));bf("#clear-selected").on("click",this._clear_selected.bind(this));bf("#share-collection").on("click",this._share_collection.bind(this));if(this.include_shared_folders){bf("#do-include-shared-folders").prop("checked",true)}else{bf("#dont-include-shared-folders").prop("checked",true)}cf.listen();ed.listen();$(document.body).on("click",".event-select",this._select_event.bind(this));$(document.body).on("click",".event-share",this._share_event.bind(this));$(document.body).on("click",".event-add-to-album",this._add_event_to_album.bind(this));return bf(".show-all-photos").on("click",this.show_all_photos.bind(this))},_select_event:function(eB){var ex,eA,ew,ez,ev,ey,T;eA=$(eB.target).up(".cu-month-header").identify().slice(2);ex=this.get_timeline().events.valueFromKey(eA);ey=ex.photos;T=[];for(ez=0,ev=ey.length;ez<ev;ez++){ew=ey[ez];T.push(ed._add(ew))}return T},_share_event:function(eA){var ew,ez,ev,ey,T,ex;ez=$(eA.target).up(".cu-month-header").identify().slice(2);ew=this.get_timeline().events.valueFromKey(ez);ex=ew.photos;for(ey=0,T=ex.length;ey<T;ey++){ev=ex[ey];ed._add(ev)}return this._share_selected()},_add_event_to_album:function(eA){var ew,ez,ev,ey,T,ex;ez=$(eA.target).up(".cu-month-header").identify().slice(2);ew=this.get_timeline().events.valueFromKey(ez);ex=ew.photos;for(ey=0,T=ex.length;ey<T;ey++){ev=ex[ey];ed._add(ev)}return cf.show_add_to_album_modal(eA,ed.get())},_init_timeline:function(eB,ew,ex,eD){var ev,eE,eC,T,eF,eA,ez,ey;if(!eB.length){this.show_empty_state();return}ev=this.in_single_collection_view()?$("single-collection-list"):$("photos-list");eA=$("cu-view").cumulativeOffset().top+ev.getLayout().get("margin-top")+ev.getLayout().get("padding-top");if(bf("#carousel-promo-banner").outerHeight()){eA+=bf("#carousel-promo-banner").outerHeight()-$("cu-view").cumulativeOffset().top}eC=$("cu-view").cumulativeOffset().left+ev.getLayout().get("margin-left")+ev.getLayout().get("padding-left");eE={top_offset:eA,left_offset:eC,thumb_size:this.THUMB_SIZE,header_height:this.in_single_collection_view()?this.COLLECTION_HEADER_HEIGHT:this.MONTH_HEADER_HEIGHT};T={uses_lightbox:true,uses_timeline_nav:true,log_thumb_loading:true};eF=new bT(ev,null,eB,ew,ex,eD,this._tmpl,eE,T);if(this.in_single_collection_view()){if((ez=this._single_collection_timeline)!=null){ez.unlisten()}this._single_collection_timeline=eF}else{if((ey=this._all_photos_timeline)!=null){ey.unlisten()}this._all_photos_timeline=eF}return this.get_timeline().render()},_init_lightbox:function(){var ev,T;if(this.get_timeline()==null){return}if(ax.shown){T=this.get_timeline().get_preview_objs();if(T.length){ax.update_previews(T);ev=Math.min(ax.current_index(),T.length-1);return ax.jump_to(ev)}else{return ax.back()}}else{return ax.init(this.get_timeline().get_preview_objs(),{include_delete:true,no_wrap:true})}},_photos_loaded:function(){return this._init_lightbox()},_photos_changed:function(){this._init_lightbox();return this.set_empty_state()},_refresh_view:function(ev){var T;if((T=this.get_timeline())!=null){T.unlisten()}ed.clear();$("cu-empty").hide();$("single-album-empty").hide();if(this.in_single_collection_view()){$("single-collection-list").__date()}this._refresh_photo_events(ev);return window.scrollTo(0,0)},_refresh_photo_events:function(T){this.event_metadata_cache=null;return new Ajax.DBRequest("/photos_events",{parameters:{collection_gid:this._current_collection_gid,show_hidden:this.show_hidden},onSuccess:(function(ev){return function(ew){var ex;ex=JSON.parse(ew.responseText);if(ex==="deleted_collection"){ev._current_collection_gid=null;cf.reload();ev.show_all_collections();Y.error(dU("This album has been deleted!"));return}ev._init_timeline(ex.header_ids,ex.header_id_to_name,ex.header_id_to_num_photos,{});ev._init_lightbox();return typeof T==="function"?T():void 0}})(this)})},set_empty_state:function(){if(this.get_timeline().events.length()){return this.hide_empty_state()}else{return this.show_empty_state()}},show_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").show()}else{return $("cu-empty").show()}},hide_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").hide()}else{return $("cu-empty").hide()}},get_timeline:function(){if(this.in_single_collection_view()){return this._single_collection_timeline}else{return this._all_photos_timeline}},show_in_folder:function(T){if(T.duplicates_info!=null){return this._show_duplicates_modal(T,false)}else{return window.open(this._get_browse_link(T),"_blank")}},_get_browse_link:function(ev){var T;T=eu.get_browse_root(cj.get_viewer().photos_user);return String(C({path:""+T+(an.normalize(an.parent_dir(ev.fq_path))),query:{select:ev.filename}}))},in_single_collection_view:function(){return this._current_collection_gid!=null},in_all_collections_view:function(){return this._in_all_collections_view},get_current_collection:function(){if(this._current_collection_gid!=null){return cf.get(this._current_collection_gid)}else{return null}},enable_selection:function(){return ds.enableSelection($(document.body))},disable_selection:function(){return ds.disableSelection($(document.body))},show_collection:function(ew){var ev,T;h.log_transition_to(bW.SINGLE_COLLECTION_VIEW);T=dX.deconstruct_url();ev="/lightbox";if(T.path.indexOf(ev)===0){T.path=T.path.slice(ev.length);key.setScope(this.KEY_SCOPE);this._last_lightbox_photo=null}if(bk.call(T.path,"/album/")<0){if(T.path==="/photos/all_albums"){$("back-to-photos").hide();$("back-to-albums").show()}else{$("back-to-albums").hide();$("back-to-photos").show()}}if(ew!=null){T.path=cf.get(ew).url}return dX.push_state(T.path,T.qargs)},show_all_collections:function(){h.log_transition_to(bW.ALBUMS_VIEW);return dX.push_state("/photos/all_albums")},show_all_photos:function(ev){var T;ev.preventDefault();h.log_transition_to(bW.PHOTOS_VIEW);T=dX.deconstruct_url();if(T.path==="/photos"){return this._refresh_view()}else{ed.clear();return dX.push_state("/photos")}},_back_to_photos:function(T){ed.clear();return this.show_all_photos(T)},_back_to_albums:function(T){ed.clear();return this.show_all_collections()},get_thumb_click_event_data:function(ew,T){var ev;ev=ew.event;return{timeline_photo_index:T,event_photo_index:ev.photos.indexOf(ew),num_photos_in_event:ev.photos.length,event_index:this.get_timeline().events.list.indexOf(ev.unique_id),num_events:this.get_timeline().events.list.length}},_thumb_click:function(ev){var T;T=this.get_timeline().get_photo_for_thumb_elm($(ev.target));if(ed._drag_drop.ignore_next_click){return ed._drag_drop.ignore_next_click=false}else{return ed.photo_click(ev,T)}},_thumb_double_click:function(ex){var ew,ev,T;ev=this.get_timeline().get_photo_for_thumb_elm($(ex.target));T=this.get_timeline().index_of_photo(ev);this._preview(T);ew=this.get_thumb_click_event_data(ev,T);return h.log_interaction(dI.OPEN_LIGHTBOX,cD.DBL_CLICK,ew)},_thumb_context_menu:function(ez){var ew,eA,ey,ev,ex,T;ew=this.get_timeline().get_photo_for_thumb_elm($(ez.target));if(ez.shiftKey){ed.photo_click(ez,ew);return}if(ed.contains(ew)){eA=ed.get()}else{eA=[ew]}a1.show_photos(ez,eA);T=[];for(ey=0,ev=eA.length;ey<ev;ey++){ew=eA[ey];T.push((ex=this.get_timeline().get_thumb_elm_for_photo(ew))!=null?ex.addClassName("context-selected"):void 0)}return T},_context_menu_hide:function(T){$$(".cu-thumb.context-selected").invoke("removeClassName","context-selected");return $$(".photo-collection.context-selected").invoke("removeClassName","context-selected")},_share_selected:function(ev){var T;T=ed.get();if(!T.length){return}dT.show(T,false);return h.log_interaction(dI.SHARE,cD.SAH,{num_photos:T.length})},_clear_selected:function(ev){var T;T=ed.get().length;ed.clear();return h.log_interaction(dI.CLEAR_SELECTED,cD.SAH,{num_photos:T})},_share_collection:function(ev){var T;ci(this.in_single_collection_view(),"_share_collection can only happen in single collection view");T=this.get_current_collection();if(T.num_items===0){Y.error(dU("This album is empty. Add some photos before you share it!"));return}dT.show(this.get_current_collection(),true);return h.log_interaction(dI.SHARE_ALBUM,cD.SCA)},toggle_mem_lane_settings:function(T){var ew,ev;if(T){Event.extend(T).preventDefault()}if(!bf("#memory-lane-settings-menu").visible()){ev=bf("#memory-lane-settings-menu");eb.show($("memory-lane-settings-menu"),$("memory-lane-settings-button"));ew=function(ex){return ex.stopPropagation()};ev.off("mousedown");ev.off("click");ev.on("mousedown",ew);return ev.on("click",ew)}},show_delete_photos_modal:function(eC){var eD,ez,ew,eA,T,ev,ex,eB,ey;if(eC.length===1){ev=eC[0];if(ev.duplicates_info!=null){this._show_duplicates_modal(ev,true);return}}else{eD=[];for(ex=0,eB=eC.length;ex<eB;ex++){ev=eC[ex];if(ev.duplicates_info!=null){ez=ev.duplicates_info.slice(0);ez.push(ev);ez.sort(function(eF,eE){return eE.mtime-eF.mtime});eD=eD.concat(ez)}}if(eD.length){this._show_delete_multiple_duplicates_modal(eC,eD);return}}ey=cB.categorize_files(eC),eA=ey[0],T=ey[1];if(eA&&T){ew=aR("Delete %(file_count)s item?","Delete %(file_count)s items?",eC.length)}else{if(eA){ew=aR("Delete %(file_count)s photo?","Delete %(file_count)s photos?",eC.length)}else{ew=aR("Delete %(file_count)s video?","Delete %(file_count)s videos?",eC.length)}}return c9.show({title_text:ew.format({file_count:eC.length}),body_html:dU("Are you sure you want to delete <strong>%(items)s</strong> from your Dropbox?").format({items:cB.file_desc(eC)}),confirm_text:dU("Delete"),cancel_text:dU("Cancel"),confirm_callback:(function(eE){return function(){return eE._delete_photos(eC)}})(this)})},_delete_photos:function(eJ){var eF,eD,ex,eG,T,ev,eI,eC,eA,ez,eH,ew,eB,ey,eE;eJ=eJ.slice(0);eI=[];for(eA=0,eH=eJ.length;eA<eH;eA++){ev=eJ[eA];eI.push(ev.fq_path);if(ev.duplicates_info!=null){eB=ev.duplicates_info;for(ez=0,ew=eB.length;ez<ew;ez++){ex=eB[ez];eI.push(ex.fq_path)}}}ey=cB.categorize_files(eJ),eG=ey[0],T=ey[1];if(eG&&T){eD=aR("Deleting file","Deleting files",eI.length);eF=aR("Deleted file.","Deleted files.",eI.length)}else{if(eG){eD=aR("Deleting photo","Deleting photos",eI.length);eF=aR("Deleted photo.","Deleted photos.",eI.length)}else{eD=aR("Deleting video","Deleting videos",eI.length);eF=aR("Deleted video.","Deleted videos.",eI.length)}}eE=function(eK){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(eK)},html_in_error_msg:true,progress_text:dU("Undoing..."),onSuccess:function(eL){var eM;eM=dU("Undo complete");Y.success(eM);return bp._all_photos_timeline.restore_removed_photos()},subject_user:cj.get_viewer().photos_user})};eC=(function(eK){return function(eL){return new Ajax.DBRequest("/cmd/delete",{parameters:{files:eI},job:eI.length>bp.NUM_PHOTOS_LONG_RUNNING_DELETES,job_user:cj.get_viewer().photos_user,progress_text:eD,onSuccess:function(eO){var eM,eP,eN;eP=eO.responseText.evalJSON();eN=bp.undo_enabled&&(bp._all_photos_timeline!=null);eM=eN?eP.changesets:null;Q.notifyWithUndo(eD,eM,eE);bp.get_timeline().remove_photos(eJ);if(eL.length>0){return cf.refresh_album_views(eL)}},subject_user:cj.get_viewer().photos_user})}})(this);return new Ajax.DBRequest("/collections_from_paths",{parameters:{fq_paths:JSON.stringify(eI)},onSuccess:(function(eK){return function(eN){var eM,eL,eO,eP;eL=JSON.parse(eN.responseText);eO=[];for(eP in eL){eM=eL[eP];eO=eO.concat(eM)}return eC(eO)}})(this)})},_preview:function(T){return ax.show(T)},_lightbox_delete:function(T){var ev;ev=T.memo.photo;h.log_interaction(dI.DELETE,cD.LIGHTBOX);return this.show_delete_photos_modal([ev])},_lightbox_remove:function(ev){var T;T=ev.memo.photo;this.get_current_collection().remove_photos([T]);return h.log_interaction(dI.REMOVE,cD.LIGHTBOX)},_show_duplicates_modal:function(ev,eK){var eC,eJ,eA,eE,eD,ex,eG,ew,eB,eF,T,eI,ey,eH,ez;eD=ev.duplicates_info.slice(0);eD.push(ev);eD.sort(function(eM,eL){return eL.mtime-eM.mtime});eE=$("cu-duplicate-files");ex=[];for(ey=0,eH=eD.length;ey<eH;ey++){eA=eD[ey];eJ="Dropbox"+an.normalize(an.parent_dir(eA.fq_path));ex.push(this._cu_duplicate_tmpl({thumbnail_url:eA.thumbnail_url,filename_snippet:bt.em_snippet(eA.filename,this.DUPLICATES_SNIPPET_LENGTH),path_snippet:bt.em_snippet(eJ,this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(eA)}))}eE.__date(ex);if(eD.length>=5){eE.addClassName("scroll")}else{eE.removeClassName("scroll")}ez=cB.categorize_files([ev]),eF=ez[0],T=ez[1];if(eF){ew=dU("There are multiple copies of this photo.");eB=dU("Delete all copies of this photo?")}else{ew=dU("There are multiple copies of this video.");eB=dU("Delete all copies of this video?")}if(eK){eG="delete_32";eI=eB;eC=ew+" "+dU("Would you like to delete them all?");$("cu-delete-all-duplicates").show()}else{eG="folder_32";eI=dU("Show in folder");eC=ew+" "+dU("Which folder would you like to view?");$("cu-delete-all-duplicates").hide()}cS.fillVal(eC,"cu-duplicates-desc");return ep.show(eI,$("cu-duplicates-modal"),{action:this._delete_photos.curry([ev])})},_show_delete_multiple_duplicates_modal:function(eH,eC){var eG,eA,eD,ew,ev,eB,ez,eE,T,ex,eF,ey;eD=$("cu-multiple-duplicate-files");ew=[];for(ex=0,eF=eC.length;ex<eF;ex++){eA=eC[ex];eG="Dropbox"+an.normalize(an.parent_dir(eA.fq_path));ew.push(this._cu_duplicate_tmpl({thumbnail_url:eA.thumbnail_url,filename_snippet:bt.em_snippet(eA.filename,this.DUPLICATES_SNIPPET_LENGTH),path_snippet:bt.em_snippet(eG,this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(eA)}))}eD.__date(ew);if(eC.length>=5){eD.addClassName("scroll")}else{eD.removeClassName("scroll")}ey=cB.categorize_files(eH),eE=ey[0],T=ey[1];if(eE&&T){ev=dU("Delete %(num_files)s files and all copies?").format({num_files:eH.length});eB=dU("There are multiple copies of these files in your Dropbox.");ez=dU("Show files with multiple copies")}else{if(eE){ev=dU("Delete %(num_photos)s photos and all copies?").format({num_photos:eH.length});eB=dU("There are multiple copies of these photos in your Dropbox.");ez=dU("Show photos with multiple copies")}else{ev=dU("Delete %(num_videos)s videos and all copies?").format({num_videos:eH.length});eB=dU("There are multiple copies of these videos in your Dropbox.");ez=dU("Show videos with multiple copies")}}cS.fillVal(eB,"cu-multiple-duplicates-desc");cS.fillVal(ez,"cu-multiple-duplicates-show");$("cu-multiple-duplicates-modal").removeClassName("show-duplicates");return ep.show(ev,$("cu-multiple-duplicates-modal"),{action:this._delete_photos.curry(eH)})},show_timestamps_modal:function(ez){var ev,ew,ex,T,ey;ez.sort_by_key((function(eA){return eA.time_taken}),true);T=(function(){var eC,eB,eA;eA=[];for(eC=0,eB=ez.length;eC<eB;eC++){ex=ez[eC];eA.push(ex.time_taken)}return eA})();ev=(function(){var eC,eB,eA;eA=[];for(eC=0,eB=ez.length;eC<eB;eC++){ex=ez[eC];eA.push(ex.item_counter)}return eA})();ew=(function(){var eC,eB,eA;eA=[];for(eC=0,eB=T.length;eC<eB;eC++){ey=T[eC];if(ey==null){eA.push(ey)}}return eA})();if(ew.length===T.length){return this._show_add_timestamps_modal(ez,T,ev)}else{if(ew.length===0){return this._show_edit_timestamps_modal(ez,T,ev)}else{return ci(false,"Timestamp modal should only open when all selected photos either have or don't have timestamp information.")}}},_scroll_to_photo_after_timestamp_edit:function(T,ev){return this._refresh_photo_events((function(ew){return function(){var ex,ey;ey=("m_"+(ev.getFullYear()))+(""+(ev.getMonth()+1)).lpad(2);ex=ew.get_timeline().events.valueFromKey(ey);ci(ex!=null,"Event is missing after a timestamp edit!");dV.update("2/3");ex.on_load_all_metadata=function(){ew.get_timeline().scroll_to_photo_with_key(T.uniqueness_key);dV.hide();return Y.success("New timestamps have been saved!")};if(ex.has_loaded_metadata()){ex.on_load_all_metadata();return ex.on_load_all_metadata=null}else{return ex.load_metadata()}}})(this))},_show_add_timestamps_modal:function(ey,ev,T){var ex,ew;ew=bf("#add-timestamp-modal");ex=new D("date_picker",{disable_future:true});return ep.show("Set Timestamps",ew[0],{action:(function(ez){return function(){var eD,eH,eF,eG,eB,eC,eE,eA;eF=ds.to_iso8601_date(ex.selected_date,false,true);eG=(function(){var eK,eJ,eI;eI=[];for(eC=eK=0,eJ=ey.length;0<=eJ?eK<eJ:eK>eJ;eC=0<=eJ?++eK:--eK){eI.push(eF)}return eI})();eB={};for(eD=eE=0,eA=T.length;eE<eA;eD=++eE){eH=T[eD];eB[eH]=eG[eD]}dV.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(eB)},onSuccess:function(eI){dV.update("1/3");return ez._scroll_to_photo_after_timestamp_edit(ey[0],ex.selected_date)}})}})(this)})},_show_edit_timestamps_modal:function(eC,eB,ex){var T,eA,ew,ey,ez,ev;eA=bf("#edit-timestamp-modal");T=(function(){var eF,eE,eD;eD=[];for(eF=0,eE=eB.length;eF<eE;eF++){ey=eB[eF];eD.push(I.toUTCDate(new Date(ey)))}return eD})();ew={year:0,month:0,day:0,hour:0};ez=function(eD){return dU("%(date)s at %(time)s").format({date:I.localize(eD),time:I.format(eD,Constants.time_format)})};ev=function(eD,eH,eI,eG){var eF,eE;if(eD==null){eD=0}if(eH==null){eH=0}if(eI==null){eI=0}if(eG==null){eG=0}ew.year+=eD;ew.month+=eH;ew.day+=eI;ew.hour+=eG;eE=bE.increment_date(new Date(T[0]),ew.year,ew.month,ew.day,ew.hour,0);eF=bE.increment_date(new Date(T[T.length-1]),ew.year,ew.month,ew.day,ew.hour,0);if(eC.length===1){return eA.find("#timestamp-new").text(ez(eE))}else{eA.find("#timestamp-new-start").text(ez(eE));return eA.find("#timestamp-new-end").text(ez(eF))}};if(eC.length===1){eA.find("#edit-timestamp-single").show();eA.find("#edit-timestamp-multi").hide();eA.find("#timestamp-current").text(ez(T[0]))}else{eA.find("#edit-timestamp-single").hide();eA.find("#edit-timestamp-multi").show();eA.find("#timestamp-current-start").text(ez(T[0]));eA.find("#timestamp-current-end").text(ez(T[T.length-1]))}ev();bf("#timestamp-year-plus").on("click",ev.curry(1,0,0,0));bf("#timestamp-year-minus").on("click",ev.curry(-1,0,0,0));bf("#timestamp-month-plus").on("click",ev.curry(0,1,0,0));bf("#timestamp-month-minus").on("click",ev.curry(0,-1,0,0));bf("#timestamp-day-plus").on("click",ev.curry(0,0,1,0));bf("#timestamp-day-minus").on("click",ev.curry(0,0,-1,0));bf("#timestamp-hour-plus").on("click",ev.curry(0,0,0,1));bf("#timestamp-hour-minus").on("click",ev.curry(0,0,0,-1));ep.onHide=function(){var eD,eG,eE,eF;eF=["year","month","day","hour"];for(eG=0,eE=eF.length;eG<eE;eG++){eD=eF[eG];bf("#timestamp-"+eD+"-plus").off("click");bf("#timestamp-"+eD+"-minus").off("click")}ep.onHide=null;return ep.hide()};return ep.show("Edit Timestamps",eA[0],{action:(function(eD){return function(){var eN,eK,eE,eF,eL,eP,eM,eI,eO,eJ,eH,eG;if((((ew.year===(eG=ew.month)&&eG===(eH=ew.day))&&eH===(eJ=ew.hour))&&eJ===0)){return}h.log_interaction(dI.EDIT_TIMESTAMP,cD.PCM,{num_photos:eC.length});eF=(function(){var eS,eR,eQ;eQ=[];for(eS=0,eR=T.length;eS<eR;eS++){eN=T[eS];eQ.push(bE.increment_date(eN,ew.year,ew.month,ew.day,ew.hour,0))}return eQ})();eL=(function(){var eS,eR,eQ;eQ=[];for(eS=0,eR=eF.length;eS<eR;eS++){eP=eF[eS];eQ.push(ds.to_iso8601_date(eP,false,true))}return eQ})();eM={};for(eK=eI=0,eO=ex.length;eI<eO;eK=++eI){eE=ex[eK];eM[eE]=eL[eK]}dV.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(eM)},job:eC.length>eD.NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP,job_user:cj.get_viewer().photos_user,onSuccess:function(eQ){dV.update("1/3");return eD._scroll_to_photo_after_timestamp_edit(eC[0],eF[0])}})}})(this)})},_preload_file_previews:function(ex){var eD,eB,ew,T,eI,eH,eE,eC,eF,eA,ez,eG,ev,ey;eF=this.get_timeline().get_photos();if(ex[0]<=ex[ex.length-1]){eC=null;for(eA=0,eG=ex.length;eA<eG;eA++){eB=ex[eA];T=eF[eB];if(T.status!==F.PLACEHOLDER){continue}eI=T.event;if(eC==null){eC=eI;eE=T}if(eI===eC){continue}if(eC.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}eC.load_metadata();eC=eI;eE=T}if((eC!=null)&&!eC.has_loaded_metadata()){eD=eC.photos.indexOf(eE);ew=eC.photos.indexOf(T);if(eC.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}return eC.load_metadata_range(eD,ew)}}else{ey=[];for(ez=0,ev=ex.length;ez<ev;ez++){eB=ex[ez];T=eF[eB];if(T.status!==F.PLACEHOLDER){continue}eI=T.event;eH=eI.photos.indexOf(T);ey.push(eI.load_metadata(eH))}return ey}},_lightbox_photo_change:function(eC){var T,eE,ez,eD,eA,ey,eB,ex,ew,ev;this._last_lightbox_photo=eC.memo.preview_obj.photo;T=eC.memo.index;ez=ax.num_previews();if(T===0||T===ez-1){return}if(eC.memo.direction===ax.NEXT||(eC.memo.direction==null)){eE=Math.min(T+this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,ez-1);return this._preload_file_previews((function(){ew=[];for(var eF=eB=T+1;eB<=eE?eF<=eE:eF>=eE;eB<=eE?eF++:eF--){ew.push(eF)}return ew}).apply(this))}else{if(eC.memo.direction===ax.PREV){eD=Math.max(T-this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,0);return this._preload_file_previews((function(){ev=[];for(var eF=ex=T-1;ex<=eD?eF<=eD:eF>=eD;ex<=eD?eF++:eF--){ev.push(eF)}return ev}).apply(this))}}},_lightbox_exit:function(T){return key.setScope(this.KEY_SCOPE)},_window_resize:function(){var ew,ev,ex,T;ev=$("cu-view").cumulativeOffset().top+$("photos-list").getLayout().get("margin-top")+$("photos-list").getLayout().get("padding-top");if(bf("#carousel-promo-banner").outerHeight()){ev+=bf("#carousel-promo-banner").outerHeight()-$("cu-view").cumulativeOffset().top}ew=$("cu-view").cumulativeOffset().left+$("photos-list").getLayout().get("margin-left")+$("photos-list").getLayout().get("padding-left");if((ex=this._all_photos_timeline)!=null){ex.update_offsets(ev,ew)}return(T=this._single_collection_timeline)!=null?T.update_offsets(ev,ew):void 0},_history_change_handler:function(eH,eG){var eC,eD,eE,ez,ex,eA,eF,eB,ey,ew,ev,T;if(this._init_finished){if(ep.shown()){ep.hide()}}$("photos-nav-item").removeClassName("selected");$$(".sidebar-album.selected").invoke("removeClassName","selected");if((eB=this.get_timeline())!=null){eB.unlisten()}if(eH==="all_albums"){cf.load_collections(null);this._in_all_collections_view=true;$("cu-view").removeClassName("single-collection");$("cu-view").addClassName("all-collections");if((ey=$("all-albums-sidebar"))!=null){ey.addClassName("selected")}ed.clear();document.title=dU("Albums")+" - Dropbox";cf.restore_all_albums_scroll_position();this._current_collection_gid=null;return}else{this._in_all_collections_view=false;$("cu-view").removeClassName("all-collections")}if(eH.startsWith("album/")){eC=cf.get_from_url("/photos/"+eH);ew=$$(".sidebar-album");for(eA=0,eF=ew.length;eA<eF;eA++){eE=ew[eA];if(eE.readAttribute("data-gid")===eC.gid){eE.addClassName("selected");break}}$("single-collection-title").__date(bt.em_snippet(eC.name,cf.HEADER_COLLECTION_SNIPPET_LENGTH,1));if(eC.shmodel_url!=null){$("single-collection-share-status").writeAttribute("href",eC.shmodel_url);if(((ev=eC.member_fnames)!=null?ev.length:void 0)>1){eD=dU("%(photo_video_desc)s from %(album_members)s",{comment:'for example: "3 photos and 1 video from Peter, Boris, and Ryan"'}).format({photo_video_desc:cB.album_desc(eC),album_members:ds.nice_list(eC.member_fnames)});$("single-collection-share-status").__date(eD)}else{$("single-collection-share-status").__date(dU("Shared"))}}else{$("single-collection-share-status").__date()}$("cu-view").addClassName("single-collection");if(!eC.is_creator){$("cu-view").addClassName("not-collection-creator")}document.title=""+eC.name+" - Dropbox";b7.log_event("show_collection",eC.gid,eC.num_photos,eC.is_anonymous)}else{eC=null;$("cu-view").removeClassName("single-collection");$("photos-nav-item").addClassName("selected");document.title=dU("Photos")+" - Dropbox"}ez=false;if(eC!=null){if(eC.gid!==this._current_collection_gid){ez=true}}else{if(this._all_photos_timeline==null){ez=true}}this._current_collection_gid=eC!=null?eC.gid:null;if(ez){this._refresh_view()}else{this._init_lightbox();this.get_timeline().init_timeline_nav();this.get_timeline().restore_scroll_position();this.get_timeline().listen()}if((this._last_lightbox_photo!=null)&&this.get_timeline().num_photos()){ex=this._last_lightbox_photo.uniqueness_key;this.get_timeline().scroll_to_photo_with_key(ex);if((T=$(ex))!=null){T.addClassName("wiggobble")}setTimeout((function(){return $(ex).removeClassName("wiggobble")}),1000);return this._last_lightbox_photo=null}}};var ay;ay=INLINE_JS.PhotosTour=A.PhotosTour={_frame:0,next:function(){var T;ep.show("",bf("#photos-tour-"+(this._frame+1))[0],null,null,700,null,null,false);T=this._frame;h.log_interaction(aP.SHOW_MODAL,"",{frame:T});bf("#modal-x").off("click");bf("#modal-x").on("click",((function(ev){return function(){return h.log_interaction(aP.EXIT_MODAL,"",{frame:T})}})(this)));return this._frame=(this._frame+1)%4},hide:function(T){h.log_interaction(T,"");return ep.hide()}};var cB;cB=A.PhotosUtil={categorize_files:function(ev){var ew,T;ew=ev.filter(function(ex){return ex.preview_type==="photo"});T=ev.filter(function(ex){return ex.preview_type==="video"});return[ew.length,T.length]},file_desc:function(ez,ew,T){var ev,ey,ex;if(ew==null){ew=false}if(T==null){T=false}ex=this.categorize_files(ez),ev=ex[0],ey=ex[1];return this._photo_video_desc(ev,ey,ew,T)},album_desc:function(ew,ev,T){if(ev==null){ev=false}if(T==null){T=false}return this._photo_video_desc(ew.num_photos,ew.num_videos,ev,T)},_photo_video_desc:function(ev,eA,ew,T){var ex,ez,ey;ez=aR("%d photo","%d photos",ev,{comment:"This will be used in a phrase such as 'x photos and y videos'"}).format(ev);ey=aR("%d video","%d videos",eA,{comment:"This will be used in a phrase such as 'x photos and y videos'"}).format(eA);if(ev&&eA){if(ew){ex=ev+eA;return aR("%d item","%d items",ex).format(ex)}else{if(T){return new es(""+ez+"<br/>"+ey)}else{return dU("%(num_photos)s and %(num_videos)s",{comment:"num_photos and num_videos may be like either '1 photo' or '%d photos'"}).format({num_photos:ez,num_videos:ey})}}}else{if(ev){return ez}else{if(eA){return ey}else{return""}}}}};var ed,bk=[].indexOf||function(ew){for(var ev=0,T=this.length;ev<T;ev++){if(ev in this&&this[ev]===ew){return ev}}return -1};ed=INLINE_JS.PhotosSelection=A.PhotosSelection={CHANGE_EVT:"db:photos_selection:change",SHIFT_KEY_CODE:16,DRAG_STATUS_OFFSET:16,DRAG_START_THRESHOLD:10,SCROLL_BAR_WIDTH:10,_selected:[],_context_selected:null,_highlighted:[],_dehighlighted:[],_last_selected:null,_last_mouseover:null,_drag_select:{},_marquee:{},_drag_drop:{},_events_highlighting:[],_last_highlight_from_photo:null,_last_highlight_to_photo:null,_select_highlighted_waiting:0,_show_share_after_loading_selected:false,_num_pending_events_with_selections:0,_max_num_pending_events_with_selections:0,listen:function(){$(document.body).on("keydown",(function(T){return function(ev){if(ev.keyCode===T.SHIFT_KEY_CODE&&T._last_mouseover&&!y.focus_in_input()){return T._highlight_range(T._last_selected,T._last_mouseover)}}})(this));$(document.body).on("keyup",(function(T){return function(ev){if(ev.keyCode===T.SHIFT_KEY_CODE&&!T._marquee.active){return T.clear_highlighted()}}})(this));key("delete, command+backspace, backspace",bp.KEY_SCOPE,(function(T){return function(ev){ev.preventDefault();if(bp.in_single_collection_view()){if(T._selected.length){return cf.show_remove_photos_modal(bp.get_current_collection(),T._selected)}}else{if(T._selected.length){return bp.show_delete_photos_modal(T._selected)}}}})(this));key("esc",bp.KEY_SCOPE,(function(T){return function(ew){var ev;if(typeof ew.preventDefault==="function"){ew.preventDefault()}if(T._drag_drop.active){T._drag_drop.active=false;if((ev=$("albums-sidebar-list"))!=null){ev.removeClassName("drag-drop")}return $("photos-drag-status").removeClassName("active")}else{T.clear();return h.log_interaction(dI.CLEAR_SELECTED,cD.ESC)}}})(this));$(document.body).on("mouseover",".cu-thumb",this._photo_mouseover.bind(this));$(document.body).on("mouseout",".cu-thumb",this._photo_mouseout.bind(this));$(document.body).on("mousedown",this._body_mousedown.bind(this));$(document.body).on("mousemove",this._body_mousemove.bind(this));$(document).on("mouseup",this._body_mouseup.bind(this));$(document.body).on("dblclick",this._body_double_click.bind(this));return x.init(null,bf("#cu-header").height())},is_selection_active:function(){return this._highlighted.length||this._selected.length||this._marquee.active||this._drag_drop.active||this._drag_select.active},get:function(){return this._selected},contains:function(ev){var T,ex,ew;ex=(function(){var eB,ez,eA,ey;eA=this._selected;ey=[];for(eB=0,ez=eA.length;eB<ez;eB++){T=eA[eB];ey.push(T.uniqueness_key)}return ey}).call(this);return ew=ev.uniqueness_key,bk.call(ex,ew)>=0},clear:function(){this._selected=[];this._last_selected=null;$$(".cu-thumb.selected").invoke("removeClassName","selected");$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected");eb.hide_all();return document.fire(ed.CHANGE_EVT)},clear_highlighted:function(){this._highlighted=[];this._dehighlighted=[];if(!this._select_highlighted_waiting){$$(".cu-thumb.highlighted").invoke("removeClassName","highlighted");$$(".cu-thumb.dehighlighted").invoke("removeClassName","dehighlighted");this._last_highlight_from_photo=null;return this._last_highlight_to_photo=null}},photo_click:function(ev,T){if(ev.isRightClick()&&!ev.shiftKey){return}if(ev.shiftKey){return this._select_highlighted()}else{if(this.contains(T)){return this._remove(T)}else{return this._add(T)}}},num_selected:function(){return this._selected.length},refresh:function(ex){var ez,eA,ew,eB,ey,ev,T;eB=(function(){var eF,eD,eE,eC;eE=this._selected;eC=[];for(eF=0,eD=eE.length;eF<eD;eF++){ew=eE[eF];eC.push(ew.uniqueness_key)}return eC}).call(this);T=[];for(ey=0,ev=ex.length;ey<ev;ey++){eA=ex[ey];ez=eB.indexOf(eA.uniqueness_key);if(ez>=0){T.push(this._selected[ez]=eA)}else{T.push(void 0)}}return T},inc_num_loading_events_before_select:function(T){if(!this._show_share_after_loading_selected){dV.show(dU("Loading photos..."))}this._show_share_after_loading_selected=T;this._num_pending_events_with_selections++;if(this._num_pending_events_with_selections>this._max_num_pending_events_with_selections){return this._max_num_pending_events_with_selections=this._num_pending_events_with_selections}},dec_num_loading_events_before_select:function(){this._num_pending_events_with_selections--;dV.update(""+(this._max_num_pending_events_with_selections-this._num_pending_events_with_selections)+"/"+this._max_num_pending_events_with_selections);if(this._num_pending_events_with_selections===0){dV.hide();if(this._show_share_after_loading_selected){this._show_share_after_loading_selected=false;if(this.num_selected()>0){return bp._share_selected()}}}},_photo_mouseover:function(T){this._last_mouseover=bp.get_timeline().get_photo_for_thumb_elm($(T.target));if(T.shiftKey){return this._highlight_range(this._last_selected,this._last_mouseover)}else{if(this._drag_select.active){return this._highlight_range(this._drag_select.anchor,this._last_mouseover,true)}}},_photo_mouseout:function(T){if(!this._marquee.active){this.clear_highlighted();return this._last_mouseover=null}},_body_mousedown:function(ex){var T,ev,ew;if(bp.in_all_collections_view()||ex.isRightClick()||this._invalid_mouse_target($(ex.target))){return}a1.hide();eb.hide_all();T=(ew=bp.get_timeline())!=null?ew.get_photo_for_thumb_elm($(ex.target)):void 0;if(T!=null){if(this.contains(T)||!ed.drag_select_enabled){ev=y.scroll_offsets();this._drag_drop.active=true;this._drag_drop.start_x=ex.clientX+ev.left;this._drag_drop.start_y=ex.clientY+ev.top;this._drag_drop.anchor=$(ex.target);this._drag_drop.single_photo=this.contains(T)?null:T;this._build_drag_status(T);this._update_drag_status_position(ex)}else{this._drag_select.active=true;this._drag_select.anchor=T}}else{ev=y.scroll_offsets();if((ex.clientX+ev.left)>=($(document.body).getWidth()-this.SCROLL_BAR_WIDTH)){return}this._marquee.active=true;this._marquee.start_x=ex.clientX+ev.left;this._marquee.start_y=ex.clientY+ev.top;this._marquee.x_max_boundary=-1;this._marquee.y_max_boundary=-1}return x.start()},_body_mousemove:function(ex){var ev,T,ey,ew;ev=y.scroll_offsets();T=ex.clientX+ev.left;ey=ex.clientY+ev.top;if(this._marquee.active){if(!$("marquee").visible()){if(Math.abs(T-this._marquee.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(ey-this._marquee.start_y)<this.DRAG_START_THRESHOLD){return}}this._marquee.end_x=T;this._marquee.end_y=ey;return this._draw_marquee()}else{if(this._drag_drop.active){if(!$("photos-drag-status").hasClassName("active")){if(Math.abs(T-this._drag_drop.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(ey-this._drag_drop.start_y)<this.DRAG_START_THRESHOLD){return}}this._update_drag_status_position(ex);$$(".sidebar-album").invoke("removeClassName","album-flash");if((ew=$("albums-sidebar-list"))!=null){ew.addClassName("drag-drop")}return $("photos-drag-status").addClassName("active")}}},_body_mouseup:function(ew){var ev,T;if(this._drag_select.active){this._drag_select.active=false;this._select_highlighted()}if(this._marquee.active){this._marquee.active=false;$("marquee").hide();ev=this._highlighted.length;this._select_highlighted();if(ev){h.log_interaction(dI.MARQUEE_SELECT,cD.DRAG,{num_selected:ev})}}if(this._drag_drop.active){if($(ew.target)===this._drag_drop.anchor&&$("photos-drag-status").hasClassName("active")){this._drag_drop.ignore_next_click=true}this._drag_drop.active=false;this._drag_drop.anchor=null;this._drag_drop.single_photo=null;if((T=$("albums-sidebar-list"))!=null){T.removeClassName("drag-drop")}$("photos-drag-status").removeClassName("active")}return x.end()},_body_double_click:function(T){if(bp.get_timeline().get_photo_for_thumb_elm($(T.target))||this._invalid_mouse_target($(T.target))){return}this.clear();return h.log_interaction(dI.CLEAR_SELECTED,cD.DBL_CLICK)},_draw_marquee:function(){var T,ey,ex,ew,ev;ev=Math.abs(this._marquee.start_x-this._marquee.end_x);T=Math.abs(this._marquee.start_y-this._marquee.end_y);ex=Math.min(this._marquee.start_y,this._marquee.end_y);ey=Math.min(this._marquee.start_x,this._marquee.end_x);$("marquee").setStyle({width:ev+"px",height:T+"px",top:ex+"px",left:ey+"px"});$("marquee").show();ew=false;if(bp.get_timeline()!=null){if(this._marquee.end_x>=this._marquee.x_max_boundary||this._marquee.end_x<=this._marquee.x_min_boundary){this._update_marquee_x_bounds(this._marquee.end_x);ew=true}if(this._marquee.end_y>=this._marquee.y_max_boundary||this._marquee.end_y<=this._marquee.y_min_boundary){this._update_marquee_y_bounds(this._marquee.end_y);ew=true}if(ew){return this._update_marquee_highlight(ex,ey,ev,T)}}},_update_marquee_highlight:function(eF,ew,T,eH){var eD,eE,eB,ev,eA,ez,eG,eC,ey,ex;this.clear_highlighted();ev=[];eE=bp.get_timeline().grid.photo_col_offsets.length;eC=bp.get_timeline().grid.photo_col_offsets.slice(0,eE-1);for(eD=eA=0,eG=eC.length;eA<eG;eD=++eA){eB=eC[eD];if(eB<=ew+T&&bp.get_timeline().grid.photo_col_offsets[eD+1]>=ew){ev.push(eD)}}ex=[];for(eD=ez=0,ey=bp.get_timeline().events.length();0<=ey?ez<ey:ez>ey;eD=0<=ey?++ez:--ez){ex.push(bp.get_timeline().events.valueAtIndex(eD).marquee_highlight(eF,eF+eH,ev))}return ex},_update_marquee_x_bounds:function(T){var ex,eA,eB,ez,ew,ey,ev;eA=$(document.body).getWidth();if(T<bp.get_timeline().grid.photo_col_offsets.first()){this._marquee.x_min_boundary=-1;return this._marquee.x_max_boundary=bp.get_timeline().grid.photo_col_offsets.first()}else{if(T>bp.get_timeline().grid.photo_col_offsets.last()){this._marquee.x_min_boundary=bp.get_timeline().grid.photo_col_offsets.last();return this._marquee.x_max_boundary=eA}else{ey=bp.get_timeline().grid.photo_col_offsets;ev=[];for(ex=ez=0,ew=ey.length;ez<ew;ex=++ez){eB=ey[ex];if(eB>T){this._marquee.x_min_boundary=bp.get_timeline().grid.photo_col_offsets[ex-1];this._marquee.x_max_boundary=eB;break}else{ev.push(void 0)}}return ev}}},_update_marquee_y_bounds:function(eB){var T,ey,ex,eA,ew,ez,ev;ex=$(document.body).getHeight();if(eB<bp.get_timeline().grid.photo_row_offsets.first()){this._marquee.y_min_boundary=-1;return this._marquee.y_max_boundary=bp.get_timeline().grid.photo_row_offsets.first()}else{if(eB>bp.get_timeline().grid.photo_row_offsets.last()){this._marquee.y_min_boundary=bp.get_timeline().grid.photo_row_offsets.last();return this._marquee.y_max_boundary=ex}else{ez=bp.get_timeline().grid.photo_row_offsets;ev=[];for(ey=eA=0,ew=ez.length;eA<ew;ey=++eA){T=ez[ey];if(T>eB){this._marquee.y_min_boundary=bp.get_timeline().grid.photo_row_offsets[ey-1];this._marquee.y_max_boundary=T;break}else{ev.push(void 0)}}return ev}}},_build_drag_status:function(ex){var ew,T,ev;T=bp.get_timeline().get_thumb_elm_for_photo(ex);ev=T.down("img.thumb-content").cloneNode(false);$("photos-drag-status").down(".thumb").__date(ev);ew=this._drag_drop.single_photo?[this._drag_drop.single_photo]:this._selected;return $("photos-drag-status").down(".count").__date(cB.file_desc(ew,false,true))},_update_drag_status_position:function(T){return $("photos-drag-status").setStyle({left:(T.pointerX()-y.scroll_offsets().left+this.DRAG_STATUS_OFFSET)+"px",top:(T.pointerY()-y.scroll_offsets().top+this.DRAG_STATUS_OFFSET)+"px"})},_highlight_range:function(eG,eF,ew){var eE,T,ex,eB,eD,eC,ev,ez,eA,ey;if(ew==null){ew=false}this.clear_highlighted();this._events_highlighting=[];this._last_highlight_from_photo=eG;this._last_highlight_to_photo=eF;ex=bp.get_timeline().index_of_photo(eG);ev=bp.get_timeline().index_of_photo(eF);eE=!ew&&this.contains(eF)&&!this.contains(eG);ey=[];for(eB=ez=ex;ex<=ev?ez<=ev:ez>=ev;eB=ex<=ev?++ez:--ez){eC=bp.get_timeline().photo_at_index(eB);if(eC.status===F.PLACEHOLDER){if(eC.event!==eD){T=eC.event;if(!T.has_loaded_metadata()){T.on_load_all_metadata=this._highlight_range_incremental.bind(this);T.load_metadata();if(eA=T.unique_id,bk.call(this._events_highlighting,eA)<0){this._events_highlighting.push(T.unique_id)}ey.push(eD=T)}else{ey.push(void 0)}}else{ey.push(void 0)}}else{if(this.contains(eC)){if(eE){ey.push(this._dehighlight(eC))}else{ey.push(void 0)}}else{if(!eE){ey.push(this._highlight(eC))}else{ey.push(void 0)}}}}return ey},_highlight_range_incremental:function(T){var eB,ew,eC,ey,ez,ev,eA,ex;eC=this._last_highlight_from_photo;eA=this._last_highlight_to_photo;if(!((eC!=null)&&(eA!=null))){return}ew=bp.get_timeline().index_of_photo(eC);ev=bp.get_timeline().index_of_photo(eA);for(ey=ex=ew;ew<=ev?ex<=ev:ex>=ev;ey=ew<=ev?++ex:--ex){ez=bp.get_timeline().photo_at_index(ey);if(ez.status!==F.PLACEHOLDER&&!this.contains(ez)&&this._highlighted.indexOf(ez)===-1){this._highlight(ez)}}eB=this._events_highlighting.indexOf(T.unique_id);if(eB>=0){this._events_highlighting.splice(eB,1)}if(this._select_highlighted_waiting){dV.update(""+(this._select_highlighted_waiting-this._events_highlighting.length)+"/"+this._select_highlighted_waiting);if(this._events_highlighting.length===0){return this._select_highlighted()}}},_highlight_list:function(ex){var ew,ey,ev,T;this.clear_highlighted();T=[];for(ey=0,ev=ex.length;ey<ev;ey++){ew=ex[ey];if(!this.contains(ew)){T.push(this._highlight(ew))}else{T.push(void 0)}}return T},_select_highlighted:function(){var ex,eA,ey,ew,ev,ez,T;if(this._events_highlighting.length>0){dV.show(dU("Selecting photos..."));this._select_highlighted_waiting=this._events_highlighting.length;return}ez=this._highlighted;for(eA=0,ew=ez.length;eA<ew;eA++){ex=ez[eA];this._add(ex)}T=this._dehighlighted;for(ey=0,ev=T.length;ey<ev;ey++){ex=T[ey];this._remove(ex)}if(this._select_highlighted_waiting){dV.hide();this._select_highlighted_waiting=0}return this.clear_highlighted()},_highlight:function(ev){var T;this._highlighted.push(ev);T=bp.get_timeline().get_thumb_elm_for_photo(ev);return T!=null?T.addClassName("highlighted"):void 0},_dehighlight:function(ev){var T;this._dehighlighted.push(ev);T=bp.get_timeline().get_thumb_elm_for_photo(ev);return T!=null?T.addClassName("dehighlighted"):void 0},_add:function(ev){var T;ci(ev.status!==F.PLACEHOLDER,"placeholder photos can't be added to the selection",true,["photo_selection_placeholder"]);T=bp.get_timeline().get_thumb_elm_for_photo(ev);if(T!=null){T.addClassName("selected")}this._selected.push(ev);this._last_selected=ev;cS.fillVal(cB.file_desc(this._selected,true),"selected-desc");cS.fillVal(this._selected.length,"num-selected");$("cu-view").addClassName("photos-selected");this._check_for_single_selection();$("page-sidebar").addClassName("photos-selected");return document.fire(ed.CHANGE_EVT)},_remove:function(ew){var ev,T;T=bp.get_timeline().get_thumb_elm_for_photo(ew);if(T!=null){T.removeClassName("selected")}ev=this._selected.indexOf(ew);if(ev!==-1){this._selected.splice(ev,1);this._last_selected=ew;if(this._selected.length){cS.fillVal(cB.file_desc(this._selected,true),"selected-desc");cS.fillVal(this._selected.length,"num-selected")}else{$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected")}}this._check_for_single_selection();return document.fire(ed.CHANGE_EVT)},_invalid_mouse_target:function(ex){var ev,ew,T;ev=ex.classNames().toArray().concat(ex.up().classNames().toArray());return(bk.call(ev,"freshbutton")>=0)||(bk.call(ev,"freshbutton-blue")>=0)||(bk.call(ev,"freshbutton-lightblue")>=0)||(bk.call(ev,"freshbutton-blue-on-gray")>=0)||(bk.call(ev,"timeline-elm")>=0)||(ex.up(".no-marquee")!=null)||(ex.up("#context-menu")!=null)||(ex.up(".freshdropdown-menu")!=null)||ex.nodeName==="A"||((ew=ex.tagName.toUpperCase())==="INPUT"||ew==="TEXTAREA"||ew==="SELECT")||ep.shown()||((T=$("modal-progress-content"))!=null?T.visible():void 0)||ax.shown},_check_for_single_selection:function(){if(this._selected.length===1){return $("cu-view").addClassName("single-selection")}else{return $("cu-view").removeClassName("single-selection")}}};var cf,bk=[].indexOf||function(ew){for(var ev=0,T=this.length;ev<T;ev++){if(ev in this&&this[ev]===ew){return ev}}return -1};cf=INLINE_JS.PhotosCollections=A.PhotosCollections={SIDEBAR_COLLECTION_SNIPPET_LENGTH:10,HEADER_COLLECTION_SNIPPET_LENGTH:25,CONTEXT_MENU_COLLECTION_SNIPPET_LENGTH:11,NUM_PHOTOS_LONG_RUNNING_ADDS:100,NUM_PHOTOS_LONG_RUNNING_REMOVES:250,NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES:50,LOADING_SPINNER:new es('<br/><div class="cu-loading"><img src="/static/images/icons/ajax-loading-small.gif" /></div>'),_collections:[],_gid_to_collection:{},_url_to_collection:{},_collection_list_item_tmpl:null,_albums_sidebar_tmpl:null,_all_collections_loaded:false,_removed_pre_load:[],_all_albums_scroll_position:0,_num_loading_collections:0,init:function(ev,T){this._collections=ev;this._gid_to_collection=ev.dict_by("gid");this._url_to_collection=ev.dict_by("url");this._collection_list_item_tmpl=es.tmpl("collection_list_item_tmpl");this._albums_sidebar_tmpl=es.tmpl("albums_sidebar_tmpl");this._all_collections_loaded=false;this._sidebar_collections_loaded=false;this._num_loading_collections=0;this.refresh_album_views();return this._init_collections()},_init_collections:function(){var T;T=dX.deconstruct_url();if(T.path!=="/photos/all_albums"){return this.load_collections(5)}},load_collections:function(T){if(this._num_loading_collections!==null&&(this._num_loading_collections<T||T===null)){this._num_loading_collections=T;return new Ajax.DBRequest("/collections",{parameters:{limit:T},allow_retries:true,onSuccess:(function(ev){return function(ey){var eC,eB,ex,eA,ew,ez;ex=JSON.parse(ey.responseText);for(eA=0,ew=ex.length;eA<ew;eA++){eB=ex[eA];if(!(eB.gid in ev._gid_to_collection)&&!(ez=eB.gid,bk.call(ev._removed_pre_load,ez)>=0)){eC=new W(eB,false);ev._collections.push(eC);ev._gid_to_collection[eC.gid]=eC;ev._url_to_collection[eC.url]=eC}}if(T===null||ex.length<T){ev._all_collections_loaded=true;ev._sidebar_collections_loaded=true}if(T>=5){ev._sidebar_collections_loaded=true}return ev.refresh_album_views()}})(this)})}},reload:function(){this._collections=[];this._gid_to_collection={};this._url_to_collection={};this._all_collections_loaded=false;this.refresh_album_views();return this._init_collections()},listen:function(){$("single-collection-title").observe("click",(function(T){return function(ev){if(!bp.get_current_collection().is_creator){return}T.header_rename();return h.log_interaction(dI.RENAME_ALBUM,cD.CLICK_TITLE)}})(this));$(document.body).on("contextmenu",".albums-list-item",this._albums_list_item_contextmenu.bind(this));$(document.body).on("click",".show-collection-target",this._show_collection_click.bind(this));$(document.body).on("click",".collection-shmodel-target",this._collection_shmodel_click.bind(this));$(document.body).on("click",".add-to-album-target",this._add_to_album_click.bind(this));$(document.body).on("mouseover",".add-to-album-drop-target",this._drop_target_mouseover.bind(this));$(document.body).on("mouseup",".add-to-album-drop-target",this._drop_target_mouseup.bind(this));$(document.body).on("mouseout",".add-to-album-drop-target",this._drop_target_mouseout.bind(this));$(document.body).on("click",".create-album-target",this._create_album_click.bind(this));document.observe(a1.HIDE_EVT,(function(){return $$(".albums-list-item.context-selected").invoke("removeClassName","context-selected")}));Event.observe(window,"scroll",this._window_scroll.bind(this));document.observe(W.CREATE_EVT,this._collection_created.bind(this));document.observe(W.ADD_EVT,this._collection_photos_added.bind(this));document.observe(W.REMOVE_EVT,this._collection_photos_removed.bind(this));document.observe(W.UNDO_REMOVE_EVT,this._collection_undid_remove.bind(this));document.observe(W.RENAME_EVT,this._collection_renamed.bind(this));document.observe(W.DELETE_EVT,this._collection_deleted.bind(this));document.observe(W.SHARE_EVT,this._collection_shared.bind(this));document.observe(W.UNSHARE_EVT,this._collection_unshared.bind(this));return document.observe(W.COVER_CHANGE_EVT,this._collection_cover_changed.bind(this))},render_all_albums_view:function(){var ey,ev,ex,T,ew;if(this._collections.length||!this._all_collections_loaded){$("albums-empty").hide()}else{$("albums-empty").show()}ev=[];ew=this._collections;for(ex=0,T=ew.length;ex<T;ex++){ey=ew[ex];ev.push(this._collection_list_item_tmpl({collection:ey,additional_class:"albums-list-item show-collection-target",Sprite:b6,Emstring:bt}))}$("albums-list").__date(ev);$("albums-list").__sert(new Element("div",{"class":"clearfix"}));if(!this._all_collections_loaded){return $("albums-list").__sert(this.LOADING_SPINNER)}},render_add_to_album_modal:function(){var ez,ev,ew,ey,T,ex;ev=[];ew={name:dU("Create new album"),thumbnail_url_256:"/static/images/new_album_big.png"};ev.push(this._collection_list_item_tmpl({collection:ew,additional_class:"create-album-target",hide_icons:true,Sprite:b6,Emstring:bt}));ex=this._collections;for(ey=0,T=ex.length;ey<T;ey++){ez=ex[ey];ev.push(this._collection_list_item_tmpl({collection:ez,additional_class:"add-to-album-target",Sprite:b6,Emstring:bt}))}$("add-to-album-modal-list").__date(ev);if(!this._all_collections_loaded&&this._collections.length>0){return $("add-to-album-modal-list").__sert(this.LOADING_SPINNER)}},render_albums_sidebar:function(){var eA,eC,ey,eB,ez,ex,ev,T,ew;if(!this._sidebar_collections_loaded){return}if(!this._collections.length){$("albums-sidebar").hide();$("main-nav-bottom").show();return}$("main-nav-bottom").hide();$("albums-sidebar").show();eC=this._albums_sidebar_tmpl({collections:this._collections.slice(0,5),_:dU,Sprite:b6,PhotosCollections:cf});if((ez=$("albums-sidebar"))!=null){ez.__date(eC)}if((ex=$("all-albums-sidebar"))!=null){ex.observe("click",bp.show_all_collections)}if((ev=$("all-albums-sidebar"))!=null){ev.observe("mouseup",(function(eD){return function(eE){var eF;if(!ed._drag_drop.active){return}if(ed._drag_drop.single_photo!=null){eF=[ed._drag_drop.single_photo]}else{eF=ed.get()}eD.show_add_to_album_modal(eE,eF);return h.log_interaction(dI.ADD_TO_OTHER_ALBUM,cD.DROP_TARGET,{num_photos:ed.get().length})}})(this))}if(bp.in_all_collections_view()){return $("all-albums-sidebar").addClassName("selected")}else{if(bp.in_single_collection_view()){T=$$(".sidebar-album");ew=[];for(ey=0,eB=T.length;ey<eB;ey++){eA=T[ey];if(eA.readAttribute("data-gid")===bp.get_current_collection().gid){eA.addClassName("selected");break}else{ew.push(void 0)}}return ew}}},refresh_album_views:function(ev){var T;if(ev==null){ev=null}T=(function(ew){return function(){ew.render_all_albums_view();ew.render_albums_sidebar();return ew.render_add_to_album_modal()}})(this);if(ev!=null?ev.length:void 0){return new Ajax.DBRequest("/collections",{allow_retries:true,parameters:{collection_gids:JSON.stringify(ev.unique())},onSuccess:(function(ew){return function(eG){var eF,eE,ey,eD,eB,eA,eH,ex,eC,ez;eC=JSON.parse(eG.responseText);for(eB=0,eH=eC.length;eB<eH;eB++){ey=eC[eB];eE=new W(ey,false);ew._gid_to_collection[eE.gid]=eE;ew._url_to_collection[eE.url]=eE;ez=ew._collections;for(eD=eA=0,ex=ez.length;eA<ex;eD=++eA){eF=ez[eD];if(eF.gid===eE.gid){ew._collections[eD]=eE;break}}}return T()}})(this)})}else{return T()}},show_add_to_album_modal:function(T,ev){if(ev!==ed.get()&&(ed._drag_drop.single_photo==null)){ed._context_selected=ev}ep.onHide=function(){ed._context_selected=null;delete ep.onHide;return ep.hide()};ep.show(dU("Choose an album"),$("add-to-album-modal"),false,false,893);return this.load_collections(null)},add_photos:function(ew,ey,ev){var T,ex;if(ev==null){ev=true}ex=null;if(bp.in_single_collection_view()){ex=bp.get_current_collection().gid}T=ey.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;Y.success(dU("Adding to album..."));return ew.add_photos(ey,ex,T,ev)},show_remove_photos_modal:function(ex,ez){var ew,T,ey,ev;ev=cB.categorize_files(ez),T=ev[0],ey=ev[1];if(T&&ey){ew=aR("Remove %(file_count)s item?","Remove %(file_count)s items?",ez.length)}else{if(T){ew=aR("Remove %(file_count)s photo?","Remove %(file_count)s photos?",ez.length)}else{ew=aR("Remove %(file_count)s video?","Remove %(file_count)s videos?",ez.length)}}ew=ew.format({file_count:ez.length});cS.fillVal(cB.file_desc(ez),"collection-remove-files");cS.fillVal(ex.name.escapeHTML(),"collection-remove-name");return ep.show(ew,cS.fromElm("collection-remove-modal"),{action:(function(eA){return function(){var eB;ez=ez.slice(0);eB=ez.length>eA.NUM_PHOTOS_LONG_RUNNING_REMOVES;return ex.remove_photos(ez,eB)}})(this)})},header_rename:function(){if(bf("#single-collection-title-container").hasClass("editing")){return}bf("#single-collection-title-container").addClass("editing");return bp.get_current_collection().rename($("single-collection-title"))},show_delete_modal:function(ev){var T;cS.fillVal(ev.name.escapeHTML(),"collection-delete-name");T=dU("Delete album?");return ep.show(T,cS.fromElm("collection-delete-modal"),{action:function(){if(ev.num_items>this.NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES){Y.success(dU("Deleting '%(collection_name)s'...").format({collection_name:ev.name}),100)}return ev["delete"]()}})},show_unshare_modal:function(ev){var T;cS.fillVal(ev.name.escapeHTML(),"collection-unshare-name");T=dU("Unshare album?");return ep.show(T,cS.fromElm("collection-unshare-modal"),{action:function(){return ev.unshare()}})},create:function(eC,eB,eG,ev){var ex,ey,ew,ez,eE,eF,eD,T,eA;if(ev==null){ev=false}if(eC){Event.extend(eC).preventDefault();eA=$(eC.target);if(eA.hasClassName("inplaceeditor-form")||(eA.up(".inplaceeditor-form")!=null)){return}if(eA.up("#context-menu")){ex=true}else{if(eA.up(".freshdropdown-menu")){ew=true}}}bp.enable_selection();if(!eG){eG=ed.get()}ez=(function(){var eJ,eI,eH;eH=[];for(eJ=0,eI=eG.length;eJ<eI;eJ++){T=eG[eJ];eH.push(T.item_counter)}return eH})();eG.sort_by_key(function(eH){return eH.time_taken});eE=eG.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;eD=(function(eH){return function(eJ){var eM,eK,eI,eL;eK=JSON.parse(eJ.responseText);eM=new W(eK);ed.clear();eb.hide_all();a1.hide();ep.hide();bp.disable_selection();eL=dU("Created '%(collection_name)s'");eI=eM.name.escapeHTML();eL=eL.format({collection_name:"<a data-gid='"+eM.gid+"' class='show-collection-target'>"+eI+"</a>"});Y.success(new es(eL));return eH.flash_sidebar_album(eM.gid)}})(this);eF=function(){if(!ew){eb.hide_all()}if(!ex){a1.hide()}cf.render_albums_sidebar();return bp.disable_selection()};ey=new Ajax.InPlaceEditor(eB,"/collection_create",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:ev,initialText:"",cancelIfSame:true,clickToEdit:false,onCancel:eF,onFailure:function(){},savingText:dU("Creating..."),onLeaveEditMode:bp.disable_selection(),onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:eD,job:eE,job_user:cj.get_viewer().photos_user,progress_text:dU("Creating album...")},callback:function(eH,eJ){var eI;Y.success(dU("Creating album..."));eI={collection_name:eJ,item_counters:JSON.stringify(ez)};if(bp.in_single_collection_view()){eI.source_collection_gid=bp.get_current_collection().gid}return eI}});ey.enterEditMode();if(!ev){return ey._controls.editor.observe("blur",eF)}},toggle_more_selected_actions:function(T){if(T){Event.extend(T).preventDefault()}if(!$("more-selected-actions-menu").visible()){return eb.show($("more-selected-actions-menu"),$("more-selected-actions-button"))}},toggle_more_actions:function(T){var ev;if(T){Event.extend(T).preventDefault()}if(!$("more-collection-actions-menu").visible()){if(bp.get_current_collection().share_tkey!=null){$("unshare-album").show()}else{$("unshare-album").hide()}if(bB.msie_version_at_most(10)){ev=bf("#more-collection-actions-menu");if(!ev.parent().is("body")){bf(document.body).append(ev.remove())}}return eb.show($("more-collection-actions-menu"),$("more-collection-actions-button"))}},_collection_created:function(T){var ev;ev=T.memo.collection;if(!ev.is_anonymous){this._collections.unshift(ev)}this._gid_to_collection[ev.gid]=ev;this._url_to_collection[ev.url]=ev;return this.refresh_album_views()},_collection_changed:function(T){this._collections.removeItem(T);this._collections.unshift(T);return this.refresh_album_views()},_collection_photos_added:function(eB){var eA,ey,ex,eC,eD,ew,T,ev,eE,ez;eA=eB.memo.collection;eE=eB.memo.photos;eC=eB.memo.num_items_added;ew=eB.memo.num_photos_added;ev=eB.memo.num_videos_added;if(eB.memo.promote_collection&&eC>0){this._collection_changed(eA)}else{this.refresh_album_views()}if(eE===ed.get()){ed.clear()}if(eC<1){ez=cB.categorize_files(eE),eD=ez[0],T=ez[1];if(eD&&T){ex=aR("That item is already in '%(collection_name)s'","Those items are already in '%(collection_name)s'",eE.length)}else{if(eD){ex=aR("That photo is already in '%(collection_name)s'","Those photos are already in '%(collection_name)s'",eE.length)}else{ex=aR("That video is already in '%(collection_name)s'","Those videos are already in '%(collection_name)s'",eE.length)}}}else{if(ew&&ev){ex=aR("Added item to '%(collection_name)s'","Added items to '%(collection_name)s'",eE.length)}else{if(ew){ex=aR("Added photo to '%(collection_name)s'","Added photos to '%(collection_name)s'",eE.length)}else{ex=aR("Added video to '%(collection_name)s'","Added videos to '%(collection_name)s'",eE.length)}}}ey=eA.name.escapeHTML();ex=ex.format({collection_name:"<a data-gid='"+eA.gid+"' class='show-collection-target'>"+ey+"</a>"});return Y.success(new es(ex))},_collection_photos_removed:function(ev){var ew,ex,T;ew=ev.memo.collection;ex=ev.memo.photos;T=bp.undo_enabled?ev.memo.undo_changeset:null;bp.get_timeline().remove_photos(ex);this._collection_changed(ew);return Y.success(dU("Removed %(files_desc)s from '%(collection_name)s'").format({files_desc:cB.file_desc(ex),collection_name:ew.name}),null,null,T,(function(){return ew.undo_remove(T)}))},_collection_undid_remove:function(T){var ev;ev=T.memo.collection;bp.get_timeline().restore_removed_photos();cf.refresh_album_views([ev.gid]);return Y.success(dU("Undo complete"))},_collection_renamed:function(ev){var ew,T;ew=ev.memo.collection;if(((T=bp.get_current_collection())!=null?T.gid:void 0)===ew.gid){bf("#single-collection-title").text(bt.em_snippet(ew.name,this.HEADER_COLLECTION_SNIPPET_LENGTH,1));document.title=""+ew.name+" - Dropbox"}this._collection_changed(ew);return Y.success(dU("Renamed '%(collection_name)s'").format({collection_name:ew.name}))},_collection_deleted:function(ev){var ew,T;ew=ev.memo.collection;this._collections.removeItem(ew);if(!this._all_collections_loaded){this._removed_pre_load.push(ew.gid)}this.refresh_album_views();if(((T=bp.get_current_collection())!=null?T.gid:void 0)===ew.gid){bp.show_all_collections()}delete this._gid_to_collection[ew.gid];delete this._url_to_collection[ew.url];return Y.success(dU("Deleted '%(collection_name)s'").format({collection_name:ew.name}))},_collection_shared:function(ev){var ew,T;ew=ev.memo.collection;this._collection_changed(ew);if(((T=bp.get_current_collection())!=null?T.gid:void 0)===ew.gid){bf("#single-collection-share-status").text(dU("Shared"));return bf("#single-collection-share-status").attr("href",ew.shmodel_url)}},_collection_unshared:function(ev){var ew,T;ew=ev.memo.collection;if(((T=bp.get_current_collection())!=null?T.gid:void 0)===ew.gid){bf("#single-collection-share-status").text("")}return Y.success(dU("Unshared '%(collection_name)s'").format({collection_name:ew.name}))},_collection_cover_changed:function(T){var ew,ev;ew=T.memo.collection;this._collection_changed(ew);ev=dU("Changed cover photo for '%(collection_name)s'");ev=ev.format({collection_name:ew.name.escapeHTML()});return Y.success(ev)},_albums_list_item_contextmenu:function(ev,T){a1.show_photo_collection(ev,this.get(T.readAttribute("data-gid")),T);T.removeClassName("album-flash");return T.addClassName("context-selected")},_show_collection_click:function(ew,T){var ev;ev=$(ew.target);if(ev.hasClassName("inplaceeditor-form")||(ev.up(".inplaceeditor-form")!=null)){return}return bp.show_collection(T.readAttribute("data-gid"))},_collection_shmodel_click:function(ev,T){return this.go_to_link(this.get(T.readAttribute("data-gid")))},_add_to_album_click:function(ev,T){if(ed._context_selected){this.add_photos(this.get(T.readAttribute("data-gid")),ed._context_selected);ed._context_selected=null}else{this.add_photos(this.get(T.readAttribute("data-gid")),ed.get())}delete ep.onHide;ep.hide();return h.log_interaction(dI.ADD_TO_RECENT_ALBUM,cD.SAH,{num_photos:ed.get().length})},_drop_target_mouseover:function(ev,T){if(ed._drag_drop.active){T.addClassName("hovered");return $("photos-drag-status").addClassName("hovering")}},_drop_target_mouseout:function(ev,T){if(ed._drag_drop.active){T.removeClassName("hovered");return $("photos-drag-status").removeClassName("hovering")}},_drop_target_mouseup:function(ev,T){var ew;if(T.hasClassName("hovered")){T.removeClassName("hovered");$("photos-drag-status").removeClassName("hovering");if(ed._drag_drop.single_photo!=null){ew=[ed._drag_drop.single_photo]}else{ew=ed.get()}if(T.readAttribute("data-gid")!=null){this.add_photos(this.get(T.readAttribute("data-gid")),ew,false)}if(T.identify()==="add-to-album-sidebar-new"){return h.log_interaction(dI.ADD_TO_NEW_ALBUM,cD.DROP_TARGET,{num_photos:ed.get().length})}else{if(T.identify()==="all-albums-sidebar"){return h.log_interaction(dI.ADD_TO_OTHER_ALBUM,cD.DROP_TARGET,{num_photos:ed.get().length})}else{return h.log_interaction(dI.ADD_TO_RECENT_ALBUM,cD.DROP_TARGET,{num_photos:ed.get().length})}}}},_create_album_click:function(T,ev){if(ed._context_selected){this.create(T,ev.down(".collection-name"),ed._context_selected,true);return ed._context_selected=null}else{return this.create(T,ev.down(".collection-name"),ed.get(),true)}},_window_scroll:function(){if(bp.in_all_collections_view()){return this._all_albums_scroll_position=y.scroll_offsets().top}},get_all:function(){return this._collections},get_from_url:function(T){return this._url_to_collection[T]},get:function(T){return this._gid_to_collection[T]},go_to_link:function(T){return window.open(T.shmodel_url,"_blank")},restore_all_albums_scroll_position:function(){if(this._all_albums_scroll_position!=null){return window.scrollTo(0,this._all_albums_scroll_position)}else{return window.scrollTo(0,0)}},two_line_snippet:function(ew,ev){var T,ey,ex;T=bt.em_snippet(ew,ev,1);ey=T.lastIndexOf(" ");if(ey===-1){return T}else{T=T.slice(0,+ey+1||9000000000);ex=bt.em_snippet(ew.slice(ey+1),ev,1);return T+ex}},get_default_album_name:function(){var T;T=dU("Untitled album");return this.increment_collection_name_until_valid(T)},collection_name_in_use:function(ev){var ey,ex,T,ew;ew=this.get_all();for(ex=0,T=ew.length;ex<T;ex++){ey=ew[ex];if(ey.name===ev.trim()){return true}}return false},increment_collection_name_until_valid:function(ev){var ew,T;ew=this.collection_name_in_use(ev);T=0;while(ew){T++;ew=this.collection_name_in_use(ev+(" ("+T+")"))}return(T===0?ev:ev+(" ("+T+")"))},flash_sidebar_album:function(ey){var ez,ex,ev,ew,T;ew=$$(".sidebar-album");T=[];for(ex=0,ev=ew.length;ex<ev;ex++){ez=ew[ex];if(ez.readAttribute("data-gid")===ey){ez.removeClassName("album-flash");ez.addClassName("album-flash");break}else{T.push(void 0)}}return T}};var bT;bT=A.PhotoTimeline=(function(){T.PHOTOS_ADDED_EVT="db:phototimeline:photos_added";T.PHOTOS_REMOVED_EVT="db:phototimeline:photos_removed";T.prototype.THUMB_SIZE=null;T.prototype.HEADER_HEIGHT=null;T.prototype.THUMBS_PER_ROW=4;T.prototype.RENDER_SCROLL_WAIT=100;T.prototype.RENDER_SCROLL_MAX_WAIT=750;T.prototype.HIDE_TIMELINE_NAV_DELAY=1500;T.prototype.THUMBS_BATCH_SIZE=12;T.prototype.VIEWPORT_SCALE_SCROLL_DIRECTION=4;T.prototype.VIEWPORT_SCALE_OTHER_DIRECTION=1;T.prototype.TIMELINE_NAV_MOUSE_THRESHOLD=100;T.prototype.TIMELINE_NAV_ELM_HEIGHT=20;T.prototype.TIMELINE_DOT_HTML=b6.html("web","timeline_dot");T.container;T.scroll_container;T.events;T.current_event;T.key_to_photo;T.preview_objs;T.tmpl;T.last_render_scroll_timeout;T.start_render_scroll_time;T.last_scroll_position;T.hide_timeline_nav_timeout;T.grid;T._skip_scroll_update;T.header_id_to_sel_items;T.event_remove_info;T.opts;function T(ew,ex,eA,ey,ez,eB,eC,eD,ev){this.container=ew;this.scroll_container=ex;this.tmpl=eC;this.opts=ev;this.THUMB_SIZE=eD.thumb_size;this.HEADER_HEIGHT=eD.header_height;this.key_to_photo={};this.preview_objs=[];this.start_render_scroll_time=-1;this.grid={};this._skip_scroll_update=false;this.header_id_to_sel_items=eB;this.event_remove_info=[];this._init_events(eA,ey,ez);this.update_offsets(eD.top_offset,eD.left_offset);this.listen();cY.start_capture(this.scroll_container)}T.prototype._init_events=function(eD,ex,ez){var ew,eB,eG,ey,eA,eE,ev,eC,eF;if(eD.length<1){this.events=new aK([],{});return}eB=[];eA={};eG=false;for(eC=0,eF=eD.length;eC<eF;eC++){ey=eD[eC];ey=String(ey);ev=ey in this.header_id_to_sel_items?this.header_id_to_sel_items[ey]:[];eE=false;if(ev.length&&!eG){eG=true;eE=true}ew=new cE(this,ey,ex[ey],ez[ey],ev,eE);eB.push(ey);eA[ey]=ew}return this.events=new aK(eB,eA)};T.prototype.listen=function(){this._bound_window_scroll=this._window_scroll.bind(this);this._bound_window_resize=this._window_resize.bind(this);this._body_mousemove_handler=$(document.body).on("mousemove",this._body_mousemove.bind(this));this._timeline_elm_click_handler=$(document.body).on("click",".timeline-elm",this._timeline_elm_click.bind(this));this._show_missing_timestamp_bucket_handler=$(document.body).on("click","#show-missing-timestamps-button",this._show_missing_timestamp_bucket.curry(true,false).bind(this));if(this.scroll_container!=null){this.scroll_container.observe("scroll",this._bound_window_scroll)}else{Event.observe(window,"scroll",this._bound_window_scroll)}Event.observe(window,"resize",this._bound_window_resize);return $(document).observe(cE.EVENT_MISCOUNT_EVT,this._event_miscount.bind(this))};T.prototype.unlisten=function(){var ew,ev,ex;if((ew=this._body_mousemove_handler)!=null){ew.stop()}if((ev=this._timeline_elm_click_handler)!=null){ev.stop()}if((ex=this._show_missing_timestamp_bucket_handler)!=null){ex.stop()}if(this.scroll_container!=null){this.scroll_container.stopObserving("scroll",this._bound_window_scroll)}else{Event.stopObserving(window,"scroll",this._bound_window_scroll)}Event.stopObserving(window,"resize",this._bound_window_resize);return $(document).stopObserving(cE.EVENT_MISCOUNT_EVT)};T.prototype.render=function(){this._render_empty_grid();this.init_timeline_nav();this._load_metadata_for_sel_events();return this._render_viewport()};T.prototype.update_offsets=function(ex,ew){var ey,eA,ez,ev;ci(this.THUMBS_PER_ROW>0,"Invalid THUMBS_PER_ROW: "+this.THUMBS_PER_ROW);this.top_offset=ex;this.refresh_row_offsets();this.left_offset=ew;this.grid.photo_col_offsets=[];ev=[];for(ey=eA=0,ez=this.THUMBS_PER_ROW;0<=ez?eA<=ez:eA>=ez;ey=0<=ez?++eA:--eA){ev.push(this.grid.photo_col_offsets.push(this.left_offset+this.THUMB_SIZE*ey))}return ev};T.prototype.refresh_row_offsets=function(){var eC,ez,ex,eB,ey,ew,eA,ev;this.grid.photo_row_offsets=[];eC=this.top_offset;eA=this.events.getValues();for(eB=0,ew=eA.length;eB<ew;eB++){ez=eA[eB];ez.top_offset=eC;eC+=this.HEADER_HEIGHT;this.grid.photo_row_offsets.push(eC);for(ex=ey=0,ev=ez.get_num_rows();0<=ev?ey<ev:ey>ev;ex=0<=ev?++ey:--ey){eC+=this.THUMB_SIZE;this.grid.photo_row_offsets.push(eC)}}};T.prototype._render_empty_grid=function(){var ew,ez,ey,ev,ex;this.container.__date();ex=this.events.getValues();for(ey=0,ev=ex.length;ey<ev;ey++){ew=ex[ey];if(!(ew.is_missing_timestamp_bucket()&&this.events.length()>1)){ew.add_html_elements_to(this.container)}}if(this.has_missing_timestamp_bucket()&&this.events.length()>1){ez=bf('<div id="show-missing-timestamps-button"/>').addClass("freshbutton-silver").text(dU("Show photos with missing dates"));return bf(this.container).append(ez)}};T.prototype._render_viewport=function(ey){var ew,eH,ez,eG,eJ,eE,eD,eB,eI,ex,ev,eF,eC,eA;if(ey==null){ey=false}this.start_render_scroll_time=-1;eJ=this.get_viewport_info();eH=[];eF=this.events.getValues();for(eE=0,eI=eF.length;eE<eI;eE++){ew=eF[eE];if(!(ew.has_loaded_metadata()||ew.loading_metadata||(ew.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown()))){if(ew.in_current_viewport(eJ,false)){eH.unshift(ew)}else{if(ew.in_current_viewport(eJ,true)){eH.push(ew)}}}}for(eD=0,ex=eH.length;eD<ex;eD++){ew=eH[eD];eC=ew.get_photo_range_to_render(eJ,true),ez=eC[0],eG=eC[1];ew.load_metadata_range(ez,eG)}if(ey){eJ=this.get_viewport_info();eA=this.events.getValues();for(eB=0,ev=eA.length;eB<ev;eB++){ew=eA[eB];if(ew.in_current_viewport(eJ,false)){ew.timing_stopped_scrolling_on_event=bE.time()-this.RENDER_SCROLL_WAIT}}}return this._load_visible_photos()};T.prototype._load_metadata_for_sel_events=function(){var ex,ez,ev,ey,ew;if("a_missing_timestamps" in this.header_id_to_sel_items){this._show_missing_timestamp_bucket(false,false)}ey=this.header_id_to_sel_items;ew=[];for(ez in ey){ev=ey[ez];ex=this.events.valueFromKey(ez);if(ex!=null){ex.load_metadata()}ew.push(ci(ex!=null,"Missing "+ez+" in list of events with selected photos"))}return ew};T.prototype._load_visible_photos=function(){var ex,ez,ew,ey,ev;ey=this.events.getValues();ev=[];for(ez=0,ew=ey.length;ez<ew;ez++){ex=ey[ez];if(!(ex.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){ev.push(ex.update_photo_divs())}else{ev.push(void 0)}}return ev};T.prototype._body_mousemove=function(ev){if(!this.opts.uses_timeline_nav){return}if((ev.clientX+y.scroll_offsets().left)>=($(document.body).getWidth()-this.TIMELINE_NAV_MOUSE_THRESHOLD)){return $("timeline-nav").addClassName("mouse-active")}else{return $("timeline-nav").removeClassName("mouse-active")}};T.prototype._timeline_elm_click=function(ey,ex){var ev,ew;ew=ex.readAttribute("data-event-id");if(ew){ev=this.events.valueFromKey(ew)}this._update_timeline_position(ev);if(ev.is_missing_timestamp_bucket()){h.log_interaction(bW.MISSING_TIMESTAMPS_VIEW);if(!this.is_missing_timestamp_bucket_shown()){this._show_missing_timestamp_bucket(false)}}return this._scroll_to_event(ev)};T.prototype._scroll_to_event=function(ex,ev){var ew;if(ev==null){ev=false}ew=ex.top_offset-this.top_offset;if(ex&&(y.scroll_offsets().top!==ew)){if(ev){return bf("html, body").animate({scrollTop:ew},200)}else{this._skip_scroll_update=true;return window.scrollTo(y.scroll_offsets().left,ew)}}};T.prototype._window_scroll=function(){var ey,ex,eB,eA,ew,ez,ev;ex=bE.time();a6.clear_all_pending_batches();if(this.start_render_scroll_time===-1||ex-this.start_render_scroll_time<this.RENDER_SCROLL_MAX_WAIT){clearTimeout(this.last_render_scroll_timeout)}if(this.start_render_scroll_time===-1){this.start_render_scroll_time=ex}eB=this.visible_thumbs_loaded()?0:this.RENDER_SCROLL_WAIT;this.last_render_scroll_timeout=setTimeout(this._render_viewport.curry(true).bind(this),eB);if(this.opts.uses_timeline_nav){this._update_timeline_position();$("timeline-nav").addClassName("scroll-active");clearTimeout(this.hide_timeline_nav_timeout);this.hide_timeline_nav_timeout=setTimeout(((function(eC){return function(){return $("timeline-nav").removeClassName("scroll-active")}})(this)),this.HIDE_TIMELINE_NAV_DELAY)}this.last_scroll_position=y.scroll_offsets().top;bp.scroll_count++;ez=this.events.getValues();ev=[];for(eA=0,ew=ez.length;eA<ew;eA++){ey=ez[eA];ev.push(ey.logged_thumbs_arrived=false)}return ev};T.prototype._window_resize=function(){this._resize_timeline_nav();return this._show_hide_timeline_elms()};T.prototype.init_timeline_nav=function(){var ew,ey,ev,ex;if(!this.opts.uses_timeline_nav){return}this.grid.side_nav={};this.current_event=null;this._resize_timeline_nav();ex=this.events.getValues().reverse();for(ey=0,ev=ex.length;ey<ev;ey++){ew=ex[ey];ew.add_to_timeline_nav(ew===this.events.getValues()[0])}this._update_timeline_position();return this._show_hide_timeline_elms()};T.prototype._resize_timeline_nav=function(){var ev;if(!this.opts.uses_timeline_nav){return}ev=this.get_viewport_info().height-this.TIMELINE_NAV_ELM_HEIGHT;return $("timeline-nav").setStyle({height:ev+"px"})};T.prototype._update_timeline_position=function(eB){var eF,eC,ev,eE,ez,ey,eD,ew,eA,ex;if(!this.opts.uses_timeline_nav){return}if(this._skip_scroll_update){this._skip_scroll_update=false;return}if(eB==null){eE=this.get_viewport_info();if(this.scroll_container==null){eE.top=document.viewport.getScrollOffsets().top}eF=eE.top+eE.height/2;eA=this.events.getValues();for(ez=0,eD=eA.length;ez<eD;ez++){ev=eA[ez];if(ev.top_offset>eF){break}eB=ev}}if((eB==null)||eB===this.current_event){return}$$(".timeline-elm.current").invoke("removeClassName","current");ex=$$(".timeline-elm");for(ey=0,ew=ex.length;ey<ew;ey++){eC=ex[ey];if(eC.readAttribute("data-event-id")===eB.unique_id){eC.addClassName("current");break}}return this.current_event=eB};T.prototype._show_hide_timeline_elms=function(){var eC,ez,ex,ey,eB,ew,eA,ev;if(!this.opts.uses_timeline_nav){return}ex=$("cu-header").cumulativeOffset().left+$("cu-header").getWidth();ez=$("cu-header").cumulativeOffset().top+$("cu-header").getHeight();eA=$$(".timeline-elm");ev=[];for(eB=0,ew=eA.length;eB<ew;eB++){eC=eA[eB];eC.show();ey=eC.cumulativeOffset();if(ey.top<ez&&ey.left<ex){ev.push(eC.hide())}else{ev.push(void 0)}}return ev};T.prototype._event_miscount=function(ev){this.refresh_row_offsets();return this._load_visible_photos()};T.prototype.remove_photos=function(eC){var ey,eA,eB,ex,ew,ez,ev;eC=eC.slice(0);this.event_remove_info=[];eB={};for(ez=0,ev=eC.length;ez<ev;ez++){ex=eC[ez];eA=ex.event.unique_id;if(eA in eB){eB[eA].push(ex)}else{eB[eA]=[ex]}}for(eA in eB){eC=eB[eA];ey=this.events.valueFromKey(eA);ew=ey.remove_photos(eC);this.event_remove_info.push({event:ey,remove_info:ew})}this.init_timeline_nav();this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(T.PHOTOS_REMOVED_EVT,this)};T.prototype.restore_removed_photos=function(){var ew,eK,eG,eJ,eH,ey,eF,eD,eC,eA,eI,ex,ev,eE,eB,ez;ed.clear();eE=this.event_remove_info.reverse();for(eD=0,eI=eE.length;eD<eI;eD++){eK=eE[eD];ew=eK.event;eH=eK.remove_info;if(eH.removed_event_index!=null){this.events.insertAtIndex(eH.removed_event_index,ew.unique_id,ew);ew.restore()}ew.add_photos(eH.removed_photos_and_indexes.reverse());eB=eH.removed_photos_and_indexes;for(eC=0,ex=eB.length;eC<ex;eC++){eJ=eB[eC];ed._add(eJ.photo)}}ey=null;eF=null;ez=this.event_remove_info;for(eA=0,ev=ez.length;eA<ev;eA++){eK=ez[eA];ew=eK.event;eH=eK.remove_info;eG=this.events.indexOfKey(ew.unique_id);if((ey==null)||ey>eG){ey=eG;eF=eH.removed_photos_and_indexes[0].photo}}this.event_remove_info=[];this.init_timeline_nav();if(eF!=null){this.scroll_to_photo_with_key(eF.uniqueness_key)}this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(T.PHOTOS_ADDED_EVT,this)};T.prototype.get_photos=function(){var ew,ez,ey,ev,ex;ez=[];ex=this.events.getValues();for(ey=0,ev=ex.length;ey<ev;ey++){ew=ex[ey];ez=ez.concat(ew.photos)}return ez};T.prototype.num_photos=function(){var ex,ew,ez,ev,ey;ew=0;ey=this.events.getValues();for(ez=0,ev=ey.length;ez<ev;ez++){ex=ey[ez];ew+=ex.photos.length}return ew};T.prototype.get_preview_objs=function(){var ev,ew,eC,eA,ez,eD,ex,eB,ey;eC=[];eB=this.events.getValues();for(eA=0,eD=eB.length;eA<eD;eA++){ev=eB[eA];ey=ev.photos;for(ez=0,ex=ey.length;ez<ex;ez++){ew=ey[ez];eC.push(ew.preview_obj)}}return eC};T.prototype.index_of_photo=function(ex){var ey,ew,eA,ev,ez;ew=0;ez=this.events.getValues();for(eA=0,ev=ez.length;eA<ev;eA++){ey=ez[eA];if(ey===ex.event){ew+=ey.photos.indexOf(ex);break}else{ew+=ey.photos.length}}return ew};T.prototype.photo_at_index=function(ex){var ev,ey,eA,ew,ez;ev=0;ez=this.events.getValues();for(eA=0,ew=ez.length;eA<ew;eA++){ey=ez[eA];if(ev+ey.photos.length>ex){return ey.photos[ex-ev]}else{ev+=ey.photos.length}}return null};T.prototype.get_thumb_elm_for_photo=function(ev){return $(ev.uniqueness_key)};T.prototype.get_photo_for_thumb_elm=function(ev){if(!ev.hasClassName("cu-thumb")){ev=ev.up(".cu-thumb")}if(ev){return this.key_to_photo[ev.identify()]}else{return null}};T.prototype.get_viewport_info=function(){var ev,ew;if(this.scroll_container!=null){ew=this.scroll_container.scrollTop;ev=this.scroll_container.getHeight()}else{ew=y.scroll_offsets().top;ev=y.viewport_dimensions().height}return{top:ew,height:ev,bottom:ew+ev}};T.prototype.scroll_to_photo_with_key=function(ew){var eA,ex,ev,ez,ey;y.scroll_unlock_document();eA=$(ew);if(eA!=null?eA.visible():void 0){ds.scroll_to_thumb(eA)}else{ev=this.key_to_photo[ew];ex=ev.event;if(ev.event!=null){ez=Math.floor(ex.photos.indexOf(ev)/this.THUMBS_PER_ROW);ey=this.get_viewport_info().height;y.scroll_to(0,ex.top_offset+this.HEADER_HEIGHT+ez*this.THUMB_SIZE-ey/2)}}return this._load_visible_photos()};T.prototype.restore_scroll_position=function(){y.scroll_unlock_document();if(this.last_scroll_position!=null){window.scrollTo(0,this.last_scroll_position)}else{window.scrollTo(0,0)}if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return this._load_visible_photos()}};T.prototype.visible_thumbs_loaded=function(){var ew,ey,ev,ex;ex=this.events.getValues();for(ey=0,ev=ex.length;ey<ev;ey++){ew=ex[ey];if(!ew.visible_thumbs_loaded()){return false}}return true};T.prototype.has_missing_timestamp_bucket=function(){var ev;ev=this.events.getValues();return ev[ev.length-1].is_missing_timestamp_bucket()};T.prototype.is_missing_timestamp_bucket_shown=function(){var ev,ew;if(!this.has_missing_timestamp_bucket()){return false}ev=this.events.getValues();ew=ev[ev.length-1].unique_id;return bf("#p-"+ew).length>0};T.prototype._show_missing_timestamp_bucket=function(ev,ey){var ex,ew;if(ev==null){ev=true}if(ey==null){ey=false}if(!(this.has_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){return}ew=this.events.getValues();ex=ew[ew.length-1];bf("#show-missing-timestamps-button").hide();ex.add_html_elements_to(this.container);if(!ey){if(this.opts.uses_timeline_nav){$("timeline-nav").addClassName("mouse-active")}this._scroll_to_event(ex,ev);this._render_viewport()}return this.init_timeline_nav()};return T})();var cE;cE=A.PhotoEvent=(function(){T.EVENT_MISCOUNT_EVT="db:photoevent:miscount";T.PHOTOS_LOADED_EVT="db:photoevent:photos_loaded";T.prototype.MONTH_PREFIX="m_";T.prototype.COLLECTION_PREFIX="c_";T.prototype.EVENT_PREFIX="e_";T.prototype.MISSING_TIMESTAMP_PREFIX="a_";T.prototype.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD=5;T.prototype.MAX_PHOTOS_PER_METADATA_REQUEST=500;T.timeline;T.unique_id;T.name;T.init_num_photos;T.photos;T.header_html;T.placeholder_html;T.top_offset;T.loading_metadata;T.cursor;T.num_photos_loaded;T.prototype.LOADING_ORDER_NOT_DECIDED=-1;T.prototype.LOADING_ORDER_TOP_DOWN=0;T.prototype.LOADING_ORDER_BOTTOM_UP=1;T.loading_order;T.num_photos_to_load;T.on_load_all_metadata;T.init_sel_items;T.scroll_to_first_sel;T.num_to_select;T.logged_thumbs_arrived;T.timing_metadata_received;T.timing_stopped_scrolling_on_event;T.scroll_count;function T(eD,eA,ew,eB,ev,ez){var ey,eE,ex,eC;this.timeline=eD;this.unique_id=eA;this.name=ew;this.init_num_photos=eB;this.photos=(function(){var eG,eF;eF=[];for(ey=eG=0;0<=eB?eG<eB:eG>eB;ey=0<=eB?++eG:--eG){eF.push(new F(this))}return eF}).call(this);this.init_sel_items={};for(ex=0,eC=ev.length;ex<eC;ex++){eE=ev[ex];this.init_sel_items[eE]=true}this.num_to_select=ev.length;this.scroll_to_first_sel=ez;this._generate_container_html();this.timing_metadata_received=-1;this.timing_stopped_scrolling_on_event=-1;this.num_photos_loaded=0;this.loading_order=this.LOADING_ORDER_NOT_DECIDED;this.num_photos_to_load=0;this.loading_metadata=false;if(eB===0){$("single-album-empty").show()}}T.prototype.is_month=function(){return this.unique_id.slice(0,2)===this.MONTH_PREFIX};T.prototype.is_missing_timestamp_bucket=function(){return this.unique_id.slice(0,2)===this.MISSING_TIMESTAMP_PREFIX};T.prototype.get_month=function(){var ev;ci(this.is_month(),"this must be a month event");ev=parseInt(this.unique_id.slice(6,8),10);ci(!isNaN(ev),"Month was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return ev};T.prototype.get_year=function(){var ev;ci(this.is_month(),"this must be a month event");ev=parseInt(this.unique_id.slice(2,6),10);ci(!isNaN(ev),"Year was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return ev};T.prototype.is_collection=function(){return this.unique_id.slice(0,2)===this.COLLECTION_PREFIX};T.prototype.get_collection_gid=function(){ci(this.is_collection(),"this must be a collection event");return this.unique_id.slice(2)};T.prototype.is_event=function(){return this.unique_id.slice(0,2)===this.EVENT_PREFIX};T.prototype._generate_container_html=function(){var ey,ew,ez,eB,ex,ev,eA;eB=this.name;if(this.is_event()){this.header_html=new Element("h1",{id:"h-"+this.unique_id,"class":"cu-month-header"});this.header_html.__sert(eB);ey=new Element("div",{"class":"event-button event-add-to-album title_bubble","data-title":"Add to album"});ey.__date(b6.html("web","event_add_to_album"));this.header_html.__sert(ey);eA=new Element("div",{"class":"event-button event-share title_bubble","data-title":"Share"});eA.__date(b6.html("web","event_share"));this.header_html.__sert(eA);ev=new Element("div",{"class":"event-button event-select title_bubble","data-title":"Select all"});ev.__date(b6.html("web","event_select"));this.header_html.__sert(ev)}else{this.header_html=new es("<h1 class='cu-month-header' id='h-"+this.unique_id+"'><span>"+eB+"</span></h1>")}ew=this.get_content_height();ex=this.photos.length%this.timeline.THUMBS_PER_ROW;ez=ex===0?0:(this.timeline.THUMBS_PER_ROW-ex)*this.timeline.THUMB_SIZE;return this.placeholder_html=new es('<div style="height: '+ew+'px;" id="p-'+this.unique_id+'" class="content-placeholder-container">\n  <div style="height: '+ew+'px;" id="p-top-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="height: 0px;" id="p-bottom-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="width: '+ez+'px" id="p-cover-'+this.unique_id+'" class="thumb-cover"></div>\n</div>')};T.prototype.add_html_elements_to=function(ew){var ev;if(this.is_event()){ev=new Element("div",{"class":"photo-event"});ev.__sert(this.header_html);ev.__sert(this.placeholder_html);return ew.__sert(ev)}else{ew.__sert(this.header_html);return ew.__sert(this.placeholder_html)}};T.prototype.remove=function(){$("h-"+this.unique_id).hide();$("p-"+this.unique_id).hide();return this.timeline.events.remove(this.unique_id)};T.prototype.restore=function(){$("h-"+this.unique_id).show();return $("p-"+this.unique_id).show()};T.prototype.add_to_timeline_nav=function(eC){var ev,eA,eD,ew,eE,ez,ey,eB,ex;if(eC==null){eC=false}if(!(this.is_month()||this.is_event()||this.is_missing_timestamp_bucket())){return}ex=this.timeline.get_viewport_info().height;eE=this.timeline.TIMELINE_NAV_ELM_HEIGHT;ez=$(document.body).getHeight();ey=this.top_offset/ez*100;if(this.is_event()){ew=this.name}else{if(this.is_missing_timestamp_bucket()){ew=dU("Missing dates")}else{ew=bE.month_abbr_with_year(this.get_month()-1,this.get_year())}}eD=false;for(eB in this.timeline.grid.side_nav){ev=Math.abs(this.timeline.events.valueFromKey(eB).top_offset-this.top_offset);if(ev/ez*ex<eE){eD=true;if(eC){bf("#timeline-nav-"+eB).remove()}}}eA=bf("#timeline-nav-"+this.unique_id);if(!eD||eC){if(eA.length){eA.css("top",""+ey+"%")}else{eA=bf("<div/>");eA.addClass("timeline-elm");eA.attr({"data-event-id":this.unique_id.toString(),id:"timeline-nav-"+this.unique_id});eA.css("top",""+ey+"%");eA.text(ew);bf("#timeline-nav").append(eA)}return this.timeline.grid.side_nav[this.unique_id]=ey}else{if(eA.length){return eA.remove()}}};T.prototype.marquee_highlight=function(ev,eC,ez){var ex,eD,ew,eE,eG,ey,eB,eA,eF;if(this.top_offset>eC||this.top_offset+this.get_height()<ev){return}if(ev<this.top_offset){eC-=this.top_offset;if(eC<this.timeline.HEADER_HEIGHT){return}ey=0;eG=Math.floor((eC-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{if(eC>this.top_offset+this.get_height()){ev-=this.top_offset;eG=Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW);if(ev<this.timeline.HEADER_HEIGHT){ey=0}else{ey=Math.floor((ev-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}else{ev-=this.top_offset;eC-=this.top_offset;if(ev<this.timeline.HEADER_HEIGHT&&eC<this.timeline.HEADER_HEIGHT){return}else{if(ev<this.timeline.HEADER_HEIGHT){ey=0;eG=Math.floor((eC-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{ey=Math.floor((ev-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);eG=Math.floor((eC-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}}}for(eE=eB=ey;ey<=eG?eB<=eG:eB>=eG;eE=ey<=eG?++eB:--eB){for(eA=0,eF=ez.length;eA<eF;eA++){ex=ez[eA];eD=this.timeline.THUMBS_PER_ROW*eE+ex;if(eD<this.photos.length){ew=this.photos[eD];if(ew.status!==F.PLACEHOLDER&&!ed.contains(ew)){ed._highlight(ew)}}}}};T.prototype.add_photos=function(ey){var ex,ew,ez,eA,ev;for(eA=0,ev=ey.length;eA<ev;eA++){ez=ey[eA];ew=ez.photo;ex=ez.index;ci(ex<=this.photos.length,"cannot insert past end of photos array");this.photos.splice(ex,0,ew);if(ew.status>=F.LOADED){ew.status=F.LOADED;this.num_photos_loaded++;this.num_photos_to_load=Math.max(this.num_photos_to_load,this.num_photos_loaded)}}return this._num_photos_changed()};T.prototype.remove_photos=function(eD){var eA,ev,ez,eB,ew,ex,eC,ey;eA=this.timeline.events.indexOfKey(this.unique_id);ew=[];for(ex=0,eC=eD.length;ex<eC;ex++){ev=eD[ex];ez=this.photos.indexOf(ev);ci(ez>-1,"Photo not found in the photos array!");this.photos.splice(ez,1);if(ev.status>=F.LOADED){this.num_photos_loaded--;if((ey=$(ev.uniqueness_key))!=null){ey.remove()}ev.status=F.LOADED}ed._remove(ev);ew.push({photo:ev,index:ez})}this._num_photos_changed();eB={removed_photos_and_indexes:ew};if(this.photos.length===0){eB.removed_event_index=eA}return eB};T.prototype._num_photos_changed=function(){if(this.photos.length===0){return this.remove()}else{return this._update_placeholder_container()}};T.prototype.update_placeholders=function(){if($("p-"+this.unique_id)!=null){this._update_placeholder_container();$("p-top-"+this.unique_id).setStyle({height:""+(this.get_content_height())+"px"});return $("p-bottom-"+this.unique_id).setStyle({height:"0px"})}else{return this._generate_container_html()}};T.prototype._update_placeholder_container=function(){var ew,ev;$("p-"+this.unique_id).setStyle({height:""+(this.get_content_height())+"px"});ev=this.photos.length%this.timeline.THUMBS_PER_ROW;ew=ev!==0?(this.timeline.THUMBS_PER_ROW-ev)*this.timeline.THUMB_SIZE:0;return $("p-cover-"+this.unique_id).setStyle({width:""+ew+"px"})};T.prototype.load_metadata=function(eC){var ex,ew,eB,ev,ez,eA,ey;ev=0;if((!this._is_valid_photo_index(eC))||(this.num_to_select>0)){if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=this.LOADING_ORDER_TOP_DOWN}ev=this.photos.length}else{if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=eC*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}ev=this._is_loading_from_bottom()?this.photos.length-eC:eC+1}this.num_photos_to_load=Math.max(this.num_photos_to_load,ev);if(this.has_loaded_metadata()||(this.num_photos_loaded>=this.num_photos_to_load)){return}if(this.loading_metadata){return}if(this.load_cached_metadata()){return}this.loading_metadata=true;ez={show_hidden:bp.show_hidden};if(this.cursor!=null){ez.cursor=this.cursor}if(this._is_loading_from_bottom()){ez.chron_order=true}ez.limit=Math.max(this.num_photos_to_load-this.num_photos_loaded,0);if(ez.limit>this.MAX_PHOTOS_PER_METADATA_REQUEST){ez.limit=this.MAX_PHOTOS_PER_METADATA_REQUEST}if(this.is_event()){eA=this.unique_id.split("_");ex=eA[2];ew=eA[1];ez.filters=JSON.stringify({date_begin:ex,date_end:ew},{event_id:this.unique_id})}else{if(this.is_missing_timestamp_bucket()){ez.filters=JSON.stringify({other:true})}else{if(this.is_month()){ey=this.get_year();eB=this.get_month();ex=ds.to_iso8601_date(new Date(ey,eB-1,1,0,0,0,0),false,true);ew=ds.to_iso8601_date(new Date(ey,eB,1,0,0,0),false,true);ez.filters=JSON.stringify({date_begin:ex,date_end:ew},{year:ey,month:eB})}else{if(this.is_collection()){ez.filters=JSON.stringify({collection_gid:this.get_collection_gid()})}else{ci(false,"invalid photo event id: "+this.unique_id)}}}}return new Ajax.DBRequest("/photos_event_metadata",{parameters:ez,allow_retries:true,onSuccess:(function(eD){return function(eE){var eF;eF=JSON.parse(eE.responseText);eD.timing_metadata_received=bE.time();eD.cursor=eF.cursor;return eD._load_metadata_callback(eF.photos,eF.key_to_duplicates,(eF.more!=null)&&eF.more)}})(this)})};T.prototype.load_metadata_range=function(ew,ev){if(!(this._is_valid_photo_index(ew)&&this._is_valid_photo_index(ev))){this.load_metadata();return}if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=ew*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}if(this._is_loading_from_bottom()){return this.load_metadata(ew)}else{return this.load_metadata(ev)}};T.prototype.load_cached_metadata=function(){var ev,ew;if(this.loading_metadata||this._is_loading_from_bottom()||this.num_photos_loaded>0||(((ew=bp.event_metadata_cache)!=null?ew[this.unique_id]:void 0)==null)){return false}ev=bp.event_metadata_cache[this.unique_id];this.cursor=ev.cursor;this._load_metadata_callback(ev.photos,ev.key_to_duplicates,ev.more);return true};T.prototype._load_metadata_callback=function(eH,eA,eB){var eG,eC,eM,eD,eN,ex,eE,eK,ez,eI,ey,eF,ew,ev,eJ,eL;eD=[];ez=[];eF=false;for(eG=ew=0,eJ=eH.length;ew<eJ;eG=++ew){eE=eH[eG];if(this.has_loaded_metadata()){ex=new F(this);if(this._is_loading_from_bottom()){this.photos.unshift(ex)}else{this.photos.push(ex)}eF=true}else{if(this.num_photos_loaded<this.photos.length){eC=this._is_loading_from_bottom()?this.photos.length-1-this.num_photos_loaded:this.num_photos_loaded;ex=this.photos[eC]}else{ci(false,"num_photos_loaded should never be greater than photos.length")}}ex.init_metadata(eE);if(ex.uniqueness_key in eA){ex.set_duplicates(eA[ex.uniqueness_key])}if(eG<this.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD){ez.push(ex.preview_obj)}eD.push(ex)}if(this.timeline.opts.uses_lightbox){window.setTimeout((function(){var eR,eQ,eP,eO;eO=[];for(eQ=0,eP=ez.length;eQ<eP;eQ++){eR=ez[eQ];eO.push(eR.preload())}return eO}),500)}ed.refresh(eD);for(ev=0,eL=eD.length;ev<eL;ev++){ex=eD[ev];if(ex.item_counter in this.init_sel_items){ed._add(ex);this.num_to_select--;if(this.num_to_select===0){ed.dec_num_loading_events_before_select()}delete this.init_sel_items[ex.item_counter];if(this.scroll_to_first_sel){this.scroll_to_first_sel=false;ey=this.timeline;eM=ex.uniqueness_key;bf(document).ready(function(){return ey.scroll_to_photo_with_key(eM)})}}}if(!eB){if(this.num_photos_loaded<this.photos.length){eN=this.photos.length-this.num_photos_loaded;eI=this._is_loading_from_bottom()?0:this.num_photos_loaded;this.photos.splice(eI,eN);this.num_photos_to_load=Math.min(this.num_photos_to_load,this.num_photos_loaded)}if(eF||eN){this._fix_photo_miscount()}if(typeof this.on_load_all_metadata==="function"){this.on_load_all_metadata(this)}this.on_load_all_metadata=null}this.loading_metadata=false;this.update_photo_divs();$(document).fire(T.PHOTOS_LOADED_EVT,this);if(!this.has_loaded_metadata()&&this.num_photos_to_load>this.num_photos_loaded){eK=this._is_loading_from_bottom()?this.photos.length-this.num_photos_to_load:this.num_photos_to_load-1;return this.load_metadata(eK)}};T.prototype._fix_photo_miscount=function(){var ex,ew,ev;ex=Math.ceil(this.init_num_photos/this.timeline.THUMBS_PER_ROW);ew=this.get_num_rows()-ex;if(typeof h!=="undefined"&&h!==null){h.log("event_miscount",null,null,null,{event_id:this.unique_id,false_count:this.init_num_photos,true_count:this.photos.length,count_delta:this.photos.length-this.init_num_photos})}ev=y.scroll_offsets().top;if(this.top_offset+this.get_height()<ev){y.scroll_to(0,ev+ew*this.timeline.THUMB_SIZE)}this._num_photos_changed();return $(document).fire(T.EVENT_MISCOUNT_EVT,this)};T.prototype.get_num_rows=function(){return Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW)};T.prototype.get_content_height=function(){return this.get_num_rows()*this.timeline.THUMB_SIZE};T.prototype.get_height=function(){return this.timeline.HEADER_HEIGHT+this.get_content_height()};T.prototype.has_loaded_metadata=function(){return this.num_photos_loaded===this.photos.length};T.prototype.visible_thumbs_loaded=function(ex){var eB,eA,ew,ev,ez,ey;if(ex==null){ex=this.timeline.get_viewport_info()}ey=this.get_photo_range_to_render(ex,false),eB=ey[0],eA=ey[1];if(eB===null&&eA===null){return true}for(ev=ez=eB;eB<=eA?ez<=eA:ez>=eA;ev=eB<=eA?++ez:--ez){ew=this.photos[ev];if((ew==null)||!(ew.status>=F.RENDERED)){return false}}return true};T.prototype._is_loaded=function(ev){var ew,ex;if(this._is_loading_from_bottom()){ex=this.photos.length-this.num_photos_loaded;ew=this.photos.length-1}else{ex=0;ew=this.num_photos_loaded-1}return(ex<=ev&&ev<=ew)};T.prototype._is_loading_from_bottom=function(){return this.loading_order===this.LOADING_ORDER_BOTTOM_UP};T.prototype._is_valid_photo_index=function(ev){return(ev!=null)&&(ev>=0)&&(ev<=this.photos.length-1)};T.prototype.update_photo_divs=function(){var ex,ew,eM,eL,eQ,eT,eN,eI,eC,eU,eK,eR,eG,eD,eA,ey,eV,eW,ev,eS,eJ,eH,eF,eB,ez,eE,eP,eO;if(!this.num_photos_loaded){return}eR=this.timeline.get_viewport_info();if(this.hide_photos_if_not_in_current_viewport(eR)){return}eS=this.get_photo_range_to_render(eR),eM=eS[0],eL=eS[1];ci((eM!=null)&&(eL!=null),"This line is after @hide_photos_if_not_in_ current_viewport, so first_photo_to_render and last_photo_to_render shouldn't be null.");if(!this.has_loaded_metadata()&&((!this._is_loaded(eM))||(!this._is_loaded(eL)))){this.load_metadata_range(eM,eL);if(this._is_loading_from_bottom()){eM=Math.max(eM,this.photos.length-this.num_photos_loaded)}else{eL=Math.min(eL,this.num_photos_loaded-1)}if(eM>eL){return}}eT=Math.floor(eM/this.timeline.THUMBS_PER_ROW);eK=eT*this.timeline.THUMB_SIZE;$("p-top-"+this.unique_id).setStyle({height:eK+"px"});eQ=Math.floor((this.photos.length-1)/this.timeline.THUMBS_PER_ROW)-Math.floor(eL/this.timeline.THUMBS_PER_ROW);ew=eQ*this.timeline.THUMB_SIZE;$("p-bottom-"+this.unique_id).setStyle({height:ew+"px"});this._hide_photos((function(){eE=[];for(var eX=0;0<=eM?eX<eM:eX>eM;0<=eM?eX++:eX--){eE.push(eX)}return eE}).apply(this));this._hide_photos((function(){eP=[];for(var eX=eJ=eL+1,eY=this.photos.length;eJ<=eY?eX<eY:eX>eY;eJ<=eY?eX++:eX--){eP.push(eX)}return eP}).apply(this));this._show_photos((function(){eO=[];for(var eX=eM;eM<=eL?eX<=eL:eX>=eL;eM<=eL?eX++:eX--){eO.push(eX)}return eO}).apply(this));eF=ed.get();for(ey=0,eV=eF.length;ey<eV;ey++){eI=eF[ey];if((eB=$(eI.uniqueness_key))!=null){eB.addClassName("selected")}}this.scroll_count=bp.scroll_count;ex=[];ez=this.get_thumb_indexes_to_load(eR);for(ev=0,eW=ez.length;ev<eW;ev++){eC=ez[ev];eI=this.photos[eC];if((eI!=null)&&eI.status>=F.RENDERED){eU=$(eI.uniqueness_key);if((eU!=null?eU.down("img"):void 0)!=null){ex.push(eU.down("img"))}}}eN=function(eX){return eX.up(".cu-thumb").addClassName("thumb-loaded")};return a6.batch_load_thumbs(ex,this.timeline.THUMBS_BATCH_SIZE,eN,this.log_thumb_load.bind(this))};T.prototype._hide_photos=function(ez){var ex,ey,ew,ev;ev=[];for(ey=0,ew=ez.length;ey<ew;ey++){ex=ez[ey];ev.push(this._hide_photo(ex))}return ev};T.prototype._hide_photo=function(ev){var ew;ew=this.photos[ev];if((ew==null)||!(ew.status===F.DISPLAYED)){return}$(ew.uniqueness_key).hide();return ew.status=F.RENDERED};T.prototype._show_photos=function(eL){var eH,eG,eK,ez,eI,eE,ey,eF,eD,eB,eA,eJ,ex,ew,ev,eC;ez=[];for(eF=0,eJ=eL.length;eF<eJ;eF++){eG=eL[eF];eI=this._get_photo_insert_info(eG);if(!eI){continue}eK=eI[0],ey=eI[1];eE=false;for(eD=0,ex=ez.length;eD<ex;eD++){eH=ez[eD];if(eH.after===eK){eH.photos.push(ey);eE=true;break}}if(!eE){ez.push({after:eK,photos:[ey]})}}for(eB=0,ew=ez.length;eB<ew;eB++){eH=ez[eB];eH.after.__sert({after:eH.photos})}eC=[];for(eA=0,ev=eL.length;eA<ev;eA++){eG=eL[eA];eC.push(this.photos[eG].status=F.DISPLAYED)}return eC};T.prototype._get_photo_insert_info=function(ev){var ey,ew,ex,eC,ez,eB,eA;ex=this.photos[ev];if((ex==null)||ex.status===F.DISPLAYED){return}if(ex.status===F.RENDERED){$(ex.uniqueness_key).show()}else{ew=$("p-top-"+this.unique_id);if(ev!==0){for(ey=eB=eA=ev-1;eA<=0?eB<=0:eB>=0;ey=eA<=0?++eB:--eB){eC=this.photos[ey];if((eC!=null)&&eC.status>=F.RENDERED){ez=$(eC.uniqueness_key);ci(ez!=null,"photo "+ey+" was marked as rendered, but its thumb elm doesn't exist");ew=ez;break}}}return[ew,ex.thumb_html]}};T.prototype.in_y_range=function(ew,ev){return !(this.top_offset+this.timeline.HEADER_HEIGHT>ev||this.top_offset+this.get_height()<ew)};T.prototype.in_current_viewport=function(ex,ez){var ev,ew,ey;if(ex==null){ex=this.timeline.get_viewport_info()}if(ez==null){ez=true}ew=ex.top;ev=ex.top+ex.height;if(ez){ey=this._blur_range(ew,ev,ex),ew=ey[0],ev=ey[1]}return this.in_y_range(ew,ev)};T.prototype.hide_photos_if_not_in_current_viewport=function(ey){var ew,eA,ex,ez,ev,eB;if(!this.in_current_viewport(ey)){if(this._is_loading_from_bottom()){for(ew=eA=ez=this.photos.length-this.num_photos_loaded,ev=this.photos.length;ez<=ev?eA<ev:eA>ev;ew=ez<=ev?++eA:--eA){this._hide_photo(ew)}}else{for(ew=ex=0,eB=this.num_photos_loaded;0<=eB?ex<eB:ex>eB;ew=0<=eB?++ex:--ex){this._hide_photo(ew)}}$("p-top-"+this.unique_id).setStyle({height:this.get_content_height()+"px"});$("p-bottom-"+this.unique_id).setStyle({height:"0px"});return true}return false};T.prototype._blur_range=function(ey,ev,eA){var ex,ew,ez;if(eA==null){eA=this.timeline.get_viewport_info()}ez=cY.get();if(ez>=0){ew=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION;ex=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION}else{if(ez<0){ew=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION;ex=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION}}ey-=ew*eA.height;ev+=ex*eA.height;return[ey,ev]};T.prototype.get_photo_range_to_render=function(eD,ex){var eB,ew,eA,eC,ez,ev,ey;if(ex==null){ex=true}ev=eD.top;ez=eD.bottom;if(ex){ey=this._blur_range(ev,ez,eD),ev=ey[0],ez=ey[1]}if(!this.in_y_range(ev,ez)){return[null,null]}eC=Math.floor((ev-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);eB=Math.floor((ez-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);ew=Math.min(this.photos.length-1,eC*this.timeline.THUMBS_PER_ROW);eA=Math.min(this.photos.length-1,(eB+1)*this.timeline.THUMBS_PER_ROW-1);ci(!isNaN(eA),"Last photo to render should not be NaN.  "+("viewport_data.bottom="+eD.bottom+" ")+("viewport_data.height="+eD.height+" ")+("photos.length="+this.photos.length+" ")+("top_offset="+this.top_offset+" ")+("bottom_row_to_render="+eB+" "),true,["photo_event_nan_limit"]);return[Math.max(0,ew),eA]};T.prototype.get_photo_range_to_render_with_blur=function(ey){var ew,eB,ex,eA,ez,ev;ez=this.get_photo_range_to_render(ey,true),eB=ez[0],eA=ez[1];ev=this.get_photo_range_to_render(ey,false),ew=ev[0],ex=ev[1];return[eB,ew,ex,eA]};T.prototype.get_thumb_indexes_to_load=function(eI){var eP,eF,eD,eC,eM,eO,eL,eN,eJ,ez,ex,ew,ev,eK,eB,eA,ey,eH,eG,eE;eK=this.get_photo_range_to_render_with_blur(eI),eF=eK[0],eP=eK[1],eD=eK[2],eC=eK[3];if(eP==null){eM=(function(){ey=[];for(var eQ=eF;eF<=eC?eQ<=eC:eQ>=eC;eF<=eC?eQ++:eQ--){ey.push(eQ)}return ey}).apply(this);if(this.top_offset>eI.bottom){return eM}else{return eM.reverse()}}eN=(function(){eH=[];for(var eQ=eP;eP<=eD?eQ<=eD:eQ>=eD;eP<=eD?eQ++:eQ--){eH.push(eQ)}return eH}).apply(this);eO=[];eL=[];if(eF<eP){eO=(function(){eG=[];for(var eQ=eB=eP-1;eB<=eF?eQ<=eF:eQ>=eF;eB<=eF?eQ++:eQ--){eG.push(eQ)}return eG}).apply(this)}if(eC>eD){eL=(function(){eE=[];for(var eQ=eA=eD+1;eA<=eC?eQ<=eC:eQ>=eC;eA<=eC?eQ++:eQ--){eE.push(eQ)}return eE}).apply(this)}eJ=cY.get();if(eJ>=0){return eN.concat(eL).concat(eO)}else{return eN.concat(eO).concat(eL)}};T.prototype.log_thumb_load=function(ew,ex){var ez,ev,ey;if(!this.timeline.opts.log_thumb_loading){return}if(this.scroll_count===bp.scroll_count&&!this.logged_thumbs_arrived){if((ew+1)%this.timeline.THUMBS_PER_ROW===0||ew+1===ex){if(this.visible_thumbs_loaded()){ev=this.timeline.get_viewport_info();ez=this.timeline.events.indexOfKey(this.unique_id)===(this.timeline.events.length()-1);if((this.top_offset<ev.bottom&&ev.bottom<this.top_offset+this.get_height())||ez){if(bp.scroll_count<2&&((ey=h.get_current_view())===bW.PHOTOS_VIEW||ey===bW.CAMERA_VIEW)){this.log_timing_event(E.viewport_initial_load);bp.scroll_count+=2}else{this.log_timing_event(E.viewport_loaded)}}return this.logged_thumbs_arrived=true}}}};T.prototype.log_timing_event=function(ey){var ev,ew,ez,ex;ew=bE.time();ev={};if(ey===E.viewport_initial_load){if((typeof performance!=="undefined"&&performance!==null?(ex=performance.timing)!=null?ex.navigationStart:void 0:void 0)!=null){ez=bE.time()-performance.timing.navigationStart;ev={current_view:h.get_current_view()};dE.log_ajax_transition(ez,ey,ev,ey)}return}if(this.timing_stopped_scrolling_on_event===-1){return}if(ey===E.viewport_loaded){ez=ew-this.timing_stopped_scrolling_on_event}return dE.log_ajax_transition(ez,ey,ev,ey)};return T})();var F;F=A.Photo=(function(){T.PLACEHOLDER=0;T.LOADED=1;T.RENDERED=2;T.DISPLAYED=3;T.uniqueness_key;T.item_counter;T.filename;T.ns_id;T.ns_path;T.fq_path;T.href;T.thumbnail_url;T.large_thumbnail_url;T.time_taken;T.display_time_taken;T.preview_type;T.mtime;T.video_streaming_url;T.is_visible;T.user_id;T.event;T.status;T.thumb_html;T.preview_obj;T.duplicates_info;function T(ev){this.event=ev;this.status=T.PLACEHOLDER;this.preview_obj=ev.unique_id}T.prototype.init_metadata=function(ev){this.uniqueness_key=ev.uniqueness_key;this.item_counter=ev.item_counter;this.filename=ev.filename;this.ns_id=ev.ns_id;this.ns_path=ev.ns_path;this.fq_path=ev.path;this.href=ev.href;this.thumbnail_url=ev.thumbnail_url;this.large_thumbnail_url=ev.large_thumbnail_url;this.time_taken=ev.time_taken;this.display_time_taken=ev.display_time_taken;this.preview_type=ev.preview_type;this.mtime=ev.mtime;this.video_streaming_url=ev.video_streaming_url;this.is_visible=ev.is_visible;this.user_id=ev.user_id;this.thumb_html=this.event.timeline.tmpl({photo:this,display_date:this._get_display_date(),shareable:true,Sprite:b6});this.preview_obj=this._get_preview_obj();this.status=T.LOADED;this.event.num_photos_loaded+=1;return this.event.timeline.key_to_photo[this.uniqueness_key]=this};T.prototype.set_duplicates=function(ex){var ew,ey,ev;for(ey=0,ev=ex.length;ey<ev;ey++){ew=ex[ey];ew.fq_path=ew.path}return this.duplicates_info=ex};T.prototype._get_preview_obj=function(){if(!this.event.timeline.opts.uses_lightbox){return}if(this.preview_type==="photo"&&this.large_thumbnail_url){if(bp.in_single_collection_view()){return new ea({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:C.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}else{return new cR({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:C.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}}else{if(this.preview_type==="video"&&this.large_thumbnail_url&&!Constants.DISABLE_VIDEOS_IN_LIGHTBOX){if(bp.in_single_collection_view()){return new ak({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:C.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}else{return new eh({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:C.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}}}return null};T.prototype._get_display_date=function(){var ev;if(this.time_taken!=null){ev=new Date(this.time_taken);return bE.nice_date_with_month_name(ev,ev.getUTCFullYear()<new Date().getFullYear(),true)}else{return""}};return T})();var W;W=A.PhotoCollection=(function(){T.CREATE_EVT="db:photocollection:create";T.ADD_EVT="db:photocollection:add";T.REMOVE_EVT="db:photocollection:remove";T.UNDO_REMOVE_EVT="db:photocollection:undo_remove";T.RENAME_EVT="db:photocollection:rename";T.DELETE_EVT="db:photocollection:delete";T.SHARE_EVT="db:photocollection:share";T.UNSHARE_EVT="db:photocollection:unshare";T.COVER_CHANGE_EVT="db:photocollection:cover_change";T.gid;T.name;T.num_items;T.num_photos;T.num_videos;T.thumbnail_url_32;T.thumbnail_url_256;T.is_anonymous;T.share_tkey;T.shmodel_url;T.short_url;T.is_creator;T.member_fnames;function T(ew,ev){if(ev==null){ev=true}ci((ew.gid!=null)&&(ew.url!=null)&&(ew.name!=null)&&(ew.num_items!=null)&&(ew.num_photos!=null)&&(ew.num_videos!=null),"missing required PhotoCollection params");this.gid=ew.gid;this.url=ew.url;this.name=ew.name;this.num_items=ew.num_items;this.num_photos=ew.num_photos;this.num_videos=ew.num_videos;this.thumbnail_url_32=ew.thumbnail_url_32||null;this.thumbnail_url_256=ew.thumbnail_url_256||null;this.is_anonymous=ew.is_anonymous!=null?ew.is_anonymous:false;this.share_tkey=ew.share_tkey||null;this.shmodel_url=ew.shmodel_url||null;this.short_url=ew.short_url||null;this.is_creator=ew.is_creator!=null?ew.is_creator:true;this.member_fnames=ew.member_fnames||[dU("You")];if(ev){document.fire(T.CREATE_EVT,{collection:this})}}T.prototype.add_photos=function(eB,eA,ex,ez){var ev,ey,ew;if(eA==null){eA=null}if(ex==null){ex=false}if(ez==null){ez=true}ev=(function(){var eE,eD,eC;eC=[];for(eE=0,eD=eB.length;eE<eD;eE++){ew=eB[eE];eC.push(ew.item_counter)}return eC})();ci(ev.length,"Have to add at least one photo");ey={collection_gid:this.gid,item_counters:JSON.stringify(ev)};if(eA!=null){ey.source_collection_gid=eA}return new Ajax.DBRequest("/collection_add",{parameters:ey,job:ex,job_user:cj.get_viewer().photos_user,progress_text:dU("Adding to album..."),onSuccess:(function(eC){return function(eF){var eD,eG,eE,eH;eH=JSON.parse(eF.responseText);eC.thumbnail_url_32=eH.thumbnail_url_32;eC.thumbnail_url_256=eH.thumbnail_url_256;eG=eH.new_num_photos-eC.num_photos;eE=eH.new_num_videos-eC.num_videos;eD=eH.new_num_items-eC.num_items;eC.num_photos=eH.new_num_photos;eC.num_videos=eH.new_num_videos;eC.num_items=eH.new_num_items;return document.fire(T.ADD_EVT,{collection:eC,photos:eB,num_items_added:eD,num_photos_added:eG,num_videos_added:eE,promote_collection:ez})}})(this)})};T.prototype.remove_photos=function(ey,ex){var ev,ew;if(ex==null){ex=false}ev=(function(){var eB,eA,ez;ez=[];for(eB=0,eA=ey.length;eB<eA;eB++){ew=ey[eB];ez.push(ew.item_counter)}return ez})();return new Ajax.DBRequest("/collection_remove",{parameters:{collection_gid:this.gid,item_counters:JSON.stringify(ev),is_shared:this.share_tkey!=null,num_items:this.num_items},job:ex,job_user:cj.get_viewer().photos_user,progress_text:dU("Removing from album..."),onSuccess:(function(ez){return function(eA){var eB;eB=JSON.parse(eA.responseText);ez.thumbnail_url_32=eB.thumbnail_url_32;ez.thumbnail_url_256=eB.thumbnail_url_256;ez.num_photos=eB.new_num_photos;ez.num_videos=eB.new_num_videos;ez.num_items=eB.new_num_items;return document.fire(T.REMOVE_EVT,{collection:ez,photos:ey,undo_changeset:eB.undo_changeset})}})(this)})};T.prototype.undo_remove=function(ev){return new Ajax.DBRequest("/photos_undo_remove",{parameters:{collection_gid:this.gid,changeset:ev},html_in_error_msg:true,progress_text:dU("Undoing..."),onSuccess:(function(ew){return function(){return document.fire(T.UNDO_REMOVE_EVT,{collection:ew})}})(this)})};T.prototype.rename=function(ew){var ev;bp.enable_selection();ev=new Ajax.InPlaceEditor(ew,"/collection_rename",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.name,cancelIfSame:true,clickToEdit:false,onComplete:function(){return bf("#single-collection-title-container").removeClass("editing")},onFailure:function(){},savingText:dU("Saving..."),onLeaveEditMode:bp.disable_selection,onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:(function(ex){return function(ey){ex.name=ey.responseText;return document.fire(T.RENAME_EVT,{collection:ex})}})(this)},callback:(function(ex){return function(ey,ez){return{collection_gid:ex.gid,new_collection_name:ez,is_shared:ex.share_tkey!=null}}})(this)});return ev.enterEditMode()};T.prototype["delete"]=function(){if(this.share_tkey!=null){new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{subject_user:cj.get_viewer().photos_user})}return new Ajax.DBRequest("/collection_delete",{parameters:{collection_gid:this.gid,is_shared:this.share_tkey!=null,num_items:this.num_items},subject_user:cj.get_viewer().photos_user,onSuccess:(function(ev){return function(){return document.fire(T.DELETE_EVT,{collection:ev})}})(this)})};T.prototype.attach_to_token=function(ex,ez,ew,ey,ev){return new Ajax.DBRequest("/collection_attach_to_dummy_token",{parameters:{tkey:ex,collection_gid:this.gid,num_items:this.num_items},onSuccess:(function(eA){return function(){eA.share_tkey=ex;eA.shmodel_url=ez;eA.short_url=ew;if(typeof ey==="function"){ey()}return document.fire(T.SHARE_EVT,{collection:eA})}})(this),onFailure:function(){return typeof ev==="function"?ev():void 0}})};T.prototype.send_link=function(ew,ey,eC,ex,eB,ev){var eA,ez;eA=(function(eD){return function(){eD.share_tkey=ey;eD.shmodel_url=eC;eD.short_url=ex;if(typeof eB==="function"){eB()}return document.fire(T.SHARE_EVT,{collection:eD})}})(this);ez={collection_gid:this.gid,share_tkey:ey,num_items:this.num_items};return bs.ajax_submit(ew,"/collection_share",eA,ev,ew.down(".tokenizer-submit-button"),ez)};T.prototype.unshare=function(){ci(this.share_tkey!=null,"Can't unshare collection "+this.gid+" without a tkey");return new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{onSuccess:(function(ev){return function(){ev.share_tkey=null;ev.shmodel_url=null;ev.short_url=null;return document.fire(T.UNSHARE_EVT,{collection:ev})}})(this),subject_user:cj.get_viewer().photos_user})};T.prototype.set_cover=function(ev){return new Ajax.DBRequest("/collection_set_cover",{parameters:{collection_gid:this.gid,item_counter:ev.item_counter},onSuccess:(function(ew){return function(ex){var ey;ey=JSON.parse(ex.responseText);ew.thumbnail_url_32=ey.thumbnail_url_32;ew.thumbnail_url_256=ey.thumbnail_url_256;return document.fire(T.COVER_CHANGE_EVT,{collection:ew})}})(this)})};return T})();var bF,k;bF=__PARENT_SCOPE__.FilePreview=INLINE_JS.FilePreview=A.FilePreview={PARTIAL_TEXT_LENGTH_THRESHOLD:64*1024,init_pdf:function(ey,ex,ev){var T,ew;this._log_pdf_render_time(ey);if(ey==="pdf-native"||ey==="pdf-embedded"||ey==="pdf-js"){window.addEventListener("message",k,false);ae.window_load((function(ez){return function(){bf("#pdf-embed-iframe").attr("src",ex);bf("#pdf-embed-iframe").attr("type","application/pdf");bf("#pdf-embed-iframe").attr("allowfullscreen","");return ez._fire_pdf_render_event()}})(this));this.preview_status=ev;if(bB.chrome){ew=function(){var ez;ez=bf('link[rel="shortcut icon"]').remove();return bf("head").append(ez)};setTimeout(ew,1000)}T=$$("#pdf-embed-container iframe");return window.setTimeout(((function(ez){return function(){return T.invoke("setStyle",{visibility:"visible"})}})(this)),200)}},init_excel:function(T){window.addEventListener("message",k,false);return bf("#pdf-embed-iframe").attr("src",T)},excel_preview_unsupported:function(){return this.preview_failed()},init_font:function(){return bf((function(T){return function(){if(!$(document.documentElement).hasClassName("fontface")||$(document.body).hasClassName("gecko")){return $(document.body).removeClassName("file-preview-body")}}})(this))},init_photo:function(ex,eA){var eC,ey,eB,ez,ew,T,ev;$("preview-img").observe("error",this.preview_failed.bind(this));if((ez=window.performance)!=null?(ew=ez.timing)!=null?ew.navigationStart:void 0:void 0){$("preview-img").observe("load",function(){var eD;eD=bE.time()-window.performance.timing.navigationStart;return dE.log_ajax_transition(eD,"file-preview-photo")})}$("full-img").src=ex;T=$$("#preview-img, #full-img");ev=[];for(ey=0,eB=T.length;ey<eB;ey++){eC=T[ey];eC.setAttribute("data-original-href",eA);ev.push(eC.on("contextmenu","img",a1.show_shmodel.bind(a1)))}return ev},init_htmlified:function(){if(window.htmlified_height){this.htmlified_loaded();return}if(!window.postMessage){this.preview_failed();return}return setTimeout(((function(T){return function(){if(!window.htmlified_height){return T.preview_failed()}}})(this)),10000)},htmlified_loaded:function(){var T;if((T=$("htmlified-loading"))!=null){T.remove()}$("htmlified").style.height=window.htmlified_height+"px";return $("htmlified").style.visibility=""},init_video:function(ex,ev,ew,ey,eA,ez,eC){var eB,T;T=eC.width()*0.9;eB=T*0.55;return bf((function(eD){return function(){var eE;eE=eD._video_preview_failed;if(ey==="hls"){eD.player=a7.embed("#video",{src:ew,type:"application/vnd.apple.mpegurl",width:T,height:eB,controls:true,poster:eA,onError:eE,onReady:eD._player_ready,metadata_link:ez})}else{bf("#video").empty();if(ex){if(ev){eD.player=a7.embed("#video",{src:ew,type:"video/mp4",width:T,height:eB,controls:true,poster:eA,onError:eE,onReady:eD._player_ready,metadata_link:ez})}else{eE()}}else{eD.player=a7.embed("#video",{src:ew,type:"video/flv",width:T,height:eB,controls:true,poster:eA,onError:eE,onReady:eD._player_ready,metadata_link:ez})}}bf(".vjs-poster").hide();bf(".vjs-big-play-button").hide();eD.player.on("play",eD._onPlay);return eD.player.on("ended",eD._onEnded)}})(this))},photo_loaded:function(ew){var ev,T;if((ev=window.performance)!=null?(T=ev.timing)!=null?T.navigationStart:void 0:void 0){ew=ew-window.performance.timing.navigationStart;return dE.log_ajax_transition(ew,"file-preview-photo")}},_player_ready:function(){var T;T=function(){bf(".vjs-poster").show();bf(".vjs-big-play-button").show();return bf(".vjs-big-play-button").focus()};return T.defer()},_onPlay:function(){bf(".vjs-poster").hide();return bf(".vjs-big-play-button").hide()},_onEnded:function(){bf(".vjs-poster").show();bf(".vjs-big-play-button").show();return bf(".vjs-loading-spinner").hide()},_video_preview_failed:function(T){if(T==="needflash"){bf("#video-preview-flash-message").show()}return bF.preview_failed()},preview_failed:function(){var T;T=bf(document.body);if(T.hasClass("shmodel-body")){T.removeClass("file-preview-body")}Y.error(dU("Preview failed."));return bf(document).trigger("preview_failed")},_fire_pdf_render_event:function(){var T;if(document.createEvent&&window.dispatchEvent){T=document.createEvent("UIEvents");T.initUIEvent("pagerender",false,false,window,0);return window.dispatchEvent(T)}},_log_pdf_render_time:function(ev){var T;T=function(ez){var ex,ey,ew;if((ey=window.performance)!=null?(ew=ey.timing)!=null?ew.navigationStart:void 0:void 0){ex=bE.time()-window.performance.timing.navigationStart;return dE.log_ajax_transition(ex,ez)}};Event.observe(window,"pagerender",function(){Event.stopObserving(window,"pagerender");return T(ev)});return Event.observe(window,"parsecomplete",function(){Event.stopObserving(window,"parsecomplete");return T(""+ev+"-parse")})},enter_rams_fullscreen:function(){return bu.enter_rams_fullscreen(bf("#pdf-embed-container"))},exit_rams_fullscreen:function(){return bu.exit_rams_fullscreen(bf("#pdf-embed-container"))},is_rams_fullscreen_active:function(){return bu.is_rams_fullscreen_active(bf("#pdf-embed-container"))}};k=function(ey){var ex,ev,ew,T;ev={"https://dl-doc.dropbox.com":true,"https://dl.dropbox.com":true};ev["https://"+Constants.DL_DOC_USER_CONTENT_DOMAIN]=true;ev["https://"+Constants.PUBSERVER]=true;ev[Constants.WEB_STATIC_DROPBOX]=true;if(ev[ey.origin]){ew={};try{ew=JSON.parse(ey.data);ex=ew.action}catch(ez){T=ez;ex=ey.data}switch(ex){case"failed":return bF.preview_failed()}}};var dB;Effect.BlindFadeUp=function(ex,ew){var ev,T;ev=new Effect.BlindUp(ex,ew);T=new Effect.Fade(ex,ew);this.cancel=function(){ev.cancel();return T.cancel()}};Effect.BlindFadeDown=function(ex,ew){var ev,T;ev=new Effect.BlindDown(ex,ew);T=new Effect.Appear(ex,ew);this.cancel=function(){ev.cancel();return T.cancel()}};Effect.Flash=function(ew,ev,T){ci(ev.startcolor&&ev.endcolor,"Start and end colors must be specified");ci(ev.cycles,"Fade cycles must be specified");T=T||0;return new Effect.Highlight(ew,{duration:1,startcolor:ev.startcolor,endcolor:ev.endcolor,restorecolor:ev.endcolor,afterFinish:function(){return new Effect.Highlight(ew,{duration:1,startcolor:ev.endcolor,endcolor:ev.startcolor,restorecolor:ev.startcolor,afterFinish:function(){if(T<ev.cycles){return Effect.Flash(ew,ev,T+1)}}})}})};Effect.ScaleComprehensive=Class.create(Effect.Scale,{setup:function(){var eK,eI,eQ,eE,eJ,eL,eF,eG,eB,ey,ew,ev,eR,eW,eU,eS,eP,eO,eN,eM,T,eX,eV,eT,eH,eD,eC,eA,ex,ez;this.restoreAfterFinish=this.options.restoreAfterFinish||false;this.elementPositioning=this.element.getStyle("position");this.originalStyle={};eH=["top","left","width","height","fontSize"];for(eB=0,eR=eH.length;eB<eR;eB++){eL=eH[eB];this.originalStyle[eL]=this.element.style[eL]}this.originalTop=this.element.offsetTop;this.originalLeft=this.element.offsetLeft;eE=this.element.getStyle("font-size")||"100%";eD=["em","px","%","pt"];for(ey=0,eW=eD.length;ey<eW;ey++){eJ=eD[ey];if(eE.indexOf(eJ)>0){this.fontSize=parseFloat(eE);this.fontSizeType=eJ}}this.factor=(this.options.scaleTo-this.options.scaleFrom)/100;if(this.options.scaleMode==="box"){this.dims={height:this.element.offsetHeight,width:this.element.offsetWidth}}if(/^content/.test(this.options.scaleMode)){this.dims={height:this.element.scrollHeight,width:this.element.scrollWidth}}if(!this.dims){this.dims={height:this.options.scaleMode.originalHeight,width:this.options.scaleMode.originalWidth}}this.full_height=this.dims.height;this.full_width=this.dims.width;eI=["border%sWidth","margin%s","padding%s"];for(ew=0,eU=eI.length;ew<eU;ew++){eF=eI[ew];eC=["Top","Bottom","Left","Right"];for(ev=0,eS=eC.length;ev<eS;ev++){eQ=eC[ev];eG=eF.format(eQ);this.dims[eG]=parseFloat(this.element.getStyle(eG));if(eQ==="Top"||eQ==="Bottom"){this.full_height+=this.dims[eG]}else{this.full_width+=this.dims[eG]}}}this.attrs_vertical=[];this.attrs_horizontal=[];if(this.options.scaleX){for(T=0,eP=eI.length;T<eP;T++){eK=eI[T];this.attrs_horizontal.push(eK.format("Left"))}this.attrs_horizontal.push("width");eA=eI.reverse();for(eX=0,eO=eA.length;eX<eO;eX++){eK=eA[eX];this.attrs_horizontal.push(eK.format("Right"))}}if(this.options.scaleY){for(eV=0,eN=eI.length;eV<eN;eV++){eK=eI[eV];this.attrs_vertical.push(eK.format("Top"))}this.attrs_vertical.push("height");ex=eI.reverse();ez=[];for(eT=0,eM=ex.length;eT<eM;eT++){eK=ex[eT];ez.push(this.attrs_vertical.push(eK.format("Bottom")))}return ez}},update:function(T){var ev;ev=(this.options.scaleFrom/100)+(this.factor*T);ev=(-0.5+1/(1+Math.exp((0.5-ev)*7)))*1.055+0.5;if(this.options.scaleContent&&this.fontSize){this.element.setStyle({fontSize:this.fontSize*ev+this.fontSizeType})}return this.setDimensions(ev)},setDimensions:function(ey){var eD,eG,eE,eB,eC,ev,ez,ex,eF,T,eA,ew;eE={};eA=[[this.full_width,this.attrs_horizontal],[this.full_height,this.attrs_vertical]];for(ez=0,eF=eA.length;ez<eF;ez++){ew=eA[ez],eB=ew[0],eG=ew[1];eC=eB*ey;for(ex=0,T=eG.length;ex<T;ex++){eD=eG[ex];ev=this.dims[eD];if(ev<eC){eE[eD]=ev+"px";eC-=ev}else{eE[eD]=eC.round()+"px";eC=0}}}return this.element.setStyle(eE)}});Effect.BlindUpComprehensive=function(T){T=$(T);T.makeClipping();return new Effect.ScaleComprehensive(T,0,Object.extend({scaleContent:false,scaleX:false,restoreAfterFinish:true,afterFinishInternal:function(ev){return ev.element.hide().undoClipping()}},arguments[1]||{}))};Effect.BlindDownComprehensive=function(ev){var T;ev=$(ev);T=ev.getDimensions();return new Effect.ScaleComprehensive(ev,100,Object.extend({scaleContent:false,scaleX:false,scaleFrom:0,scaleMode:{originalHeight:T.height,originalWidth:T.width},restoreAfterFinish:true,afterSetup:function(ew){return ew.element.makeClipping().setStyle({height:"0px"}).show()},afterFinishInternal:function(ew){return ew.element.undoClipping()}},arguments[1]||{}))};Effect.HighlightForcedWithAlpha=Class.create(Effect.Highlight,{setup:function(){var eC,eA,ew,ez,eB,ex,eD,ey,ev,T;this.oldStyle={};if(!this.options.keepBackgroundImage){this.oldStyle.backgroundImage=this.element.getStyle("background-image");this.element.setStyle({backgroundImage:"none"})}if(!this.options.endcolor){this.options.endcolor=this.element.getStyle("background-color")}if(!this.options.restorecolor){this.options.restorecolor=this.element.getStyle("background-color")}this._supports_alpha=false;try{eA=new Element("div");eB="rgba(1, 1, 1, 0)";eA.setStyle({backgroundColor:eB});this._supports_alpha=(eA.getStyle("background-color"))===eB}catch(eE){}this._base=dB(this.options.startcolor);if((ey=this.options.endcolor)==="transparent"||ey==="rgba(0, 0, 0, 0)"){if(this._supports_alpha){ew=this._base.slice(0);ew[3]=0}else{ew=[255,255,255,1]}}else{ew=dB(this.options.endcolor)}this._delta=[];ev=this._base;T=[];for(ez=ex=0,eD=ev.length;ex<eD;ez=++ex){eC=ev[ez];T.push(this._delta.push(ew[ez]-eC))}return T},update:function(T){var eB,ew,eA,ex,ez,ev,ey;eA=[];ey=this._base;for(ex=ez=0,ev=ey.length;ez<ev;ex=++ez){eB=ey[ex];ew=eB+this._delta[ex]*T;if(!(ex>2)){ew=Math.round(ew)}eA.push(ew)}if(this._supports_alpha){return this.element.setStyle({backgroundColor:"rgba("+(eA.join(", "))+")"})}else{return this.element.setStyle({backgroundColor:"rgb("+(eA.slice(0,3).join(", "))+")"})}}});dB=function(ew){var ex,eA,ez,ey,T,ev,eB,eD,eC;ev=/^rgb\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3})\)$/;T=/^rgba\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3}), ?(\d+?\.?\d*)\)$/;ey=/^#([0-9A-F])([0-9A-F])([0-9A-F])$/i;eA=/^#([0-9A-F])([0-9A-F])([0-9A-F])([0-9A-F])$/i;ez=/^#([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])$/i;ex=/^#([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])$/i;if(eD=ew.match(ev)){eC=(function(){var eH,eF,eG,eE;eG=eD.slice(1);eE=[];for(eH=0,eF=eG.length;eH<eF;eH++){ew=eG[eH];eE.push(parseInt(ew,10))}return eE})()}else{if(eD=ew.match(T)){eC=(function(){var eH,eF,eG,eE;eG=eD.slice(1,4);eE=[];for(eH=0,eF=eG.length;eH<eF;eH++){ew=eG[eH];eE.push(parseInt(ew,10))}return eE})();eC[3]=parseFloat(eD[4])}else{if(eD=ew.match(ey)){eC=(function(){var eH,eF,eG,eE;eG=eD.slice(1);eE=[];for(eH=0,eF=eG.length;eH<eF;eH++){ew=eG[eH];eE.push(parseInt(ew+ew,16))}return eE})()}else{if(eD=ew.match(eA)){eC=(function(){var eH,eF,eG,eE;eG=eD.slice(1);eE=[];for(eH=0,eF=eG.length;eH<eF;eH++){ew=eG[eH];eE.push(parseInt(ew+ew,16))}return eE})()}else{if(eD=ew.match(ez)){eC=(function(){var eH,eF,eG,eE;eG=eD.slice(1);eE=[];for(eH=0,eF=eG.length;eH<eF;eH++){ew=eG[eH];eE.push(parseInt(ew,16))}return eE})()}else{if(eD=ew.match(ex)){eC=(function(){var eH,eF,eG,eE;eG=eD.slice(1);eE=[];for(eH=0,eF=eG.length;eH<eF;eH++){ew=eG[eH];eE.push(parseInt(ew,16))}return eE})()}}}}}}eC=eC||[255,255,255,1];eB=eC.length;if(eB===3){eC.push(1)}else{if(eB===4&&eC[eB-1]>1){eC[eB-1]=eC[eB-1]/255}}return eC};var aq;aq=A.ClientDownload=(function(){function T(){}T.prototype.show_download_modal=function(){return new Ajax.DBRequest("/download_modal_view",{onSuccess:function(ev){var ew;ew=bf("<div",{"class":"brodal-header",text:dU("Install Dropbox")});return ep.show(ew[0],$("client-download"),{},false,450)},subject_user:b2.active_user})};return T})();var b7,dI,h,E,aP,cD,bW;b7=A.AlbumsLogger={log_share:function(ev,ey,ex,ew,T){return b7.log(ev,ey,true,ex,ew,T)},log_event:function(T,ex,ew,ev){return b7.log(T,ex,false,ew,ev)},log:function(ev,eA,ex,ez,ey,T){var ew;ew={evt:ev,collection_gid:eA,is_anonymous:ey};if(ex!=null){ew.share_event=ex}if(ez!=null){ew.num_items=ez}if(T!=null){ew.on_create=T}return new Ajax.DBRequest("/collection_log",{method:"post",noAutonotify:true,parameters:ew})}};dI=INLINE_JS.PhotosEvents=A.PhotosEvents={CLEAR_SELECTED:"clear_selected",SHARE:"share",SHARE_ALBUM:"share_album",GO_TO_ALBUM_LINK:"go_to_album_link",UNSHARE_ALBUM:"unshare_album",ADD_TO_NEW_ALBUM:"add_to_new_album",ADD_TO_RECENT_ALBUM:"add_to_recent_album",ADD_TO_OTHER_ALBUM:"add_to_other_album",SHOW_IN_FOLDER:"show_in_folder",DELETE:"delete",DELETE_ALBUM:"delete_album",REMOVE:"remove",SET_AS_COVER:"set_as_cover",RENAME_ALBUM:"rename_album",OPEN_LIGHTBOX:"open_lightbox",MARQUEE_SELECT:"marquee_select",SEND:"send",GET_LINK:"get_link",FB_SHARE:"fb_share",TWITTER_SHARE:"twitter_share"};aP=INLINE_JS.PhotosTourEvents=A.PhotosTourEvents={SKIP:"skip",AWESOME:"awesome",EXIT_MODAL:"exit_modal",SHOW_MODAL:"show_modal"};cD=INLINE_JS.PhotosTriggers=A.PhotosTriggers={SAH:"selected_actions_header",PCM:"photos_context_menu",CCM:"collections_context_menu",SCA:"single_collection_action",CLICK:"click",DBL_CLICK:"double_click",DRAG:"drag",ESC:"escape",CLICK_TITLE:"click_title",LIGHTBOX:"lightbox",DROP_TARGET:"drop_target",FOSHMODAL:"foshmodal"};bW=A.PhotosViews={PHOTOS_VIEW:"photos_view",CAMERA_VIEW:"camera_view",ALBUMS_VIEW:"albums_view",SINGLE_COLLECTION_VIEW:"single_collection_view",NOT_PHOTOS:"not_photos",MISSING_TIMESTAMPS_VIEW:"missing_timestamps_view"};h=INLINE_JS.PhotosLogger=A.PhotosLogger={last_logged_error_msg:null,last_error_msg_url:null,get_current_view:function(){var T,ew,ev;T=((ev=$("modal"))!=null?ev.visible():void 0)&&$("shmodal").visible();ew=T?"-foshmodal":"";if(bp.in_single_collection_view()){return bW.SINGLE_COLLECTION_VIEW+ew}else{if(bp.in_all_collections_view()){return bW.ALBUMS_VIEW+ew}else{if(bp.initialized){return bW.PHOTOS_VIEW+ew}else{return bW.NOT_PHOTOS}}}},log_interaction:function(T,ev,ew){return h.log(T,ev,null,h.get_current_view(),ew)},log_transition_to:function(T){return h.log(T,null,null,h.get_current_view(),null,true)},log:function(ev,ew,T,eA,ey,ez){var ex;ex={evt:ev,trigger:ew,view:T};if(ey!=null){ex.data=JSON.stringify(ey)}if(eA!=null){ex.start_view=eA}if(ez!=null){ex.transition=true}return new Ajax.DBRequest("/photos_log",{method:"post",noAutonotify:true,parameters:ex})}};E=A.PhotosTimingEvents={viewport_loaded:"viewport_loaded",viewport_initial_load:"viewport_initial_load"};var c7,aA;aA=A.ShmodelLogger={CLICK_SIGN_IN:"click_sign_in",CLICK_ADD_TO_MY_DROPBOX:"click_add_to_my_dropbox",REMOVE_LINK:"remove_link",CLICK_FILENAME:"click_filename",CLICK_DOWNLOAD:"click_download",LOGIN_THRU_DEFAULT_DROPDOWN:"login_thru_default_dropdown",CLICK_SIGNUP_THRU_DEFAULT_DROPDOWN:"click_signup_thru_default_dropdown",CLICK_SHARE:"click_share",log:function(T){return new Ajax.DBRequest("/shmlog",{method:"post",noAutonotify:true,parameters:{evt:T,url:window.location.href}})},attachLogListener:function(T,ev){if(ev==null){return}return ev.observe("click",function(ew){aA.log(T);if(ev.href&&ev.href!=="#"&&ev.target!=="_blank"){Event.stop(ew);return(function(){return window.location.href=ev.href}).defer()}})}};c7=A.RegistrationLogger={log:function(T){var ev;ev=window.location.href;return new Ajax.DBRequest("/share/reglog",{method:"post",noAutonotify:true,parameters:{evt:T,url:ev}})},attachLogListener:function(T,ev){if(ev==null){return}return ev.observe("click",function(ew){c7.log(T);if(ev.href&&ev.href!=="#"&&ev.target!=="_blank"){Event.stop(ew);return(function(){return window.location.href=ev.href}).defer()}})}};var e;e=A.ModalFlow=(function(){function T(eD,eB,eF,ex,ew,eA,eE){var ev,ey,eC,ez;this.title=eD;this.icon=eB;this.states=eF;this.next_state_table=ex;this.previous_state_table=ew;this.initial=eA;this.onStart=eE;this._state_map={};ez=this.states;for(ey=0,eC=ez.length;ey<eC;ey++){ev=ez[ey];this._state_map[ev.name]=ev}this.state=null;this._exit_listeners=[];this._cleanup_queue=[]}T.prototype.start=function(){var ey,ex,ev,ew;this.vars={};ew=this.states;for(ex=0,ev=ew.length;ex<ev;ex++){ey=ew[ex];ey.next=this._next.bind(this,ey);ey.back=this._back.bind(this,ey);if(ey.onSubmit){ey.onSubmitFn=(function(ez,eA){ez.onSubmit(this,ez,eA);return false}).bind(this,ey)}else{ey.onSubmitFn=((function(ez){return function(eA,eB){eA.next();return false}})(this)).bind(this,ey)}ey.contents.on("submit",ey.onSubmitFn);ey.contents.find(".backbutton").on("click",ey.back)}ep.onHide=this._onExit.bind(this);if(this.onStart){this.onStart()}this.to_state(this.initial);return false};T.prototype.to_state=function(ew){var ev;this.state=this._state_map[ew];ev=this.title;if(this.state.title!=null){ev=this.state.title}ep.show(ev,this.state.contents[0]);return this.state.enter(this)};T.prototype._next=function(ev){var ew;if(ev===this.state){ew=this.next_state_table[this.state.name](this);if(ew==="__exit__"){return this.exit()}else{return this.to_state(ew)}}};T.prototype._back=function(ev){var ew;if(ev===this.state){ew=this.previous_state_table[this.state.name](this);if(ew==="__cancel__"){return this.exit()}else{if(ew){return this.to_state(ew)}}}};T.prototype.exit=function(){return this._onExit()};T.prototype._onExit=function(eC){var ex,ev,eA,ez,eD,ew,eB,ey;eB=this.states;for(eA=0,eD=eB.length;eA<eD;eA++){ev=eB[eA];ev.contents.off("submit",ev.onSubmitFn)}this._cleanUpExitListeners();ey=this._exit_listeners;for(ez=0,ew=ey.length;ez<ew;ez++){ex=ey[ez];ex(eC)}ep.onHide=null;return ep.hide()};T.prototype.addExitListener=function(ev){return this._exit_listeners.push(ev)};T.prototype.removeExitListener=function(ev){return this._cleanup_queue.push(ev)};T.prototype._cleanUpExitListeners=function(){var ey,ex,eA,ew,ez,ev;ez=this._cleanup_queue;ev=[];for(eA=0,ew=ez.length;eA<ew;eA++){ey=ez[eA];ex=this._exit_listeners.indexOf(ey);ev.push(this._exit_listeners.splice(ex,1))}return ev};return T})();var cd;cd=A.TwoFactorAuth={_checkpoint_token:null,_email:null,_container_selector:null,_error_selector:null,_is_offline_setup:null,_invalid_code_count:null,_current_flow:null,set_user:function(T){this._user=cj.get_viewer().get_user_by_id(T);ci(this._user,""+T+" is invalid");return bf("#twofactor-enter-password .email-placeholder").text(this._user.email)},login_init:function(){this._container_selector="#twofactor-confirm";this._error_selector="#twofactor-confirm .error-message";return this.login_listen()},login_listen:function(){bf("#resend-link").on("click",this.resend_phone_code.bind(this));return bf("#code").focus()},init:function(T){this._container_selector=".twofactor-account-form";this._error_selector=".twofactor-account-form .error-message";this.account_listen();return ds.async_load_script(T)},account_listen:function(){var eA,T,ev,ex,ey,eD,eE,ew,eC,ez,eB;eC={name:"delivery_choice",enter:(function(eF){return function(eG){var eH;eF.hide_error();eH=0;bf(".delivery-choice").each(function(){var eI;eI=bf(this).height();return eH=Math.max(eI,eH)});bf(".delivery-choice").height(eH);return bf(".delivery-choice.selected > input").prop("checked",true)}})(this),contents:bf("#twofactor-delivery-choice"),onSubmit:(function(eF){return function(eG,eH,eI){eG.vars.sms=!!(bf("#use-sms")[0].getValue()==="on");if(!eG.vars.sms){return eF.fetch_offline_key(eG,eH)}else{return eH.next()}}})(this)};ez={name:"enter_phone_number",enter:(function(eF){return function(eH){var eI,eG;eF.hide_error();eF._is_offline_setup=false;eF._phone_number=null;eI=$("twofactor-enter-phone");eG=eF.fill_phone_number_for_edit(eI,bf("#twofactor-row-"+eF._user.role+" #twofactor-sms-number").text());return eG.focus()}})(this),contents:bf("#twofactor-enter-phone"),onSubmit:this.submit_phone_number.bind(this)};eB={name:"offline_setup",enter:(function(eF){return function(eG){eF.hide_error();eF._is_offline_setup=true;return eF._phone_number=null}})(this),contents:bf("#twofactor-offline-setup")};ew={name:"confirm_phone",enter:(function(eF){return function(eG){var eH;eF._invalid_code_count=0;if(eF._is_offline_setup){$("twofactor-enable-confirm").addClassName("offline")}else{eH=eG.vars.phone_number;ci(eH,"expected a display_phone argument");$("phone-number-placeholder").__date(eH);$("twofactor-enable-confirm").removeClassName("offline")}eF.hide_error();$("phone-code").clear().focus();return eF.fill_delivery_choice(eH)}})(this),onSubmit:this.submit_phone_code.bind(this),contents:bf("#twofactor-enable-confirm")};eE={name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_next"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_none"),contents:bf("#twofactor-enter-backup-phone")};ey=new e(this.DEFAULT_ENABLE_TITLE,this.LOCK_ICON,[{name:"enable_start",enter:this.hide_error.bind(this),contents:bf("#twofactor-start")},{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.ENABLE_CONFIRM_HREF,(function(eF){return function(eG,eH){eF.successfully_enabled=false;eG.vars.mode="ENABLE";eG.vars.passed_password=true;return eH.next()}})(this)),contents:bf("#twofactor-enter-password")},eC,ez,eB,ew,eE,{name:"recovery_code",enter:(function(eF){return function(){eF.fill_backup_phone(eF._backup_phone);return eF.hide_error.bind(eF)}})(this),onSubmit:this.submit_finish.bind(this),contents:bf("#twofactor-recovery")},{name:"congrats_done",enter:this.after_enabled.bind(this),title:dU("Congrats! You've enabled two-step verification!"),contents:bf("#twofactor-done")}],{enable_start:function(){return"password"},password:function(){return"delivery_choice"},delivery_choice:((function(eF){return function(eG){if(eG.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}})(this)),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"recovery_code"},recovery_code:function(){return"congrats_done"},congrats_done:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{enable_start:function(){return null},password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(eF){if(eF.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"},recovery_code:function(){return"backup_phone"},congrats_done:function(){return null}},"enable_start",function(){return this.vars.passed_password=false});ey.addExitListener((function(eF){return function(eG){if(ey.vars.passed_password&&eG&&!eF.successfully_enabled){return Y.error(dU("Two-step verification is not enabled"))}}})(this));ex=new e(this.DEFAULT_EDIT_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(eF){return function(eH,eI){var eG;eF.successfully_enabled=false;bf(".delivery-choice").removeClass("selected");eG=!bf("#twofactor-row").hasClass("with-sms");bf(eG?"#app-choice":"#sms-choice").addClass("selected");bf("#twofactor-recovery").addClass("edit-mode");eH.vars.passed_password=true;return eI.next()}})(this)),contents:bf("#twofactor-enter-password")},eC,ez,eB,ew,{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_save"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_everything"),contents:bf("#twofactor-enter-backup-phone")}],{password:function(){return"delivery_choice"},delivery_choice:((function(eF){return function(eG){if(eG.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}})(this)),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(eF){if(eF.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"}},"password",function(){return this.vars.passed_password=false});ex.addExitListener((function(eF){return function(eG){if(ex.vars.passed_password&&eG&&!eF.successfully_enabled){return Y.error(dU("Two-step verification has not been changed"))}}})(this));T=new e(this.DEFAULT_DISABLE_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.DISABLE_CONFIRM_HREF,(function(eF){return function(eG,eH){eF.successfully_disabled=false;eG.vars.passed_password=true;return eH.next()}})(this)),contents:bf("#twofactor-enter-password")},{name:"disable",enter:this.hide_error.bind(this),contents:bf("#twofactor-disable"),onSubmit:this.disable_submit.bind(this)}],{password:function(){return"disable"},disable:function(){return"__exit__"}},{password:function(){return null},disable:function(){return"__cancel__"}},"password",function(){return this.vars.passed_password=false});T.addExitListener((function(eF){return function(eG){if(T.vars.passed_password&&eG&&!eF.successfully_disabled){return Y.error(dU("Two-step verification is still enabled"))}}})(this));eA=new e(this.ADD_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(eF){return function(eG,eH){return eH.next()}})(this)),contents:bf("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,true,"save_backup_phone"),contents:bf("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");ev=new e(this.EDIT_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(eF){return function(eG,eH){return eH.next()}})(this)),contents:bf("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_backup_phone"),contents:bf("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");eD=new e(this.EDIT_RECOVERY_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(eF){return function(eG,eH){return new Ajax.DBRequest(eF.RECOVERY_CODE_HREF,{parameters:{checkpoint_token:eF._checkpoint_token},onSuccess:function(eI){var eJ;eJ=eI.responseText.strip();if(eJ.startsWith("OK:")){eF.fill_recovery_code(eJ.substr(3),"backup-code-div-edit");return eH.next()}else{switch(eJ){case"EXPIRED":return eF.show_error_expired();case"ALREADY_DISABLED":bf("#twofactor-row").removeClass("twofactor-enabled");Y.success(dU("Two-step verification is already disabled. Did you maybe disable it in another window?"));return ep.hide()}}},onFailure:eF.show_error500.bind(eF),cleanUp:eF.hide_loading.bind(eF),subject_user:eF._user})}})(this)),contents:bf("#twofactor-enter-password")},{name:"recovery_code",enter:this.hide_error.bind(this),contents:bf("#twofactor-recovery-edit"),onSubmit:(function(eF){return function(eG,eH){eF._checkpoint_token=null;return eH.next()}})(this)}],{password:function(){return"recovery_code"},recovery_code:function(){return"__exit__"}},{password:function(){return null},recovery_code:function(){return null}},"password");bf(".enable-twofactor").on("click",(function(eF){return function(eG){return eF.start_flow(eG,ey)}})(this));bf(".disable-twofactor").on("click",(function(eF){return function(eG){return eF.start_flow(eG,T)}})(this));bf(".add-twofactor-backup-link").on("click",(function(eF){return function(eG){return eF.start_flow(eG,eA)}})(this));bf(".edit-twofactor-backup").on("click",(function(eF){return function(eG){return eF.start_flow(eG,ev)}})(this));bf(".edit-twofactor-recovery").on("click",(function(eF){return function(eG){return eF.start_flow(eG,eD)}})(this));bf(".edit-twofactor-sms, .edit-twofactor-offline").on("click",(function(eF){return function(eG){return eF.start_flow(eG,ex)}})(this));bf("#generate-new-recovery-code").on("click",(function(eF){return function(eG){eF.show_loading();return new Ajax.DBRequest(eF.NEW_RECOVERY_CODE_HREF,{parameters:{checkpoint_token:eF._checkpoint_token},onSuccess:function(eH){var eI;eI=eH.responseText.strip();if(eI.startsWith("OK:")){return eF.fill_recovery_code(eI.substr(3),"backup-code-div-edit")}else{switch(eI){case"EXPIRED":eD.to_state("password");return eF.show_error_expired();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");Y.success(dU("Two-step verification is disabled. Did you maybe disable it in another window?"));return ep.hide()}}},onFailure:eF.show_error500.bind(eF),cleanUp:eF.hide_loading.bind(eF),subject_user:eF._user})}})(this));bf("#twofactor-enter-backup-phone #country-code").on("change",this.reset_phone_field.bind(this));bf("#resend-link").on("click",this.enable_resend_phone_code.bind(this));bf("#twofactor-delivery-choice input").change(function(){bf(".delivery-choice").removeClass("selected");return bf(this).parents(".delivery-choice").addClass("selected")});bf("#show-qr").on("click",(function(eF){return function(eG){bf("#twofactor-offline-setup").addClass("showing-qr");return false}})(this));bf("#hide-qr").on("click",(function(eF){return function(eG){bf("#twofactor-offline-setup").removeClass("showing-qr");return false}})(this));if(window.location.hash==="#backup2fa"&&bf("#twofactor-row").hasClass("allow-autopop")){return this.start_flow(eA)}},start_flow:function(ew,ev){var T;ew.preventDefault();T=bf(ew.target).data("uid");cd.set_user(cj.get_viewer().get_user_by_id(T));this._current_flow=ev;ev.start();return false},connect_login_init:function(){this._container_selector="#twofactor-form";this._error_selector="#twofactor-form .error";return bf("#resend-link").on("click",this.connect_resend_phone_code.bind(this))},resend_phone_code:function(ev){var T;if(this.is_resending()){return}this.show_resending();T="/twofactor_resend";if(bf("#twofactor-confirm").hasClass("backup")){T=C.parse(T).updateQuery({backup:true}).toString()}new Ajax.DBRequest(T,{onSuccess:(function(ew){return function(ex){switch(ex.responseText.strip()){case"OK":ew.hide_error();return ew.notify_resent();case"UNREACHABLE":return ew.show_error_unreachable(true);case"BADCARRIER":return ew.show_error_bad_carrier();case"INVALIDNUMBER":return ew.show_error_invalid_number();case"NOTAMOBILE":return ew.show_error_not_a_mobile();case"RATELIMIT":return Y.error(dU("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-confirm").submit()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},connect_resend_phone_code:function(T){if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(ev){return function(ew){switch(ew.responseText.strip()){case"OK":ev.hide_error();return ev.notify_resent();case"UNREACHABLE":return Y.error(error_unreachable(true));case"BADCARRIER":return Y.error(error_bad_carrier());case"INVALIDNUMBER":return ev.show_error_invalid_number();case"NOTAMOBILE":return Y.error(error_not_a_mobile());case"RATELIMIT":return Y.error(dU("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-form").submit()}}})(this),onFailure:(function(ev){return function(ew){return Y.error(ev.error500())}})(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},enable_resend_phone_code:function(T){if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(ev){return function(ew){switch(ew.responseText.strip()){case"OK":ev.hide_error();return ev.notify_resent();case"UNREACHABLE":return ev.show_error_unreachable();case"BADCARRIER":return ev.show_error_bad_carrier();case"INVALIDNUMBER":return ev.show_error_invalid_number();case"NOTAMOBILE":return ev.show_error_not_a_mobile();case"RATELIMIT":return Y.error("You've asked for too many SMS messages. Please try again in a few minutes.");case"EXPIRED":ev._current_flow.to_state("password");return ev.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},DEFAULT_ENABLE_TITLE:dU("Enable two-step verification"),DEFAULT_EDIT_TITLE:dU("Edit two-step verification"),DEFAULT_DISABLE_TITLE:dU("Disable two-step verification"),ADD_BACKUP_TITLE:dU("Add a backup phone number"),EDIT_BACKUP_TITLE:dU("Edit backup phone number"),EDIT_RECOVERY_TITLE:dU("View recovery code"),LOCK_ICON:"lock32",ENABLE_CONFIRM_HREF:"/account/twofactor/confirm_password",DISABLE_CONFIRM_HREF:"/account/twofactor/disable_confirm_password",EDIT_CONFIRM_HREF:"/account/twofactor/edit_confirm_password",RECOVERY_CODE_HREF:"/account/twofactor/get_rescue_code",NEW_RECOVERY_CODE_HREF:"/account/twofactor/new_rescue_code",enter_password_shown:function(){var T;this.hide_error();bf("#twofactor-recovery").removeClass("edit-mode");T=$("twofactor-enter-password");bf("#password",T).val("").focus();return false},submit_password:function(ew,ez,T,ex,ey){var ev;ev=$("password").getValue();if(!ev){this.show_error(dU("Please enter your password"));return}this.show_loading();return new Ajax.DBRequest(ew,{parameters:{password:ev},onSuccess:(function(eA){return function(eB){var eC;eC=eB.responseText.strip();if(eC.startsWith("OK:")){eA._checkpoint_token=eC.substr(3);return ez(T,ex)}else{switch(eC){case"EXPIRED_PASSWORD":return eA.show_error_expired_password();case"INVALID":return eA.show_error(dU("Invalid password"));case"RATELIMIT":return eA.show_error(dU("Too many incorrect passwords. Please try again in a few minutes."));case"ALREADY_ENABLED":$("twofactor-row").addClassName("twofactor-enabled");Y.success(dU("Two-step verification is already enabled. Did you maybe enable it in another window?"));return ep.hide();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");Y.success(dU("Two-step verification is already disabled. Did you maybe disable it in another window?"));return ep.hide()}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fetch_offline_key:function(T,ev){this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,offline:true},onSuccess:(function(ew){return function(ex){var ey;ey=ex.responseText.strip();if(ey.startsWith("OK:")){ew.fill_key(ey.substr(3));return ev.next()}else{switch(ey){case"EXPIRED":T.to_state("password");return ew.show_error_expired()}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_key:function(ev){var T,ex,ew;ev=ev.replace(new RegExp("=+$"),"");T=ev.toLowerCase().replace(/(.{4})/g,"$1 ");$("secret-div").__date(T);$("qr-div").__date();ew=Constants.IS_PROD?"Dropbox":"DropboxDev";ex={text:"otpauth://totp/"+ew+":"+this._user.email+"?secret="+ev+"&issuer="+ew,width:200,height:200};if(!Modernizr.canvas){ex.render="table"}bf("#qr-div").qrcode(ex);if(!Modernizr.canvas){return bf("#qr-div > table").css("margin","0 auto")}},submit_phone_number:function(ev,ex,ey){var T,ew;T=bf("#twofactor-enter-phone .twofactor-phone-number");if(!T.controller().validate_on_submit()){return}ew=T.val();this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,phone_number:ew},onSuccess:(function(ez){return function(eA){switch(eA.responseText.strip()){case"OK":ez._phone_number=ew;ev.vars.phone_number=ew;return ex.next();case"EXPIRED":ev.to_state("password");return ez.show_error_expired();case"UNREACHABLE":return ez.show_error_unreachable(T);case"BADCARRIER":return ez.show_error_bad_carrier(T);case"INVALIDNUMBER":return ez.show_error_invalid_number(T);case"NOTAMOBILE":return ez.show_error_not_a_mobile(T);case"RATELIMIT":return ez.show_error(dU("You've added too many phone numbers. Please try again in a few minutes."))}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},submit_phone_code:function(T,ev,ex){var ew;ew=$("phone-code").getValue().strip();if(!ew){this.show_error(dU("Please enter the security code"));return}if(ew.search(/^\d{6}$/)===-1){this.show_error(dU("Invalid security code"));return}this.show_loading();return new Ajax.DBRequest("/account/twofactor/confirm_phone",{parameters:{checkpoint_token:this._checkpoint_token,twofactor_code:ew},onSuccess:(function(ey){return function(ez){var eB,eA;eA=ez.responseText.strip();if(eA.startsWith("OK:")){ey.fill_recovery_code(eA.substr(3),"backup-code-div");return ev.next()}else{switch(eA){case"INVALID":ey._invalid_code_count+=1;eB=ey._invalid_code_count<=2?dU("Invalid code"):ey._is_offline_setup?dU("Invalid code. Check the clock on your phone: it must be accurate to the minute."):dU("Invalid code");return ey.show_error(eB);case"EXPIRED":T.to_state("password");return ey.show_error_expired();case"RATELIMIT":return ey.show_error(dU("Too many invalid codes. Try again in a few minutes."))}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},enter_backup_phone_number_shown:function(ex,ev){var ew,T;this.hide_error();ew=$("twofactor-enter-backup-phone");T=this.fill_phone_number_for_edit(ew,bf("#twofactor-row-"+this._user.role+" #twofactor-backup-number").text());T.focus();if(ex==="back_next"){bf("#twofactor-backup-back-next").show();bf("#twofactor-backup-cancel-save").hide();return bf("#twofactor-backup-back-save").hide()}else{if(ex==="cancel_save"){bf("#twofactor-backup-back-next").hide();bf("#twofactor-backup-cancel-save").show();return bf("#twofactor-backup-back-save").hide()}else{if(ex==="back_save"){bf("#twofactor-backup-back-next").hide();bf("#twofactor-backup-cancel-save").hide();return bf("#twofactor-backup-back-save").show()}}}},submit_backup_phone_number:function(ey,ex,ev,ez,eA){var T,ew;T=bf("#twofactor-enter-backup-phone .twofactor-backup-phone-number");if(!T.controller().validate_on_blur()){return}ew=T.val();if(ew){if(this.is_primary_number(ew)){T.controller().show_error(dU("You can't use your primary phone as your backup",T));return}}else{if(ey){T.controller().show_error(dU("Please enter phone number",T));return}}this._backup_phone=ew;if(ex==="save_backup_phone"){this.save_added_backup_phone(ev,ey,ew)}else{if(ex==="save_everything"){this.submit_finish(ev,ez,eA)}else{if(ex==="save_none"){return ez.next()}}}},is_same_phone_number:function(ev,T){if(!ev||!T){return false}return ev.replace(/\D+/g,"")===T.replace(/\D+/g,"")},is_primary_number:function(T){var ev;ev=bf("#twofactor-row-"+this._user.role);if(this._is_offline_setup){return false}if(this.is_same_phone_number(T,ev.data("primary_phone"))){return true}if(this.is_same_phone_number(T,bf("#twofactor-sms-number",ev).text())){return true}return false},save_added_backup_phone:function(T,ew,ev){this.show_loading();return new Ajax.DBRequest("/account/twofactor/set_backup_phone",{parameters:{checkpoint_token:this._checkpoint_token,backup_phone_number:ev},onSuccess:(function(ex){return function(ey){var ez;switch(ey.responseText.strip()){case"OK":ex.hide_error();ez="#twofactor-row-"+ex._user.role;bf(""+ez+" #twofactor-backup-number").text(ev);bf(ez).toggleClass("with-backup",!!ev);ds.syncHeight();if(!ev){Y.success(dU("Backup phone number removed"))}else{if(!ew){Y.success(dU("Backup phone number updated"))}else{Y.success(dU("Backup phone number added"))}}return ep.hide();case"EXPIRED":T.to_state("password");return ex.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_phone_number_for_edit:function(ex,ez){var ey,ev,ew,T;ev=bf(".sick-input > input",ex);if(!ez){return ev.val("")}T=bf('select[name="country_code"]',ex);ey=/^\+\d+/.exec(ez);ey=ey?ey[0]:"";ew=this.option_for_country_code(T,ey);if(ew!=null){ew.selected=true}ev.val(bf.trim(ez.slice(ey.length)));if(ev.length){ev[0].select()}return ev},option_for_country_code:function(T,ew){var ev;if(ew){ev=bf('option[value="'+ew+'"]',T);if(ev.length>1){ev=ev.filter("[selected]")}if(ev.length){return ev[0]}}return bf("option[selected]",T)[0]},fill_delivery_choice:function(T){bf("#twofactor-delivery-phone-label,#confirm-phone-primary").toggle(!!T);bf("#twofactor-delivery-offline-label").toggle(!T);bf("#confirm-phone-primary-number").text(T);return bf("#twofactor-row-"+this._user.role).data("primary_phone",T)},fill_backup_phone:function(T){bf("#confirm-phone-backup").toggle(!!T);return bf("#confirm-phone-backup-number").text(T)},fill_recovery_code:function(ev,T){ev=ev.toLowerCase().replace(/(.{4})/g,"$1 ");return $(T).__date(ev)},submit_finish:function(T,ev,ew){var ex;this.show_loading();ex={checkpoint_token:this._checkpoint_token};if(this._backup_phone){ex.backup_phone_number=this._backup_phone}return new Ajax.DBRequest("/account/twofactor/enable_finish",{parameters:ex,onSuccess:(function(ey){return function(ez){switch(ez.responseText.strip()){case"OK":ey.successfully_enabled=true;if(T.vars.mode!=="ENABLE"){return ey.after_enabled(T,ev)}else{return ev.next()}break;case"EXPIRED":T.to_state("password");return ey.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},after_enabled:function(ev,ew){var T;this._checkpoint_token=null;this.hide_error();T=bf("#twofactor-row-"+this._user.role);T.toggleClass("with-sms",!!this._phone_number);bf("#twofactor-sms-number",T).text(this._phone_number||"");T.toggleClass("with-backup",!!this._backup_phone);bf("#twofactor-backup-number",T).text(this._backup_phone||"");T.addClass("twofactor-enabled");ds.syncHeight();if(ev.vars.mode!=="ENABLE"){Y.success(dU("Two-step verification updated"));return ew!=null?ew.next():void 0}},disable_submit:function(T,ev){this.show_loading();return new Ajax.DBRequest("/account/twofactor/disable",{parameters:{checkpoint_token:this._checkpoint_token},onSuccess:(function(ew){return function(ey){var ex;switch(ey.responseText.strip()){case"OK":ew.successfully_disabled=true;ew._checkpoint_token=null;ex=bf("#twofactor-row-"+ew._user.role);ex.removeClass("twofactor-enabled with-sms with-backup");bf("#twofactor-sms-number, #twofactor-backup-number",ex).text("");ds.syncHeight();Y.success(dU("Two-step verification is now disabled."));return ev.next();case"EXPIRED":T.to_state("password");return ew.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},show_error:function(ew,T){var ev;if(T){T.controller().show_error(ew);return}ev=$$(this._error_selector);if(ew===this.error_expired_password()||ew===this.error_unreachable(true)){ev.invoke("update",ew)}else{ev.invoke("__date",ew)}return ev.invoke("show")},show_error500:function(){return this.show_error(this.error_500())},show_error_bad_carrier:function(T){return this.show_error(this.error_bad_carrier(),T)},show_error_invalid_number:function(T){return this.show_error(this.error_invalid_number(),T)},show_error_not_a_mobile:function(T){return this.show_error(this.error_not_a_mobile(),T)},show_error_unreachable:function(T,ev){if(ev==null){ev=false}return this.show_error(this.error_unreachable(ev),T)},show_error_expired:function(T){return this.show_error(this.error_expired(),T)},show_error_expired_password:function(T){return this.show_error(this.error_expired_password(),T)},error_500:function(){return dU("Sorry, an error occurred. Please try again later.")},error_bad_carrier:function(){return dU("Unfortunately, your carrier is not supported at this time.")},error_invalid_number:function(){return dU("That is not a valid phone number.")},error_not_a_mobile:function(){return dU("That phone number does not appear to be a valid mobile number.")},error_unreachable:function(T){if(T==null){T=false}if(T){return dU('We couldn\'t reach your phone number. If this has happened before <a href="https://www.dropbox.com/help/364/">click here</a>.')}else{return dU("We couldn't reach your phone number. Are you sure it's correct?")}},error_expired:function(){return dU("Since it's been a while, please enter your password again.")},error_expired_password:function(){return dU('Your password has expired. Please create a new password <a target="_blank" href="/password_expired">here</a>.')},hide_error:function(){return $$(this._error_selector).invoke("__date")},show_loading:function(){this.hide_error();return $$(this._container_selector).invoke("addClassName","loading")},hide_loading:function(){return $$(this._container_selector).invoke("removeClassName","loading")},is_resending:function(){return $$(this._container_selector)[0].hasClassName("resending")},show_resending:function(){return $$(this._container_selector).invoke("addClassName","resending")},hide_resending:function(){return $$(this._container_selector).invoke("removeClassName","resending")},hide_resending_with_delay:function(){return setTimeout(this.hide_resending.bind(this),3000)},notify_resent:function(){return Y.success(dU("We sent you another code. It may take a few minutes to arrive."))},reset_phone_field:function(ev){var T,ew;T=ev.element();ew=bf(".sick-input",T.form);bf("input",ew).val("").focus();return this.fill_example_phone_number(T,ew)},fill_example_phone_number:function(T,ex){var ew,ev;if(typeof phone_helpers!=="undefined"&&phone_helpers!==null){ew=bf(T).val().substr(1);ev=phone_helpers.get_example_mobile_number(ew);return bf("label",ex).text(dU("Example: ")+ev)}},reset_phone_field_and_backup_country:function(ev){var T;this.reset_phone_field(ev);if(bf("#backup-phone-number").val()===""){T=bf("#twofactor-enter-backup-phone #country-code");T.val(ev.element().getValue());return this.fill_example_phone_number(T,bf(".sick-input",T[0].form))}}};var bK;bK=A.PseudoLocalStorage={_store:{},getItem:function(T){return this._store[T]},setItem:function(T,ev){return this._store[T]=ev},removeItem:function(T){return delete this._store[T]},clear:function(){return this._store={}}};var bu;bu=A.FileViewRamsCommon={RAMS_FULLSCREEN_TRANSITION_TIME_MSEC:1000,enter_rams_fullscreen:function(T){T.addClass("rams-fullscreen").data("rams-fullscreen",true);return bf(window).resize()},exit_rams_fullscreen:function(T){T.removeClass("rams-fullscreen").removeData("rams-fullscreen");return bf(window).resize()},is_rams_fullscreen_active:function(ev){var T;T=ev.data("rams-fullscreen");return(T!=null)&&T}};var l;l=__PARENT_SCOPE__.FileViewer=INLINE_JS.FileViewer=A.FileViewer={KEY_SCOPE:"fileviewer",_MODAL_FILEINFO:0,_MODAL_PREVIEW:1,file:null,has_preview:false,preview_locked:false,preview_lock_listener:null,modal_type:this._MODAL_FILEINFO,is_loaded:false,has_key_listener:false,history_length:null,preview_status_timeout_obj:null,preview_status_request:null,_non_fullscreen_vert_overflow:null,active_user:null,in_browse:true,globalPreviewStateModel:new Backbone.Model({state:"closed",file_obj:null}),_get_extension:function(ev){var T;T=ev.lastIndexOf(".");return(T===-1?"":ev.substr(T+1))},show:function(ev,T,ew){this.file=ev;this.active_user=T;this.in_browse=ew;this._start_time=Date.now();this.history_length=window.history.length;if(this.file.preview_type==="download"){return window.location.href=this.file.href}else{document.title=this.file.filename;this._render_viewer();return bf("#file-viewer").show().trigger("db:filepreview:open",[this.file])}},shown:function(){return bf("#file-viewer").css("display")!=="none"},set_preview_url:function(ev,T,ex){var ez,ey,ew;ez=C.parse(dX.get_url());ey=ez.getPath();ew=ez.updateQuery({preview:ev.filename}).getQuery();return dX.push_state(C.encode_parts(ey),ew)},unset_preview_url:function(){var ew,ev,T;ew=C.parse(dX.get_url());if(ew.getPath().match(/^\/s[h]?\/.+/)||!this.in_browse){return}if(!("preview" in ew.getQuery())){return}ev=ew.getPath();T=ew.removeQuery("preview").getQuery();return dX.push_state(C.encode_parts(ev),T)},render_file_failed:function(){this._hide();this.file=this.last_file;this.file.doc_preview_status=Constants.DOC_PREVIEW_UNAVAILABLE_BAD_FILE;this._render_viewer();return bf("#file-viewer").show()},_log_view:function(T,ev){var ew;ew={mode:"file-preview",file_ext:an.file_extension_for_logging(this.file.filename),preview_type:this.file.preview_type,preview_status:this.file.doc_preview_status,time_taken:T,file_bytes:this.file.bytes,is_team:this.active_user.is_team===1,paid:this.active_user.paid===1,in_progress:ev,ns_id:this.file.ns_id,ns_path:this.file.ns_path,sjid:this.file.sjid,user_id:this.active_user.id};return aQ.UserActivityLogger.log("web","file_view",ew)},_render_viewer:function(){var eA,ev,eD,eE,ex,eG,T,eF,eC,eH,ew,ey,eB,ez;y.scroll_lock_document();ev=bf("#file-viewer");eA=ev.find(".download-button");eE=C.parse(this.file.href).updateQuery({dl:1}).toString();eB=(function(eI){return function(eP){var eL,eN,eK,eM,eO,eJ;if(eP==null){eP=true}eK=bt.em_snippet(eI.file.filename,35);eL=ev.find(".title-bar .filename");eO={"class":"icon",alt:eI.file.caption};eM=b6.html("web",eI.file.icon,eO).toHTML();eN=bf("<span />",{"class":"filename-text"}).text(eK);eL.html(eM).append(eN);ev.addClass("has-preview");if(eI.file.htmlified_link){}else{if(eI.file.preview_type==="excel"){ev.addClass("html-preview");ev.find(".loading").css("z-index","-1")}else{ev.addClass(""+eI.file.preview_type+"-preview")}}if(eP){ev.find(".loading").show()}eA.on("click",function(eQ){eQ.preventDefault();return window.location.href=eE});if(eI.file.tkey===void 0&&l.active_user.is_email_verified){eJ=function(eQ){this.file.tkey=eQ.tkey;return this._update_title_bar_buttons()};cb.WebRequest({url:"/sm/get_token",type:"POST",data:{path:eI.file.fq_path},dataType:"json",subject_user:eI.active_user.id,success:eJ.bind(eI)})}else{eI._update_title_bar_buttons()}eI.modal_type=eI._MODAL_PREVIEW;eI._first_render_completed=false;return eI._listen()}})(this);eG=(function(eI){return function(){ev.removeClass();ev.find(".loading").hide();return eI._unlisten()}})(this);ey=(function(eI){return function(eJ,eO,eM,eL,eK){var eN;if(eJ==null){eJ=false}if(eO==null){eO=true}if(eM==null){eM=false}if(eL==null){eL=false}if(eK==null){eK=true}eI._log_view(Date.now()-eI._start_time,eL);eN=eI._get_extension(eI.file.filename);if(eN==="doc"||eN==="docx"||eN==="ppt"||eN==="pptx"||eN==="xls"||eN==="xlsx"||eN==="pdf"){eI.globalPreviewStateModel.set({state:"open",file_obj:eI.file})}if(!eJ){eB(eO);eI._update_title_bar_buttons()}eI._render_preview(eM,eK);return eI._initial_resize()}})(this);ew=(function(eI){return function(eJ){var eK;if(eJ==null){eJ=false}eI.globalPreviewStateModel.set({state:"closed",file_obj:null});eK=bt.em_snippet(eI.file.filename,20);ev.find(".title-bar .filename").text(eK);ev.addClass("no-preview");ev.find(".file-thumbnail img").attr({src:"/static/images/icons128/"+(an.file_icon(eI.file.filename))+".png"});ev.find(".file-type").text(eK);ev.find(".file-size").text(eI.file.size);ev.find(".file-modified").text(eI.file.ago||"");eA.on("click",function(){return bB.redirect(eE)});eI.modal_type=eI._MODAL_FILEINFO;eI._listen();eI._log_view(Date.now()-eI._start_time,eJ);eI._update_title_bar_buttons();return eI._initial_resize()}})(this);ex=this._get_extension(this.file.fq_path);eH=(this.file.preview_type==="doc"||this.file.preview_type==="excel"||this.file.preview_type==="keynote")&&(this.file.bytes<Constants.MAX_PDF_FILE_SIZE_B||an.file_extension(this.file.filename).toLowerCase()!=="pdf");this.has_preview=(this.file.preview_type==="text"&&this.file.bytes<Constants.MAX_TEXT_FILE_SIZE_B)||(this.file.preview_type==="html"&&"sandbox" in document.createElement("iframe"))||(eH&&this.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE);T=eH&&this._preview_progressive_try(ex);if(this.has_preview||T){return ey(false,!(this.file.preview_type==="doc"),false,false,this.has_preview)}eF=eH&&this.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS;if(!eF){return ew()}eB();eC=C({path:"/doc_preview_status"+this.file.fq_path}).toString();ez=Date.now();return(eD=(function(eI){return function(){var eJ;eJ=Date.now();if(eJ-ez>=5000){eG();return ew(true)}return eI.preview_status_request=bf.ajax(eC,{success:function(eK){if(eI.file){return eI.file.doc_preview_status=parseInt(eK,10)}},complete:function(eK,eL){if(eL==="abort"){return}if(eI.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE){eI.has_preview=true;return ey(true,false,true,true)}else{if(eI.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS){return eI.preview_status_timeout_obj=setTimeout(eD,1000)}else{eG();return ew(true)}}},timeout:5000-(eJ-ez),subject_user:eI.active_user})}})(this))()},_remove_loading:function(T){if(T==null){T=true}bf("#file-viewer .loading").hide();return this.is_loaded=T},_update_title_bar_buttons:function(){var ew,ev,eA,eI,ez,eM,eB,eC,ey,ex,T,eG,eK,eL,eH,eJ,eN,eE,eF,eD;ez=bf("#file-viewer");ew=ez.find(".download-button");ev=ez.find(".split-button.openwith");eI=ev!=null?ev.find(".main-button"):void 0;eA=ev!=null?ev.find(".more-button"):void 0;eM=dU("Open",{comment:"Open a file natively on the user's computer"});eF=function(){return ez.data("is-unity-allowed")==="True"&&(__CONDITIONAL_JS__.UnityFeatures!=null)};eE=(function(eO){return function(eP){var eQ;return ez.data("is-openwith-allowed")==="True"&&((eQ=__CONDITIONAL_JS__.OpenWith)!=null?eQ.get_open_handler_for(eP,eO.active_user):void 0)}})(this);eK=(function(eO){return function(){return __CONDITIONAL_JS__.UnityFeatures.open_file(eO.file.ns_id,eO.file.ns_path,eO.file.user_id,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler)}})(this);eL=(function(eO){return function(){var eP;eP=__CONDITIONAL_JS__.OpenWith.get_open_handler_for(eO.file,eO.active_user);if(eP!=null){return bB.redirect(eP.uri)}}})(this);eN=(function(eO){return function(eQ,eP,eS){var eR;if(!eQ&&!eP){eH(false)}else{if(eQ&&eP){ex(eM,eO.file,eK,eL)}else{if(eQ){ey(eM,eL)}else{ey(eM,eK)}}}if(!eQ&&!eP){eR=false}else{if(eP){eR=false}else{eR=true}}if(!eR&&!eS){return eO._hide_more_button()}else{return eO._show_more_button(eS,eR)}}})(this);eH=function(eO){if(ev!=null){ev.toggleClass("shown",eO)}return ew.toggle(!eO)};ey=function(eO,eP){if((ev==null)&&(eI==null)){return}eH(true);ev.removeClass("split");eI.text(eO);return eI.off("click").on("click",eP)};ex=(function(eO){return function(eU,eP,eT,eS){var eR,eQ;if((ev==null)&&(eI==null)&&(eA==null)){return}eH(true);ev.addClass("split");eI.text(eU);eR=ez.find(".openwith-dropdown");eI.off("click").on("click",function(eV){return eT(eV)});eA.off("click").on("click",function(eW){var eV;eV=bf(this).parent().siblings(".openwith-dropdown");if(eV.is(":visible")){return}eb.show(eV,this,null,true);return eW.stopPropagation()});eR.find(".openwith-desktop-link").off("click").on("click",function(eV){eV.preventDefault();return eT(eV)});eQ=__CONDITIONAL_JS__.OpenWith.get_open_handler_for(eP,eO.active_user);eR.each(function(){return b6.src(bf(this).find(".openwith-link .sprite")[0],"web",eQ.icon)});eR.find(".openwith-link .sprite-text-inner").text(eQ.name);eR.find(".openwith-link").off("click").on("click",function(eV){eV.preventDefault();return eS(eV)});return bf("#file-viewer-container").off("click",eb.hide_all).on("click",eb.hide_all)}})(this);eJ=!!eF();eB=!!eE(this.file);eC=!!this.file.tkey;eN(false,false,eC);if(eB){eN(eB,false,eC)}if(eJ){T=(function(eO){return function(){return eN(eB,true,eC)}})(this);if((eD=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?eD.get(this.file.ns_id,this.file.ns_path):void 0){return T()}else{eG=(function(eO){return function(eP){if(eP){return T()}}})(this);return __CONDITIONAL_JS__.UnityFeatures.check_file(this.file.ns_id,this.file.ns_path,this.file.user_id,eG)}}},_show_more_button:function(eA,ev){var ey,ez,ew,ex,T;T=bf("#file-viewer");ey=T.find(".more-options-button");ey.show();ew=T.find(".more-options-dropdown");ey.on("click",(function(eB){return function(eC){if(ew.is(":visible")){return}eb.show(ew,ey,null,true);return eC.stopPropagation()}})(this));bf("#file-viewer-container").on("click",eb.hide_all);ex=ew.find(".remove-link");ex.off("click");if(eA){ex.show();ex.on("click",(function(eB){return function(eC){eb.hide_all();return ad.confirm_remove(eB.file.filename,eB.file.tkey,0,0,0,eB.file.user_id)}})(this))}else{ex.hide()}ez=ew.find(".download-button");return ez.toggle(ev)},_hide_more_button:function(){var ev,T;T=bf("#file-viewer");ev=T.find(".more-options-button");ev.off("click").hide();bf("#file-viewer-container").off("click",eb.hide_all);return T.find(".remove-link").off("click")},_initial_resize:function(){var T;if(this.is_loaded){return}T=function(){return bf("window").trigger("resize")};return setTimeout(T,0)},_get_progressive_url:function(ey,ex){var ez,T,ew,ev;ev=this.active_user;ey=ey.substring(0,3).replace("rtf","doc").replace("pps","ppt");ew=C.parse(ex);T=false;if((ey==="doc"&&ev.progressive_previews_doc)||(ey==="key")||(ey==="keynote")){if(!(Constants.PDF_PREVIEW_MODE==="pdf-js")){ew=ew.updateQuery({post_message_on_failure:1})}}else{if(ey==="ppt"&&ev.progressive_previews_ppt){ez="private_progressive_viewer";T=true}else{if(ey==="xls"&&ev.progressive_previews_xls){if(ev.xls_edit){ez="xls/edit"}else{ez="xls/preview"}}}}if(ez){if(T){ew.setAuthority(Constants.WEBSERVER)}else{ew.setAuthority(ew.getAuthority().replace("dl-web","dl-doc"))}ew.setPath(ew.getPath().replace("/get/","/"+ez+"/"))}ew=ew.updateQuery({get_preview:1});return ew},_preview_is_progressive:function(ev){var T;ev=ev.substring(0,3).replace("rtf","doc").replace("pps","ppt");T=this.active_user;return(ev==="doc"&&T.progressive_previews_doc)||(ev==="ppt"&&T.progressive_previews_ppt)||(ev==="xls"&&T.progressive_previews_xls)||(ev==="key"||ev==="keynote")},_preview_progressive_try:function(T){if(!this._preview_is_progressive(T)){return false}if(this.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS){return true}T=T.substring(0,3).replace("rtf","doc").replace("pps","ppt");return this.file.doc_preview_status===Constants.DOC_PREVIEW_UNAVAILABLE_FAILED&&(((T==="ppt")&&this.active_user.progressive_previews_ppt_try_failed)||((T==="doc")&&this.active_user.progressive_previews_doc_try_failed)||((T==="xls")&&this.active_user.progressive_previews_xls_try_failed))||(T==="key")||(T==="keynote")},_set_previews_sandbox_params:function(ev,T){ev=ev.substring(0,3).replace("rtf","doc").replace("pps","ppt");if(ev!=="xls"){return""}else{return null}},_render_preview:function(ew,T){var ez,ex,ey,eB,ev,eA;if(ew==null){ew=false}if(T==null){T=true}if(ew){this._remove_loading(false)}eB=bf("#file-viewer .preview-content-container");if(this.file.htmlified_link){ey=bf("<iframe/>",{src:this.file.htmlified_link});eB.append(ey);return ey.on("load",this._remove_loading)}else{if(this.file.preview_type==="doc"){ez=this._get_extension(this.file.filename);ev=this._get_progressive_url(ez,this.file.href);ez=ez.substring(0,3).replace("rtf","doc").replace("pps","ppt");if(ez==="ppt"){ey=bf("<iframe/>",{src:ev.toString(),allowfullscreen:"",type:"application/pdf"});eB.append(ey)}else{if(this.active_user.inline_commenting){bf("#file-viewer-container").css({marginLeft:"0",width:"90%",left:"5%"});ev.setAuthority(ev.getAuthority().replace("dl-web","dl-doc"));ev.setPath(ev.getPath().replace("/get/","/dochax_private_commentless_preview/"));ex=ev.toString();ev=C.parse(Constants.static_url_pdfjs_hack_viewer);ev.setQuery({file:ex})}else{if(!T){ev=ev.updateQuery({generate_preview:1});ev.setAuthority(ev.getAuthority().replace("dl-web","dl-doc"))}if(Constants.PDF_PREVIEW_MODE==="pdf-js"){ex=ev.toString();ev=C.parse(Constants.static_url_pdfjs_viewer);ev.setQuery({file:ex})}}eA=String(ev.updateQuery(Constants.UID_PARAM_NAME,this.active_user));ey=bf("<iframe/>",{src:eA,type:"application/pdf"});eB.append(ey)}return ey.on("load",this._remove_loading)}else{if(this.file.preview_type==="html"){ey=bf("<iframe/>",{src:this.file.href,sandbox:""});eB.append(ey);return ey.on("load",this._remove_loading)}else{if(this.file.preview_type==="excel"){ev=this._get_progressive_url("xls",this.file.href);ey=bf("<iframe/>",{src:ev,type:"application/pdf"});this._set_previews_sandbox_params("xls",ey);eB.append(ey);return ey.on("load",this._remove_loading)}else{if(this.file.preview_type==="keynote"){ev=this._get_progressive_url("html",this.file.href);ev=ev.updateQuery({generate_preview:1});ey=bf("<iframe/>",{src:ev,type:"text/html"});eB.append(ey);return ey.on("load",this._remove_loading)}}}}}},post_preview_message:function(eC){var eB,ey,ez,eD,ev,T,ex,eA,ew;ez=bf("#file-viewer .preview-content-container iframe");ew=[];for(ex=0,eA=ez.length;ex<eA;ex++){ey=ez[ex];T=ey.src;ev="://";eD=T.indexOf(ev);if(eD===-1){eB=T.indexOf("/")}else{eB=T.indexOf("/",eD+ev.length)}if(eB!==-1){T=T.substring(0,eB)}ew.push(ey.contentWindow.postMessage(eC,T))}return ew},notify_preview_sfj:function(){return l.post_preview_message('{"action":"notify_sfj"}')},_listen:function(){var ev,T,ew;ev=bf("#file-viewer");ev.on("click",bf.proxy(this._hide,this));ev.find("#file-viewer-container").on("click",function(ex){return ex.stopPropagation()});ev.find(".js-close-button").on("click",bf.proxy(this._hide,this));if(this.in_browse){this.sfj_callback_handle=b2.add_subscribe_sfj_callback(l.notify_preview_sfj)}if(!this.has_key_listener){key("esc",this.KEY_SCOPE,bf.proxy(this._hide,this));this.has_key_listener=true}this.prev_scope=key.getScope();key.setScope(this.KEY_SCOPE);if(this.modal_type===this._MODAL_PREVIEW){ev.find(".share-button").on("click",bf.proxy(this._share,this));ew=(function(ex){return function(ey){if(ex.file.fq_path.toLowerCase()===ey.memo.fq_path.toLowerCase()){ex.file.tkey=ey.memo.tkey;return ex._update_title_bar_buttons()}}})(this);T=(function(ex){return function(ey){if(ex.file.tkey===ey.memo.token){ex.file.tkey=null;return ex._update_title_bar_buttons()}}})(this);this.share_link_callback=ew.bind(this);this.remove_link_callback=T.bind(this);document.observe(av.LINKS_ADD,this.share_link_callback);document.observe(av.LINKS_REMOVE,this.remove_link_callback)}else{if(this.modal_type===this._MODAL_FILEINFO){ev.find(".share-button").on("click",bf.proxy(this._share,this))}}bf(window).on("resize",bf.proxy(this._resize,this));this.preview_lock_listener=function(eB){var eA,ey,ez,ex;ey={"https://dl-doc.dropbox.com":true,"https://dl.dropbox.com":true};ey["https://"+Constants.DL_DOC_USER_CONTENT_DOMAIN]=true;ey["https://"+Constants.PUBSERVER]=true;ey[Constants.WEB_STATIC_DROPBOX]=true;if(ey[eB.origin]){ez={};try{ez=JSON.parse(eB.data);eA=ez.action}catch(eC){ex=eC;eA=eB.data}switch(eA){case"failed":return l.render_file_failed();case"lock_preview":return l.preview_locked=true;case"unlock_preview":return l.preview_locked=false;case"toggle_preview_lock":return l.preview_locked=!l.preview_locked;case"hide_iframe":return l._hide();case"loaded":return l.post_preview_message('{"action":"listening_sfj"}');case"pagerendered":return l._handle_page_rendered(ez.stats)}}};window.addEventListener("message",this.preview_lock_listener,false);return window.onbeforeunload=function(ex){if(l.preview_locked){return""}else{return void 0}}},_unlisten:function(){var T;T=bf("#file-viewer");T.off("click",bf.proxy(this._hide,this));T.find("#file-viewer-container").off("click",function(ev){return ev.stopPropagation()});T.find(".js-close-button").off("click",bf.proxy(this._hide,this));if(this.modal_type===this._MODAL_PREVIEW){T.find(".share-button").off("click",bf.proxy(this._share,this));T.find(".download-button").off("click");bf(document).off("click",eb.hide_all);document.stopObserving(av.LINKS_ADD,this.share_link_callback);document.stopObserving(av.LINKS_REMOVE,this.remove_link_callback)}else{if(this.modal_type===this._MODAL_FILEINFO){T.find(".share-button").off("click",bf.proxy(this._share,this))}}bf(window).off("resize",bf.proxy(this._resize,this));key.setScope(this.prev_scope);if(this.in_browse){b2.remove_sfj_callback(this.sfj_callback_handle);return this.sfj_callback_handle=null}},_resize:function(ew){var ev,T;if(!this._is_rams_ui()){ev=bf("#file-viewer");T=ev.find("#file-viewer-container").height()-(ev.find(".title-bar").height()+1);ev.find(".preview").height(T);return ev.trigger("height-resize",{height:T})}},_share:function(T){aQ.ShmodelUILogger.log("via-browse-file-viewer");T.preventDefault();return new cI(this.active_user.id,this.file.fq_path,"file_viewer").show()},_hide:function(){var ew,T,ev;this.globalPreviewStateModel.set({state:"closed",file_obj:null});if(this.preview_locked){if(!confirm("You have unsaved changes. Are you sure you want to leave this page?")){return}}if(this.preview_status_timeout_obj){clearTimeout(this.preview_status_timeout_obj);this.preview_status_timeout_obj=null}if(this.preview_status_request){this.preview_status_request.abort();this.preview_status_request=null}if(this.in_browse){ee.set_selected_files(this.file);l.unset_preview_url()}y.scroll_unlock_document();T=bf("#file-viewer");T.trigger("db:filepreview:close");if(this.is_rams_fullscreen_active()){this.exit_rams_fullscreen()}if(__CONDITIONAL_JS__.UnityFeatures!=null){ev=dU("Download");ew=T.find(".download-button");ew.text(ev);ew.off("click")}this._hide_more_button();T.hide().removeClass("has-preview").removeClass("no-preview");T.find(".preview-content-container").empty();T.find(".file-thumbnail img").attr({src:""});T.find(".title-bar .filename").text("");T.attr({"class":""});this._unlisten();this._remove_loading();this.last_file=this.file;this.file=null;this.preview_locked=false;window.removeEventListener("message",this.preview_lock_listener);return this.is_loaded=false},_handle_page_rendered:function(ex){var T,ew,ey,ez,ev;if(!this._first_render_completed){T={total_time:Date.now()-this._start_time,file_ext:an.file_extension_for_logging(this.file.filename)};for(ez=0,ev=ex.length;ez<ev;ez++){ey=ex[ez];ew=(function(){switch(ey.name){case"Page Request":return"viewer_page_request_time";case"Rendering":return"viewer_rendering_time";case"Overall":return"viewer_overall_time"}})();T[ew]=ey.end-ey.start}aQ.UserActivityLogger.log("web","file_view_first_page_rendered",T);return this._first_render_completed=true}},resize:function(){return this._resize(null)},hide:function(){return this._hide()},_is_rams_ui:function(){return bf("#file-viewer").attr("data-docpreview-ui-rams-enabled")},enter_rams_fullscreen:function(){var T;bu.enter_rams_fullscreen(bf(".preview"));T=bf("html");this._non_fullscreen_vert_overflow=T.css("overflow-y");return T.css("overflow-y","hidden")},exit_rams_fullscreen:function(){bu.exit_rams_fullscreen(bf(".preview"));bf("html").css("overflow-y",this._non_fullscreen_vert_overflow);return this._non_fullscreen_vert_overflow=null},is_rams_fullscreen_active:function(){return bu.is_rams_fullscreen_active(bf(".preview"))}};var dl;dl=A.Index2={init:function(eC,ey){var eA,eD,ev,eE,ez,T,ex,ew,eB;if(ey){bf("#sign-in").on("click",function(eK){var eF,eI,eH,eG,eJ;eK.preventDefault();eH=bf("#sign-in-form");ep.show(dU("Sign in"),eH[0],false,false,416,false,"sign-in-modal");eI=eH.find("#login_email");eI.focus();return new bG(eF=eI,eJ=function(){eH.find("#password-field").hide();eH.find("#remember-me").hide();eH.find("#login_submit").val(dU("Continue"));eH.find("#forgot_password_link").hide();return eH.find("#sso_description_footer").show()},eG=function(){eH.find("#password-field").show();eH.find("#remember-me").show();eH.find("#login_submit").val(dU("Sign in"));eH.find("#forgot_password_link").show();return eH.find("#sso_description_footer").hide()})})}eA=function(){if(!bf("#signup-container").hasClass("form_shown")){return bf.when(bf("#signup-container").animate({marginTop:-245},{easing:"easeInOutCubic",duration:500}).promise()).done(function(){return bf("#signup-container").addClass("form_shown")})}};if(!eC){bf(".register").find(".login-button").on("click",function(eF){if(!bf("#signup-container").hasClass("form_shown")){eF.preventDefault();return eA()}});dl.animate()}else{bf(".photo").show()}eD=function(){if(!bf("#signup-container").hasClass("form_shown")){return bf(".register").find(".login-button").trigger("click")}};bf(".buttons .freshbutton-blue").on("click",function(eF){eF.preventDefault();bf("html, body").animate({scrollTop:0},{queue:false,duration:500,complete:eD});return false});bf("#learn-more").on("click",function(eF){eF.preventDefault();bf("html, body").animate({scrollTop:bf("#divider").offset().top},{queue:false,duration:500});return false});if(a8.are_enabled()){aQ.WebMiscActivityLogger.log("index_page",{event_name:"cookies_enabled"})}else{Y.error(dU("Please enable browser-cookies to use the Dropbox website."))}T=["#devices-background",".register-button","#learn-more",".buttons .freshbutton-blue",".buttons .freshbutton-silver","#sign-in a","#page-header .downloading-link"];ex=function(eF){return bf(eF).on("click",function(){return aQ.WebMiscActivityLogger.log("index_page",{event_name:"click",id:eF})})};for(ew=0,eB=T.length;ew<eB;ew++){ev=T[ew];ex(ev)}ez=[".bullet-0 .subline",".bullet-0 .description",".bullet-1 .subline",".bullet-1 .description",".bullet-2 .subline",".bullet-2 .description",".bullet-3 .subline",".bullet-3 .description",".bottom .buttons"];eE={};return bf(window).scroll(function(){var eL,eM,eK,eI,eH,eJ,eG,eF;eF=[];for(eJ=0,eG=ez.length;eJ<eG;eJ++){eK=ez[eJ];if(bf(eK).length&&!eE[eK]){eM=bf(window).scrollTop();eL=eM+bf(window).outerHeight();eH=bf(eK).offset().top;eI=eH+bf(eK).outerHeight();if(eI<=eL){aQ.WebMiscActivityLogger.log("index_page",{event_name:"scroll",id:eK});eF.push(eE[eK]=true)}else{eF.push(void 0)}}else{eF.push(void 0)}}return eF})},_animate_points:function(eA,eB,eC,ev,eE,ez,T){var ex,ew,ey,eD;if(T==null){T=0}T=Math.min(Math.max(T,0),1);ey=ez(T);eD=[(function(){var eH,eG,eF;eF=[];for(ex=eH=0,eG=eB.length;0<=eG?eH<eG:eH>eG;ex=0<=eG?++eH:--eH){eF.push([(function(){var eJ,eI;eI=[];for(ew=eJ=0;eJ<2;ew=++eJ){eI.push(eB[ex][ew]+(eC[ex][ew]-eB[ex][ew])*ey)}return eI})()])}return eF})()];eA.attr("points",dl.points_array_to_str(eD));if(T>=1){return eE.resolve()}else{return setTimeout(function(){return dl._animate_points(eA,eB,eC,ev,eE,ez,T+(10/ev))},10)}},animate_points:function(ev,eA,ez,ew,ey,ex){var T;if(ex==null){ex=jQuery.easing.linear}T=bf.Deferred();dl._animate_points(ev,eA,ez,ew,T,ex);return T.done(function(){return typeof ey==="function"?ey():void 0}).promise()},animate_hide_rects:function(ev,ez,eB){var T,ew,eA,ey,ex;T=bf.Deferred().resolve().promise();eA=function(eC){var eH,eE,eG,eD,eF;eD=bf(ev[eC]);eH=dl.points_str_to_array(eD.attr("points"));eF=[eH[1],eH[1],eH[2],eH[2]];eE=dl.inverse(jQuery.easing.linear);eG=ez*(eE((eC+1)/ev.length)-eE(eC/ev.length));return T=T.then(function(){return dl.animate_points(eD,eH,eF,eG)})};for(ew=ey=0,ex=ev.length;0<=ex?ey<ex:ey>ex;ew=0<=ex?++ey:--ey){eA(ew)}return T.done(function(){return typeof eB==="function"?eB():void 0}).promise()},animate_delay:function(ev){var T;T=bf.Deferred();setTimeout(T.resolve,ev);return T.promise()},animate:function(){return bf.Deferred().resolve().promise().then(function(){return dl.animate_docs()}).then(function(){return dl.animate_graphs()}).then(function(){return dl.animate_photos()})},inverse:function(ev,T){if(T==null){T=0.000001}return function(ez){var ex,ey,ew;ey=0;ex=1;while(ex-ey>T){ew=(ey+ex)/2;if(ev(ew)<ez){ey=ew}else{ex=ew}}return ey}},points_str_to_array:function(eA){var ew,ez,ey,ev,ex,T;ex=eA.split(" ");T=[];for(ey=0,ev=ex.length;ey<ev;ey++){ez=ex[ey];T.push((function(){var eE,eC,eB,eD;eB=ez.split(",");eD=[];for(eE=0,eC=eB.length;eE<eC;eE++){ew=eB[eE];eD.push(parseFloat(ew))}return eD})())}return T},points_array_to_str:function(ev){var T;return((function(){var ey,ex,ew;ew=[];for(ey=0,ex=ev.length;ey<ex;ey++){T=ev[ey];ew.push(T.join(","))}return ew})()).join(" ")},animate_docs:function(){var eA,T,ex,ew,ez,ev,ey;ev=[[5,6],[177,1],[184,157],[13,180]];T="";for(ez=ey=0.475;ey<=0.625;ez=ey+=0.05){eA=ez+0.05;ex=[[ev[0][0]+(ev[3][0]-ev[0][0])*ez,ev[0][1]+(ev[3][1]-ev[0][1])*ez],[ev[1][0]+(ev[2][0]-ev[1][0])*ez,ev[1][1]+(ev[2][1]-ev[1][1])*ez],[ev[1][0]+(ev[2][0]-ev[1][0])*eA,ev[1][1]+(ev[2][1]-ev[1][1])*eA],[ev[0][0]+(ev[3][0]-ev[0][0])*eA,ev[0][1]+(ev[3][1]-ev[0][1])*eA]];ex=dl.points_array_to_str(ex);T+="<polygon points='"+ex+"' style='fill:#f5f9fc;stroke:none;' />"}ew=bf('<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="190" width="188">\n   '+T+"\n</svg>");return bf.Deferred().resolve().promise().then(function(){bf(".doc, .graph, .photo").hide();bf(".comp.doc").append(ew);return bf(".comp.doc").show("slide",{direction:"down"},850).promise()}).then(function(){return dl.animate_hide_rects(ew.find("polygon"),2500,function(){return ew.remove()})}).then(function(){return dl.animate_delay(500)}).then(function(){return bf(".tablet.doc, .phone.doc").show("fade",{easing:"easeInOutCubic"},400).promise()}).then(function(){return dl.animate_delay(1500)}).then(function(){return bf(".tablet.doc, .phone.doc, .comp.doc").hide("fade",{easing:"easeInOutCubic",duration:700}).promise()})},animate_graphs:function(){var ev,T;ev=[[83,98],[158,37],[241,77],[171,145]];T=bf('<svg xmlns="http://www.w3.org/2000/svg" version="1.1">\n    <polygon style="fill:#f5f9fc;stroke:none;"/>\n</svg>');T.find("polygon").attr("points",dl.points_array_to_str(ev));return bf.Deferred().resolve().promise().then(function(){bf(".doc, .graph, .photo").hide();bf(".tablet.graph .graph-grid").hide();bf(".tablet.graph").append(T);return bf(".tablet.graph").show("fade",{},500).promise()}).then(function(){var ew;ew=[ev[0],ev[1],ev[1],ev[0]];return dl.animate_points(T.find("polygon"),ev,ew,600,function(){return T.remove()})}).then(function(){if(!bB.msie_version_at_most(8)){return bf(".tablet.graph .graph-grid").show("fade",{},400).promise()}}).then(function(){return dl.animate_delay(500)}).then(function(){return bf(".comp.graph, .phone.graph").show("fade",{easing:"easeInOutCubic"},500).promise()}).then(function(){return dl.animate_delay(2000)}).then(function(){return bf(".graph").hide("fade",{easing:"easeInOutCubic"},700).promise()})},animate_photos:function(){return bf.Deferred().resolve().promise().then(function(){bf(".doc, .graph, .photo").hide();bf(".phone.photo img").not(".photo-flash").css({left:-18*1.15,top:-66*1.15,position:"absolute"});bf(".phone.photo").show();return bf.when((function(){if(!bB.msie_version_at_most(8)){return bf(".phone.photo .photo-flash").show().hide("fade",{},2000).promise()}})(),(function(){return bf.Deferred().resolve().promise().then(function(){return bf(".phone.photo img").not(".photo-flash").animate({left:0,top:0},{duration:800,easing:"easeInOutCubic"}).promise()}).then(function(){return dl.animate_delay(750)}).then(function(){return bf(".tablet.photo, .comp.photo").show("fade",{easing:"easeInOutCubic"},500).promise()})})())})}};var cZ,H,cU=function(T,ev){return function(){return T.apply(ev,arguments)}},am={}.hasOwnProperty,cl=function(ex,ev){for(var T in ev){if(am.call(ev,T)){ex[T]=ev[T]}}function ew(){this.constructor=ex}ew.prototype=ev.prototype;ex.prototype=new ew();ex.__super__=ev.prototype;return ex};H=INLINE_JS.UserNotifier=A.UserNotifier={USER_NOTIFICATION_STATUS_UNREAD:0,USER_NOTIFICATION_STATUS_READ:1,USER_NOTIFICATION_STATUS_INVISIBLE:2,MAX_ROWS_TO_RETRIEVE:100,MAX_INITIAL_ROWS:10,NUM_ROWS_TO_APPEND:10,SCROLLING_OFFSET:10,_is_retrieving_feed:false,_unread_count:0,_notifications:[],LAST_ACKED_META_ID_KEY:"last_acked_meta_id_key",_current_meta_not_id:null,_num_event_rows:0,_acked_ids:{},_shown:{},_has_more:false,_has_acked:false,THUMBS_BATCH_SIZE:16,_thumb_cache:{},init:function(){var ev,ew,T;this.refresh_feed();bf("#event-feed-container").scroll(function(){if(H._has_more){if(H._scroller_within_offset_to_bottom(H.SCROLLING_OFFSET)){return H._append_event_rows(false)}}});Event.observe($("event-feed-container"),"mousewheel",this.scrolling.bind(this));Event.observe($("event-feed-container"),"DOMMouseScroll",this.scrolling.bind(this));bf("#event-feed").on("click",this._mouseclick.bind(this));T=[];for(ew in M){ev=M[ew];T.push(this._subscribe_user(ev))}return T},refresh_feed:function(T,ev){var ex,ey,ew;ew=(function(ez){return function(eB){var eE,eC,eD,eA;ez._unread_count=eB.unread_count;ez._notifications=eB.notifications;if(eB.meta_notification){eC=eB.meta_notification;eD=ez._identifier(eC);if(eD!==ez._get_last_acked_meta_not_id()){ez._unread_count++}ez._current_meta_not_id=eD;ez._notifications.push(eC)}ez._has_acked=false;ez._notifications.sort(ez._sort_key);ez._append_event_rows(true);ez.update_jewel_ui(ez._unread_count);if((T!=null)&&(ev!=null)){eA=T.get_user_id();eE=eB.latest_nid[eA];T.handler_success(ev,{nid:eB.latest_nid[eA]})}if(bz){return bz.refresh_inbox_counts()}}})(this);ey=(function(ez){return function(){return ez._is_retrieving_feed=false}})(this);ex=(function(ez){return function(){var eA;ez._is_retrieving_feed=true;eA={count:ez.MAX_ROWS_TO_RETRIEVE};return new bf.ajax("/web/notifications/retrieve",{data:eA,dataType:"json",type:"POST",success:ew,error:function(){if((T!=null)&&(ev!=null)){return T.handler_failure(ev)}},complete:ey})}})(this);return ex()},ack_unread_notifications:function(){if(!this._has_acked&&this._unread_count>0){this.update_jewel_ui(0);if(this._get_last_acked_meta_not_id()!==this._current_meta_not_id){this._set_last_acked_meta_not_id(this._current_meta_not_id);this._acked_ids[this._current_meta_not_id]=true}new bf.ajax("/web/notifications/ack_all",{dataType:"json",type:"POST",success:(function(T){return function(ex){var ey,eA,ez,ew,ev;ev=[];for(ez=0,ew=ex.length;ez<ew;ez++){eA=ex[ez];ey=T._identifier(eA);T._acked_ids[ey]=true;ev.push(T._append_event_rows())}return ev}})(this)});return this._has_acked=true}},update_jewel_ui:function(T){bf("#new-notification-count").text(T).toggleClass("show",T>0);if(T>0){bf(".notifications-bell").addClass("shake")}return setTimeout((function(){return bf(".notifications-bell").removeClass("shake")}),500)},scrolling:function(T){var ev;if(T.originalEvent){T=T.originalEvent}ev=T.detail?T.detail*(-40):T.wheelDelta;if(!this._has_more&&ev<=0&&this._scroller_within_offset_to_bottom(0)){return this.preventDefault(T)}else{if(ev>=0&&$("event-feed-container").scrollTop===0){return this.preventDefault(T)}}},clear_cached_client_states:function(){if(this._is_retrieving_feed){return}this._acked_ids={};return this._append_event_rows(true)},preventDefault:function(T){if(typeof T.preventDefault==="function"){T.preventDefault()}return T.returnValue=false},_subscribe_user:function(T){var ev;return ev=T.subscribe_user({name:"NotificationFeedUpdater",handler:(function(ew){return function(){return ew.refresh_feed(T,ev)}})(this)})},_append_event_rows:function(eD){var T,eH,eK,ew,eF,eB,eE,eC,eA,eG,ev,ey,eJ,ex,eI,ez;if(eD==null){eD=false}if(eD){bf("#event-feed").empty();this._shown={};this._num_event_rows=Math.min(this._notifications.length,this.MAX_INITIAL_ROWS)}else{this._num_event_rows+=this.NUM_ROWS_TO_APPEND;this._num_event_rows=Math.min(this._num_event_rows,this._notifications.length)}eG=bf(".feed-row").size();eH=[];ez=this._notifications;for(eE=ex=0,eI=ez.length;ex<eI;eE=++ex){eA=ez[eE];if(eG>=this._num_event_rows){break}eF=this._identifier(eA);if(eF in this._shown){continue}this._shown[eF]=true;ey=eA.status;ew=bf(eA.notification_div);bf("#event-feed").append(ew);eG++;eB=ew.find("img").get(0);if(eB){T=bf(eB);eK=T.attr("data-src");if(eK){if(this._thumb_cache[eK]){eC=this._thumb_cache[eK];T.attr("src",eC);if(!eC.endsWith(b6.SPACER)){this._add_thumbnail_frame(T)}}else{if(!(eK in this._thumb_cache)){this._thumb_cache[eK]=false;eJ=eA.user_id;T.data("uid",eJ);T.data("not-identifier",eF);eH.push($(eB))}}}}if(!ew.hasClass("feed-row")){ew=ew.find(".feed-row")}if(eA.type_id===Constants.NOTIFICATION_TYPE_META){ew.addClass("meta-feed");if((!(eF in this._acked_ids))&&(eF===this._get_last_acked_meta_not_id())){ew.addClass("read")}}if(ey===this.USER_NOTIFICATION_STATUS_INVISIBLE){ew.addClass("invisible");if(eF in this._acked_ids){delete this._acked_ids[eF]}}if(ey===this.USER_NOTIFICATION_STATUS_READ){if(!(eF in this._acked_ids)){ew.addClass("read")}}}ev=(function(eL){return function(eP){var eN,eM,eO;if(!eP.src.endsWith(b6.SPACER)){eN=bf(eP);eL._add_thumbnail_frame(eN);eF=eN.data("not-identifier");eO=eN.attr("data-src");eM=eN.attr("src");return eL._thumb_cache[eO]=eM}}})(this);a6.batch_load_thumbs(eH,this.THUMBS_BATCH_SIZE,ev);this._has_more=this._num_event_rows<this._notifications.length;if(bf(".feed-row").length===0){return bf("#event-feed-container").addClass("empty")}else{return bf("#event-feed-container").removeClass("empty")}},_identifier:function(T){return""+T.user_id+" "+T.type_id+" "+T.target_object_key},_sort_key:function(ev,T){if(ev.sticky&&!T.sticky){return -1}if(T.sticky&&!ev.sticky){return 1}if(ev.status===H.USER_NOTIFICATION_STATUS_UNREAD&&T.status!==H.USER_NOTIFICATION_STATUS_UNREAD){return -1}if(T.status===H.USER_NOTIFICATION_STATUS_UNREAD&&ev.status!==H.USER_NOTIFICATION_STATUS_UNREAD){return 1}return T.feed_time-ev.feed_time},_get_last_acked_meta_not_id:function(){if(window.localStorage){return localStorage.getItem(this.LAST_ACKED_META_ID_KEY)}},_set_last_acked_meta_not_id:function(T){if(window.localStorage){return localStorage.setItem(this.LAST_ACKED_META_ID_KEY,T)}},_add_thumbnail_frame:function(T){bf(T).addClass("thumbnail");return bf(T).parent(".feed-thumbnail").addClass("has-frame")},_mouseclick:function(ew){var ev,T;ev=bf(ew.target);if(ev.is("a")){if(ev.hasClass("view")){ew.preventDefault();T=ev.attr("data-mount");return window.open(T)}}},_scroller_within_offset_to_bottom:function(ev){var T;T=$("event-feed-container");return T.scrollTop+T.offsetHeight+ev>=T.scrollHeight}};cZ=A.NotificationUIButton=(function(ev){cl(T,ev);T.prototype.selector=function(){return".notification-button"};function T(){this.clear=cU(this.clear,this);this.active=cU(this.active,this);this._clear_sticky_notification_on_popover_close=cU(this._clear_sticky_notification_on_popover_close,this);T.__super__.constructor.call(this);this._overflowY="auto";this._position="static";this._max_height="0px"}T.prototype._clear_sticky_notification_on_popover_close=function(){if(!bf(this.selector())[0].hasClassName("active")){return H.clear_cached_client_states()}};T.prototype.active=function(ew,ey){var ex;ex=ew.target.hasClassName("feed-row")?ew.target:$(ew.target).up(".feed-row");if(ex){if(!ex.hasClassName("clickable")){return}}T.__super__.active.call(this,ew,ey);return this._clear_sticky_notification_on_popover_close()};T.prototype.clear=function(ew){T.__super__.clear.call(this,ew);return this._clear_sticky_notification_on_popover_close()};return T})(dh);var bc,bX,d6;d6=A.UnsupportedBrowser={init:function(){return bf("#unsupported-browser-dismiss").on("click",function(T){T.preventDefault();el.hide();return bf.ajax({url:"/dismiss_browser_msg",type:"POST"})})}};bX=A.ExpiredCCNotificationBar={init:function(T){return bf(".expired-dismiss").on("click",function(ev){ev.preventDefault();el.hide();return bf.ajax({url:"/dismiss_expired_cc_notification",type:"POST",data:{source:T}})})}};bc=A.BetaLocaleNotificationBar={init:function(T){return bf(".beta-locale-dismiss").on("click",function(ev){ev.preventDefault();el.hide();return bf.ajax({url:"/dismiss_beta_locale_notification",type:"POST",data:{source:T}})})}};var d;d=INLINE_JS.viewer=cj.get_viewer();var G,bM,g,f,cm,ch,u,dH;if(!Constants.is_test){bf(d9.check_timezone)}if(window._document_observe_listeners){u=window._document_observe_listeners;for(g=0,cm=u.length;g<cm;g++){bM=u[g];if(document.loaded){bM.func()}else{document.observe(bM.event,bM.func)}}}if(window._jquery_ready_handlers){dH=window._jquery_ready_handlers;for(f=0,ch=dH.length;f<ch;f++){G=dH[f];bf(G)}}bf(function(){Event.fire(document,"script:loaded");return $(document.body).removeClassName("deferred-resources")});return A});